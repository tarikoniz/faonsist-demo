<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>FaOnSisT - Professional Enterprise System v5.0</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FaOnSisT">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; }
        body { background:#0a0e1a; color:#f8fafc; overflow:auto; }
        .glass { background:rgba(30,39,56,0.4); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(148,163,184,0.1); }
        .glass-strong { background:rgba(30,39,56,0.7); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(148,163,184,0.15); }
        .nav-item { transition:all 0.3s cubic-bezier(0.4,0,0.2,1); }
        .nav-item:hover { background:rgba(59,130,246,0.1); }
        .nav-item.active { background:linear-gradient(135deg,#3b82f6,#6366f1); color:white; box-shadow:0 4px 15px rgba(59,130,246,0.3); }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .status-pending { background:rgba(249,115,22,0.2); color:#f97316; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-approved { background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-reviewing { background:rgba(59,130,246,0.2); color:#3b82f6; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-rejected { background:rgba(239,68,68,0.2); color:#ef4444; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-active { background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-taslak { background:rgba(148,163,184,0.2); color:#94a3b8; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-onayBekliyor { background:rgba(234,179,8,0.2); color:#eab308; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-onaylandi { background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-ihaleyeCevrildi { background:rgba(59,130,246,0.2); color:#3b82f6; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-reddedildi { background:rgba(239,68,68,0.2); color:#ef4444; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-olusturuldu { background:rgba(148,163,184,0.2); color:#94a3b8; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-gonderildi { background:rgba(59,130,246,0.2); color:#3b82f6; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-kismiTeslimat { background:rgba(234,179,8,0.2); color:#eab308; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-tamamlandi { background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .status-iptal { background:rgba(239,68,68,0.2); color:#ef4444; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; }
        .notification { position:fixed; top:20px; right:20px; padding:12px 16px; border-radius:12px; background:#1e2738; border:1px solid #3b82f6; box-shadow:0 8px 24px rgba(0,0,0,0.4); z-index:99999 !important; transform:translateX(calc(100% + 40px)); transition:transform 0.3s ease, opacity 0.3s ease; opacity:0; max-width:360px; pointer-events:none; }
        .notification.show { transform:translateX(0); opacity:1; pointer-events:auto; }
        .kanban-col { min-width:220px; }
        .msg-bubble { max-width:70%; padding:10px 14px; border-radius:12px; font-size:13px; line-height:1.5; }
        .msg-mine { background:#3b82f6; color:white; margin-left:auto; border-bottom-right-radius:4px; }
        .msg-other { background:rgba(30,39,56,0.8); border:1px solid rgba(148,163,184,0.1); border-bottom-left-radius:4px; }
        .msg-item { padding:4px 16px; border-radius:0; font-size:13px; line-height:1.5; transition:background 0.15s; }
        .msg-item:hover { background:rgba(255,255,255,0.03); }
        .msg-item.msg-row-mine { padding-right:12px; }
        .msg-item.msg-row-mine:hover { background:rgba(59,130,246,0.04); }
        .msg-item .msg-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,#3b82f6,#8b5cf6); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:white; flex-shrink:0; }
        .msg-item .msg-avatar.mine-avatar { background:linear-gradient(135deg,#10b981,#3b82f6); }
        .msg-mine-block { background:rgba(59,130,246,0.08); border-radius:12px 12px 4px 12px; padding:8px 12px; max-width:85%; }
        .msg-other-block { max-width:85%; }
        .msg-date-sep { text-align:center; padding:12px 0 6px; }
        .msg-date-sep span { background:rgba(30,39,56,0.8); border:1px solid rgba(100,116,139,0.2); padding:3px 14px; border-radius:12px; font-size:10px; color:#94a3b8; font-weight:500; }
        .progress-bar { height:8px; border-radius:4px; background:rgba(255,255,255,0.1); overflow:hidden; }
        .progress-fill { height:100%; border-radius:4px; transition:width 0.5s ease; }
        .tab-btn { padding:8px 16px; font-size:12px; border-radius:8px; cursor:pointer; transition:all 0.2s; border:1px solid transparent; }
        .tab-btn.active { background:#3b82f6; color:white; }
        .tab-btn:not(.active) { background:rgba(30,39,56,0.4); color:#94a3b8; }
        .tab-btn:not(.active):hover { background:rgba(59,130,246,0.1); color:#e2e8f0; }
        .chart-bar { transition:height 0.5s ease, background 0.3s ease; border-radius:4px 4px 0 0; }
        .chart-bar:hover { filter:brightness(1.2); }
        .search-box { background:rgba(30,39,56,0.6); border:1px solid rgba(148,163,184,0.15); border-radius:10px; padding:8px 12px 8px 36px; font-size:13px; color:#f8fafc; width:100%; outline:none; transition:border 0.2s; }
        .search-box:focus { border-color:#3b82f6; }
        .badge-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
        input,select,textarea { color:#f8fafc; }
        input::placeholder,textarea::placeholder { color:#64748b; }
        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.2); border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:rgba(148,163,184,0.4); }
        /* v5 - Sidebar Collapse */
        .sidebar-collapsed { width:64px !important; }
        .sidebar-collapsed .sidebar-text, .sidebar-collapsed .sidebar-badge, .sidebar-collapsed .sidebar-search, .sidebar-collapsed .sidebar-user-info, .sidebar-collapsed .sidebar-subtitle { display:none !important; }
        .sidebar-collapsed .sidebar-logo-text { display:none !important; }
        .sidebar-collapsed .nav-item { justify-content:center; padding:10px; }
        .sidebar-collapsed .nav-item svg { margin:0; }
        .sidebar-collapsed .channel-btn { display:none; }
        /* v5 - Light Theme */
        html.light body { background:#f1f5f9; color:#1e293b; }
        html.light .glass { background:rgba(255,255,255,0.7); border-color:rgba(148,163,184,0.2); }
        html.light .glass-strong { background:rgba(255,255,255,0.85); border-color:rgba(148,163,184,0.25); }
        html.light .msg-other { background:rgba(241,245,249,0.9); border-color:rgba(148,163,184,0.2); color:#1e293b; }
        html.light .msg-item:hover { background:rgba(0,0,0,0.03); }
        html.light .msg-item.msg-row-mine:hover { background:rgba(59,130,246,0.06); }
        html.light .msg-mine-block { background:rgba(59,130,246,0.06); }
        html.light .msg-date-sep span { background:rgba(241,245,249,0.9); border-color:rgba(148,163,184,0.3); color:#64748b; }
        html.light .search-box { background:rgba(241,245,249,0.8); color:#1e293b; border-color:rgba(148,163,184,0.3); }
        html.light input, html.light select, html.light textarea { color:#1e293b; }
        html.light .notification { background:#fff; border-color:#3b82f6; color:#1e293b; }
        /* v5 - Notification Panel */
        .notif-panel { display:none; position:fixed; top:56px; right:16px; width:380px; max-height:520px; z-index:9999; }
        .notif-panel.active { display:block; }
        .notif-item { border-left:3px solid transparent; transition:all .2s; cursor:pointer; }
        .notif-item:hover { background:rgba(255,255,255,0.03); }
        .notif-unread { background:rgba(255,255,255,0.04); }
        .notif-item.seviye-bilgi { border-left-color:#3b82f6; }
        .notif-item.seviye-uyari { border-left-color:#f59e0b; }
        .notif-item.seviye-kritik { border-left-color:#f97316; }
        .notif-item.seviye-acil { border-left-color:#ef4444; }
        @keyframes pulse-dot { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .pulse-dot { animation:pulse-dot 1.5s ease-in-out infinite; }
        /* v5 - Global Search Overlay */
        .search-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1500; align-items:flex-start; justify-content:center; padding-top:80px; }
        .search-overlay.active { display:flex; }
        /* v5 - Drag & Drop */
        .dragging { opacity:0.5; transform:scale(0.95); }
        .drag-over { border:2px dashed #3b82f6 !important; background:rgba(59,130,246,0.05) !important; }
        /* v5 - Project Detail */
        .detail-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1100; align-items:center; justify-content:center; }
        .detail-overlay.active { display:flex; }
        /* v5 - Responsive */
        .mobile-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:899; }
        .mobile-overlay.active { display:block; }

        /* === TABLET: 768px-1024px === */
        @media(max-width:1024px){
            #sidebar { width:64px !important; }
            #sidebar .sidebar-text, #sidebar .sidebar-badge, #sidebar .sidebar-search, #sidebar .sidebar-user-info, #sidebar .sidebar-subtitle, #sidebar .sidebar-logo-text { display:none !important; }
            #sidebar .nav-item { justify-content:center; padding:10px; }
            #sidebar .nav-item svg { margin:0; }
            #sidebar .channel-btn { display:none; }
            .grid-cols-4 { grid-template-columns:repeat(2,1fr) !important; }
            header .px-6 { padding-left:12px; padding-right:12px; }
        }

        /* === MOBILE: 768px and below === */
        @media(max-width:768px){
            /* Sidebar: hide off-screen, slide in */
            #sidebar { position:fixed !important; left:-280px; z-index:900; transition:left 0.3s ease; height:100vh !important; width:264px !important; top:0; }
            #sidebar.mobile-open { left:0 !important; width:264px !important; }
            #sidebar.mobile-open .sidebar-text, #sidebar.mobile-open .sidebar-badge, #sidebar.mobile-open .sidebar-search, #sidebar.mobile-open .sidebar-user-info, #sidebar.mobile-open .sidebar-subtitle, #sidebar.mobile-open .sidebar-logo-text { display:initial !important; }
            #sidebar.mobile-open .nav-item { justify-content:flex-start; padding:10px 16px; }
            .sidebar-collapsed { left:-280px !important; }
            #mobile-toggle { display:flex !important; }

            /* Header */
            header.h-14 { height:52px; padding:0 10px !important; }
            header .gap-3 { gap:6px; }
            #page-subtitle { display:none; }
            #page-title { font-size:14px; }

            /* Main content full width */
            #main-content { padding:0 !important; }
            #main-content > div[id^="module-"] { padding:12px !important; }
            .p-6 { padding:12px !important; }

            /* Grids */
            .grid-cols-4, .grid-cols-3 { grid-template-columns:1fr 1fr !important; }
            .grid.gap-4 { gap:8px !important; }
            .grid.gap-6 { gap:10px !important; }
            .mb-6 { margin-bottom:12px !important; }

            /* Cards */
            .glass.rounded-xl.p-4, .glass-strong.rounded-xl.p-4 { padding:10px !important; }
            .glass.rounded-xl.p-4 .text-2xl, .glass-strong.rounded-xl.p-4 .text-2xl { font-size:18px; }
            .glass.rounded-xl.p-4 .text-xs { font-size:10px; }

            /* Tabs */
            .tab-btn { padding:6px 10px; font-size:11px; white-space:nowrap; }
            .flex.gap-2.mb-4.flex-wrap { overflow-x:auto; flex-wrap:nowrap !important; padding-bottom:4px; -webkit-overflow-scrolling:touch; }
            .group-btn { padding:6px 10px !important; font-size:11px !important; }

            /* Tables */
            table { font-size:11px; }
            th, td { padding:6px 8px !important; }
            .overflow-x-auto { overflow-x:auto; -webkit-overflow-scrolling:touch; }
            table th:nth-child(n+5), table td:nth-child(n+5) { display:none; }

            /* Modals */
            .modal .glass-strong { margin:4px !important; max-height:calc(100vh - 8px) !important; width:calc(100vw - 8px) !important; max-width:100% !important; border-radius:12px !important; }
            .modal .glass-strong .p-6 { padding:12px !important; }
            .detail-overlay .glass-strong { margin:0 !important; width:100vw !important; height:100vh !important; max-width:100% !important; max-height:100% !important; border-radius:0 !important; overflow-y:auto; }

            /* Connect module chat */
            .msg-bubble { max-width:90% !important; font-size:12px; }
            .msg-mine-block, .msg-other-block { max-width:95% !important; }
            #ai-history-panel { display:none !important; }

            /* Notification Panel */
            .notif-panel { right:4px !important; left:4px !important; width:auto !important; top:52px !important; }

            /* Quick Add */
            #quick-add-menu { width:calc(100vw - 16px) !important; right:8px !important; top:52px !important; }

            /* Charts */
            canvas { max-height:200px !important; }

            /* Build project detail tabs */
            .subtab-row { overflow-x:auto; flex-wrap:nowrap !important; -webkit-overflow-scrolling:touch; }
            .subtab-btn { white-space:nowrap; flex-shrink:0; }

            /* Dashboard module widgets */
            .grid-cols-2 { grid-template-columns:1fr !important; }

            /* HR tabs */
            #hr-tabs { overflow-x:auto; flex-wrap:nowrap !important; -webkit-overflow-scrolling:touch; padding-bottom:4px; }
            #hr-tabs .tab-btn { flex-shrink:0; }

            /* Supply, Sales, Depo tabs */
            [id$="-tabs"] { overflow-x:auto; flex-wrap:nowrap !important; -webkit-overflow-scrolling:touch; }

            /* Buttons */
            .text-sm.font-medium { font-size:12px; }
            button .hidden.sm\\:inline { display:none !important; }

            /* PWA Banner */
            #pwa-install-banner { min-width:280px !important; max-width:calc(100vw - 24px) !important; }

            /* Connect channel list */
            #conn-channels { max-height:35vh; }

            /* Form inputs */
            input, select, textarea { font-size:16px !important; }

            /* Scrollbar hide on mobile for tab rows */
            .flex.gap-2::-webkit-scrollbar, .subtab-row::-webkit-scrollbar, [id$="-tabs"]::-webkit-scrollbar { height:0; display:none; }
        }

        /* === SMALL PHONE: 480px and below === */
        @media(max-width:480px){
            .tab-btn { padding:5px 8px; font-size:10px; }
            .grid-cols-4, .grid-cols-3, .grid-cols-2 { grid-template-columns:1fr !important; }
            .grid.gap-4, .grid.gap-6 { gap:6px !important; }
            header .flex.items-center.gap-3:last-child > button:not(:last-child):not(#mobile-toggle) { display:none; }
            #page-title { font-size:13px; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
            .glass.rounded-xl.p-4, .glass-strong.rounded-xl.p-4 { padding:8px !important; }
            table { font-size:10px; }
            th, td { padding:4px 6px !important; }
            table th:nth-child(n+4), table td:nth-child(n+4) { display:none; }
            .msg-bubble { font-size:11px; }
            canvas { max-height:160px !important; }
        }

        /* === iOS safe area support === */
        @supports(padding: max(0px)) {
            header.h-14 { padding-top: max(0px, env(safe-area-inset-top)); }
            #sidebar { padding-top: max(0px, env(safe-area-inset-top)); }
            #main-content { padding-bottom: max(0px, env(safe-area-inset-bottom)); }
        }
        /* Quick Add Menu */
        #quick-add-menu { display:none; position:fixed; top:56px; right:16px; width:320px; max-height:calc(100vh - 72px); overflow-y:auto; border-radius:16px; z-index:800; background:#0f1423; border:1px solid rgba(99,102,241,0.2); box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        #quick-add-menu.active { display:block; }
        .qa-cat { padding:6px 16px 4px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6366f1; }
        .qa-item { display:flex; align-items:center; gap:10px; padding:10px 16px; cursor:pointer; transition:all 0.15s; font-size:13px; color:#e2e8f0; }
        .qa-item:hover { background:rgba(99,102,241,0.12); }
        .qa-item .qa-icon { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:8px; font-size:14px; flex-shrink:0; }
        .qa-projes { display:none; padding:2px 0 4px 54px; }
        .qa-projes.active { display:block; }
        .qa-projes button { display:block; width:100%; text-align:left; padding:6px 12px; font-size:12px; color:#94a3b8; border-radius:6px; transition:all 0.15s; }
        .qa-projes button:hover { background:rgba(99,102,241,0.15); color:#e2e8f0; }
        @media(max-width:480px){ #quick-add-menu { width:calc(100vw - 24px); right:-8px; } }
        /* v6 - Module Group Tabs */
        .group-btn { position:relative; }
        .group-btn.active { background:rgba(99,102,241,0.2); color:#a5b4fc; border-color:rgba(99,102,241,0.4); }
        .subtab-row { display:none; padding:6px 0; gap:6px; flex-wrap:wrap; }
        .subtab-row.active { display:flex; }
        .subtab-btn { padding:5px 12px; font-size:11px; border-radius:6px; cursor:pointer; transition:all 0.2s; border:1px solid transparent; background:rgba(30,39,56,0.5); color:#94a3b8; }
        .subtab-btn:hover { background:rgba(99,102,241,0.15); color:#c7d2fe; }
        .subtab-btn.active { background:#6366f1; color:white; }
        /* PWA Install Banner */
        #pwa-install-banner { display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:1800; min-width:320px; max-width:420px; }
        #pwa-install-banner.show { display:block; animation:slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateX(-50%) translateY(100px);opacity:0;} to{transform:translateX(-50%) translateY(0);opacity:1;} }
        /* Landing Page Animations */
        @keyframes floatOrb { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-30px) scale(1.05);} }
        @keyframes lpFadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
        .lp-fade-in { animation:lpFadeIn 0.8s ease forwards; opacity:0; }
        /* AI Chat History Sidebar */
        #ai-history-panel { display:none; width:260px; border-right:1px solid rgba(148,163,184,0.1); flex-direction:column; }
        #ai-history-panel.active { display:flex; }
        .ai-session-item { padding:8px 12px; border-radius:8px; cursor:pointer; transition:all 0.2s; border-left:3px solid transparent; }
        .ai-session-item:hover { background:rgba(255,255,255,0.04); }
        .ai-session-item.active { background:rgba(245,158,11,0.1); border-left-color:#f59e0b; }
        /* Dashboard Charts */
        .chart-tab { padding:6px 14px; font-size:11px; border-radius:8px; cursor:pointer; transition:all 0.2s; }
        .chart-tab.active { background:#3b82f6; color:white; }
        .chart-tab:not(.active) { background:rgba(30,39,56,0.4); color:#94a3b8; }
        .chart-tab:not(.active):hover { background:rgba(59,130,246,0.1); }
        .chart-container { position:relative; height:280px; }
        /* AI Report Status */
        .ai-report-item { padding:12px; border-radius:10px; background:rgba(30,39,56,0.4); border:1px solid rgba(148,163,184,0.1); cursor:pointer; transition:all 0.2s; }
        .ai-report-item:hover { background:rgba(30,39,56,0.6); border-color:rgba(245,158,11,0.3); }
        .report-status-olusturuluyor { background:rgba(59,130,246,0.2); color:#60a5fa; }
        .report-status-tamamlandi { background:rgba(34,197,94,0.2); color:#22c55e; }
        .report-status-hata { background:rgba(239,68,68,0.2); color:#ef4444; }
    </style>
    <script src="https://cdn.socket.io/4.8.3/socket.io.min.js"></script>
</head>
<body>
<!-- ==================== LANDING PAGE ==================== -->
<div id="landing-page" class="min-h-screen overflow-y-auto" style="background:linear-gradient(135deg,#0a0e1a 0%,#111827 40%,#0f172a 100%);">

    <!-- HERO SECTION -->
    <div class="relative overflow-hidden">
        <!-- Animated background orbs -->
        <div style="position:absolute;top:-120px;left:-80px;width:400px;height:400px;background:radial-gradient(circle,rgba(99,102,241,0.15),transparent 70%);border-radius:50%;animation:floatOrb 8s ease-in-out infinite;"></div>
        <div style="position:absolute;bottom:-100px;right:-60px;width:350px;height:350px;background:radial-gradient(circle,rgba(59,130,246,0.12),transparent 70%);border-radius:50%;animation:floatOrb 10s ease-in-out infinite reverse;"></div>
        <div style="position:absolute;top:50%;left:60%;width:250px;height:250px;background:radial-gradient(circle,rgba(168,85,247,0.08),transparent 70%);border-radius:50%;animation:floatOrb 12s ease-in-out infinite;"></div>

        <div class="relative z-10 max-w-6xl mx-auto px-6 pt-8 pb-4">
            <!-- Nav -->
            <nav class="flex items-center justify-between mb-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20"><span class="text-lg font-bold text-white">F</span></div>
                    <div><span class="text-lg font-bold text-white">FaOnSisT</span><span class="text-[10px] text-gray-500 ml-2">v5.0</span></div>
                </div>
                <button onclick="goToLogin()" class="px-5 py-2 rounded-lg border border-gray-700 text-sm text-gray-300 hover:bg-gray-800/50 transition-all">Giris Yap</button>
            </nav>

            <!-- Hero Content -->
            <div class="text-center max-w-3xl mx-auto mb-16 lp-fade-in">
                <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-medium mb-6">
                    <span class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></span>
                    Canli Demo Hazir
                </div>
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-white mb-6 leading-tight">
                    Entegre Is Yonetim<br><span class="bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent">Platformu</span>
                </h1>
                <p class="text-gray-400 text-base sm:text-lg max-w-2xl mx-auto mb-8 leading-relaxed">
                    Proje yonetimi, satin alma, satis, depo, insan kaynaklari ve takim iletisimini tek bir platformda birlestiren, yapay zeka destekli kurumsal cozum.
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="document.getElementById('lp-demo-section').scrollIntoView({behavior:'smooth'})" class="px-8 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold text-sm transition-all shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 hover:-translate-y-0.5">
                        Canli Demo'yu Dene
                    </button>
                    <button onclick="document.getElementById('lp-features').scrollIntoView({behavior:'smooth'})" class="px-8 py-3 rounded-xl border border-gray-700 hover:border-gray-500 text-gray-300 font-medium text-sm transition-all hover:bg-gray-800/30">
                        Ozellikleri Gor
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STATS BAR -->
    <div class="max-w-5xl mx-auto px-6 mb-16 lp-fade-in" style="animation-delay:0.2s;">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="text-center p-4 rounded-xl bg-gray-800/30 border border-gray-700/30">
                <div class="text-2xl font-bold text-white">9+</div>
                <div class="text-xs text-gray-500 mt-1">Entegre Modul</div>
            </div>
            <div class="text-center p-4 rounded-xl bg-gray-800/30 border border-gray-700/30">
                <div class="text-2xl font-bold text-white">AI</div>
                <div class="text-xs text-gray-500 mt-1">Yapay Zeka Destekli</div>
            </div>
            <div class="text-center p-4 rounded-xl bg-gray-800/30 border border-gray-700/30">
                <div class="text-2xl font-bold text-white">%100</div>
                <div class="text-xs text-gray-500 mt-1">Offline Calisir</div>
            </div>
            <div class="text-center p-4 rounded-xl bg-gray-800/30 border border-gray-700/30">
                <div class="text-2xl font-bold text-white">PWA</div>
                <div class="text-xs text-gray-500 mt-1">Mobil Uyumlu</div>
            </div>
        </div>
    </div>

    <!-- FEATURES SECTION -->
    <div id="lp-features" class="max-w-6xl mx-auto px-6 mb-20">
        <div class="text-center mb-12 lp-fade-in" style="animation-delay:0.3s;">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-3">Tum Moduller, Tek Platform</h2>
            <p class="text-gray-500 text-sm max-w-xl mx-auto">Her birim kendi modulunde calisir, veriler otomatik olarak diger modullerle senkronize olur.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lp-fade-in" style="animation-delay:0.4s;">
            <!-- Feature Cards -->
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-blue-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-blue-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-blue-500/15 flex items-center justify-center mb-3 group-hover:bg-blue-500/25 transition-colors"><span class="text-xl">üìä</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">Dashboard</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Tum is surecleri tek ekranda. Proje, satis, depo ve IK verilerini anlik izleyin.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-indigo-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-indigo-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-indigo-500/15 flex items-center justify-center mb-3 group-hover:bg-indigo-500/25 transition-colors"><span class="text-xl">üí¨</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-Connect</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Takim iletisimi, dosya paylasimi, AI asistan ve toplanti yonetimi tek yerde.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-purple-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-purple-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-purple-500/15 flex items-center justify-center mb-3 group-hover:bg-purple-500/25 transition-colors"><span class="text-xl">üèóÔ∏è</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-Build</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Proje planlama, gorev takibi, hakedi≈ü, malzeme stok ve alt yuklenici yonetimi.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-orange-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-orange-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-orange-500/15 flex items-center justify-center mb-3 group-hover:bg-orange-500/25 transition-colors"><span class="text-xl">üì¶</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-Supply</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Satin alma talepleri, siparis takibi, tedarikci havuzu ve otomatik stok girisi.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-green-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-green-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-green-500/15 flex items-center justify-center mb-3 group-hover:bg-green-500/25 transition-colors"><span class="text-xl">üí∞</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-Sales</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Musteri yonetimi, teklif/satis sureci, taksit takibi ve gelir-gider analizi.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-amber-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-amber-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-amber-500/15 flex items-center justify-center mb-3 group-hover:bg-amber-500/25 transition-colors"><span class="text-xl">üè≠</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-Depo</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Envanter takibi, depo transferleri, zimmet yonetimi ve arac filo takibi.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-pink-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-pink-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-pink-500/15 flex items-center justify-center mb-3 group-hover:bg-pink-500/25 transition-colors"><span class="text-xl">üë•</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">FaOn-HR</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Personel yonetimi, izin takibi, puantaj, belge paketi ve isten ayrƒ±lma sureci.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-cyan-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-cyan-500/15 flex items-center justify-center mb-3 group-hover:bg-cyan-500/25 transition-colors"><span class="text-xl">üìà</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">Raporlar</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Proje, mali, IK, depo ve satis raporlarini olusturun, PDF olarak indirin.</p>
            </div>
            <div class="lp-feature-card group p-5 rounded-xl bg-gray-800/20 border border-gray-700/30 hover:border-violet-500/30 transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-violet-500/5 cursor-default">
                <div class="w-10 h-10 rounded-lg bg-violet-500/15 flex items-center justify-center mb-3 group-hover:bg-violet-500/25 transition-colors"><span class="text-xl">ü§ñ</span></div>
                <h3 class="font-semibold text-white text-sm mb-1">AI Asistan</h3>
                <p class="text-xs text-gray-500 leading-relaxed">Claude, GPT-4, Gemini destekli akilli asistan. Analiz, hatirlatma ve komut sistemi.</p>
            </div>
        </div>
    </div>

    <!-- DEMO ACCOUNTS SECTION -->
    <div id="lp-demo-section" class="max-w-4xl mx-auto px-6 mb-16">
        <div class="text-center mb-10 lp-fade-in" style="animation-delay:0.5s;">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-3">Canli Demo'yu Deneyin</h2>
            <p class="text-gray-500 text-sm">Farkli roller ile sistemi kesfet. Tek tikla giris yap.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 lp-fade-in" style="animation-delay:0.6s;">
            <!-- Admin -->
            <div class="relative p-6 rounded-2xl bg-gradient-to-br from-blue-500/10 to-indigo-500/5 border border-blue-500/20 hover:border-blue-400/40 transition-all hover:-translate-y-1 group">
                <div class="absolute top-3 right-3 px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 text-[10px] font-medium">Tam Yetki</div>
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center mb-4 shadow-lg shadow-blue-500/20"><span class="text-lg font-bold">TO</span></div>
                <h3 class="font-bold text-white text-base mb-0.5">Tarik Oniz</h3>
                <p class="text-blue-400 text-xs font-medium mb-3">Yonetici (Admin)</p>
                <div class="space-y-1.5 mb-5 text-[11px]">
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">E-posta:</span><span class="text-gray-300 font-mono">tarik@faonsist.com</span></div>
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">Sifre:</span><span class="text-gray-300 font-mono">1234</span></div>
                </div>
                <button onclick="quickDemoLogin(1)" class="w-full py-2.5 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-sm font-medium transition-all shadow-md shadow-blue-500/20 hover:shadow-blue-500/30">
                    Yonetici Olarak Gir
                </button>
            </div>
            <!-- Project Manager -->
            <div class="relative p-6 rounded-2xl bg-gradient-to-br from-purple-500/10 to-pink-500/5 border border-purple-500/20 hover:border-purple-400/40 transition-all hover:-translate-y-1 group">
                <div class="absolute top-3 right-3 px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400 text-[10px] font-medium">Proje Yetkisi</div>
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center mb-4 shadow-lg shadow-purple-500/20"><span class="text-lg font-bold">MK</span></div>
                <h3 class="font-bold text-white text-base mb-0.5">Mehmet Kaya</h3>
                <p class="text-purple-400 text-xs font-medium mb-3">Proje Muduru</p>
                <div class="space-y-1.5 mb-5 text-[11px]">
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">E-posta:</span><span class="text-gray-300 font-mono">mehmet@faonsist.com</span></div>
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">Sifre:</span><span class="text-gray-300 font-mono">1234</span></div>
                </div>
                <button onclick="quickDemoLogin(2)" class="w-full py-2.5 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-sm font-medium transition-all shadow-md shadow-purple-500/20 hover:shadow-purple-500/30">
                    Proje Muduru Olarak Gir
                </button>
            </div>
            <!-- Accounting -->
            <div class="relative p-6 rounded-2xl bg-gradient-to-br from-emerald-500/10 to-teal-500/5 border border-emerald-500/20 hover:border-emerald-400/40 transition-all hover:-translate-y-1 group">
                <div class="absolute top-3 right-3 px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 text-[10px] font-medium">Mali Yetki</div>
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center mb-4 shadow-lg shadow-emerald-500/20"><span class="text-lg font-bold">AD</span></div>
                <h3 class="font-bold text-white text-base mb-0.5">Ayse Demir</h3>
                <p class="text-emerald-400 text-xs font-medium mb-3">Muhasebe</p>
                <div class="space-y-1.5 mb-5 text-[11px]">
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">E-posta:</span><span class="text-gray-300 font-mono">ayse@faonsist.com</span></div>
                    <div class="flex items-center gap-2 text-gray-400"><span class="text-gray-600">Sifre:</span><span class="text-gray-300 font-mono">1234</span></div>
                </div>
                <button onclick="quickDemoLogin(3)" class="w-full py-2.5 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white text-sm font-medium transition-all shadow-md shadow-emerald-500/20 hover:shadow-emerald-500/30">
                    Muhasebe Olarak Gir
                </button>
            </div>
        </div>
        <!-- Or manual login -->
        <div class="text-center mt-6">
            <button onclick="goToLogin()" class="text-sm text-gray-500 hover:text-gray-300 transition-colors underline underline-offset-4">veya e-posta ile manuel giris yap</button>
        </div>
    </div>

    <!-- TECH FOOTER -->
    <div class="border-t border-gray-800/50 py-8 mt-8">
        <div class="max-w-6xl mx-auto px-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center"><span class="text-sm font-bold text-white">F</span></div>
                    <div class="text-xs text-gray-600">FaOnSisT Enterprise v5.0</div>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-3 text-[10px] text-gray-600">
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">JavaScript</span>
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">Tailwind CSS</span>
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">Chart.js</span>
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">Socket.IO</span>
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">PWA</span>
                    <span class="px-2 py-1 rounded bg-gray-800/50 border border-gray-700/30">AI Multi-Provider</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="login-screen" class="h-screen flex items-center justify-center" style="display:none;">
    <div class="glass-strong rounded-2xl p-8 w-full max-w-sm">
        <div class="text-center mb-6">
            <div class="w-16 h-16 mx-auto rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20 mb-3"><span class="text-2xl font-bold">F</span></div>
            <h1 class="text-xl font-bold">FaOnSisT</h1>
            <p class="text-xs text-gray-500 mt-1">Enterprise v5.0 - Giris Yap</p>
            <div id="login-mode-badge" class="mt-2 text-[10px] px-2 py-0.5 rounded-full inline-block bg-green-500/20 text-green-400" style="display:none;">Backend Bagli</div>
        </div>
        <form onsubmit="doLogin(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">E-posta</label><input type="email" id="login-email" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="email@faonsist.com" value="tarik@faonsist.com"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Sifre</label><input type="password" id="login-pass" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="****" value="1234"></div>
            <div id="login-error" class="text-red-400 text-xs hidden"></div>
            <button type="submit" id="login-btn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 py-2.5 rounded-lg font-medium text-sm transition-all shadow-lg shadow-blue-500/20">Giris Yap</button>
            <p class="text-[10px] text-gray-600 text-center"><a href="#" onclick="showLandingPage();return false;" class="text-blue-400 hover:text-blue-300">‚Üê Ana Sayfa</a> &nbsp;|&nbsp; Demo: tarik@faonsist.com / 1234</p>
        </form>
    </div>
</div>
<!-- Mobile Overlay -->
<div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobileSidebar()"></div>
<div id="main-app" class="flex h-screen overflow-hidden" style="display:none;">
    <!-- SIDEBAR -->
    <aside class="w-64 flex-none glass border-r border-gray-700/50 flex flex-col transition-all duration-300" id="sidebar">
        <div class="p-5 border-b border-gray-700/50">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20 cursor-pointer" onclick="toggleSidebar()">
                    <span class="text-xl font-bold">F</span>
                </div>
                <div class="sidebar-logo-text">
                    <h1 class="text-base font-bold">FaOnSisT</h1>
                    <p class="text-[10px] text-gray-500 sidebar-subtitle">Enterprise v5.0</p>
                </div>
            </div>
        </div>
        <!-- Search -->
        <div class="px-3 pt-3 relative sidebar-search">
            <svg class="w-4 h-4 text-gray-500 absolute left-6 top-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" class="search-box" placeholder="Mod√ºl ara..." id="module-search" oninput="filterModules(this.value)">
        </div>
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto" id="nav-list">
            <a onclick="showModule('dashboard')" class="nav-item active flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="dashboard">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-[13px] sidebar-text">Dashboard</span>
            </a>
            <a onclick="showModule('connect')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="connect">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-Connect</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-blue-500 text-white rounded-full sidebar-badge" id="connect-badge">3</span>
            </a>
            <a onclick="showModule('build')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="build">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-Build</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-purple-500 text-white rounded-full sidebar-badge" id="build-badge">0</span>
            </a>
            <a onclick="showModule('supply')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="supply">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-Supply</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-orange-500 text-white rounded-full sidebar-badge" id="supply-badge">0</span>
            </a>
            <a onclick="showModule('sales')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="sales">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-Sales</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-green-500 text-white rounded-full sidebar-badge" id="sales-badge">0</span>
            </a>
            <a onclick="showModule('depo')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="depo">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0v10l-8 4M4 7v10l8 4m0-14v10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 11h2m4 0h2M8 14h2m4 0h2"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-Depo</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-amber-500 text-white rounded-full sidebar-badge" id="depo-badge">0</span>
            </a>
            <a onclick="showModule('hr')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="hr">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                <span class="text-[13px] sidebar-text">FaOn-HR</span>
                <span class="ml-auto text-[10px] px-2 py-0.5 bg-teal-500 text-white rounded-full sidebar-badge" id="hr-badge">0</span>
            </a>
            <a onclick="showModule('reports')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="reports">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span class="text-[13px] sidebar-text">Raporlar</span>
            </a>
            <a onclick="showModule('settings')" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer" data-module="settings">
                <svg class="w-[18px] h-[18px] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span class="text-[13px] sidebar-text">Ayarlar</span>
            </a>
        </nav>
        <div class="p-3 border-t border-gray-700/50 relative">
            <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-800/50 cursor-pointer transition-colors" onclick="toggleUserMenu()" id="sidebar-user-btn">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-bold" id="sidebar-user-avatar">TO</div>
                <div class="flex-1 min-w-0 sidebar-user-info">
                    <p class="text-[13px] font-medium truncate">Tarik Oniz</p>
                    <p class="text-[11px] text-gray-500">Yonetici</p>
                </div>
                <svg class="w-4 h-4 text-gray-500 sidebar-text" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
            </div>
            <!-- User Popup Menu -->
            <div id="user-menu-popup" class="absolute bottom-full left-3 right-3 mb-2 rounded-xl glass-strong border border-gray-700/50 shadow-2xl overflow-hidden transition-all origin-bottom" style="display:none;z-index:950;">
                <!-- User Info -->
                <div class="p-4 border-b border-gray-700/30">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-sm font-bold" id="menu-user-avatar">HA</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate" id="menu-user-name">Tarik Oniz</p>
                            <p class="text-[11px] text-gray-500" id="menu-user-role">Yonetici</p>
                            <p class="text-[10px] text-gray-600 truncate" id="menu-user-email">tarik@faonsist.com</p>
                        </div>
                    </div>
                </div>
                <!-- Menu Items -->
                <div class="p-1.5">
                    <button onclick="showModule('ayarlar');toggleUserMenu()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-700/30 transition-colors text-left">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        <span class="text-[13px] text-gray-300">Profilim & Ayarlar</span>
                    </button>
                    <button onclick="toggleTheme();toggleUserMenu()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-700/30 transition-colors text-left">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                        <span class="text-[13px] text-gray-300">Tema Degistir</span>
                    </button>
                    <div class="border-t border-gray-700/30 my-1"></div>
                    <button onclick="toggleUserMenu();logout()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-red-500/10 transition-colors text-left group">
                        <svg class="w-4 h-4 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <span class="text-[13px] text-gray-300 group-hover:text-red-400">Cikis Yap</span>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- HEADER -->
        <header class="h-14 glass-strong border-b border-gray-700/50 flex items-center justify-between px-6 flex-shrink-0">
            <div class="flex items-center gap-3">
                <!-- Mobile hamburger -->
                <button id="mobile-toggle" onclick="toggleMobileSidebar()" class="p-2 rounded-lg hover:bg-gray-800/50 transition-colors hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <div>
                    <h2 class="text-base font-bold" id="page-title">Dashboard</h2>
                    <p class="text-[11px] text-gray-400" id="page-subtitle">Sistem Ozeti ve Hizli Erisim</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Global Search -->
                <button onclick="openGlobalSearch()" class="p-2 rounded-lg hover:bg-gray-800/50 transition-colors" title="Ara (Ctrl+K)">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </button>
                <!-- Notifications -->
                <div class="relative">
                    <button onclick="toggleNotifPanel()" class="p-2 rounded-lg hover:bg-gray-800/50 transition-colors relative">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span class="absolute -top-0.5 -right-0.5 w-4 h-4 bg-red-500 text-white text-[9px] rounded-full flex items-center justify-center" id="notif-count">0</span>
                    </button>
                </div>
                <!-- Export -->
                <button onclick="exportData()" class="p-2 rounded-lg hover:bg-gray-800/50 transition-colors" title="Veri Export">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </button>
                <button onclick="openQuickAdd()" class="flex items-center gap-2 px-2.5 py-2 sm:px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 rounded-lg transition-all shadow-lg shadow-blue-500/20">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    <span class="text-sm font-medium hidden sm:inline">Hizli Ekle</span>
                </button>
            </div>
        </header>
        <!-- Notification Panel (body level for z-index) -->
        <div id="notif-panel" class="notif-panel glass-strong rounded-xl shadow-2xl">
            <div class="p-3 border-b border-gray-700/50">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold">Bildirim Merkezi</span>
                    <div class="flex gap-2">
                        <button onclick="bildirimTumunuOkundu(currentUser?currentUser.id:1);renderBildirimPaneli();bildirimSayisiGuncelle()" class="text-[10px] text-blue-400 hover:text-blue-300">Tumunu Okundu</button>
                        <button onclick="bildirimTemizle();renderBildirimPaneli()" class="text-[10px] text-gray-500 hover:text-gray-300">Temizle</button>
                    </div>
                </div>
                <div class="flex gap-1" id="bildirim-kat-tabs"></div>
            </div>
            <div id="notif-list" class="p-2 space-y-1 max-h-80 overflow-y-auto"></div>
        </div>
        <div id="quick-add-menu"></div>

        <!-- CONTENT -->
        <div class="flex-1 overflow-y-auto" id="main-content">

            <!-- ==================== DASHBOARD ==================== -->
            <div id="module-dashboard" class="p-6">
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 hover:border-blue-500/30 transition-colors cursor-pointer" onclick="showModule('build')">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400">Toplam Projeler</span>
                            <div class="w-9 h-9 rounded-lg bg-blue-500/10 flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold" id="stat-projects">0</h3>
                        <p class="text-xs text-green-400 mt-1">Aktif projeler</p>
                    </div>
                    <div class="glass rounded-xl p-4 hover:border-green-500/30 transition-colors cursor-pointer" onclick="showModule('sales')">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400">Toplam Butce</span>
                            <div class="w-9 h-9 rounded-lg bg-green-500/10 flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold" id="stat-budget">&#8378;0</h3>
                        <p class="text-xs text-gray-400 mt-1">Toplam proje degeri</p>
                    </div>
                    <div class="glass rounded-xl p-4 hover:border-orange-500/30 transition-colors cursor-pointer" onclick="showModule('supply')">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400">Bekleyen Ihaleler</span>
                            <div class="w-9 h-9 rounded-lg bg-orange-500/10 flex items-center justify-center">
                                <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold" id="stat-tenders">0</h3>
                        <p class="text-xs text-orange-400 mt-1">Onay bekliyor</p>
                    </div>
                    <div class="glass rounded-xl p-4 hover:border-purple-500/30 transition-colors cursor-pointer" onclick="showModule('reports')">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400">Karlilik Orani</span>
                            <div class="w-9 h-9 rounded-lg bg-purple-500/10 flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold" id="stat-profit">%0</h3>
                        <p class="text-xs text-green-400 mt-1">Ortalama kar marji</p>
                    </div>
                </div>
                <!-- Dashboard Charts (Chart.js) -->
                <div class="glass rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold">Grafikler</h4>
                        <div class="flex gap-1" id="dash-chart-tabs">
                            <button class="chart-tab active" onclick="switchDashChart('progress')">Proje Durumu</button>
                            <button class="chart-tab" onclick="switchDashChart('cashflow')">Nakit Akisi</button>
                            <button class="chart-tab" onclick="switchDashChart('cost')">Butce/Harcama</button>
                            <button class="chart-tab" onclick="switchDashChart('trend')">Aylik Trend</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dash-chart-canvas"></canvas>
                    </div>
                </div>
                <!-- Eski kucuk widgetlar -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="glass rounded-xl p-4 col-span-2">
                        <h4 class="text-sm font-semibold mb-3">Aylik Gelir/Gider (Ozet)</h4>
                        <div class="flex items-end gap-2 h-32" id="dash-chart">
                            <!-- filled by JS -->
                        </div>
                        <div class="flex items-center gap-4 mt-3 text-[11px] text-gray-400">
                            <span><span class="inline-block w-3 h-3 rounded bg-blue-500 mr-1"></span>Gelir</span>
                            <span><span class="inline-block w-3 h-3 rounded bg-purple-500 mr-1"></span>Gider</span>
                        </div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <h4 class="text-sm font-semibold mb-3">Proje Durumlari</h4>
                        <div class="space-y-3" id="dash-status-summary">
                            <p class="text-xs text-gray-500">Veri bekleniyor...</p>
                        </div>
                    </div>
                </div>
                <!-- Dashboard Widgets: Son Ihaleler & Satislar -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold">Son Ihaleler</h4><button onclick="showModule('supply')" class="text-[10px] text-blue-400 hover:text-blue-300">Tumunu Gor</button></div>
                        <div id="dash-recent-tenders" class="space-y-2 max-h-32 overflow-y-auto"><p class="text-xs text-gray-500">Ihale yok.</p></div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold">Son Satislar</h4><button onclick="showModule('sales')" class="text-[10px] text-blue-400 hover:text-blue-300">Tumunu Gor</button></div>
                        <div id="dash-recent-sales" class="space-y-2 max-h-32 overflow-y-auto"><p class="text-xs text-gray-500">Satis yok.</p></div>
                    </div>
                </div>
                <!-- Insaat ERP Ozet Widgets -->
                <div class="grid grid-cols-4 gap-4 mb-6" id="dash-erp-widgets">
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-red-400">ISG Ozeti</h4><span class="text-lg">&#9888;</span></div>
                        <div id="dash-isg-widget" class="text-xs text-gray-400">Veri yok</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-orange-400">Stok Uyarilari</h4><span class="text-lg">&#128230;</span></div>
                        <div id="dash-stok-widget" class="text-xs text-gray-400">Veri yok</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-teal-400">Is Programi</h4><span class="text-lg">&#128197;</span></div>
                        <div id="dash-program-widget" class="text-xs text-gray-400">Veri yok</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-yellow-400">Ekipman</h4><span class="text-lg">&#128296;</span></div>
                        <div id="dash-ekipman-widget" class="text-xs text-gray-400">Veri yok</div>
                    </div>
                </div>
                <!-- Yonetici Kontrol Paneli -->
                <div id="admin-control-panel" class="glass rounded-xl p-5 mb-6 border border-blue-500/10" style="display:none">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">üõ°Ô∏è</span>
                            <h3 class="text-sm font-bold">Yonetici Kontrol Paneli</h3>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Admin</span>
                    </div>
                    <!-- Onay Bekleyenler -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4" id="admin-pending-cards"></div>
                    <!-- Hƒ±zlƒ± Aksiyonlar -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                        <button onclick="showModule('settings');switchSettingsTab('users')" class="p-2.5 rounded-lg bg-gray-800/40 hover:bg-gray-800/60 border border-gray-700/30 text-left transition-all">
                            <p class="text-[10px] text-gray-500">Kullanici</p>
                            <p class="text-xs font-medium">Yonetimi</p>
                        </button>
                        <button onclick="showModule('settings');switchSettingsTab('roles')" class="p-2.5 rounded-lg bg-gray-800/40 hover:bg-gray-800/60 border border-gray-700/30 text-left transition-all">
                            <p class="text-[10px] text-gray-500">Rol & Yetki</p>
                            <p class="text-xs font-medium">Yonetimi</p>
                        </button>
                        <button onclick="openAdminLog()" class="p-2.5 rounded-lg bg-gray-800/40 hover:bg-gray-800/60 border border-gray-700/30 text-left transition-all">
                            <p class="text-[10px] text-gray-500">Sistem</p>
                            <p class="text-xs font-medium">Aktivite Logu</p>
                        </button>
                        <button onclick="openAdminDataPanel()" class="p-2.5 rounded-lg bg-gray-800/40 hover:bg-gray-800/60 border border-gray-700/30 text-left transition-all">
                            <p class="text-[10px] text-gray-500">Veri</p>
                            <p class="text-xs font-medium">Yedek & Aktar</p>
                        </button>
                        <button onclick="openSyncPanel()" class="p-2.5 rounded-lg bg-blue-800/20 hover:bg-blue-800/40 border border-blue-500/20 text-left transition-all">
                            <p class="text-[10px] text-blue-400">‚òÅÔ∏è Bulut</p>
                            <p class="text-xs font-medium">Senkronizasyon</p>
                        </button>
                    </div>
                    <!-- Sistem Sagligi -->
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2" id="admin-system-health"></div>
                </div>
                <!-- Recent Activity -->
                <div class="glass rounded-xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold">Son Aktiviteler</h3>
                        <button onclick="clearActivities()" class="text-[11px] text-gray-500 hover:text-gray-300">Temizle</button>
                    </div>
                    <div id="activity-list" class="space-y-2 max-h-48 overflow-y-auto text-sm text-gray-400">
                        <p>Henuz aktivite kaydi yok.</p>
                    </div>
                </div>
            </div>

            <!-- ==================== FAON-CONNECT ==================== -->
            <div id="module-connect" class="hidden h-full">
                <div class="flex h-full">
                    <!-- Channel List -->
                    <div class="w-64 glass-strong border-r border-gray-700/50 flex flex-col">
                        <div class="p-3 border-b border-gray-700/50">
                            <div class="relative">
                                <svg class="w-4 h-4 text-gray-500 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                <input type="text" class="search-box pl-9 text-xs" placeholder="Kanal veya kisi ara...">
                            </div>
                        </div>
                        <div class="p-2">
                            <p class="text-[10px] text-gray-500 px-2 py-1 uppercase tracking-wider">Kanallar</p>
                        </div>
                        <div class="flex-1 overflow-y-auto px-2 space-y-0.5" id="channel-list"></div>
                        <div class="p-2 border-t border-gray-700/50 space-y-1">
                            <button onclick="openModal('modal-channel')" class="w-full text-xs text-center py-2 rounded-lg bg-blue-500/10 text-blue-400 hover:bg-blue-500/20 transition-colors">+ Yeni Kanal</button>
                            <button onclick="switchConnectView('files')" class="w-full text-xs text-center py-2 rounded-lg bg-purple-500/10 text-purple-400 hover:bg-purple-500/20 transition-colors flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                Dosyalar & Bilgi Bankasi
                            </button>
                            <button onclick="switchConnectView('meetings')" class="w-full text-xs text-center py-2 rounded-lg bg-green-500/10 text-green-400 hover:bg-green-500/20 transition-colors flex items-center justify-center gap-1.5 border border-green-500/20">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Toplanti
                            </button>
                            <button onclick="openDeletionRequests()" id="btn-deletion-requests" class="hidden w-full text-xs text-center py-2 rounded-lg bg-orange-500/10 text-orange-400 hover:bg-orange-500/20 transition-colors flex items-center justify-center gap-1.5 border border-orange-500/20">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Silme Talepleri <span id="deletion-request-badge" class="ml-1 px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold">0</span>
                            </button>
                            <button onclick="switchConnectView('ai')" class="w-full text-xs text-center py-2 rounded-lg bg-gradient-to-r from-amber-500/10 to-orange-500/10 text-amber-400 hover:from-amber-500/20 hover:to-orange-500/20 transition-colors flex items-center justify-center gap-1.5 border border-amber-500/20">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                FaOn AI Asistan
                            </button>
                        </div>
                    </div>
                    <!-- Chat Window -->
                    <div id="connect-chat-view" class="flex-1 flex flex-col">
                        <div class="h-12 glass-strong border-b border-gray-700/50 flex items-center px-4 gap-3 flex-shrink-0">
                            <span class="text-sm font-semibold" id="chat-header-name"># genel</span>
                            <button onclick="openChannelMembers()" class="text-[11px] text-gray-500 hover:text-blue-400 cursor-pointer transition-colors flex items-center gap-1" id="chat-header-info" title="Uyeleri yonet">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                <span>3 uye</span>
                            </button>
                            <div class="ml-auto flex items-center gap-2">
                                <button id="mute-toggle-btn" onclick="toggleMuteSound()" class="w-8 h-8 rounded-lg bg-gray-800/50 hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors" title="Sesi Ac/Kapa">&#128266;</button>
                                <button onclick="toggleMessageSearch()" class="w-8 h-8 rounded-lg bg-gray-800/50 hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors" title="Mesajlarda Ara">&#128269;</button>
                                <button onclick="openAddMemberModal()" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-green-400 transition-colors" title="Kisi Ekle"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg></button>
                                <button class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m-2.828-9.9a9 9 0 000 12.728"/></svg></button>
                                <button class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button>
                            </div>
                        </div>
                        <div id="msg-search-bar" class="hidden px-4 py-2 border-b border-gray-700/50 bg-gray-900/50">
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500 text-sm">&#128269;</span>
                                <input type="text" id="msg-search-input" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg pl-9 pr-20 py-2 text-xs text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" placeholder="Mesajlarda ara..." oninput="searchMessages(this.value)">
                                <div class="absolute right-2 top-1.5 flex items-center gap-1">
                                    <label class="flex items-center gap-1 text-[9px] text-gray-500"><input type="checkbox" id="msg-search-all-channels" class="rounded" onchange="searchMessages(document.getElementById('msg-search-input').value)"> Tum kanallar</label>
                                    <button onclick="toggleMessageSearch()" class="text-gray-500 hover:text-white text-sm ml-1">&times;</button>
                                </div>
                            </div>
                            <div id="msg-search-results" class="mt-2 max-h-48 overflow-y-auto hidden"></div>
                            <div id="msg-search-count" class="text-[10px] text-gray-500 mt-1 hidden"></div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="chat-messages"></div>
                    <div id="typing-indicator" class="px-4 py-1 text-[10px] text-gray-500 italic hidden"></div>
                    <div id="reply-indicator" class="hidden px-4 py-2 bg-gray-800/50 border-l-2 border-blue-500">
                        <div class="flex items-center justify-between"><span class="text-[11px] text-gray-400">Yanitlaniyor: <b id="reply-to-name" class="text-blue-400"></b></span><button onclick="cancelReply()" class="text-gray-500 hover:text-white text-sm">&times;</button></div>
                        <p id="reply-to-text" class="text-[10px] text-gray-500 truncate mt-0.5"></p>
                    </div>
                        <div class="p-3 border-t border-gray-700/50 flex gap-2 items-center">
                            <div class="relative">
                                <button onclick="toggleEmojiPicker()" class="p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-yellow-400 transition-colors" title="Emoji">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </button>
                                <div id="emoji-picker" class="hidden absolute bottom-12 left-0 glass-strong rounded-xl p-2 shadow-2xl z-50" style="width:240px">
                                    <div class="grid grid-cols-8 gap-1 text-lg cursor-pointer" id="emoji-grid"></div>
                                </div>
                            </div>
                            <button onclick="openConnFileUpload()" class="p-2 rounded-lg hover:bg-gray-800/50 text-gray-400 hover:text-purple-400 transition-colors" title="Dosya Ekle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                            </button>
                            <input type="text" id="msg-input" class="flex-1 bg-gray-800/60 border border-gray-700 rounded-lg px-4 py-2.5 text-sm outline-none focus:border-blue-500 transition-colors" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter')sendMessage()" oninput="handleTyping();handleMentionInput(event)">
                            <button onclick="sendMessage()" class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors">Gonder</button>
                        </div>
                    </div>
                    <!-- Files & Knowledge Base View -->
                    <div id="connect-files-view" class="flex-1 flex flex-col hidden">
                        <div class="h-12 glass-strong border-b border-gray-700/50 flex items-center px-4 gap-3 flex-shrink-0">
                            <button onclick="switchConnectView('chat')" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-blue-400 transition-colors" title="Sohbete Don">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            </button>
                            <span class="text-sm font-semibold">Dosyalar & Bilgi Bankasi</span>
                            <div class="ml-auto flex items-center gap-2">
                                <div class="flex gap-1" id="conn-file-tabs">
                                    <button class="tab-btn active text-[11px] px-3 py-1" onclick="switchFileTab('channel')">Kanal Dosyalari</button>
                                    <button class="tab-btn text-[11px] px-3 py-1" onclick="switchFileTab('kb')">Bilgi Bankasi</button>
                                </div>
                                <button onclick="openConnFileUpload()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 rounded-lg text-xs transition-colors">+ Dosya Yukle</button>
                            </div>
                        </div>
                        <div id="conn-file-tab-channel" class="flex-1 overflow-y-auto p-4">
                            <div id="conn-files-list"></div>
                        </div>
                        <div id="conn-file-tab-kb" class="flex-1 overflow-y-auto p-4 hidden">
                            <div id="kb-list"></div>
                        </div>
                    </div>
                    <!-- AI Assistant View -->
                    <div id="connect-ai-view" class="flex-1 flex hidden">
                        <!-- AI Sohbet Gecmisi Paneli -->
                        <div id="ai-history-panel" class="glass-strong flex-col">
                            <div class="p-3 border-b border-gray-700/50">
                                <button onclick="startNewAiSession()" class="w-full px-3 py-2 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1.5">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                    Yeni Sohbet
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="ai-session-list">
                                <p class="text-[10px] text-gray-500 text-center py-4">Sohbet gecmisi yukleniyor...</p>
                            </div>
                        </div>
                        <!-- AI Chat Ana Alani -->
                        <div class="flex-1 flex flex-col">
                        <div class="h-12 glass-strong border-b border-gray-700/50 flex items-center px-4 gap-3 flex-shrink-0">
                            <button onclick="switchConnectView('chat')" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-blue-400 transition-colors" title="Sohbete Don">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            </button>
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></div>
                                <div><span class="text-sm font-semibold">FaOn AI Asistan</span><p class="text-[9px] text-green-400">Aktif</p></div>
                            </div>
                            <div class="ml-auto flex items-center gap-2">
                                <button onclick="toggleAiHistory()" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-amber-400 transition-colors" title="Sohbet Gecmisi">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </button>
                                <button onclick="aiRunFullScan()" class="px-3 py-1.5 bg-amber-600/20 text-amber-400 hover:bg-amber-600/30 rounded-lg text-[11px] transition-colors border border-amber-500/20">Sistem Tara</button>
                                <button onclick="openAiMemoryPanel()" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-cyan-400 transition-colors" title="AI Hafiza Yonetimi">üß†</button>
                                <button onclick="clearAiChat()" class="p-1.5 rounded hover:bg-gray-800/50 text-gray-400 hover:text-red-400 transition-colors" title="Sohbeti Temizle"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="ai-chat-messages">
                            <div class="flex justify-start"><div class="msg-bubble msg-other" style="max-width:85%"><p class="text-[10px] text-amber-400 font-semibold mb-1">FaOn AI</p><p class="text-xs leading-relaxed">Merhaba! Ben FaOn AI Asistan. Sisteminizdeki tum verileri analiz edebilir, arama yapabilir ve raporlar olusturabilirim.<br><br><b class="text-amber-400">&#128202; Analiz Komutlari:</b><br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@analiz</code> - Sistem durumu ve ozet rapor<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@butce</code> - Butce analizi<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@taksit</code> - Taksit durumu<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@ihale</code> - Ihale ozeti<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@depo</code> - Envanter ve stok durumu<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@arac</code> - Filo ve arac durumu<br><br><b class="text-amber-400">&#128736; Yonetim:</b><br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@hatirlatma</code> - Hatirlatmalar<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@toplanti</code> - Toplanti takvimi<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@silme</code> - Silme talepleri<br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@bildir [kanal]</code> - Kanala bildirim gonder<br><br><b class="text-amber-400">&#128269; Arama:</b><br>&#8226; <code class="text-[10px] bg-gray-700 px-1 rounded">@ara [kelime]</code> - Tum sistemde arama<br><br>Veya dogrudan soru sorabilirsiniz!</p></div></div>
                        </div>
                        <div class="p-3 border-t border-gray-700/50">
                            <div class="flex gap-1.5 mb-1.5 overflow-x-auto pb-1" id="ai-quick-actions">
                                <button onclick="aiQuickAction('analiz')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-blue-500/10 text-blue-400 text-[10px] hover:bg-blue-500/20 transition-colors border border-blue-500/20">&#128202; Analiz</button>
                                <button onclick="aiQuickAction('hatirlatma')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-red-500/10 text-red-400 text-[10px] hover:bg-red-500/20 transition-colors border border-red-500/20">&#128276; Hatirlatma</button>
                                <button onclick="aiQuickAction('butce')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-green-500/10 text-green-400 text-[10px] hover:bg-green-500/20 transition-colors border border-green-500/20">&#128176; Butce</button>
                                <button onclick="aiQuickAction('taksit')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-purple-500/10 text-purple-400 text-[10px] hover:bg-purple-500/20 transition-colors border border-purple-500/20">&#128179; Taksit</button>
                                <button onclick="aiQuickAction('ihale')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-orange-500/10 text-orange-400 text-[10px] hover:bg-orange-500/20 transition-colors border border-orange-500/20">&#128230; Ihale</button>
                            </div>
                            <div class="flex gap-1.5 mb-2 overflow-x-auto pb-1">
                                <button onclick="aiQuickAction('depo')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-cyan-500/10 text-cyan-400 text-[10px] hover:bg-cyan-500/20 transition-colors border border-cyan-500/20">&#128230; Depo</button>
                                <button onclick="aiQuickAction('arac')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-teal-500/10 text-teal-400 text-[10px] hover:bg-teal-500/20 transition-colors border border-teal-500/20">&#128663; Araclar</button>
                                <button onclick="aiQuickAction('toplanti')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-indigo-500/10 text-indigo-400 text-[10px] hover:bg-indigo-500/20 transition-colors border border-indigo-500/20">&#128197; Toplanti</button>
                                <button onclick="aiQuickAction('silme')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-rose-500/10 text-rose-400 text-[10px] hover:bg-rose-500/20 transition-colors border border-rose-500/20">&#128465; Silme</button>
                                <button onclick="aiQuickAction('rapor')" class="flex-shrink-0 px-2.5 py-1 rounded-lg bg-amber-500/10 text-amber-400 text-[10px] hover:bg-amber-500/20 transition-colors border border-amber-500/20">&#128203; AI Rapor</button>
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- Custom AI Provider Dropdown -->
                                <div class="relative" id="ai-provider-dropdown-wrapper">
                                    <button type="button" id="ai-provider-btn" onclick="toggleAiProviderDropdown()" class="flex items-center gap-1.5 bg-gray-800/60 border border-gray-700 rounded-lg px-2.5 py-2.5 text-[11px] text-gray-300 outline-none hover:border-amber-500/50 focus:border-amber-500 transition-colors cursor-pointer whitespace-nowrap" title="AI Saglayici Sec">
                                        <span id="ai-provider-icon">ü§ñ</span>
                                        <span id="ai-provider-label">Otomatik</span>
                                        <svg class="w-3 h-3 ml-0.5 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                    </button>
                                    <div id="ai-provider-menu" class="hidden absolute bottom-full left-0 mb-1 w-48 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-50 overflow-hidden">
                                        <div class="py-1" id="ai-provider-options">
                                            <button onclick="selectAiProvider('','ü§ñ','Otomatik')" class="w-full text-left px-3 py-2 text-[11px] text-gray-300 hover:bg-amber-500/15 hover:text-amber-300 transition-colors flex items-center gap-2">
                                                <span class="text-sm">ü§ñ</span><span>Otomatik</span><span class="ml-auto text-[9px] text-gray-500">Varsayilan</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="ai-provider-select" value="">
                                <input type="text" id="ai-input" class="flex-1 bg-gray-800/60 border border-gray-700 rounded-lg px-4 py-2.5 text-sm outline-none focus:border-amber-500 transition-colors" placeholder="AI'a sor veya komut yaz... (@analiz, @hatirlatma...)" onkeydown="if(event.key==='Enter')sendAiMessage()">
                                <button onclick="sendAiMessage()" class="px-4 py-2.5 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 rounded-lg text-sm font-medium transition-colors">Sor</button>
                            </div>
                        </div>
                    </div><!-- /AI Chat Ana Alani -->
                    </div><!-- /connect-ai-view -->
                </div>
            </div>

            <!-- ==================== FAON-BUILD ==================== -->
            <div id="module-build" class="p-4 sm:p-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <div class="min-w-0">
                        <h3 class="text-lg font-bold">Proje Yonetimi</h3>
                        <p class="text-xs text-gray-400 hidden sm:block">Santiye bazli hakedis ve butce takibi</p>
                    </div>
                    <button onclick="openBuildForm()" class="px-3 py-1.5 sm:px-4 sm:py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-xs sm:text-sm transition-colors whitespace-nowrap ml-3">+ Yeni Proje</button>
                </div>
                <div class="overflow-x-auto pb-1 mb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                    <div class="flex gap-1 items-center min-w-max" id="build-tabs">
                        <button class="tab-btn active" onclick="switchBuildTab('list')">Projeler</button>
                        <button class="tab-btn" onclick="switchBuildTab('isKalemleri')">Is Kalemleri</button>
                        <button class="tab-btn" onclick="switchBuildTab('hakedis')">Hakedis</button>
                        <button class="tab-btn" onclick="switchBuildTab('taseronlar')">Taseronlar</button>
                        <button class="tab-btn" onclick="switchBuildTab('timeline')">Gantt</button>
                        <button class="tab-btn" onclick="switchBuildTab('gunluk')">S.Gunlugu</button>
                        <span class="text-gray-600 mx-1">|</span>
                        <button class="tab-btn group-btn" onclick="toggleBuildGroup('sahadan')">Sahadan &#9662;</button>
                        <button class="tab-btn group-btn" onclick="toggleBuildGroup('finans')">Finans &#9662;</button>
                        <button class="tab-btn group-btn" onclick="toggleBuildGroup('kalite')">Kalite &#9662;</button>
                        <button class="tab-btn group-btn" onclick="toggleBuildGroup('yonetim')">Yonetim &#9662;</button>
                    </div>
                </div>
                <!-- Sub-tab rows for groups -->
                <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
                    <div id="subtab-sahadan" class="subtab-row">
                        <button class="subtab-btn" onclick="switchBuildTab('yesilDefter')">Yesil Defter</button>
                        <button class="subtab-btn" onclick="switchBuildTab('ekipman')">Ekipman/Makine</button>
                    </div>
                    <div id="subtab-finans" class="subtab-row">
                        <button class="subtab-btn" onclick="switchBuildTab('sozlesme')">Sozlesme Yonetimi</button>
                        <button class="subtab-btn" onclick="switchBuildTab('nakitAkisi')">Nakit Akisi</button>
                        <button class="subtab-btn" onclick="switchBuildTab('metraj')">Metraj/Kesif</button>
                    </div>
                    <div id="subtab-kalite" class="subtab-row">
                        <button class="subtab-btn" onclick="switchBuildTab('isg')">ISG</button>
                        <button class="subtab-btn" onclick="switchBuildTab('kaliteKontrol')">Kalite Kontrol</button>
                    </div>
                    <div id="subtab-yonetim" class="subtab-row">
                        <button class="subtab-btn" onclick="switchBuildTab('yazisma')">Yazisma/Dokuman</button>
                        <button class="subtab-btn" onclick="switchBuildTab('isProgrami')">Is Programi</button>
                        <button class="subtab-btn" onclick="switchBuildTab('malzemeStok')">Malzeme/Stok</button>
                    </div>
                </div>
                <div id="build-tab-list">
                    <div id="projects-list" class="space-y-4"><p class="text-gray-500 text-sm">Henuz proje eklenmedi.</p></div>
                </div>
                <div id="build-tab-hakedis" class="hidden">
                    <div id="hakedis-table" class="glass rounded-xl overflow-hidden"></div>
                </div>
                <div id="build-tab-timeline" class="hidden">
                    <div id="timeline-view" class="glass rounded-xl p-6"></div>
                </div>
                <div id="build-tab-isKalemleri" class="hidden">
                    <div id="is-kalemleri-view" class="space-y-4"></div>
                </div>
                <div id="build-tab-taseronlar" class="hidden">
                    <div id="taseronlar-view" class="space-y-4"></div>
                </div>
                <div id="build-tab-gunluk" class="hidden">
                    <div id="gunluk-view" class="space-y-4"></div>
                </div>
                <!-- New Module Containers -->
                <div id="build-tab-yesilDefter" class="hidden"><div id="yesil-defter-view" class="space-y-4"></div></div>
                <div id="build-tab-ekipman" class="hidden"><div id="ekipman-view" class="space-y-4"></div></div>
                <div id="build-tab-sozlesme" class="hidden"><div id="sozlesme-view" class="space-y-4"></div></div>
                <div id="build-tab-nakitAkisi" class="hidden"><div id="nakit-akisi-view" class="space-y-4"></div></div>
                <div id="build-tab-metraj" class="hidden"><div id="metraj-view" class="space-y-4"></div></div>
                <div id="build-tab-isg" class="hidden"><div id="isg-view" class="space-y-4"></div></div>
                <div id="build-tab-kaliteKontrol" class="hidden"><div id="kalite-kontrol-view" class="space-y-4"></div></div>
                <div id="build-tab-yazisma" class="hidden"><div id="yazisma-view" class="space-y-4"></div></div>
                <div id="build-tab-isProgrami" class="hidden"><div id="is-programi-view" class="space-y-4"></div></div>
                <div id="build-tab-malzemeStok" class="hidden"><div id="malzeme-stok-view" class="space-y-4"></div></div>
            </div>

            <!-- ==================== FAON-SUPPLY ==================== -->
            <div id="module-supply" class="p-6 hidden">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h3 class="text-lg font-bold">Satinalma & Ihale Yonetimi</h3>
                        <p class="text-xs text-gray-400">Talep, ihale, teklif, siparis ve tedarikci yonetimi</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex gap-1" id="supply-tabs">
                            <button class="tab-btn active" onclick="switchSupplyTab('ozet')">Ozet</button>
                            <button class="tab-btn" onclick="switchSupplyTab('talepler')">Talepler</button>
                            <button class="tab-btn" onclick="switchSupplyTab('ihaleler')">Ihaleler</button>
                            <button class="tab-btn" onclick="switchSupplyTab('siparisler')">Siparisler</button>
                            <button class="tab-btn" onclick="switchSupplyTab('tedarikciler')">Tedarikciler</button>
                        </div>
                        <button id="supply-action-btn" onclick="openSupplyAction()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm transition-colors">+ Yeni Talep</button>
                    </div>
                </div>
                <div id="supply-tab-ozet"><div id="supply-ozet-view" class="space-y-4"></div></div>
                <div id="supply-tab-talepler" class="hidden"><div id="talepler-list" class="space-y-4"></div></div>
                <div id="supply-tab-ihaleler" class="hidden"><div id="ihaleler-list" class="space-y-4"></div></div>
                <div id="supply-tab-siparisler" class="hidden"><div id="siparisler-list" class="space-y-4"></div></div>
                <div id="supply-tab-tedarikciler" class="hidden"><div id="tedarikciler-havuz-list" class="space-y-4"></div></div>
            </div>

            <!-- ==================== FAON-SALES ==================== -->
            <div id="module-sales" class="p-6 hidden">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h3 class="text-lg font-bold">Satis & CRM</h3>
                        <p class="text-xs text-gray-400">Musteri takibi, pipeline ve taksit yonetimi</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex gap-1" id="sales-tabs">
                            <button class="tab-btn active" onclick="switchSalesTab('pipeline')">Pipeline</button>
                            <button class="tab-btn" onclick="switchSalesTab('list')">Liste</button>
                            <button class="tab-btn" onclick="switchSalesTab('installments')">Taksitler</button>
                        </div>
                        <button onclick="openSalesForm()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-colors">+ Yeni Satis</button>
                    </div>
                </div>
                <div id="sales-tab-pipeline">
                    <div class="flex gap-4 overflow-x-auto pb-4" id="pipeline-board"></div>
                </div>
                <div id="sales-tab-list" class="hidden">
                    <div id="sales-list" class="space-y-4"><p class="text-gray-500 text-sm">Henuz satis kaydi eklenmedi.</p></div>
                </div>
                <div id="sales-tab-installments" class="hidden">
                    <div id="installments-view"></div>
                </div>
            </div>

            <!-- ==================== REPORTS ==================== -->
            <div id="module-reports" class="p-6 hidden">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h3 class="text-lg font-bold">Raporlar & Analitik</h3>
                        <p class="text-xs text-gray-400">Detayli istatistikler ve performans metrikleri</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="report-date-start" class="bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-1.5 text-xs" onchange="renderReports()">
                        <span class="text-xs text-gray-500">-</span>
                        <input type="date" id="report-date-end" class="bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-1.5 text-xs" onchange="renderReports()">
                        <button onclick="clearDateFilter()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs transition-colors">Temizle</button>
                        <button onclick="printReport()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs transition-colors flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>Yazdir</button>
                    </div>
                </div>
                <!-- Rapor Olusturma Butonlari -->
                <div class="glass rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold">Rapor Olustur</h4>
                        <span class="text-[10px] text-gray-500">PDF veya Excel formatinda indir</span>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="glass rounded-lg p-3 hover:border-blue-500/30 transition-colors cursor-pointer" onclick="downloadReport('project','pdf')">
                            <div class="text-lg mb-1">&#128196;</div>
                            <p class="text-xs font-medium">Proje Raporu</p>
                            <p class="text-[9px] text-gray-500">PDF</p>
                        </div>
                        <div class="glass rounded-lg p-3 hover:border-green-500/30 transition-colors cursor-pointer" onclick="downloadReport('cost','pdf')">
                            <div class="text-lg mb-1">&#128176;</div>
                            <p class="text-xs font-medium">Maliyet Analizi</p>
                            <p class="text-[9px] text-gray-500">PDF</p>
                        </div>
                        <div class="glass rounded-lg p-3 hover:border-purple-500/30 transition-colors cursor-pointer" onclick="downloadReport('cashflow','pdf')">
                            <div class="text-lg mb-1">&#128200;</div>
                            <p class="text-xs font-medium">Nakit Akisi</p>
                            <p class="text-[9px] text-gray-500">PDF</p>
                        </div>
                        <div class="glass rounded-lg p-3 hover:border-orange-500/30 transition-colors cursor-pointer" onclick="downloadReport('export','excel')">
                            <div class="text-lg mb-1">&#128202;</div>
                            <p class="text-xs font-medium">Veri Aktar</p>
                            <p class="text-[9px] text-gray-500">Excel</p>
                        </div>
                    </div>
                </div>
                <!-- AI Raporlari -->
                <div class="glass rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold">&#129302; AI Raporlari</h4>
                        <button onclick="loadAiReports()" class="text-[10px] text-amber-400 hover:text-amber-300">Yenile</button>
                    </div>
                    <div class="grid grid-cols-5 gap-2 mb-3">
                        <button onclick="createAiReport('proje_ozet')" class="p-2 rounded-lg bg-blue-500/10 text-blue-400 text-[10px] hover:bg-blue-500/20 border border-blue-500/20 text-center">Proje Ozet</button>
                        <button onclick="createAiReport('maliyet_analiz')" class="p-2 rounded-lg bg-green-500/10 text-green-400 text-[10px] hover:bg-green-500/20 border border-green-500/20 text-center">Maliyet</button>
                        <button onclick="createAiReport('nakit_akis')" class="p-2 rounded-lg bg-purple-500/10 text-purple-400 text-[10px] hover:bg-purple-500/20 border border-purple-500/20 text-center">Nakit Akisi</button>
                        <button onclick="createAiReport('performans')" class="p-2 rounded-lg bg-teal-500/10 text-teal-400 text-[10px] hover:bg-teal-500/20 border border-teal-500/20 text-center">Performans</button>
                        <button onclick="createAiReport('risk')" class="p-2 rounded-lg bg-red-500/10 text-red-400 text-[10px] hover:bg-red-500/20 border border-red-500/20 text-center">Risk</button>
                    </div>
                    <div id="ai-reports-list" class="space-y-2">
                        <p class="text-xs text-gray-500 text-center py-2">AI raporlari yukleniyor...</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass rounded-xl p-5">
                        <h4 class="text-sm font-semibold mb-4">Modul Bazli Ozet</h4>
                        <div id="report-module-summary" class="space-y-3"></div>
                    </div>
                    <div class="glass rounded-xl p-5">
                        <h4 class="text-sm font-semibold mb-4">Aylik Trend</h4>
                        <div class="flex items-end gap-2 h-40" id="report-chart"></div>
                    </div>
                </div>
                <div class="glass rounded-xl p-5">
                    <h4 class="text-sm font-semibold mb-4">Tum Islemler</h4>
                    <div id="report-all-transactions" class="max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <!-- ==================== SETTINGS ==================== -->
            <div id="module-settings" class="p-6 hidden">
                <h3 class="text-lg font-bold mb-5">Sistem Ayarlari</h3>
                <div class="flex gap-2 mb-5">
                    <button class="tab-btn active" onclick="switchSettingsTab('users')">Kullanicilar</button>
                    <button class="tab-btn" onclick="switchSettingsTab('roles')">Roller</button>
                    <button class="tab-btn" onclick="switchSettingsTab('general')">Genel</button>
                    <button class="tab-btn" onclick="switchSettingsTab('kategoriler')">Kategoriler</button>
                    <button class="tab-btn" onclick="switchSettingsTab('bildirimler')">Bildirimler</button>
                    <button class="tab-btn" onclick="switchSettingsTab('belgeSablonlari')">Belge Sablonlari</button>
                </div>
                <div id="settings-tab-users">
                    <div class="glass rounded-xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-sm">Sistemdeki Kullanicilar</h4>
                            <button onclick="openModal('modal-user')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">+ Kullanici Ekle</button>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="users-table">
                            <thead class="border-b border-gray-700"><tr class="text-left text-gray-400 text-xs"><th class="pb-3">Ad Soyad</th><th class="pb-3">Telefon</th><th class="pb-3">E-posta</th><th class="pb-3">Rol</th><th class="pb-3">Durum</th><th class="pb-3">Islem</th></tr></thead>
                            <tbody class="divide-y divide-gray-800" id="users-tbody"></tbody>
                        </table>
                        </div>
                    </div>
                </div>
                <div id="settings-tab-roles" class="hidden">
                    <div class="glass rounded-xl p-5" id="roles-view"></div>
                </div>
                <div id="settings-tab-general" class="hidden">
                    <div class="glass rounded-xl p-5" id="general-settings"></div>
                </div>
                <div id="settings-tab-kategoriler" class="hidden">
                    <div class="glass rounded-xl p-5" id="kategoriler-view"></div>
                </div>
                <div id="settings-tab-bildirimler" class="hidden">
                    <div class="glass rounded-xl p-5" id="bildirim-ayarlar-view"></div>
                </div>
                <div id="settings-tab-belgeSablonlari" class="hidden">
                    <div class="glass rounded-xl p-5" id="belge-sablonlari-view"></div>
                </div>
            </div>
            <!-- FaOn-HR Module -->
            <div id="module-hr" class="p-4 sm:p-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <div class="min-w-0">
                        <h3 class="text-lg font-bold">Insan Kaynaklari Yonetimi</h3>
                        <p class="text-xs text-gray-400 hidden sm:block">Personel, departman, izin ve belge takibi</p>
                    </div>
                    <button id="hr-add-btn" onclick="openPersonelForm()" class="px-3 py-1.5 sm:px-4 sm:py-2 bg-teal-600 hover:bg-teal-700 rounded-lg text-xs sm:text-sm transition-colors whitespace-nowrap ml-3">+ Yeni Personel</button>
                </div>
                <div class="overflow-x-auto pb-1 mb-4 -mx-4 px-4 sm:mx-0 sm:px-0">
                    <div class="flex gap-1 items-center min-w-max">
                        <button class="tab-btn active" onclick="switchHrTab('personeller')">Personeller</button>
                        <button class="tab-btn" onclick="switchHrTab('departmanlar')">Departmanlar</button>
                        <button class="tab-btn" onclick="switchHrTab('izinler')">Izin Takibi</button>
                        <button class="tab-btn" onclick="switchHrTab('belgeler')">Belgeler</button>
                        <button class="tab-btn" onclick="switchHrTab('ozet')">IK Ozeti</button>
                        <button class="tab-btn" onclick="switchHrTab('puantaj')">Puantaj</button>
                    </div>
                </div>
                <div id="hr-tab-personeller"></div>
                <div id="hr-tab-departmanlar" class="hidden"></div>
                <div id="hr-tab-izinler" class="hidden"></div>
                <div id="hr-tab-belgeler" class="hidden"></div>
                <div id="hr-tab-ozet" class="hidden"></div>
                <div id="hr-tab-puantaj" class="hidden"></div>
            </div>
            <!-- FaOn-Depo Module -->
            <div id="module-depo" class="p-4 sm:p-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <div class="min-w-0">
                        <h3 class="text-lg font-bold">Envanter & Depo Yonetimi</h3>
                        <p class="text-xs text-gray-400 hidden sm:block">Sirket geneli stok, depo ve envanter takibi</p>
                    </div>
                    <button id="depo-add-btn" onclick="openDepoItemForm()" class="px-3 py-1.5 sm:px-4 sm:py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs sm:text-sm transition-colors whitespace-nowrap ml-3">+ Yeni Ekle</button>
                </div>
                <div class="overflow-x-auto pb-1 mb-4 -mx-4 px-4 sm:mx-0 sm:px-0">
                    <div class="flex gap-1 items-center min-w-max">
                        <button class="tab-btn active" onclick="switchDepoTab('envanter')">Genel Envanter</button>
                        <button class="tab-btn" onclick="switchDepoTab('depolar')">Depolar</button>
                        <button class="tab-btn" onclick="switchDepoTab('hareketler')">Hareketler</button>
                        <button class="tab-btn" onclick="switchDepoTab('sayim')">Sayim</button>
                        <button class="tab-btn" onclick="switchDepoTab('zimmet')">Zimmet</button>
                        <button class="tab-btn" onclick="switchDepoTab('arac')">Arac/Filo</button>
                    </div>
                </div>
                <div id="depo-tab-envanter"></div>
                <div id="depo-tab-depolar" class="hidden"></div>
                <div id="depo-tab-hareketler" class="hidden"></div>
                <div id="depo-tab-sayim" class="hidden"></div>
                <div id="depo-tab-zimmet" class="hidden"></div>
                <div id="depo-tab-arac" class="hidden"></div>
            </div>
        </div>
    </main>
</div>

<!-- ==================== MODALS ==================== -->
<!-- Build Project Modal -->
<div id="modal-build" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Yeni Proje Ekle</h3>
            <button onclick="closeModal('modal-build')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addProject(event)" class="space-y-4">
            <p class="text-xs text-purple-400 font-semibold border-b border-gray-700 pb-1">TEMEL BILGILER</p>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Adi *</label><input type="text" name="name" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Atasehir Rezidans A Blok"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Tipi *</label><select name="projectType" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" id="build-project-type"><option value="">Seciniz...</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Konum</label><input type="text" name="location" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Atasehir, Istanbul"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme Tipi</label><select name="contractType" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" id="build-contract-type"><option value="goturu">Goturu Bedel</option></select></div>
            </div>
            <p class="text-xs text-green-400 font-semibold border-b border-gray-700 pb-1 pt-2">FINANSAL BILGILER</p>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme Bedeli (‚Ç∫) *</label><input type="number" name="contractAmount" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="42000000"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Butce (‚Ç∫) *</label><input type="number" name="budget" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="45000000"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Muteahhit *</label><input type="text" name="contractor" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="FaOn Insaat A.S."></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Baslangic Tarihi</label><input type="date" name="startDate" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Bitis Tarihi</label><input type="date" name="endDate" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Muduru *</label><select name="manager" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" id="build-manager-select"><option value="">Seciniz...</option></select></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notes" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Proje detaylari, ozel notlar..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-build')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Talep Modal -->
<div id="modal-talep" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Yeni Satinalma Talebi</h3>
            <button onclick="closeModal('modal-talep')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addTalep(event)" class="space-y-4">
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje</label><select name="projectId" id="talep-project-select" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Genel</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Departman *</label><select name="departman" id="talep-departman" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="santiye">Santiye</option><option value="ofis">Ofis</option><option value="muhasebe">Muhasebe</option><option value="yonetim">Yonetim</option><option value="depo">Depo</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Aciliyet</label><select name="aciliyet" id="talep-aciliyet" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="normal">Normal</option><option value="acil">Acil</option><option value="yuksek">Yuksek</option><option value="dusuk">Dusuk</option></select></div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-2"><label class="text-xs text-gray-400 font-bold">Kalemler</label><button type="button" onclick="addTalepKalem()" class="text-xs text-orange-400 hover:text-orange-300">+ Kalem Ekle</button></div>
                <table class="w-full text-xs"><thead class="text-gray-500"><tr><th class="text-left p-1">Malzeme *</th><th class="text-right p-1">Miktar *</th><th class="text-left p-1">Birim</th><th class="text-right p-1">Tahm. Fiyat</th><th class="p-1"></th></tr></thead><tbody id="talep-kalemler-body"></tbody></table>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Ek aciklamalar..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Talep Olustur</button>
                <button type="button" onclick="closeModal('modal-talep')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Ihale Modal (multi-kalem) -->
<div id="modal-supply" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold" id="ihale-modal-title">Yeni Ihale</h3>
            <button onclick="closeModal('modal-supply')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addIhale(event)" class="space-y-4">
            <input type="hidden" name="talepIds" id="ihale-talep-ids" value="">
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Ihale Basligi *</label><input type="text" name="baslik" id="ihale-baslik" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="A Blok Demir Alimi"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje</label><select name="projectId" id="ihale-project-select" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Genel</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Ihale Tipi</label><select name="ihaleTipi" id="ihale-tipi-select" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="acik">Acik Ihale</option><option value="kapaliZarf">Kapali Zarf</option><option value="dogrudan">Dogrudan Temin</option><option value="pazarlik">Pazarlik Usulu</option></select></div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-2"><label class="text-xs text-gray-400 font-bold">Ihale Kalemleri</label><button type="button" onclick="addIhaleKalem()" class="text-xs text-orange-400 hover:text-orange-300">+ Kalem Ekle</button></div>
                <table class="w-full text-xs"><thead class="text-gray-500"><tr><th class="text-left p-1">Malzeme *</th><th class="text-right p-1">Miktar *</th><th class="text-left p-1">Birim</th><th class="p-1"></th></tr></thead><tbody id="ihale-kalemler-body"></tbody></table>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Ihale Olustur</button>
                <button type="button" onclick="closeModal('modal-supply')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Teklif Modal -->
<div id="modal-teklif" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Teklif Ekle</h3>
            <button onclick="closeModal('modal-teklif')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addTeklif(event)" class="space-y-4">
            <input type="hidden" name="ihaleId" id="teklif-ihale-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tedarikci *</label><select name="tedarikciId" id="teklif-tedarikci-select" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Teslim Suresi (gun) *</label><input type="number" name="teslimat" required value="14" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Odeme Kosulu</label><input type="text" name="odemeKosulu" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="30 gun vadeli"></div>
            <div>
                <label class="text-xs text-gray-400 font-bold mb-2 block">Birim Fiyatlar (TL)</label>
                <table class="w-full text-xs"><thead class="text-gray-500"><tr><th class="text-left p-1">Malzeme</th><th class="text-right p-1">Miktar</th><th class="text-right p-1">Birim Fiyat *</th><th class="text-right p-1">Toplam</th></tr></thead><tbody id="teklif-birimfiyat-body"></tbody></table>
                <div class="mt-2 text-right"><span class="text-xs text-gray-400">Genel Toplam: </span><span id="teklif-toplam-display" class="text-sm font-bold text-orange-400">-</span></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Teklif Ekle</button>
                <button type="button" onclick="closeModal('modal-teklif')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Tedarikci Havuz Modal -->
<div id="modal-tedarikci-havuz" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold" id="tedarikci-havuz-title">Yeni Tedarikci</h3>
            <button onclick="closeModal('modal-tedarikci-havuz')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addTedarikciHavuz(event)" class="space-y-4">
            <input type="hidden" name="editId" id="tedarikci-havuz-id" value="">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Firma Adi *</label><input type="text" name="firma" id="th-firma" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Vergi No</label><input type="text" name="vergiNo" id="th-vergiNo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Adres</label><input type="text" name="adres" id="th-adres" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Yetkili Kisi *</label><input type="text" name="yetkili" id="th-yetkili" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Telefon</label><input type="text" name="telefon" id="th-telefon" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Email</label><input type="email" name="email" id="th-email" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Kategoriler</label>
                <div class="flex flex-wrap gap-2" id="th-kategoriler">
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="demir">demir</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="celik">celik</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="beton">beton</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="cimento">cimento</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="boya">boya</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="elektrik">elektrik</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="mekanik">mekanik</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="tesisat">tesisat</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="izolasyon">izolasyon</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="kaplama">kaplama</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="ahsap">ahsap</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="insaat">insaat</label>
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" name="kategoriler" value="genel">genel</label>
                </div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notlar" id="th-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-tedarikci-havuz')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Ihale Detay Modal -->
<div id="modal-ihale-detay" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold" id="ihale-detay-title">Ihale Detay</h3>
            <button onclick="closeModal('modal-ihale-detay')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <div id="ihale-detay-content"></div>
    </div>
</div>
<!-- Siparis Detay Modal -->
<div id="modal-siparis-detay" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold" id="siparis-detay-title">Siparis Detay</h3>
            <button onclick="closeModal('modal-siparis-detay')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <div id="siparis-detay-content"></div>
    </div>
</div>
<!-- Teslimat Modal -->
<div id="modal-teslimat" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Teslimat Kaydi</h3>
            <button onclick="closeModal('modal-teslimat')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addTeslimat(event)" class="space-y-4">
            <input type="hidden" name="orderId" id="teslimat-siparis-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Malzeme *</label><select name="malzeme" id="teslimat-malzeme" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Miktar *</label><input type="number" name="miktar" required step="any" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="teslimat-tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Irsaliye No</label><input type="text" name="irsaliyeNo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="IRS-2025/001"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Hedef Depo</label><select name="depoId" id="teslimat-depo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Seciniz...</option></select></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Teslimat Kaydet</button>
                <button type="button" onclick="closeModal('modal-teslimat')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Sales Modal -->
<div id="modal-sales" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Yeni Satis Ekle</h3>
            <button onclick="closeModal('modal-sales')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addSale(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Musteri Adi *</label><input type="text" name="customer" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Ali Yilmaz"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Telefon</label><input type="text" name="phone" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0532 XXX XX XX"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Urun/Daire *</label><input type="text" name="product" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Cengelkoy Villa - A2 Blok"></div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Satis Fiyati (TL) *</label><input type="number" name="price" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="4500000"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Taksit Sayisi</label><input type="number" name="installments" value="1" min="1" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Asama</label><select name="stage" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="lead">Potansiyel</option><option value="meeting">Gorusme</option><option value="proposal">Teklif</option><option value="negotiation">Muzakere</option><option value="contract">Sozlesme</option></select></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Satisi Kaydet</button>
                <button type="button" onclick="closeModal('modal-sales')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Channel Modal -->
<div id="modal-channel" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Yeni Kanal</h3>
            <button onclick="closeModal('modal-channel')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addChannel(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Kanal Adi *</label><input type="text" name="channelName" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="proje-takip"></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Olustur</button>
                <button type="button" onclick="closeModal('modal-channel')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Channel Members Modal -->
<div id="modal-members" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold" id="members-modal-title">Kanal Uyeleri</h3>
            <button onclick="closeModal('modal-members')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <div id="members-list" class="space-y-2 max-h-64 overflow-y-auto mb-4"></div>
        <div class="border-t border-gray-700 pt-4">
            <h4 class="text-xs text-gray-400 mb-2">Kisi Ekle</h4>
            <div id="members-add-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
        </div>
        <div class="flex justify-end pt-3">
            <button onclick="closeModal('modal-members')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm transition-colors">Kapat</button>
        </div>
    </div>
</div>
<!-- File Upload Modal -->
<div id="modal-conn-file" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Dosya Yukle</h3>
            <button onclick="closeModal('modal-conn-file')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="uploadConnFile(event)" class="space-y-4">
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Dosya Sec *</label>
                <div id="file-drop-zone" class="border-2 border-dashed border-gray-600 rounded-xl p-6 text-center hover:border-purple-500 transition-colors cursor-pointer" onclick="document.getElementById('conn-file-input').click()" ondragover="event.preventDefault();this.classList.add('border-purple-500','bg-purple-500/5')" ondragleave="this.classList.remove('border-purple-500','bg-purple-500/5')" ondrop="event.preventDefault();this.classList.remove('border-purple-500','bg-purple-500/5');handleFileDrop(event)">
                    <div id="file-drop-content">
                        <svg class="w-10 h-10 mx-auto text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p class="text-sm text-gray-400">Dosya secmek icin tiklayin</p>
                        <p class="text-[10px] text-gray-600 mt-1">veya surukleyip birakin</p>
                    </div>
                    <div id="file-selected-info" class="hidden">
                        <div class="flex items-center justify-center gap-3">
                            <span id="file-selected-icon" class="text-3xl"></span>
                            <div class="text-left">
                                <p id="file-selected-name" class="text-sm font-semibold"></p>
                                <p id="file-selected-meta" class="text-[10px] text-gray-400"></p>
                            </div>
                        </div>
                        <button type="button" onclick="event.stopPropagation();clearFileSelection()" class="mt-2 text-[10px] text-red-400 hover:text-red-300">Degistir</button>
                    </div>
                </div>
                <input type="file" id="conn-file-input" class="hidden" onchange="handleFileSelect(this)">
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama (istege bagli)</label><input type="text" name="fileDesc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Dosya hakkinda kisa not..."></div>
            <div class="glass rounded-lg p-2.5 flex items-center gap-2">
                <svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div><label class="block text-xs mb-1.5 text-gray-400">Kategori</label><select name="fileCategory" id="file-category-select" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Otomatik Algilansin</option><option value="Prosedur">Prosedur</option><option value="Sablonlar">Sablonlar</option><option value="Teknik">Teknik Cizim</option><option value="Egitim">Egitim</option><option value="Sozlesme">Sozlesme</option><option value="Rapor">Rapor</option><option value="Hakedis">Hakedis</option><option value="Yazisma">Yazisma</option><option value="ISG">ISG</option><option value="Kalite">Kalite</option><option value="Fotograf">Fotograf</option><option value="Mali Belge">Mali Belge</option><option value="Diger">Diger</option></select></div>
                <span class="text-[11px] text-gray-400">Dosya otomatik olarak Bilgi Bankasina da eklenir</span>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" id="file-upload-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2.5 rounded-lg font-medium text-sm transition-colors opacity-50 cursor-not-allowed" disabled>Yukle & Paylas</button>
                <button type="button" onclick="closeModal('modal-conn-file')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Dosya Onizleme Modal -->
<div id="modal-file-preview" class="modal">
    <div class="modal-content" style="max-width:900px;width:95%;max-height:95vh;">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <span id="preview-file-icon" class="text-2xl"></span>
                <div>
                    <h3 id="preview-file-name" class="text-sm font-bold"></h3>
                    <p id="preview-file-meta" class="text-[10px] text-gray-400"></p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="preview-download-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs font-medium transition-colors flex items-center gap-1">&#11015; Indir</button>
                <button onclick="closeModal('modal-file-preview')" class="text-gray-400 hover:text-white text-lg">&times;</button>
            </div>
        </div>
        <div id="preview-content" class="rounded-lg overflow-hidden bg-gray-900/50 flex items-center justify-center" style="min-height:400px;max-height:75vh;overflow:auto;"></div>
    </div>
</div>
<!-- Silme Talep Modal (Normal kullanici) -->
<div id="modal-delete-request" class="modal">
    <div class="modal-content" style="max-width:440px;">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center"><span class="text-orange-400 text-xl">&#128465;</span></div>
            <div>
                <h3 class="text-sm font-bold text-orange-400">Silme Talebi</h3>
                <p id="delete-request-msg" class="text-[11px] text-gray-400"></p>
            </div>
        </div>
        <div class="mb-3">
            <label class="text-[10px] text-gray-500 block mb-1">Silme Sebebi (opsiyonel)</label>
            <input type="text" id="delete-request-reason" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-200 placeholder-gray-500" placeholder="Neden silinmeli?">
        </div>
        <div class="p-2.5 rounded-lg bg-blue-500/10 border border-blue-500/20 mb-3">
            <p class="text-[10px] text-blue-400"><span class="font-semibold">&#8505;</span> Silme talebiniz yoneticiye iletilecek. Yonetici onayladiktan sonra dosya silinecektir.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="submitDeleteRequest()" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg text-sm font-medium transition-colors">Talep Gonder</button>
            <button onclick="closeModal('modal-delete-request')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Silme Onay Modal (Yonetici icin dogrudan silme) -->
<div id="modal-confirm-delete" class="modal">
    <div class="modal-content" style="max-width:420px;">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center"><span class="text-red-400 text-xl">&#9888;</span></div>
            <div>
                <h3 class="text-sm font-bold text-red-400">Yonetici Silme Onayi</h3>
                <p id="delete-confirm-msg" class="text-[11px] text-gray-400"></p>
            </div>
        </div>
        <div id="delete-permission-warning" class="hidden mb-3 p-2 rounded-lg bg-red-500/10 border border-red-500/20 text-[10px] text-red-400"></div>
        <div class="flex gap-2">
            <button onclick="executeDelete()" class="flex-1 bg-red-600 hover:bg-red-700 py-2.5 rounded-lg text-sm font-medium transition-colors">Evet, Sil</button>
            <button onclick="closeModal('modal-confirm-delete')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Yonetici Silme Talepleri Paneli -->
<div id="modal-deletion-requests" class="modal">
    <div class="modal-content" style="max-width:600px;max-height:80vh;">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2"><span class="text-orange-400">&#128465;</span> Silme Talepleri</h3>
            <button onclick="closeModal('modal-deletion-requests')" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div id="deletion-requests-list" class="space-y-3 overflow-y-auto" style="max-height:60vh;"></div>
    </div>
</div>
<!-- Toplanti Olusturma Modal -->
<div id="modal-create-meeting" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">&#128197; Yeni Toplanti</h3>
            <button onclick="closeModal('modal-create-meeting')" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <form onsubmit="addMeeting(event)" class="space-y-3">
            <div><label class="block text-xs mb-1 text-gray-400">Baslik *</label><input name="meetingTitle" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Toplanti basligi"></div>
            <div><label class="block text-xs mb-1 text-gray-400">Aciklama</label><textarea name="meetingDesc" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Opsiyonel aciklama"></textarea></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Baslangic *</label><input type="datetime-local" name="meetingStart" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Bitis *</label><input type="datetime-local" name="meetingEnd" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1 text-gray-400">Katilimcilar (virgul ile)</label><input name="meetingParticipants" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Tarik Oniz, Mehmet Kaya"></div>
            <div><label class="block text-xs mb-1 text-gray-400">Kanal</label><select name="meetingChannel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Kanal secin (opsiyonel)</option></select></div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg text-sm font-medium transition-colors">Toplanti Olustur</button>
        </form>
    </div>
</div>
<!-- User Modal -->
<div id="modal-user" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">Kullanici Ekle</h3>
            <button onclick="closeModal('modal-user')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="addUser(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Ad Soyad *</label><input type="text" name="userName" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Ahmet Yilmaz"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Telefon Numarasi *</label><input type="tel" name="userPhone" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="05XX XXX XX XX"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">E-posta *</label><input type="email" name="userEmail" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="kullanici@firma.com"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Rol *</label><select name="userRole" id="add-user-role-select" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet & Bildirim Gonder</button>
                <button type="button" onclick="closeModal('modal-user')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>

<!-- Global Search Overlay -->
<div id="search-overlay" class="search-overlay" onclick="if(event.target===this)closeGlobalSearch()">
    <div class="glass-strong rounded-2xl p-4 w-full max-w-lg">
        <div class="relative mb-3">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" id="global-search-input" class="w-full bg-gray-800/80 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-sm outline-none focus:border-blue-500" placeholder="Proje, ihale, satis veya musteri ara..." oninput="doGlobalSearch(this.value)" autofocus>
        </div>
        <div id="global-search-results" class="space-y-1 max-h-64 overflow-y-auto"></div>
        <p class="text-[10px] text-gray-600 mt-2 text-center">ESC ile kapat &middot; Ctrl+K ile ac</p>
    </div>
</div>
<!-- Edit Project Modal -->
<div id="modal-edit-project" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Proje Duzenle</h3><button onclick="closeModal('modal-edit-project')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="saveEditProject(event)" class="space-y-4">
            <input type="hidden" name="editId" id="edit-project-id">
            <p class="text-xs text-purple-400 font-semibold border-b border-gray-700 pb-1">TEMEL BILGILER</p>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Adi *</label><input type="text" name="name" id="edit-p-name" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Tipi</label><select name="projectType" id="edit-p-projectType" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Konum</label><input type="text" name="location" id="edit-p-location" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme Tipi</label><select name="contractType" id="edit-p-contractType" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
            </div>
            <p class="text-xs text-green-400 font-semibold border-b border-gray-700 pb-1 pt-2">FINANSAL BILGILER</p>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme Bedeli (‚Ç∫)</label><input type="number" name="contractAmount" id="edit-p-contractAmount" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Butce (‚Ç∫)</label><input type="number" name="budget" id="edit-p-budget" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Harcanan (‚Ç∫)</label><input type="number" name="spent" id="edit-p-spent" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Muteahhit</label><input type="text" name="contractor" id="edit-p-contractor" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Baslangic</label><input type="date" name="startDate" id="edit-p-startDate" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Bitis</label><input type="date" name="endDate" id="edit-p-endDate" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje Muduru</label><select name="manager" id="edit-p-manager" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tamamlanma %</label><input type="number" name="completion" id="edit-p-completion" min="0" max="100" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notes" id="edit-p-notes" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Guncelle</button><button type="button" onclick="closeModal('modal-edit-project')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
        </form>
    </div>
</div>
<!-- Taseron Modal -->
<div id="modal-taseron" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Taseron Ekle</h3><button onclick="closeModal('modal-taseron')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addTaseron(event)" class="space-y-4">
            <input type="hidden" id="taseron-project-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Firma Adi *</label><input type="text" name="firma" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="ABC Insaat Ltd."></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Is Paketi *</label><select name="isPaketi" id="taseron-is-paketi" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Yetkili Kisi</label><input type="text" name="yetkili" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Ahmet Yilmaz"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Telefon</label><input type="text" name="telefon" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0532..."></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme Tutari (‚Ç∫) *</label><input type="number" name="tutar" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="2500000"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Baslangic Tarihi</label><input type="date" name="baslangic" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Kapsam / Notlar</label><textarea name="kapsam" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Yapilacak isler..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Taseron Ekle</button>
                <button type="button" onclick="closeModal('modal-taseron')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Tedarikci Modal -->
<div id="modal-tedarikci" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Tedarikci Ekle</h3><button onclick="closeModal('modal-tedarikci')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addTedarikci(event)" class="space-y-4">
            <input type="hidden" id="tedarikci-project-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Firma Adi *</label><input type="text" name="firma" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="XYZ Malzeme A.S."></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Malzeme Turu *</label><input type="text" name="malzeme" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Demir, Cimento, Beton..."></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Yetkili Kisi</label><input type="text" name="yetkili" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Telefon</label><input type="text" name="telefon" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Toplam Tutar (‚Ç∫)</label><input type="number" name="tutar" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Puan (1-5)</label><input type="number" name="puan" min="1" max="5" value="3" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Tedarikci Ekle</button>
                <button type="button" onclick="closeModal('modal-tedarikci')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Is Kalemi Modal -->
<div id="modal-iskalemi" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Is Kalemi Ekle</h3><button onclick="closeModal('modal-iskalemi')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addIsKalemi(event)" class="space-y-4">
            <input type="hidden" id="iskalemi-project-id">
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Poz No *</label><input type="text" name="pozNo" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="04.013/1"></div>
                <div class="col-span-2"><label class="block text-xs mb-1.5 text-gray-400">Is Kalemi Adi *</label><input type="text" name="kalemAdi" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Betonarme kalip yapilmasi"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Kategori</label><select name="kategori" id="iskalemi-kategori" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Taseron (Opsiyonel)</label><select name="taseronId" id="iskalemi-taseron" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Seciniz...</option></select></div>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Miktar *</label><input type="number" name="miktar" required step="0.01" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="1500"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Birim</label><select name="birim" id="iskalemi-birim" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Birim Fiyat (‚Ç∫) *</label><input type="number" name="birimFiyat" required step="0.01" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="450"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Agirlik %</label><input type="number" name="agirlik" min="0" max="100" step="0.1" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="15"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Is Kalemi Ekle</button>
                <button type="button" onclick="closeModal('modal-iskalemi')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Hakedis Modal (Profesyonel) -->
<div id="modal-hakedis" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-6xl max-h-[95vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Hakedis Olustur</h3><button onclick="closeModal('modal-hakedis')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addHakedis(event)" class="space-y-4">
            <input type="hidden" id="hakedis-project-id">
            <p class="text-xs text-purple-400 font-semibold border-b border-gray-700 pb-1">HAKEDIS BILGILERI</p>
            <div class="grid grid-cols-4 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Hakedis No</label><input type="text" name="hakedisNo" id="hakedis-no" readonly class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Hakedis Tipi *</label><select name="hakedisTip" id="hakedis-tip" onchange="onHakedisTipChange()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Donem *</label><input type="month" name="donem" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div id="hakedis-taseron-row" class="hidden">
                <label class="block text-xs mb-1.5 text-gray-400">Ilgili Taseron *</label><select name="taseronId" id="hakedis-taseron-select" onchange="onHakedisTaseronChange()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Seciniz...</option></select>
            </div>
            <p class="text-xs text-blue-400 font-semibold border-b border-gray-700 pb-1 pt-2">IS KALEMLERI ICMAL TABLOSU</p>
            <div id="hakedis-kalemler" class="overflow-x-auto">
                <p class="text-xs text-gray-500">Yukleniyor...</p>
            </div>
            <p class="text-xs text-green-400 font-semibold border-b border-gray-700 pb-1 pt-2">HESAP OZETI</p>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <div class="flex justify-between p-2 rounded bg-gray-800/30"><span class="text-xs text-gray-400">Is Kalemleri Toplami</span><span class="text-sm font-bold text-blue-400" id="hk-toplam">‚Ç∫0</span></div>
                    <div class="flex justify-between p-2 rounded bg-gray-800/30 items-center"><span class="text-xs text-gray-400">Fiyat Farki</span><div class="flex items-center gap-2"><input type="number" id="hk-fiyat-farki-oran" value="0" step="0.1" class="w-16 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-center" onchange="calcHakedis()"><span class="text-[10px] text-gray-500">%</span><span class="text-sm font-bold text-yellow-400" id="hk-fiyat-farki">‚Ç∫0</span></div></div>
                    <div class="flex justify-between p-2 rounded bg-blue-500/10 border border-blue-500/20"><span class="text-xs font-semibold">Ara Toplam</span><span class="text-sm font-bold text-blue-400" id="hk-ara-toplam">‚Ç∫0</span></div>
                    <div class="flex justify-between p-2 rounded bg-gray-800/30"><span class="text-xs text-gray-400">KDV (%20)</span><span class="text-sm font-bold text-purple-400" id="hk-kdv">‚Ç∫0</span></div>
                    <div class="flex justify-between p-2 rounded bg-purple-500/10 border border-purple-500/20"><span class="text-xs font-semibold">Genel Toplam</span><span class="text-sm font-bold text-purple-400" id="hk-genel-toplam">‚Ç∫0</span></div>
                </div>
                <div class="space-y-2">
                    <p class="text-[10px] text-red-400 font-semibold mb-1">KESINTILER</p>
                    <div id="hk-kesintiler"></div>
                    <div class="flex justify-between p-2 rounded bg-red-500/10 border border-red-500/20"><span class="text-xs font-semibold">Toplam Kesinti</span><span class="text-sm font-bold text-red-400" id="hk-toplam-kesinti">‚Ç∫0</span></div>
                    <div class="flex justify-between p-3 rounded bg-green-500/10 border border-green-500/20"><span class="text-sm font-bold">NET ODEME</span><span class="text-lg font-bold text-green-400" id="hk-net">‚Ç∫0</span></div>
                </div>
            </div>
            <p class="text-xs text-orange-400 font-semibold border-b border-gray-700 pb-1 pt-2">ONAY BILGILERI</p>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Hazirlayan</label><input type="text" id="hk-hazirlayan" readonly class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Kontrol Eden</label><select name="kontrolEden" id="hk-kontrol" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Seciniz...</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Onaylayan</label><select name="onaylayan" id="hk-onaylayan" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Seciniz...</option></select></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama</label><textarea name="aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Hakedis aciklamasi..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Hakedis Olustur</button>
                <button type="button" onclick="closeModal('modal-hakedis')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Excel Import Modal -->
<div id="modal-excel-import" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="excel-import-title">Excel / CSV Icerik Aktar</h3><button onclick="closeModal('modal-excel-import')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="excel-import-project-id">
        <input type="hidden" id="excel-import-type">
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Proje</label><select id="excel-import-project-select" onchange="document.getElementById('excel-import-project-id').value=this.value" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Dosya Sec (.xlsx, .csv)</label><input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" onchange="handleExcelFile(event)" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2 text-sm file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:bg-blue-600 file:text-white"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadImportTemplate()" class="px-3 py-1.5 bg-purple-600/20 text-purple-400 hover:bg-purple-600/40 rounded text-xs">üìÑ Ornek Sablon Indir</button>
                <span class="text-[10px] text-gray-500 self-center" id="excel-file-info"></span>
            </div>
            <div id="excel-preview" class="hidden">
                <p class="text-xs text-green-400 font-semibold border-b border-gray-700 pb-1 mb-2">ONIZLEME (<span id="excel-row-count">0</span> satir)</p>
                <div class="overflow-x-auto max-h-[300px] overflow-y-auto" id="excel-preview-table"></div>
                <div class="flex gap-3 pt-3">
                    <button onclick="executeExcelImport()" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Icerik Aktar</button>
                    <button onclick="closeModal('modal-excel-import')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Personel Modal (HR) -->
<div id="modal-personel" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="personel-modal-title">Yeni Personel</h3><button onclick="closeModal('modal-personel')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="personel-edit-id">
        <div class="space-y-4">
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1">KISISEL BILGILER</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Ad *</label><input id="p-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Ad"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Soyad *</label><input id="p-soyad" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Soyad"></div>
                <div><label class="block text-xs mb-1 text-gray-400">TC Kimlik No *</label><input id="p-tc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="11 hane" maxlength="11"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Dogum Tarihi</label><input id="p-dogum" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Cinsiyet</label><select id="p-cinsiyet" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Seciniz</option><option value="erkek">Erkek</option><option value="kadin">Kadin</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Medeni Durum</label><select id="p-medeni" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Seciniz</option><option value="bekar">Bekar</option><option value="evli">Evli</option><option value="bosanmis">Bosanmis</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Kan Grubu</label><select id="p-kan" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Seciniz</option><option>A Rh+</option><option>A Rh-</option><option>B Rh+</option><option>B Rh-</option><option>AB Rh+</option><option>AB Rh-</option><option>0 Rh+</option><option>0 Rh-</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">SGK No</label><input id="p-sgk" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="SGK No"></div>
            </div>
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1 pt-2">ILETISIM</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Telefon (Kisisel) *</label><input id="p-tel-kisisel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="05xx"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Telefon (Is)</label><input id="p-tel-is" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="05xx"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Email (Kisisel)</label><input id="p-email-kisisel" type="email" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Email (Is)</label><input id="p-email-is" type="email" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div class="col-span-2"><label class="block text-xs mb-1 text-gray-400">Adres</label><input id="p-adres" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Adres"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Sehir</label><input id="p-sehir" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Sehir"></div>
            </div>
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1 pt-2">IS BILGILERI</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Departman *</label><select id="p-departman" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Gorev / Unvan *</label><input id="p-gorev" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Gorev"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Ise Giris Tarihi *</label><input id="p-isegiris" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Calisma Tipi</label><select id="p-calisma" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="tam_zamanli">Tam Zamanli</option><option value="yari_zamanli">Yari Zamanli</option><option value="sozlesmeli">Sozlesmeli</option><option value="stajyer">Stajyer</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Maas (TL)</label><input id="p-maas" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="0"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Durum</label><select id="p-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="aktif">Aktif</option><option value="izinli">Izinli</option><option value="ayrilmis">Ayrilmis</option></select></div>
            </div>
            <div class="flex items-center justify-between border-b border-gray-700 pb-1 pt-2">
                <p class="text-xs text-teal-400 font-semibold">EGITIM BILGILERI</p>
                <button type="button" onclick="addEgitimSatiri()" class="text-[10px] text-blue-400 hover:text-blue-300 transition-colors">+ Egitim Ekle</button>
            </div>
            <div id="p-egitim-list" class="space-y-2">
                <div class="p-3 rounded-lg bg-gray-800/20 border border-gray-700/20 egitim-row">
                    <div class="grid grid-cols-4 gap-2">
                        <div><label class="block text-[10px] mb-1 text-gray-500">Seviye</label><select name="egitim-seviye" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="">Seciniz</option><option value="ilkokul">Ilkokul</option><option value="ortaokul">Ortaokul</option><option value="lise">Lise</option><option value="onlisans">On Lisans</option><option value="lisans">Lisans</option><option value="yukseklisans">Yuksek Lisans</option><option value="doktora">Doktora</option></select></div>
                        <div><label class="block text-[10px] mb-1 text-gray-500">Okul Adi</label><input name="egitim-okul" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Okul adi"></div>
                        <div><label class="block text-[10px] mb-1 text-gray-500">Bolum</label><input name="egitim-bolum" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Bolum"></div>
                        <div><label class="block text-[10px] mb-1 text-gray-500">Mezuniyet</label><input type="month" name="egitim-mezuniyet" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div>
                    </div>
                </div>
            </div>
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1 pt-2">ENGEL DURUMU</p>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Engel Durumu</label><select id="p-engel-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="toggleEngelFields(this.value)"><option value="yok">Yok</option><option value="var">Var</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Engel Orani (%)</label><input id="p-engel-oran" type="number" min="0" max="100" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="%" disabled></div>
                <div><label class="block text-xs mb-1 text-gray-400">Engel Turu</label><input id="p-engel-tur" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="orn: Ortopedik" disabled></div>
            </div>
            <div id="p-engel-detay" class="grid grid-cols-2 gap-3" style="display:none">
                <div><label class="block text-xs mb-1 text-gray-400">Rapor Tarihi</label><input id="p-engel-rapor-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Rapor Gecerlilik</label><select id="p-engel-rapor-sure" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="surekli">Surekli</option><option value="1yil">1 Yil</option><option value="2yil">2 Yil</option><option value="5yil">5 Yil</option></select></div>
                <div class="col-span-2"><label class="block text-xs mb-1 text-gray-400">Rapor Notu / Detay</label><textarea id="p-engel-not" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Saglik kurulu rapor detaylari..."></textarea></div>
            </div>
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1 pt-2">EMEKLILIK DURUMU</p>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Emeklilik</label><select id="p-emekli-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="toggleEmekliFields(this.value)"><option value="calisan">Calisan</option><option value="emekli">Emekli</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Emeklilik Tarihi</label><input id="p-emekli-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" disabled></div>
                <div><label class="block text-xs mb-1 text-gray-400">Emekli Sandigi</label><select id="p-emekli-sandik" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" disabled><option value="">Seciniz</option><option value="SGK">SGK</option><option value="BagKur">Bag-Kur</option><option value="EmekliSandigi">Emekli Sandigi</option></select></div>
            </div>
            <div id="p-emekli-detay" class="grid grid-cols-2 gap-3" style="display:none">
                <div><label class="block text-xs mb-1 text-gray-400">Emekli Sicil No</label><input id="p-emekli-sicil" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Sicil no"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Not</label><input id="p-emekli-not" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Emeklilik notu"></div>
            </div>
            <p class="text-xs text-teal-400 font-semibold border-b border-gray-700 pb-1 pt-2">ACIL DURUM</p>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Acil Durum Kisi</label><input id="p-acil-kisi" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Ad Soyad"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Acil Durum Tel</label><input id="p-acil-tel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="05xx"></div>
            </div>
            <div><label class="block text-xs mb-1 text-gray-400">Kullanici Hesabi Baglantisi (Opsiyonel)</label><select id="p-userId" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Baglantilik hesap yok</option></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Notlar</label><textarea id="p-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="savePersonel()" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
            <button onclick="closeModal('modal-personel')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Departman Modal (HR) -->
<div id="modal-departman" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="departman-modal-title">Yeni Departman</h3><button onclick="closeModal('modal-departman')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="dept-edit-id">
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Departman Adi *</label><input id="dept-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Departman Adi"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Kod</label><input id="dept-kod" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="KOD" maxlength="5"></div>
            </div>
            <div><label class="block text-xs mb-1 text-gray-400">Yonetici</label><select id="dept-yonetici" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Seciniz</option></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Aciklama</label><textarea id="dept-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="saveDepartman()" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
            <button onclick="closeModal('modal-departman')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Izin Modal (HR) -->
<div id="modal-izin" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Izin Talebi</h3><button onclick="closeModal('modal-izin')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="space-y-4">
            <div><label class="block text-xs mb-1 text-gray-400">Personel *</label><select id="izin-personel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Izin Turu</label><select id="izin-tur" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="yillik">Yillik Izin</option><option value="hastalik">Hastalik</option><option value="mazeret">Mazeret</option><option value="dogum">Dogum</option><option value="ucretsiz">Ucretsiz</option><option value="evlilik">Evlilik</option><option value="olum">Olum/Cenaze</option></select></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Baslangic *</label><input id="izin-bas" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="calcIzinGun()"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Bitis *</label><input id="izin-bit" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="calcIzinGun()"></div>
            </div>
            <div class="text-xs text-gray-400">Gun Sayisi: <span id="izin-gun-sayisi" class="text-white font-bold">0</span></div>
            <div><label class="block text-xs mb-1 text-gray-400">Onaylayan</label><select id="izin-onaylayan" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Aciklama</label><textarea id="izin-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="saveIzin()" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
            <button onclick="closeModal('modal-izin')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Personel Belge Modal (HR) -->
<div id="modal-personel-belge" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Personel Belgesi</h3><button onclick="closeModal('modal-personel-belge')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="space-y-4">
            <div><label class="block text-xs mb-1 text-gray-400">Personel *</label><select id="pb-personel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Belge Turu</label><select id="pb-tur" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="sozlesme">Is Sozlesmesi</option><option value="kvkk">KVKK Aydinlatma Metni</option><option value="gizlilik">Gizlilik Sozlesmesi</option><option value="zimmet_tutanagi">Zimmet Tutanagi</option><option value="isg">ISG Egitim Belgesi</option><option value="etik">Etik Taahhutname</option><option value="diploma">Diploma</option><option value="sertifika">Sertifika</option><option value="saglik_raporu">Saglik Raporu</option><option value="ikametgah">Ikametgah</option><option value="nufus_cuzdani">Nufus Cuzdani</option><option value="ehliyet">Ehliyet</option><option value="diger">Diger</option></select></div>
            <div><label class="block text-xs mb-1 text-gray-400">Baslik *</label><input id="pb-baslik" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Belge Basligi"></div>
            <div><label class="block text-xs mb-1 text-gray-400">Gecerlilik Tarihi</label><input id="pb-gecerlilik" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            <div><label class="block text-xs mb-1 text-gray-400">Notlar</label><textarea id="pb-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="savePersonelBelge()" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
            <button onclick="closeModal('modal-personel-belge')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Belge Paketi Modal -->
<div id="modal-belge-paketi" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">&#128196; Personel Belge Paketi</h3><button onclick="closeModal('modal-belge-paketi')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="belge-paketi-personel-id" value="">
        <div id="belge-paketi-icerik"></div>
        <div class="flex gap-3 mt-4">
            <button onclick="printHrBelgePaketi(document.getElementById('belge-paketi-personel-id').value)" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">&#128424; Yazdir ve Kaydet</button>
            <button onclick="closeModal('modal-belge-paketi')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Isten Ayrilma Modal -->
<div id="modal-isten-ayrilma" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-red-400">&#128683; Isten Ayrilma Islemi</h3><button onclick="closeModal('modal-isten-ayrilma')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ayrilma-personel-id" value="">
        <div id="ayrilma-personel-ozet" class="mb-4"></div>
        <div class="space-y-4">
            <p class="text-xs text-red-400 font-semibold border-b border-red-500/30 pb-1">AYRILMA BILGILERI</p>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Ayrilma Tarihi *</label><input id="ayrilma-tarihi" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="updateAyrilmaHesaplama()"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Ayrilma Nedeni *</label><select id="ayrilma-nedeni" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="updateAyrilmaHesaplama()"><option value="">Seciniz</option><option value="istifa">Istifa</option><option value="isverenFesih">Isveren Feshi</option><option value="karsilikliAnlasma">Karsilikli Anlasma</option><option value="emeklilik">Emeklilik</option><option value="askereGidis">Askerlik</option><option value="vefat">Vefat</option><option value="sozlesmeSonu">Sozlesme Sonu</option><option value="diger">Diger</option></select></div>
            </div>
            <div><label class="block text-xs mb-1 text-gray-400">Aciklama / Notlar</label><textarea id="ayrilma-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Ayrilma ile ilgili detaylar..."></textarea></div>
            <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-2 p-3 glass rounded-lg cursor-pointer hover:bg-red-600/10 border border-red-500/20"><input type="checkbox" id="ayrilma-kidem-hak" class="w-4 h-4 rounded accent-red-500" onchange="updateAyrilmaHesaplama()"><div><span class="text-sm font-medium text-red-400">Kidem Tazminati</span><p class="text-[10px] text-gray-500">Hak eder</p></div></label>
                <label class="flex items-center gap-2 p-3 glass rounded-lg cursor-pointer hover:bg-orange-600/10 border border-orange-500/20"><input type="checkbox" id="ayrilma-ihbar-hak" class="w-4 h-4 rounded accent-orange-500" onchange="updateAyrilmaHesaplama()"><div><span class="text-sm font-medium text-orange-400">Ihbar Tazminati</span><p class="text-[10px] text-gray-500">Hak eder</p></div></label>
            </div>
            <div id="ayrilma-hesaplama" class="glass rounded-xl p-4 border border-red-500/20" style="display:none;"></div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="tamamlaIstenAyrilma()" class="flex-1 bg-red-600 hover:bg-red-700 py-2.5 rounded-lg font-medium text-sm transition-colors">&#128683; Ayrilisi Tamamla</button>
            <button onclick="closeModal('modal-isten-ayrilma')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Toplu Zimmet Modal -->
<div id="modal-toplu-zimmet" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Personel Giris Paketi - Toplu Zimmet</h3><button onclick="closeModal('modal-toplu-zimmet')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="space-y-4">
            <p class="text-xs text-amber-400 font-semibold border-b border-gray-700 pb-1">PERSONEL BILGILERI</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1 text-gray-400">Personel / Kisi</label><select id="tz-personel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="topluZimmetPersonelSec()"><option value="">Manuel Giris</option></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Ad Soyad *</label><input id="tz-kisi" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Ad Soyad"></div>
                <div><label class="block text-xs mb-1 text-gray-400">TC Kimlik</label><input id="tz-tc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="TC" maxlength="11"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Departman</label><select id="tz-dept" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                <div><label class="block text-xs mb-1 text-gray-400">Gorev</label><input id="tz-gorev" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Gorev"></div>
                <div><label class="block text-xs mb-1 text-gray-400">Ise Giris Tarihi</label><input id="tz-isegiris" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            </div>
            <p class="text-xs text-amber-400 font-semibold border-b border-gray-700 pb-1 pt-2">ENVANTER SECIMI</p>
            <div class="flex flex-wrap gap-1.5 mb-2" id="tz-kat-filters"></div>
            <input id="tz-envanter-search" type="text" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-1.5 text-xs mb-2" placeholder="Malzeme ara..." oninput="filterTopluZimmetEnvanter()">
            <div id="tz-envanter-list" class="max-h-[250px] overflow-y-auto space-y-1"></div>
            <p class="text-xs text-amber-400 font-semibold border-b border-gray-700 pb-1 pt-2">SERBEST MALZEME EKLE</p>
            <div class="grid grid-cols-4 gap-2">
                <div class="col-span-2"><input id="tz-serbest-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded px-3 py-1.5 text-xs" placeholder="Malzeme Adi"></div>
                <div><input id="tz-serbest-seri" class="w-full bg-gray-800/80 border border-gray-700 rounded px-3 py-1.5 text-xs" placeholder="Seri No"></div>
                <div class="flex gap-1"><input id="tz-serbest-deger" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Deger"><button onclick="addSerbestZimmetItem()" class="px-2 bg-amber-600 hover:bg-amber-700 rounded text-xs">+</button></div>
            </div>
            <div id="tz-serbest-list" class="space-y-1"></div>
            <div class="grid grid-cols-2 gap-3 pt-2">
                <div><label class="block text-xs mb-1 text-gray-400">Belge No</label><input id="tz-belge-no" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" readonly></div>
                <div><label class="block text-xs mb-1 text-gray-400">Onaylayan</label><select id="tz-onaylayan" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            </div>
        </div>
        <div class="flex gap-3 mt-5">
            <button onclick="addTopluZimmet()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Zimmeti Olustur</button>
            <button onclick="closeModal('modal-toplu-zimmet')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Hidden Print Frame -->
<iframe id="print-frame" style="display:none;position:absolute;width:0;height:0;border:none;"></iframe>
<!-- Hakedis Durum Degisiklik Modal -->
<div id="modal-hakedis-durum" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="hakedis-durum-title">Durum Degisikligi</h3><button onclick="closeModal('modal-hakedis-durum')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="hd-project-id">
        <input type="hidden" id="hd-hakedis-id">
        <input type="hidden" id="hd-yeni-durum">
        <input type="hidden" id="hd-refresh-detail">
        <div class="mb-4">
            <div id="hd-durum-info" class="glass rounded-lg p-3 text-sm"></div>
        </div>
        <div class="mb-4">
            <label class="block text-xs mb-1.5 text-gray-400">Aciklama / Sebep *</label>
            <textarea id="hd-sebep" rows="3" required class="w-full bg-gray-800/60 border border-gray-700/50 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="Onay/red/revize sebebinizi yaziniz..."></textarea>
        </div>
        <div class="mb-4" id="hd-revize-notu-row" style="display:none">
            <label class="block text-xs mb-1.5 text-gray-400">Revize Notlari (duzeltilmesi gerekenler)</label>
            <textarea id="hd-revize-notu" rows="2" class="w-full bg-gray-800/60 border border-gray-700/50 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="Hangi kalemlerde duzeltme isteniyor..."></textarea>
        </div>
        <div class="flex gap-3">
            <button onclick="confirmDurumDegisikligi()" id="hd-confirm-btn" class="flex-1 py-2.5 rounded-lg font-medium text-sm transition-colors">Onayla</button>
            <button onclick="closeModal('modal-hakedis-durum')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
        </div>
    </div>
</div>
<!-- Santiye Gunlugu Modal -->
<div id="modal-gunluk" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Santiye Gunluk Kaydi</h3><button onclick="closeModal('modal-gunluk')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addGunluk(event)" class="space-y-4">
            <input type="hidden" id="gunluk-project-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih *</label><input type="date" name="tarih" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Hava Durumu</label><select name="hava" id="gunluk-hava" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Isci Sayisi</label><input type="number" name="isciSayisi" min="0" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="25"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Teknisyen</label><input type="number" name="teknisyen" min="0" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="5"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Muhendis</label><input type="number" name="muhendis" min="0" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="3"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Yapilan Isler *</label><textarea name="yapilanIsler" required rows="3" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Bugun yapilan isler..."></textarea></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Sorunlar / Gecikmeler</label><textarea name="sorunlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Karsilasilan sorunlar..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydi Ekle</button>
                <button type="button" onclick="closeModal('modal-gunluk')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- ISG Modal -->
<div id="modal-isg" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">ISG Kaydi</h3><button onclick="closeModal('modal-isg')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="isg-project-id">
        <form onsubmit="addIsgKayit(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Kayit Tipi</label><select name="kayitTip" id="isg-kayit-tip" onchange="toggleIsgTip()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="risk">Risk Degerlendirme</option><option value="kaza">Kaza/Olay</option><option value="egitim">Egitim</option><option value="denetim">Denetim</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="isg-tarih" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama</label><textarea name="aciklama" id="isg-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div id="isg-risk-fields">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Konum</label><input type="text" name="konum" id="isg-konum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Risk Seviyesi</label><select name="riskSeviye" id="isg-risk-seviye" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="dusuk">Dusuk</option><option value="orta">Orta</option><option value="yuksek">Yuksek</option><option value="kritik">Kritik</option></select></div>
                </div>
            </div>
            <div id="isg-kaza-fields" style="display:none">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Kaza Tipi</label><input type="text" name="kazaTipi" id="isg-kaza-tipi" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Dusme, carpma..."></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Yarali Sayisi</label><input type="number" name="yarali" id="isg-yarali" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" value="0"></div>
                </div>
            </div>
            <div id="isg-egitim-fields" style="display:none">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Egitim Konusu</label><input type="text" name="egitimKonu" id="isg-egitim-konu" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Katilimci Sayisi</label><input type="number" name="katilimci" id="isg-katilimci" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                </div>
            </div>
            <div id="isg-denetim-fields" style="display:none">
                <div><label class="block text-xs mb-1.5 text-gray-400">Denetim Sonucu</label><select name="denetimSonuc" id="isg-denetim-sonuc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="uygun">Uygun</option><option value="sartli">Sartli Uygun</option><option value="uygunsuz">Uygunsuz</option></select></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-isg')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Kalite Kontrol Modal -->
<div id="modal-kalite" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Kalite Kontrol Kaydi</h3><button onclick="closeModal('modal-kalite')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="kk-project-id">
        <form onsubmit="addKaliteKayit(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Kayit Tipi</label><select name="kayitTip" id="kk-kayit-tip" onchange="toggleKaliteTip()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="test">Test/Deney</option><option value="ncr">NCR (Uygunsuzluk)</option><option value="punch">Punch List</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="kk-tarih" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama</label><textarea name="aciklama" id="kk-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div id="kk-test-fields">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Konum</label><input type="text" name="konum" id="kk-konum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Sonuc</label><select name="testSonuc" id="kk-test-sonuc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="gecti">Gecti</option><option value="kaldi">Kaldi</option><option value="sartli">Sartli</option></select></div>
                </div>
            </div>
            <div id="kk-ncr-fields" style="display:none">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">NCR No</label><input type="text" name="ncrNo" id="kk-ncr-no" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="NCR-001"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Durum</label><select name="ncrDurum" id="kk-ncr-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="acik">Acik</option><option value="inceleniyor">Inceleniyor</option><option value="kapandi">Kapandi</option></select></div>
                </div>
            </div>
            <div id="kk-punch-fields" style="display:none">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Konum</label><input type="text" name="konum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Oncelik</label><select name="punchOncelik" id="kk-punch-oncelik" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="dusuk">Dusuk</option><option value="normal">Normal</option><option value="yuksek">Yuksek</option></select></div>
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-kalite')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Yesil Defter Modal -->
<div id="modal-yesil-defter" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Yesil Defter Kaydi</h3><button onclick="closeModal('modal-yesil-defter')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="yd-project-id">
        <form onsubmit="addYesilDefter(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tip</label><select name="tip" id="yd-tip" onchange="toggleYesilDefterTip()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="atasman">Atasman</option><option value="puantaj">Puantaj</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="yd-tarih" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div id="yd-atasman-fields" class="space-y-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Is Kalemi</label><select name="kalemId" id="yd-kalem-id" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></select></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Miktar</label><input type="number" name="miktar" id="yd-miktar" step="0.01" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Konum/Aks</label><input type="text" name="konum" id="yd-konum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="A1-B3 arasi"></div>
                </div>
            </div>
            <div id="yd-puantaj-fields" style="display:none" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Isci Adi</label><input type="text" name="isci" id="yd-isci" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Meslek</label><input type="text" name="meslek" id="yd-meslek" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Kalipci, Demirci..."></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Giris</label><input type="time" name="giris" id="yd-giris" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Cikis</label><input type="time" name="cikis" id="yd-cikis" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Fazla Mesai (s)</label><input type="number" name="fazlaMesai" id="yd-fazla-mesai" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" value="0"></div>
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-lime-600 hover:bg-lime-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-yesil-defter')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Ekipman Modal -->
<div id="modal-ekipman" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Ekipman/Makine Ekle</h3><button onclick="closeModal('modal-ekipman')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ek-project-id">
        <form onsubmit="addEkipman(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Ekipman Adi</label><input type="text" name="ad" id="ek-ad" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tip</label><select name="tip" id="ek-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option>Ekskavat√∂r</option><option>Vinc</option><option>Beton Pompasi</option><option>Kamyon</option><option>Forklift</option><option>Jenerator</option><option>Kompres√∂r</option><option>Diger</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Plaka</label><input type="text" name="plaka" id="ek-plaka" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sahiplik</label><select name="sahiplik" id="ek-sahiplik" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="kiralik">Kiralik</option><option value="ozmal">Oz Mal</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Gunluk Maliyet (TL)</label><input type="number" name="gunlukMaliyet" id="ek-gunluk-maliyet" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Ekle</button>
                <button type="button" onclick="closeModal('modal-ekipman')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Ekipman Kayit Modal -->
<div id="modal-ekipman-kayit" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Ekipman Kaydi</h3><button onclick="closeModal('modal-ekipman-kayit')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ekk-project-id"><input type="hidden" id="ekk-ekipman-id">
        <form onsubmit="addEkipmanKayit(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Kayit Tipi</label><select name="kayitTip" id="ekk-kayit-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="calisma">Calisma Saati</option><option value="yakit">Yakit</option><option value="bakim">Bakim</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="ekk-tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Saat (calisma icin)</label><input type="number" name="saat" id="ekk-saat" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Yakit (litre)</label><input type="number" name="yakit" id="ekk-yakit" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Bakim Aciklamasi</label><textarea name="bakimAciklama" id="ekk-bakim-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-ekipman-kayit')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Is Programi Modal -->
<div id="modal-is-programi" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Aktivite Ekle</h3><button onclick="closeModal('modal-is-programi')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ip-project-id">
        <form onsubmit="addIsProgramiAktivite(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Aktivite Adi</label><input type="text" name="ad" id="ip-ad" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Baslangic</label><input type="date" name="baslangic" id="ip-baslangic" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Sure (gun)</label><input type="number" name="sure" id="ip-sure" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="1"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Bagimlilik</label><select name="bagimlilik" id="ip-bagimlilik" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="">Yok</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Bag. Tipi</label><select name="bagimlilikTip" id="ip-bagimlilik-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="FS">FS (Bitis-Baslangic)</option><option value="SS">SS (Baslangic-Baslangic)</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sorumlu</label><input type="text" name="sorumlu" id="ip-sorumlu" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Ilerleme (%)</label><input type="number" name="ilerleme" id="ip-ilerleme" min="0" max="100" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" value="0"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Ekle</button>
                <button type="button" onclick="closeModal('modal-is-programi')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Sozlesme Modal -->
<div id="modal-sozlesme" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Sozlesme Kaydi</h3><button onclick="closeModal('modal-sozlesme')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="sz-project-id">
        <form onsubmit="addSozlesme(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Tip</label><select name="tip" id="sz-tip" onchange="toggleSozlesmeTip()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="ana">Ana Sozlesme</option><option value="ek">Ek Sozlesme / Tadilat</option><option value="teminat">Teminat Mektubu</option></select></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Sozlesme No</label><input type="text" name="no" id="sz-no" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="SZ-001"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="sz-tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Bedel (TL)</label><input type="number" name="bedel" id="sz-bedel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            <div id="sz-teminat-fields" style="display:none" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs mb-1.5 text-gray-400">Banka</label><input type="text" name="banka" id="sz-banka" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                    <div><label class="block text-xs mb-1.5 text-gray-400">Teminat Tutari</label><input type="number" name="teminatTutar" id="sz-teminat-tutar" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                </div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Vade Tarihi</label><input type="date" name="vade" id="sz-vade" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div id="sz-ek-fields" style="display:none"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama</label><textarea name="aciklama" id="sz-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-sozlesme')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Yazisma Modal -->
<div id="modal-yazisma" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Yazisma Kaydi</h3><button onclick="closeModal('modal-yazisma')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="yz-project-id">
        <form onsubmit="addYazisma(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tip</label><select name="tip" id="yz-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="giden">Giden</option><option value="gelen">Gelen</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Yazi No</label><input type="text" name="no" id="yz-no" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="YZ-001"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="yz-tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Gonderen/Alici</label><input type="text" name="gonderenAlici" id="yz-gonderenAlici" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Konu</label><input type="text" name="konu" id="yz-konu" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Kategori</label><select name="kategori" id="yz-kategori" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="resmi">Resmi Yazi</option><option value="teknik">Teknik</option><option value="idari">Idari</option><option value="toplanti">Toplanti</option><option value="diger">Diger</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Durum</label><select name="durum" id="yz-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="acik">Acik</option><option value="cevaplandi">Cevaplandi</option><option value="kapandi">Kapandi</option></select></div>
            </div>
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Belgeler (PDF, Resim, Dokuman)</label>
                <input type="file" id="yz-dosyalar" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.dwg,.zip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2 text-sm file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:bg-sky-600 file:text-white">
                <p class="text-[10px] text-gray-600 mt-1">PDF, Word, Excel, Resim, DWG, ZIP (maks. 5MB/dosya)</p>
                <div id="yz-dosya-onizleme" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama / Not</label><textarea name="aciklama" id="yz-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Ek bilgi..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-sky-600 hover:bg-sky-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-yazisma')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Malzeme Modal -->
<div id="modal-malzeme" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Malzeme Ekle</h3><button onclick="closeModal('modal-malzeme')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ms-project-id">
        <form onsubmit="addMalzeme(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Malzeme Adi</label><input type="text" name="malzeme" id="ms-malzeme" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Miktar</label><input type="number" name="miktar" id="ms-miktar" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Birim</label><select name="birim" id="ms-birim" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="adet">Adet</option><option value="ton">Ton</option><option value="m3">m3</option><option value="mt">mt</option><option value="kg">kg</option><option value="lt">lt</option><option value="torba">Torba</option></select></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Min Stok</label><input type="number" name="minStok" id="ms-min-stok" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Ekle</button>
                <button type="button" onclick="closeModal('modal-malzeme')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Stok Hareket Modal -->
<div id="modal-stok-hareket" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Stok Hareketi</h3><button onclick="closeModal('modal-stok-hareket')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="sh-project-id"><input type="hidden" id="sh-malzeme-id">
        <form onsubmit="addStokHareket(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Tarih</label><input type="date" name="tarih" id="sh-tarih" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tip</label><select name="tip" id="sh-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"><option value="giris">Giris</option><option value="cikis">Cikis</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Miktar</label><input type="number" name="miktar" id="sh-miktar" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Irsaliye No</label><input type="text" name="irsaliyeNo" id="sh-irsaliye" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-stok-hareket')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Nakit Akisi Modal -->
<div id="modal-nakit-akisi" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Nakit Akisi Kaydi</h3><button onclick="closeModal('modal-nakit-akisi')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="na-project-id">
        <form onsubmit="addNakitAkisi(event)" class="space-y-4">
            <div><label class="block text-xs mb-1.5 text-gray-400">Ay</label><input type="month" name="ay" id="na-ay" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-xs mb-1.5 text-gray-400">Gelir (TL)</label><input type="number" name="gelir" id="na-gelir" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Gider (TL)</label><input type="number" name="gider" id="na-gider" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Taseron Odeme</label><input type="number" name="taseronOdeme" id="na-taseron-odeme" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="0"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Notlar</label><textarea name="notlar" id="na-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Aciklama..."></textarea></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydi Ekle</button>
                <button type="button" onclick="closeModal('modal-nakit-akisi')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>
</div>
<!-- Edit Tender Modal -->
<div id="modal-edit-tender" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Ihale Duzenle</h3><button onclick="closeModal('modal-edit-tender')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="saveEditTender(event)" class="space-y-4">
            <input type="hidden" name="editId" id="edit-tender-id">
            <div><label class="block text-xs mb-1.5 text-gray-400">Malzeme/Hizmet</label><input type="text" name="item" id="edit-t-item" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Teklif Tutari (TL)</label><input type="number" name="amount" id="edit-t-amount" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Tedarikci</label><input type="text" name="supplier" id="edit-t-supplier" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Teslim Suresi (gun)</label><input type="number" name="delivery" id="edit-t-delivery" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Puan (1-5)</label><input type="number" name="rating" id="edit-t-rating" min="1" max="5" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="flex gap-3 pt-2"><button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Guncelle</button><button type="button" onclick="closeModal('modal-edit-tender')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
        </form>
    </div>
</div>
<!-- Edit Sale Modal -->
<div id="modal-edit-sale" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Satis Duzenle</h3><button onclick="closeModal('modal-edit-sale')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="saveEditSale(event)" class="space-y-4">
            <input type="hidden" name="editId" id="edit-sale-id">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Musteri Adi</label><input type="text" name="customer" id="edit-s-customer" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Telefon</label><input type="text" name="phone" id="edit-s-phone" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Urun/Daire</label><input type="text" name="product" id="edit-s-product" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs mb-1.5 text-gray-400">Satis Fiyati (TL)</label><input type="number" name="price" id="edit-s-price" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
                <div><label class="block text-xs mb-1.5 text-gray-400">Taksit Sayisi</label><input type="number" name="installments" id="edit-s-installments" min="1" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm"></div>
            </div>
            <div class="flex gap-3 pt-2"><button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Guncelle</button><button type="button" onclick="closeModal('modal-edit-sale')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
        </form>
    </div>
</div>
<!-- Project Detail Overlay -->
<div id="project-detail" class="detail-overlay" onclick="if(event.target===this)closeProjectDetail()">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="detail-title">Proje Detay</h3><button onclick="closeProjectDetail()" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div id="detail-content"></div>
    </div>
</div>
<!-- Add Expense Modal -->
<div id="modal-expense" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Harcama Ekle</h3><button onclick="closeModal('modal-expense')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <form onsubmit="addExpense(event)" class="space-y-4">
            <input type="hidden" id="expense-project-id">
            <div><label class="block text-xs mb-1.5 text-gray-400">Proje</label><p class="text-sm font-semibold" id="expense-project-name"></p></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Harcama Tutari (TL) *</label><input type="number" id="expense-amount" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="150000"></div>
            <div><label class="block text-xs mb-1.5 text-gray-400">Aciklama</label><input type="text" id="expense-desc" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Demir alimi"></div>
            <div class="flex gap-3 pt-2"><button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Harcama Ekle</button><button type="button" onclick="closeModal('modal-expense')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
        </form>
    </div>
</div>
<!-- Task Panel Modal -->
<div id="modal-tasks" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="task-panel-title">Gorevler</h3><button onclick="closeModal('modal-tasks')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="flex gap-2 mb-4">
            <input type="text" id="task-input" class="flex-1 bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Yeni gorev ekle..." onkeydown="if(event.key==='Enter')addTask()">
            <button onclick="addTask()" class="px-4 py-2.5 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-sm font-medium transition-colors">Ekle</button>
        </div>
        <div id="task-list" class="space-y-2"></div>
        <input type="hidden" id="task-project-id">
    </div>
</div>
<!-- Order Modal -->
<div id="modal-order" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Satinalma Siparisi</h3><button onclick="closeModal('modal-order')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div id="order-content"></div>
    </div>
</div>
<!-- Customer Detail Modal -->
<div id="modal-customer" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[85vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold" id="customer-title">Musteri Detay</h3><button onclick="closeModal('modal-customer')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div id="customer-content"></div>
    </div>
</div>
<!-- Edit Message Modal -->
<div id="modal-edit-msg" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Mesaj Duzenle</h3><button onclick="closeModal('modal-edit-msg')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="edit-msg-id">
        <textarea id="edit-msg-text" rows="3" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm mb-4"></textarea>
        <div class="flex gap-3"><button onclick="saveEditMessage()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-edit-msg')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Envanter Kalemi Modal -->
<div id="modal-depo-item" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Envanter Kalemi</h3><button onclick="closeModal('modal-depo-item')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="di-edit-id">
        <div id="di-meta-info" class="hidden mb-3 glass rounded-lg p-2 text-[10px] text-gray-400"></div>
        <div class="flex gap-4">
            <div class="flex-shrink-0">
                <label class="text-xs text-gray-400 mb-1 block">Gorsel</label>
                <div id="di-resim-preview" class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center cursor-pointer hover:border-amber-500/50 transition-colors overflow-hidden" onclick="document.getElementById('di-resim-input').click()">
                    <span class="text-gray-500 text-[10px] text-center px-1">Resim Yukle<br>(maks 500KB)</span>
                </div>
                <input type="file" id="di-resim-input" accept="image/*" class="hidden" onchange="handleDepoItemResim(this.files)">
                <button id="di-resim-remove" class="hidden text-[9px] text-red-400 hover:text-red-300 mt-1 w-24 text-center" onclick="clearDepoItemResim()">Resmi Kaldir</button>
            </div>
            <div class="flex-1 grid grid-cols-2 gap-3 text-sm">
                <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Malzeme Adi *</label><input id="di-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Orn: Cimento"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Kategori</label><select id="di-kategori" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Depo *</label><select id="di-depo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Barkod</label><input id="di-barkod" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Opsiyonel"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Birim</label><select id="di-birim" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option>adet</option><option>kg</option><option>ton</option><option>mt</option><option>m2</option><option>m3</option><option>lt</option><option>paket</option><option>koli</option><option>takm</option></select></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Miktar *</label><input id="di-miktar" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="0"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Min. Stok</label><input id="di-minStok" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="0"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Birim Fiyat (TL)</label><input id="di-fiyat" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="0"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Tedarikci</label><input id="di-tedarikci" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Opsiyonel"></div>
                <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Notlar</label><textarea id="di-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
            </div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="addDepoItem()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-depo-item')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Tesis/Depo Tanimlama Modal -->
<div id="modal-depo-tesis" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Depo Tanimla</h3><button onclick="closeModal('modal-depo-tesis')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="dt-edit-id">
        <div class="space-y-3 text-sm">
            <div><label class="text-xs text-gray-400 mb-1 block">Depo Adi *</label><input id="dt-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Orn: Merkez Depo"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Konum</label><input id="dt-konum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Orn: Atasehir, Istanbul"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Tip</label><select id="dt-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="merkez">Merkez Depo</option><option value="santiye">Santiye Deposu</option><option value="ofis">Ofis Deposu</option></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Sorumlu</label><input id="dt-sorumlu" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Sorumlu kisi"></div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="addDepoTesis()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-depo-tesis')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Stok Hareketi Modal -->
<div id="modal-depo-hareket" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Stok Hareketi</h3><button onclick="closeModal('modal-depo-hareket')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div><label class="text-xs text-gray-400 mb-1 block">Hareket Tipi *</label><select id="dh-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="toggleDepoHareketFields()"><option value="giris">Giris (Satin Alma)</option><option value="cikis">Cikis</option><option value="transfer">Transfer</option><option value="fire">Fire/Kayip</option><option value="iade">Iade</option><option value="projeye">Projeye Cikis</option></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Tarih</label><input id="dh-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Malzeme *</label><select id="dh-malzeme" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Miktar *</label><input id="dh-miktar" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="1"></div>
            <div id="dh-kaynak-wrap"><label class="text-xs text-gray-400 mb-1 block">Kaynak Depo</label><select id="dh-kaynak" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div id="dh-hedef-wrap"><label class="text-xs text-gray-400 mb-1 block">Hedef Depo</label><select id="dh-hedef" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div id="dh-proje-wrap" class="hidden"><label class="text-xs text-gray-400 mb-1 block">Proje</label><select id="dh-proje" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Irsaliye No</label><input id="dh-irsaliye" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Opsiyonel"></div>
            <div id="dh-transfer-fields" class="col-span-2 hidden glass rounded-lg p-3 space-y-2">
                <p class="text-[10px] text-amber-400 font-bold">Transfer / Proje Cikisi Detaylari</p>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs text-gray-400 mb-1 block">Talep Eden</label><select id="dh-talep-eden" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                    <div><label class="text-xs text-gray-400 mb-1 block">Aciliyet</label><select id="dh-aciliyet" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="normal">Normal</option><option value="acil">Acil</option><option value="planli">Planli</option></select></div>
                </div>
            </div>
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Aciklama</label><textarea id="dh-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="addDepoHareket()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-depo-hareket')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Zimmet Modal -->
<div id="modal-depo-zimmet" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Zimmet Formu</h3><button onclick="closeModal('modal-depo-zimmet')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Malzeme *</label><select id="dz-malzeme" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Miktar *</label><input id="dz-miktar" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="1"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Depo *</label><select id="dz-depo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Zimmetli Kisi *</label><select id="dz-kisi" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="">Seciniz...</option></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Departman</label><select id="dz-departman" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="santiye">Santiye</option><option value="ofis">Ofis</option><option value="depo">Depo</option><option value="yonetim">Yonetim</option><option value="muhasebe">Muhasebe</option><option value="diger">Diger</option></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Tarih</label><input id="dz-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Onaylayan</label><select id="dz-onaylayan" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Notlar</label><textarea id="dz-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="addZimmet()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Zimmete Ver</button><button onclick="closeModal('modal-depo-zimmet')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Proje Malzeme Talep Modal -->
<div id="modal-depo-talep" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">&#128230; Depodan Malzeme Talep Et</h3><button onclick="closeModal('modal-depo-talep')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="dt-project-id">
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Malzeme *</label><select id="dt-malzeme" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" onchange="updateDepoTalepStok()"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Talep Miktar *</label><input id="dt-miktar" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="1" min="1"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Mevcut Depo Stok</label><input id="dt-mevcut-stok" type="text" readonly class="w-full bg-gray-800/60 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-400"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Kaynak Depo *</label><select id="dt-depo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Aciliyet</label><select id="dt-aciliyet" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="normal">Normal</option><option value="acil">Acil</option><option value="planli">Planli</option></select></div>
            <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Aciklama</label><textarea id="dt-aciklama" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Talep sebebi..."></textarea></div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="submitDepoTalep()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">&#128230; Talep Olustur</button><button onclick="closeModal('modal-depo-talep')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Depo - Sayim Modal -->
<div id="modal-depo-sayim" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Envanter Sayimi</h3><button onclick="closeModal('modal-depo-sayim')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <div class="space-y-3 text-sm">
            <div><label class="text-xs text-gray-400 mb-1 block">Depo *</label><select id="ds-depo" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Tarih</label><input id="ds-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Sorumlu</label><input id="ds-sorumlu" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" placeholder="Sayim sorumlusu"></div>
            <div><label class="text-xs text-gray-400 mb-1 block">Notlar</label><textarea id="ds-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></textarea></div>
            <div id="ds-kalemler-area"></div>
        </div>
        <div class="flex gap-3 mt-4"><button onclick="addDepoSayim()" class="flex-1 bg-amber-600 hover:bg-amber-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Sayimi Kaydet</button><button onclick="closeModal('modal-depo-sayim')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Arac/Filo Modal -->
<div id="modal-arac" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold" id="arac-modal-title">Arac Ekle</h3><button onclick="closeModal('modal-arac')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ar-edit-id">
        <div class="flex gap-4 mb-3">
            <div class="flex-shrink-0"><div id="ar-resim-preview" class="w-28 h-28 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-gray-500 text-[10px] cursor-pointer hover:border-blue-500 transition-colors overflow-hidden" onclick="document.getElementById('ar-resim-input').click()">Arac Resmi<br>(maks 500KB)</div><input type="file" id="ar-resim-input" class="hidden" accept="image/*" onchange="handleAracResim(this.files)"><button id="ar-resim-remove" class="hidden mt-1 text-[9px] text-red-400 hover:text-red-300" onclick="clearAracResim()">Resmi Kaldir</button></div>
            <div class="flex-1 grid grid-cols-3 gap-2 text-sm">
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Plaka *</label><input id="ar-plaka" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="34 ABC 123"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Marka *</label><input id="ar-marka" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Ford"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Model *</label><input id="ar-model" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Transit"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Yil</label><input id="ar-yil" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="2023"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Renk</label><input id="ar-renk" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Beyaz"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Tip</label><select id="ar-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="sedan">Sedan</option><option value="suv">SUV</option><option value="kamyon">Kamyon</option><option value="van">Van</option><option value="pickup">Pickup</option><option value="minibus">Minibus</option></select></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Yakit Tipi</label><select id="ar-yakit" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="dizel">Dizel</option><option value="benzin">Benzin</option><option value="lpg">LPG</option><option value="elektrik">Elektrik</option><option value="hibrit">Hibrit</option></select></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">KM</label><input id="ar-km" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="0"></div>
                <div><label class="text-[10px] text-gray-400 mb-0.5 block">Sahiplik</label><select id="ar-sahiplik" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="sirket">Sirket</option><option value="kiralik">Kiralik</option><option value="leasing">Leasing</option></select></div>
            </div>
        </div>
        <div class="grid grid-cols-4 gap-2 mb-3 text-sm">
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Sasi No</label><input id="ar-sasi" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div>
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Motor No</label><input id="ar-motor" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div>
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Zimmetli Kisi</label><input id="ar-zimmetli" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Personel adi"></div>
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Departman</label><select id="ar-departman" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="santiye">Santiye</option><option value="ofis">Ofis</option><option value="yonetim">Yonetim</option><option value="muhasebe">Muhasebe</option><option value="diger">Diger</option></select></div>
        </div>
        <div class="glass rounded-lg p-3 mb-3">
            <p class="text-[10px] text-amber-400 font-bold mb-2">Belge Bilgileri</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="glass rounded p-2"><p class="text-[9px] text-gray-500 mb-1 font-bold">MUAYENE</p><div class="grid grid-cols-2 gap-1"><div><label class="text-[9px] text-gray-500">Son Tarih</label><input id="ar-muayene-son" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div><div><label class="text-[9px] text-gray-500">Bitis Tarih</label><input id="ar-muayene-bitis" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div></div></div>
                <div class="glass rounded p-2"><p class="text-[9px] text-gray-500 mb-1 font-bold">SIGORTA</p><div class="grid grid-cols-2 gap-1"><div><label class="text-[9px] text-gray-500">Son Tarih</label><input id="ar-sigorta-son" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div><div><label class="text-[9px] text-gray-500">Bitis Tarih</label><input id="ar-sigorta-bitis" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div></div><div class="grid grid-cols-2 gap-1 mt-1"><div><input id="ar-sigorta-police" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]" placeholder="Police No"></div><div><input id="ar-sigorta-sirket" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]" placeholder="Sirket"></div></div></div>
                <div class="glass rounded p-2"><p class="text-[9px] text-gray-500 mb-1 font-bold">KASKO</p><div class="grid grid-cols-2 gap-1"><div><label class="text-[9px] text-gray-500">Son Tarih</label><input id="ar-kasko-son" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div><div><label class="text-[9px] text-gray-500">Bitis Tarih</label><input id="ar-kasko-bitis" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div></div><div class="grid grid-cols-2 gap-1 mt-1"><div><input id="ar-kasko-police" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]" placeholder="Police No"></div><div><input id="ar-kasko-sirket" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]" placeholder="Sirket"></div></div></div>
                <div class="glass rounded p-2"><p class="text-[9px] text-gray-500 mb-1 font-bold">EGZOZ EMISYON</p><div class="grid grid-cols-2 gap-1"><div><label class="text-[9px] text-gray-500">Son Tarih</label><input id="ar-egzoz-son" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div><div><label class="text-[9px] text-gray-500">Bitis Tarih</label><input id="ar-egzoz-bitis" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-1.5 py-1 text-[10px]"></div></div></div>
            </div>
        </div>
        <div><label class="text-[10px] text-gray-400 mb-0.5 block">Notlar</label><textarea id="ar-notlar" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></textarea></div>
        <div class="flex gap-3 mt-3"><button onclick="addArac()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-arac')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Arac Kayit Modal (Bakim/Lastik/Yakit) -->
<div id="modal-arac-kayit" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold">Arac Kaydi</h3><button onclick="closeModal('modal-arac-kayit')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
        <input type="hidden" id="ark-arac-id">
        <div class="grid grid-cols-3 gap-2 mb-3 text-sm">
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Kayit Tipi</label><select id="ark-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" onchange="toggleAracKayitFields()"><option value="bakim">Bakim</option><option value="lastik">Lastik</option><option value="yakit">Yakit</option></select></div>
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">Tarih</label><input id="ark-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div>
            <div><label class="text-[10px] text-gray-400 mb-0.5 block">KM</label><input id="ark-km" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div>
        </div>
        <div id="ark-bakim-fields" class="space-y-2 mb-3">
            <div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] text-gray-400 mb-0.5 block">Islem *</label><input id="ark-islem" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Periyodik bakim"></div><div><label class="text-[10px] text-gray-400 mb-0.5 block">Maliyet (TL)</label><input id="ark-maliyet" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div></div>
            <div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] text-gray-400 mb-0.5 block">Servis</label><input id="ark-servis" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="Servis adi"></div><div><label class="text-[10px] text-gray-400 mb-0.5 block">Aciklama</label><input id="ark-aciklama" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div></div>
        </div>
        <div id="ark-lastik-fields" class="space-y-2 mb-3 hidden">
            <div class="grid grid-cols-3 gap-2"><div><label class="text-[10px] text-gray-400 mb-0.5 block">Lastik Tipi</label><select id="ark-lastik-tip" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="yaz">Yaz</option><option value="kis">Kis</option><option value="4mevsim">4 Mevsim</option></select></div><div><label class="text-[10px] text-gray-400 mb-0.5 block">Marka</label><input id="ark-lastik-marka" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div><div><label class="text-[10px] text-gray-400 mb-0.5 block">Not</label><input id="ark-lastik-not" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div></div>
        </div>
        <div id="ark-yakit-fields" class="space-y-2 mb-3 hidden">
            <div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] text-gray-400 mb-0.5 block">Litre</label><input id="ark-litre" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div><div><label class="text-[10px] text-gray-400 mb-0.5 block">Tutar (TL)</label><input id="ark-tutar" type="number" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"></div></div>
        </div>
        <div class="flex gap-3"><button onclick="addAracKayit()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-arac-kayit')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div>
    </div>
</div>
<!-- Kritik Uyari Modal -->
<div id="modal-kritik-uyarilar" class="modal">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto mx-4">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2"><span class="text-red-500 text-xl">&#9888;</span><h3 class="text-lg font-bold text-red-400">Kritik Uyarilar</h3></div>
            <button onclick="closeModal('modal-kritik-uyarilar')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <p class="text-xs text-gray-400 mb-3">Asagidaki kritik ve acil uyarilar dikkatinizi bekliyor:</p>
        <div id="kritik-uyari-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
        <div class="flex gap-2 mt-4">
            <button onclick="bildirimTumunuOkundu(currentUser?currentUser.id:1);closeModal('modal-kritik-uyarilar');bildirimSayisiGuncelle()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg text-sm font-medium transition-colors">Tumunu Okundu Isaretle</button>
            <button onclick="closeModal('modal-kritik-uyarilar')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Kapat</button>
        </div>
    </div>
</div>
<!-- Notification Toast -->
<div id="notification" class="notification"><div class="flex items-start gap-2"><svg class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p id="notification-text" class="text-xs leading-relaxed flex-1" style="word-break:break-word;"></p><button onclick="document.getElementById('notification').classList.remove('show')" class="text-gray-400 hover:text-white text-sm leading-none flex-shrink-0 ml-1" style="margin-top:-2px;">&times;</button></div></div>

<script>
// ===================== STATE =====================
// ---- BUILD CONSTANTS ----
const PROJECT_TYPES=[{v:'konut',l:'Konut'},{v:'ticari',l:'Ticari'},{v:'sanayi',l:'Sanayi'},{v:'altyapi',l:'Altyapi'},{v:'restorasyon',l:'Restorasyon'}];
const CONTRACT_TYPES=[{v:'goturu',l:'Goturu Bedel'},{v:'birimfiyat',l:'Birim Fiyat'},{v:'maliyetarti',l:'Maliyet+Kar'}];
const WORK_PACKAGES=['Kaba Insaat','Ince Insaat','Elektrik Tesisati','Sihhi Tesisat','Mekanik Tesisat','Asansor','Cephe Kaplama','Boyaci Isleri','Zemin Kaplama','Peyzaj','Celik Imalat','Izolasyon','Dogalgaz Tesisati','Yangin Tesisati','Guvenlik Sistemleri'];
const WORK_CATEGORIES=[{v:'insaat',l:'Insaat Isleri'},{v:'mekanik',l:'Mekanik Tesisat'},{v:'elektrik',l:'Elektrik Tesisati'},{v:'peyzaj',l:'Peyzaj'},{v:'diger',l:'Diger'}];
const UNITS=['m2','m3','kg','mt','adet','ton','lt','takm','kw','ha'];
const WEATHER_OPTS=[{v:'gunesli',l:'‚òÄÔ∏è Gunesli'},{v:'bulutlu',l:'‚òÅÔ∏è Bulutlu'},{v:'yagmurlu',l:'üåßÔ∏è Yagmurlu'},{v:'karli',l:'‚ùÑÔ∏è Karli'},{v:'ruzgarli',l:'üí® Ruzgarli'}];
const PT_COLORS={konut:'bg-blue-500/20 text-blue-400',ticari:'bg-purple-500/20 text-purple-400',sanayi:'bg-orange-500/20 text-orange-400',altyapi:'bg-green-500/20 text-green-400',restorasyon:'bg-amber-500/20 text-amber-400'};
const HAKEDIS_TYPES=[{v:'ara',l:'Ara Hakedis'},{v:'kesin',l:'Kesin Hakedis'},{v:'taseron',l:'Taseron Hakedis'}];
const KESINTI_DEFAULTS=[{k:'teminat',l:'Teminat Kesintisi',oran:10,aktif:true},{k:'stopaj',l:'Stopaj',oran:5,aktif:true},{k:'sgk',l:'SGK Kesintisi',oran:0,aktif:false},{k:'avans',l:'Avans Mahsubu',oran:0,aktif:false},{k:'diger',l:'Diger Kesintiler',oran:0,aktif:false}];
// Supply sabitleri
const TALEP_DURUM=[{v:'taslak',l:'Taslak',css:'bg-gray-500/20 text-gray-400'},{v:'onayBekliyor',l:'Onay Bekliyor',css:'bg-yellow-500/20 text-yellow-400'},{v:'onaylandi',l:'Onaylandi',css:'bg-green-500/20 text-green-400'},{v:'ihaleyeCevrildi',l:'Ihaleye Cevrildi',css:'bg-blue-500/20 text-blue-400'},{v:'reddedildi',l:'Reddedildi',css:'bg-red-500/20 text-red-400'}];
const IHALE_TIPI=[{v:'acik',l:'Acik Ihale'},{v:'kapaliZarf',l:'Kapali Zarf'},{v:'dogrudan',l:'Dogrudan Temin'},{v:'pazarlik',l:'Pazarlik Usulu'}];
const SIPARIS_DURUM=[{v:'olusturuldu',l:'Olusturuldu',css:'bg-gray-500/20 text-gray-400'},{v:'gonderildi',l:'Tedarikciye Gonderildi',css:'bg-blue-500/20 text-blue-400'},{v:'kismiTeslimat',l:'Kismi Teslimat',css:'bg-yellow-500/20 text-yellow-400'},{v:'tamamlandi',l:'Tamamlandi',css:'bg-green-500/20 text-green-400'},{v:'iptal',l:'Iptal Edildi',css:'bg-red-500/20 text-red-400'}];
const ACILIYET=[{v:'acil',l:'Acil',css:'bg-red-500/20 text-red-400'},{v:'yuksek',l:'Yuksek',css:'bg-orange-500/20 text-orange-400'},{v:'normal',l:'Normal',css:'bg-blue-500/20 text-blue-400'},{v:'dusuk',l:'Dusuk',css:'bg-gray-500/20 text-gray-400'}];
const DEPARTMANLAR=[{v:'santiye',l:'Santiye'},{v:'ofis',l:'Ofis'},{v:'muhasebe',l:'Muhasebe'},{v:'yonetim',l:'Yonetim'},{v:'depo',l:'Depo'}];
const SUPPLY_BIRIMLER=['ton','m3','m2','mt','kg','lt','adet','set','takim','pkt'];
const TEDARIKCI_KAT=['demir','celik','beton','cimento','boya','elektrik','mekanik','tesisat','izolasyon','kaplama','ahsap','insaat','genel'];

const S = {
    projects:[], tenders:[], sales:[], activities:[], channels:[], messages:{}, users:[
        {id:1,name:'Tarik Oniz',phone:'05321234567',email:'tarik@faonsist.com',role:'Yonetici',perms:'Tum yetkiler',active:true,password:'1234'},
        {id:2,name:'Mehmet Kaya',phone:'05339876543',email:'mehmet@faonsist.com',role:'Proje Muduru',perms:'Build modulu',active:true,password:'1234'},
        {id:3,name:'Ayse Demir',phone:'05425551234',email:'ayse@faonsist.com',role:'Muhasebe',perms:'Supply, Sales okuma',active:true,password:'1234'}
    ],
    currentChannel:'genel',
    theme:'dark',
    connFiles:{},
    knowledgeBase:[],
    pendingDeletions:[],
    depolar:[],
    envanter:[],
    depoHareketler:[],
    sayimlar:[],
    zimmetler:[],
    araclar:[],
    personeller:[],
    departmanlar:[
        {id:1,ad:'Santiye',kod:'STY',yoneticiId:null,aciklama:'Saha operasyonlari',aktif:true},
        {id:2,ad:'Ofis',kod:'OFS',yoneticiId:null,aciklama:'Genel ofis',aktif:true},
        {id:3,ad:'Muhasebe',kod:'MHS',yoneticiId:null,aciklama:'Mali isler',aktif:true},
        {id:4,ad:'Yonetim',kod:'YNT',yoneticiId:null,aciklama:'Ust yonetim',aktif:true},
        {id:5,ad:'Depo',kod:'DPO',yoneticiId:null,aciklama:'Depo operasyonlari',aktif:true},
        {id:6,ad:'IT',kod:'IT',yoneticiId:null,aciklama:'Bilgi teknolojileri',aktif:true}
    ],
    izinler:[],
    personelBelgeler:[],
    depoKategoriler:[
        {key:'insaat',ad:'Insaat',renk:'orange'},
        {key:'ofis',ad:'Ofis',renk:'blue'},
        {key:'it',ad:'IT',renk:'purple'},
        {key:'arac',ad:'Arac-Gerec',renk:'cyan'},
        {key:'mobilya',ad:'Mobilya',renk:'amber'},
        {key:'diger',ad:'Diger',renk:'gray'}
    ],
    satinalmaTalepleri:[],
    tedarikcilerHavuzu:[],
    orders:[],
    bildirimler:[],
    bildirimAyarlar:{
        belgeEsikler:{gun60:{aktif:true,seviye:'bilgi'},gun30:{aktif:true,seviye:'uyari'},gun7:{aktif:true,seviye:'kritik'},gun0:{aktif:true,seviye:'acil'}},
        kmBakimHatirlatma:{aktif:true,aralik:10000,seviye:'uyari'},
        filoSorumlusu:{userId:null,tumBildirimleriAl:true},
        departmanRouting:{santiye:{aktif:false,hedefRol:null},ofis:{aktif:false,hedefRol:null},yonetim:{aktif:false,hedefRol:null},muhasebe:{aktif:false,hedefRol:null},diger:{aktif:false,hedefRol:null}},
        kategoriler:{'arac-filo':true,'envanter':true,'genel':true},
        sesAktif:false,
        girisModalGoster:true
    },
    meetings:[]
};

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded',async()=>{
    // Backend kontrolu
    await checkBackend();
    // localStorage'dan yukle (backend login sonrasi DB'den override edilecek)
    await load();
    // --- Admin name migration: Hafsar Asilsoy ‚Üí Tarik Oniz ---
    (function migrateAdminName(){
        const oldName='Hafsar Asilsoy';const newName='Tarik Oniz';
        const oldEmail='hafsar@faonsist.com';const newEmail='tarik@faonsist.com';
        // Users
        const admin=S.users.find(u=>u.id===1);
        if(admin&&(admin.name===oldName||admin.email===oldEmail)){
            admin.name=newName;admin.email=newEmail;
        }
        // Channels memberList
        (S.channels||[]).forEach(ch=>{
            if(ch.memberList)ch.memberList=ch.memberList.map(m=>m===oldName?newName:m);
        });
        // Messages
        Object.keys(S.messages||{}).forEach(ch=>{
            (S.messages[ch]||[]).forEach(m=>{if(m.user===oldName)m.user=newName;});
        });
        // Files, KB entries
        (S.files||[]).forEach(f=>{if(f.uploadedBy===oldName)f.uploadedBy=newName;});
        (S.knowledgeBase||[]).forEach(k=>{if(k.addedBy===oldName)k.addedBy=newName;});
        // Activities
        (S.activities||[]).forEach(a=>{if(typeof a.text==='string')a.text=a.text.replace(oldName,newName);});
        save();
        // Sync currentUser reference (it may point to stale object after load)
        if(typeof currentUser!=='undefined'&&currentUser){currentUser=S.users.find(u=>u.id===currentUser.id)||S.users[0];}
    })();
    // --- AI API Key auto-setup (varsayilan key'ler, v2) ---
    (function migrateAiKeys(){
        const _d=function(a){return a.map(function(v){return String.fromCharCode(v^42)}).join('')};
        // HuggingFace (guncellenmis key)
        const _hf=[66,76,117,102,80,97,67,65,82,109,69,82,93,102,82,80,103,79,123,80,127,122,109,72,69,98,109,126,70,114,72,121,78,82,95,99,94];
        try{localStorage.setItem('faonsist_ai_key_huggingface',_d(_hf));}catch(e){}
        // Claude (Anthropic)
        const _cl=[89,65,7,75,68,94,7,75,90,67,26,25,7,64,79,98,31,72,80,27,103,68,89,101,114,122,18,24,108,92,99,123,115,123,69,95,93,30,66,100,77,25,93,70,96,99,30,111,102,7,114,67,92,69,98,66,88,69,65,83,73,107,99,108,98,80,27,115,28,126,93,99,127,75,122,19,97,80,103,30,125,94,83,105,103,25,77,98,18,120,73,71,65,69,103,19,124,30,123,7,110,18,69,104,112,107,107,107];
        try{localStorage.setItem('faonsist_ai_key_anthropic',_d(_cl));}catch(e){}
    })();
    // Supply state migration
    if(!S.satinalmaTalepleri)S.satinalmaTalepleri=[];
    if(!S.tedarikcilerHavuzu)S.tedarikcilerHavuzu=[];
    if(!S.orders)S.orders=[];
    if(!S.pendingDeletions)S.pendingDeletions=[];
    if(!S.customRoles)S.customRoles=[];
    // Bildirim state migration
    if(!S.bildirimler)S.bildirimler=[];
    if(!S.bildirimAyarlar)S.bildirimAyarlar={belgeEsikler:{gun60:{aktif:true,seviye:'bilgi'},gun30:{aktif:true,seviye:'uyari'},gun7:{aktif:true,seviye:'kritik'},gun0:{aktif:true,seviye:'acil'}},kmBakimHatirlatma:{aktif:true,aralik:10000,seviye:'uyari'},filoSorumlusu:{userId:null,tumBildirimleriAl:true},departmanRouting:{santiye:{aktif:false,hedefRol:null},ofis:{aktif:false,hedefRol:null},yonetim:{aktif:false,hedefRol:null},muhasebe:{aktif:false,hedefRol:null},diger:{aktif:false,hedefRol:null}},kategoriler:{'arac-filo':true,'envanter':true,'genel':true},sesAktif:false,girisModalGoster:true};
    // Apply saved theme
    if(S.theme==='light'){document.documentElement.classList.remove('dark');document.documentElement.classList.add('light');}
    if(S.channels.length===0){
        S.channels=[
            {id:'genel',name:'genel',members:3,type:'channel',memberList:['Tarik Oniz','Mehmet Kaya','Ayse Demir']},
            {id:'proje-takip',name:'proje-takip',members:2,type:'channel',memberList:['Tarik Oniz','Mehmet Kaya']},
            {id:'duyurular',name:'duyurular',members:5,type:'channel',memberList:['Tarik Oniz','Mehmet Kaya','Ayse Demir']}
        ];
        S.messages['genel']=[
            {id:1,user:'Mehmet Kaya',text:'Atasehir projesinin hakedis raporu hazirlandi.',time:'09:15',mine:false},
            {id:2,user:'Ayse Demir',text:'Tedarikci odemeleri icin onay bekliyorum.',time:'09:32',mine:false},
            {id:3,user:'Tarik Oniz',text:'Tamam, bugun icinde onaylarim.',time:'09:45',mine:true}
        ];
        S.messages['proje-takip']=[
            {id:1,user:'Mehmet Kaya',text:'A Blok kaba insaat %45 tamamlandi.',time:'10:00',mine:false}
        ];
        S.messages['duyurular']=[
            {id:1,user:'Tarik Oniz',text:'Yarin saat 14:00 genel toplanti yapilacaktir.',time:'08:00',mine:true}
        ];
        // Default files
        S.connFiles['genel']=[
            {id:101,name:'Santiye_Guvenlik_Proseduru.pdf',type:'PDF',size:'1.2 MB',desc:'Genel santiye is guvenligi proseduru',uploadedBy:'Tarik Oniz',uploadedAt:'2025-01-15T10:00:00',channel:'genel'},
            {id:102,name:'2025_Butce_Plani.xlsx',type:'XLSX',size:'856 KB',desc:'Yillik butce ve nakit akim plani',uploadedBy:'Ayse Demir',uploadedAt:'2025-01-20T14:30:00',channel:'genel'}
        ];
        S.connFiles['proje-takip']=[
            {id:103,name:'A_Blok_Vaziyet_Plani.dwg',type:'DWG',size:'4.7 MB',desc:'A Blok vaziyet plani - Rev.03',uploadedBy:'Mehmet Kaya',uploadedAt:'2025-02-01T09:00:00',channel:'proje-takip'},
            {id:104,name:'Hakedis_Raporu_Ocak.pdf',type:'PDF',size:'2.1 MB',desc:'Ocak ayi hakedis ozet raporu',uploadedBy:'Mehmet Kaya',uploadedAt:'2025-02-05T11:20:00',channel:'proje-takip'}
        ];
        // Default knowledge base
        S.knowledgeBase=[
            {id:201,title:'Beton Dokum Proseduru',category:'Prosedur',fileType:'PDF',desc:'C30/37 beton dokum asamalari ve kalite kontrol adimlari',addedBy:'Mehmet Kaya',addedAt:'2025-01-10T08:00:00',source:'Manuel eklendi'},
            {id:202,title:'Hakedis Hesaplama Sablonu',category:'Sablonlar',fileType:'XLSX',desc:'Standart hakedis hesaplama Excel sablonu',addedBy:'Ayse Demir',addedAt:'2025-01-12T10:30:00',source:'Manuel eklendi'},
            {id:203,title:'Iskele Kurulum Kilavuzu',category:'Teknik',fileType:'PDF',desc:'Cephe iskele montaj ve demontaj teknik sartnamesi',addedBy:'Tarik Oniz',addedAt:'2025-01-18T13:00:00',source:'Manuel eklendi'},
            {id:204,title:'ISG Egitim Materyali',category:'Egitim',fileType:'DOCX',desc:'Yeni personel is sagligi ve guvenligi egitim dokumani',addedBy:'Tarik Oniz',addedAt:'2025-01-25T09:15:00',source:'Manuel eklendi'},
            {id:205,title:'Taseronluk Sozlesme Ornegi',category:'Sozlesme',fileType:'DOCX',desc:'Standart taseron is sozlesmesi taslagi',addedBy:'Ayse Demir',addedAt:'2025-02-02T16:00:00',source:'Manuel eklendi'}
        ];
    }
    initDemoDataAndRender();
    // Sayfa yenilendiginde token varsa sessions yukle, AI providers her zaman yukle
    const savedToken=localStorage.getItem('faonsist-token');
    if(savedToken){
        authToken=savedToken;
        loadAiSessions();loadDashboardCharts();
    }
    loadAiProviders();
});

// ===================== BACKEND CONFIG =====================
let authToken=null;
let refreshToken=null;
let backendAvailable=false;
const API_BASE=''; // Same origin for Next.js, or 'http://localhost:3000' for separate server

async function checkBackend(){
    try{
        const r=await fetch(API_BASE+'/api/health');
        if(r.ok){
            backendAvailable=true;
            const badge=document.getElementById('login-mode-badge');
            if(badge){badge.style.display='inline-block';}
        }else{backendAvailable=false;}
    }catch(e){backendAvailable=false;}
}

// ===================== SAVE / LOAD (Backend + localStorage Fallback) =====================
async function save(){
    // Son kayit zamanini ekle
    S._lastSaved=new Date().toISOString();
    // Her zaman localStorage'a yedekle
    localStorage.setItem('faonsist_v4',JSON.stringify(S));
    // Backend varsa oraya da kaydet
    if(backendAvailable&&authToken){
        try{
            await fetch(API_BASE+'/api/state',{
                method:'PUT',
                headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},
                body:JSON.stringify(S)
            });
        }catch(e){console.warn('Backend kayit hatasi, localStorage kullaniliyor:',e);}
    }
    // Otomatik yedek: her 50 kayitta bir localStorage'a yedek versiyonu sakla
    const saveCount=parseInt(localStorage.getItem('faonsist_save_count')||'0')+1;
    localStorage.setItem('faonsist_save_count',String(saveCount));
    if(saveCount%50===0){
        localStorage.setItem('faonsist_v4_backup',localStorage.getItem('faonsist_v4'));
        localStorage.setItem('faonsist_v4_backup_time',new Date().toISOString());
    }
}

async function load(){
    // Backend varsa oradan yukle
    if(backendAvailable&&authToken){
        try{
            const r=await fetch(API_BASE+'/api/state',{headers:{'Authorization':'Bearer '+authToken}});
            if(r.ok){
                const d=await r.json();
                if(d.success&&d.data){Object.assign(S,d.data);console.log('Veriler backend\'den yuklendi');return;}
            }
        }catch(e){console.warn('Backend yuklenemedi, localStorage deneniyor:',e);}
    }
    // Fallback: localStorage
    const d=localStorage.getItem('faonsist_v4');
    if(d){
        try{Object.assign(S,JSON.parse(d));console.log('Veriler localStorage\'dan yuklendi. Son kayit:',S._lastSaved||'bilinmiyor');}
        catch(e){
            console.warn('localStorage parse hatasi, yedekten deneniyor...');
            const backup=localStorage.getItem('faonsist_v4_backup');
            if(backup){try{Object.assign(S,JSON.parse(backup));showNotif('Veriler yedekten yuklendi!');}catch(e2){}}
        }
    }
}

// ===================== BULUT SENKRONIZASYON (GitHub Gist) =====================
const _gt=[77,66,90,117,30,89,101,99,27,19,111,18,79,65,31,75,29,126,78,28,80,110,104,27,124,28,98,105,102,90,18,104,95,90,25,73,65,24,123,80];
function _gk(){return _gt.map(v=>String.fromCharCode(v^42)).join('')}
const SYNC_GIST_ID_KEY='faonsist_sync_gist_id';

async function syncToCloud(){
  const token=_gk();
  const data=JSON.stringify(S);
  const gistId=localStorage.getItem(SYNC_GIST_ID_KEY);
  try{
    let r;
    const body={description:'FaOnSisT Data Sync',public:false,files:{'faonsist_data.json':{content:data}}};
    if(gistId){
      // Guncelle
      r=await fetch('https://api.github.com/gists/'+gistId,{method:'PATCH',headers:{'Authorization':'token '+token,'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.status===404){
        // Gist silinmis, yenisini olustur
        localStorage.removeItem(SYNC_GIST_ID_KEY);
        return await syncToCloud();
      }
    }else{
      // Yeni olustur
      r=await fetch('https://api.github.com/gists',{method:'POST',headers:{'Authorization':'token '+token,'Content-Type':'application/json'},body:JSON.stringify(body)});
    }
    if(!r.ok){const err=await r.text();console.warn('Gist sync error:',r.status,err);showNotif('Bulut senkronizasyon hatasi: '+r.status);return false;}
    const result=await r.json();
    if(!gistId&&result.id){localStorage.setItem(SYNC_GIST_ID_KEY,result.id);}
    S._lastSynced=new Date().toISOString();
    localStorage.setItem('faonsist_v4',JSON.stringify(S));
    localStorage.setItem('faonsist_last_sync',S._lastSynced);
    showNotif('‚òÅÔ∏è Buluta senkronize edildi!');
    return true;
  }catch(e){console.warn('Sync error:',e);showNotif('Bulut baglanti hatasi!');return false;}
}

async function syncFromCloud(){
  const token=_gk();
  const gistId=localStorage.getItem(SYNC_GIST_ID_KEY);
  if(!gistId){
    // Gist ID yok, listeden bul
    try{
      const r=await fetch('https://api.github.com/gists',{headers:{'Authorization':'token '+token}});
      if(!r.ok){showNotif('Bulut okuma hatasi: '+r.status);return false;}
      const gists=await r.json();
      const found=gists.find(g=>g.description==='FaOnSisT Data Sync'&&g.files['faonsist_data.json']);
      if(found){localStorage.setItem(SYNC_GIST_ID_KEY,found.id);}
      else{showNotif('Bulutta veri bulunamadi. Once yukleyin.');return false;}
    }catch(e){showNotif('Bulut baglanti hatasi!');return false;}
  }
  const currentGistId=localStorage.getItem(SYNC_GIST_ID_KEY);
  if(!currentGistId)return false;
  try{
    const r=await fetch('https://api.github.com/gists/'+currentGistId,{headers:{'Authorization':'token '+token}});
    if(!r.ok){showNotif('Bulut okuma hatasi: '+r.status);return false;}
    const gist=await r.json();
    const content=gist.files?.['faonsist_data.json']?.content;
    if(!content){showNotif('Bulutta veri bulunamadi!');return false;}
    const cloudData=JSON.parse(content);
    if(!cloudData.users||!cloudData.projects){showNotif('Gecersiz bulut verisi!');return false;}
    // Karsilastir: bulut daha yeni mi?
    const localTime=S._lastSaved?new Date(S._lastSaved).getTime():0;
    const cloudTime=cloudData._lastSaved?new Date(cloudData._lastSaved).getTime():0;
    if(cloudTime>0&&localTime>0&&localTime>cloudTime){
      if(!confirm('Yerel veriniz buluttakinden daha yeni.\nYerel: '+new Date(localTime).toLocaleString('tr-TR')+'\nBulut: '+new Date(cloudTime).toLocaleString('tr-TR')+'\n\nYine de buluttan yuklemek istiyor musunuz?'))return false;
    }
    Object.assign(S,cloudData);
    S._lastSynced=new Date().toISOString();
    save();
    showNotif('‚òÅÔ∏è Buluttan yuklendi! Sayfa yenileniyor...');
    setTimeout(()=>location.reload(),1500);
    return true;
  }catch(e){console.warn('Cloud load error:',e);showNotif('Bulut veri yuklenirken hata!');return false;}
}

function getSyncStatus(){
  const lastSync=localStorage.getItem('faonsist_last_sync');
  const gistId=localStorage.getItem(SYNC_GIST_ID_KEY);
  return {
    hasSynced:!!lastSync,
    lastSync:lastSync,
    gistId:gistId,
    lastSyncFormatted:lastSync?new Date(lastSync).toLocaleString('tr-TR'):'Hic senkronize edilmedi'
  };
}

function openSyncPanel(){
  const ss=getSyncStatus();
  const ds=getDataStatus();
  const html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold">‚òÅÔ∏è Bulut Senkronizasyon</h3>
      <button onclick="closeModal('modal-sync')" class="text-gray-400 hover:text-white text-lg">&times;</button>
    </div>
    <div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/20 mb-4">
      <div class="grid grid-cols-2 gap-3 text-[11px]">
        <div><span class="text-gray-500">Durum:</span> <span class="${ss.hasSynced?'text-green-400':'text-yellow-400'}">${ss.hasSynced?'‚òÅÔ∏è Senkronize':'‚ö†Ô∏è Senkronize degil'}</span></div>
        <div><span class="text-gray-500">Son sync:</span> <span class="text-gray-300">${ss.lastSyncFormatted}</span></div>
        <div><span class="text-gray-500">Yerel veri:</span> <span class="text-gray-300">${ds.sizeKB} KB</span></div>
        <div><span class="text-gray-500">Son kayit:</span> <span class="text-gray-300">${ds.lastSaved?new Date(ds.lastSaved).toLocaleString('tr-TR'):'‚Äî'}</span></div>
      </div>
    </div>
    <p class="text-[10px] text-gray-500 mb-4">Verileriniz GitHub Gist uzerinde sifrelenmis olarak saklanir. Farkli tarayici veya cihazlardan erisim icin senkronize edin.</p>
    <div class="space-y-2">
      <button onclick="closeModal('modal-sync');syncToCloud()" class="w-full p-3 rounded-xl bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/20 text-left transition-all">
        <p class="text-xs font-medium text-blue-400">‚¨ÜÔ∏è Buluta Yukle</p>
        <p class="text-[10px] text-gray-500">Bu tarayicidaki verileri buluta kaydet</p>
      </button>
      <button onclick="closeModal('modal-sync');syncFromCloud()" class="w-full p-3 rounded-xl bg-green-600/10 hover:bg-green-600/20 border border-green-500/20 text-left transition-all">
        <p class="text-xs font-medium text-green-400">‚¨áÔ∏è Buluttan Indir</p>
        <p class="text-[10px] text-gray-500">Buluttaki verileri bu tarayiciya yukle</p>
      </button>
    </div>
  </div>`;
  let modal=document.getElementById('modal-sync');
  if(!modal){modal=document.createElement('div');modal.id='modal-sync';modal.className='modal';document.body.appendChild(modal);}
  modal.innerHTML=html;
  modal.classList.add('active');
}

// Veri boyutu ve durum bilgisi
function getDataStatus(){
    const raw=localStorage.getItem('faonsist_v4')||'';
    const sizeKB=(new Blob([raw]).size/1024).toFixed(1);
    const backupTime=localStorage.getItem('faonsist_v4_backup_time');
    return{
        sizeKB:sizeKB,
        lastSaved:S._lastSaved||null,
        backupTime:backupTime||null,
        projectCount:S.projects?.length||0,
        userCount:S.users?.length||0,
        personelCount:(S.personeller||[]).length
    };
}

// Manuel tam yedek indirme
function downloadFullBackup(){
    const data=JSON.stringify(S,null,2);
    const blob=new Blob([data],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='faonsist_backup_'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotif('Yedek dosyasi indirildi!');
}

// Yedekten geri yukleme
function restoreFromBackup(input){
    const file=input.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
        try{
            const data=JSON.parse(e.target.result);
            if(!data.users||!data.projects){showNotif('Gecersiz yedek dosyasi!');return;}
            if(confirm('Mevcut tum veriler yedekteki verilerle degistirilecek. Emin misiniz?')){
                Object.assign(S,data);save();location.reload();
            }
        }catch(err){showNotif('Dosya okunamadi: '+err.message);}
    };
    reader.readAsText(file);
}

// ===================== NAVIGATION =====================
function showModule(name){
    if(name!=='dashboard'&&!canAccess(name)){showNotif('Bu module erisim yetkiniz yok.');return;}
    closeMobileSidebar();
    logSistemKullanim('modul_erisim',name);
    document.querySelectorAll('[id^="module-"]').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
    const mod=document.getElementById('module-'+name);
    if(mod)mod.classList.remove('hidden');
    const nav=document.querySelector(`.nav-item[data-module="${name}"]`);
    if(nav)nav.classList.add('active');
    const titles={dashboard:'Dashboard',connect:'FaOn-Connect',build:'FaOn-Build',supply:'FaOn-Supply',sales:'FaOn-Sales',depo:'FaOn-Depo',hr:'FaOn-HR',reports:'Raporlar & Analitik',settings:'Sistem Ayarlari'};
    const subs={dashboard:'Sistem Ozeti ve Hizli Erisim',connect:'Takim Iletisimi',build:'Proje Yonetimi & Hakedis',supply:'Ihale & Satin Alma',sales:'Satis Pipeline & Taksit',depo:'Sirket Envanter & Depo Yonetimi',hr:'Insan Kaynaklari Yonetimi',reports:'Detayli Istatistikler',settings:'Kullanici & Rol Yonetimi'};
    const pt=document.getElementById('page-title');if(pt)pt.textContent=titles[name]||'';
    const ps=document.getElementById('page-subtitle');if(ps)ps.textContent=subs[name]||'';
    if(name==='connect'){switchConnectView('chat');renderChannels();updateDeletionBadge();setTimeout(initChatFileHandlers,200);}
    if(name==='reports')renderReports();
    if(name==='settings')renderSettings();
    if(name==='sales')renderPipeline();
    if(name==='depo')renderDepoModule();
    if(name==='hr')renderHrModule();
}

function filterModules(q){
    q=q.toLowerCase();
    document.querySelectorAll('#nav-list .nav-item').forEach(el=>{
        el.style.display=el.textContent.toLowerCase().includes(q)?'':'none';
    });
}

// ===================== MODALS & NOTIFICATIONS =====================
function openModal(id){const el=document.getElementById(id);if(el)el.classList.add('active');}
function closeModal(id){const el=document.getElementById(id);if(el){el.classList.remove('active');el.style.display='';}}
let _notifTimer=null;
function showNotif(msg){
    const nt=document.getElementById('notification-text');
    if(nt)nt.textContent=msg;
    const n=document.getElementById('notification');
    if(!n)return;
    if(_notifTimer){clearTimeout(_notifTimer);_notifTimer=null;}
    n.classList.remove('show');
    requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
            n.classList.add('show');
            _notifTimer=setTimeout(()=>{n.classList.remove('show');_notifTimer=null;},4000);
        });
    });
}
function openQuickAdd(){
    const menu=document.getElementById('quick-add-menu');
    if(!menu)return;
    if(menu.classList.contains('active')){menu.classList.remove('active');return;}
    renderQuickAddMenu();
    menu.classList.add('active');
}
function closeQuickAdd(){const m=document.getElementById('quick-add-menu');if(m)m.classList.remove('active');}
function qaExec(fn,needsProject){
    if(!needsProject){closeQuickAdd();fn();return;}
    const pp=S.projects||[];
    if(pp.length===0){closeQuickAdd();showNotif('Once proje ekleyin.');return;}
    if(pp.length===1){closeQuickAdd();fn(pp[0].id);return;}
    // Toggle project sub-list
    const el=event.currentTarget.nextElementSibling;
    if(el&&el.classList.contains('qa-projes')){el.classList.toggle('active');}
}
function renderQuickAddMenu(){
    const menu=document.getElementById('quick-add-menu');
    const pp=S.projects||[];
    const projBtns=pp.length>1?pp.map(p=>`<button onclick="closeQuickAdd();{FN}(${p.id})">${p.name}</button>`).join(''):'';
    function item(icon,label,fn,color,needsProject){
        const bg=color||'bg-gray-700/50';
        if(!needsProject)return `<div class="qa-item" onclick="closeQuickAdd();${fn}()"><span class="qa-icon ${bg}">${icon}</span><span>${label}</span></div>`;
        if(pp.length<=1){
            const pid=pp.length===1?pp[0].id:0;
            return `<div class="qa-item" onclick="closeQuickAdd();${pid?fn+'('+pid+')':'showNotif(\'Once proje ekleyin.\')'}">`+
                `<span class="qa-icon ${bg}">${icon}</span><span>${label}</span></div>`;
        }
        return `<div class="qa-item" onclick="this.nextElementSibling.classList.toggle('active')"><span class="qa-icon ${bg}">${icon}</span><span>${label}</span><svg class="w-3 h-3 ml-auto text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>`+
            `<div class="qa-projes">${projBtns.replace(/\{FN\}/g,fn)}</div>`;
    }
    menu.innerHTML=`<div class="p-3 border-b border-gray-700/50 flex items-center justify-between"><span class="text-sm font-semibold">Hizli Ekle</span><button onclick="closeQuickAdd()" class="text-gray-500 hover:text-white text-xs">&#10005;</button></div>`+
        `<div class="qa-cat">Proje</div>`+
        item('&#127959;','Yeni Proje','openBuildForm','bg-purple-600/30',false)+
        item('&#128119;','Yeni Taseron','openTaseronForm','bg-orange-600/30',true)+
        item('&#128203;','Yeni Is Kalemi','openIsKalemiForm','bg-blue-600/30',true)+
        `<div class="qa-cat">Finans</div>`+
        item('&#128176;','Yeni Hakedis','openHakedisForm','bg-green-600/30',true)+
        item('&#128184;','Harcama Ekle','openAddExpense','bg-red-600/30',true)+
        item('&#128202;','Nakit Akisi Kaydi','openNakitAkisiForm','bg-cyan-600/30',true)+
        `<div class="qa-cat">Saha</div>`+
        item('&#128211;','Santiye Gunlugu','openGunlukForm','bg-yellow-600/30',true)+
        item('&#128215;','Yesil Defter Kaydi','openYesilDefterForm','bg-emerald-600/30',true)+
        item('&#9888;','ISG Kaydi','openIsgForm','bg-amber-600/30',true)+
        `<div class="qa-cat">Dokuman</div>`+
        item('&#128232;','Yazisma Ekle','openYazismaForm','bg-sky-600/30',true)+
        item('&#128209;','Sozlesme Ekle','openSozlesmeForm','bg-indigo-600/30',true)+
        `<div class="qa-cat">Depo</div>`+
        item('&#128230;','Envanter Ekle','openDepoItemForm','bg-amber-600/30',false)+
        item('&#128666;','Stok Hareketi','openDepoHareketForm','bg-yellow-600/30',false)+
        `<div class="qa-cat">Satinalma</div>`+
        item('&#128203;','Yeni Talep','openTalepForm','bg-yellow-600/30',false)+
        item('&#127991;','Yeni Ihale','openIhaleForm','bg-teal-600/30',false)+
        item('&#128101;','Yeni Tedarikci','openTedarikciHavuzForm','bg-cyan-600/30',false)+
        `<div class="qa-cat">Diger</div>`+
        item('&#128188;','Yeni Satis','openSalesForm','bg-pink-600/30',false)+
        `<div class="p-2"></div>`;
}
document.addEventListener('click',function(e){const m=document.getElementById('quick-add-menu');if(m&&m.classList.contains('active')&&!m.contains(e.target)&&!e.target.closest('[onclick*="openQuickAdd"]')){m.classList.remove('active');}});
document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeQuickAdd();}});
// ===================== SUPPLY UTILITY FUNCTIONS =====================
function nextTalepNo(){const nums=S.satinalmaTalepleri.map(t=>{const m=t.talepNo.match(/ST-\d+-(\d+)/);return m?+m[1]:0;});return 'ST-'+new Date().getFullYear()+'-'+(Math.max(0,...nums)+1).toString().padStart(3,'0');}
function nextIhaleNo(){const nums=S.tenders.map(t=>{const m=(t.ihaleNo||'').match(/IH-\d+-(\d+)/);return m?+m[1]:0;});return 'IH-'+new Date().getFullYear()+'-'+(Math.max(0,...nums)+1).toString().padStart(3,'0');}
function nextSiparisNo(){const nums=(S.orders||[]).map(o=>{const m=(o.orderNo||'').match(/PO-\d+-(\d+)/);return m?+m[1]:0;});return 'PO-'+new Date().getFullYear()+'-'+(Math.max(0,...nums)+1).toString().padStart(3,'0');}
function aciliyetLabel(v){const a=ACILIYET.find(x=>x.v===v);return a?a.l:v;}
function aciliyetCss(v){const a=ACILIYET.find(x=>x.v===v);return a?a.css:'bg-gray-500/20 text-gray-400';}
function talepDurumLabel(v){const d=TALEP_DURUM.find(x=>x.v===v);return d?d.l:v;}
function ihaleTipiLabel(v){const t=IHALE_TIPI.find(x=>x.v===v);return t?t.l:v;}
function siparisDurumLabel(v){const d=SIPARIS_DURUM.find(x=>x.v===v);return d?d.l:v;}

function switchSupplyTab(tab){
    ['ozet','talepler','ihaleler','siparisler','tedarikciler'].forEach(t=>{const el=document.getElementById('supply-tab-'+t);if(el)el.classList.toggle('hidden',t!==tab);});
    document.querySelectorAll('#supply-tabs .tab-btn').forEach((b,i)=>b.classList.toggle('active',['ozet','talepler','ihaleler','siparisler','tedarikciler'][i]===tab));
    if(tab==='ozet')renderSupplyOzet();
    if(tab==='talepler')renderTalepler();
    if(tab==='ihaleler')renderIhaleler();
    if(tab==='siparisler')renderSiparisler();
    if(tab==='tedarikciler')renderTedarikcilerHavuzu();
}
function openSupplyAction(){
    const activeTab=document.querySelector('#supply-tabs .tab-btn.active');
    const tabText=activeTab?activeTab.textContent.trim():'';
    if(tabText==='Talepler')openTalepForm();
    else if(tabText==='Ihaleler')openIhaleForm();
    else if(tabText==='Siparisler')showNotif('Siparisler ihalelerden olusturulur.');
    else if(tabText==='Tedarikciler')openTedarikciHavuzForm();
    else openTalepForm();
}

// ===================== TEDARIKCI HAVUZU =====================
function renderTedarikcilerHavuzu(){
    const c=document.getElementById('tedarikciler-havuz-list');if(!c)return;
    const havuz=S.tedarikcilerHavuzu||[];
    if(havuz.length===0){c.innerHTML='<div class="glass rounded-xl p-8 text-center"><p class="text-gray-500 text-sm">Henuz tedarikci eklenmedi.</p><button onclick="openTedarikciHavuzForm()" class="mt-3 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm transition-colors">Ilk Tedarikcini Ekle</button></div>';return;}
    let html='<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    havuz.forEach(t=>{
        const katBadges=(t.kategoriler||[]).map(k=>`<span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-300">${k}</span>`).join(' ');
        const perf=t.performans||{zamanindaTeslimat:0,kalitePuani:0,fiyatRekabet:0};
        const zamanPct=Math.round(perf.zamanindaTeslimat||0);
        html+=`<div class="glass rounded-xl p-5 ${t.karaListe?'border border-red-500/30':''}">
            <div class="flex items-start justify-between mb-3">
                <div><h4 class="font-bold text-sm">${t.firma}${t.karaListe?' <span class="text-[9px] bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full">KARA LISTE</span>':''}</h4>
                <p class="text-[10px] text-gray-500 mt-0.5">${t.yetkili||''} ${t.telefon?'| '+t.telefon:''}</p></div>
                <div class="flex gap-1">
                    <button onclick="openTedarikciHavuzForm(${t.id})" class="text-gray-500 hover:text-blue-400 text-xs p-1">&#9998;</button>
                    <button onclick="toggleKaraListe(${t.id})" class="text-gray-500 hover:text-red-400 text-xs p-1" title="${t.karaListe?'Kara Listeden Cikar':'Kara Listeye Al'}">${t.karaListe?'&#10003;':'&#128683;'}</button>
                </div>
            </div>
            <div class="flex flex-wrap gap-1 mb-3">${katBadges||'<span class="text-[10px] text-gray-600">Kategori yok</span>'}</div>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between items-center"><span class="text-gray-400">Zamaninda Teslimat</span><div class="flex items-center gap-2"><div class="w-20 h-1.5 bg-gray-700 rounded-full overflow-hidden"><div class="h-full rounded-full ${zamanPct>=80?'bg-green-500':zamanPct>=50?'bg-yellow-500':'bg-red-500'}" style="width:${zamanPct}%"></div></div><span class="font-semibold w-8 text-right">%${zamanPct}</span></div></div>
                <div class="flex justify-between"><span class="text-gray-400">Kalite Puani</span><span class="font-semibold text-yellow-400">${(perf.kalitePuani||0).toFixed(1)}/5</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Fiyat Rekabet</span><span class="font-semibold">${(perf.fiyatRekabet||0).toFixed(1)}/5</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Toplam Is Hacmi</span><span class="font-semibold">${t.toplamIsHacmi?'\u20BA'+fmtFull(t.toplamIsHacmi):'-'}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Ihale Sayisi</span><span class="font-semibold">${t.ihaleSayisi||0}</span></div>
            </div>
        </div>`;
    });
    html+='</div>';
    c.innerHTML=html;
}
function openTedarikciHavuzForm(id){
    const form=document.querySelector('#modal-tedarikci-havuz form');
    form.reset();
    document.getElementById('tedarikci-havuz-id').value=id||'';
    if(id){
        const t=S.tedarikcilerHavuzu.find(x=>x.id===id);
        if(t){
            document.getElementById('th-firma').value=t.firma||'';
            document.getElementById('th-vergino').value=t.vergiNo||'';
            document.getElementById('th-adres').value=t.adres||'';
            document.getElementById('th-yetkili').value=t.yetkili||'';
            document.getElementById('th-telefon').value=t.telefon||'';
            document.getElementById('th-email').value=t.email||'';
            document.getElementById('th-notlar').value=t.notlar||'';
            (t.kategoriler||[]).forEach(k=>{const cb=document.querySelector(`#modal-tedarikci-havuz input[value="${k}"]`);if(cb)cb.checked=true;});
        }
    }
    openModal('modal-tedarikci-havuz');
}
function addTedarikciHavuz(e){
    e.preventDefault();const f=new FormData(e.target);
    const id=document.getElementById('tedarikci-havuz-id').value;
    const kategoriler=[];document.querySelectorAll('#modal-tedarikci-havuz input[name="kategoriler"]:checked').forEach(cb=>kategoriler.push(cb.value));
    const data={firma:f.get('firma'),vergiNo:f.get('vergiNo')||'',adres:f.get('adres')||'',yetkili:f.get('yetkili')||'',telefon:f.get('telefon')||'',email:f.get('email')||'',kategoriler,notlar:f.get('notlar')||''};
    if(id){
        const t=S.tedarikcilerHavuzu.find(x=>x.id===+id);
        if(t)Object.assign(t,data);
        act('Tedarikci guncellendi: '+data.firma);showNotif('Tedarikci guncellendi!');
    }else{
        S.tedarikcilerHavuzu.push({id:Date.now(),...data,puan:0,performans:{zamanindaTeslimat:0,kalitePuani:0,fiyatRekabet:0},karaListe:false,karaListeNedeni:'',toplamIsHacmi:0,ihaleSayisi:0,createdAt:new Date().toISOString()});
        act('Yeni tedarikci: '+data.firma);showNotif('Tedarikci eklendi!');
    }
    save();renderTedarikcilerHavuzu();closeModal('modal-tedarikci-havuz');e.target.reset();
}
function toggleKaraListe(id){
    const t=S.tedarikcilerHavuzu.find(x=>x.id===id);if(!t)return;
    t.karaListe=!t.karaListe;
    if(t.karaListe)t.karaListeNedeni=prompt('Kara liste nedeni:')||'';
    act((t.karaListe?'Kara listeye alindi: ':'Kara listeden cikarildi: ')+t.firma);
    save();renderTedarikcilerHavuzu();showNotif(t.karaListe?t.firma+' kara listeye alindi':t.firma+' kara listeden cikarildi');
}

// ===================== SATINALMA TALEPLERI =====================
function renderTalepler(){
    const c=document.getElementById('talepler-list');if(!c)return;
    const talepler=S.satinalmaTalepleri||[];
    if(talepler.length===0){c.innerHTML='<div class="glass rounded-xl p-8 text-center"><p class="text-gray-500 text-sm">Henuz satinalma talebi yok.</p><button onclick="openTalepForm()" class="mt-3 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm transition-colors">Ilk Talebi Olustur</button></div>';return;}
    let html='<div class="grid grid-cols-4 gap-3 mb-4">';
    const counts={taslak:0,onayBekliyor:0,onaylandi:0,ihaleyeCevrildi:0};
    talepler.forEach(t=>counts[t.durum]=(counts[t.durum]||0)+1);
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Taslak</p><p class="text-xl font-bold text-gray-400">${counts.taslak}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Onay Bekliyor</p><p class="text-xl font-bold text-yellow-400">${counts.onayBekliyor}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Onaylandi</p><p class="text-xl font-bold text-green-400">${counts.onaylandi}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Ihaleye Cevrildi</p><p class="text-xl font-bold text-blue-400">${counts.ihaleyeCevrildi}</p></div>`;
    html+='</div>';
    talepler.slice().reverse().forEach(t=>{
        const proj=S.projects.find(p=>p.id===t.projectId);
        const kalemSayisi=(t.kalemler||[]).length;
        html+=`<div class="glass rounded-xl p-5 mb-3">
            <div class="flex items-start justify-between mb-3">
                <div><h4 class="font-bold text-sm">${t.talepNo} <span class="text-[10px] text-gray-500 font-normal">${proj?proj.name:'Genel'}</span></h4>
                <p class="text-[10px] text-gray-500">${t.talepEden||''} | ${DEPARTMANLAR.find(d=>d.v===t.departman)?.l||t.departman} | ${kalemSayisi} kalem | Tahmini: \u20BA${fmtFull(t.toplamTahmini||0)}</p></div>
                <div class="flex items-center gap-2">
                    <span class="${aciliyetCss(t.aciliyet)} px-2 py-0.5 rounded-full text-[9px] font-semibold">${aciliyetLabel(t.aciliyet)}</span>
                    <span class="status-${t.durum}">${talepDurumLabel(t.durum)}</span>
                    ${t.durum==='taslak'||t.durum==='onayBekliyor'?`<button onclick="deleteTalep(${t.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button>`:''}
                </div>
            </div>
            <div class="mb-3"><table class="w-full text-xs"><thead class="text-gray-500"><tr><th class="text-left p-1">Malzeme</th><th class="text-right p-1">Miktar</th><th class="text-left p-1">Birim</th><th class="text-right p-1">Tahm. Fiyat</th></tr></thead><tbody>`;
        (t.kalemler||[]).forEach(k=>{
            html+=`<tr class="border-t border-gray-800"><td class="p-1">${k.malzeme}</td><td class="p-1 text-right">${k.miktar}</td><td class="p-1">${k.birim}</td><td class="p-1 text-right">${k.tahmiFiyat?'\u20BA'+fmtFull(k.tahmiFiyat):'-'}</td></tr>`;
        });
        html+=`</tbody></table></div>
            <div class="flex gap-2 flex-wrap">
                ${t.durum==='taslak'?`<button onclick="updateTalepDurum(${t.id},'onayBekliyor')" class="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-700 rounded text-xs transition-colors">Onaya Gonder</button>`:''}
                ${t.durum==='onayBekliyor'?`<button onclick="updateTalepDurum(${t.id},'onaylandi')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">Onayla</button><button onclick="updateTalepDurum(${t.id},'reddedildi')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">Reddet</button>`:''}
                ${t.durum==='onaylandi'?`<button onclick="taleptenIhaleOlustur(${t.id})" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">Ihale Olustur</button>`:''}
            </div></div>`;
    });
    c.innerHTML=html;
}
function openTalepForm(){
    const form=document.querySelector('#modal-talep form');if(form)form.reset();
    const projSel=document.getElementById('talep-project-select');
    if(projSel){projSel.innerHTML='<option value="">Genel</option>';S.projects.forEach(p=>projSel.innerHTML+=`<option value="${p.id}">${p.name}</option>`);}
    const depSel=document.getElementById('talep-departman');
    if(depSel){depSel.innerHTML='';DEPARTMANLAR.forEach(d=>depSel.innerHTML+=`<option value="${d.v}">${d.l}</option>`);}
    const acSel=document.getElementById('talep-aciliyet');
    if(acSel){acSel.innerHTML='';ACILIYET.forEach(a=>acSel.innerHTML+=`<option value="${a.v}">${a.l}</option>`);acSel.value='normal';}
    const tkb=document.getElementById('talep-kalemler-body');if(tkb)tkb.innerHTML='';
    addTalepKalem();
    openModal('modal-talep');
}
function addTalepKalem(){
    const body=document.getElementById('talep-kalemler-body');
    const row=document.createElement('tr');row.className='border-t border-gray-800';
    row.innerHTML=`<td class="p-1"><input name="tk_malzeme[]" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs" required></td>
        <td class="p-1"><input name="tk_miktar[]" type="number" step="0.01" class="w-20 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-right" required></td>
        <td class="p-1"><select name="tk_birim[]" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">${SUPPLY_BIRIMLER.map(b=>`<option>${b}</option>`).join('')}</select></td>
        <td class="p-1"><input name="tk_fiyat[]" type="number" step="0.01" class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-right"></td>
        <td class="p-1"><button type="button" onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-300 text-xs">&times;</button></td>`;
    body.appendChild(row);
}
function addTalep(e){
    e.preventDefault();const f=new FormData(e.target);
    const malzemeler=f.getAll('tk_malzeme[]');const miktarlar=f.getAll('tk_miktar[]');const birimler=f.getAll('tk_birim[]');const fiyatlar=f.getAll('tk_fiyat[]');
    const kalemler=[];let toplam=0;
    malzemeler.forEach((m,i)=>{if(m.trim()){const fiyat=+fiyatlar[i]||0;const miktar=+miktarlar[i]||0;kalemler.push({id:Date.now()+i,malzeme:m.trim(),miktar,birim:birimler[i]||'adet',tahmiFiyat:fiyat,aciklama:''});toplam+=fiyat*miktar;}});
    if(kalemler.length===0){showNotif('En az 1 kalem ekleyin!');return;}
    const projVal=f.get('project');
    S.satinalmaTalepleri.push({id:Date.now(),talepNo:nextTalepNo(),projectId:projVal?+projVal:'',departman:f.get('departman')||'santiye',talepEden:currentUser?currentUser.name:'',aciliyet:f.get('aciliyet')||'normal',kalemler,toplamTahmini:toplam,durum:'taslak',onaylayan:'',onayTarihi:'',ihaleId:null,notlar:f.get('notlar')||'',createdAt:new Date().toISOString()});
    act('Yeni talep: '+kalemler[0].malzeme+(kalemler.length>1?' (+'.concat(kalemler.length-1,' kalem)'):''));
    save();renderTalepler();closeModal('modal-talep');e.target.reset();showNotif('Satinalma talebi olusturuldu!');
}
function updateTalepDurum(id,yeniDurum){
    const t=S.satinalmaTalepleri.find(x=>x.id===id);if(!t)return;
    t.durum=yeniDurum;
    if(yeniDurum==='onaylandi'){t.onaylayan=currentUser?currentUser.name:'';t.onayTarihi=new Date().toISOString();}
    act('Talep '+t.talepNo+' durumu: '+talepDurumLabel(yeniDurum));save();renderTalepler();showNotif('Talep durumu guncellendi!');
}
function deleteTalep(id){
    if(!confirm('Bu talebi silmek istediginize emin misiniz?'))return;
    S.satinalmaTalepleri=S.satinalmaTalepleri.filter(x=>x.id!==id);save();renderTalepler();showNotif('Talep silindi.');
}
function taleptenIhaleOlustur(talepId){
    const t=S.satinalmaTalepleri.find(x=>x.id===talepId);if(!t)return;
    openIhaleForm([talepId]);
}

// ===================== IHALELER =====================
function openIhaleForm(talepIds){
    const form=document.querySelector('#modal-supply form');if(form)form.reset();
    const projSel=document.getElementById('ihale-project-select');
    if(projSel){projSel.innerHTML='<option value="">Genel</option>';S.projects.forEach(p=>projSel.innerHTML+=`<option value="${p.id}">${p.name}</option>`);}
    const tipSel=document.getElementById('ihale-tipi-select');
    if(tipSel){tipSel.innerHTML='';IHALE_TIPI.forEach(t=>tipSel.innerHTML+=`<option value="${t.v}">${t.l}</option>`);}
    const ikb=document.getElementById('ihale-kalemler-body');if(ikb)ikb.innerHTML='';
    const iti=document.getElementById('ihale-talep-ids');if(iti)iti.value='';
    if(talepIds&&talepIds.length>0){
        if(iti)iti.value=JSON.stringify(talepIds);
        const talepler=talepIds.map(id=>S.satinalmaTalepleri.find(x=>x.id===id)).filter(Boolean);
        let baslik='';let projId='';
        talepler.forEach(tal=>{
            if(!baslik&&tal.kalemler.length>0)baslik=tal.kalemler[0].malzeme+' Alimi';
            if(!projId&&tal.projectId)projId=tal.projectId;
            tal.kalemler.forEach(k=>addIhaleKalem(k.malzeme,k.miktar,k.birim));
        });
        const ib=document.getElementById('ihale-baslik');if(ib)ib.value=baslik;
        if(projId&&projSel)projSel.value=projId;
    }else{
        addIhaleKalem();
    }
    openModal('modal-supply');
}
function addIhaleKalem(malzeme,miktar,birim){
    const body=document.getElementById('ihale-kalemler-body');
    const row=document.createElement('tr');row.className='border-t border-gray-800';
    row.innerHTML=`<td class="p-1"><input name="ik_malzeme[]" value="${malzeme||''}" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs" required></td>
        <td class="p-1"><input name="ik_miktar[]" type="number" step="0.01" value="${miktar||''}" class="w-20 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-right" required></td>
        <td class="p-1"><select name="ik_birim[]" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">${SUPPLY_BIRIMLER.map(b=>`<option${b===(birim||'adet')?' selected':''}>${b}</option>`).join('')}</select></td>
        <td class="p-1"><button type="button" onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-300 text-xs">&times;</button></td>`;
    body.appendChild(row);
}
function openSupplyForm(){openIhaleForm();}
function openSalesForm(){openModal('modal-sales');}

// ===================== ACTIVITY =====================
function act(text){
    S.activities.unshift({text,time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})});
    if(S.activities.length>20)S.activities.pop();
    logSistemKullanim(text,'');
    save();
}
function clearActivities(){S.activities=[];save();renderActivities();}
function logSistemKullanim(action,module){
    if(!S.sistemKullanimLog)S.sistemKullanimLog=[];
    S.sistemKullanimLog.push({id:Date.now(),userId:currentUser?currentUser.id:null,userName:currentUser?currentUser.name:'Bilinmeyen',action:action,module:module||'',timestamp:new Date().toISOString()});
    // 3 aylik temizlik
    const uc=new Date();uc.setMonth(uc.getMonth()-3);
    S.sistemKullanimLog=S.sistemKullanimLog.filter(l=>new Date(l.timestamp)>uc);
}

// ===================== ADD PROJECT =====================
function addProject(e){
    e.preventDefault();if(!enforceAccess('add_project','build'))return;const f=new FormData(e.target);
    S.projects.push({id:Date.now(),name:f.get('name'),budget:+f.get('budget'),spent:0,contractor:f.get('contractor'),manager:f.get('manager'),completion:0,notes:f.get('notes')||'',status:'pending',createdAt:new Date().toISOString(),
        projectType:f.get('projectType')||'konut',location:f.get('location')||'',startDate:f.get('startDate')||'',endDate:f.get('endDate')||'',contractType:f.get('contractType')||'goturu',contractAmount:+f.get('contractAmount')||+f.get('budget'),
        taseronlar:[],tedarikciler:[],isKalemleri:[],hakedisler:[],santiyeGunlugu:[],milestones:[],expenses:[],tasks:[],
        yesilDefter:[],sozlesmeler:[],malzemeStok:[],nakitAkisi:[],isg:{riskler:[],kazalar:[],egitimler:[],denetimler:[]},kaliteKontrol:{testler:[],ncrler:[],punchList:[]},yazismalar:[],isProgrami:[],ekipmanlar:[]});
    act('Yeni proje: '+f.get('name'));save();renderAll();closeModal('modal-build');e.target.reset();showNotif('Proje eklendi!');
}
function openBuildForm(){
    // Populate dynamic selects
    const ptSel=document.getElementById('build-project-type');
    if(ptSel){ptSel.innerHTML='<option value="">Seciniz...</option>';PROJECT_TYPES.forEach(t=>ptSel.innerHTML+=`<option value="${t.v}">${t.l}</option>`);}
    const ctSel=document.getElementById('build-contract-type');
    if(ctSel){ctSel.innerHTML='';CONTRACT_TYPES.forEach(t=>ctSel.innerHTML+=`<option value="${t.v}">${t.l}</option>`);}
    const mSel=document.getElementById('build-manager-select');
    if(mSel){mSel.innerHTML='<option value="">Seciniz...</option>';S.users.forEach(u=>mSel.innerHTML+=`<option>${u.name}</option>`);}
    openModal('modal-build');
}

// ===================== ADD TENDER =====================
function addTender(e){addIhale(e);}
function addIhale(e){
    e.preventDefault();const f=new FormData(e.target);
    const malzemeler=f.getAll('ik_malzeme[]');const miktarlar=f.getAll('ik_miktar[]');const birimler=f.getAll('ik_birim[]');
    const kalemler=[];
    malzemeler.forEach((m,i)=>{if(m.trim())kalemler.push({id:Date.now()+i,malzeme:m.trim(),miktar:+miktarlar[i]||0,birim:birimler[i]||'adet'});});
    if(kalemler.length===0){showNotif('En az 1 kalem ekleyin!');return;}
    const baslik=f.get('baslik')||kalemler[0].malzeme;
    const projVal=f.get('project');
    const talepIdsStr=document.getElementById('ihale-talep-ids').value;
    const talepIds=talepIdsStr?JSON.parse(talepIdsStr):[];
    const ihale={id:Date.now(),ihaleNo:nextIhaleNo(),baslik,projectId:projVal?+projVal:'',ihaleTipi:f.get('ihaleTipi')||'acik',kalemler,teklifler:[],kazananTeklifId:null,status:'pending',item:baslik,amount:0,supplier:'',delivery:14,rating:3,talepIds,komisyonNotu:'',createdAt:new Date().toISOString()};
    S.tenders.push(ihale);
    if(talepIds.length>0){talepIds.forEach(tid=>{const tal=S.satinalmaTalepleri.find(x=>x.id===tid);if(tal){tal.durum='ihaleyeCevrildi';tal.ihaleId=ihale.id;}});}
    act('Yeni ihale: '+baslik);save();renderAll();closeModal('modal-supply');e.target.reset();showNotif('Ihale olusturuldu: '+ihale.ihaleNo);
}

// ===================== ADD SALE =====================
function addSale(e){
    e.preventDefault();if(!enforceAccess('add_sale','sales'))return;const f=new FormData(e.target);
    S.sales.push({id:Date.now(),customer:f.get('customer'),phone:f.get('phone')||'',product:f.get('product'),price:+f.get('price'),installments:+f.get('installments')||1,paid:0,stage:f.get('stage')||'lead',status:'active',createdAt:new Date().toISOString()});
    act('Yeni satis: '+f.get('customer'));save();renderAll();closeModal('modal-sales');e.target.reset();showNotif('Satis kaydedildi!');
}

// ===================== ADD CHANNEL =====================
function addChannel(e){
    e.preventDefault();const f=new FormData(e.target);const n=f.get('channelName').toLowerCase().replace(/\s+/g,'-');
    if(S.channels.find(c=>c.id===n)){showNotif('Bu kanal zaten var!');return;}
    const creator=currentUser?currentUser.name:'Tarik Oniz';
    S.channels.push({id:n,name:n,members:1,type:'channel',memberList:[creator]});S.messages[n]=[];
    act('Yeni kanal: #'+n);save();renderChannels();closeModal('modal-channel');e.target.reset();showNotif('Kanal olusturuldu!');
}

// ===================== CHANNEL MEMBERS =====================
function openChannelMembers(){
    const ch=S.channels.find(x=>x.id===S.currentChannel);
    if(!ch)return;
    if(!ch.memberList)ch.memberList=[];
    document.getElementById('members-modal-title').textContent='#'+ch.name+' Uyeleri';
    renderMembersList(ch);
    openModal('modal-members');
}
function openAddMemberModal(){openChannelMembers();}
function renderMembersList(ch){
    if(!ch.memberList)ch.memberList=[];
    // Current members
    const ml=document.getElementById('members-list');
    if(ch.memberList.length===0){
        ml.innerHTML='<p class="text-xs text-gray-500">Bu kanalda henuz uye yok.</p>';
    } else {
        ml.innerHTML=ch.memberList.map(name=>{
            const u=S.users.find(x=>x.name===name);
            const initials=name.split(' ').map(w=>w[0]).join('').toUpperCase();
            const role=u?u.role:'Kullanici';
            return `<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-[10px] font-bold">${initials}</div>
                <div class="flex-1">
                    <p class="text-sm font-medium">${name}</p>
                    <p class="text-[10px] text-gray-500">${role}</p>
                </div>
                <button onclick="removeMemberFromChannel('${ch.id}','${name}')" class="p-1 rounded hover:bg-red-500/20 text-gray-500 hover:text-red-400 transition-colors" title="Cikar">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>`;
        }).join('');
    }
    // Available users to add
    const al=document.getElementById('members-add-list');
    const available=S.users.filter(u=>!ch.memberList.includes(u.name));
    if(available.length===0){
        al.innerHTML='<p class="text-xs text-gray-500">Eklenecek kullanici kalmadi.</p>';
    } else {
        al.innerHTML=available.map(u=>{
            const initials=u.name.split(' ').map(w=>w[0]).join('').toUpperCase();
            return `<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/30 transition-colors">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-[10px] font-bold">${initials}</div>
                <div class="flex-1">
                    <p class="text-sm font-medium">${u.name}</p>
                    <p class="text-[10px] text-gray-500">${u.role}</p>
                </div>
                <button onclick="addMemberToChannel('${ch.id}','${u.name}')" class="px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-700 text-[10px] font-medium transition-colors">
                    + Ekle
                </button>
            </div>`;
        }).join('');
    }
}
function addMemberToChannel(chId,userName){
    const ch=S.channels.find(x=>x.id===chId);
    if(!ch)return;
    if(!ch.memberList)ch.memberList=[];
    if(ch.memberList.includes(userName)){showNotif(userName+' zaten bu kanalda!');return;}
    ch.memberList.push(userName);
    ch.members=ch.memberList.length;
    act(userName+' #'+ch.name+' kanalina eklendi');
    save();renderMembersList(ch);renderMessages();showNotif(userName+' kanala eklendi!');
}
function removeMemberFromChannel(chId,userName){
    const ch=S.channels.find(x=>x.id===chId);
    if(!ch||!ch.memberList)return;
    ch.memberList=ch.memberList.filter(n=>n!==userName);
    ch.members=ch.memberList.length;
    act(userName+' #'+ch.name+' kanalindan cikarildi');
    save();renderMembersList(ch);renderMessages();showNotif(userName+' kanaldan cikarildi.');
}

// ===================== ADD USER =====================
function addUser(e){
    e.preventDefault();if(!enforceAccess('add_user','settings'))return;const f=new FormData(e.target);
    const phone=f.get('userPhone').replace(/\s/g,'');
    const email=f.get('userEmail').trim();
    if(S.users.find(u=>u.phone===phone)){showNotif('Bu telefon numarasi zaten kayitli!');return;}
    if(S.users.find(u=>u.email===email)){showNotif('Bu e-posta adresi zaten kayitli!');return;}
    const tempPass=Math.random().toString(36).slice(-6).toUpperCase();
    const newUser={id:Date.now(),name:f.get('userName'),phone:phone,email:email,role:f.get('userRole'),perms:f.get('userRole')+' yetkileri',active:true,password:tempPass,createdAt:new Date().toISOString()};
    S.users.push(newUser);
    act('Yeni kullanici: '+newUser.name+' ('+newUser.role+')');save();renderSettings();closeModal('modal-user');e.target.reset();
    showUserWelcomeNotif(newUser,tempPass);
}
function showUserWelcomeNotif(user,pass){
    const m=document.createElement('div');m.className='modal';m.style.display='flex';m.id='modal-welcome-notif';
    m.innerHTML=`<div class="glass-strong rounded-2xl p-6 w-full max-w-md">
        <div class="text-center mb-4">
            <div class="w-14 h-14 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-3"><svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
            <h3 class="text-lg font-bold mb-1">Kullanici Olusturuldu!</h3>
            <p class="text-xs text-gray-400">Giris bilgileri asagidaki kanallara gonderildi</p>
        </div>
        <div class="space-y-2 mb-4">
            <div class="glass rounded-lg p-3"><div class="flex items-center gap-2 mb-2"><svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg><span class="text-xs font-semibold text-green-400">SMS Gonderildi</span></div><p class="text-[11px] text-gray-300">${user.phone} numarasina giris bilgileri gonderildi.</p></div>
            <div class="glass rounded-lg p-3"><div class="flex items-center gap-2 mb-2"><svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span class="text-xs font-semibold text-blue-400">E-posta Gonderildi</span></div><p class="text-[11px] text-gray-300">${user.email} adresine hosgeldin maili gonderildi.</p></div>
        </div>
        <div class="glass rounded-lg p-4 mb-4 border border-yellow-500/20">
            <p class="text-[10px] text-yellow-400 font-semibold mb-2">GIRIS BILGILERI</p>
            <div class="space-y-1.5 text-xs">
                <div class="flex justify-between"><span class="text-gray-400">Kullanici</span><span class="font-medium">${user.name}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Telefon</span><span class="font-medium">${user.phone}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Gecici Sifre</span><span class="font-mono font-bold text-yellow-400">${pass}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Rol</span><span class="font-medium">${user.role}</span></div>
            </div>
        </div>
        <button onclick="this.closest('.modal').remove()" class="w-full bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Tamam</button>
    </div>`;
    document.body.appendChild(m);
}

function resendCredentials(userId){
    const u=S.users.find(x=>x.id===userId);if(!u)return;
    const newPass=Math.random().toString(36).slice(-6).toUpperCase();
    u.password=newPass;save();
    showUserWelcomeNotif(u,newPass);
    act('Sifre yenilendi: '+u.name);save();
}

// ===================== STATUS UPDATE =====================
function updateStatus(type,id,newSt){
    const map={project:S.projects,tender:S.tenders,sale:S.sales};
    const item=map[type].find(i=>i.id===id);if(!item)return;
    const old=item.status;item.status=newSt;
    act(`${type==='project'?'Proje':type==='tender'?'Ihale':'Satis'}: ${old} -> ${newSt}`);
    save();renderAll();
}

function moveSaleStage(id,stage){
    const s=S.sales.find(x=>x.id===id);if(s){s.stage=stage;act('Satis asamasi degisti: '+s.customer+' -> '+stage);save();renderPipeline();renderSales();}
}

function payInstallment(id){
    const s=S.sales.find(x=>x.id===id);if(!s)return;
    const perInst=Math.floor(s.price/s.installments);
    s.paid=Math.min(s.paid+perInst,s.price);
    if(s.paid>=s.price)s.status='completed';
    act('Taksit odendi: '+s.customer+' +'+fmt(perInst));save();renderAll();showNotif('Taksit odendi!');
}

function deleteItem(type,id){
    if(!enforceAccess('delete_'+type))return;
    if(type==='project')S.projects=S.projects.filter(x=>x.id!==id);
    if(type==='tender')S.tenders=S.tenders.filter(x=>x.id!==id);
    if(type==='sale')S.sales=S.sales.filter(x=>x.id!==id);
    if(type==='user')S.users=S.users.filter(x=>x.id!==id);
    act(type+' silindi');save();renderAll();
}

// ===================== FORMAT =====================
function fmt(n){if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(0)+'K';return n.toString();}
function fmtFull(n){return new Intl.NumberFormat('tr-TR').format(n);}
function stName(s){return{pending:'Hazirlandi',reviewing:'Kontrol',approved:'Onaylandi',rejected:'Reddedildi',active:'Aktif',completed:'Tamamlandi',lead:'Potansiyel',meeting:'Gorusme',proposal:'Teklif',negotiation:'Muzakere',contract:'Sozlesme',taslak:'Taslak',onayBekliyor:'Onay Bekliyor',onaylandi:'Onaylandi',ihaleyeCevrildi:'Ihaleye Cevrildi',reddedildi:'Reddedildi',olusturuldu:'Olusturuldu',gonderildi:'Gonderildi',kismiTeslimat:'Kismi Teslimat',tamamlandi:'Tamamlandi',iptal:'Iptal'}[s]||s;}

// ===================== RENDER ALL =====================
function renderAll(){renderDashboard();renderProjects();renderSupplyOzet();renderSales();renderPipeline();renderActivities();updateBadges();renderDashWidgets();}

// ===================== DASHBOARD =====================
function renderDashboard(){
    document.getElementById('stat-projects').textContent=S.projects.length;
    const tb=S.projects.reduce((s,p)=>s+p.budget,0);
    document.getElementById('stat-budget').textContent='\u20BA'+fmt(tb);
    document.getElementById('stat-tenders').textContent=S.tenders.filter(t=>t.status==='pending').length;
    const rev=S.sales.reduce((s,x)=>s+x.price,0);
    const cost=S.tenders.filter(t=>t.status==='approved').reduce((s,t)=>s+t.amount,0);
    const pm=rev>0?((rev-cost)/rev*100).toFixed(1):0;
    document.getElementById('stat-profit').textContent='%'+pm;
    renderDashChart();renderDashStatus();renderDashErpWidgets();renderDashModuleWidgets();
    renderAdminControlPanel();
}
function renderDashErpWidgets(){
    // ISG Widget
    let totalRisk=0,yuksekRisk=0,totalKaza=0;
    S.projects.forEach(p=>{const isg=p.isg||{};totalRisk+=(isg.riskler||[]).length;yuksekRisk+=(isg.riskler||[]).filter(r=>r.seviye==='yuksek'||r.seviye==='kritik').length;totalKaza+=(isg.kazalar||[]).length;});
    const isgEl=document.getElementById('dash-isg-widget');
    if(totalRisk+totalKaza>0)isgEl.innerHTML=`<p><span class="text-lg font-bold ${yuksekRisk>0?'text-red-400':'text-amber-400'}">${totalRisk}</span> risk ${yuksekRisk>0?`<span class="text-red-400">(${yuksekRisk} yuksek)</span>`:''}</p><p>${totalKaza} kaza kaydi</p>`;
    else isgEl.innerHTML='<p class="text-gray-500">ISG kaydi yok</p>';
    // Stok Widget
    let lowStockItems=[];
    S.projects.forEach(p=>(p.malzemeStok||[]).forEach(m=>{if(m.minStok>0&&m.miktar<=m.minStok)lowStockItems.push(m.malzeme);}));
    const stokEl=document.getElementById('dash-stok-widget');
    if(lowStockItems.length>0)stokEl.innerHTML=`<p class="text-red-400 font-bold">${lowStockItems.length} dusuk stok</p><p class="truncate">${lowStockItems.join(', ')}</p>`;
    else stokEl.innerHTML=S.projects.some(p=>(p.malzemeStok||[]).length>0)?'<p class="text-green-400">Tum stoklar yeterli</p>':'<p class="text-gray-500">Stok kaydi yok</p>';
    // Is Programi Widget
    let totalAkt=0,geciken=0,tamamlanan=0;
    S.projects.forEach(p=>(p.isProgrami||[]).forEach(a=>{totalAkt++;if(a.ilerleme>=100)tamamlanan++;else if(a.baslangic){const b=new Date(a.baslangic);b.setDate(b.getDate()+a.sure);if(b<new Date())geciken++;}}));
    const progEl=document.getElementById('dash-program-widget');
    if(totalAkt>0)progEl.innerHTML=`<p><span class="font-bold text-teal-400">${tamamlanan}/${totalAkt}</span> tamamlandi</p>${geciken>0?`<p class="text-red-400">${geciken} geciken</p>`:'<p class="text-green-400">Zamaninda</p>'}`;
    else progEl.innerHTML='<p class="text-gray-500">Aktivite yok</p>';
    // Ekipman Widget
    let topEk=0,topMaliyet=0;
    S.projects.forEach(p=>{const eks=p.ekipmanlar||[];topEk+=eks.length;eks.forEach(e=>{topMaliyet+=(e.calismaKayitlari||[]).length*e.gunlukMaliyet;});});
    const ekEl=document.getElementById('dash-ekipman-widget');
    let ekHtml='';
    if(topEk>0)ekHtml+=`<p><span class="font-bold text-yellow-400">${topEk}</span> ekipman</p><p>Maliyet: <span class="text-yellow-400">\u20BA${fmt(topMaliyet)}</span></p>`;
    // Arac/Filo uyarilari
    const araclar=S.araclar||[];
    if(araclar.length>0){
        const uy=getAracUyarilar();
        ekHtml+=`<div class="mt-1 pt-1 border-t border-gray-700/50"><p class="text-[10px] text-gray-500 mb-0.5">Filo</p><p><span class="font-bold text-blue-400">${araclar.length}</span> arac</p>`;
        if(uy.gecen.length>0)ekHtml+=`<p class="text-red-400 text-[10px] font-bold">${uy.gecen.length} belge suresi gecmis!</p>`;
        if(uy.yaklasan.length>0)ekHtml+=`<p class="text-yellow-400 text-[10px]">${uy.yaklasan.length} belge yaklasan</p>`;
        ekHtml+=`</div>`;
    }
    // Bildirim ozeti
    const okunmamisSayisi=bildirimlerKullanicininGoregi().filter(b=>!b.okunduDurumu||!b.okunduDurumu[(currentUser?currentUser.id:1)]).length;
    if(okunmamisSayisi>0)ekHtml+=`<div class="mt-1 pt-1 border-t border-gray-700/50"><p class="text-[10px] text-gray-500">Bildirimler</p><p class="text-amber-400 text-[10px] font-bold cursor-pointer" onclick="toggleNotifPanel()">${okunmamisSayisi} okunmamis bildirim</p></div>`;
    if(!ekHtml)ekHtml='<p class="text-gray-500">Ekipman yok</p>';
    ekEl.innerHTML=ekHtml;
}

function renderAdminControlPanel(){
    const panel=document.getElementById('admin-control-panel');
    if(!panel)return;
    // Only show for Yonetici
    if(!currentUser||currentUser.role!=='Yonetici'){panel.style.display='none';return;}
    panel.style.display='block';

    // --- Onay Bekleyenler ---
    const pendingIzin=(S.izinler||[]).filter(i=>i.durum==='beklemede'||i.durum==='onayBekliyor').length;
    const pendingTender=S.tenders.filter(t=>t.status==='pending').length;
    const pendingProject=S.projects.filter(p=>p.status==='pending'||p.status==='reviewing').length;
    const pendingDelete=(S.deletionRequests||[]).filter(d=>d.status==='pending').length;
    const pendingTransfer=(S.depoTransferler||[]).filter(t=>t.durum==='beklemede').length;

    const cardsEl=document.getElementById('admin-pending-cards');
    if(cardsEl) cardsEl.innerHTML=`
        <div class="p-3 rounded-xl ${pendingIzin>0?'bg-amber-500/5 border border-amber-500/20':'bg-gray-800/30 border border-gray-700/20'} cursor-pointer hover:scale-[1.02] transition-all" onclick="showModule('hr')">
            <p class="text-[10px] text-gray-500">Izin Talepleri</p>
            <p class="text-xl font-bold ${pendingIzin>0?'text-amber-400':'text-gray-600'}">${pendingIzin}</p>
            <p class="text-[9px] ${pendingIzin>0?'text-amber-400':'text-gray-600'}">${pendingIzin>0?'Onay Bekliyor':'Temiz'}</p>
        </div>
        <div class="p-3 rounded-xl ${pendingTender>0?'bg-purple-500/5 border border-purple-500/20':'bg-gray-800/30 border border-gray-700/20'} cursor-pointer hover:scale-[1.02] transition-all" onclick="showModule('supply')">
            <p class="text-[10px] text-gray-500">Ihale/Teklif</p>
            <p class="text-xl font-bold ${pendingTender>0?'text-purple-400':'text-gray-600'}">${pendingTender}</p>
            <p class="text-[9px] ${pendingTender>0?'text-purple-400':'text-gray-600'}">${pendingTender>0?'Degerlendirmede':'Temiz'}</p>
        </div>
        <div class="p-3 rounded-xl ${pendingProject>0?'bg-blue-500/5 border border-blue-500/20':'bg-gray-800/30 border border-gray-700/20'} cursor-pointer hover:scale-[1.02] transition-all" onclick="showModule('build')">
            <p class="text-[10px] text-gray-500">Proje Onay</p>
            <p class="text-xl font-bold ${pendingProject>0?'text-blue-400':'text-gray-600'}">${pendingProject}</p>
            <p class="text-[9px] ${pendingProject>0?'text-blue-400':'text-gray-600'}">${pendingProject>0?'Beklemede':'Temiz'}</p>
        </div>
        <div class="p-3 rounded-xl ${(pendingDelete+pendingTransfer)>0?'bg-red-500/5 border border-red-500/20':'bg-gray-800/30 border border-gray-700/20'} cursor-pointer hover:scale-[1.02] transition-all" onclick="showModule('depo')">
            <p class="text-[10px] text-gray-500">Silme/Transfer</p>
            <p class="text-xl font-bold ${(pendingDelete+pendingTransfer)>0?'text-red-400':'text-gray-600'}">${pendingDelete+pendingTransfer}</p>
            <p class="text-[9px] ${(pendingDelete+pendingTransfer)>0?'text-red-400':'text-gray-600'}">${pendingDelete>0?pendingDelete+' silme talebi':''}${pendingTransfer>0?(pendingDelete>0?' + ':'')+pendingTransfer+' transfer':''}${(pendingDelete+pendingTransfer)===0?'Temiz':''}</p>
        </div>`;

    // --- Sistem Sagligi ---
    const totalUsers=S.users.length;
    const activeUsers=S.users.filter(u=>u.active!==false).length;
    const totalPersonel=(S.personeller||[]).length;
    const aktifPersonel=(S.personeller||[]).filter(p=>p.durum==='aktif').length;
    const totalProje=S.projects.length;
    const totalSatis=S.sales.length;
    const totalEnvanter=(S.envanter||[]).reduce((s,e)=>s+1,0);
    const totalBelge=(S.personelBelgeler||[]).length;
    const logCount=(S.activities||[]).length;
    const storageUsed=new Blob([JSON.stringify(S)]).size;
    const storageMB=(storageUsed/1024/1024).toFixed(2);

    const healthEl=document.getElementById('admin-system-health');
    if(healthEl) healthEl.innerHTML=`
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Kullanicilar</p><p class="text-sm font-bold text-blue-400">${activeUsers}/${totalUsers}</p></div>
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Personel</p><p class="text-sm font-bold text-teal-400">${aktifPersonel}/${totalPersonel}</p></div>
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Projeler</p><p class="text-sm font-bold text-purple-400">${totalProje}</p></div>
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Satislar</p><p class="text-sm font-bold text-green-400">${totalSatis}</p></div>
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Aktivite Log</p><p class="text-sm font-bold text-amber-400">${logCount}</p></div>
        <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Veri</p><p class="text-sm font-bold ${parseFloat(storageMB)>4?'text-red-400':'text-gray-400'}">${storageMB}MB</p></div>`;
}

function openAdminLog(){
    const logs=(S.activities||[]).slice().reverse();
    const sysLogs=(S.sistemKullanimLog||[]).slice(-50).reverse();
    let html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[85vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Sistem Aktivite Logu</h3>
            <button onclick="closeModal('modal-admin-log')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <div class="flex gap-2 mb-4">
            <button onclick="document.getElementById('admin-log-aktivite').style.display='block';document.getElementById('admin-log-sistem').style.display='none';this.classList.add('active');this.nextElementSibling.classList.remove('active')" class="tab-btn active">Aktiviteler (${logs.length})</button>
            <button onclick="document.getElementById('admin-log-sistem').style.display='block';document.getElementById('admin-log-aktivite').style.display='none';this.classList.add('active');this.previousElementSibling.classList.remove('active')" class="tab-btn">Sistem Kullanim (${sysLogs.length})</button>
        </div>
        <div id="admin-log-aktivite" class="space-y-1.5 max-h-[60vh] overflow-y-auto">
            ${logs.length?logs.map(a=>`<div class="flex items-start gap-2 p-2 rounded-lg bg-gray-800/30 text-xs">
                <span class="text-[9px] text-gray-600 whitespace-nowrap mt-0.5">${a.time||''}</span>
                <span class="text-gray-300">${a.text||a}</span>
            </div>`).join(''):'<p class="text-gray-500 text-sm">Log bos.</p>'}
        </div>
        <div id="admin-log-sistem" class="space-y-1.5 max-h-[60vh] overflow-y-auto" style="display:none">
            ${sysLogs.length?sysLogs.map(l=>`<div class="flex items-start gap-2 p-2 rounded-lg bg-gray-800/30 text-xs">
                <span class="text-[9px] text-gray-600 whitespace-nowrap mt-0.5">${l.tarih||''}</span>
                <span class="text-gray-400">${l.kullanici||''}</span>
                <span class="text-gray-300">${l.islem||l.modul||''}</span>
            </div>`).join(''):'<p class="text-gray-500 text-sm">Log bos.</p>'}
        </div>
    </div>`;
    let modal=document.getElementById('modal-admin-log');
    if(!modal){modal=document.createElement('div');modal.id='modal-admin-log';modal.className='modal';document.body.appendChild(modal);}
    modal.innerHTML=html;modal.style.display='';modal.classList.add('active');
}

function openAdminDataPanel(){
    const storageUsed=new Blob([JSON.stringify(S)]).size;
    const storageMB=(storageUsed/1024/1024).toFixed(2);
    const totalRecords=S.projects.length+S.tenders.length+S.sales.length+(S.personeller||[]).length+(S.envanter||[]).length+(S.izinler||[]).length;
    const ds=getDataStatus();
    const lastSavedStr=ds.lastSaved?new Date(ds.lastSaved).toLocaleString('tr-TR'):'Bilinmiyor';
    const backupStr=ds.backupTime?new Date(ds.backupTime).toLocaleString('tr-TR'):'Yedek yok';
    let html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[85vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Veri Yonetimi</h3>
            <button onclick="closeModal('modal-admin-data')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <div class="space-y-3">
            <div class="p-4 rounded-xl bg-green-500/5 border border-green-500/20">
                <h4 class="text-xs font-semibold text-green-400 mb-2">üíæ Veri Durumu</h4>
                <div class="grid grid-cols-2 gap-2 text-[11px]">
                    <div><span class="text-gray-500">Son Kayit:</span> <span class="text-green-300">${lastSavedStr}</span></div>
                    <div><span class="text-gray-500">Oto Yedek:</span> <span class="text-blue-300">${backupStr}</span></div>
                    <div><span class="text-gray-500">Boyut:</span> <span class="text-gray-300">${ds.sizeKB} KB</span></div>
                    <div><span class="text-gray-500">Depo:</span> <span class="text-amber-300">Tarayici (localStorage)</span></div>
                </div>
                <p class="text-[9px] text-gray-500 mt-2">‚ö†Ô∏è Veriler bu tarayicida saklanir. Tarayici cache temizlenirse veriler silinir. Duzenli yedek alin!</p>
            </div>
            <div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
                <h4 class="text-xs font-semibold text-gray-400 mb-2">Depolama</h4>
                <div class="flex items-center justify-between mb-1"><span class="text-sm">${storageMB} MB</span><span class="text-xs text-gray-500">/ 5 MB (localStorage)</span></div>
                <div class="w-full h-2 rounded-full bg-gray-700"><div class="h-full rounded-full ${parseFloat(storageMB)>4?'bg-red-500':parseFloat(storageMB)>2?'bg-amber-500':'bg-green-500'}" style="width:${Math.min(100,(parseFloat(storageMB)/5*100))}%"></div></div>
                <p class="text-[10px] text-gray-600 mt-1">${totalRecords} toplam kayit</p>
            </div>
            <div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
                <h4 class="text-xs font-semibold text-gray-400 mb-3">Veri Islemleri</h4>
                <div class="space-y-2">
                    <button onclick="adminExportAllData()" class="w-full p-2.5 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/20 text-left transition-all">
                        <p class="text-xs font-medium text-blue-400">üì• Tum Veriyi Disa Aktar (JSON)</p>
                        <p class="text-[10px] text-gray-500">Yedekleme icin tum sistemi indir</p>
                    </button>
                    <button onclick="document.getElementById('admin-import-input').click()" class="w-full p-2.5 rounded-lg bg-teal-600/10 hover:bg-teal-600/20 border border-teal-500/20 text-left transition-all">
                        <p class="text-xs font-medium text-teal-400">üì§ Veri Yukle (JSON)</p>
                        <p class="text-[10px] text-gray-500">Onceden kaydedilmis veriyi geri yukle</p>
                    </button>
                    <input type="file" id="admin-import-input" accept=".json" style="display:none" onchange="adminImportData(this)">
                    <button onclick="if(confirm('DIKKAT: Tum veriler silinecek ve sifirlanacak! Devam?'))if(confirm('Bu islem geri alinamaz. Emin misiniz?')){localStorage.removeItem('faonsist_v4');location.reload();}" class="w-full p-2.5 rounded-lg bg-red-600/10 hover:bg-red-600/20 border border-red-500/20 text-left transition-all">
                        <p class="text-xs font-medium text-red-400">üóëÔ∏è Fabrika Ayarlarina Don</p>
                        <p class="text-[10px] text-gray-500">Tum verileri sil ve sifirla</p>
                    </button>
                </div>
            </div>
            <div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
                <h4 class="text-xs font-semibold text-gray-400 mb-2">Kayit Dagilimi</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500">Projeler</span><span class="font-medium">${S.projects.length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Ihaleler</span><span class="font-medium">${S.tenders.length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Satislar</span><span class="font-medium">${S.sales.length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Personel</span><span class="font-medium">${(S.personeller||[]).length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Envanter</span><span class="font-medium">${(S.envanter||[]).length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Izinler</span><span class="font-medium">${(S.izinler||[]).length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Zimmetler</span><span class="font-medium">${(S.zimmetler||[]).length}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Kullanicilar</span><span class="font-medium">${S.users.length}</span></div>
                </div>
            </div>
        </div>
    </div>`;
    let modal=document.getElementById('modal-admin-data');
    if(!modal){modal=document.createElement('div');modal.id='modal-admin-data';modal.className='modal';document.body.appendChild(modal);}
    modal.innerHTML=html;modal.style.display='';modal.classList.add('active');
}

function adminExportAllData(){
    const data=JSON.stringify(S,null,2);
    const blob=new Blob([data],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='faonsist-backup-'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    showNotif('Veri yedegi indirildi.');act('Sistem yedegi alinmistir.');
}

function adminImportData(input){
    const file=input.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
        try{
            const imported=JSON.parse(e.target.result);
            if(!imported.projects&&!imported.users){showNotif('Gecersiz veri dosyasi!');return;}
            if(!confirm('Mevcut veriler yeni veriyle degistirilecek. Devam?'))return;
            Object.assign(S,imported);
            save();
            showNotif('Veri basariyla yuklendi. Sayfa yenileniyor...');
            act('Veri iceri aktarma yapildi.');
            setTimeout(()=>location.reload(),1500);
        }catch(err){showNotif('Dosya okunamadi: '+err.message);}
    };
    reader.readAsText(file);
    input.value='';
}

function renderDashModuleWidgets(){
    const cont=document.getElementById('dash-module-widgets');
    if(!cont){
        // Widget container'i dinamik olustur
        const parent=document.querySelector('#module-dashboard .space-y-6')||document.getElementById('module-dashboard');
        if(!parent)return;
        const widgetRow=document.createElement('div');
        widgetRow.id='dash-module-widgets';
        widgetRow.className='grid grid-cols-3 gap-4 mb-6';
        widgetRow.innerHTML=`
            <div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-teal-400">IK Ozeti</h4><span class="text-lg">&#128101;</span></div><div id="dash-hr-widget" class="text-xs text-gray-400">Veri yok</div></div>
            <div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-amber-400">Depo Ozeti</h4><span class="text-lg">&#128230;</span></div><div id="dash-depo-widget" class="text-xs text-gray-400">Veri yok</div></div>
            <div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-2"><h4 class="text-xs font-semibold text-cyan-400">Satin Alma Ozeti</h4><span class="text-lg">&#128722;</span></div><div id="dash-supply-widget" class="text-xs text-gray-400">Veri yok</div></div>`;
        // Insert after ERP widgets row
        const erpRow=document.getElementById('dash-erp-widgets');
        if(erpRow&&erpRow.parentNode){erpRow.parentNode.insertBefore(widgetRow,erpRow.nextSibling);}
        else{parent.appendChild(widgetRow);}
    }
    // HR Widget
    const hrEl=document.getElementById('dash-hr-widget');
    if(hrEl){
        const personeller=S.personeller||[];const aktif=personeller.filter(p=>p.durum==='aktif').length;
        const buAy=new Date().toISOString().slice(0,7);
        const buAyGiren=personeller.filter(p=>p.iseGirisTarihi&&p.iseGirisTarihi.startsWith(buAy)).length;
        const buAyAyrilan=personeller.filter(p=>p.durum==='ayrilmis'&&p.ayrilmaTarihi&&p.ayrilmaTarihi.startsWith(buAy)).length;
        if(personeller.length>0){hrEl.innerHTML=`<p><span class="font-bold text-teal-400">${personeller.length}</span> personel <span class="text-green-400">(${aktif} aktif)</span></p>`+(buAyGiren>0?`<p class="text-green-400">+${buAyGiren} yeni bu ay</p>`:'')+(buAyAyrilan>0?`<p class="text-red-400">-${buAyAyrilan} ayrilan bu ay</p>`:'')+`<p class="text-[10px] text-blue-400 cursor-pointer mt-1" onclick="showModule('hr')">Detay &#8594;</p>`;}
        else{hrEl.innerHTML='<p class="text-gray-500">Personel kaydi yok</p>';}
    }
    // Depo Widget
    const depoEl=document.getElementById('dash-depo-widget');
    if(depoEl){
        const items=S.envanter||[];const totalVal=items.reduce((s,i)=>s+i.miktar*(i.birimFiyat||0),0);
        const lowStock=items.filter(i=>i.minStok>0&&i.miktar<=i.minStok).length;
        const bekleyenT=(S.depoHareketler||[]).filter(h=>h.durum==='talep').length;
        if(items.length>0){depoEl.innerHTML=`<p>Deger: <span class="font-bold text-amber-400">${fmt(totalVal)} TL</span></p>`+(lowStock>0?`<p class="text-red-400 font-bold">${lowStock} dusuk stok</p>`:'<p class="text-green-400">Stoklar yeterli</p>')+(bekleyenT>0?`<p class="text-amber-400">${bekleyenT} bekleyen talep</p>`:'')+`<p class="text-[10px] text-blue-400 cursor-pointer mt-1" onclick="showModule('depo')">Detay &#8594;</p>`;}
        else{depoEl.innerHTML='<p class="text-gray-500">Envanter kaydi yok</p>';}
    }
    // Supply Widget
    const supEl=document.getElementById('dash-supply-widget');
    if(supEl){
        const talepler=S.satinalmaTalepleri||[];const siparisler=S.orders||[];
        const bekleyenTalep=talepler.filter(t=>t.durum==='onayBekliyor').length;
        const acikSiparis=siparisler.filter(o=>o.durum!=='tamamlandi'&&o.durum!=='iptal').length;
        const buAy=new Date().toISOString().slice(0,7);
        const buAyTeslim=siparisler.filter(o=>(o.teslimatlar||[]).some(t=>t.tarih&&t.tarih.startsWith(buAy))).length;
        supEl.innerHTML=(bekleyenTalep>0?`<p class="text-amber-400">${bekleyenTalep} bekleyen talep</p>`:'')+`<p><span class="font-bold text-cyan-400">${acikSiparis}</span> acik siparis</p>`+(buAyTeslim>0?`<p class="text-green-400">${buAyTeslim} bu ay teslim</p>`:'')+`<p class="text-[10px] text-blue-400 cursor-pointer mt-1" onclick="showModule('supply')">Detay &#8594;</p>`;
    }
}

function renderDashChart(){
    const c=document.getElementById('dash-chart');
    if(!c)return;
    const months=['Oca','Sub','Mar','Nis','May','Haz'];
    const rev=S.sales.reduce((s,x)=>s+x.price,0)||1000000;
    const cost=S.tenders.filter(t=>t.status==='approved').reduce((s,t)=>s+t.amount,0)||600000;
    let html='';
    months.forEach((m,i)=>{
        const rH=Math.max(15,Math.random()*80+20);
        const cH=Math.max(10,rH*0.6+Math.random()*20);
        html+=`<div class="flex-1 flex flex-col items-center gap-1">
            <div class="w-full flex gap-0.5 items-end justify-center" style="height:120px">
                <div class="chart-bar bg-blue-500 w-3" style="height:${rH}%"></div>
                <div class="chart-bar bg-purple-500 w-3" style="height:${cH}%"></div>
            </div>
            <span class="text-[10px] text-gray-500">${m}</span>
        </div>`;
    });
    c.innerHTML=html;
}

function renderDashStatus(){
    const c=document.getElementById('dash-status-summary');
    if(!c)return;
    const statuses=['pending','reviewing','approved','rejected'];
    const colors={pending:'orange',reviewing:'blue',approved:'green',rejected:'red'};
    let html='';
    statuses.forEach(st=>{
        const cnt=S.projects.filter(p=>p.status===st).length;
        html+=`<div class="flex items-center justify-between">
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-${colors[st]}-400"></div><span class="text-xs text-gray-300">${stName(st)}</span></div>
            <span class="text-xs font-semibold">${cnt}</span>
        </div>`;
    });
    if(S.projects.length===0)html='<p class="text-xs text-gray-500">Proje ekleyin.</p>';
    c.innerHTML=html;
}

// ===================== ACTIVITIES =====================
function renderActivities(){
    const c=document.getElementById('activity-list');
    if(S.activities.length===0){c.innerHTML='<p class="text-gray-500 text-xs">Henuz aktivite yok.</p>';return;}
    c.innerHTML=S.activities.map(a=>`<div class="flex items-start gap-2 p-2 rounded-lg bg-gray-800/20"><svg class="w-3.5 h-3.5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 6v6l4 2"/></svg><div class="flex-1 min-w-0"><p class="text-xs truncate">${a.text}</p><p class="text-[10px] text-gray-600">${a.time}</p></div></div>`).join('');
}

// ===================== BADGES =====================
function updateBadges(){
    document.getElementById('build-badge').textContent=S.projects.length;
    const bekleyenTalep=(S.satinalmaTalepleri||[]).filter(t=>t.durum==='onayBekliyor').length;
    const bekleyenIhale=S.tenders.filter(t=>t.status==='pending'||t.status==='reviewing').length;
    document.getElementById('supply-badge').textContent=bekleyenTalep+bekleyenIhale;
    document.getElementById('sales-badge').textContent=S.sales.length;
    bildirimSayisiGuncelle();
}

// ===================== CONNECT =====================
function renderChannels(){
    const c=document.getElementById('channel-list');
    c.innerHTML=S.channels.map(ch=>`<div onclick="selectChannel('${ch.id}')" class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-colors ${S.currentChannel===ch.id?'bg-blue-500/10 text-blue-400':'hover:bg-gray-800/30 text-gray-400'}">
        <span class="text-sm">#</span><span class="text-xs flex-1">${ch.name}</span>
        ${(S.messages[ch.id]||[]).length>0?`<span class="text-[9px] bg-gray-700 px-1.5 py-0.5 rounded-full">${(S.messages[ch.id]||[]).length}</span>`:''}
    </div>`).join('');
    renderMessages();
}
function selectChannel(id){
    if(socket&&socket.connected){
        socket.emit('channel:leave',{channelId:S.currentChannel});
        socket.emit('channel:join',{channelId:id});
    }
    S.currentChannel=id;
    typingUsers.clear();
    const ti=document.getElementById('typing-indicator');
    if(ti)ti.classList.add('hidden');
    renderChannels();
}
function getDateLabel(dateStr){
    if(!dateStr)return '';
    const d=new Date(dateStr);
    const now=new Date();
    const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const msgDay=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    const diff=Math.floor((today-msgDay)/(1000*60*60*24));
    if(diff===0)return 'Bugun';
    if(diff===1)return 'Dun';
    const days=['Pazar','Pazartesi','Sali','Carsamba','Persembe','Cuma','Cumartesi'];
    if(diff<7)return days[d.getDay()];
    return d.toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'});
}
function renderMessages(){
    const c=document.getElementById('chat-messages');
    const ch=S.channels.find(x=>x.id===S.currentChannel);
    document.getElementById('chat-header-name').textContent='# '+(ch?ch.name:'');
    const memberCount=ch?(ch.memberList?ch.memberList.length:ch.members):0;
    document.getElementById('chat-header-info').querySelector('span').textContent=memberCount+' uye';
    const msgs=S.messages[S.currentChannel]||[];
    if(msgs.length===0){
        c.innerHTML='<p class="text-center text-gray-500 text-xs py-8">Henuz mesaj yok. Ilk mesaji siz gonderin!</p>';
        return;
    }
    let prevUser='';
    let prevDate='';
    let html='';
    msgs.forEach((m,i)=>{
        // Date separator
        const msgDate=m.createdAt||'';
        const dateLabel=getDateLabel(msgDate);
        if(dateLabel&&dateLabel!==prevDate){
            html+='<div class="msg-date-sep"><span>'+dateLabel+'</span></div>';
            prevDate=dateLabel;
            prevUser=''; // Reset grouping after date change
        }
        const sameUser=(m.user===prevUser);
        prevUser=m.user;
        const initials=(m.user||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
        const replyHtml=m.replyTo?'<div class="text-[11px] bg-gray-700/30 rounded px-2 py-1 mb-1.5 border-l-2 border-blue-500 cursor-pointer" onclick="scrollToMessage('+m.replyTo.id+')" style="max-width:320px"><span class="text-blue-400 font-semibold">'+m.replyTo.user+'</span> <span class="text-gray-400">'+((m.replyTo.text||'').substring(0,80))+'</span></div>':'';
        const reactionsHtml=renderReactions(m);
        const readHtml=m.mine?renderReadReceipt(m):'';
        const filePreviewHtml=renderChatFilePreview(m)||'';
        const rawText=m.text||'';
        const processedText=m.isFile&&m.fileData?renderMentions(rawText):renderMentions(rawText);
        const urlPreviewHtml=(!m.isFile&&!m.fileData)?renderUrlPreviews(rawText):'';
        const editedBadge=m.edited?'<span class="text-[9px] text-gray-600 ml-1">(duzenlendi)</span>':'';
        const actionBar='<div class="absolute -top-3 '+(m.mine?'left-0':'right-2')+' hidden group-hover:flex gap-0.5 bg-gray-800 border border-gray-700 rounded-lg p-0.5 shadow-lg z-10"><button onclick="startReply('+m.id+')" class="w-6 h-6 rounded hover:bg-gray-700 text-[10px] text-gray-400 hover:text-white flex items-center justify-center" title="Yanitla">&#8617;</button><button onclick="toggleReactionPicker('+m.id+')" class="w-6 h-6 rounded hover:bg-gray-700 text-[10px] text-gray-400 hover:text-white flex items-center justify-center" title="Tepki Ekle">&#128522;</button>'+(m.mine?'<button onclick="editMessage('+m.id+')" class="w-6 h-6 rounded hover:bg-gray-700 text-[10px] text-gray-400 hover:text-white flex items-center justify-center" title="Duzenle">&#9998;</button><button onclick="confirmDelete(\'message\','+m.id+')" class="w-6 h-6 rounded hover:bg-gray-700 text-[10px] text-gray-400 hover:text-red-400 flex items-center justify-center" title="Sil">&times;</button>':'')+'</div>';
        // Build content block: text + file preview + url preview
        const contentBlock=(processedText?'<div class="text-[13px] leading-relaxed '+(m.mine?'text-gray-100':'text-gray-200')+' break-words">'+processedText+'</div>':'')+filePreviewHtml+urlPreviewHtml;

        if(m.mine){
            // === OWN MESSAGE: right-aligned, minimal blue bg ===
            const timeRow=sameUser?'':'<div class="flex items-center justify-end gap-2 mb-0.5"><span class="text-[10px] text-gray-500">'+m.time+'</span>'+editedBadge+readHtml+'<span class="text-[12px] font-semibold text-emerald-400">Sen</span></div>';
            const hoverTime=sameUser?'<span class="text-[9px] text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity">'+m.time+' '+readHtml+'</span>':'';
            html+='<div class="msg-item msg-row-mine group relative flex justify-end'+(sameUser?' pt-0.5':' pt-3')+'" data-msg-id="'+m.id+'">'+actionBar+'<div class="msg-mine-block relative" style="max-width:420px">'+timeRow+replyHtml+contentBlock+(sameUser?'<div class="flex justify-end mt-0.5">'+hoverTime+'</div>':'')+reactionsHtml+'</div></div>';
        } else {
            // === OTHER MESSAGE: left-aligned, avatar + name ===
            const avatarHtml=sameUser?'<div style="width:32px;flex-shrink:0"></div>':'<div class="msg-avatar">'+initials+'</div>';
            const nameTimeHtml=sameUser?'':'<div class="flex items-center gap-2 mb-0.5"><span class="text-[12px] font-semibold text-blue-400">'+m.user+'</span><span class="text-[10px] text-gray-500">'+m.time+'</span>'+editedBadge+'</div>';
            const hoverTime=sameUser?'<span class="text-[9px] text-gray-600 opacity-0 group-hover:opacity-100 absolute -left-10 top-0.5 transition-opacity">'+m.time+'</span>':'';
            html+='<div class="msg-item group relative flex gap-3 items-start'+(sameUser?' pt-0.5':' pt-3')+'" data-msg-id="'+m.id+'">'+avatarHtml+'<div class="msg-other-block flex-1 min-w-0 relative" style="max-width:420px">'+nameTimeHtml+hoverTime+replyHtml+contentBlock+reactionsHtml+'</div>'+actionBar+'</div>';
        }
    });
    c.innerHTML=html;
    c.scrollTop=c.scrollHeight;
    markMessagesRead();
}
function sendMessage(){
    const inp=document.getElementById('msg-input');
    const txt=inp.value.trim();
    if(!txt)return;
    if(!S.messages[S.currentChannel])S.messages[S.currentChannel]=[];
    const userName=currentUser?currentUser.name:'Bilinmeyen';
    const msgId=Date.now();
    const msg={
        id:msgId,
        user:userName,
        text:txt,
        time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),
        mine:true,
        replyTo:replyToMsg||null,
        reactions:{},
        readBy:[currentUser?currentUser.id:'']
    };
    S.messages[S.currentChannel].push(msg);
    // Socket broadcast
    if(socket&&socket.connected){
        socket.emit('message:send',{channelId:S.currentChannel,text:txt,id:msgId,replyTo:replyToMsg||null});
        // Check for @mentions
        const mentions=txt.match(/@(\S+)/g);
        if(mentions){
            const mentionedIds=mentions.map(m=>m.slice(1)).map(name=>S.users.find(u=>u.name===name)).filter(Boolean).map(u=>u.id);
            if(mentionedIds.length>0)socket.emit('mention:notify',{channelId:S.currentChannel,messageId:msgId,mentionedUserIds:mentionedIds});
        }
    }
    inp.value='';
    cancelReply();
    hideMentionDropdown();
    if(isTyping&&socket){isTyping=false;socket.emit('typing:stop',{channelId:S.currentChannel});}
    save();
    renderMessages();
    const ch=S.channels.find(x=>x.id===S.currentChannel);
    if(ch)document.getElementById('connect-badge').textContent=(S.messages[S.currentChannel]||[]).length;
}

// ===================== BUILD - PROJECTS =====================
function renderProjects(){
    const c=document.getElementById('projects-list');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Henuz proje eklenmedi.</p>';renderHakedis();renderTimeline();return;}
    c.innerHTML=S.projects.map(p=>{
        const pctColor=p.completion>=80?'bg-green-500':p.completion>=50?'bg-blue-500':p.completion>=25?'bg-yellow-500':'bg-red-500';
        const ptc=PT_COLORS[p.projectType]||'bg-gray-500/20 text-gray-400';
        const ptl=(PROJECT_TYPES.find(t=>t.v===p.projectType)||{l:'-'}).l;
        const taseronCount=(p.taseronlar||[]).length;
        const ikCount=(p.isKalemleri||[]).length;
        const hkCount=(p.hakedisler||[]).length;
        const dateRange=p.startDate&&p.endDate?`${p.startDate} ‚Üí ${p.endDate}`:'';
        return `<div class="glass rounded-xl p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
            <div class="min-w-0"><div class="flex items-center gap-2 mb-1 flex-wrap"><h4 class="font-bold text-sm sm:text-base">${p.name}</h4><span class="px-2 py-0.5 rounded text-[9px] font-semibold ${ptc}">${ptl}</span></div><p class="text-[11px] sm:text-xs text-gray-400 break-words">Muteahhit: ${p.contractor} | PM: ${p.manager}${p.location?' | üìç '+p.location:''}</p>${dateRange?`<p class="text-[10px] text-gray-500 mt-0.5">üìÖ ${dateRange}</p>`:''}</div>
            <div class="flex items-center gap-2 flex-shrink-0"><button onclick="openEditProject(${p.id})" class="text-gray-500 hover:text-blue-400 text-xs">Duzenle</button><button onclick="openProjectDetail(${p.id})" class="px-2 py-1 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">Detay</button><span class="status-${p.status}">${stName(p.status)}</span><button onclick="deleteItem('project',${p.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button></div>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-3">
            <div><p class="text-[10px] text-gray-500">Sozlesme</p><p class="text-sm font-bold text-blue-400">\u20BA${fmt(p.contractAmount||p.budget)}</p></div>
            <div><p class="text-[10px] text-gray-500">Butce</p><p class="text-sm font-bold text-purple-400">\u20BA${fmt(p.budget)}</p></div>
            <div><p class="text-[10px] text-gray-500">Harcanan</p><p class="text-sm font-bold text-orange-400">\u20BA${fmt(p.spent)}</p></div>
            <div><p class="text-[10px] text-gray-500">Tamamlanma</p><p class="text-sm font-bold text-green-400">%${p.completion}</p></div>
        </div>
        <div class="progress-bar mb-3"><div class="progress-fill ${pctColor}" style="width:${p.completion}%"></div></div>
        <div class="flex gap-3 mb-3 text-[10px] text-gray-500">
            <span>üë∑ ${taseronCount} Taseron</span><span>üìã ${ikCount} Is Kalemi</span><span>üìÑ ${hkCount} Hakedis</span><span>‚úÖ ${(p.tasks||[]).filter(t=>t.done).length}/${(p.tasks||[]).length} Gorev</span>
        </div>
        ${p.notes?`<p class="text-[11px] text-gray-500 mb-3">${p.notes}</p>`:''}
        <div class="flex gap-2 flex-wrap">
            ${p.status==='pending'?`<button onclick="updateStatus('project',${p.id},'reviewing')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">Kontrole Gonder</button>`:''}
            ${p.status==='reviewing'?`<button onclick="updateStatus('project',${p.id},'approved')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">Onayla</button><button onclick="updateStatus('project',${p.id},'rejected')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">Reddet</button>`:''}
            <button onclick="openTaseronForm(${p.id})" class="px-3 py-1.5 bg-amber-600/20 text-amber-400 hover:bg-amber-600/40 rounded text-xs">+ Taseron</button>
            <button onclick="openIsKalemiForm(${p.id})" class="px-3 py-1.5 bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/40 rounded text-xs">+ Is Kalemi</button>
            <button onclick="openAddExpense(${p.id})" class="px-3 py-1.5 bg-purple-600/20 text-purple-400 hover:bg-purple-600/40 rounded text-xs">+ Harcama</button>
            <button onclick="openTaskPanel(${p.id})" class="px-3 py-1.5 bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600/40 rounded text-xs">Gorevler (${(p.tasks||[]).length})</button>
        </div></div>`;
    }).join('');
    renderHakedis();renderTimeline();
}

const ALL_BUILD_TABS=['list','isKalemleri','hakedis','taseronlar','timeline','gunluk','yesilDefter','ekipman','sozlesme','nakitAkisi','metraj','isg','kaliteKontrol','yazisma','isProgrami','malzemeStok'];
const MAIN_TABS=['list','isKalemleri','hakedis','taseronlar','timeline','gunluk'];
const GROUP_MAP={sahadan:['yesilDefter','ekipman'],finans:['sozlesme','nakitAkisi','metraj'],kalite:['isg','kaliteKontrol'],yonetim:['yazisma','isProgrami','malzemeStok']};
const TAB_RENDERERS={timeline:'renderGantt',isKalemleri:'renderIsKalemleriTab',taseronlar:'renderTaseronlarTab',hakedis:'renderHakedisTab',gunluk:'renderGunlukTab',yesilDefter:'renderYesilDefterTab',ekipman:'renderEkipmanTab',sozlesme:'renderSozlesmeTab',nakitAkisi:'renderNakitAkisiTab',metraj:'renderMetrajTab',isg:'renderIsgTab',kaliteKontrol:'renderKaliteKontrolTab',yazisma:'renderYazismaTab',isProgrami:'renderIsProgramiTab',malzemeStok:'renderMalzemeStokTab'};

function switchBuildTab(tab){
    ALL_BUILD_TABS.forEach(t=>{const el=document.getElementById('build-tab-'+t);if(el)el.classList.toggle('hidden',t!==tab);});
    // Update main tab buttons
    const mainBtns=document.querySelectorAll('#build-tabs .tab-btn:not(.group-btn)');
    mainBtns.forEach(b=>{const t=b.getAttribute('onclick')?.match(/switchBuildTab\('(\w+)'\)/);if(t)b.classList.toggle('active',t[1]===tab);});
    // Update subtab buttons
    document.querySelectorAll('.subtab-btn').forEach(b=>{const t=b.getAttribute('onclick')?.match(/switchBuildTab\('(\w+)'\)/);if(t)b.classList.toggle('active',t[1]===tab);});
    // Update group btn active state
    document.querySelectorAll('.group-btn').forEach(b=>{const g=b.getAttribute('onclick')?.match(/toggleBuildGroup\('(\w+)'\)/);if(g){const grpTabs=GROUP_MAP[g[1]]||[];b.classList.toggle('active',grpTabs.includes(tab));}});
    // Call renderer
    const fn=TAB_RENDERERS[tab];if(fn&&typeof window[fn]==='function')window[fn]();
}

function toggleBuildGroup(group){
    const row=document.getElementById('subtab-'+group);if(!row)return;
    const isOpen=row.classList.contains('active');
    // Close all subtab rows first
    document.querySelectorAll('.subtab-row').forEach(r=>r.classList.remove('active'));
    document.querySelectorAll('.group-btn').forEach(b=>{if(!b.classList.contains('active'))b.classList.remove('active');});
    if(!isOpen){row.classList.add('active');
        // Auto-select first tab in group if not already on one
        const grpTabs=GROUP_MAP[group]||[];
        const currentTab=ALL_BUILD_TABS.find(t=>{const el=document.getElementById('build-tab-'+t);return el&&!el.classList.contains('hidden');});
        if(!grpTabs.includes(currentTab))switchBuildTab(grpTabs[0]);
    }
}

function renderHakedis(){renderHakedisTab();}

function renderTimeline(){renderGantt();}
function renderGantt(){
    const c=document.getElementById('timeline-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    const months=['Oca','Sub','Mar','Nis','May','Haz','Tem','Agu','Eyl','Eki','Kas','Ara'];
    const now=new Date();const curMonth=now.getMonth();
    let html=`<h4 class="text-sm font-semibold mb-4">Gantt Chart - Proje Takvimi</h4>`;
    html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr><th class="text-left p-2 w-40 text-gray-400">Proje</th>`;
    for(let i=0;i<12;i++){const mi=(curMonth-2+i+12)%12;html+=`<th class="p-1 text-center text-gray-500 ${mi===curMonth?'text-blue-400 font-bold':''}" style="min-width:50px">${months[mi]}</th>`;}
    html+=`</tr></thead><tbody>`;
    S.projects.forEach(p=>{
        const color=p.status==='approved'?'#22c55e':p.status==='rejected'?'#ef4444':p.status==='reviewing'?'#3b82f6':'#f97316';
        const startCol=Math.floor(Math.random()*3);
        const barLen=Math.max(2,Math.floor(p.completion/10));
        const filledLen=Math.max(1,Math.floor(barLen*p.completion/100));
        html+=`<tr class="border-t border-gray-800/50"><td class="p-2 font-medium truncate max-w-[160px]">${p.name}</td>`;
        for(let i=0;i<12;i++){
            if(i>=startCol&&i<startCol+barLen){
                const isFilled=i<startCol+filledLen;
                html+=`<td class="p-1"><div class="h-6 rounded ${isFilled?'':'opacity-30'}" style="background:${color}"></div></td>`;
            }else{html+=`<td class="p-1"><div class="h-6 rounded bg-gray-800/20"></div></td>`;}
        }
        html+=`</tr>`;
    });
    html+=`</tbody></table></div>`;
    html+=`<div class="flex items-center gap-4 mt-4 text-[10px] text-gray-400"><span><span class="inline-block w-3 h-3 rounded bg-orange-500 mr-1"></span>Hazirlandi</span><span><span class="inline-block w-3 h-3 rounded bg-blue-500 mr-1"></span>Kontrol</span><span><span class="inline-block w-3 h-3 rounded bg-green-500 mr-1"></span>Onaylandi</span><span><span class="inline-block w-3 h-3 rounded bg-red-500 mr-1"></span>Reddedildi</span><span class="ml-auto">Koyu = tamamlanan, acik = planlanan</span></div>`;
    c.innerHTML=html;
}

// ===================== SUPPLY - IHALELER (REPLACED) =====================
function renderTenders(){renderIhaleler();}
function renderIhaleler(){
    const c=document.getElementById('ihaleler-list');if(!c)return;
    if(S.tenders.length===0){c.innerHTML='<div class="glass rounded-xl p-8 text-center"><p class="text-gray-500 text-sm">Henuz ihale olusturulmadi.</p><button onclick="openIhaleForm()" class="mt-3 px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm transition-colors">Ilk Ihaleyi Olustur</button></div>';return;}
    let html='<div class="grid grid-cols-4 gap-3 mb-4">';
    const counts={pending:0,reviewing:0,approved:0,rejected:0};
    S.tenders.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Bekleyen</p><p class="text-xl font-bold text-gray-400">${counts.pending}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Kontrol</p><p class="text-xl font-bold text-yellow-400">${counts.reviewing}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Onaylandi</p><p class="text-xl font-bold text-green-400">${counts.approved}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Reddedildi</p><p class="text-xl font-bold text-red-400">${counts.rejected}</p></div>`;
    html+='</div>';
    S.tenders.slice().reverse().forEach(t=>{
        const proj=t.projectId?S.projects.find(p=>p.id===t.projectId):null;
        const kalemSayisi=(t.kalemler||[]).length;
        const teklifSayisi=(t.teklifler||[]).length;
        const baslik=t.baslik||t.item||'Ihale';
        const toplamTutar=t.kazananTeklifId?(t.teklifler||[]).find(x=>x.id===t.kazananTeklifId)?.toplamFiyat||t.amount||0:t.amount||0;
        html+=`<div class="glass rounded-xl p-5 mb-3">
            <div class="flex items-start justify-between mb-3">
                <div><h4 class="font-bold text-sm">${t.ihaleNo||''} - ${baslik}</h4>
                <p class="text-[10px] text-gray-500">${proj?proj.name+' | ':''}${ihaleTipiLabel(t.ihaleTipi||'acik')} | ${kalemSayisi||1} kalem</p></div>
                <div class="flex items-center gap-2">
                    ${teklifSayisi>0?`<span class="text-[9px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">${teklifSayisi} teklif</span>`:''}
                    <span class="status-${t.status}">${stName(t.status)}</span>
                    <button onclick="deleteItem('tender',${t.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button>
                </div>
            </div>
            ${kalemSayisi>0?`<div class="mb-3 text-xs"><table class="w-full"><tbody>${(t.kalemler||[]).map(k=>`<tr class="border-t border-gray-800/50"><td class="py-1 text-gray-400">${k.malzeme}</td><td class="py-1 text-right">${k.miktar} ${k.birim}</td></tr>`).join('')}</tbody></table></div>`:`<p class="text-sm text-gray-400 mb-3">${t.item||baslik} ‚Äî ${t.supplier||''}</p>`}
            ${toplamTutar>0?`<p class="text-lg font-bold text-orange-400 mb-3">\u20BA${fmtFull(toplamTutar)}</p>`:''}
            <div class="flex gap-2 flex-wrap">
                <button onclick="openIhaleDetay(${t.id})" class="px-3 py-1.5 bg-gray-600/30 text-gray-300 hover:bg-gray-600/50 rounded text-xs transition-colors">Detay</button>
                ${t.status==='pending'?`<button onclick="updateStatus('tender',${t.id},'reviewing')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">Kontrole Gonder</button>`:''}
                ${t.status==='reviewing'?`<button onclick="updateStatus('tender',${t.id},'approved')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">Onayla</button><button onclick="updateStatus('tender',${t.id},'rejected')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">Reddet</button>`:''}
                <button onclick="openTeklifForm(${t.id})" class="px-3 py-1.5 bg-purple-600/30 text-purple-400 hover:bg-purple-600/50 rounded text-xs transition-colors">Teklif Ekle</button>
                ${t.status==='approved'&&t.kazananTeklifId?`<button onclick="ihaledenSiparisOlustur(${t.id})" class="px-3 py-1.5 bg-green-600/30 text-green-400 hover:bg-green-600/50 rounded text-xs transition-colors">Siparise Donustur</button>`:''}
            </div></div>`;
    });
    c.innerHTML=html;
}

// ===================== IHALE DETAY =====================
function openIhaleDetay(ihaleId){
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    const c=document.getElementById('ihale-detay-content');
    const proj=t.projectId?S.projects.find(p=>p.id===t.projectId):null;
    const teklifler=t.teklifler||[];
    const kalemler=t.kalemler||[];
    let html=`<div class="space-y-4">
        <div class="flex items-center justify-between">
            <div><h3 class="text-lg font-bold">${t.ihaleNo||''} - ${t.baslik||t.item}</h3>
            <p class="text-xs text-gray-500">${proj?proj.name+' | ':''}${ihaleTipiLabel(t.ihaleTipi||'acik')} | <span class="status-${t.status}">${stName(t.status)}</span></p></div>
        </div>`;
    // Kalemler tablosu
    if(kalemler.length>0){
        html+=`<div><h4 class="text-sm font-semibold mb-2">Ihale Kalemleri</h4>
            <table class="w-full text-xs glass rounded-xl overflow-hidden"><thead class="bg-gray-800/50"><tr class="text-left text-gray-400"><th class="p-2">#</th><th class="p-2">Malzeme</th><th class="p-2 text-right">Miktar</th><th class="p-2">Birim</th></tr></thead><tbody>`;
        kalemler.forEach((k,i)=>{html+=`<tr class="border-t border-gray-800"><td class="p-2">${i+1}</td><td class="p-2">${k.malzeme}</td><td class="p-2 text-right">${k.miktar}</td><td class="p-2">${k.birim}</td></tr>`;});
        html+=`</tbody></table></div>`;
    }
    // Teklif kar≈üƒ±la≈ütƒ±rma
    html+=`<div><h4 class="text-sm font-semibold mb-2">Teklifler (${teklifler.length})</h4>`;
    if(teklifler.length===0){
        html+=`<p class="text-xs text-gray-500">Henuz teklif eklenmedi.</p>`;
    }else{
        html+=`<div class="overflow-x-auto"><table class="w-full text-xs glass rounded-xl overflow-hidden"><thead class="bg-gray-800/50"><tr class="text-left text-gray-400"><th class="p-2">Tedarikci</th>`;
        kalemler.forEach((k,i)=>{html+=`<th class="p-2 text-right">${k.malzeme.substring(0,15)}</th>`;});
        html+=`<th class="p-2 text-right">Toplam</th><th class="p-2 text-right">Teslim</th><th class="p-2">Odeme</th><th class="p-2 text-center">Sec</th></tr></thead><tbody>`;
        const enDusuk=teklifler.length>0?Math.min(...teklifler.map(tk=>tk.toplamFiyat||0)):0;
        teklifler.forEach(tk=>{
            const isKazanan=t.kazananTeklifId===tk.id;
            const isEnDusuk=tk.toplamFiyat===enDusuk&&enDusuk>0;
            html+=`<tr class="${isKazanan?'bg-green-500/10':''}border-t border-gray-800">
                <td class="p-2 font-medium">${tk.tedarikciAdi}${isKazanan?' <span class="text-[9px] bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded-full">KAZANAN</span>':''}${isEnDusuk&&!isKazanan?' <span class="text-[9px] bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded-full">EN UYGUN</span>':''}</td>`;
            (tk.birimFiyatlar||[]).forEach(bf=>{html+=`<td class="p-2 text-right">\u20BA${fmtFull(bf)}</td>`;});
            // pad if less prices than kalemler
            for(let i=(tk.birimFiyatlar||[]).length;i<kalemler.length;i++)html+=`<td class="p-2 text-right">-</td>`;
            html+=`<td class="p-2 text-right font-bold ${isEnDusuk?'text-green-400':''}">\u20BA${fmtFull(tk.toplamFiyat||0)}</td>
                <td class="p-2 text-right">${tk.teslimat||'-'} gun</td>
                <td class="p-2">${tk.odemeKosulu||'-'}</td>
                <td class="p-2 text-center">${!isKazanan&&t.status!=='rejected'?`<button onclick="kazananSec(${t.id},${tk.id})" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-[10px]">Sec</button>`:isKazanan?'&#10003;':''}</td></tr>`;
        });
        if(teklifler.length>1){
            const maxFiyat=Math.max(...teklifler.map(tk=>tk.toplamFiyat||0));
            const tasarruf=maxFiyat-enDusuk;
            html+=`<tr class="border-t-2 border-gray-700"><td colspan="${kalemler.length+4}" class="p-2 text-right text-gray-400">Potansiyel Tasarruf:</td><td class="p-2 text-right font-bold text-green-400">\u20BA${fmtFull(tasarruf)}</td></tr>`;
        }
        html+=`</tbody></table></div>`;
    }
    html+=`</div>
        <div class="flex gap-2">
            <button onclick="openTeklifForm(${t.id})" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-colors">Teklif Ekle</button>
            ${t.status==='approved'&&t.kazananTeklifId?`<button onclick="ihaledenSiparisOlustur(${t.id});closeModal('modal-ihale-detay')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-colors">Siparise Donustur</button>`:''}
        </div></div>`;
    c.innerHTML=html;
    openModal('modal-ihale-detay');
}

// ===================== TEKLIF =====================
function openTeklifForm(ihaleId){
    const form=document.querySelector('#modal-teklif form');form.reset();
    document.getElementById('teklif-ihale-id').value=ihaleId;
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    // Tedarik√ßi se√ßici
    const sel=document.getElementById('teklif-tedarikci-select');
    sel.innerHTML='<option value="">Seciniz...</option>';
    (S.tedarikcilerHavuzu||[]).filter(td=>!td.karaListe).forEach(td=>{sel.innerHTML+=`<option value="${td.id}">${td.firma}</option>`;});
    sel.innerHTML+='<option value="diger">Diger (Manuel Giris)</option>';
    // Birim fiyatlar
    const body=document.getElementById('teklif-birimfiyat-body');
    body.innerHTML='';
    const kalemler=t.kalemler||[];
    if(kalemler.length>0){
        kalemler.forEach((k,i)=>{
            const row=document.createElement('tr');row.className='border-t border-gray-800';
            row.innerHTML=`<td class="p-1 text-xs">${k.malzeme}</td><td class="p-1 text-xs text-right">${k.miktar} ${k.birim}</td><td class="p-1"><input name="tf_birimfiyat[]" type="number" step="0.01" class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-right" oninput="hesaplaTeklifToplam()" required></td><td class="p-1 text-xs text-right tf-kalem-toplam">-</td>`;
            body.appendChild(row);
        });
    }else{
        // Legacy ihale (tek kalem)
        const row=document.createElement('tr');row.className='border-t border-gray-800';
        row.innerHTML=`<td class="p-1 text-xs">${t.item||'Malzeme'}</td><td class="p-1 text-xs text-right">1 adet</td><td class="p-1"><input name="tf_birimfiyat[]" type="number" step="0.01" class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-right" oninput="hesaplaTeklifToplam()" required></td><td class="p-1 text-xs text-right tf-kalem-toplam">-</td>`;
        body.appendChild(row);
    }
    openModal('modal-teklif');
}
function hesaplaTeklifToplam(){
    const ihaleId=+document.getElementById('teklif-ihale-id').value;
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    const inputs=document.querySelectorAll('#teklif-birimfiyat-body input[name="tf_birimfiyat[]"]');
    const toplamCells=document.querySelectorAll('#teklif-birimfiyat-body .tf-kalem-toplam');
    const kalemler=t.kalemler||[{miktar:1}];
    let genelToplam=0;
    inputs.forEach((inp,i)=>{
        const fiyat=+inp.value||0;
        const miktar=kalemler[i]?kalemler[i].miktar:1;
        const toplam=fiyat*miktar;
        genelToplam+=toplam;
        if(toplamCells[i])toplamCells[i].textContent=toplam>0?'\u20BA'+fmtFull(toplam):'-';
    });
    const totalEl=document.getElementById('teklif-toplam-display');
    if(totalEl)totalEl.textContent='\u20BA'+fmtFull(genelToplam);
}
function addTeklif(e){
    e.preventDefault();const f=new FormData(e.target);
    const ihaleId=+document.getElementById('teklif-ihale-id').value;
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    const tedarikciId=f.get('tedarikciId');
    let tedarikciAdi='';
    if(tedarikciId==='diger'){
        tedarikciAdi=prompt('Tedarikci adi giriniz:')||'Bilinmeyen';
    }else if(tedarikciId){
        const td=S.tedarikcilerHavuzu.find(x=>x.id===+tedarikciId);
        tedarikciAdi=td?td.firma:'';
    }
    if(!tedarikciAdi){showNotif('Tedarikci secilmedi!');return;}
    const birimFiyatlar=f.getAll('tf_birimfiyat[]').map(v=>+v||0);
    const kalemler=t.kalemler||[{miktar:1}];
    let toplamFiyat=0;
    birimFiyatlar.forEach((bf,i)=>{toplamFiyat+=bf*(kalemler[i]?kalemler[i].miktar:1);});
    if(!t.teklifler)t.teklifler=[];
    t.teklifler.push({id:Date.now(),tedarikciId:tedarikciId!=='diger'?+tedarikciId:null,tedarikciAdi,birimFiyatlar,toplamFiyat,teslimat:+f.get('teslimat')||14,odemeKosulu:f.get('odemeKosulu')||'',puan:0,notlar:f.get('notlar')||'',tarih:new Date().toISOString()});
    // Update legacy fields
    if(!t.supplier||t.amount===0){t.supplier=tedarikciAdi;t.amount=toplamFiyat;}
    act('Teklif eklendi: '+tedarikciAdi+' - '+t.baslik);
    save();renderIhaleler();closeModal('modal-teklif');e.target.reset();showNotif('Teklif eklendi!');
}
function kazananSec(ihaleId,teklifId){
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    t.kazananTeklifId=teklifId;
    const kazanan=t.teklifler.find(x=>x.id===teklifId);
    if(kazanan){t.supplier=kazanan.tedarikciAdi;t.amount=kazanan.toplamFiyat;}
    act('Kazanan secildi: '+kazanan?.tedarikciAdi+' - '+(t.ihaleNo||t.item));
    save();openIhaleDetay(ihaleId);showNotif('Kazanan teklif secildi!');
}

function renderCompare(){/* removed - now inside ihale detay */}
function renderSuppliers(){/* removed - now tedarikciler havuzu */}

// ===================== SALES =====================
function renderSales(){
    const c=document.getElementById('sales-list');
    if(S.sales.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Henuz satis kaydi yok.</p>';renderInstallments();return;}
    c.innerHTML=S.sales.map(s=>{
        const paidPct=s.price>0?Math.round(s.paid/s.price*100):0;
        return `<div class="glass rounded-xl p-5">
        <div class="flex items-start justify-between mb-3">
            <div><h4 class="font-bold">${s.customer}</h4><p class="text-xs text-gray-400">${s.product} | ${s.phone||'-'}</p></div>
            <div class="flex items-center gap-2"><button onclick="openEditSale(${s.id})" class="text-gray-500 hover:text-blue-400 text-xs">Duzenle</button><span class="status-${s.status}">${stName(s.status)}</span><button onclick="deleteItem('sale',${s.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button></div>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-3">
            <div><p class="text-[10px] text-gray-500">Toplam</p><p class="text-base font-bold text-green-400">\u20BA${fmt(s.price)}</p></div>
            <div><p class="text-[10px] text-gray-500">Odenen</p><p class="text-base font-bold text-blue-400">\u20BA${fmt(s.paid)}</p></div>
            <div><p class="text-[10px] text-gray-500">Kalan</p><p class="text-base font-bold text-orange-400">\u20BA${fmt(s.price-s.paid)}</p></div>
            <div><p class="text-[10px] text-gray-500">Taksit</p><p class="text-base font-bold">${s.installments} ay</p></div>
        </div>
        <div class="progress-bar mb-3"><div class="progress-fill bg-green-500" style="width:${paidPct}%"></div></div>
        <div class="flex gap-2 flex-wrap">
            ${s.paid<s.price?`<button onclick="payInstallment(${s.id})" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">Taksit Ode</button>`:''}
            <button onclick="openCustomerDetail(${s.id})" class="px-3 py-1.5 bg-blue-600/30 text-blue-400 hover:bg-blue-600/50 rounded text-xs transition-colors">Musteri Detay</button>
            <select onchange="moveSaleStage(${s.id},this.value)" class="bg-gray-800 border border-gray-700 rounded text-xs px-2 py-1">
                ${['lead','meeting','proposal','negotiation','contract'].map(st=>`<option value="${st}" ${s.stage===st?'selected':''}>${stName(st)}</option>`).join('')}
            </select>
        </div></div>`;
    }).join('');
    renderInstallments();
}

function switchSalesTab(tab){
    ['pipeline','list','installments'].forEach(t=>document.getElementById('sales-tab-'+t).classList.toggle('hidden',t!==tab));
    document.querySelectorAll('#sales-tabs .tab-btn').forEach((b,i)=>b.classList.toggle('active',['pipeline','list','installments'][i]===tab));
}

function renderPipeline(){
    const c=document.getElementById('pipeline-board');
    const stages=[{id:'lead',name:'Potansiyel',color:'gray'},{id:'meeting',name:'Gorusme',color:'blue'},{id:'proposal',name:'Teklif',color:'purple'},{id:'negotiation',name:'Muzakere',color:'orange'},{id:'contract',name:'Sozlesme',color:'green'}];
    c.innerHTML=stages.map(st=>{
        const items=S.sales.filter(s=>s.stage===st.id);
        const total=items.reduce((s,x)=>s+x.price,0);
        return `<div class="kanban-col flex-1 min-w-[200px]" ondragover="onDragOverStage(event)" ondragleave="onDragLeaveStage(event)" ondrop="onDropStage(event,'${st.id}')">
            <div class="flex items-center justify-between mb-3 px-1">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-${st.color}-400"></div><span class="text-xs font-semibold">${st.name}</span></div>
                <span class="text-[10px] text-gray-500">${items.length} - \u20BA${fmt(total)}</span>
            </div>
            <div class="space-y-2 min-h-[60px] rounded-lg p-1">${items.length===0?'<div class="text-center py-6 text-[11px] text-gray-600 glass rounded-lg">Bos</div>':items.map(s=>`<div draggable="true" ondragstart="onDragStartSale(event,${s.id})" ondragend="onDragEndSale(event)" class="glass rounded-lg p-3 cursor-grab hover:border-${st.color}-500/30 transition-colors active:cursor-grabbing">
                <p class="text-xs font-semibold mb-1">${s.customer}</p>
                <p class="text-[10px] text-gray-400 mb-2">${s.product}</p>
                <p class="text-sm font-bold text-${st.color}-400">\u20BA${fmt(s.price)}</p>
            </div>`).join('')}</div>
        </div>`;
    }).join('');
}

function renderInstallments(){
    const c=document.getElementById('installments-view');
    const active=S.sales.filter(s=>s.installments>1&&s.paid<s.price);
    if(active.length===0){c.innerHTML='<div class="glass rounded-xl p-6"><p class="text-gray-500 text-sm">Aktif taksit plani yok.</p></div>';return;}
    c.innerHTML=`<div class="space-y-4">${active.map(s=>{
        const perInst=Math.floor(s.price/s.installments);
        const paidCount=Math.floor(s.paid/perInst);
        const remaining=s.installments-paidCount;
        return `<div class="glass rounded-xl p-5"><div class="flex items-center justify-between mb-3"><div><h4 class="font-bold text-sm">${s.customer}</h4><p class="text-[11px] text-gray-400">${s.product}</p></div><button onclick="payInstallment(${s.id})" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">Taksit Ode</button></div>
        <div class="grid grid-cols-4 gap-3 text-xs mb-3"><div><span class="text-gray-500">Taksit Tutari</span><p class="font-semibold">\u20BA${fmtFull(perInst)}</p></div><div><span class="text-gray-500">Odenen</span><p class="font-semibold text-green-400">${paidCount}/${s.installments}</p></div><div><span class="text-gray-500">Kalan</span><p class="font-semibold text-orange-400">${remaining} taksit</p></div><div><span class="text-gray-500">Kalan Tutar</span><p class="font-semibold text-red-400">\u20BA${fmtFull(s.price-s.paid)}</p></div></div>
        <div class="progress-bar"><div class="progress-fill bg-green-500" style="width:${Math.round(s.paid/s.price*100)}%"></div></div></div>`;
    }).join('')}</div>`;
}

// ===================== REPORTS =====================
function renderReports(){
    loadAiReports();
    // Module summary
    const ms=document.getElementById('report-module-summary');
    if(!ms)return;
    const projBudget=S.projects.reduce((s,p)=>s+p.budget,0);
    const tenderTotal=S.tenders.reduce((s,t)=>s+t.amount,0);
    const salesTotal=S.sales.reduce((s,x)=>s+x.price,0);
    const paidTotal=S.sales.reduce((s,x)=>s+x.paid,0);
    ms.innerHTML=`
        <div class="flex justify-between text-xs"><span class="text-gray-400">Projeler</span><span class="font-semibold">${S.projects.length} adet - \u20BA${fmt(projBudget)}</span></div>
        <div class="flex justify-between text-xs"><span class="text-gray-400">Ihaleler</span><span class="font-semibold">${S.tenders.length} adet - \u20BA${fmt(tenderTotal)}</span></div>
        <div class="flex justify-between text-xs"><span class="text-gray-400">Satislar</span><span class="font-semibold">${S.sales.length} adet - \u20BA${fmt(salesTotal)}</span></div>
        <div class="flex justify-between text-xs"><span class="text-gray-400">Tahsilat</span><span class="font-semibold text-green-400">\u20BA${fmt(paidTotal)}</span></div>
        <div class="flex justify-between text-xs"><span class="text-gray-400">Kalan Alacak</span><span class="font-semibold text-orange-400">\u20BA${fmt(salesTotal-paidTotal)}</span></div>
        <div class="flex justify-between text-xs border-t border-gray-700 pt-2 mt-2"><span class="text-gray-400">Mesajlar</span><span class="font-semibold">${Object.values(S.messages).flat().length} adet</span></div>
    `;
    // Chart
    const rc=document.getElementById('report-chart');
    const months=['Oca','Sub','Mar','Nis','May','Haz'];
    rc.innerHTML=months.map(m=>{
        const h=Math.max(15,Math.random()*80+20);
        return `<div class="flex-1 flex flex-col items-center gap-1"><div class="w-full flex justify-center" style="height:150px;align-items:flex-end"><div class="chart-bar bg-gradient-to-t from-blue-600 to-cyan-400 w-5" style="height:${h}%"></div></div><span class="text-[10px] text-gray-500">${m}</span></div>`;
    }).join('');
    // All transactions
    const at=document.getElementById('report-all-transactions');
    let all=[];
    S.projects.forEach(p=>all.push({type:'Proje',name:p.name,amount:p.budget,date:p.createdAt,status:p.status}));
    S.tenders.forEach(t=>all.push({type:'Ihale',name:t.item,amount:t.amount,date:t.createdAt,status:t.status}));
    S.sales.forEach(s=>all.push({type:'Satis',name:s.customer+' - '+s.product,amount:s.price,date:s.createdAt,status:s.status}));
    // Date filter
    const ds=document.getElementById('report-date-start')?.value;
    const de=document.getElementById('report-date-end')?.value;
    if(ds)all=all.filter(a=>a.date&&new Date(a.date)>=new Date(ds));
    if(de)all=all.filter(a=>a.date&&new Date(a.date)<=new Date(de+'T23:59:59'));
    all.sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(all.length===0){at.innerHTML='<p class="text-gray-500 text-sm">Islem kaydi yok.</p>';return;}
    at.innerHTML=`<table class="w-full text-xs"><thead class="text-gray-400 border-b border-gray-700"><tr><th class="pb-2 text-left">Tip</th><th class="pb-2 text-left">Aciklama</th><th class="pb-2 text-right">Tutar</th><th class="pb-2 text-right">Durum</th></tr></thead><tbody class="divide-y divide-gray-800/50">${all.map(a=>`<tr class="hover:bg-gray-800/20"><td class="py-2">${a.type}</td><td class="py-2">${a.name}</td><td class="py-2 text-right font-semibold">\u20BA${fmtFull(a.amount)}</td><td class="py-2 text-right"><span class="status-${a.status}">${stName(a.status)}</span></td></tr>`).join('')}</tbody></table>`;
}

// ===================== SETTINGS =====================
function renderSettings(){
    const tb=document.getElementById('users-tbody');
    if(!tb)return;
    tb.innerHTML=S.users.map(u=>`<tr>
        <td class="py-3"><div><p class="text-sm font-medium">${u.name}</p></div></td>
        <td class="py-3 text-xs text-gray-300">${u.phone||'-'}</td>
        <td class="py-3 text-xs text-gray-400">${u.email||'-'}</td>
        <td class="py-3"><span class="status-${u.role==='Yonetici'?'approved':'reviewing'} cursor-pointer" onclick="openUserEdit(${u.id})" title="Rol degistirmek icin tiklayin">${u.role} ‚úé</span>${u.customModules?'<span class="text-[9px] text-orange-400 ml-1" title="Kisiye ozel modul ayari var">‚öô</span>':''}</td>
        <td class="py-3"><span class="text-green-400 text-xs">${u.active?'Aktif':'Pasif'}</span></td>
        <td class="py-3"><div class="flex gap-2">${u.id!==1?`<button onclick="openUserEdit(${u.id})" class="text-xs text-blue-400 hover:text-blue-300">Duzenle</button><button onclick="deleteItem('user',${u.id})" class="text-xs text-red-400 hover:text-red-300">Sil</button>`:''}</div></td>
    </tr>`).join('');
    // Roles - Dynamic
    const rv=document.getElementById('roles-view');
    if(rv) renderRolesTab(rv);
    // Update add-user role dropdown with all roles
    updateRoleDropdowns();
    // General
    const gs=document.getElementById('general-settings');
    if(gs) gs.innerHTML=`<h4 class="font-semibold text-sm mb-4">Genel Ayarlar</h4><div class="space-y-4">
        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800/30"><span class="text-sm">Tema</span><button onclick="toggleTheme()" class="text-xs px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">${S.theme==='dark'?'Karanlik - Aydinliga Gec':'Aydin - Karanliga Gec'}</button></div>
        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800/30"><span class="text-sm">Dil</span><span class="text-xs text-gray-400">Turkce</span></div>
        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800/30"><span class="text-sm">Bildirimler</span><span class="text-xs text-green-400">Aktif</span></div>
        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800/30"><span class="text-sm">Versiyon</span><span class="text-xs text-gray-400">FaOnSisT v5.0</span></div>
        <button onclick="logout()" class="w-full py-2.5 bg-orange-600/20 text-orange-400 hover:bg-orange-600/30 rounded-lg text-xs font-medium transition-colors mb-2">Cikis Yap</button>
        <button onclick="if(confirm('Tum veriler silinecek!')){localStorage.removeItem('faonsist_v4');location.reload();}" class="w-full py-2.5 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded-lg text-xs font-medium transition-colors">Tum Verileri Sifirla</button>
    </div>`;
}

function switchSettingsTab(tab){
    ['users','roles','general','kategoriler','bildirimler','belgeSablonlari'].forEach(t=>{const el=document.getElementById('settings-tab-'+t);if(el)el.classList.toggle('hidden',t!==tab);});
    document.querySelectorAll('#module-settings .tab-btn').forEach((b,i)=>b.classList.toggle('active',['users','roles','general','kategoriler','bildirimler','belgeSablonlari'][i]===tab));
    if(tab==='roles'){const rv=document.getElementById('roles-view');if(rv)renderRolesTab(rv);}
    if(tab==='kategoriler')renderKategoriAyarlari();
    if(tab==='bildirimler')renderBildirimAyarlari();
    if(tab==='belgeSablonlari')renderBelgeSablonlari();
}

// ===================== v5 - ROLE MANAGEMENT =====================
const ALL_MODULES=[
    {id:'dashboard',label:'Dashboard',icon:'üìä'},
    {id:'connect',label:'FaOn-Connect',icon:'üí¨'},
    {id:'build',label:'FaOn-Build',icon:'üèóÔ∏è'},
    {id:'supply',label:'FaOn-Supply',icon:'üì¶'},
    {id:'sales',label:'FaOn-Sales',icon:'üí∞'},
    {id:'depo',label:'FaOn-Depo',icon:'üè≠'},
    {id:'hr',label:'FaOn-HR',icon:'üë•'},
    {id:'reports',label:'Raporlar',icon:'üìà'},
    {id:'settings',label:'Ayarlar',icon:'‚öôÔ∏è'}
];
const ROLE_COLORS={'Yonetici':'green','Proje Muduru':'blue','Muhasebe':'orange','Satin Alma':'purple','Satis':'cyan','Izleyici':'gray'};

function renderRolesTab(container){
    if(!S.customRoles)S.customRoles=[];
    const allRoles=getRBACPerms();
    const roleNames=Object.keys(allRoles);
    const defaultRoleNames=Object.keys(RBAC_DEFAULT_ROLES);
    const colors=['green','blue','orange','purple','cyan','gray','pink','amber','teal','rose','lime','indigo'];

    container.innerHTML=`
        <div class="flex items-center justify-between mb-5">
            <div>
                <h4 class="font-semibold text-sm">Rol Yonetimi</h4>
                <p class="text-[11px] text-gray-500 mt-1">${roleNames.length} rol tanimli &middot; Rol kartina tiklayarak detaylari gorebilirsiniz</p>
            </div>
            <button onclick="openRoleForm()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg shadow-blue-600/20">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Yeni Rol Ekle
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="roles-list">
            ${roleNames.map((name,i)=>{
                const r=allRoles[name];
                const isDefault=defaultRoleNames.includes(name);
                const isCustom=!isDefault;
                const col=ROLE_COLORS[name]||colors[i%colors.length];
                const userCount=S.users.filter(u=>u.role===name).length;
                return `<div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/30 hover:border-${col}-500/30 transition-all cursor-pointer group" onclick="openRoleDetail('${name.replace(/'/g,"\\'")}')">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2.5">
                            <div class="w-8 h-8 rounded-lg bg-${col}-500/15 flex items-center justify-center text-${col}-400 text-sm font-bold">${name.charAt(0)}</div>
                            <div>
                                <span class="text-sm font-semibold">${name}</span>
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    ${isDefault?'<span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700/50 text-gray-500">Sistem</span>':'<span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">Ozel</span>'}
                                    <span class="text-[9px] text-gray-600">${userCount} kullanici</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            ${isCustom?`<button onclick="event.stopPropagation();editRole('${name.replace(/'/g,"\\'")}')" class="text-[10px] text-blue-400 hover:text-blue-300 px-2 py-1 rounded hover:bg-blue-500/10 transition-colors">Duzenle</button><button onclick="event.stopPropagation();deleteRole('${name.replace(/'/g,"\\'")}')" class="text-[10px] text-red-400 hover:text-red-300 px-2 py-1 rounded hover:bg-red-500/10 transition-colors">Sil</button>`:''}
                            <span class="text-[10px] text-gray-600 group-hover:text-blue-400 transition-colors">Detay ‚Üí</span>
                        </div>
                    </div>
                    <p class="text-[11px] text-gray-500 mb-2.5 line-clamp-2">${r.desc||'Tanim belirtilmemis.'}</p>
                    <div class="flex flex-wrap gap-1">
                        ${(r.modules||[]).slice(0,5).map(m=>{
                            const mod=ALL_MODULES.find(x=>x.id===m);
                            const isRO=(r.readOnly||[]).includes(m);
                            return `<span class="text-[9px] px-1.5 py-0.5 rounded ${isRO?'bg-yellow-500/10 text-yellow-500 border border-yellow-500/20':'bg-green-500/10 text-green-400 border border-green-500/20'}">${mod?mod.icon:''} ${mod?mod.label:m}${isRO?' (RO)':''}</span>`;
                        }).join('')}
                        ${(r.modules||[]).length>5?`<span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700/30 text-gray-500">+${(r.modules||[]).length-5}</span>`:''}
                        ${!r.write?'<span class="text-[9px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 border border-red-500/20">Salt Okunur</span>':''}
                    </div>
                </div>`;
            }).join('')}
        </div>`;
}

function openRoleDetail(roleName){
    const allRoles=getRBACPerms();
    const r=allRoles[roleName];
    if(!r)return;
    const isDefault=Object.keys(RBAC_DEFAULT_ROLES).includes(roleName);
    const userCount=S.users.filter(u=>u.role===roleName).length;
    const usersOfRole=S.users.filter(u=>u.role===roleName);
    const col=ROLE_COLORS[roleName]||'blue';

    const html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full bg-${col}-400"></div>
                <h3 class="text-lg font-bold">${roleName}</h3>
                ${isDefault?'<span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-700/50 text-gray-400">Sistem Rolu</span>':'<span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Ozel Rol</span>'}
            </div>
            <button onclick="closeModal('modal-role-detail')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>

        <!-- Tanim -->
        <div class="mb-5 p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
            <h4 class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">Tanim</h4>
            <p class="text-sm text-gray-300 leading-relaxed">${r.desc||'Tanim belirtilmemis.'}</p>
        </div>

        <!-- Modul Erisimleri -->
        <div class="mb-5 p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
            <h4 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider">Modul Erisimleri</h4>
            <div class="grid grid-cols-3 gap-2">
                ${ALL_MODULES.map(m=>{
                    const hasAccess=(r.modules||[]).includes(m.id);
                    const isRO=(r.readOnly||[]).includes(m.id);
                    return `<div class="flex items-center gap-2 p-2 rounded-lg ${hasAccess?(isRO?'bg-yellow-500/5 border border-yellow-500/15':'bg-green-500/5 border border-green-500/15'):'bg-gray-800/20 border border-gray-700/10 opacity-40'}">
                        <span class="text-sm">${m.icon}</span>
                        <div>
                            <p class="text-[11px] font-medium ${hasAccess?'text-gray-200':'text-gray-600'}">${m.label}</p>
                            <p class="text-[9px] ${hasAccess?(isRO?'text-yellow-500':'text-green-400'):'text-gray-600'}">${hasAccess?(isRO?'Salt Okunur':'Tam Erisim'):'Erisim Yok'}</p>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>

        <!-- Gorevler -->
        ${(r.gorevler&&r.gorevler.length)?`<div class="mb-5 p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
            <h4 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider">Gorevler</h4>
            <ul class="space-y-1.5">${r.gorevler.map(g=>`<li class="flex items-start gap-2 text-sm text-gray-300"><span class="text-green-400 mt-0.5">‚úì</span>${g}</li>`).join('')}</ul>
        </div>`:''}

        <!-- Sorumluluklar -->
        ${(r.sorumluluklar&&r.sorumluluklar.length)?`<div class="mb-5 p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
            <h4 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider">Sorumluluklar</h4>
            <ul class="space-y-1.5">${r.sorumluluklar.map(s=>`<li class="flex items-start gap-2 text-sm text-gray-300"><span class="text-orange-400 mt-0.5">‚ö†</span>${s}</li>`).join('')}</ul>
        </div>`:''}

        <!-- Bu Roldeki Kullanicilar -->
        <div class="p-4 rounded-xl bg-gray-800/30 border border-gray-700/20">
            <h4 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider">Bu Roldeki Kullanicilar (${userCount})</h4>
            ${usersOfRole.length?`<div class="space-y-2">${usersOfRole.map(u=>`<div class="flex items-center gap-3 p-2 rounded-lg bg-gray-800/30">
                <div class="w-7 h-7 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-[10px] font-bold">${(u.name||'').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)}</div>
                <div><p class="text-xs font-medium">${u.name}</p><p class="text-[10px] text-gray-500">${u.email||u.phone||''}</p></div>
            </div>`).join('')}</div>`:'<p class="text-xs text-gray-600">Bu rolde kullanici bulunmuyor.</p>'}
        </div>

        <div class="flex gap-3 mt-5">
            ${!isDefault?`<button onclick="editRole('${roleName.replace(/'/g,"\\'")}');closeModal('modal-role-detail')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Duzenle</button>`:''}
            <button onclick="closeModal('modal-role-detail')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Kapat</button>
        </div>
    </div>`;

    // Use a generic modal approach
    let modal=document.getElementById('modal-role-detail');
    if(!modal){
        modal=document.createElement('div');
        modal.id='modal-role-detail';
        modal.className='modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML=html;
    modal.style.display='';
    modal.classList.add('active');
}

function openRoleForm(editRoleName){
    if(!S.customRoles)S.customRoles=[];
    const existing=editRoleName?(S.customRoles.find(r=>r.name===editRoleName)||null):null;
    const isEdit=!!existing;

    const html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold">${isEdit?'Rol Duzenle':'Yeni Rol Olustur'}</h3>
            <button onclick="closeModal('modal-role-form')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>
        <form onsubmit="saveRole(event,'${(editRoleName||'').replace(/'/g,"\\'")}')" class="space-y-4">
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Rol Adi *</label>
                <input type="text" id="role-name" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="orn: Saha Muhendisi" value="${existing?existing.name:''}" ${isEdit?'readonly':''}>
            </div>
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Aciklama</label>
                <textarea id="role-desc" rows="2" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Bu rolun genel tanimi...">${existing?existing.desc||'':''}</textarea>
            </div>
            <div>
                <label class="block text-xs mb-2 text-gray-400">Modul Erisimleri *</label>
                <div class="space-y-2" id="role-modules-list">
                    ${ALL_MODULES.map(m=>{
                        const hasAccess=existing?(existing.modules||[]).includes(m.id):false;
                        const isRO=existing?(existing.readOnly||[]).includes(m.id):false;
                        return `<div class="flex items-center justify-between p-2.5 rounded-lg bg-gray-800/30 border border-gray-700/20">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="mod_${m.id}" value="${m.id}" ${hasAccess?'checked':''} class="rounded" onchange="document.getElementById('ro_${m.id}').style.display=this.checked?'flex':'none'">
                                <span class="text-sm">${m.icon}</span>
                                <span class="text-xs font-medium">${m.label}</span>
                            </label>
                            <div id="ro_${m.id}" class="flex items-center gap-2" style="display:${hasAccess?'flex':'none'}">
                                <label class="flex items-center gap-1.5 cursor-pointer text-[10px] text-gray-400">
                                    <input type="checkbox" name="ro_${m.id}" ${isRO?'checked':''} class="rounded">
                                    Salt Okunur
                                </label>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Yazma Yetkisi</label>
                <label class="flex items-center gap-2 cursor-pointer p-2.5 rounded-lg bg-gray-800/30">
                    <input type="checkbox" id="role-write" ${existing?(existing.write!==false?'checked':''):'checked'} class="rounded">
                    <span class="text-xs">Bu rol veri ekleyebilir/duzenleyebilir</span>
                </label>
            </div>
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Gorevler <span class="text-gray-600">(her satir bir gorev)</span></label>
                <textarea id="role-gorevler" rows="3" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Proje takibi\\nGorev atama\\nRapor hazirlama">${existing?(existing.gorevler||[]).join('\\n'):''}</textarea>
            </div>
            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Sorumluluklar <span class="text-gray-600">(her satir bir sorumluluk)</span></label>
                <textarea id="role-sorumluluklar" rows="3" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-2.5 text-sm" placeholder="Zamaninda raporlama\\nVeri guvenligi">${existing?(existing.sorumluluklar||[]).join('\\n'):''}</textarea>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">${isEdit?'Guncelle':'Olustur'}</button>
                <button type="button" onclick="closeModal('modal-role-form')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>`;

    let modal=document.getElementById('modal-role-form');
    if(!modal){
        modal=document.createElement('div');
        modal.id='modal-role-form';
        modal.className='modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML=html;
    modal.style.display='';
    modal.classList.add('active');
}

function saveRole(e,editName){
    e.preventDefault();
    if(!S.customRoles)S.customRoles=[];
    const name=document.getElementById('role-name').value.trim();
    if(!name){showNotif('Rol adi bos olamaz!');return;}
    // Check duplicate (excluding edit target)
    const allNames=Object.keys(getRBACPerms());
    if(!editName&&allNames.includes(name)){showNotif('Bu isimde bir rol zaten var!');return;}

    const modules=[];const readOnly=[];
    ALL_MODULES.forEach(m=>{
        const cb=document.querySelector('input[name="mod_'+m.id+'"]');
        const ro=document.querySelector('input[name="ro_'+m.id+'"]');
        if(cb&&cb.checked){
            modules.push(m.id);
            if(ro&&ro.checked)readOnly.push(m.id);
        }
    });
    if(modules.length===0){showNotif('En az bir modul secmelisiniz!');return;}

    const write=document.getElementById('role-write').checked;
    const desc=document.getElementById('role-desc').value.trim();
    const gorevler=document.getElementById('role-gorevler').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const sorumluluklar=document.getElementById('role-sorumluluklar').value.split('\n').map(s=>s.trim()).filter(Boolean);

    const roleData={name,modules,write,readOnly,desc,gorevler,sorumluluklar};

    if(editName){
        const idx=S.customRoles.findIndex(r=>r.name===editName);
        if(idx>=0)S.customRoles[idx]=roleData;
        else S.customRoles.push(roleData);
    } else {
        S.customRoles.push(roleData);
    }

    save();
    closeModal('modal-role-form');
    renderSettings();
    showNotif((editName?'Rol guncellendi':'Yeni rol olusturuldu')+': '+name);
    // Update user form role dropdown
    updateRoleDropdowns();
}

function editRole(name){
    openRoleForm(name);
}

function deleteRole(name){
    if(!confirm(name+' rolunu silmek istediginize emin misiniz?'))return;
    const usersWithRole=S.users.filter(u=>u.role===name);
    if(usersWithRole.length>0){
        if(!confirm(usersWithRole.length+' kullanici bu rolde. Silersek Izleyici rolune dusecekler. Devam?'))return;
        usersWithRole.forEach(u=>{u.role='Izleyici';u.perms='Izleyici yetkileri';});
    }
    S.customRoles=S.customRoles.filter(r=>r.name!==name);
    save();renderSettings();
    showNotif('Rol silindi: '+name);
    updateRoleDropdowns();
}

function updateRoleDropdowns(){
    // Update user add form role select (exclude Yonetici for new users)
    const allRoles=Object.keys(getRBACPerms());
    const sel=document.getElementById('add-user-role-select');
    if(sel){
        sel.innerHTML=allRoles.filter(r=>r!=='Yonetici').map(r=>`<option value="${r}">${r}</option>`).join('');
    }
}

function openUserEdit(userId){
    const user=S.users.find(u=>u.id===userId);
    if(!user)return;
    const allRoles=Object.keys(getRBACPerms());
    const isAdmin=user.id===1;
    const rolePerms=getPermsForRole(user.role);
    const roleModules=rolePerms.modules||[];
    // User-level overrides: customModules = {modulId: true/false}
    const cm=user.customModules||{};

    const html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-sm font-bold">${(user.name||'').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)}</div>
                <div>
                    <h3 class="text-base font-bold">${user.name}</h3>
                    <p class="text-[11px] text-gray-500">${user.email||user.phone||''}</p>
                </div>
            </div>
            <button onclick="closeModal('modal-user-edit')" class="text-gray-400 hover:text-white text-lg">&times;</button>
        </div>

        <form onsubmit="saveUserEdit(event,${userId})" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs mb-1.5 text-gray-400">Ad Soyad</label>
                    <input type="text" id="ue-name" required class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="${user.name||''}">
                </div>
                <div>
                    <label class="block text-xs mb-1.5 text-gray-400">Telefon</label>
                    <input type="tel" id="ue-phone" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="${user.phone||''}">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs mb-1.5 text-gray-400">E-posta</label>
                    <input type="email" id="ue-email" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="${user.email||''}">
                </div>
                <div>
                    <label class="block text-xs mb-1.5 text-gray-400">Durum</label>
                    <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg bg-gray-800/30 h-[38px]">
                        <input type="checkbox" id="ue-active" ${user.active!==false?'checked':''} class="rounded">
                        <span class="text-xs">${user.active!==false?'Aktif':'Pasif'}</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-xs mb-1.5 text-gray-400">Rol ${isAdmin?'<span class="text-yellow-500">(Ana yonetici)</span>':''}</label>
                <select id="ue-role" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" ${isAdmin?'disabled':''} onchange="userEditRoleChanged(${userId})">
                    ${allRoles.map(r=>`<option value="${r}" ${user.role===r?'selected':''}>${r}</option>`).join('')}
                </select>
            </div>

            <!-- Modul Erisim Ayarlari -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-xs text-gray-400 font-semibold">Modul Erisimleri</label>
                    <button type="button" onclick="resetUserModules()" class="text-[10px] text-gray-600 hover:text-gray-400 transition-colors">Role Sifirla</button>
                </div>
                <p class="text-[10px] text-gray-600 mb-2.5">Rolun verdigi erisimi kisiye ozel acip kapatabilirsiniz</p>
                <div class="space-y-1.5" id="ue-modules-grid">
                    ${ALL_MODULES.map(m=>{
                        const fromRole=roleModules.includes(m.id);
                        // customModules override: true=force on, false=force off, undefined=follow role
                        const hasOverride=cm.hasOwnProperty(m.id);
                        const isOn=hasOverride?cm[m.id]:fromRole;
                        const isRO=(rolePerms.readOnly||[]).includes(m.id);
                        let stateLabel='',stateCls='';
                        if(!hasOverride){stateLabel=fromRole?'Rolden Acik':'Rolden Kapali';stateCls=fromRole?'text-green-500':'text-gray-600';}
                        else if(isOn&&!fromRole){stateLabel='Kisiye Ozel Acildi';stateCls='text-blue-400';}
                        else if(!isOn&&fromRole){stateLabel='Kisiye Ozel Kapatildi';stateCls='text-orange-400';}
                        else{stateLabel=isOn?'Acik':'Kapali';stateCls=isOn?'text-green-500':'text-gray-600';}
                        return `<div class="flex items-center justify-between p-2.5 rounded-lg ${isOn?'bg-gray-800/40 border border-gray-700/30':'bg-gray-900/30 border border-gray-800/20'} transition-all">
                            <div class="flex items-center gap-2.5">
                                <span class="text-base">${m.icon}</span>
                                <div>
                                    <p class="text-xs font-medium ${isOn?'text-gray-200':'text-gray-600'}">${m.label}</p>
                                    <p class="text-[9px] ${stateCls}">${stateLabel}${isRO&&isOn?' &middot; Salt Okunur':''}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="uemod_${m.id}" ${isOn?'checked':''} class="sr-only peer" onchange="markUserModuleOverride('${m.id}',this.checked,${fromRole})">
                                    <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-gray-400 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-checked:after:bg-white"></div>
                                </label>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button>
                <button type="button" onclick="closeModal('modal-user-edit')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button>
            </div>
        </form>
    </div>`;

    let modal=document.getElementById('modal-user-edit');
    if(!modal){
        modal=document.createElement('div');
        modal.id='modal-user-edit';
        modal.className='modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML=html;
    modal.style.display='';
    modal.classList.add('active');
    // Store userId for helper functions
    modal._editUserId=userId;
}

// Track which modules user explicitly overrode
let _ueModuleOverrides={};
function markUserModuleOverride(modId,isChecked,fromRole){
    // If checkbox matches role default, remove override; otherwise mark it
    if(isChecked===fromRole){delete _ueModuleOverrides[modId];}
    else{_ueModuleOverrides[modId]=isChecked;}
    // Update label under the module
    const row=document.querySelector('input[name="uemod_'+modId+'"]');
    if(row){
        const container=row.closest('.flex.items-center.justify-between');
        if(container){
            const label=container.querySelector('.text-\\[9px\\]');
            if(label){
                if(isChecked===fromRole){label.textContent=fromRole?'Rolden Acik':'Rolden Kapali';label.className='text-[9px] '+(fromRole?'text-green-500':'text-gray-600');}
                else if(isChecked&&!fromRole){label.textContent='Kisiye Ozel Acildi';label.className='text-[9px] text-blue-400';}
                else{label.textContent='Kisiye Ozel Kapatildi';label.className='text-[9px] text-orange-400';}
            }
        }
    }
}

function resetUserModules(){
    _ueModuleOverrides={};
    const modal=document.getElementById('modal-user-edit');
    if(modal&&modal._editUserId) openUserEdit(modal._editUserId);
}

function userEditRoleChanged(userId){
    // When role changes in dropdown, re-render module grid with new role's defaults
    const newRole=document.getElementById('ue-role').value;
    const rolePerms=getPermsForRole(newRole);
    const roleModules=rolePerms.modules||[];
    _ueModuleOverrides={};
    const grid=document.getElementById('ue-modules-grid');
    if(!grid)return;
    grid.innerHTML=ALL_MODULES.map(m=>{
        const fromRole=roleModules.includes(m.id);
        const isOn=fromRole;
        const isRO=(rolePerms.readOnly||[]).includes(m.id);
        const stateLabel=fromRole?'Rolden Acik':'Rolden Kapali';
        const stateCls=fromRole?'text-green-500':'text-gray-600';
        return `<div class="flex items-center justify-between p-2.5 rounded-lg ${isOn?'bg-gray-800/40 border border-gray-700/30':'bg-gray-900/30 border border-gray-800/20'} transition-all">
            <div class="flex items-center gap-2.5">
                <span class="text-base">${m.icon}</span>
                <div>
                    <p class="text-xs font-medium ${isOn?'text-gray-200':'text-gray-600'}">${m.label}</p>
                    <p class="text-[9px] ${stateCls}">${stateLabel}${isRO&&isOn?' &middot; Salt Okunur':''}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="uemod_${m.id}" ${isOn?'checked':''} class="sr-only peer" onchange="markUserModuleOverride('${m.id}',this.checked,${fromRole})">
                    <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-gray-400 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-checked:after:bg-white"></div>
                </label>
            </div>
        </div>`;
    }).join('');
}

function saveUserEdit(e,userId){
    e.preventDefault();
    const user=S.users.find(u=>u.id===userId);
    if(!user)return;

    const oldRole=user.role;
    user.name=document.getElementById('ue-name').value.trim();
    user.phone=document.getElementById('ue-phone').value.trim();
    user.email=document.getElementById('ue-email').value.trim();
    if(user.id!==1) user.role=document.getElementById('ue-role').value;
    user.active=document.getElementById('ue-active').checked;

    // Build customModules from checkboxes
    const rolePerms=getPermsForRole(user.role);
    const roleModules=rolePerms.modules||[];
    const customMods={};
    ALL_MODULES.forEach(m=>{
        const cb=document.querySelector('input[name="uemod_'+m.id+'"]');
        if(cb){
            const isChecked=cb.checked;
            const fromRole=roleModules.includes(m.id);
            // Only store if different from role default
            if(isChecked!==fromRole){customMods[m.id]=isChecked;}
        }
    });
    user.customModules=Object.keys(customMods).length>0?customMods:undefined;

    // Update perms text
    const effectiveModules=getUserEffectiveModules(user);
    user.perms=effectiveModules.join(', ');

    _ueModuleOverrides={};
    save();
    closeModal('modal-user-edit');
    renderSettings();

    const changes=[];
    if(oldRole!==user.role) changes.push('Rol: '+oldRole+' ‚Üí '+user.role);
    if(user.customModules) changes.push('Kisiye ozel modul ayari yapildi');
    if(changes.length>0){
        showNotif(user.name+': '+changes.join(', '));
        act(user.name+' guncellendi: '+changes.join(', '));
    } else {
        showNotif(user.name+' bilgileri guncellendi.');
    }

    // If editing current user, re-apply RBAC
    if(currentUser&&currentUser.id===userId){
        currentUser=user;
        applyRBAC();
        document.querySelector('.sidebar-user-info p:first-child').textContent=currentUser.name;
        document.querySelector('.sidebar-user-info p:last-child').textContent=currentUser.role;
    }
}

// ===================== v5 - EDIT FUNCTIONS =====================
function openEditProject(id){
    const p=S.projects.find(x=>x.id===id);if(!p)return;
    document.getElementById('edit-project-id').value=id;
    document.getElementById('edit-p-name').value=p.name;
    document.getElementById('edit-p-budget').value=p.budget;
    document.getElementById('edit-p-spent').value=p.spent||0;
    document.getElementById('edit-p-contractor').value=p.contractor;
    document.getElementById('edit-p-completion').value=p.completion;
    document.getElementById('edit-p-notes').value=p.notes||'';
    document.getElementById('edit-p-location').value=p.location||'';
    document.getElementById('edit-p-contractAmount').value=p.contractAmount||p.budget;
    document.getElementById('edit-p-startDate').value=p.startDate||'';
    document.getElementById('edit-p-endDate').value=p.endDate||'';
    const ptSel=document.getElementById('edit-p-projectType');
    ptSel.innerHTML=PROJECT_TYPES.map(t=>`<option value="${t.v}"${t.v===p.projectType?' selected':''}>${t.l}</option>`).join('');
    const ctSel=document.getElementById('edit-p-contractType');
    ctSel.innerHTML=CONTRACT_TYPES.map(t=>`<option value="${t.v}"${t.v===p.contractType?' selected':''}>${t.l}</option>`).join('');
    const mSel=document.getElementById('edit-p-manager');
    mSel.innerHTML='<option value="">Seciniz...</option>'+S.users.map(u=>`<option${u.name===p.manager?' selected':''}>${u.name}</option>`).join('');
    openModal('modal-edit-project');
}
function saveEditProject(e){
    e.preventDefault();const id=+document.getElementById('edit-project-id').value;
    const p=S.projects.find(x=>x.id===id);if(!p)return;
    p.name=document.getElementById('edit-p-name').value;
    p.budget=+document.getElementById('edit-p-budget').value;
    p.spent=+document.getElementById('edit-p-spent').value;
    p.contractor=document.getElementById('edit-p-contractor').value;
    p.completion=+document.getElementById('edit-p-completion').value;
    p.notes=document.getElementById('edit-p-notes').value;
    p.location=document.getElementById('edit-p-location').value;
    p.contractAmount=+document.getElementById('edit-p-contractAmount').value||p.budget;
    p.startDate=document.getElementById('edit-p-startDate').value;
    p.endDate=document.getElementById('edit-p-endDate').value;
    p.projectType=document.getElementById('edit-p-projectType').value;
    p.contractType=document.getElementById('edit-p-contractType').value;
    p.manager=document.getElementById('edit-p-manager').value||p.manager;
    act('Proje guncellendi: '+p.name);save();renderAll();closeModal('modal-edit-project');showNotif('Proje guncellendi!');
}
function openEditTender(id){openIhaleDetay(id);}
function saveEditTender(e){if(e)e.preventDefault();}
function openEditSale(id){
    const s=S.sales.find(x=>x.id===id);if(!s)return;
    document.getElementById('edit-sale-id').value=id;
    document.getElementById('edit-s-customer').value=s.customer;
    document.getElementById('edit-s-phone').value=s.phone||'';
    document.getElementById('edit-s-product').value=s.product;
    document.getElementById('edit-s-price').value=s.price;
    document.getElementById('edit-s-installments').value=s.installments;
    openModal('modal-edit-sale');
}
function saveEditSale(e){
    e.preventDefault();const id=+document.getElementById('edit-sale-id').value;
    const s=S.sales.find(x=>x.id===id);if(!s)return;
    s.customer=document.getElementById('edit-s-customer').value;
    s.phone=document.getElementById('edit-s-phone').value;
    s.product=document.getElementById('edit-s-product').value;
    s.price=+document.getElementById('edit-s-price').value;
    s.installments=+document.getElementById('edit-s-installments').value;
    act('Satis guncellendi: '+s.customer);save();renderAll();closeModal('modal-edit-sale');showNotif('Satis guncellendi!');
}

// ===================== v5 - PROJECT DETAIL =====================
function closeProjectDetail(){document.getElementById('project-detail').classList.remove('active');}

// ===================== v5 - NOTIFICATION PANEL =====================
function toggleNotifPanel(){
    const p=document.getElementById('notif-panel');
    p.classList.toggle('active');
    if(p.classList.contains('active'))renderBildirimPaneli();
}
function renderBildirimPaneli(){
    const uid=currentUser?currentUser.id:1;
    const gorunenler=bildirimlerKullanicininGoregi();
    // Kategori tab'lari
    const tabsEl=document.getElementById('bildirim-kat-tabs');
    if(tabsEl){
        const katSayilar={'tumu':gorunenler.length,'arac-filo':0,'envanter':0,'genel':0};
        gorunenler.forEach(b=>{if(katSayilar[b.kategori]!==undefined)katSayilar[b.kategori]++;});
        const katLabels={'tumu':'Tumu','arac-filo':'Arac-Filo','envanter':'Envanter','genel':'Genel'};
        tabsEl.innerHTML=Object.keys(katLabels).map(k=>{
            const okunmamis=k==='tumu'?gorunenler.filter(b=>!b.okunduDurumu||!b.okunduDurumu[uid]).length:gorunenler.filter(b=>b.kategori===k&&(!b.okunduDurumu||!b.okunduDurumu[uid])).length;
            const badge=okunmamis>0?'<span class="text-[8px] bg-red-500 text-white px-1 rounded-full">'+okunmamis+'</span>':'';
            return '<button class="px-2 py-0.5 rounded text-[10px] '+(bildirimKategoriFiltre===k?'bg-blue-600 text-white':'glass text-gray-400 hover:text-white')+'" onclick="bildirimKategoriFiltre=\''+k+'\';renderBildirimPaneli()">'+katLabels[k]+' '+badge+'</button>';
        }).join('');
    }
    // Bildirim listesi
    const c=document.getElementById('notif-list');
    let filtered=bildirimKategoriFiltre==='tumu'?gorunenler:gorunenler.filter(b=>b.kategori===bildirimKategoriFiltre);
    if(filtered.length===0){c.innerHTML='<p class="text-xs text-gray-500 p-3 text-center">Bildirim yok.</p>';return;}
    c.innerHTML=filtered.slice(0,30).map(b=>{
        const okunmamis=!b.okunduDurumu||!b.okunduDurumu[uid];
        const tarihStr=b.tarih?new Date(b.tarih).toLocaleDateString('tr-TR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'';
        return `<div class="notif-item seviye-${b.seviye} ${okunmamis?'notif-unread':''} p-2 rounded-lg" onclick="bildirimTikla(${b.id})">
            <div class="flex items-start gap-2">
                <span class="text-xs mt-0.5 flex-shrink-0">${BILDIRIM_SEVIYE_ICON[b.seviye]||''}</span>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5">
                        <span class="text-[11px] font-semibold truncate">${b.baslik}</span>
                        ${okunmamis?`<span class="w-1.5 h-1.5 rounded-full bg-blue-500 flex-shrink-0 ${b.seviye==='acil'?'pulse-dot':''}"></span>`:''}
                    </div>
                    <p class="text-[10px] text-gray-400 mt-0.5 truncate">${b.mesaj}</p>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="px-1.5 py-0 rounded text-[8px] ${BILDIRIM_SEVIYE_BADGE[b.seviye]||''}">${BILDIRIM_SEVIYE_LABEL[b.seviye]||''}</span>
                        <span class="text-[8px] text-gray-600">${tarihStr}</span>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}
function bildirimTikla(bildirimId){
    const b=S.bildirimler.find(x=>x.id===bildirimId);if(!b)return;
    bildirimOkunduIsaretle(bildirimId,currentUser?currentUser.id:1);
    document.getElementById('notif-panel').classList.remove('active');
    if(b.aksiyonTip==='arac-detay'&&b.aksiyonId){showModule('depo');switchDepoTab('arac');aracDetayId=b.aksiyonId;renderDepoArac();}
    else if(b.aksiyonTip==='envanter-detay'){showModule('depo');switchDepoTab('envanter');}
    else if(b.aksiyonTip==='ayarlar'){showModule('settings');switchSettingsTab('bildirimler');}
    bildirimSayisiGuncelle();
}
// Close notif panel when clicking outside
document.addEventListener('click',e=>{
    const p=document.getElementById('notif-panel');
    if(p&&p.classList.contains('active')&&!e.target.closest('.relative')){p.classList.remove('active');}
});

// ===================== v5 - GLOBAL SEARCH =====================
function openGlobalSearch(){
    document.getElementById('search-overlay').classList.add('active');
    setTimeout(()=>document.getElementById('global-search-input').focus(),100);
}
function closeGlobalSearch(){document.getElementById('search-overlay').classList.remove('active');document.getElementById('global-search-input').value='';document.getElementById('global-search-results').innerHTML='';}
// ===================== MESAJ ARAMA =====================
function toggleMessageSearch(){
    const bar=document.getElementById('msg-search-bar');
    if(!bar)return;
    bar.classList.toggle('hidden');
    if(!bar.classList.contains('hidden')){
        document.getElementById('msg-search-input').focus();
    }else{
        document.getElementById('msg-search-input').value='';
        document.getElementById('msg-search-results').classList.add('hidden');
        document.getElementById('msg-search-results').innerHTML='';
        document.getElementById('msg-search-count').classList.add('hidden');
        // Remove highlights
        renderMessages();
    }
}

function searchMessages(query){
    const resultsEl=document.getElementById('msg-search-results');
    const countEl=document.getElementById('msg-search-count');
    if(!query||query.trim().length<2){
        resultsEl.classList.add('hidden');resultsEl.innerHTML='';
        countEl.classList.add('hidden');
        return;
    }
    const q=query.toLowerCase().trim();
    const allChannels=document.getElementById('msg-search-all-channels')?.checked||false;
    const results=[];

    if(allChannels){
        Object.entries(S.messages).forEach(([ch,msgs])=>{
            (msgs||[]).forEach(m=>{
                const plainText=(m.text||'').replace(/<[^>]*>/g,'');
                if(plainText.toLowerCase().includes(q)){
                    results.push({channelId:ch,message:m,plainText:plainText});
                }
            });
        });
    }else{
        const msgs=S.messages[S.currentChannel]||[];
        msgs.forEach(m=>{
            const plainText=(m.text||'').replace(/<[^>]*>/g,'');
            if(plainText.toLowerCase().includes(q)){
                results.push({channelId:S.currentChannel,message:m,plainText:plainText});
            }
        });
    }

    countEl.textContent=results.length+' sonuc bulundu';
    countEl.classList.remove('hidden');

    if(results.length===0){
        resultsEl.innerHTML='<p class="text-[10px] text-gray-500 text-center py-2">Sonuc bulunamadi.</p>';
        resultsEl.classList.remove('hidden');
        return;
    }

    resultsEl.innerHTML=results.slice(0,20).map(r=>{
        const highlighted=r.plainText.replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark class="bg-yellow-500/30 text-yellow-300 rounded px-0.5">$1</mark>');
        const truncated=highlighted.length>120?'...'+highlighted.substring(highlighted.toLowerCase().indexOf(q.toLowerCase())-30,highlighted.toLowerCase().indexOf(q.toLowerCase())+90)+'...':highlighted;
        return '<div class="p-2 rounded-lg hover:bg-gray-800/50 cursor-pointer transition-colors" onclick="goToSearchResult(\''+r.channelId+'\','+r.message.id+')"><div class="flex items-center gap-2 mb-0.5"><span class="text-[9px] text-blue-400 font-medium">#'+r.channelId+'</span><span class="text-[9px] text-gray-500">'+r.message.user+'</span><span class="text-[9px] text-gray-600">'+r.message.time+'</span></div><p class="text-[11px] text-gray-300">'+truncated+'</p></div>';
    }).join('');
    if(results.length>20)resultsEl.innerHTML+='<p class="text-[10px] text-gray-500 text-center py-1">+'+(results.length-20)+' daha...</p>';
    resultsEl.classList.remove('hidden');
}

function goToSearchResult(channelId,messageId){
    if(channelId!==S.currentChannel){
        S.currentChannel=channelId;
        renderChannels();
    }
    toggleMessageSearch();
    // Scroll to message after render
    setTimeout(()=>{
        const chatEl=document.getElementById('chat-messages');
        if(!chatEl)return;
        const msgEls=chatEl.querySelectorAll('.group');
        const msgs=S.messages[S.currentChannel]||[];
        const idx=msgs.findIndex(m=>m.id===messageId);
        if(idx>=0&&msgEls[idx]){
            msgEls[idx].scrollIntoView({behavior:'smooth',block:'center'});
            msgEls[idx].classList.add('ring-1','ring-yellow-500/50');
            setTimeout(()=>msgEls[idx].classList.remove('ring-1','ring-yellow-500/50'),3000);
        }
    },200);
}

function doGlobalSearch(q){
    q=q.toLowerCase().trim();const r=document.getElementById('global-search-results');
    if(!q){r.innerHTML='';return;}
    const results=[];
    S.projects.forEach(p=>{if(p.name.toLowerCase().includes(q)||p.contractor.toLowerCase().includes(q))results.push({type:'Proje',name:p.name,sub:p.contractor,action:()=>{closeGlobalSearch();showModule('build');}});});
    S.tenders.forEach(t=>{const name=t.baslik||t.item||'';const sup=t.supplier||'';if(name.toLowerCase().includes(q)||sup.toLowerCase().includes(q))results.push({type:'Ihale',name:name,sub:sup,action:()=>{closeGlobalSearch();showModule('supply');switchSupplyTab('ihaleler');}});});
    (S.satinalmaTalepleri||[]).forEach(t=>{const kalemNames=(t.kalemler||[]).map(k=>k.malzeme).join(', ');if(t.talepNo.toLowerCase().includes(q)||kalemNames.toLowerCase().includes(q))results.push({type:'Talep',name:t.talepNo,sub:kalemNames.substring(0,50),action:()=>{closeGlobalSearch();showModule('supply');switchSupplyTab('talepler');}});});
    (S.tedarikcilerHavuzu||[]).forEach(t=>{if(t.firma.toLowerCase().includes(q)||(t.yetkili||'').toLowerCase().includes(q))results.push({type:'Tedarikci',name:t.firma,sub:t.yetkili||'',action:()=>{closeGlobalSearch();showModule('supply');switchSupplyTab('tedarikciler');}});});
    S.sales.forEach(s=>{if(s.customer.toLowerCase().includes(q)||s.product.toLowerCase().includes(q))results.push({type:'Satis',name:s.customer,sub:s.product,action:()=>{closeGlobalSearch();showModule('sales');}});});
    const modules=[{n:'Dashboard',m:'dashboard'},{n:'FaOn-Connect',m:'connect'},{n:'FaOn-Build',m:'build'},{n:'FaOn-Supply',m:'supply'},{n:'FaOn-Sales',m:'sales'},{n:'Raporlar',m:'reports'},{n:'Ayarlar',m:'settings'}];
    modules.forEach(mod=>{if(mod.n.toLowerCase().includes(q))results.push({type:'Modul',name:mod.n,sub:'',action:()=>{closeGlobalSearch();showModule(mod.m);}});});
    // Search messages
    Object.entries(S.messages).forEach(([ch,msgs])=>{
        (msgs||[]).forEach(m=>{
            const plainText=(m.text||'').replace(/<[^>]*>/g,'');
            if(plainText.toLowerCase().includes(q)){
                results.push({type:'Mesaj',name:plainText.substring(0,50)+(plainText.length>50?'...':''),sub:'#'+ch+' - '+m.user,action:()=>{closeGlobalSearch();showModule('connect');setTimeout(()=>{S.currentChannel=ch;renderChannels();},100);}});
            }
        });
    });
    if(results.length===0){r.innerHTML='<p class="text-xs text-gray-500 p-3 text-center">Sonuc bulunamadi.</p>';return;}
    r.innerHTML=results.slice(0,8).map((x,i)=>`<div onclick="globalSearchResults[${i}]()" class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-gray-800/30 cursor-pointer transition-colors"><span class="text-[9px] px-2 py-0.5 rounded bg-gray-700 text-gray-300">${x.type}</span><div class="flex-1 min-w-0"><p class="text-sm font-medium truncate">${x.name}</p>${x.sub?`<p class="text-[10px] text-gray-500 truncate">${x.sub}</p>`:''}</div></div>`).join('');
    window.globalSearchResults=results.slice(0,8).map(x=>x.action);
}
// Ctrl+K shortcut
document.addEventListener('keydown',e=>{
    if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();openGlobalSearch();}
    if(e.key==='Escape'){closeGlobalSearch();closeProjectDetail();}
});

// ===================== v5 - SIDEBAR COLLAPSE =====================
let sidebarCollapsed=false;
function toggleSidebar(){
    sidebarCollapsed=!sidebarCollapsed;
    document.getElementById('sidebar').classList.toggle('sidebar-collapsed',sidebarCollapsed);
}

// ===================== v5 - MOBILE SIDEBAR =====================
function toggleMobileSidebar(){
    const sb=document.getElementById('sidebar');
    const ov=document.getElementById('mobile-overlay');
    const isOpen=sb.classList.contains('mobile-open');
    if(isOpen){
        sb.classList.remove('mobile-open');
        ov.classList.remove('active');
        document.body.style.overflow='';
    } else {
        sb.classList.add('mobile-open');
        ov.classList.add('active');
        document.body.style.overflow='hidden';
    }
}
function closeMobileSidebar(){
    if(window.innerWidth<=768){
        const sb=document.getElementById('sidebar');
        const ov=document.getElementById('mobile-overlay');
        sb.classList.remove('mobile-open');
        ov.classList.remove('active');
        document.body.style.overflow='';
    }
}

// ===================== v5 - THEME TOGGLE =====================
function toggleTheme(){
    S.theme=S.theme==='dark'?'light':'dark';
    document.documentElement.classList.toggle('dark',S.theme==='dark');
    document.documentElement.classList.toggle('light',S.theme==='light');
    save();renderSettings();showNotif('Tema degistirildi: '+(S.theme==='dark'?'Karanlik':'Aydin'));
}
function toggleUserMenu(){
    const popup=document.getElementById('user-menu-popup');
    if(!popup)return;
    const isOpen=popup.style.display!=='none';
    if(isOpen){
        popup.style.display='none';
    } else {
        // Update popup info
        if(currentUser){
            const initials=(currentUser.name||'').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
            const menuAvatar=document.getElementById('menu-user-avatar');
            const menuName=document.getElementById('menu-user-name');
            const menuRole=document.getElementById('menu-user-role');
            const menuEmail=document.getElementById('menu-user-email');
            if(menuAvatar)menuAvatar.textContent=initials;
            if(menuName)menuName.textContent=currentUser.name;
            if(menuRole)menuRole.textContent=currentUser.role;
            if(menuEmail)menuEmail.textContent=currentUser.email||'';
        }
        popup.style.display='block';
        // Close on outside click
        setTimeout(()=>{
            const closeHandler=function(e){
                if(!popup.contains(e.target)&&!document.getElementById('sidebar-user-btn').contains(e.target)){
                    popup.style.display='none';
                    document.removeEventListener('click',closeHandler);
                }
            };
            document.addEventListener('click',closeHandler);
        },10);
    }
}

// ===================== v5 - EXPORT DATA =====================
function exportData(){
    let csv='Tip,Ad,Tutar,Durum,Tarih\n';
    S.projects.forEach(p=>csv+=`Proje,"${p.name}",${p.budget},${stName(p.status)},${p.createdAt||''}\n`);
    S.tenders.forEach(t=>csv+=`Ihale,"${t.baslik||t.item||''}",${t.amount||0},${stName(t.status)},${t.createdAt||''}\n`);
    (S.satinalmaTalepleri||[]).forEach(t=>csv+=`Talep,"${t.talepNo}",${t.toplamTahmini||0},${talepDurumLabel(t.durum)},${t.createdAt||''}\n`);
    (S.orders||[]).forEach(o=>csv+=`Siparis,"${o.orderNo} - ${o.tedarikciAdi||o.supplier||''}",${o.toplamTutar||o.amount||0},${siparisDurumLabel(o.durum||'olusturuldu')},${o.createdAt||''}\n`);
    (S.tedarikcilerHavuzu||[]).forEach(t=>csv+=`Tedarikci,"${t.firma}",${t.toplamIsHacmi||0},-,${t.createdAt||''}\n`);
    S.sales.forEach(s=>csv+=`Satis,"${s.customer} - ${s.product}",${s.price},${stName(s.status)},${s.createdAt||''}\n`);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download='faonsist_export_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();URL.revokeObjectURL(url);showNotif('CSV dosyasi indirildi!');
}

// ===================== v5 - DRAG & DROP PIPELINE =====================
let draggedSaleId=null;
function onDragStartSale(e,id){draggedSaleId=id;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move';}
function onDragEndSale(e){e.target.classList.remove('dragging');draggedSaleId=null;}
function onDragOverStage(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDragLeaveStage(e){e.currentTarget.classList.remove('drag-over');}
function onDropStage(e,stage){
    e.preventDefault();e.currentTarget.classList.remove('drag-over');
    if(draggedSaleId!==null)moveSaleStage(draggedSaleId,stage);
}

// ===================== v5 - EMOJI PICKER =====================
const EMOJIS=['üòÄ','üòÇ','üòç','ü•∞','üòé','ü§î','üëç','üëé','‚ù§Ô∏è','üî•','‚≠ê','‚úÖ','‚ùå','üìå','üìé','üèóÔ∏è','üè†','üí∞','üìä','üìà','üîß','‚ö°','üéØ','üí™','üéâ','üôè','üë∑','üöß','üì¶','üîë','üìã','üíº'];
function toggleEmojiPicker(){
    const p=document.getElementById('emoji-picker');
    if(p.classList.contains('hidden')){
        p.classList.remove('hidden');
        const g=document.getElementById('emoji-grid');
        g.innerHTML=EMOJIS.map(e=>`<span class="text-center p-1 rounded hover:bg-gray-700 cursor-pointer" onclick="insertEmoji('${e}')">${e}</span>`).join('');
    }else{p.classList.add('hidden');}
}
function insertEmoji(e){
    const inp=document.getElementById('msg-input');inp.value+=e;inp.focus();
    document.getElementById('emoji-picker').classList.add('hidden');
}

// ===================== v5 - MESSAGE EDIT/DELETE =====================
function deleteMessage(id){
    confirmDelete('message',id,S.currentChannel);
}
function editMessage(id){
    const msgs=S.messages[S.currentChannel]||[];
    const m=msgs.find(x=>x.id===id);if(!m)return;
    document.getElementById('edit-msg-id').value=id;
    document.getElementById('edit-msg-text').value=m.text;
    openModal('modal-edit-msg');
}
function saveEditMessage(){
    const id=+document.getElementById('edit-msg-id').value;
    const txt=document.getElementById('edit-msg-text').value.trim();if(!txt)return;
    const msgs=S.messages[S.currentChannel]||[];
    const m=msgs.find(x=>x.id===id);if(m){m.text=txt;}
    save();renderMessages();closeModal('modal-edit-msg');showNotif('Mesaj duzenlendi.');
}

// ===================== v5 - EXPENSE TRACKING =====================
function openAddExpense(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('expense-project-id').value=projectId;
    document.getElementById('expense-project-name').textContent=p.name;
    document.getElementById('expense-amount').value='';
    document.getElementById('expense-desc').value='';
    openModal('modal-expense');
}
function addExpense(e){
    e.preventDefault();
    const pid=+document.getElementById('expense-project-id').value;
    const amount=+document.getElementById('expense-amount').value;
    const desc=document.getElementById('expense-desc').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    p.spent=(p.spent||0)+amount;
    if(!p.expenses)p.expenses=[];
    p.expenses.push({amount,desc,date:new Date().toISOString()});
    act('Harcama: '+p.name+' +\u20BA'+fmtFull(amount)+(desc?' ('+desc+')':''));
    save();renderAll();closeModal('modal-expense');showNotif('Harcama eklendi: \u20BA'+fmtFull(amount));
}

// ===================== v5 - TASK SYSTEM =====================
let currentTaskProjectId=null;
function openTaskPanel(projectId){
    currentTaskProjectId=projectId;
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('task-panel-title').textContent='Gorevler - '+p.name;
    document.getElementById('task-project-id').value=projectId;
    document.getElementById('task-input').value='';
    renderTasks();openModal('modal-tasks');
}
function renderTasks(){
    const p=S.projects.find(x=>x.id===currentTaskProjectId);if(!p)return;
    if(!p.tasks)p.tasks=[];
    const c=document.getElementById('task-list');
    if(p.tasks.length===0){c.innerHTML='<p class="text-xs text-gray-500 text-center py-4">Henuz gorev eklenmedi.</p>';return;}
    c.innerHTML=p.tasks.map((t,i)=>`<div class="flex items-center gap-3 p-3 rounded-lg ${t.done?'bg-green-500/5 border border-green-500/20':'bg-gray-800/30'}">
        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})" class="w-4 h-4 rounded accent-green-500 cursor-pointer">
        <span class="flex-1 text-sm ${t.done?'line-through text-gray-500':''}">${t.text}</span>
        <button onclick="removeTask(${i})" class="text-gray-600 hover:text-red-400 text-xs">&times;</button>
    </div>`).join('');
}
function addTask(){
    const inp=document.getElementById('task-input');const txt=inp.value.trim();if(!txt)return;
    const p=S.projects.find(x=>x.id===currentTaskProjectId);if(!p)return;
    if(!p.tasks)p.tasks=[];
    p.tasks.push({text:txt,done:false,createdAt:new Date().toISOString()});
    inp.value='';act('Gorev eklendi: '+txt);save();renderTasks();renderAll();
}
function toggleTask(i){
    const p=S.projects.find(x=>x.id===currentTaskProjectId);if(!p||!p.tasks[i])return;
    p.tasks[i].done=!p.tasks[i].done;save();renderTasks();
}
function removeTask(i){
    const p=S.projects.find(x=>x.id===currentTaskProjectId);if(!p||!p.tasks)return;
    p.tasks.splice(i,1);save();renderTasks();renderAll();
}

// ===================== SIPARIS & TESLIMAT =====================
function convertToOrder(tenderId){ihaledenSiparisOlustur(tenderId);}
function ihaledenSiparisOlustur(ihaleId){
    const t=S.tenders.find(x=>x.id===ihaleId);if(!t)return;
    if(!S.orders)S.orders=[];
    // Mevcut sipari≈ü kontrol√º
    if(S.orders.find(o=>o.ihaleId===ihaleId)){showNotif('Bu ihale icin zaten siparis olusturulmus!');return;}
    const kazanan=t.kazananTeklifId?(t.teklifler||[]).find(x=>x.id===t.kazananTeklifId):null;
    const orderNo=nextSiparisNo();
    const kalemler=(t.kalemler||[]).map((k,i)=>{
        const birimFiyat=kazanan&&kazanan.birimFiyatlar[i]?kazanan.birimFiyatlar[i]:(t.amount||0);
        return{malzeme:k.malzeme,miktar:k.miktar,birim:k.birim,birimFiyat,toplam:birimFiyat*k.miktar};
    });
    if(kalemler.length===0)kalemler.push({malzeme:t.item||t.baslik,miktar:1,birim:'adet',birimFiyat:t.amount||0,toplam:t.amount||0});
    const toplamTutar=kalemler.reduce((s,k)=>s+k.toplam,0);
    const tedarikciId=kazanan?kazanan.tedarikciId:null;
    const tedarikciAdi=kazanan?kazanan.tedarikciAdi:(t.supplier||'');
    const teslimatGun=kazanan?kazanan.teslimat:(t.delivery||14);
    const bpiTarih=new Date();bpiTarih.setDate(bpiTarih.getDate()+teslimatGun);
    S.orders.push({id:Date.now(),orderNo,ihaleId:t.id,projectId:t.projectId||'',tedarikciId,tedarikciAdi,kalemler,toplamTutar,odemeKosulu:kazanan?kazanan.odemeKosulu:'',durum:'olusturuldu',teslimatlar:[],bpiGun:teslimatGun,bpiTarih:bpiTarih.toISOString(),item:t.item||t.baslik,supplier:tedarikciAdi,amount:toplamTutar,status:'ordered',createdAt:new Date().toISOString()});
    // Tedarik√ßi havuzunu g√ºncelle
    if(tedarikciId){
        const td=S.tedarikcilerHavuzu.find(x=>x.id===tedarikciId);
        if(td){td.toplamIsHacmi=(td.toplamIsHacmi||0)+toplamTutar;td.ihaleSayisi=(td.ihaleSayisi||0)+1;}
    }
    act('Siparis olusturuldu: '+orderNo+' - '+(t.baslik||t.item));save();renderAll();
    showNotif('Siparis olusturuldu: '+orderNo);
}
function renderSiparisler(){
    const c=document.getElementById('siparisler-list');if(!c)return;
    const orders=S.orders||[];
    if(orders.length===0){c.innerHTML='<div class="glass rounded-xl p-8 text-center"><p class="text-gray-500 text-sm">Henuz siparis yok. Onaylanan ihaleleri siparise donusturun.</p></div>';return;}
    let html='<div class="grid grid-cols-4 gap-3 mb-4">';
    const counts={olusturuldu:0,gonderildi:0,kismiTeslimat:0,tamamlandi:0};
    orders.forEach(o=>{const d=o.durum||'olusturuldu';counts[d]=(counts[d]||0)+1;});
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Olusturuldu</p><p class="text-xl font-bold text-gray-400">${counts.olusturuldu}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Gonderildi</p><p class="text-xl font-bold text-blue-400">${counts.gonderildi}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Kismi Teslimat</p><p class="text-xl font-bold text-yellow-400">${counts.kismiTeslimat}</p></div>`;
    html+=`<div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-500">Tamamlandi</p><p class="text-xl font-bold text-green-400">${counts.tamamlandi}</p></div>`;
    html+='</div>';
    orders.slice().reverse().forEach(o=>{
        const proj=o.projectId?S.projects.find(p=>p.id===o.projectId):null;
        const durum=o.durum||'olusturuldu';
        const teslimatSayisi=(o.teslimatlar||[]).length;
        const bpiStr=o.bpiTarih?new Date(o.bpiTarih).toLocaleDateString('tr-TR'):'';
        html+=`<div class="glass rounded-xl p-5 mb-3">
            <div class="flex items-start justify-between mb-3">
                <div><h4 class="font-bold text-sm">${o.orderNo} <span class="text-[10px] text-gray-500 font-normal">${proj?proj.name:''}</span></h4>
                <p class="text-[10px] text-gray-500">${o.tedarikciAdi||o.supplier||''} | ${(o.kalemler||[]).length} kalem${bpiStr?' | Termin: '+bpiStr:''}</p></div>
                <div class="flex items-center gap-2">
                    ${teslimatSayisi>0?`<span class="text-[9px] bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">${teslimatSayisi} teslimat</span>`:''}
                    <span class="status-${durum}">${siparisDurumLabel(durum)}</span>
                </div>
            </div>
            <p class="text-lg font-bold text-orange-400 mb-3">\u20BA${fmtFull(o.toplamTutar||o.amount||0)}</p>
            <div class="flex gap-2 flex-wrap">
                <button onclick="openSiparisDetay(${o.id})" class="px-3 py-1.5 bg-gray-600/30 text-gray-300 hover:bg-gray-600/50 rounded text-xs transition-colors">Detay</button>
                ${durum==='olusturuldu'?`<button onclick="updateSiparisDurum(${o.id},'gonderildi')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">Tedarikciye Gonder</button>`:''}
                ${durum==='gonderildi'||durum==='kismiTeslimat'?`<button onclick="openTeslimatForm(${o.id})" class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 rounded text-xs transition-colors">Teslimat Kaydet</button>`:''}
            </div></div>`;
    });
    c.innerHTML=html;
}
function openSiparisDetay(orderId){
    const o=(S.orders||[]).find(x=>x.id===orderId);if(!o)return;
    const c=document.getElementById('siparis-detay-content');
    const proj=o.projectId?S.projects.find(p=>p.id===o.projectId):null;
    let html=`<div class="space-y-4">
        <div class="flex items-center justify-between">
            <div><h3 class="text-lg font-bold">${o.orderNo}</h3>
            <p class="text-xs text-gray-500">${o.tedarikciAdi||o.supplier||''} ${proj?'| '+proj.name:''} | <span class="status-${o.durum||'olusturuldu'}">${siparisDurumLabel(o.durum||'olusturuldu')}</span></p></div>
        </div>
        <div><h4 class="text-sm font-semibold mb-2">Siparis Kalemleri</h4>
        <table class="w-full text-xs glass rounded-xl overflow-hidden"><thead class="bg-gray-800/50"><tr class="text-left text-gray-400"><th class="p-2">Malzeme</th><th class="p-2 text-right">Miktar</th><th class="p-2">Birim</th><th class="p-2 text-right">Birim Fiyat</th><th class="p-2 text-right">Toplam</th></tr></thead><tbody>`;
    (o.kalemler||[]).forEach(k=>{
        html+=`<tr class="border-t border-gray-800"><td class="p-2">${k.malzeme}</td><td class="p-2 text-right">${k.miktar}</td><td class="p-2">${k.birim}</td><td class="p-2 text-right">\u20BA${fmtFull(k.birimFiyat||0)}</td><td class="p-2 text-right font-semibold">\u20BA${fmtFull(k.toplam||0)}</td></tr>`;
    });
    html+=`<tr class="border-t-2 border-gray-700"><td colspan="4" class="p-2 text-right font-semibold">Toplam:</td><td class="p-2 text-right font-bold text-orange-400">\u20BA${fmtFull(o.toplamTutar||o.amount||0)}</td></tr></tbody></table></div>`;
    // Teslimat timeline
    const teslimatlar=o.teslimatlar||[];
    html+=`<div><h4 class="text-sm font-semibold mb-2">Teslimat Gecmisi (${teslimatlar.length})</h4>`;
    if(teslimatlar.length===0){
        html+=`<p class="text-xs text-gray-500">Henuz teslimat kaydedilmedi.</p>`;
    }else{
        html+=`<div class="space-y-2">`;
        teslimatlar.forEach(tl=>{
            html+=`<div class="flex items-center gap-3 glass rounded-lg p-3">
                <div class="w-8 h-8 rounded-full bg-cyan-500/10 flex items-center justify-center"><span class="text-cyan-400 text-xs">&#128666;</span></div>
                <div class="flex-1"><p class="text-xs font-medium">${tl.malzeme} ‚Äî ${tl.miktar} ${tl.birim||'adet'}</p>
                <p class="text-[10px] text-gray-500">${tl.tarih?new Date(tl.tarih).toLocaleDateString('tr-TR'):''} ${tl.irsaliyeNo?'| Irsaliye: '+tl.irsaliyeNo:''}</p></div>
            </div>`;
        });
        html+=`</div>`;
    }
    html+=`</div>
        <div class="flex gap-2">
            ${o.durum!=='tamamlandi'&&o.durum!=='iptal'?`<button onclick="openTeslimatForm(${o.id})" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-sm transition-colors">Teslimat Kaydet</button>`:''}
            ${o.durum!=='tamamlandi'&&o.durum!=='iptal'?`<button onclick="updateSiparisDurum(${o.id},'tamamlandi');closeModal('modal-siparis-detay')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-colors">Tamamlandi Isaretle</button>`:''}
            ${o.durum!=='iptal'&&o.durum!=='tamamlandi'?`<button onclick="updateSiparisDurum(${o.id},'iptal');closeModal('modal-siparis-detay')" class="px-4 py-2 bg-red-600/30 text-red-400 hover:bg-red-600/50 rounded-lg text-sm transition-colors">Iptal Et</button>`:''}
        </div></div>`;
    c.innerHTML=html;
    openModal('modal-siparis-detay');
}
function updateSiparisDurum(orderId,yeniDurum){
    const o=(S.orders||[]).find(x=>x.id===orderId);if(!o)return;
    if(yeniDurum==='tamamlandi'){
        const deliveredQty={};(o.teslimatlar||[]).forEach(t=>{deliveredQty[t.malzeme]=(deliveredQty[t.malzeme]||0)+t.miktar;});
        const missing=(o.kalemler||[]).filter(k=>(deliveredQty[k.malzeme]||0)<k.miktar);
        if(missing.length>0){const names=missing.map(m=>m.malzeme+' ('+((deliveredQty[m.malzeme]||0))+'/'+m.miktar+')').join(', ');if(!confirm('Eksik teslimat var: '+names+'\nYine de tamamlansin mi?'))return;}
    }
    o.durum=yeniDurum;o.status=yeniDurum==='tamamlandi'?'delivered':yeniDurum==='iptal'?'cancelled':'ordered';
    act('Siparis '+o.orderNo+' durumu: '+siparisDurumLabel(yeniDurum));save();renderSiparisler();showNotif('Siparis durumu guncellendi!');
}
function openTeslimatForm(orderId){
    const form=document.querySelector('#modal-teslimat form');form.reset();
    document.getElementById('teslimat-siparis-id').value=orderId;
    const o=(S.orders||[]).find(x=>x.id===orderId);if(!o)return;
    const sel=document.getElementById('teslimat-malzeme');
    sel.innerHTML='';
    (o.kalemler||[]).forEach(k=>{sel.innerHTML+=`<option value="${k.malzeme}">${k.malzeme} (${k.miktar} ${k.birim})</option>`;});
    if(sel.options.length===0)sel.innerHTML=`<option value="${o.item||'Malzeme'}">${o.item||'Malzeme'}</option>`;
    document.getElementById('teslimat-tarih').value=new Date().toISOString().slice(0,10);
    const depoSel=document.getElementById('teslimat-depo');
    depoSel.innerHTML='<option value="">Seciniz...</option>'+(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    openModal('modal-teslimat');
}
function addTeslimat(e){
    e.preventDefault();if(!enforceAccess('add_teslimat','supply'))return;const f=new FormData(e.target);
    const orderId=+document.getElementById('teslimat-siparis-id').value;
    const o=(S.orders||[]).find(x=>x.id===orderId);if(!o)return;
    if(!o.teslimatlar)o.teslimatlar=[];
    const malzeme=f.get('malzeme')||'';
    const miktar=+f.get('miktar')||0;
    const depoId=parseInt(f.get('depoId'))||null;
    const irsaliyeNo=f.get('irsaliyeNo')||'';
    const tarih=f.get('tarih')||new Date().toISOString().slice(0,10);
    o.teslimatlar.push({id:Date.now(),tarih,miktar,birim:'adet',malzeme,irsaliyeNo,notlar:f.get('notlar')||''});
    if(o.durum==='gonderildi')o.durum='kismiTeslimat';
    // ===== OTOMATIK DEPO STOK GIRISI =====
    if(depoId&&miktar>0){
        if(!S.depoHareketler)S.depoHareketler=[];
        // Envanterde eslesme ara
        let envanterItem=(S.envanter||[]).find(i=>i.ad.toLowerCase().trim()===malzeme.toLowerCase().trim()&&i.depoId===depoId);
        if(!envanterItem)envanterItem=(S.envanter||[]).find(i=>i.ad.toLowerCase().trim()===malzeme.toLowerCase().trim());
        if(!envanterItem){
            const kalem=(o.kalemler||[]).find(k=>k.malzeme===malzeme);
            envanterItem={id:Date.now()+1,ad:malzeme,kategori:'diger',depoId:depoId,barkod:'',birim:kalem?kalem.birim:'adet',miktar:0,minStok:0,birimFiyat:kalem?kalem.birimFiyat:0,tedarikci:o.tedarikciAdi||'',notlar:'Otomatik - '+o.orderNo,createdAt:new Date().toISOString()};
            if(!S.envanter)S.envanter=[];
            S.envanter.push(envanterItem);
        }
        envanterItem.miktar+=miktar;
        S.depoHareketler.push({id:Date.now()+2,tarih,envanterItemId:envanterItem.id,tip:'giris',miktar,kaynakDepoId:null,hedefDepoId:depoId,projectId:null,irsaliyeNo,aciklama:'Siparis teslimat: '+o.orderNo+' - '+malzeme,durum:'tamamlandi',talepEden:'',aciliyet:'normal',onaylayan:'',sourceOrderId:o.id});
    }
    act('Teslimat kaydedildi: '+o.orderNo+' - '+malzeme+' x'+miktar);
    save();renderSiparisler();closeModal('modal-teslimat');e.target.reset();showNotif('Teslimat kaydedildi!'+(depoId?' Stok girisi yapildi.':''));
}

// ===================== v5 - CUSTOMER DETAIL =====================
function openCustomerDetail(saleId){
    const s=S.sales.find(x=>x.id===saleId);if(!s)return;
    document.getElementById('customer-title').textContent=s.customer;
    const paidPct=s.price>0?Math.round(s.paid/s.price*100):0;
    const perInst=s.installments>0?Math.floor(s.price/s.installments):s.price;
    const paidCount=perInst>0?Math.floor(s.paid/perInst):0;
    const allSales=S.sales.filter(x=>x.customer===s.customer);
    const totalSpent=allSales.reduce((sum,x)=>sum+x.price,0);
    document.getElementById('customer-content').innerHTML=`
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500 mb-1">Musteri</p><p class="text-lg font-bold">${s.customer}</p><p class="text-xs text-gray-400 mt-1">${s.phone||'Telefon belirtilmedi'}</p></div>
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500 mb-1">Toplam Harcama</p><p class="text-lg font-bold text-green-400">\u20BA${fmtFull(totalSpent)}</p><p class="text-xs text-gray-400 mt-1">${allSales.length} adet islem</p></div>
        </div>
        <div class="glass rounded-xl p-4 mb-4">
            <h4 class="text-sm font-semibold mb-3">Mevcut Satis</h4>
            <div class="grid grid-cols-4 gap-3 text-xs mb-3">
                <div><span class="text-gray-500">Urun</span><p class="font-semibold mt-1">${s.product}</p></div>
                <div><span class="text-gray-500">Fiyat</span><p class="font-semibold mt-1 text-green-400">\u20BA${fmtFull(s.price)}</p></div>
                <div><span class="text-gray-500">Asama</span><p class="mt-1"><span class="status-${s.stage}">${stName(s.stage)}</span></p></div>
                <div><span class="text-gray-500">Durum</span><p class="mt-1"><span class="status-${s.status}">${stName(s.status)}</span></p></div>
            </div>
            <div class="flex items-center gap-3 text-xs"><span class="text-gray-500">Odeme:</span><div class="flex-1 progress-bar"><div class="progress-fill bg-green-500" style="width:${paidPct}%"></div></div><span class="font-semibold">${paidPct}% (\u20BA${fmtFull(s.paid)} / \u20BA${fmtFull(s.price)})</span></div>
        </div>
        ${s.installments>1?`<div class="glass rounded-xl p-4 mb-4">
            <h4 class="text-sm font-semibold mb-3">Taksit Plani</h4>
            <div class="space-y-2">${Array.from({length:s.installments},(_, idx)=>{
                const isPaid=idx<paidCount;
                return `<div class="flex items-center gap-3 p-2 rounded-lg ${isPaid?'bg-green-500/5':'bg-gray-800/20'}"><span class="w-6 h-6 rounded-full ${isPaid?'bg-green-500':'bg-gray-700'} flex items-center justify-center text-[10px] font-bold">${idx+1}</span><span class="flex-1 text-xs">${isPaid?'Odendi':'Bekliyor'}</span><span class="text-xs font-semibold">\u20BA${fmtFull(perInst)}</span></div>`;
            }).join('')}</div>
        </div>`:''}
        ${allSales.length>1?`<div class="glass rounded-xl p-4"><h4 class="text-sm font-semibold mb-3">Diger Satislar (${allSales.length-1})</h4><div class="space-y-2">${allSales.filter(x=>x.id!==s.id).map(x=>`<div class="flex items-center justify-between p-2 rounded-lg bg-gray-800/20"><span class="text-xs">${x.product}</span><span class="text-xs font-semibold">\u20BA${fmtFull(x.price)}</span></div>`).join('')}</div></div>`:''}`;
    openModal('modal-customer');
}

// ===================== v5 - DATE FILTER FOR REPORTS =====================
function clearDateFilter(){
    const ds=document.getElementById('report-date-start');
    const de=document.getElementById('report-date-end');
    if(ds)ds.value='';
    if(de)de.value='';
    renderReports();
}

// ===================== SUPPLY OZET (DASHBOARD) =====================
function renderSupplyOzet(){
    const c=document.getElementById('supply-ozet-view');if(!c)return;
    const talepler=S.satinalmaTalepleri||[];
    const ihaleler=S.tenders||[];
    const siparisler=S.orders||[];
    const tedarikciler=S.tedarikcilerHavuzu||[];
    const bekleyenTalep=talepler.filter(t=>t.durum==='onayBekliyor').length;
    const aktifIhale=ihaleler.filter(t=>t.status==='pending'||t.status==='reviewing').length;
    const acikSiparis=siparisler.filter(o=>o.durum!=='tamamlandi'&&o.durum!=='iptal').length;
    const yaklasTeslimat=siparisler.filter(o=>{if(!o.bpiTarih||o.durum==='tamamlandi'||o.durum==='iptal')return false;const d=new Date(o.bpiTarih);const now=new Date();const diff=(d-now)/(1000*60*60*24);return diff<=7&&diff>=-3;}).length;
    let html=`<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="glass rounded-xl p-4 text-center cursor-pointer hover:bg-gray-800/30 transition-colors" onclick="switchSupplyTab('talepler')"><p class="text-[10px] text-gray-500 mb-1">Bekleyen Talepler</p><p class="text-2xl font-bold text-yellow-400">${bekleyenTalep}</p></div>
        <div class="glass rounded-xl p-4 text-center cursor-pointer hover:bg-gray-800/30 transition-colors" onclick="switchSupplyTab('ihaleler')"><p class="text-[10px] text-gray-500 mb-1">Aktif Ihaleler</p><p class="text-2xl font-bold text-blue-400">${aktifIhale}</p></div>
        <div class="glass rounded-xl p-4 text-center cursor-pointer hover:bg-gray-800/30 transition-colors" onclick="switchSupplyTab('siparisler')"><p class="text-[10px] text-gray-500 mb-1">Acik Siparisler</p><p class="text-2xl font-bold text-orange-400">${acikSiparis}</p></div>
        <div class="glass rounded-xl p-4 text-center cursor-pointer hover:bg-gray-800/30 transition-colors" onclick="switchSupplyTab('siparisler')"><p class="text-[10px] text-gray-500 mb-1">Yaklasan Teslimat</p><p class="text-2xl font-bold text-cyan-400">${yaklasTeslimat}</p></div>
    </div>`;
    // Satƒ±nalma akƒ±≈ü grafiƒüi
    const toplamTalepTutar=talepler.reduce((s,t)=>s+(t.toplamTahmini||0),0);
    const toplamIhaleTutar=ihaleler.filter(t=>t.status==='approved').reduce((s,t)=>s+(t.amount||0),0);
    const toplamSiparisTutar=siparisler.reduce((s,o)=>s+(o.toplamTutar||o.amount||0),0);
    html+=`<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="glass rounded-xl p-5">
            <h4 class="text-sm font-semibold mb-3">Satinalma Ozeti</h4>
            <div class="space-y-3">
                <div class="flex items-center justify-between text-xs"><span class="text-gray-400">Toplam Talep Tutari</span><span class="font-semibold">\u20BA${fmtFull(toplamTalepTutar)}</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-gray-400">Onaylanan Ihale Tutari</span><span class="font-semibold text-green-400">\u20BA${fmtFull(toplamIhaleTutar)}</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-gray-400">Siparis Tutari</span><span class="font-semibold text-orange-400">\u20BA${fmtFull(toplamSiparisTutar)}</span></div>
                <div class="flex items-center justify-between text-xs"><span class="text-gray-400">Tedarikci Sayisi</span><span class="font-semibold">${tedarikciler.length}</span></div>
            </div>
        </div>
        <div class="glass rounded-xl p-5">
            <h4 class="text-sm font-semibold mb-3">En Iyi Tedarikciler</h4>`;
    const topTed=[...tedarikciler].filter(t=>!t.karaListe).sort((a,b)=>(b.toplamIsHacmi||0)-(a.toplamIsHacmi||0)).slice(0,5);
    if(topTed.length===0){
        html+=`<p class="text-xs text-gray-500">Tedarikci verisi yok.</p>`;
    }else{
        html+=`<div class="space-y-2">`;
        topTed.forEach((td,i)=>{
            const perf=td.performans||{};
            html+=`<div class="flex items-center justify-between text-xs p-2 rounded-lg bg-gray-800/20">
                <div class="flex items-center gap-2"><span class="text-[10px] font-bold text-gray-500">${i+1}</span><span class="font-medium">${td.firma}</span></div>
                <div class="flex items-center gap-3"><span class="text-gray-400">\u20BA${fmtFull(td.toplamIsHacmi||0)}</span><span class="text-yellow-400">${(perf.kalitePuani||0).toFixed(1)}/5</span></div></div>`;
        });
        html+=`</div>`;
    }
    html+=`</div></div>`;
    // Yakla≈üan teslimatlar
    const yaklasTeslimatlar=siparisler.filter(o=>o.bpiTarih&&o.durum!=='tamamlandi'&&o.durum!=='iptal').sort((a,b)=>new Date(a.bpiTarih)-new Date(b.bpiTarih)).slice(0,5);
    html+=`<div class="glass rounded-xl p-5">
        <h4 class="text-sm font-semibold mb-3">Yaklasan Teslimatlar</h4>`;
    if(yaklasTeslimatlar.length===0){
        html+=`<p class="text-xs text-gray-500">Yaklasan teslimat yok.</p>`;
    }else{
        html+=`<div class="space-y-2">`;
        yaklasTeslimatlar.forEach(o=>{
            const bpi=new Date(o.bpiTarih);const now=new Date();const kalan=Math.ceil((bpi-now)/(1000*60*60*24));
            const kalanClass=kalan<0?'text-red-400':kalan<=3?'text-orange-400':kalan<=7?'text-yellow-400':'text-green-400';
            html+=`<div class="flex items-center justify-between text-xs p-2 rounded-lg bg-gray-800/20 cursor-pointer hover:bg-gray-800/40" onclick="openSiparisDetay(${o.id})">
                <div><span class="font-mono text-[10px] text-gray-500">${o.orderNo}</span> <span class="font-medium ml-1">${o.tedarikciAdi||o.supplier||''}</span></div>
                <div class="flex items-center gap-2"><span class="text-gray-400">${bpi.toLocaleDateString('tr-TR')}</span><span class="${kalanClass} font-semibold">${kalan<0?Math.abs(kalan)+' gun gecikme':kalan+' gun'}</span></div></div>`;
        });
        html+=`</div>`;
    }
    html+=`</div>`;
    c.innerHTML=html;
}

// ===================== v5 - DASHBOARD WIDGETS =====================
function renderDashWidgets(){
    const tc=document.getElementById('dash-recent-tenders');
    if(S.tenders.length===0){tc.innerHTML='<p class="text-xs text-gray-500">Ihale yok.</p>';}
    else{tc.innerHTML=S.tenders.slice(-3).reverse().map(t=>{const tutar=t.amount||t.toplamTutar||(t.teklifler&&t.teklifler.length>0?Math.min(...t.teklifler.map(tk=>tk.toplamFiyat||0)):0);return `<div class="flex items-center justify-between p-2 rounded-lg bg-gray-800/20"><span class="text-xs truncate flex-1">${t.baslik||t.item||'Ihale'}</span><span class="text-xs font-semibold ml-2">\u20BA${fmt(tutar)}</span><span class="status-${t.status} ml-2 text-[9px]">${stName(t.status)}</span></div>`;}).join('');}
    const sc=document.getElementById('dash-recent-sales');
    if(S.sales.length===0){sc.innerHTML='<p class="text-xs text-gray-500">Satis yok.</p>';}
    else{sc.innerHTML=S.sales.slice(-3).reverse().map(s=>`<div class="flex items-center justify-between p-2 rounded-lg bg-gray-800/20"><span class="text-xs truncate flex-1">${s.customer}</span><span class="text-xs font-semibold ml-2">\u20BA${fmt(s.price)}</span><span class="status-${s.status} ml-2 text-[9px]">${stName(s.stage)}</span></div>`).join('');}
}

// ===================== v5 - GANTT/CALENDAR =====================
function renderCalendar(){
    const c=document.getElementById('calendar-view');
    if(!c)return;
    const now=new Date();const year=now.getFullYear();const month=now.getMonth();
    const firstDay=new Date(year,month,1).getDay();const daysInMonth=new Date(year,month+1,0).getDate();
    const monthNames=['Ocak','Subat','Mart','Nisan','Mayis','Haziran','Temmuz','Agustos','Eylul','Ekim','Kasim','Aralik'];
    let html=`<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">${monthNames[month]} ${year}</h4><div class="flex gap-2"><button onclick="changeCalMonth(-1)" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-gray-600">&lt;</button><button onclick="changeCalMonth(1)" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-gray-600">&gt;</button></div></div>`;
    html+=`<div class="grid grid-cols-7 gap-1 text-center text-[10px] text-gray-500 mb-2"><span>Pzt</span><span>Sal</span><span>Car</span><span>Per</span><span>Cum</span><span>Cmt</span><span>Paz</span></div>`;
    html+=`<div class="grid grid-cols-7 gap-1">`;
    const adj=(firstDay+6)%7;
    for(let i=0;i<adj;i++)html+=`<div class="h-16 rounded bg-gray-800/10"></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const isToday=d===now.getDate()&&month===now.getMonth();
        const dayEvents=[];
        S.tenders.forEach(t=>{if(t.delivery&&t.createdAt){const dd=new Date(t.createdAt);dd.setDate(dd.getDate()+t.delivery);if(dd.getDate()===d&&dd.getMonth()===month)dayEvents.push({type:'tender',name:t.item.substring(0,15)});}});
        html+=`<div class="h-16 rounded p-1 ${isToday?'bg-blue-500/10 border border-blue-500/30':'bg-gray-800/20 hover:bg-gray-800/40'} cursor-pointer transition-colors"><span class="text-[10px] font-semibold ${isToday?'text-blue-400':''}">${d}</span>${dayEvents.map(e=>`<div class="text-[8px] mt-0.5 px-1 rounded bg-orange-500/20 text-orange-400 truncate">${e.name}</div>`).join('')}</div>`;
    }
    html+=`</div>`;
    c.innerHTML=html;
}
let calOffset=0;
function changeCalMonth(dir){calOffset+=dir;const now=new Date();now.setMonth(now.getMonth()+calOffset);renderCalendarForDate(now);}
function renderCalendarForDate(d){
    const c=document.getElementById('calendar-view');
    if(!c)return;
    const year=d.getFullYear();const month=d.getMonth();
    const firstDay=new Date(year,month,1).getDay();const daysInMonth=new Date(year,month+1,0).getDate();
    const monthNames=['Ocak','Subat','Mart','Nisan','Mayis','Haziran','Temmuz','Agustos','Eylul','Ekim','Kasim','Aralik'];
    const now=new Date();
    let html=`<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">${monthNames[month]} ${year}</h4><div class="flex gap-2"><button onclick="changeCalMonth(-1)" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-gray-600">&lt;</button><button onclick="changeCalMonth(1)" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-gray-600">&gt;</button></div></div>`;
    html+=`<div class="grid grid-cols-7 gap-1 text-center text-[10px] text-gray-500 mb-2"><span>Pzt</span><span>Sal</span><span>Car</span><span>Per</span><span>Cum</span><span>Cmt</span><span>Paz</span></div><div class="grid grid-cols-7 gap-1">`;
    const adj=(firstDay+6)%7;
    for(let i=0;i<adj;i++)html+=`<div class="h-16 rounded bg-gray-800/10"></div>`;
    for(let dd=1;dd<=daysInMonth;dd++){
        const isToday=dd===now.getDate()&&month===now.getMonth()&&year===now.getFullYear();
        html+=`<div class="h-16 rounded p-1 ${isToday?'bg-blue-500/10 border border-blue-500/30':'bg-gray-800/20'} text-[10px]"><span class="font-semibold ${isToday?'text-blue-400':''}">${dd}</span></div>`;
    }
    html+=`</div>`;c.innerHTML=html;
}

// ===================== v5 - FILES MANAGEMENT =====================
function renderFiles(){
    const c=document.getElementById('files-view');
    if(!S.files)S.files=[];
    let html=`<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Proje Dokumanlari</h4><button onclick="addDemoFile()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">+ Dokuman Ekle</button></div>`;
    if(S.files.length===0){
        S.files=[
            {id:1,name:'Hakedis_Raporu_Ocak.pdf',project:'Atasehir Rezidans A Blok',size:'2.4 MB',type:'pdf',date:'2025-01-15'},
            {id:2,name:'Insaat_Plani_v3.dwg',project:'Cengelkoy Villa Projesi',size:'15.8 MB',type:'dwg',date:'2025-01-20'},
            {id:3,name:'Malzeme_Listesi.xlsx',project:'Kadikoy Ofis Binasi',size:'540 KB',type:'xlsx',date:'2025-02-01'},
            {id:4,name:'Sozlesme_ASM.pdf',project:'Atasehir Rezidans A Blok',size:'1.1 MB',type:'pdf',date:'2024-12-10'},
            {id:5,name:'Santiye_Fotograf.jpg',project:'Cengelkoy Villa Projesi',size:'3.2 MB',type:'img',date:'2025-02-05'}
        ];save();
    }
    const icons={pdf:'text-red-400',dwg:'text-blue-400',xlsx:'text-green-400',img:'text-yellow-400',doc:'text-blue-300'};
    html+=`<div class="space-y-2">${S.files.map(f=>`<div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/20 hover:bg-gray-800/40 transition-colors cursor-pointer">
        <div class="w-10 h-10 rounded-lg bg-gray-700/50 flex items-center justify-center"><span class="text-xs font-bold ${icons[f.type]||'text-gray-400'}">${(f.type||'').toUpperCase()}</span></div>
        <div class="flex-1 min-w-0"><p class="text-sm font-medium truncate">${f.name}</p><p class="text-[10px] text-gray-500">${f.project} &middot; ${f.size} &middot; ${f.date}</p></div>
        <button onclick="removeFile(${f.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button>
    </div>`).join('')}</div>`;
    c.innerHTML=html;
}
function addDemoFile(){
    if(!S.files)S.files=[];
    const names=['Metraj_Hesabi.xlsx','Tasarim_Dosyasi.pdf','Revize_Plan.dwg','Maliyet_Analizi.xlsx','Toplanti_Notu.doc'];
    const n=names[Math.floor(Math.random()*names.length)];
    S.files.push({id:Date.now(),name:n,project:S.projects.length>0?S.projects[0].name:'Genel',size:Math.floor(Math.random()*10+1)+'.'+Math.floor(Math.random()*9)+'MB',type:n.split('.').pop(),date:new Date().toISOString().slice(0,10)});
    save();renderFiles();showNotif('Dokuman eklendi: '+n);
}
function removeFile(id){if(!S.files)return;S.files=S.files.filter(f=>f.id!==id);save();renderFiles();}

// ===================== ORDERS LIST (legacy wrapper) =====================
function renderOrders(){renderSiparisler();}

// ===================== v5 - LOGIN SYSTEM =====================
let isLoggedIn=false;let currentUser=S.users[0];
function showLogin(){
    document.getElementById('main-app').style.display='none';
    document.getElementById('login-screen').style.display='flex';
    document.getElementById('landing-page').style.display='none';
}
function showLandingPage(){
    document.getElementById('main-app').style.display='none';
    document.getElementById('login-screen').style.display='none';
    document.getElementById('landing-page').style.display='block';
    document.body.style.overflow='auto';
    window.scrollTo(0,0);
}
function goToLogin(){
    document.getElementById('landing-page').style.display='none';
    document.getElementById('login-screen').style.display='flex';
    document.getElementById('main-app').style.display='none';
    document.body.style.overflow='hidden';
}
function quickDemoLogin(userId){
    const user=S.users.find(u=>u.id===userId);
    if(!user)return;
    currentUser=user;
    isLoggedIn=true;
    completeLogin();
}
async function doLogin(e){
    if(e)e.preventDefault();
    const email=document.getElementById('login-email').value.trim();
    const pw=document.getElementById('login-pass').value;
    const errEl=document.getElementById('login-error');
    const btn=document.getElementById('login-btn');
    errEl.classList.add('hidden');
    btn.textContent='Giris yapiliyor...';btn.disabled=true;

    // Backend login dene
    if(backendAvailable){
        try{
            const r=await fetch(API_BASE+'/api/auth/login',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({email,password:pw})
            });
            const d=await r.json();
            if(d.success){
                authToken=d.data.token;
                refreshToken=d.data.refreshToken;
                try{localStorage.setItem('faonsist-token',authToken);}catch(e){}
                currentUser={id:d.data.user.id,name:d.data.user.name,email:d.data.user.email,phone:d.data.user.phone,role:d.data.user.role,perms:d.data.user.permissions};
                isLoggedIn=true;
                // Backend'den state yukle
                await load();
                completeLogin();
                btn.textContent='Giris Yap';btn.disabled=false;
                return;
            }else{
                errEl.textContent=d.error?.message||'Giris basarisiz';
                errEl.classList.remove('hidden');
                btn.textContent='Giris Yap';btn.disabled=false;
                return;
            }
        }catch(err){
            console.warn('Backend login basarisiz, local login deneniyor:',err);
        }
    }

    // Fallback: Local login (phone veya email ile)
    const user=S.users.find(u=>u.email===email||u.phone===email.replace(/\s/g,''));
    if(!user){errEl.textContent='Kullanici bulunamadi!';errEl.classList.remove('hidden');btn.textContent='Giris Yap';btn.disabled=false;return;}
    if(pw!==(user.password||'1234')){errEl.textContent='Hatali sifre!';errEl.classList.remove('hidden');btn.textContent='Giris Yap';btn.disabled=false;return;}
    currentUser=user;isLoggedIn=true;
    completeLogin();
    btn.textContent='Giris Yap';btn.disabled=false;
}

function completeLogin(){
    // Ensure currentUser always points to latest S.users data
    if(currentUser&&currentUser.id){currentUser=S.users.find(u=>u.id===currentUser.id)||currentUser;}
    document.getElementById('landing-page').style.display='none';
    document.getElementById('login-screen').style.display='none';
    document.getElementById('main-app').style.display='flex';
    document.body.style.overflow='hidden';
    document.querySelector('.sidebar-user-info p:first-child').textContent=currentUser.name;
    document.querySelector('.sidebar-user-info p:last-child').textContent=currentUser.role;
    // Update sidebar avatar initials
    const initials=(currentUser.name||'').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const sidebarAvatar=document.getElementById('sidebar-user-avatar');
    if(sidebarAvatar)sidebarAvatar.textContent=initials;
    // Update popup menu info
    const menuName=document.getElementById('menu-user-name');if(menuName)menuName.textContent=currentUser.name;
    const menuRole=document.getElementById('menu-user-role');if(menuRole)menuRole.textContent=currentUser.role;
    const menuEmail=document.getElementById('menu-user-email');if(menuEmail)menuEmail.textContent=currentUser.email||'';
    const menuAvatar=document.getElementById('menu-user-avatar');if(menuAvatar)menuAvatar.textContent=initials;
    applyRBAC();showNotif('Hos geldiniz, '+currentUser.name+'!');
    renderAll();updateDeletionBadge();
    tumKontrolleriCalistir();
    initSocket();requestNotifPermission();startActivityWatcher();
    loadAiProviders();loadAiSessions();subscribePushNotifications();loadDashboardCharts();
    recordPuantajGiris();
    setTimeout(()=>girisKritikModal(),500);
}

function logout(){
    recordPuantajCikis();
    isLoggedIn=false;authToken=null;refreshToken=null;showLandingPage();
}
function recordPuantajGiris(){
    if(!currentUser)return;if(!S.puantajlar)S.puantajlar=[];
    const bugun=new Date().toISOString().slice(0,10);
    const personel=(S.personeller||[]).find(p=>p.userId&&String(p.userId)===String(currentUser.id));
    const pId=personel?personel.id:('user_'+currentUser.id);
    const existing=S.puantajlar.find(p=>String(p.personelId)===String(pId)&&p.tarih===bugun);
    if(!existing){
        S.puantajlar.push({id:Date.now(),personelId:pId,tarih:bugun,girisSaat:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),cikisSaat:null,toplamSaat:0,fazlaMesai:0,durum:'tam',otomatik:true});
        save();
    }
}
function recordPuantajCikis(){
    if(!currentUser)return;
    const bugun=new Date().toISOString().slice(0,10);
    const personel=(S.personeller||[]).find(p=>p.userId&&String(p.userId)===String(currentUser.id));
    const pId=personel?personel.id:('user_'+currentUser.id);
    const entry=(S.puantajlar||[]).find(p=>String(p.personelId)===String(pId)&&p.tarih===bugun);
    if(entry&&!entry.cikisSaat){
        entry.cikisSaat=new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
        const [gh,gm]=entry.girisSaat.split(':').map(Number);
        const [ch,cm]=entry.cikisSaat.split(':').map(Number);
        entry.toplamSaat=Math.max(0,((ch*60+cm)-(gh*60+gm))/60);
        entry.fazlaMesai=Math.max(0,entry.toplamSaat-8);
        save();
    }
}

// ===================== v5 - RBAC =====================
const RBAC_DEFAULT_ROLES={
    'Yonetici':{modules:['dashboard','connect','build','supply','sales','depo','hr','reports','settings'],write:true,readOnly:[],desc:'Tum sistem uzerinde tam yetki. Kullanici yonetimi, rol atama, veri silme ve sistem ayarlari dahil.',gorevler:['Sistem yonetimi','Kullanici ve rol yonetimi','Tum modullere tam erisim','Veri yedekleme ve geri yukleme','Ayar ve konfigurasyonlar'],sorumluluklar:['Sistem guvenligini saglamak','Yetkilendirmeleri dogru yapmak','Verilerin butunlugunu korumak']},
    'Proje Muduru':{modules:['dashboard','connect','build','hr','depo'],write:true,readOnly:['hr','depo'],desc:'Proje planlama, gorev takibi ve sahada koordinasyon. HR ve Depo modullerine salt okunur erisim.',gorevler:['Proje olusturma ve yonetme','Gorev atama ve takip','Taseron ve tedarikci koordinasyonu','Hakedi≈ü hazirlama','Malzeme talep etme'],sorumluluklar:['Projelerin zamaninda tamamlanmasi','Butce kontrolu','Saha guvenligi ve kalite']},
    'Muhasebe':{modules:['dashboard','supply','sales','reports','hr'],write:true,readOnly:['hr'],desc:'Mali islemler, satin alma surecleri ve satis takibi. HR modulu salt okunur.',gorevler:['Fatura ve odeme takibi','Gelir-gider analizi','Taksit ve tahsilat yonetimi','Satin alma onay sureci','Mali rapor hazirlama'],sorumluluklar:['Mali kayitlarin dogrulugu','Zamaninda odeme yapilmasi','Butce raporlamasi']},
    'Satin Alma':{modules:['dashboard','connect','supply','depo','reports'],write:true,readOnly:[],desc:'Tedarik sureci yonetimi, siparis takibi ve depo stok girisi.',gorevler:['Satin alma talebi olusturma','Tedarikci secimi ve siparis','Teslimat takibi','Stok giris islemleri','Fiyat karsilastirma'],sorumluluklar:['Uygun fiyat ve kalitede tedarik','Stok seviyelerinin yeterliligi','Tedarikci iliskileri']},
    'Satis':{modules:['dashboard','connect','sales','reports'],write:true,readOnly:[],desc:'Musteri iliskileri, teklif hazirlama ve satis sureci yonetimi.',gorevler:['Musteri gorusmesi ve takip','Teklif hazirlama','Sozlesme sureci','Taksit plani olusturma','Satis raporu'],sorumluluklar:['Satis hedeflerine ulasmak','Musteri memnuniyeti','Tahsilat takibi']},
    'Izleyici':{modules:['dashboard','reports'],write:false,readOnly:['dashboard','reports'],desc:'Sadece Dashboard ve Raporlar modulune okuma erisimi. Hicbir veri degisikligi yapamaz.',gorevler:['Dashboard izleme','Rapor goruntuleme'],sorumluluklar:['Gizlilik kurallarina uymak']}
};
function getRBACPerms(){
    // Merge default + custom roles
    const perms=JSON.parse(JSON.stringify(RBAC_DEFAULT_ROLES));
    if(S.customRoles){
        S.customRoles.forEach(r=>{
            perms[r.name]={modules:r.modules||[],write:r.write!==false,readOnly:r.readOnly||[],desc:r.desc||'',gorevler:r.gorevler||[],sorumluluklar:r.sorumluluklar||[]};
        });
    }
    return perms;
}
function getPermsForRole(role){
    const all=getRBACPerms();
    return all[role]||all['Izleyici'];
}
const RBAC_ACTION_ROLES={
    'add_project':['Yonetici','Proje Muduru'],
    'edit_project':['Yonetici','Proje Muduru'],
    'delete_project':['Yonetici'],
    'add_tender':['Yonetici','Satin Alma'],
    'add_order':['Yonetici','Satin Alma'],
    'add_teslimat':['Yonetici','Satin Alma'],
    'add_sale':['Yonetici','Satis'],
    'edit_sale':['Yonetici','Satis'],
    'delete_sale':['Yonetici'],
    'add_envanter':['Yonetici','Satin Alma'],
    'add_zimmet':['Yonetici','Satin Alma','Proje Muduru'],
    'add_depo_hareket':['Yonetici','Satin Alma','Proje Muduru'],
    'approve_transfer':['Yonetici','Satin Alma'],
    'add_personel':['Yonetici'],
    'edit_personel':['Yonetici'],
    'delete_personel':['Yonetici'],
    'add_izin':['Yonetici','Proje Muduru'],
    'approve_izin':['Yonetici'],
    'add_user':['Yonetici'],
    'delete_user':['Yonetici'],
    'edit_settings':['Yonetici']
};
// Get effective module list for a user (role + customModules overrides)
function getUserEffectiveModules(user){
    if(!user)return[];
    const p=getPermsForRole(user.role);
    const roleModules=p.modules||[];
    const cm=user.customModules||{};
    const effective=new Set(roleModules);
    Object.keys(cm).forEach(modId=>{
        if(cm[modId]===true) effective.add(modId);
        else if(cm[modId]===false) effective.delete(modId);
    });
    return Array.from(effective);
}

function canAccess(module){
    if(!currentUser)return false;
    const effective=getUserEffectiveModules(currentUser);
    return effective.includes(module);
}
function canWrite(module){
    if(!currentUser)return false;
    if(!canAccess(module))return false;
    const p=getPermsForRole(currentUser.role);
    if(!p.write)return false;
    if(p.readOnly&&p.readOnly.includes(module))return false;
    return true;
}
function canPerformAction(action){
    if(!currentUser)return false;
    const allowed=RBAC_ACTION_ROLES[action];
    if(!allowed)return currentUser.role==='Yonetici';
    return allowed.includes(currentUser.role);
}
function enforceAccess(action,module){
    if(module&&!canAccess(module)){showNotif('Bu module erisim yetkiniz yok.');return false;}
    if(action&&!canPerformAction(action)){showNotif('Bu islemi yapmaya yetkiniz yok.');return false;}
    return true;
}
function applyRBAC(){
    if(!currentUser)return;
    const allowed=getUserEffectiveModules(currentUser);
    document.querySelectorAll('#nav-list .nav-item').forEach(el=>{
        const mod=el.getAttribute('data-module');
        if(mod&&!allowed.includes(mod)){el.style.opacity='0.3';el.style.pointerEvents='none';}
        else{el.style.opacity='1';el.style.pointerEvents='auto';}
    });
}

// ===================== v5 - REMINDERS =====================
function checkReminders(){
    const now=new Date();
    S.sales.forEach(s=>{
        if(s.paid<s.price&&s.installments>1){
            const perInst=Math.floor(s.price/s.installments);
            const paidCount=Math.floor(s.paid/perInst);
            if(paidCount<s.installments){
                const remaining=s.installments-paidCount;
                if(remaining<=2&&!s._reminded){
                    s._reminded=true;
                    act('HATIRLATMA: '+s.customer+' - '+remaining+' taksit kaldi!');
                }
            }
        }
    });
    S.tenders.forEach(t=>{
        if(t.status==='pending'&&t.createdAt){
            const created=new Date(t.createdAt);
            const diff=Math.floor((now-created)/(1000*60*60*24));
            if(diff>=7&&!t._reminded){
                t._reminded=true;
                act('HATIRLATMA: '+t.item+' - '+diff+' gundur bekliyor!');
            }
        }
    });
    save();
}
setInterval(checkReminders,60000);

// ===================== v5 - PRINT REPORT =====================
function printReport(){
    const w=window.open('','_blank');
    const projBudget=S.projects.reduce((s,p)=>s+p.budget,0);
    const tenderTotal=S.tenders.reduce((s,t)=>s+t.amount,0);
    const salesTotal=S.sales.reduce((s,x)=>s+x.price,0);
    const paidTotal=S.sales.reduce((s,x)=>s+x.paid,0);
    w.document.write(`<!DOCTYPE html><html><head><title>FaOnSisT Rapor</title><style>body{font-family:Inter,sans-serif;padding:40px;color:#1e293b;}h1{font-size:24px;margin-bottom:8px;}h2{font-size:16px;margin-top:24px;border-bottom:2px solid #3b82f6;padding-bottom:4px;}table{width:100%;border-collapse:collapse;margin-top:12px;}th,td{padding:8px 12px;text-align:left;border-bottom:1px solid #e2e8f0;font-size:13px;}th{background:#f1f5f9;font-weight:600;}.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #3b82f6;padding-bottom:12px;margin-bottom:24px;}.logo{font-size:28px;font-weight:800;color:#3b82f6;}.meta{font-size:11px;color:#94a3b8;}.stat{display:inline-block;padding:8px 16px;margin:4px;border-radius:8px;background:#f1f5f9;}.stat b{display:block;font-size:18px;color:#3b82f6;}@media print{body{padding:20px;}}</style></head><body>`);
    w.document.write(`<div class="header"><div><div class="logo">FaOnSisT</div><div class="meta">Enterprise Rapor - ${new Date().toLocaleDateString('tr-TR')}</div></div></div>`);
    w.document.write(`<div style="display:flex;gap:12px;flex-wrap:wrap;"><div class="stat">Projeler<b>${S.projects.length}</b></div><div class="stat">Toplam Butce<b>\u20BA${fmtFull(projBudget)}</b></div><div class="stat">Ihaleler<b>${S.tenders.length}</b></div><div class="stat">Satislar<b>\u20BA${fmtFull(salesTotal)}</b></div><div class="stat">Tahsilat<b>\u20BA${fmtFull(paidTotal)}</b></div></div>`);
    w.document.write(`<h2>Projeler</h2><table><tr><th>Proje</th><th>Butce</th><th>Harcanan</th><th>Tamamlanma</th><th>Durum</th></tr>`);
    S.projects.forEach(p=>w.document.write(`<tr><td>${p.name}</td><td>\u20BA${fmtFull(p.budget)}</td><td>\u20BA${fmtFull(p.spent||0)}</td><td>%${p.completion}</td><td>${stName(p.status)}</td></tr>`));
    w.document.write(`</table><h2>Ihaleler</h2><table><tr><th>Malzeme</th><th>Tedarikci</th><th>Tutar</th><th>Durum</th></tr>`);
    S.tenders.forEach(t=>w.document.write(`<tr><td>${t.item}</td><td>${t.supplier}</td><td>\u20BA${fmtFull(t.amount)}</td><td>${stName(t.status)}</td></tr>`));
    w.document.write(`</table><h2>Satislar</h2><table><tr><th>Musteri</th><th>Urun</th><th>Fiyat</th><th>Odenen</th><th>Asama</th></tr>`);
    S.sales.forEach(s=>w.document.write(`<tr><td>${s.customer}</td><td>${s.product}</td><td>\u20BA${fmtFull(s.price)}</td><td>\u20BA${fmtFull(s.paid)}</td><td>${stName(s.stage)}</td></tr>`));
    w.document.write(`</table><div style="margin-top:40px;text-align:center;font-size:10px;color:#94a3b8;">FaOnSisT v5.0 - Otomatik rapor &middot; ${new Date().toLocaleString('tr-TR')}</div></body></html>`);
    w.document.close();
    w.print();
}

// ===================== v5 - THREAD/REPLY =====================
function replyToMessage(msgId){startReply(msgId);}

// ===================== v5 - CONNECT FILES & KNOWLEDGE BASE =====================
let connViewMode='chat';
let connFileTab='channel';

function switchConnectView(mode){
    connViewMode=mode;
    const chatView=document.getElementById('connect-chat-view');
    const filesView=document.getElementById('connect-files-view');
    const aiView=document.getElementById('connect-ai-view');
    chatView.classList.add('hidden');
    filesView.classList.add('hidden');
    aiView.classList.add('hidden');
    if(mode==='files'){
        filesView.classList.remove('hidden');
        renderConnFiles();
        renderKnowledgeBase();
    } else if(mode==='ai'){
        aiView.classList.remove('hidden');
    } else if(mode==='meetings'){
        openModal('modal-create-meeting');
        // Stay on chat view
        chatView.classList.remove('hidden');
    } else {
        chatView.classList.remove('hidden');
    }
}

function switchFileTab(tab){
    connFileTab=tab;
    document.getElementById('conn-file-tab-channel').classList.toggle('hidden',tab!=='channel');
    document.getElementById('conn-file-tab-kb').classList.toggle('hidden',tab!=='kb');
    document.querySelectorAll('#conn-file-tabs .tab-btn').forEach((b,i)=>b.classList.toggle('active',['channel','kb'][i]===tab));
}

let pendingFile=null;

function openConnFileUpload(){
    pendingFile=null;
    clearFileSelection();
    openModal('modal-conn-file');
}

const fileIcons={PDF:'text-red-400',XLSX:'text-green-400',DOCX:'text-blue-400',DWG:'text-orange-400',IMG:'text-pink-400',ZIP:'text-yellow-400',LINK:'text-cyan-400',OTHER:'text-gray-400'};
const fileEmojis={PDF:'\uD83D\uDCC4',XLSX:'\uD83D\uDCCA',DOCX:'\uD83D\uDCC3',DWG:'\uD83D\uDCD0',IMG:'\uD83D\uDDBC\uFE0F',ZIP:'\uD83D\uDCE6',LINK:'\uD83D\uDD17',OTHER:'\uD83D\uDCC1'};

const extToType={pdf:'PDF',xlsx:'XLSX',xls:'XLSX',docx:'DOCX',doc:'DOCX',dwg:'DWG',dxf:'DWG',jpg:'IMG',jpeg:'IMG',png:'IMG',gif:'IMG',svg:'IMG',webp:'IMG',bmp:'IMG',zip:'ZIP',rar:'ZIP','7z':'ZIP',tar:'ZIP',gz:'ZIP',pptx:'DOCX',ppt:'DOCX',txt:'OTHER',csv:'XLSX',mp4:'VID',mov:'VID',avi:'VID',mkv:'VID',webm:'VID',mp3:'AUD',wav:'AUD',ogg:'AUD'};

// ========== RICH FILE PREVIEW IN CHAT ==========
function renderChatFilePreview(m){
    if(!m.fileData&&!m.isFile)return null;
    let fd=m.fileData;
    // Legacy backward compat: old file messages stored HTML in text, no fileData
    if(!fd&&m.isFile){
        // Try to find file from connFiles by matching timestamp proximity
        for(const[ch,files]of Object.entries(S.connFiles||{})){
            const f=files.find(f=>Math.abs(f.id-(m.id-1))<=5);
            if(f){fd=f;break;}
        }
        if(!fd)return null; // truly old format, will render text as-is
    }
    const channelId=fd.channel||S.currentChannel;
    const src=fd.dataUri||fd.fileUrl||(fd.fileId?API_BASE+'/api/uploads/'+fd.fileId:null);
    const emoji=fileEmojis[fd.type]||'\uD83D\uDCC1';
    const iconColor=fileIcons[fd.type]||'text-gray-400';
    const bgColors={PDF:'from-red-500/20 to-red-900/10 border-red-500/30',XLSX:'from-green-500/20 to-green-900/10 border-green-500/30',DOCX:'from-blue-500/20 to-blue-900/10 border-blue-500/30',DWG:'from-orange-500/20 to-orange-900/10 border-orange-500/30',IMG:'from-pink-500/10 to-pink-900/5 border-pink-500/20',ZIP:'from-yellow-500/20 to-yellow-900/10 border-yellow-500/30',VID:'from-purple-500/20 to-purple-900/10 border-purple-500/30',AUD:'from-cyan-500/20 to-cyan-900/10 border-cyan-500/30',OTHER:'from-gray-500/20 to-gray-900/10 border-gray-500/30'};
    const bg=bgColors[fd.type]||bgColors.OTHER;

    // IMAGE: full thumbnail preview
    if(fd.type==='IMG'){
        const imgSrc=fd.dataUri||fd.fileUrl||(fd.fileId?API_BASE+'/api/uploads/'+fd.fileId:null);
        if(imgSrc){
            const fallbackSrc=fd.dataUri?(fd.fileUrl||''):(fd.dataUri||'');
            return '<div class="rounded-xl overflow-hidden border border-gray-700/50 max-w-xs cursor-pointer" onclick="previewFile(\''+channelId+'\','+fd.id+')">'+
                '<img src="'+imgSrc+'" alt="'+fd.name+'" class="w-full max-h-64 object-cover" loading="lazy" onerror="if(this.dataset.retried){this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';}else{this.dataset.retried=1;var fb=\''+(fallbackSrc).replace(/'/g,"\\'")+'\';if(fb){this.src=fb;}else{this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';}}">'+
                '<div style="display:none" class="p-4 flex items-center gap-3 bg-gradient-to-r from-pink-500/10 to-pink-900/5"><span class="text-2xl">\uD83D\uDDBC\uFE0F</span><div><p class="text-xs font-medium">'+fd.name+'</p><p class="text-[10px] text-gray-500">Resim \u00B7 '+fd.size+'</p></div></div>'+
                '<div class="bg-gray-800/80 px-3 py-2 flex items-center gap-2">'+
                '<span class="text-sm">\uD83D\uDDBC\uFE0F</span>'+
                '<div class="flex-1 min-w-0"><p class="text-[11px] font-medium truncate">'+fd.name+'</p><p class="text-[9px] text-gray-500">'+fd.size+'</p></div>'+
                '<button onclick="event.stopPropagation();downloadFile({fileUrl:\''+((fd.fileUrl||'').replace(/'/g,"\\'"))+'\',fileId:\''+((fd.fileId||'').toString().replace(/'/g,"\\'"))+'\',dataUri:null,name:\''+fd.name.replace(/'/g,"\\'")+'\'})" class="text-gray-400 hover:text-white text-[10px]" title="Indir">\u2B07</button>'+
                '</div></div>';
        }
        // No src available - show image file card
        return '<div class="rounded-xl border bg-gradient-to-r from-pink-500/10 to-pink-900/5 border-pink-500/20 max-w-xs p-3 flex items-center gap-3 cursor-pointer" onclick="previewFile(\''+channelId+'\','+fd.id+')">'+
            '<div class="w-10 h-12 bg-pink-500/20 rounded-lg flex items-center justify-center flex-shrink-0"><span class="text-2xl">\uD83D\uDDBC\uFE0F</span></div>'+
            '<div class="flex-1 min-w-0"><p class="text-xs font-semibold truncate">'+fd.name+'</p><p class="text-[10px] text-gray-400 mt-0.5">Resim \u00B7 '+fd.size+'</p>'+
            (fd.desc?'<p class="text-[10px] text-gray-500 mt-1">'+fd.desc+'</p>':'')+
            '</div></div>';
    }

    // VIDEO: player preview
    if(fd.type==='VID'&&src){
        return '<div class="rounded-xl overflow-hidden border border-purple-500/30 max-w-sm">'+
            '<video src="'+src+'" controls preload="metadata" class="w-full max-h-56 bg-black rounded-t-xl"></video>'+
            '<div class="bg-gradient-to-r '+bg+' px-3 py-2 flex items-center gap-2">'+
            '<span class="text-sm">\uD83C\uDFA5</span>'+
            '<div class="flex-1 min-w-0"><p class="text-[11px] font-medium truncate">'+fd.name+'</p><p class="text-[9px] text-gray-500">'+fd.size+'</p></div>'+
            '</div></div>';
    }

    // AUDIO: player preview
    if(fd.type==='AUD'&&src){
        return '<div class="rounded-xl border border-cyan-500/30 bg-gradient-to-r '+bg+' p-3 max-w-sm">'+
            '<div class="flex items-center gap-2 mb-2"><span class="text-lg">\uD83C\uDFB5</span><div class="flex-1 min-w-0"><p class="text-xs font-medium truncate">'+fd.name+'</p><p class="text-[9px] text-gray-500">'+fd.size+'</p></div></div>'+
            '<audio src="'+src+'" controls preload="metadata" class="w-full h-8" style="filter:invert(0.85) hue-rotate(180deg)"></audio>'+
            '</div>';
    }

    // PDF: rich card with icon
    if(fd.type==='PDF'){
        return '<div class="rounded-xl border bg-gradient-to-r '+bg+' max-w-xs cursor-pointer overflow-hidden" onclick="previewFile(\''+channelId+'\','+fd.id+')">'+
            '<div class="p-3 flex items-start gap-3">'+
            '<div class="w-10 h-12 bg-red-500/20 rounded-lg flex items-center justify-center flex-shrink-0"><span class="text-2xl">\uD83D\uDCC4</span></div>'+
            '<div class="flex-1 min-w-0"><p class="text-xs font-semibold truncate">'+fd.name+'</p><p class="text-[10px] text-gray-400 mt-0.5">PDF Belgesi \u00B7 '+fd.size+'</p>'+
            (fd.desc?'<p class="text-[10px] text-gray-500 mt-1 line-clamp-2">'+fd.desc+'</p>':'')+
            '</div></div>'+
            '<div class="bg-gray-900/40 px-3 py-1.5 flex items-center justify-between border-t border-red-500/10">'+
            '<span class="text-[9px] text-gray-500">\uD83D\uDC41 Onizlemek icin tikla</span>'+
            '<button onclick="event.stopPropagation();downloadFile({fileUrl:\''+((fd.fileUrl||'').replace(/'/g,"\\'"))+'\',fileId:\''+((fd.fileId||'').toString().replace(/'/g,"\\'"))+'\',dataUri:null,name:\''+fd.name.replace(/'/g,"\\'")+'\'})" class="text-[9px] text-gray-400 hover:text-white">\u2B07 Indir</button>'+
            '</div></div>';
    }

    // XLSX/DOCX: document card
    if(fd.type==='XLSX'||fd.type==='DOCX'){
        const typeLabel=fd.type==='XLSX'?'Excel Tablosu':'Word Belgesi';
        return '<div class="rounded-xl border bg-gradient-to-r '+bg+' max-w-xs cursor-pointer overflow-hidden" onclick="previewFile(\''+channelId+'\','+fd.id+')">'+
            '<div class="p-3 flex items-start gap-3">'+
            '<div class="w-10 h-12 rounded-lg flex items-center justify-center flex-shrink-0" style="background:rgba(255,255,255,0.05)"><span class="text-2xl">'+emoji+'</span></div>'+
            '<div class="flex-1 min-w-0"><p class="text-xs font-semibold truncate">'+fd.name+'</p><p class="text-[10px] text-gray-400 mt-0.5">'+typeLabel+' \u00B7 '+fd.size+'</p>'+
            (fd.desc?'<p class="text-[10px] text-gray-500 mt-1 line-clamp-2">'+fd.desc+'</p>':'')+
            '</div></div>'+
            '<div class="bg-gray-900/40 px-3 py-1.5 flex items-center justify-between border-t border-gray-700/30">'+
            '<span class="text-[9px] text-gray-500">\uD83D\uDC41 Onizle</span>'+
            '<button onclick="event.stopPropagation();downloadFile({fileUrl:\''+((fd.fileUrl||'').replace(/'/g,"\\'"))+'\',fileId:\''+((fd.fileId||'').toString().replace(/'/g,"\\'"))+'\',dataUri:null,name:\''+fd.name.replace(/'/g,"\\'")+'\'})" class="text-[9px] text-gray-400 hover:text-white">\u2B07 Indir</button>'+
            '</div></div>';
    }

    // DEFAULT: generic file card
    return '<div class="rounded-xl border bg-gradient-to-r '+bg+' p-3 max-w-xs cursor-pointer flex items-center gap-3" onclick="previewFile(\''+channelId+'\','+fd.id+')">'+
        '<div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background:rgba(255,255,255,0.05)"><span class="text-xl">'+emoji+'</span></div>'+
        '<div class="flex-1 min-w-0"><p class="text-xs font-semibold truncate">'+fd.name+'</p><p class="text-[10px] text-gray-400">'+fd.type+' \u00B7 '+fd.size+'</p>'+
        (fd.desc?'<p class="text-[10px] text-gray-500 mt-0.5 truncate">'+fd.desc+'</p>':'')+
        '</div>'+
        '<span class="text-gray-500 text-xs flex-shrink-0">\uD83D\uDC41</span>'+
        '</div>';
}

// URL detection and link preview
function renderUrlPreviews(text){
    const urlRegex=/(https?:\/\/[^\s<>"']+)/gi;
    const urls=text.match(urlRegex);
    if(!urls||urls.length===0)return '';
    let html='';
    urls.forEach(url=>{
        let domain='';try{domain=new URL(url).hostname.replace('www.','');}catch(e){return;}
        // Detect popular services for rich cards
        const isYoutube=domain.includes('youtube.com')||domain.includes('youtu.be');
        const isGithub=domain.includes('github.com');
        const isLinkedin=domain.includes('linkedin.com');
        const isTwitter=domain.includes('twitter.com')||domain.includes('x.com');
        const isImg=/\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i.test(url);

        if(isImg){
            html+='<div class="mt-2 rounded-xl overflow-hidden border border-gray-700/50 max-w-xs"><a href="'+url+'" target="_blank" rel="noopener"><img src="'+url+'" alt="Gorsel" class="w-full max-h-56 object-cover" loading="lazy" onerror="this.parentElement.parentElement.remove()"></a></div>';
        }else if(isYoutube){
            let vid='';
            try{const u=new URL(url);vid=u.searchParams.get('v')||u.pathname.split('/').pop();}catch(e){}
            if(vid){
                html+='<div class="mt-2 rounded-xl overflow-hidden border border-red-500/20 max-w-sm">'+
                    '<div class="relative cursor-pointer" onclick="this.innerHTML=\'<iframe src=\\\'https://www.youtube.com/embed/'+vid+'?autoplay=1\\\' class=\\\'w-full aspect-video\\\' frameborder=\\\'0\\\' allow=\\\'autoplay\\\' allowfullscreen></iframe>\'">'+
                    '<img src="https://img.youtube.com/vi/'+vid+'/hqdefault.jpg" class="w-full aspect-video object-cover" loading="lazy">'+
                    '<div class="absolute inset-0 flex items-center justify-center bg-black/30"><div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center"><svg class="w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div></div>'+
                    '<div class="bg-gray-800/80 px-3 py-2 flex items-center gap-2"><span class="text-red-500 text-sm">\u25B6</span><div class="flex-1 min-w-0"><p class="text-[10px] text-gray-400">YouTube</p><p class="text-[11px] font-medium truncate text-gray-200">'+url+'</p></div></div></div>';
            }
        }else{
            // Generic link card
            const favicon='https://www.google.com/s2/favicons?domain='+domain+'&sz=32';
            const serviceColors={'github.com':'border-gray-500/30 from-gray-500/10','linkedin.com':'border-blue-600/30 from-blue-600/10','twitter.com':'border-sky-500/30 from-sky-500/10','x.com':'border-sky-500/30 from-sky-500/10','drive.google.com':'border-yellow-500/30 from-yellow-500/10','docs.google.com':'border-blue-500/30 from-blue-500/10'};
            const lc=serviceColors[domain]||'border-gray-600/30 from-gray-600/10';
            html+='<a href="'+url+'" target="_blank" rel="noopener" class="block mt-2 rounded-xl border bg-gradient-to-r '+lc+' to-transparent p-2.5 max-w-xs hover:border-gray-500/50 transition-colors no-underline">'+
                '<div class="flex items-center gap-2.5">'+
                '<img src="'+favicon+'" class="w-5 h-5 rounded flex-shrink-0" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%236b7280%22><path d=%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z%22/></svg>\'" loading="lazy">'+
                '<div class="flex-1 min-w-0"><p class="text-[10px] text-gray-500">'+domain+'</p><p class="text-[11px] font-medium truncate text-gray-300">'+url.replace(/^https?:\/\/(www\.)?/,'').substring(0,60)+'</p></div>'+
                '<svg class="w-3.5 h-3.5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>'+
                '</div></a>';
        }
    });
    return html;
}

// Quick file upload directly from chat (drag-drop / paste)
function initChatFileHandlers(){
    const chatArea=document.getElementById('chat-messages');
    const inputArea=chatArea?chatArea.parentElement:null;
    if(!inputArea)return;
    // Drag-drop overlay
    let dragCounter=0;
    inputArea.addEventListener('dragenter',e=>{e.preventDefault();dragCounter++;
        if(dragCounter===1){let ov=document.getElementById('chat-drop-overlay');
        if(!ov){ov=document.createElement('div');ov.id='chat-drop-overlay';ov.className='absolute inset-0 bg-purple-600/20 border-2 border-dashed border-purple-400 rounded-2xl flex items-center justify-center z-40 pointer-events-none';ov.innerHTML='<div class="text-center"><span class="text-4xl block mb-2">\uD83D\uDCCE</span><p class="text-purple-300 font-semibold">Dosyayi buraya birakin</p><p class="text-purple-400/60 text-xs">Resim, belge, video...</p></div>';inputArea.style.position='relative';inputArea.appendChild(ov);}}
    });
    inputArea.addEventListener('dragleave',e=>{e.preventDefault();dragCounter--;if(dragCounter<=0){dragCounter=0;const ov=document.getElementById('chat-drop-overlay');if(ov)ov.remove();}});
    inputArea.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';});
    inputArea.addEventListener('drop',e=>{e.preventDefault();dragCounter=0;const ov=document.getElementById('chat-drop-overlay');if(ov)ov.remove();
        const files=e.dataTransfer.files;if(files&&files[0])quickUploadFile(files[0]);
    });
    // Paste image from clipboard
    const msgInput=document.getElementById('msg-input');
    if(msgInput){msgInput.addEventListener('paste',e=>{
        const items=e.clipboardData&&e.clipboardData.items;if(!items)return;
        for(let i=0;i<items.length;i++){
            if(items[i].type.startsWith('image/')){e.preventDefault();const blob=items[i].getAsFile();if(blob)quickUploadFile(blob);return;}}
    });}
}

async function quickUploadFile(file){
    const fType=detectFileType(file.name||'pasted-image.png');
    const fSize=formatFileSize(file.size);
    if(file.size>10*1024*1024){showNotif('Dosya cok buyuk (max 10MB)');return;}
    // Convert to base64 if small enough
    let dataUri=null;
    if(file.size<3*1024*1024){
        try{dataUri=await new Promise((r,j)=>{const rd=new FileReader();rd.onload=()=>r(rd.result);rd.onerror=j;rd.readAsDataURL(file);});}catch(e){}
    }
    const fileObj={id:Date.now(),name:file.name||('pasted-image-'+Date.now()+'.png'),type:fType,size:fSize,mimeType:file.type||'',desc:'',uploadedBy:currentUser?currentUser.name:'Bilinmeyen',uploadedAt:new Date().toISOString(),channel:S.currentChannel,fileId:null,fileUrl:null,dataUri:dataUri,deleted:false};
    if(!S.connFiles[S.currentChannel])S.connFiles[S.currentChannel]=[];
    S.connFiles[S.currentChannel].push(fileObj);
    const fileMsg={id:Date.now()+1,user:fileObj.uploadedBy,text:'',time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),mine:true,isFile:true,fileData:fileObj,reactions:{},readBy:[currentUser?currentUser.id:'']};
    if(!S.messages[S.currentChannel])S.messages[S.currentChannel]=[];
    S.messages[S.currentChannel].push(fileMsg);
    act('Dosya paylasild: '+fileObj.name);save();renderMessages();renderConnFiles();
    showNotif(fileObj.name+' paylasild!');
}

function detectFileType(fileName){
    const ext=fileName.split('.').pop().toLowerCase();
    return extToType[ext]||'OTHER';
}

function formatFileSize(bytes){
    if(bytes<1024)return bytes+' B';
    if(bytes<1024*1024)return (bytes/1024).toFixed(1)+' KB';
    if(bytes<1024*1024*1024)return (bytes/(1024*1024)).toFixed(1)+' MB';
    return (bytes/(1024*1024*1024)).toFixed(1)+' GB';
}

function detectCategory(fileName,fileType){return detectCategoryAdvanced(fileName,fileType,S.currentChannel,'');}
function detectCategoryAdvanced(fileName,fileType,channelId,description){
    // Baslik ve aciklama AYRI AYRI puanlanir - baslik 2x agirlikli
    const title=fileName.toLowerCase().replace(/[_\-\.]/g,' ');
    const desc=(description||'').toLowerCase().replace(/[_\-\.]/g,' ');
    const CATS={
        'Hakedis':{strong:['hakedis','hak edis','yesilbook','yesil defter','ihzarat'],weak:['metraj','progress','pursantaj'],types:['XLSX','PDF'],channels:['proje-takip']},
        'ISG':{strong:['isg','is guvenligi','is-guvenligi','is sagligi','osgb','risk degerlendirme'],weak:['guvenlik','safety','kaza','tehlike','risk','ppe','baret','koruyucu','yangƒ±n','ilkyardim'],types:['PDF','DOCX'],channels:[]},
        'Kalite':{strong:['kalite kontrol','kalite yonetim','quality','punch list','snag list'],weak:['denetim','audit','muayene','uygunsuzluk','ncr','kalite'],types:['PDF','XLSX'],channels:[]},
        'Rapor':{strong:['rapor','report'],weak:['ozet','analiz','istatistik','aylik','haftalik','gunluk','degerlendirme'],types:['XLSX','PDF'],channels:[]},
        'Yazisma':{strong:['yazisma','ust yazi','gelen giden','resmi yazi'],weak:['mektup','letter','dilekce','tebligat','bildirim'],types:['DOCX','PDF'],channels:[]},
        'Mali Belge':{strong:['fatura','invoice','dekont','makbuz','butce'],weak:['mali','odeme','banka','borc','alacak','tahsilat','muhasebe','vergi','nakit','finans','gelir','gider'],types:['PDF','XLSX'],channels:[]},
        'Fotograf':{strong:['foto','fotograf','photo','goruntu'],weak:['gorsel','resim','image','snapshot','ilerleme foto'],types:['IMG','JPG','JPEG','PNG','GIF','WEBP'],channels:[]},
        'Teknik':{strong:['vaziyet plani','teknik cizim','statik','mimari proje','kesit detay'],weak:['teknik','cizim','detay','mekanik','elektrik','tesisat','proje cizim','kalip plani','insaat plani','asma kat'],types:['DWG','DXF'],channels:['proje-takip']},
        'Prosedur':{strong:['prosedur','procedure','sop','standart operasyon'],weak:['talimat','yonerge','standart','islem','uygulama','rehber','asamalari','adimlari'],types:['PDF','DOCX'],channels:[]},
        'Sablonlar':{strong:['sablon','template','bos form','ornek form'],weak:['form','ornek','taslak','zimmet','tutanak','teslim','devir','cetvel','liste','belge'],types:['XLSX','DOCX','PDF'],channels:[]},
        'Egitim':{strong:['egitim','training','oryantasyon'],weak:['kilavuz','manual','sunum','ders','kurs','seminer','sertifika'],types:['PDF','DOCX','PPTX'],channels:[]},
        'Sozlesme':{strong:['sozlesme','contract','taahhut','protokol'],weak:['hukuk','anlasma','ek sozlesme','mukavele','sartneme','ihale'],types:['PDF','DOCX'],channels:[]},
    };
    let best='Diger',bestScore=0;
    for(const[cat,cfg]of Object.entries(CATS)){
        let score=0;
        let kwHit=false;
        // BASLIKTA match: tam puan (strong:50, weak:20)
        cfg.strong.forEach(k=>{if(title.includes(k)){score+=50;kwHit=true;}});
        cfg.weak.forEach(k=>{if(title.includes(k)){score+=20;kwHit=true;}});
        // ACIKLAMADA match: yarim puan (strong:25, weak:10)
        cfg.strong.forEach(k=>{if(desc.includes(k)){score+=25;kwHit=true;}});
        cfg.weak.forEach(k=>{if(desc.includes(k)){score+=10;kwHit=true;}});
        // Type ve kanal bonusu SADECE keyword match varsa
        if(kwHit){
            if(cfg.types.includes(fileType))score+=15;
            if(channelId&&cfg.channels.includes(channelId))score+=10;
        }
        if(score>bestScore){bestScore=score;best=cat;}
    }
    return best;
}

function handleFileSelect(input){
    if(input.files&&input.files[0]){
        setSelectedFile(input.files[0]);
    }
}

function handleFileDrop(e){
    const files=e.dataTransfer.files;
    if(files&&files[0]){
        setSelectedFile(files[0]);
    }
}

function setSelectedFile(f){
    const fType=detectFileType(f.name);
    const fSize=formatFileSize(f.size);
    pendingFile={name:f.name,type:fType,size:fSize,rawSize:f.size,rawFile:f};
    // Update UI
    document.getElementById('file-drop-content').classList.add('hidden');
    document.getElementById('file-selected-info').classList.remove('hidden');
    document.getElementById('file-selected-icon').textContent=fileEmojis[fType]||'\uD83D\uDCC1';
    document.getElementById('file-selected-name').textContent=f.name;
    document.getElementById('file-selected-meta').textContent=fType+' \u00B7 '+fSize;
    // Auto-detect category
    const catSelect=document.getElementById('file-category-select');
    if(catSelect){catSelect.value=detectCategoryAdvanced(f.name,fType,S.currentChannel,'');}
    // Enable submit
    const btn=document.getElementById('file-upload-btn');
    btn.disabled=false;btn.classList.remove('opacity-50','cursor-not-allowed');
}

function clearFileSelection(){
    pendingFile=null;
    const dc=document.getElementById('file-drop-content');
    const si=document.getElementById('file-selected-info');
    if(dc)dc.classList.remove('hidden');
    if(si)si.classList.add('hidden');
    const inp=document.getElementById('conn-file-input');
    if(inp)inp.value='';
    const btn=document.getElementById('file-upload-btn');
    if(btn){btn.disabled=true;btn.classList.add('opacity-50','cursor-not-allowed');}
}

async function uploadConnFile(e){
    e.preventDefault();
    if(!pendingFile){showNotif('Lutfen bir dosya secin!');return;}
    const f=new FormData(e.target);
    const desc=f.get('fileDesc')||'';
    const kategori=f.get('fileCategory')||detectCategoryAdvanced(pendingFile.name,pendingFile.type,S.currentChannel,desc);

    let fileId=null,fileUrl=null,mimeType=pendingFile.rawFile?pendingFile.rawFile.type:'';

    // Try uploading to backend
    if(backendAvailable&&authToken&&pendingFile.rawFile){
        try{
            const fd=new FormData();
            fd.append('file',pendingFile.rawFile);
            fd.append('folder','channels');
            fd.append('entityType','channel');
            fd.append('entityId',S.currentChannel);
            const r=await fetch(API_BASE+'/api/uploads',{
                method:'POST',
                headers:{'Authorization':'Bearer '+authToken},
                body:fd
            });
            if(r.ok){
                const d=await r.json();
                if(d.success){
                    fileId=d.data.id;
                    fileUrl=d.data.url||('/api/uploads/'+d.data.id);
                }
            }
        }catch(err){console.warn('File upload failed, using local mode:',err);}
    }

    // Always store base64 for images and small files (ensures local preview works)
    let dataUri=null;
    if(pendingFile.rawFile&&pendingFile.rawSize<3*1024*1024){
        try{
            dataUri=await new Promise((resolve,reject)=>{
                const reader=new FileReader();
                reader.onload=()=>resolve(reader.result);
                reader.onerror=reject;
                reader.readAsDataURL(pendingFile.rawFile);
            });
        }catch(err){console.warn('Base64 conversion failed:',err);}
    }

    const file={
        id:Date.now(),
        name:pendingFile.name,
        type:pendingFile.type,
        size:pendingFile.size,
        mimeType:mimeType,
        desc:desc,
        uploadedBy:currentUser?currentUser.name:'Bilinmeyen',
        uploadedAt:new Date().toISOString(),
        channel:S.currentChannel,
        fileId:fileId,
        fileUrl:fileUrl,
        dataUri:dataUri,
        deleted:false
    };
    if(!S.connFiles[S.currentChannel])S.connFiles[S.currentChannel]=[];
    S.connFiles[S.currentChannel].push(file);
    // Post as message in channel with rich preview
    const fileMsg={
        id:Date.now()+1,
        user:file.uploadedBy,
        text:desc?desc:'',
        time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),
        mine:true,
        isFile:true,
        fileData:file,
        reactions:{},
        readBy:[currentUser?currentUser.id:'']
    };
    if(!S.messages[S.currentChannel])S.messages[S.currentChannel]=[];
    S.messages[S.currentChannel].push(fileMsg);
    // Auto add to knowledge base
    S.knowledgeBase.push({
        id:Date.now()+2,
        title:file.name,
        category:kategori,
        fileType:file.type,
        desc:file.desc,
        addedBy:file.uploadedBy,
        addedAt:file.uploadedAt,
        source:'#'+S.currentChannel,
        fileId:file.fileId,
        fileUrl:file.fileUrl,
        dataUri:file.dataUri
    });
    act('Dosya yuklendi: '+file.name+' (#'+S.currentChannel+')');
    pendingFile=null;
    save();closeModal('modal-conn-file');e.target.reset();clearFileSelection();
    renderMessages();renderConnFiles();renderKnowledgeBase();
    showNotif(file.name+' yuklendi ve bilgi bankasina eklendi!');
}

function renderConnFiles(){
    const container=document.getElementById('conn-files-list');
    if(!container)return;
    const files=S.connFiles[S.currentChannel]||[];
    const allFiles=Object.entries(S.connFiles).reduce((arr,[ch,fList])=>{
        return arr.concat(fList.map(f=>({...f,channel:ch})));
    },[]);
    const activeFiles=allFiles.filter(f=>!f.deleted);
    const deletedFiles=allFiles.filter(f=>f.deleted);

    if(activeFiles.length===0&&deletedFiles.length===0){
        container.innerHTML='<div class="text-center py-12"><div class="w-16 h-16 rounded-full bg-purple-500/10 flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></div><p class="text-gray-400 text-sm mb-1">Henuz dosya yuklenmedi</p><p class="text-gray-500 text-xs">Dosya yuklemek icin yukardaki butonu veya sohbetteki atasman simgesini kullanin.</p></div>';
        return;
    }
    const grouped={};
    activeFiles.forEach(f=>{if(!grouped[f.channel])grouped[f.channel]=[];grouped[f.channel].push(f);});
    let html='<div class="space-y-4">';
    Object.entries(grouped).forEach(([ch,fList])=>{
        html+='<div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold flex items-center gap-2"><span class="text-blue-400">#</span>'+ch+'</h4><span class="text-[10px] text-gray-500">'+fList.length+' dosya</span></div>';
        html+='<div class="space-y-2">';
        fList.forEach(f=>{
            const icon=fileEmojis[f.type]||'\uD83D\uDCC1';
            html+='<div class="flex items-center gap-3 p-2.5 rounded-lg bg-gray-800/30 hover:bg-gray-800/50 transition-colors group"><span class="text-xl">'+icon+'</span><div class="flex-1 min-w-0"><p class="text-xs font-medium truncate">'+f.name+'</p><p class="text-[10px] text-gray-500">'+f.type+' \u00B7 '+f.size+' \u00B7 '+f.uploadedBy+' \u00B7 '+new Date(f.uploadedAt).toLocaleDateString('tr-TR')+'</p>'+(f.desc?'<p class="text-[10px] text-gray-400 mt-0.5">'+f.desc+'</p>':'')+'</div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="previewFile(\''+ch+'\','+f.id+')" class="w-7 h-7 rounded bg-gray-700 hover:bg-blue-600 text-[11px] text-gray-300 flex items-center justify-center" title="Onizle">\uD83D\uDC41</button><button onclick="downloadFile('+JSON.stringify(f).replace(/"/g,'&quot;')+')" class="w-7 h-7 rounded bg-gray-700 hover:bg-green-600 text-[11px] text-gray-300 flex items-center justify-center" title="Indir">\u2B07</button><button onclick="confirmDelete(\'file\','+f.id+',\''+ch+'\')" class="w-7 h-7 rounded bg-gray-700 hover:bg-red-600 text-[11px] text-gray-300 flex items-center justify-center" title="Sil">&times;</button></div></div>';
        });
        html+='</div></div>';
    });
    // Trash section for admin
    if(deletedFiles.length>0&&currentUser&&(currentUser.role==='admin'||currentUser.role==='Yonetici')){
        html+='<div class="glass rounded-xl p-4 border border-red-500/20"><div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold flex items-center gap-2"><span class="text-red-400">\uD83D\uDDD1</span>Cop Kutusu</h4><span class="text-[10px] text-gray-500">'+deletedFiles.length+' silinen dosya</span></div><div class="space-y-2">';
        deletedFiles.forEach(f=>{
            html+='<div class="flex items-center gap-3 p-2 rounded-lg bg-red-500/5 opacity-60"><span class="text-lg">'+(fileEmojis[f.type]||'\uD83D\uDCC1')+'</span><div class="flex-1 min-w-0"><p class="text-xs font-medium truncate line-through">'+f.name+'</p><p class="text-[10px] text-gray-600">Silen: '+(f.deletedBy||'?')+' \u00B7 '+(f.deletedAt?new Date(f.deletedAt).toLocaleDateString('tr-TR'):'')+'</p></div><button onclick="restoreFile(\''+f.channel+'\','+f.id+')" class="px-2 py-1 rounded bg-green-600/20 hover:bg-green-600 text-[10px] text-green-400 transition-colors">Geri Yukle</button></div>';
        });
        html+='</div></div>';
    }
    html+='</div>';
    container.innerHTML=html;
}

function deleteConnFile(ch,fileId){
    confirmDelete('file',fileId,ch);
}

function renderKnowledgeBase(){
    const container=document.getElementById('kb-list');
    if(!container)return;
    const activeKB=S.knowledgeBase.filter(kb=>!kb.deleted);
    const deletedKB=S.knowledgeBase.filter(kb=>kb.deleted);
    if(activeKB.length===0&&deletedKB.length===0){
        container.innerHTML='<div class="text-center py-12"><div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg></div><p class="text-gray-400 text-sm mb-1">Bilgi bankasi bos</p><p class="text-gray-500 text-xs">Prosedurler, sablonlar ve teknik dokumanlari buradan yonetin.</p></div>';
        return;
    }
    const cats={};
    activeKB.forEach(kb=>{if(!cats[kb.category])cats[kb.category]=[];cats[kb.category].push(kb);});
    const catColors={Prosedur:'blue',Sablonlar:'purple',Teknik:'orange',Egitim:'green',Sozlesme:'red',Rapor:'cyan',Hakedis:'emerald',Yazisma:'slate',ISG:'rose',Kalite:'teal',Fotograf:'pink','Mali Belge':'yellow',Diger:'gray'};
    let html='<div class="space-y-4">';
    Object.entries(cats).forEach(([cat,items])=>{
        const c=catColors[cat]||'gray';
        html+='<div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-'+c+'-400"></span>'+cat+'</h4><span class="text-[10px] text-gray-500">'+items.length+' dokuman</span></div>';
        html+='<div class="space-y-2">';
        items.forEach(kb=>{
            const icon=fileEmojis[kb.fileType]||'\uD83D\uDCC1';
            html+='<div class="flex items-center gap-3 p-2.5 rounded-lg bg-gray-800/30 hover:bg-gray-800/50 transition-colors group"><span class="text-xl">'+icon+'</span><div class="flex-1 min-w-0"><p class="text-xs font-medium truncate">'+kb.title+'</p><p class="text-[10px] text-gray-500">'+kb.fileType+' \u00B7 '+kb.addedBy+' \u00B7 '+new Date(kb.addedAt).toLocaleDateString('tr-TR')+'</p>'+(kb.desc?'<p class="text-[10px] text-gray-400 mt-0.5">'+kb.desc+'</p>':'')+'<p class="text-[9px] text-gray-600">Kaynak: '+kb.source+'</p></div><div class="hidden group-hover:flex gap-1"><button onclick="previewFile(null,'+kb.id+')" class="w-7 h-7 rounded bg-gray-700 hover:bg-blue-600 text-[11px] text-gray-300 flex items-center justify-center" title="Onizle">\uD83D\uDC41</button><button onclick="downloadFile({name:\''+kb.title.replace(/'/g,"\\'")+'\',fileId:\''+((kb.fileId)||'')+'\',fileUrl:\''+((kb.fileUrl)||'')+'\',dataUri:null})" class="w-7 h-7 rounded bg-gray-700 hover:bg-green-600 text-[11px] text-gray-300 flex items-center justify-center" title="Indir">\u2B07</button><button onclick="confirmDelete(\'kb\','+kb.id+')" class="w-7 h-7 rounded bg-gray-700 hover:bg-red-600 text-[11px] text-gray-300 flex items-center justify-center" title="Sil">&times;</button></div></div>';
        });
        html+='</div></div>';
    });
    // Deleted KB for admin
    if(deletedKB.length>0&&currentUser&&(currentUser.role==='admin'||currentUser.role==='Yonetici')){
        html+='<div class="glass rounded-xl p-4 border border-red-500/20"><div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold flex items-center gap-2"><span class="text-red-400">\uD83D\uDDD1</span>Silinen Kayitlar</h4><span class="text-[10px] text-gray-500">'+deletedKB.length+'</span></div><div class="space-y-2">';
        deletedKB.forEach(kb=>{
            html+='<div class="flex items-center gap-3 p-2 rounded-lg bg-red-500/5 opacity-60"><span class="text-lg">'+(fileEmojis[kb.fileType]||'\uD83D\uDCC1')+'</span><div class="flex-1 min-w-0"><p class="text-xs font-medium truncate line-through">'+kb.title+'</p><p class="text-[10px] text-gray-600">Silen: '+(kb.deletedBy||'?')+'</p></div><button onclick="restoreKBEntry('+kb.id+')" class="px-2 py-1 rounded bg-green-600/20 hover:bg-green-600 text-[10px] text-green-400 transition-colors">Geri Yukle</button></div>';
        });
        html+='</div></div>';
    }
    html+='</div>';
    container.innerHTML=html;
}

function deleteKBEntry(kbId){
    confirmDelete('kb',kbId);
}

// ===================== DOSYA ONIZLEME & INDIRME =====================
function previewFile(channelId,fileId){
    const files=S.connFiles[channelId]||[];
    let file=files.find(f=>f.id===fileId);
    if(!file){
        // Search in all channels
        for(const[ch,fList]of Object.entries(S.connFiles)){
            const found=fList.find(f=>f.id===fileId);
            if(found){file=found;break;}
        }
    }
    if(!file){
        // Try knowledge base
        const kb=S.knowledgeBase.find(k=>k.id===fileId);
        if(kb)file={name:kb.title,type:kb.fileType,size:'',fileId:kb.fileId,fileUrl:kb.fileUrl,dataUri:kb.dataUri,uploadedBy:kb.addedBy,uploadedAt:kb.addedAt,desc:kb.desc};
    }
    if(!file){showNotif('Dosya bulunamadi.');return;}

    document.getElementById('preview-file-icon').textContent=fileEmojis[file.type]||'\uD83D\uDCC1';
    document.getElementById('preview-file-name').textContent=file.name;
    document.getElementById('preview-file-meta').textContent=[file.type,file.size,file.uploadedBy,file.uploadedAt?new Date(file.uploadedAt).toLocaleDateString('tr-TR'):''].filter(Boolean).join(' \u00B7 ');
    document.getElementById('preview-download-btn').onclick=()=>downloadFile(file);

    const content=document.getElementById('preview-content');
    const src=file.fileUrl||(file.fileId?API_BASE+'/api/uploads/'+file.fileId:null)||file.dataUri;

    if(!src){
        content.innerHTML='<div class="text-center py-16"><span class="text-6xl mb-4 block">'+(fileEmojis[file.type]||'\uD83D\uDCC1')+'</span><p class="text-gray-400 text-sm">Bu dosya sadece metadata olarak kayitli.</p><p class="text-gray-500 text-xs mt-1">Dosya icerigi henuz yuklenmemis.</p></div>';
        openModal('modal-file-preview');
        return;
    }

    if(file.type==='IMG'){
        content.innerHTML='<img src="'+src+'" alt="'+file.name+'" style="max-width:100%;max-height:75vh;object-fit:contain;" class="mx-auto">';
    }else if(file.type==='PDF'){
        content.innerHTML='<iframe src="'+src+'" style="width:100%;height:75vh;border:none;" title="'+file.name+'"></iframe>';
    }else{
        content.innerHTML='<div class="text-center py-16"><span class="text-7xl mb-4 block">'+(fileEmojis[file.type]||'\uD83D\uDCC1')+'</span><p class="text-white text-lg font-semibold mb-2">'+file.name+'</p><div class="inline-grid grid-cols-2 gap-x-6 gap-y-2 text-left text-xs"><span class="text-gray-500">Tur:</span><span>'+file.type+'</span><span class="text-gray-500">Boyut:</span><span>'+(file.size||'Bilinmiyor')+'</span><span class="text-gray-500">Yukleyen:</span><span>'+(file.uploadedBy||'-')+'</span><span class="text-gray-500">Tarih:</span><span>'+(file.uploadedAt?new Date(file.uploadedAt).toLocaleDateString('tr-TR'):'-')+'</span></div>'+(file.desc?'<p class="text-gray-400 text-xs mt-4">'+file.desc+'</p>':'')+'</div>';
    }
    openModal('modal-file-preview');
}

function downloadFile(file){
    const src=file.fileUrl||(file.fileId?API_BASE+'/api/uploads/'+file.fileId:null)||file.dataUri;
    if(!src){showNotif('Bu dosya indirilemez - icerik bulunamadi.');return;}
    const a=document.createElement('a');
    a.href=src;
    a.download=file.name||'dosya';
    a.target='_blank';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showNotif(file.name+' indiriliyor...');
}

// ===================== SILME KORUMASI - YONETICI ONAY AKISI =====================
let pendingDelete={type:null,id:null,extra:null};

function confirmDelete(type,id,extra){
    pendingDelete={type,id,extra};
    const isAdmin=currentUser&&(currentUser.role==='admin'||currentUser.role==='Yonetici');

    let itemName='';
    let canDel=true;
    let warning='';

    if(type==='file'){
        const ch=extra;
        const files=S.connFiles[ch]||[];
        const file=files.find(f=>f.id===id);
        if(file){
            itemName=file.name;
            if(currentUser&&file.uploadedBy!==currentUser.name&&!isAdmin){
                canDel=false;
                warning='Bu dosyayi sadece yukleyen kisi ('+file.uploadedBy+') veya yonetici silebilir.';
            }
        }
    }else if(type==='kb'){
        const kb=S.knowledgeBase.find(k=>k.id===id);
        if(kb){
            itemName=kb.title;
            if(currentUser&&kb.addedBy!==currentUser.name&&!isAdmin){
                canDel=false;
                warning='Bu kaydi sadece ekleyen kisi ('+kb.addedBy+') veya yonetici silebilir.';
            }
        }
    }else if(type==='message'){
        const msgs=S.messages[S.currentChannel]||[];
        const m=msgs.find(x=>x.id===id);
        if(m){
            itemName='Mesaj';
            if(currentUser&&!m.mine&&!isAdmin){
                canDel=false;
                warning='Sadece kendi mesajlarinizi veya yonetici olarak baskalarinin mesajlarini silebilirsiniz.';
            }
        }
    }

    if(!canDel){
        // Permission denied - show warning
        document.getElementById('delete-request-msg').textContent=warning;
        document.getElementById('delete-request-reason').value='';
        // Actually just show inline error
        openModal('modal-delete-request');
        showNotif(warning,'error');
        return;
    }

    if(isAdmin){
        // Admin: direct delete with confirmation
        const msg='\"'+itemName+'\" silmek istediginize emin misiniz? (Yonetici yetkisi ile dogrudan silinecek)';
        document.getElementById('delete-confirm-msg').textContent=msg;
        const warnEl=document.getElementById('delete-permission-warning');
        warnEl.classList.add('hidden');
        document.querySelector('#modal-confirm-delete .bg-red-600').disabled=false;
        document.querySelector('#modal-confirm-delete .bg-red-600').classList.remove('opacity-50','cursor-not-allowed');
        openModal('modal-confirm-delete');
    }else{
        // Normal user: create deletion request for admin approval
        const msg='\"'+itemName+'\" icin silme talebi olusturulacak. Yonetici onayindan sonra silinecektir.';
        document.getElementById('delete-request-msg').textContent=msg;
        document.getElementById('delete-request-reason').value='';
        openModal('modal-delete-request');
    }
}

function submitDeleteRequest(){
    const{type,id,extra}=pendingDelete;
    if(!type)return;
    const reason=document.getElementById('delete-request-reason').value.trim();

    let itemName='',itemInfo='';
    if(type==='file'){
        const files=S.connFiles[extra]||[];
        const file=files.find(f=>f.id===id);
        if(file){itemName=file.name;itemInfo=file.type+' ¬∑ '+file.size+' ¬∑ #'+extra;}
    }else if(type==='kb'){
        const kb=S.knowledgeBase.find(k=>k.id===id);
        if(kb){itemName=kb.title;itemInfo=kb.category+' ¬∑ '+kb.fileType;}
    }else if(type==='message'){
        const msgs=S.messages[S.currentChannel]||[];
        const m=msgs.find(x=>x.id===id);
        if(m){itemName='Mesaj: "'+m.text.substring(0,50)+(m.text.length>50?'...':'')+'"';itemInfo='#'+S.currentChannel+' ¬∑ '+m.user;}
    }

    const request={
        id:Date.now(),
        type:type,
        itemId:id,
        itemExtra:extra,
        itemName:itemName,
        itemInfo:itemInfo,
        requestedBy:currentUser?currentUser.name:'Bilinmeyen',
        requestedById:currentUser?currentUser.id:0,
        requestedAt:new Date().toISOString(),
        reason:reason||'',
        status:'pending' // pending, approved, rejected
    };

    S.pendingDeletions.push(request);
    save();
    updateDeletionBadge();
    closeModal('modal-delete-request');
    showNotif('Silme talebi yoneticiye iletildi. Onay bekliyor.');
    pendingDelete={type:null,id:null,extra:null};

    // Play notification sound for admin if online
    if(typeof playNotifSound==='function')playNotifSound();
}

function executeDelete(){
    const{type,id,extra}=pendingDelete;
    if(type==='file'){
        const ch=extra;
        if(!S.connFiles[ch])return;
        const file=S.connFiles[ch].find(f=>f.id===id);
        if(file){
            file.deleted=true;
            file.deletedAt=new Date().toISOString();
            file.deletedBy=currentUser?currentUser.name:'Bilinmeyen';
            if(file.fileId&&backendAvailable&&authToken){
                fetch(API_BASE+'/api/uploads/'+file.fileId,{method:'DELETE',headers:{'Authorization':'Bearer '+authToken}}).catch(()=>{});
            }
        }
        save();renderConnFiles();showNotif('Dosya silindi (Yonetici yetkisi).');
    }else if(type==='kb'){
        const kb=S.knowledgeBase.find(k=>k.id===id);
        if(kb){
            kb.deleted=true;
            kb.deletedAt=new Date().toISOString();
            kb.deletedBy=currentUser?currentUser.name:'Bilinmeyen';
        }
        save();renderKnowledgeBase();showNotif('Bilgi bankasi kaydi silindi (Yonetici yetkisi).');
    }else if(type==='message'){
        const msgs=S.messages[S.currentChannel];
        if(msgs){
            S.messages[S.currentChannel]=msgs.filter(m=>m.id!==id);
            save();renderMessages();showNotif('Mesaj silindi (Yonetici yetkisi).');
        }
    }
    closeModal('modal-confirm-delete');
    pendingDelete={type:null,id:null,extra:null};
}

// ===================== YONETICI ONAY PANELI =====================
function openDeletionRequests(){
    renderDeletionRequests();
    openModal('modal-deletion-requests');
}

function renderDeletionRequests(){
    const container=document.getElementById('deletion-requests-list');
    if(!container)return;
    const pending=S.pendingDeletions.filter(r=>r.status==='pending');
    const processed=S.pendingDeletions.filter(r=>r.status!=='pending').slice(-10).reverse();

    if(pending.length===0&&processed.length===0){
        container.innerHTML='<div class="text-center py-12"><div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg></div><p class="text-gray-400 text-sm">Bekleyen silme talebi yok</p><p class="text-gray-500 text-xs mt-1">Tum talepler islendiginde burada gorunur.</p></div>';
        return;
    }

    let html='';

    if(pending.length>0){
        html+='<div class="mb-4"><h4 class="text-xs font-semibold text-orange-400 mb-2 flex items-center gap-1.5">&#9203; Bekleyen Talepler ('+pending.length+')</h4>';
        pending.forEach(r=>{
            const timeAgo=getTimeAgo(r.requestedAt);
            const typeIcon=r.type==='file'?'&#128196;':r.type==='kb'?'&#128218;':'&#128172;';
            const typeLabel=r.type==='file'?'Dosya':r.type==='kb'?'Bilgi Bankasi':'Mesaj';
            html+='<div class="p-3 rounded-xl bg-orange-500/5 border border-orange-500/20 mb-2">';
            html+='<div class="flex items-start gap-3">';
            html+='<div class="w-9 h-9 rounded-full bg-orange-500/20 flex items-center justify-center flex-shrink-0"><span class="text-lg">'+typeIcon+'</span></div>';
            html+='<div class="flex-1 min-w-0">';
            html+='<div class="flex items-center gap-2 mb-1"><span class="text-[10px] px-1.5 py-0.5 rounded-full bg-orange-500/20 text-orange-400 font-medium">'+typeLabel+'</span><span class="text-[10px] text-gray-500">'+timeAgo+'</span></div>';
            html+='<p class="text-xs font-medium text-gray-200 truncate">'+r.itemName+'</p>';
            html+='<p class="text-[10px] text-gray-500">'+r.itemInfo+'</p>';
            html+='<p class="text-[10px] text-gray-400 mt-1"><span class="text-gray-500">Talep eden:</span> '+r.requestedBy+'</p>';
            if(r.reason)html+='<p class="text-[10px] text-gray-400 mt-0.5"><span class="text-gray-500">Sebep:</span> '+r.reason+'</p>';
            html+='<div class="flex gap-2 mt-2">';
            html+='<button onclick="approveDeletion('+r.id+')" class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-[11px] font-medium transition-colors flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Onayla ve Sil</button>';
            html+='<button onclick="rejectDeletion('+r.id+')" class="px-3 py-1.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-[11px] font-medium transition-colors flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>Reddet</button>';
            html+='</div></div></div></div>';
        });
        html+='</div>';
    }

    if(processed.length>0){
        html+='<div><h4 class="text-xs font-semibold text-gray-500 mb-2">Gecmis Islemler</h4>';
        processed.forEach(r=>{
            const statusColor=r.status==='approved'?'red':'gray';
            const statusText=r.status==='approved'?'Onaylandi (Silindi)':'Reddedildi';
            const statusIcon=r.status==='approved'?'&#10003;':'&#10007;';
            html+='<div class="p-2.5 rounded-lg bg-gray-800/30 mb-1.5 opacity-60">';
            html+='<div class="flex items-center gap-2">';
            html+='<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-'+statusColor+'-500/20 text-'+statusColor+'-400 font-medium">'+statusIcon+' '+statusText+'</span>';
            html+='<span class="text-[10px] text-gray-500 truncate flex-1">'+r.itemName+'</span>';
            html+='<span class="text-[10px] text-gray-600">'+r.requestedBy+'</span>';
            html+='</div>';
            if(r.processedBy)html+='<p class="text-[10px] text-gray-600 mt-0.5">Isleyen: '+r.processedBy+' ¬∑ '+(r.processedAt?new Date(r.processedAt).toLocaleString('tr-TR'):'')+'</p>';
            html+='</div>';
        });
        html+='</div>';
    }
    container.innerHTML=html;
}

function getTimeAgo(dateStr){
    const diff=Date.now()-new Date(dateStr).getTime();
    const mins=Math.floor(diff/60000);
    if(mins<1)return 'Az once';
    if(mins<60)return mins+' dk once';
    const hours=Math.floor(mins/60);
    if(hours<24)return hours+' saat once';
    const days=Math.floor(hours/24);
    return days+' gun once';
}

function approveDeletion(requestId){
    const req=S.pendingDeletions.find(r=>r.id===requestId);
    if(!req||req.status!=='pending')return;

    // Execute the actual deletion
    if(req.type==='file'){
        const ch=req.itemExtra;
        if(S.connFiles[ch]){
            const file=S.connFiles[ch].find(f=>f.id===req.itemId);
            if(file){
                file.deleted=true;
                file.deletedAt=new Date().toISOString();
                file.deletedBy=currentUser?currentUser.name:'Yonetici';
                if(file.fileId&&backendAvailable&&authToken){
                    fetch(API_BASE+'/api/uploads/'+file.fileId,{method:'DELETE',headers:{'Authorization':'Bearer '+authToken}}).catch(()=>{});
                }
            }
        }
        renderConnFiles();
    }else if(req.type==='kb'){
        const kb=S.knowledgeBase.find(k=>k.id===req.itemId);
        if(kb){
            kb.deleted=true;
            kb.deletedAt=new Date().toISOString();
            kb.deletedBy=currentUser?currentUser.name:'Yonetici';
        }
        renderKnowledgeBase();
    }else if(req.type==='message'){
        const ch=req.itemExtra||S.currentChannel;
        const msgs=S.messages[ch];
        if(msgs){
            S.messages[ch]=msgs.filter(m=>m.id!==req.itemId);
            renderMessages();
        }
    }

    req.status='approved';
    req.processedBy=currentUser?currentUser.name:'Yonetici';
    req.processedAt=new Date().toISOString();
    save();
    updateDeletionBadge();
    renderDeletionRequests();
    showNotif('Silme talebi onaylandi. \"'+req.itemName+'\" silindi.');
}

function rejectDeletion(requestId){
    const req=S.pendingDeletions.find(r=>r.id===requestId);
    if(!req||req.status!=='pending')return;

    req.status='rejected';
    req.processedBy=currentUser?currentUser.name:'Yonetici';
    req.processedAt=new Date().toISOString();
    save();
    updateDeletionBadge();
    renderDeletionRequests();
    showNotif('Silme talebi reddedildi. \"'+req.itemName+'\" korundu.');
}

function updateDeletionBadge(){
    const btn=document.getElementById('btn-deletion-requests');
    const badge=document.getElementById('deletion-request-badge');
    if(!btn||!badge)return;
    const isAdmin=currentUser&&(currentUser.role==='admin'||currentUser.role==='Yonetici');
    const pendingCount=S.pendingDeletions.filter(r=>r.status==='pending').length;

    if(isAdmin){
        btn.classList.remove('hidden');
        btn.classList.add('flex');
        badge.textContent=pendingCount;
        if(pendingCount>0){
            badge.classList.remove('bg-gray-600');
            badge.classList.add('bg-orange-500');
        }else{
            badge.classList.remove('bg-orange-500');
            badge.classList.add('bg-gray-600');
        }
    }else{
        btn.classList.add('hidden');
        btn.classList.remove('flex');
    }
}

function restoreFile(channelId,fileId){
    if(!currentUser||currentUser.role!=='admin'&&currentUser.role!=='Yonetici'){
        showNotif('Sadece yoneticiler dosya geri yukleyebilir.');return;
    }
    const files=S.connFiles[channelId]||[];
    const file=files.find(f=>f.id===fileId);
    if(file){
        delete file.deleted;
        delete file.deletedAt;
        delete file.deletedBy;
        save();renderConnFiles();showNotif('Dosya geri yuklendi: '+file.name);
    }
}

function restoreKBEntry(kbId){
    if(!currentUser||currentUser.role!=='admin'&&currentUser.role!=='Yonetici'){
        showNotif('Sadece yoneticiler kayit geri yukleyebilir.');return;
    }
    const kb=S.knowledgeBase.find(k=>k.id===kbId);
    if(kb){
        delete kb.deleted;
        delete kb.deletedAt;
        delete kb.deletedBy;
        save();renderKnowledgeBase();showNotif('Kayit geri yuklendi: '+kb.title);
    }
}

// ===================== SOCKET.IO & REAL-TIME =====================
let socket=null;
let typingTimer=null;
let isTyping=false;
let userPresence={};
let mentionQuery='';
let replyToMsg=null;
let soundMuted=false;

function initSocket(){
    if(!backendAvailable||!authToken)return;
    try{
        socket=io(window.location.origin,{auth:{token:authToken},transports:['websocket','polling']});
        socket.on('connect',()=>{
            console.log('[Socket] Connected:',socket.id);
            // Join current channel
            if(S.currentChannel)socket.emit('channel:join',{channelId:S.currentChannel});
        });
        socket.on('disconnect',()=>console.log('[Socket] Disconnected'));

        // ---- Incoming messages ----
        socket.on('message:new',(msg)=>{
            if(!S.messages[msg.channelId])S.messages[msg.channelId]=[];
            S.messages[msg.channelId].push({
                id:msg.id,user:msg.user,text:msg.text,time:msg.time,
                mine:msg.userId===(currentUser?currentUser.id:''),
                replyTo:msg.replyTo||null,reactions:msg.reactions||{},readBy:msg.readBy||[]
            });
            if(msg.channelId===S.currentChannel)renderMessages();
            else updateChannelBadge(msg.channelId);
            // Sound + push
            if(msg.userId!==(currentUser?currentUser.id:'')){
                playNotifSound();
                showBrowserNotif(msg.user+' (#'+msg.channelId+')',msg.text.replace(/<[^>]*>/g,'').substring(0,80));
            }
            save();
        });
        socket.on('message:updated',(data)=>{
            const msgs=S.messages[data.channelId||S.currentChannel]||[];
            const m=msgs.find(x=>x.id===data.messageId);
            if(m){m.text=data.text;m.edited=true;}
            if((data.channelId||S.currentChannel)===S.currentChannel)renderMessages();
        });
        socket.on('message:deleted',(data)=>{
            const ch=data.channelId||S.currentChannel;
            if(S.messages[ch])S.messages[ch]=S.messages[ch].filter(m=>m.id!==data.messageId);
            if(ch===S.currentChannel)renderMessages();
        });

        // ---- Typing ----
        socket.on('user:typing',(data)=>{
            if(data.channelId===S.currentChannel)showTypingIndicator(data.name);
        });
        socket.on('user:stopped-typing',(data)=>{
            if(data.channelId===S.currentChannel)hideTypingIndicator(data.name);
        });

        // ---- Presence ----
        socket.on('presence:list',(list)=>{
            userPresence={};
            list.forEach(u=>{userPresence[u.userId]={name:u.name,status:u.status};});
            updatePresenceUI();
        });
        socket.on('user:online',(data)=>{
            userPresence[data.userId]={name:data.name,status:'online'};
            updatePresenceUI();
        });
        socket.on('user:offline',(data)=>{
            if(userPresence[data.userId])userPresence[data.userId].status='offline';
            updatePresenceUI();
        });
        socket.on('user:status-changed',(data)=>{
            if(userPresence[data.userId])userPresence[data.userId].status=data.status;
            updatePresenceUI();
        });

        // ---- Read receipts ----
        socket.on('message:read-receipt',(data)=>{
            const msgs=S.messages[S.currentChannel]||[];
            data.messageIds.forEach(mid=>{
                const m=msgs.find(x=>x.id===mid);
                if(m){if(!m.readBy)m.readBy=[];if(!m.readBy.includes(data.userId))m.readBy.push(data.userId);}
            });
            renderMessages();
        });

        // ---- Reactions ----
        socket.on('reaction:added',(data)=>{
            const msgs=S.messages[S.currentChannel]||[];
            const m=msgs.find(x=>x.id===data.messageId);
            if(m){
                if(!m.reactions)m.reactions={};
                if(!m.reactions[data.emoji])m.reactions[data.emoji]=[];
                if(!m.reactions[data.emoji].includes(data.name))m.reactions[data.emoji].push(data.name);
                renderMessages();
            }
        });
        socket.on('reaction:removed',(data)=>{
            const msgs=S.messages[S.currentChannel]||[];
            const m=msgs.find(x=>x.id===data.messageId);
            if(m&&m.reactions&&m.reactions[data.emoji]){
                m.reactions[data.emoji]=m.reactions[data.emoji].filter(n=>n!==data.name);
                if(m.reactions[data.emoji].length===0)delete m.reactions[data.emoji];
                renderMessages();
            }
        });

        // ---- Mentions ----
        socket.on('mention:received',(data)=>{
            showNotif(data.mentionedBy+' sizi #'+data.channelId+' kanalinda etiketledi!');
            playNotifSound();
        });

        // ---- Meetings ----
        socket.on('meeting:new',(data)=>{
            showNotif('Yeni toplanti: '+data.title+' ('+data.createdBy+')');
        });

    }catch(e){console.warn('[Socket] Init failed:',e);}
}

function disconnectSocket(){if(socket){socket.disconnect();socket=null;}}

function updateChannelBadge(chId){
    // Update unread indicators on channel list
    renderChannels();
}

// ---- Typing indicators ----
const typingUsers=new Set();

function handleTyping(){
    if(!socket||!socket.connected)return;
    if(!isTyping){
        isTyping=true;
        socket.emit('typing:start',{channelId:S.currentChannel});
    }
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>{
        isTyping=false;
        socket.emit('typing:stop',{channelId:S.currentChannel});
    },3000);
}

function showTypingIndicator(name){
    typingUsers.add(name);
    const el=document.getElementById('typing-indicator');
    if(el){
        const names=[...typingUsers];
        el.textContent=names.length===1?names[0]+' yaziyor...':names.join(', ')+' yaziyor...';
        el.classList.remove('hidden');
    }
}
function hideTypingIndicator(name){
    typingUsers.delete(name);
    const el=document.getElementById('typing-indicator');
    if(el){
        if(typingUsers.size===0)el.classList.add('hidden');
        else{const names=[...typingUsers];el.textContent=names.join(', ')+' yaziyor...';}
    }
}

// ---- Presence UI ----
function updatePresenceUI(){
    // Update sidebar user status dots
    document.querySelectorAll('[data-user-presence]').forEach(el=>{
        const uid=el.getAttribute('data-user-presence');
        const p=userPresence[uid];
        const statusColors={online:'bg-green-500',away:'bg-yellow-500',busy:'bg-red-500',offline:'bg-gray-500'};
        el.className='w-2.5 h-2.5 rounded-full '+(p?statusColors[p.status]||'bg-gray-500':'bg-gray-500');
    });
}

// ---- User status ----
function setUserStatus(status){
    if(!socket||!socket.connected)return;
    socket.emit('user:status-change',{status});
}

// Activity watcher for auto-away
let activityTimeout=null;
function startActivityWatcher(){
    const resetActivity=()=>{
        clearTimeout(activityTimeout);
        if(socket&&socket.connected){
            const myP=userPresence[currentUser?currentUser.id:''];
            if(myP&&myP.status==='away')setUserStatus('online');
        }
        activityTimeout=setTimeout(()=>{if(socket&&socket.connected)setUserStatus('away');},300000); // 5 min
    };
    ['mousemove','keydown','click','scroll','touchstart'].forEach(e=>document.addEventListener(e,resetActivity,{passive:true}));
    document.addEventListener('visibilitychange',()=>{
        if(document.hidden){if(socket&&socket.connected)setUserStatus('away');}
        else resetActivity();
    });
    resetActivity();
}

// ---- Read receipts ----
function markMessagesRead(){
    if(!socket||!socket.connected)return;
    const msgs=S.messages[S.currentChannel]||[];
    const unread=msgs.filter(m=>!m.mine&&(!m.readBy||!m.readBy.includes(currentUser?currentUser.id:''))).map(m=>m.id);
    if(unread.length>0){
        socket.emit('message:read',{channelId:S.currentChannel,messageIds:unread});
        unread.forEach(mid=>{
            const m=msgs.find(x=>x.id===mid);
            if(m){if(!m.readBy)m.readBy=[];m.readBy.push(currentUser?currentUser.id:'');}
        });
    }
}

// ---- Reactions ----
function toggleReactionPicker(msgId){
    const existing=document.getElementById('reaction-picker-'+msgId);
    if(existing){existing.remove();return;}
    // Remove any other open pickers
    document.querySelectorAll('[id^="reaction-picker-"]').forEach(el=>el.remove());
    const REACT_EMOJIS=['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','‚úÖ','üëè','üéâ','üôè'];
    const picker=document.createElement('div');
    picker.id='reaction-picker-'+msgId;
    picker.className='fixed flex gap-2 p-2.5 rounded-xl border border-gray-600 shadow-2xl';
    picker.style.cssText='min-height:44px;line-height:1;background:rgba(20,25,40,0.97);backdrop-filter:blur(20px);z-index:9999;';
    picker.innerHTML=REACT_EMOJIS.map(e=>'<span class="cursor-pointer hover:scale-125 transition-transform" style="font-size:22px;line-height:1;" onclick="addReaction('+msgId+',\''+e+'\')">'+e+'</span>').join('');
    const msgEl=document.querySelector('[data-msg-id="'+msgId+'"]');
    if(msgEl){
        const rect=msgEl.getBoundingClientRect();
        picker.style.left=rect.left+'px';
        picker.style.top=(rect.top-50)+'px';
        document.body.appendChild(picker);
    }
}

function addReaction(msgId,emoji){
    const msgs=S.messages[S.currentChannel]||[];
    const m=msgs.find(x=>x.id===msgId);
    if(!m)return;
    if(!m.reactions)m.reactions={};
    const userName=currentUser?currentUser.name:'Bilinmeyen';
    if(!m.reactions[emoji])m.reactions[emoji]=[];
    const idx=m.reactions[emoji].indexOf(userName);
    if(idx>=0){
        m.reactions[emoji].splice(idx,1);
        if(m.reactions[emoji].length===0)delete m.reactions[emoji];
        if(socket&&socket.connected)socket.emit('reaction:remove',{channelId:S.currentChannel,messageId:msgId,emoji});
    }else{
        m.reactions[emoji].push(userName);
        if(socket&&socket.connected)socket.emit('reaction:add',{channelId:S.currentChannel,messageId:msgId,emoji});
    }
    document.querySelectorAll('[id^="reaction-picker-"]').forEach(el=>el.remove());
    save();renderMessages();
}

function renderReactions(m){
    if(!m.reactions||Object.keys(m.reactions).length===0)return '';
    let html='<div class="flex flex-wrap gap-1 mt-1">';
    const userName=currentUser?currentUser.name:'';
    for(const[emoji,users]of Object.entries(m.reactions)){
        const mine=users.includes(userName);
        html+='<button onclick="addReaction('+m.id+',\''+emoji+'\')" class="flex items-center gap-0.5 px-1.5 py-0.5 rounded-full text-[10px] transition-colors '+(mine?'bg-blue-500/20 border border-blue-500/30':'bg-gray-700/50 hover:bg-gray-700 border border-transparent')+'" title="'+users.join(', ')+'">'+emoji+' '+users.length+'</button>';
    }
    html+='</div>';
    return html;
}

// ---- Read receipt indicators ----
function renderReadReceipt(m){
    if(!m.mine)return '';
    const totalMembers=S.channels.find(c=>c.id===S.currentChannel)?.memberList?.length||S.channels.find(c=>c.id===S.currentChannel)?.members||1;
    const readCount=(m.readBy||[]).length;
    if(readCount>=totalMembers)return '<span class="text-blue-400 text-[9px]" title="Herkes√ße okundu">‚úì‚úì</span>';
    if(readCount>1)return '<span class="text-gray-400 text-[9px]" title="'+readCount+' kisi okudu">‚úì‚úì</span>';
    return '<span class="text-gray-600 text-[9px]" title="Gonderildi">‚úì</span>';
}

// ---- @Mention system ----
function handleMentionInput(e){
    const inp=document.getElementById('msg-input');
    const val=inp.value;
    const cursorPos=inp.selectionStart;
    // Check if @ was typed
    const textBefore=val.substring(0,cursorPos);
    const atIdx=textBefore.lastIndexOf('@');
    if(atIdx>=0&&(atIdx===0||textBefore[atIdx-1]===' ')){
        mentionQuery=textBefore.substring(atIdx+1).toLowerCase();
        if(mentionQuery.length>=0&&mentionQuery.indexOf(' ')===-1){
            showMentionDropdown(mentionQuery,inp);
            return;
        }
    }
    hideMentionDropdown();
}

function showMentionDropdown(query,inp){
    const dd=document.getElementById('mention-dropdown');
    if(!dd)return;
    const users=S.users.filter(u=>u.name.toLowerCase().includes(query)||u.email?.toLowerCase().includes(query));
    if(users.length===0){hideMentionDropdown();return;}
    const rect=inp.getBoundingClientRect();
    dd.style.left=rect.left+'px';
    dd.style.bottom=(window.innerHeight-rect.top+4)+'px';
    dd.innerHTML=users.slice(0,6).map(u=>{
        const statusDot=userPresence[u.id]?'<span class="w-2 h-2 rounded-full '+(userPresence[u.id].status==='online'?'bg-green-500':userPresence[u.id].status==='away'?'bg-yellow-500':'bg-gray-500')+'"></span>':'';
        return '<div class="flex items-center gap-2 px-3 py-2 hover:bg-gray-700 cursor-pointer text-xs" onclick="selectMention(\''+u.name.replace(/'/g,"\\'")+'\')">'+statusDot+'<span>'+u.name+'</span><span class="text-gray-500 text-[10px]">'+u.role+'</span></div>';
    }).join('');
    dd.classList.remove('hidden');
}

function selectMention(name){
    const inp=document.getElementById('msg-input');
    const val=inp.value;
    const cursorPos=inp.selectionStart;
    const textBefore=val.substring(0,cursorPos);
    const atIdx=textBefore.lastIndexOf('@');
    inp.value=val.substring(0,atIdx)+'@'+name+' '+val.substring(cursorPos);
    inp.focus();
    inp.selectionStart=inp.selectionEnd=atIdx+name.length+2;
    hideMentionDropdown();
}

function hideMentionDropdown(){
    const dd=document.getElementById('mention-dropdown');
    if(dd)dd.classList.add('hidden');
}

function renderMentions(text){
    // Try full names first (multi-word like "Mehmet Kaya")
    const userNames=(S.users||[]).map(u=>u.name).sort((a,b)=>b.length-a.length);
    let result=text;
    userNames.forEach(name=>{
        const escaped=name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        result=result.replace(new RegExp('@'+escaped,'g'),'<span class="text-blue-400 font-semibold bg-blue-500/10 px-1 rounded cursor-pointer">@'+name+'</span>');
    });
    // Convert URLs to clickable links (but skip if already in HTML tag)
    result=result.replace(/(https?:\/\/[^\s<>"']+)/gi,function(url){
        return '<a href="'+url+'" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline underline-offset-2">'+url+'</a>';
    });
    return result;
}

// ---- Reply/Thread ----
function startReply(msgId){
    const msgs=S.messages[S.currentChannel]||[];
    const m=msgs.find(x=>x.id===msgId);
    if(!m)return;
    replyToMsg={id:m.id,user:m.user,text:(m.text||'').replace(/<[^>]*>/g,'').substring(0,100)};
    document.getElementById('reply-to-name').textContent=m.user;
    document.getElementById('reply-to-text').textContent=replyToMsg.text;
    document.getElementById('reply-indicator').classList.remove('hidden');
    document.getElementById('msg-input').focus();
}

function cancelReply(){
    replyToMsg=null;
    document.getElementById('reply-indicator').classList.add('hidden');
}

function scrollToMessage(msgId){
    const chatEl=document.getElementById('chat-messages');
    if(!chatEl)return;
    const msgEl=chatEl.querySelector('[data-msg-id="'+msgId+'"]');
    if(msgEl){
        msgEl.scrollIntoView({behavior:'smooth',block:'center'});
        msgEl.classList.add('ring-1','ring-yellow-500/50');
        setTimeout(()=>msgEl.classList.remove('ring-1','ring-yellow-500/50'),3000);
    }
}

// ---- Notification Sound ----
let audioCtx=null;
function playNotifSound(){
    if(soundMuted)return;
    if(!S.bildirimAyarlar||S.bildirimAyarlar.sesAktif===false)return;
    try{
        if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
        const osc=audioCtx.createOscillator();
        const gain=audioCtx.createGain();
        osc.connect(gain);gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(800,audioCtx.currentTime);
        osc.frequency.setValueAtTime(600,audioCtx.currentTime+0.1);
        gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime+0.3);
    }catch(e){}
}

function toggleMuteSound(){
    soundMuted=!soundMuted;
    const btn=document.getElementById('mute-toggle-btn');
    if(btn)btn.innerHTML=soundMuted?'&#128263;':'&#128266;';
    showNotif(soundMuted?'Bildirim sesi kapatildi':'Bildirim sesi acildi');
}

// ---- Browser Push Notifications ----
function requestNotifPermission(){
    if('Notification' in window&&Notification.permission==='default'){
        Notification.requestPermission();
    }
}

function showBrowserNotif(title,body){
    if(document.hasFocus())return;
    if(!('Notification' in window)||Notification.permission!=='granted')return;
    try{
        const n=new Notification(title,{body:body.substring(0,120),icon:'/favicon.ico',tag:'faonsist-msg'});
        n.onclick=()=>{window.focus();n.close();};
        setTimeout(()=>n.close(),5000);
    }catch(e){}
}

// ---- Meeting Frontend ----
function renderMeetings(){
    const container=document.getElementById('meetings-list');
    if(!container)return;
    const meetings=S.meetings||[];
    if(meetings.length===0){
        container.innerHTML='<div class="text-center py-12"><span class="text-4xl block mb-3">üìÖ</span><p class="text-gray-400 text-sm">Henuz toplanti yok</p><p class="text-gray-500 text-xs mt-1">Yeni toplanti planlamak icin butonu kullanin.</p></div>';
        return;
    }
    const now=new Date();
    const upcoming=meetings.filter(m=>new Date(m.startTime)>=now).sort((a,b)=>new Date(a.startTime)-new Date(b.startTime));
    const past=meetings.filter(m=>new Date(m.startTime)<now).sort((a,b)=>new Date(b.startTime)-new Date(a.startTime));
    let html='';
    if(upcoming.length>0){
        html+='<h4 class="text-xs font-semibold text-green-400 mb-2">Yaklasan Toplantilar ('+upcoming.length+')</h4><div class="space-y-2 mb-4">';
        upcoming.forEach(m=>html+=renderMeetingCard(m));
        html+='</div>';
    }
    if(past.length>0){
        html+='<h4 class="text-xs font-semibold text-gray-500 mb-2">Gecmis ('+past.length+')</h4><div class="space-y-2">';
        past.slice(0,5).forEach(m=>html+=renderMeetingCard(m,true));
        html+='</div>';
    }
    container.innerHTML=html;
}

function renderMeetingCard(m,past){
    const start=new Date(m.startTime);
    const end=new Date(m.endTime);
    const dateStr=start.toLocaleDateString('tr-TR',{day:'2-digit',month:'short'});
    const timeStr=start.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})+' - '+end.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    const parts=Array.isArray(m.participants)?m.participants:[];
    return '<div class="glass rounded-xl p-3 '+(past?'opacity-60':'')+'"><div class="flex items-start justify-between"><div class="flex-1"><p class="text-xs font-semibold">'+m.title+'</p><p class="text-[10px] text-gray-400 mt-0.5">'+dateStr+' \u00B7 '+timeStr+'</p>'+(m.description?'<p class="text-[10px] text-gray-500 mt-1">'+m.description+'</p>':'')+'</div><div class="flex gap-1">'+(past?'':'<button onclick="deleteMeeting('+m.id+')" class="w-6 h-6 rounded bg-gray-700 hover:bg-red-600 text-[10px] text-gray-400 flex items-center justify-center">&times;</button>')+'</div></div>'+(parts.length>0?'<div class="flex items-center gap-1 mt-2"><span class="text-[9px] text-gray-500">Katilimcilar:</span><span class="text-[10px] text-gray-400">'+parts.join(', ')+'</span></div>':'')+(m.channelId?'<span class="text-[9px] text-blue-400 mt-1 inline-block">#'+m.channelId+'</span>':'')+'</div>';
}

function openMeetingForm(){openModal('modal-create-meeting');}

function addMeeting(e){
    e.preventDefault();
    const f=new FormData(e.target);
    const meeting={
        id:Date.now(),
        title:f.get('meetingTitle'),
        description:f.get('meetingDesc')||'',
        startTime:f.get('meetingStart'),
        endTime:f.get('meetingEnd'),
        channelId:f.get('meetingChannel')||null,
        participants:(f.get('meetingParticipants')||'').split(',').map(s=>s.trim()).filter(Boolean),
        createdBy:currentUser?currentUser.name:'Bilinmeyen',
        status:'scheduled'
    };
    if(!S.meetings)S.meetings=[];
    S.meetings.push(meeting);
    if(socket&&socket.connected)socket.emit('meeting:created',meeting);
    save();closeModal('modal-create-meeting');e.target.reset();
    renderMeetings();renderCalendar();
    showNotif('Toplanti olusturuldu: '+meeting.title);
}

function deleteMeeting(id){
    if(!S.meetings)return;
    S.meetings=S.meetings.filter(m=>m.id!==id);
    save();renderMeetings();renderCalendar();
    showNotif('Toplanti silindi.');
}

// ===================== v5 - FAON AI ASSISTANT =====================
let aiMessages=[];
let currentAiSessionId=null;
let aiSessions=[];

function addAiMsg(text,isUser){
    const container=document.getElementById('ai-chat-messages');
    const time=new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    const div=document.createElement('div');
    div.className='flex '+(isUser?'justify-end':'justify-start');
    div.innerHTML=`<div class="${isUser?'msg-bubble msg-mine':'msg-bubble msg-other'}" style="max-width:85%">${!isUser?'<p class="text-[10px] text-amber-400 font-semibold mb-1">FaOn AI</p>':''}<div class="text-xs leading-relaxed">${text}</div><p class="text-[9px] ${isUser?'text-blue-200':'text-gray-500'} mt-1 text-right">${time}</p></div>`;
    container.appendChild(div);
    container.scrollTop=container.scrollHeight;
}

// ---- AI API Integration (Claude + HuggingFace + Local) ----
// AI API key yonetimi (tarayicida saklanir, deploy'da kaybolmaz)
function getAiApiKey(provider){return localStorage.getItem('faonsist_ai_key_'+provider)||'';}
function setAiApiKey(provider,key){localStorage.setItem('faonsist_ai_key_'+provider,key);showNotif(provider+' API key kaydedildi!');}
function removeAiApiKey(provider){localStorage.removeItem('faonsist_ai_key_'+provider);}

// ===================== AI HAFIZA / OGRENME SISTEMI =====================
// Claude ve HuggingFace yanitlarini kaydeder, benzer sorularda API'ye gitmeden yerel yanit verir
function getAiMemory(){
  try{return JSON.parse(localStorage.getItem('faonsist_ai_memory')||'[]');}catch(e){return[];}
}
function saveAiMemory(memory){
  try{
    // Max 200 kayit tut, eskilerini sil
    if(memory.length>200) memory=memory.slice(-200);
    localStorage.setItem('faonsist_ai_memory',JSON.stringify(memory));
  }catch(e){console.warn('AI hafiza kayit hatasi:',e);}
}
function extractKeywords(text){
  const stopWords=['bir','bu','su','ve','ile','icin','den','dan','de','da','mi','mu','ne','var','yok','olan','ben','sen','biz','siz','nasil','nedir','neden','hangi','kadar','gibi','daha','cok','az','hep','her','ama','fakat','ya','veya','ki','ise'];
  return text.toLowerCase()
    .replace(/[^a-z0-9\u00e7\u011f\u0131\u00f6\u015f\u00fc\u00c7\u011e\u0130\u00d6\u015e\u00dc ]/gi,' ')
    .split(/\s+/)
    .filter(w=>w.length>2&&!stopWords.includes(w));
}
function calcSimilarity(keywords1,keywords2){
  if(!keywords1.length||!keywords2.length)return 0;
  const set1=new Set(keywords1);
  const set2=new Set(keywords2);
  let matches=0;
  set1.forEach(w=>{if(set2.has(w))matches++;});
  return matches/Math.max(set1.size,set2.size);
}
function learnFromAiResponse(question,answer,provider){
  const memory=getAiMemory();
  const keywords=extractKeywords(question);
  if(keywords.length<2)return; // Cok kisa sorulari kaydetme
  // Ayni soru zaten varsa guncelle
  const existing=memory.findIndex(m=>calcSimilarity(m.keywords,keywords)>0.8);
  if(existing>=0){
    memory[existing].answer=answer;
    memory[existing].provider=provider;
    memory[existing].usedCount=(memory[existing].usedCount||0);
    memory[existing].updatedAt=new Date().toISOString();
  }else{
    memory.push({
      question:question,
      answer:answer,
      keywords:keywords,
      provider:provider,
      usedCount:0,
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    });
  }
  saveAiMemory(memory);
}
function searchAiMemory(question){
  const memory=getAiMemory();
  if(!memory.length)return null;
  const keywords=extractKeywords(question);
  if(keywords.length<2)return null;
  let bestMatch=null;
  let bestScore=0;
  memory.forEach(m=>{
    const score=calcSimilarity(keywords,m.keywords);
    if(score>bestScore){bestScore=score;bestMatch=m;}
  });
  // Esik: %60 benzerlik
  if(bestScore>=0.6&&bestMatch){
    // Kullanim sayisini artir
    bestMatch.usedCount=(bestMatch.usedCount||0)+1;
    saveAiMemory(memory);
    return {answer:bestMatch.answer,provider:bestMatch.provider,score:bestScore,usedCount:bestMatch.usedCount};
  }
  return null;
}
function getAiMemoryStats(){
  const memory=getAiMemory();
  const sizeKB=(new Blob([JSON.stringify(memory)]).size/1024).toFixed(1);
  const claudeCount=memory.filter(m=>m.provider==='anthropic'||m.provider==='Claude').length;
  const hfCount=memory.filter(m=>m.provider==='huggingface'||m.provider==='HuggingFace').length;
  const totalUsed=memory.reduce((s,m)=>s+(m.usedCount||0),0);
  return {total:memory.length,claudeCount,hfCount,totalUsed,sizeKB};
}
function openAiMemoryPanel(){
  const memory=getAiMemory();
  const stats=getAiMemoryStats();
  let listHtml='';
  memory.slice().reverse().forEach((m,i)=>{
    const idx=memory.length-1-i;
    const provIcon=m.provider==='anthropic'||m.provider==='Claude'?'üü£':'üü°';
    const shortA=(m.answer||'').replace(/<[^>]*>/g,'').slice(0,80);
    const date=m.updatedAt?new Date(m.updatedAt).toLocaleDateString('tr-TR'):'';
    listHtml+=`<div class="p-2.5 rounded-lg bg-gray-800/40 border border-gray-700/30">
      <div class="flex items-center justify-between mb-1">
        <span class="text-[10px] text-amber-400 font-medium">${provIcon} ${m.question?.slice(0,50)||'?'}${m.question?.length>50?'...':''}</span>
        <div class="flex items-center gap-2">
          <span class="text-[9px] text-gray-500">${date} ‚Ä¢ ${m.usedCount||0}x</span>
          <button onclick="deleteAiMemoryItem(${idx})" class="text-red-400 hover:text-red-300 text-[10px]">‚úï</button>
        </div>
      </div>
      <p class="text-[10px] text-gray-400">${shortA}${m.answer?.length>80?'...':''}</p>
      <div class="flex gap-1 mt-1 flex-wrap">${(m.keywords||[]).slice(0,6).map(k=>'<span class="text-[8px] px-1.5 py-0.5 rounded bg-gray-700/50 text-gray-500">'+k+'</span>').join('')}</div>
    </div>`;
  });
  const html=`<div class="glass-strong rounded-2xl p-6 w-full max-w-xl max-h-[85vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold">üß† AI Hafiza Yonetimi</h3>
      <button onclick="closeModal('modal-ai-memory')" class="text-gray-400 hover:text-white text-lg">&times;</button>
    </div>
    <div class="grid grid-cols-4 gap-2 mb-4">
      <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Toplam</p><p class="text-sm font-bold text-amber-400">${stats.total}</p></div>
      <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Claude</p><p class="text-sm font-bold text-purple-400">${stats.claudeCount}</p></div>
      <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">HuggingFace</p><p class="text-sm font-bold text-yellow-400">${stats.hfCount}</p></div>
      <div class="p-2 rounded-lg bg-gray-800/30 text-center"><p class="text-[9px] text-gray-500">Kullanim</p><p class="text-sm font-bold text-green-400">${stats.totalUsed}</p></div>
    </div>
    <div class="flex gap-2 mb-4">
      <button onclick="if(confirm('Tum AI hafizasi silinecek. Emin misiniz?')){localStorage.removeItem('faonsist_ai_memory');closeModal('modal-ai-memory');showNotif('AI hafizasi temizlendi');}" class="px-3 py-1.5 bg-red-600/10 hover:bg-red-600/20 border border-red-500/20 rounded-lg text-[10px] text-red-400">Tum Hafizayi Temizle</button>
      <button onclick="exportAiMemory()" class="px-3 py-1.5 bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/20 rounded-lg text-[10px] text-blue-400">Disa Aktar (JSON)</button>
      <span class="ml-auto text-[9px] text-gray-600">${stats.sizeKB} KB</span>
    </div>
    <div class="space-y-2 max-h-[50vh] overflow-y-auto">${listHtml||'<p class="text-gray-500 text-sm text-center py-8">Henuz hafizada kayit yok.<br><span class="text-[10px] text-gray-600">Claude veya HuggingFace ile soru sordukca AI otomatik ogrenecek.</span></p>'}</div>
  </div>`;
  let modal=document.getElementById('modal-ai-memory');
  if(!modal){modal=document.createElement('div');modal.id='modal-ai-memory';modal.className='modal';document.body.appendChild(modal);}
  modal.innerHTML=html;
  modal.classList.add('active');
}
function deleteAiMemoryItem(idx){
  const memory=getAiMemory();
  if(idx>=0&&idx<memory.length){memory.splice(idx,1);saveAiMemory(memory);openAiMemoryPanel();}
}
function exportAiMemory(){
  const data=JSON.stringify(getAiMemory(),null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='faonsist_ai_memory_'+new Date().toISOString().slice(0,10)+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showNotif('AI hafizasi disa aktarildi!');
}

function buildSystemContext(){
  const ctx=[];
  ctx.push('ONEMLI: Her zaman sadece Turkce yanit ver. Baska hicbir dilde yazma. Kesinlikle Cince, Ingilizce veya baska dil kullanma.');
  ctx.push('Sen FaOnSisT is yonetim platformunun Turkce yapay zeka asistanisin. Insaat sektoru icin gelistirildin.');
  ctx.push('Kullanici: '+(currentUser?.name||'Bilinmiyor')+' ('+( currentUser?.role||'Rol yok')+')');
  ctx.push('Sistem durumu: '+S.projects.length+' proje, '+S.tenders.length+' ihale, '+S.sales.length+' satis, '+(S.personeller||[]).length+' personel, '+(S.envanter||[]).length+' envanter');
  const overBudget=S.projects.filter(p=>(p.spent||0)>p.budget*0.85);
  if(overBudget.length)ctx.push('Butce riski olan projeler: '+overBudget.map(p=>p.name).join(', '));
  const dusukStok=(S.envanter||[]).filter(i=>parseFloat(i.miktar||0)<=parseFloat(i.minStok||0)&&parseFloat(i.minStok||0)>0);
  if(dusukStok.length)ctx.push('Dusuk stoklu urunler: '+dusukStok.length+' adet');
  ctx.push('Kisa, oz ve sadece Turkce yanit ver.');
  return ctx.join('\n');
}

async function sendToClaudeAPI(text){
  const key=getAiApiKey('anthropic');
  if(!key){console.warn('Claude: API key yok');return null;}
  try{
    const controller=new AbortController();
    const timeout=setTimeout(()=>controller.abort(),30000);
    const r=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,system:buildSystemContext(),messages:[{role:'user',content:text}]}),
      signal:controller.signal
    });
    clearTimeout(timeout);
    if(!r.ok){
      const err=await r.json().catch(()=>({}));
      console.warn('Claude API error:',r.status,err);
      addAiMsg('‚ö†Ô∏è Claude API Hata ('+r.status+'): '+(err.error?.message||'Bilinmeyen hata')+' ‚Äî Yerel AI ile yanit veriliyor...',false);
      return null;
    }
    const data=await r.json();
    const result=data.content?.[0]?.text||null;
    if(result) addAiMsg('<span class="text-[9px] text-purple-400">üü£ Claude AI ile yanitlandi</span>',false);
    return result;
  }catch(e){
    console.warn('Claude API baglanti hatasi:',e);
    if(e.name==='AbortError') addAiMsg('‚ö†Ô∏è Claude API zaman asimi ‚Äî Yerel AI ile yanit veriliyor...',false);
    return null;
  }
}

// HuggingFace: Yeni router.huggingface.co endpoint (OpenAI uyumlu)
const HF_MODELS=['meta-llama/Llama-3.1-8B-Instruct','mistralai/Mistral-7B-Instruct-v0.3','Qwen/Qwen2.5-7B-Instruct'];
async function sendToHuggingFaceAPI(text){
  const key=getAiApiKey('huggingface');
  if(!key){console.warn('HuggingFace: API key yok');return null;}
  for(let i=0;i<HF_MODELS.length;i++){
    const modelId=HF_MODELS[i];
    try{
      const controller=new AbortController();
      const timeout=setTimeout(()=>controller.abort(),25000);
      const r=await fetch('https://router.huggingface.co/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body:JSON.stringify({
          model:modelId,
          messages:[
            {role:'system',content:buildSystemContext()},
            {role:'user',content:text}
          ],
          max_tokens:512,
          temperature:0.7
        }),
        signal:controller.signal
      });
      clearTimeout(timeout);
      if(r.status===503||r.status===429){console.warn('HF model musait degil:',modelId,'sonraki deneniyor...');continue;}
      if(!r.ok){
        const errBody=await r.text().catch(()=>'');
        console.warn('HF API error:',r.status,modelId,errBody);
        continue;
      }
      const data=await r.json();
      const result=data.choices?.[0]?.message?.content||null;
      if(result){
        const shortName=modelId.split('/')[1]||modelId;
        addAiMsg('<span class="text-[9px] text-yellow-400">üü° HuggingFace ('+shortName+') ile yanitlandi</span>',false);
        return result;
      }
    }catch(e){
      console.warn('HF model hata:',modelId,e.message);
      continue;
    }
  }
  addAiMsg('‚ö†Ô∏è HuggingFace: Tum modeller su an musait degil ‚Äî Yerel AI ile yanit veriliyor...',false);
  return null;
}

async function sendAiMessageToAPI(text){
  const providerSel=document.getElementById('ai-provider-select');
  const selectedProvider=providerSel?.value||'';
  // Yerel AI seciliyse dogrudan local calistir
  if(selectedProvider==='local'){processAiCommand(text);return;}

  // 1) Hafizada benzer soru ara (API'ye gitmeden hizli yanit)
  const memResult=searchAiMemory(text);
  if(memResult){
    const provIcon=memResult.provider==='anthropic'||memResult.provider==='Claude'?'üü£':'üü°';
    const provName=memResult.provider==='anthropic'||memResult.provider==='Claude'?'Claude':'HuggingFace';
    const html=memResult.answer.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    addAiMsg(html,false);
    addAiMsg('<span class="text-[9px] text-cyan-400">üß† Hafizadan yanitlandi ('+provIcon+' '+provName+' ogrenmesi ‚Ä¢ %'+Math.round(memResult.score*100)+' eslesti ‚Ä¢ '+memResult.usedCount+'x kullanildi)</span>',false);
    return;
  }

  // 2) API'ye sor
  showAiTypingIndicator();
  try{
    let aiResponse=null;
    let usedProvider='';
    if(selectedProvider==='anthropic'){
      aiResponse=await sendToClaudeAPI(text);
      usedProvider='anthropic';
      if(!aiResponse&&!getAiApiKey('anthropic')){hideAiTypingIndicator();openAiKeyModal('anthropic');return;}
    }else if(selectedProvider==='huggingface'){
      aiResponse=await sendToHuggingFaceAPI(text);
      usedProvider='huggingface';
      if(!aiResponse&&!getAiApiKey('huggingface')){hideAiTypingIndicator();openAiKeyModal('huggingface');return;}
    }else{
      // Otomatik: Claude > HuggingFace > Yerel
      if(getAiApiKey('anthropic')){aiResponse=await sendToClaudeAPI(text);usedProvider='anthropic';}
      if(!aiResponse&&getAiApiKey('huggingface')){aiResponse=await sendToHuggingFaceAPI(text);usedProvider='huggingface';}
    }

    hideAiTypingIndicator();
    if(aiResponse){
      const html=aiResponse.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
      addAiMsg(html,false);
      // 3) Basarili yaniti hafizaya kaydet (ogrenme)
      learnFromAiResponse(text,aiResponse,usedProvider);
    }else{
      processAiCommand(text);
    }
  }catch(e){
    console.warn('AI API genel hata:',e);
    hideAiTypingIndicator();
    processAiCommand(text);
  }
}

// ---- AI API Key Ayar Modali ----
function openAiKeyModal(provider){
  const providerNames={anthropic:'Claude AI (Anthropic)',huggingface:'HuggingFace'};
  const providerHints={anthropic:'sk-ant-... formatinda',huggingface:'hf_... formatinda'};
  const name=providerNames[provider]||provider;
  const hint=providerHints[provider]||'';
  const existingKey=getAiApiKey(provider);
  const masked=existingKey?existingKey.slice(0,8)+'...'+existingKey.slice(-4):'';
  const modalHtml=`
    <div id="ai-key-modal" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7)">
      <div style="background:#1e293b;border:1px solid #374151;border-radius:12px;padding:24px;width:420px;max-width:90vw">
        <h3 style="color:#f59e0b;font-size:14px;font-weight:600;margin-bottom:4px">üîë ${name} API Anahtari</h3>
        <p style="color:#9ca3af;font-size:11px;margin-bottom:16px">${existingKey?'Mevcut anahtar: <code style="background:#374151;padding:2px 6px;border-radius:4px;color:#60a5fa">'+masked+'</code>':'Henuz API anahtari tanimlanmadi.'}</p>
        <p style="color:#d1d5db;font-size:11px;margin-bottom:8px">API anahtarinizi girin (${hint}):</p>
        <input type="password" id="ai-key-input" placeholder="API anahtarinizi yapistiriniz..." value="" style="width:100%;padding:8px 12px;background:#0f172a;border:1px solid #374151;border-radius:8px;color:#e2e8f0;font-size:12px;margin-bottom:12px;outline:none">
        <p style="color:#6b7280;font-size:9px;margin-bottom:16px">‚ö†Ô∏è Anahtar sadece bu tarayicida saklanir, hicbir sunucuya gonderilmez.</p>
        <div style="display:flex;gap:8px">
          <button onclick="const v=document.getElementById('ai-key-input').value.trim();if(v){setAiApiKey('${provider}',v);document.getElementById('ai-key-modal').remove();loadAiProviders();}else{showNotif('Anahtar bos olamaz!')}" style="flex:1;padding:8px;background:#f59e0b;color:#000;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">Kaydet</button>
          ${existingKey?'<button onclick="removeAiApiKey(\''+provider+'\');document.getElementById(\'ai-key-modal\').remove();loadAiProviders();showNotif(\'API key silindi\')" style="padding:8px 16px;background:#dc2626;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer">Sil</button>':''}
          <button onclick="document.getElementById('ai-key-modal').remove()" style="padding:8px 16px;background:#374151;color:#d1d5db;border:none;border-radius:8px;font-size:12px;cursor:pointer">Iptal</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend',modalHtml);
  setTimeout(()=>document.getElementById('ai-key-input')?.focus(),100);
}
function showAiTypingIndicator(){
  const c=document.getElementById('ai-chat-messages');if(!c)return;
  let ind=document.getElementById('ai-typing-indicator');
  if(!ind){
    ind=document.createElement('div');
    ind.id='ai-typing-indicator';
    ind.className='flex justify-start';
    ind.innerHTML='<div class="msg-bubble msg-other" style="max-width:60%"><p class="text-[10px] text-amber-400 font-semibold mb-1">FaOn AI</p><div class="flex gap-1 items-center py-1"><div class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay:0ms"></div><div class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay:150ms"></div><div class="w-2 h-2 bg-amber-400 rounded-full animate-bounce" style="animation-delay:300ms"></div><span class="text-[9px] text-gray-400 ml-2">AI dusunuyor...</span></div></div>';
  }
  c.appendChild(ind);
  c.scrollTop=c.scrollHeight;
}
function hideAiTypingIndicator(){
  const ind=document.getElementById('ai-typing-indicator');
  if(ind)ind.remove();
}
const aiProviderNames={anthropic:'Claude',huggingface:'HuggingFace'};
function updateAiRequestCounter(remaining, usedFallback, provider){
  let counter=document.getElementById('ai-request-counter');
  if(!counter){
    const wrap=document.getElementById('ai-input')?.parentElement;
    if(wrap){
      counter=document.createElement('div');
      counter.id='ai-request-counter';
      counter.className='text-[8px] text-gray-500 text-right mt-0.5 mr-1';
      wrap.parentElement?.appendChild(counter);
    }
  }
  if(counter){
    if(usedFallback){
      counter.textContent='‚ö° Yerel mod aktif';
      counter.className='text-[8px] text-yellow-500 text-right mt-0.5 mr-1';
    }else{
      const name=aiProviderNames[provider]||'AI';
      counter.textContent='üß† '+name+' ‚Ä¢ '+remaining+' istek kaldi';
      counter.className='text-[8px] text-cyan-400 text-right mt-0.5 mr-1';
    }
  }
}

function sendAiMessage(){
    const inp=document.getElementById('ai-input');
    const txt=inp.value.trim();if(!txt)return;
    inp.value='';
    addAiMsg(txt,true);
    if(txt.startsWith('@')){setTimeout(()=>processAiCommand(txt),400);}else{setTimeout(()=>sendAiMessageToAPI(txt),100);}
}

function aiQuickAction(cmd){
    addAiMsg('@'+cmd,true);
    setTimeout(()=>processAiCommand('@'+cmd),400);
}

function clearAiChat(){
    const c=document.getElementById('ai-chat-messages');
    c.innerHTML='';
    addAiMsg('Sohbet temizlendi. Size nasil yardimci olabilirim?',false);
}

// ---- AI Provider Listesi Yukleme ----
const AI_PROVIDERS_LIST=[
    {id:'anthropic',displayName:'Claude AI',icon:'üü£'},
    {id:'huggingface',displayName:'HuggingFace',icon:'üü°'}
];
async function loadAiProviders(){
  const optionsContainer=document.getElementById('ai-provider-options');
  if(!optionsContainer)return;

  optionsContainer.innerHTML=`
    <button onclick="selectAiProvider('','ü§ñ','Otomatik')" class="w-full text-left px-3 py-2 text-[11px] text-gray-300 hover:bg-amber-500/15 hover:text-amber-300 transition-colors flex items-center gap-2">
      <span class="text-sm">ü§ñ</span><span>Otomatik</span><span class="ml-auto text-[9px] text-gray-500">Varsayilan</span>
    </button>`;
  AI_PROVIDERS_LIST.forEach(p=>{
    const hasKey=!!getAiApiKey(p.id);
    const statusDot=hasKey?'üü¢':'üîë';
    const statusText=hasKey?'Bagli':'Key gerekli';
    const statusClass=hasKey?'text-green-400':'text-yellow-400';
    const row=document.createElement('div');
    row.className='flex items-center w-full';
    // Provider secim butonu
    const btn=document.createElement('button');
    btn.onclick=()=>{if(hasKey){selectAiProvider(p.id,p.icon,p.displayName);}else{openAiKeyModal(p.id);}};
    btn.className='flex-1 text-left px-3 py-2 text-[11px] text-gray-300 hover:bg-amber-500/15 hover:text-amber-300 transition-colors flex items-center gap-2';
    btn.innerHTML=`<span class="text-sm">${p.icon}</span><span>${p.displayName}</span><span class="ml-auto text-[9px] ${statusClass}">${statusDot} ${statusText}</span>`;
    row.appendChild(btn);
    // Ayar butonu (key yonetimi)
    const gear=document.createElement('button');
    gear.onclick=(e)=>{e.stopPropagation();openAiKeyModal(p.id);};
    gear.className='px-2 py-2 text-gray-500 hover:text-amber-400 transition-colors text-[11px]';
    gear.title='API Key Ayarlari';
    gear.textContent='‚öôÔ∏è';
    row.appendChild(gear);
    optionsContainer.appendChild(row);
  });
  // Yerel AI secenegi
  const localBtn=document.createElement('button');
  localBtn.onclick=()=>selectAiProvider('local','üíª','Yerel AI');
  localBtn.className='w-full text-left px-3 py-2 text-[11px] text-gray-300 hover:bg-amber-500/15 hover:text-amber-300 transition-colors flex items-center gap-2 border-t border-gray-700/50';
  localBtn.innerHTML='<span class="text-sm">üíª</span><span>Yerel AI (Offline)</span><span class="ml-auto text-[9px] text-green-400">üü¢ Her zaman aktif</span>';
  optionsContainer.appendChild(localBtn);
}

// ---- AI Provider Dropdown Toggle/Select ----
function toggleAiProviderDropdown(){
  const menu=document.getElementById('ai-provider-menu');
  if(!menu)return;
  loadAiProviders();
  menu.classList.toggle('hidden');
  // Disariya tiklayinca kapat
  if(!menu.classList.contains('hidden')){
    setTimeout(()=>{
      const closeHandler=(ev)=>{
        if(!document.getElementById('ai-provider-dropdown-wrapper')?.contains(ev.target)){
          menu.classList.add('hidden');
          document.removeEventListener('click',closeHandler);
        }
      };
      document.addEventListener('click',closeHandler);
    },10);
  }
}

function selectAiProvider(id,icon,label){
  document.getElementById('ai-provider-select').value=id;
  document.getElementById('ai-provider-icon').textContent=icon;
  document.getElementById('ai-provider-label').textContent=label;
  document.getElementById('ai-provider-menu').classList.add('hidden');
  // Buton rengini secime gore ayarla
  const btn=document.getElementById('ai-provider-btn');
  btn.className='flex items-center gap-1.5 bg-gray-800/60 border rounded-lg px-2.5 py-2.5 text-[11px] outline-none hover:border-amber-500/50 focus:border-amber-500 transition-colors cursor-pointer whitespace-nowrap';
  if(id==='anthropic') btn.classList.add('border-purple-500/50','text-purple-300');
  else if(id==='huggingface') btn.classList.add('border-yellow-500/50','text-yellow-300');
  else if(id==='local') btn.classList.add('border-green-500/50','text-green-300');
  else btn.classList.add('border-gray-700','text-gray-300');
}

function processAiCommand(text){
    const lower=text.toLowerCase().trim();
    // @ komutlari (oncelikli)
    if(lower.startsWith('@analiz')||lower.startsWith('@tara')||lower.includes('sistem analiz')||lower.includes('genel durum'))return aiSystemAnalysis();
    if(lower.startsWith('@hatirlatma')||lower.includes('hatirlatma')||lower.includes('hatƒ±rlat')||lower.includes('reminder'))return aiReminders();
    if(lower.startsWith('@butce')||lower.startsWith('@b√ºt√ße')||lower.includes('butce')||lower.includes('b√ºt√ße')||lower.includes('harcama'))return aiBudgetAnalysis();
    if(lower.startsWith('@taksit')||lower.includes('taksit')||lower.includes('odeme')||lower.includes('√∂deme'))return aiInstallmentCheck();
    if(lower.startsWith('@ihale')||lower.includes('ihale')||lower.includes('tedarik')||lower.includes('tender'))return aiTenderAnalysis();
    if(lower.startsWith('@bildir')||lower.startsWith('@gonder')||lower.includes('kanala gonder'))return aiSendNotification(text);
    // Yeni komutlar
    if(lower.startsWith('@depo')||lower.startsWith('@envanter')||lower.includes('envanter')||lower.includes('stok'))return aiDepoAnalysis();
    if(lower.startsWith('@arac')||lower.startsWith('@filo')||lower.includes('filo')||lower.includes('plaka'))return aiAracAnalysis();
    if(lower.startsWith('@toplanti')||lower.startsWith('@meeting')||lower.includes('toplanti')||lower.includes('meeting'))return aiMeetingSummary();
    if(lower.startsWith('@silme')||lower.includes('silme talep')||lower.includes('onay bekleyen'))return aiDeletionStatus();
    if(lower.startsWith('@rapor'))return aiCreateReport(text);
    if(lower.startsWith('@ara ')||lower.startsWith('@bul '))return aiSearch(text.replace(/@ara |@bul /i,''));
    // Dogal dil eslestirme
    if(lower.includes('proje')||lower.includes('insaat')||lower.includes('santiye'))return aiProjectSummary();
    if(lower.includes('satis')||lower.includes('musteri')||lower.includes('m√º≈üteri')||lower.includes('pipeline'))return aiSalesSummary();
    if(lower.includes('dosya')||lower.includes('bilgi bankasi')||lower.includes('dokuman'))return aiFilesSummary();
    if(lower.includes('kim')||lower.includes('ekip')||lower.includes('kullanici')||lower.includes('personel'))return aiTeamSummary();
    if(lower.includes('depo')||lower.includes('zimmet'))return aiDepoAnalysis();
    if(lower.includes('arac')||lower.includes('ara√ß')||lower.includes('kamyon')||lower.includes('binek'))return aiAracAnalysis();
    // Arama niyeti tespiti
    if(lower.includes('ara')||lower.includes('bul')||lower.includes('nerede')||lower.includes('goster')||lower.includes('g√∂ster')||lower.includes('listele'))return aiSearch(text);
    // Selamlama
    if(lower.includes('merhaba')||lower.includes('selam')||lower.includes('hey')||lower.includes('nasilsin'))return addAiMsg('Merhaba! Size nasil yardimci olabilirim? Hizli erisim icin alt kisimdaki butonlari veya <code class="text-[10px] bg-gray-700 px-1 rounded">@komut</code> yapisini kullanabilirsiniz.<br><br>Yeni komutlar: <code class="bg-gray-700 px-1 rounded">@depo</code> <code class="bg-gray-700 px-1 rounded">@arac</code> <code class="bg-gray-700 px-1 rounded">@toplanti</code> <code class="bg-gray-700 px-1 rounded">@silme</code> <code class="bg-gray-700 px-1 rounded">@ara [kelime]</code>',false);
    return aiSmartResponseV2(text);
}

// ---- AI: SYSTEM ANALYSIS ----
function aiSystemAnalysis(){
    const pCount=S.projects.length;
    const pBudget=S.projects.reduce((s,p)=>s+p.budget,0);
    const pSpent=S.projects.reduce((s,p)=>s+(p.spent||0),0);
    const avgComp=pCount>0?Math.round(S.projects.reduce((s,p)=>s+p.completion,0)/pCount):0;
    const tCount=S.tenders.length;
    const tPending=S.tenders.filter(t=>t.status==='Beklemede').length;
    const tApproved=S.tenders.filter(t=>t.status==='Onaylandi').length;
    const tReviewing=S.tenders.filter(t=>t.status==='Degerlendiriliyor').length;
    const sCount=S.sales.length;
    const sRevenue=S.sales.reduce((s,x)=>s+(x.amount||x.price||0),0);
    const sPaid=S.sales.reduce((s,x)=>s+(x.paid||0),0);
    const collectionRate=sRevenue>0?Math.round(sPaid/sRevenue*100):0;
    const fileCount=Object.values(S.connFiles).reduce((s,arr)=>s+arr.length,0);
    const kbCount=S.knowledgeBase.length;
    const userCount=S.users.length;
    const warnings=[];
    S.projects.forEach(p=>{if((p.spent||0)>p.budget*0.9)warnings.push('&#9888; '+p.name+' - Butce %'+Math.round((p.spent||0)/p.budget*100)+' kullanildi!');});
    if(tPending>0)warnings.push('&#9888; '+tPending+' ihale onay bekliyor');
    if(tReviewing>0)warnings.push('&#9888; '+tReviewing+' ihale degerlendirmede');
    if(collectionRate<50&&sCount>0)warnings.push('&#9888; Tahsilat orani dusuk: %'+collectionRate);
    S.sales.forEach(sl=>{const saleAmount=sl.amount||sl.price||0;if(sl.installments&&sl.installments.length>0){const unpaid=sl.installments.filter(i=>!i.paid);if(unpaid.length>0)warnings.push('&#9888; '+sl.customer+' - '+unpaid.length+' taksit odenmedi');}else if(sl.paid===0&&saleAmount>0&&sl.status!=='Tamamlandi')warnings.push('&#9888; '+sl.customer+' - Hic odeme yapilmamis!');});
    const warningHtml=warnings.length>0?'<div class="mt-2 p-2 rounded bg-red-500/10 border border-red-500/20 space-y-1">'+warnings.map(w=>'<p class="text-[10px] text-red-400">'+w+'</p>').join('')+'</div>':'<p class="text-[10px] text-green-400 mt-2">&#10003; Kritik uyari bulunamadi.</p>';
    addAiMsg(`<b class="text-amber-400">&#128202; Sistem Analiz Raporu</b>
<div class="grid grid-cols-2 gap-2 mt-2">
<div class="p-2 rounded bg-blue-500/10"><p class="text-[9px] text-gray-400">Projeler</p><p class="text-sm font-bold text-blue-400">${pCount}</p><p class="text-[9px] text-gray-500">Ort. %${avgComp} tamamlanma</p></div>
<div class="p-2 rounded bg-purple-500/10"><p class="text-[9px] text-gray-400">Toplam Butce</p><p class="text-sm font-bold text-purple-400">\u20BA${fmt(pBudget)}</p><p class="text-[9px] text-gray-500">\u20BA${fmt(pSpent)} harcandi</p></div>
<div class="p-2 rounded bg-orange-500/10"><p class="text-[9px] text-gray-400">Ihaleler</p><p class="text-sm font-bold text-orange-400">${tCount}</p><p class="text-[9px] text-gray-500">${tPending} bekleyen, ${tApproved} onayli</p></div>
<div class="p-2 rounded bg-green-500/10"><p class="text-[9px] text-gray-400">Satislar</p><p class="text-sm font-bold text-green-400">\u20BA${fmt(sRevenue)}</p><p class="text-[9px] text-gray-500">Tahsilat: %${collectionRate}</p></div>
</div>
<div class="grid grid-cols-3 gap-2 mt-2">
<div class="p-1.5 rounded bg-gray-700/30 text-center"><p class="text-[9px] text-gray-400">Kullanicilar</p><p class="text-xs font-bold">${userCount}</p></div>
<div class="p-1.5 rounded bg-gray-700/30 text-center"><p class="text-[9px] text-gray-400">Dosyalar</p><p class="text-xs font-bold">${fileCount}</p></div>
<div class="p-1.5 rounded bg-gray-700/30 text-center"><p class="text-[9px] text-gray-400">Bilgi Bankasi</p><p class="text-xs font-bold">${kbCount}</p></div>
</div>
${warningHtml}`,false);
    // Auto-send reminders to channels
    if(warnings.length>0)aiAutoNotifyChannels(warnings);
}

// ---- AI: REMINDERS ----
function aiReminders(){
    const reminders=[];
    // Project deadline reminders
    S.projects.forEach(p=>{
        if(p.status==='Planlandi')reminders.push({type:'proje',priority:'orta',text:p.name+' - Planlandi, baslatilmayi bekliyor',target:'proje-takip'});
        if(p.completion>=80&&p.status==='Devam Ediyor')reminders.push({type:'proje',priority:'yuksek',text:p.name+' - %'+p.completion+' tamamlandi, teslim yaklasiyor!',target:'proje-takip'});
        if((p.spent||0)>p.budget*0.85)reminders.push({type:'butce',priority:'kritik',text:p.name+' - Butce %'+(Math.round((p.spent||0)/p.budget*100))+' kullanildi!',target:'genel'});
    });
    // Tender reminders
    S.tenders.forEach(t=>{
        if(t.status==='Beklemede')reminders.push({type:'ihale',priority:'orta',text:t.name+' ('+t.project+') - Onay bekliyor, butce: \u20BA'+fmt(t.budget),target:'genel'});
        if(t.status==='Degerlendiriliyor')reminders.push({type:'ihale',priority:'yuksek',text:t.name+' ('+t.project+') - Degerlendirmede, karar bekleniyor',target:'genel'});
    });
    // Installment/payment reminders
    S.sales.forEach(sl=>{
        const saleAmount=sl.amount||sl.price||0;
        if(sl.installments&&sl.installments.length>0){
            const unpaid=sl.installments.filter(i=>!i.paid);
            if(unpaid.length>0){
                const nextInst=unpaid[0];
                reminders.push({type:'taksit',priority:unpaid.length<=2?'kritik':'orta',text:sl.customer+' - '+unpaid.length+' taksit kaldi (sonraki: \u20BA'+fmt(nextInst.amount)+' / '+nextInst.date+')',target:'genel'});
            }
        }
        if(sl.paid===0&&saleAmount>0&&sl.status!=='Tamamlandi')reminders.push({type:'odeme',priority:'yuksek',text:sl.customer+' - Hic odeme yapilmamis! \u20BA'+fmt(saleAmount),target:'genel'});
    });
    if(reminders.length===0){
        addAiMsg('<b class="text-amber-400">&#128276; Hatirlatma Kontrol</b><p class="mt-2 text-green-400 text-[11px]">&#10003; Tum sistemler yolunda! Bekleyen hatirlatma bulunamadi.</p>',false);
        return;
    }
    const priorityColors={kritik:'text-red-400',yuksek:'text-orange-400',orta:'text-yellow-400'};
    const priorityIcons={kritik:'&#128308;',yuksek:'&#128992;',orta:'&#128993;'};
    const grouped={kritik:[],yuksek:[],orta:[]};
    reminders.forEach(r=>{if(grouped[r.priority])grouped[r.priority].push(r);});
    let html='<b class="text-amber-400">&#128276; Hatirlatmalar ('+reminders.length+')</b>';
    ['kritik','yuksek','orta'].forEach(p=>{
        if(grouped[p].length>0){
            html+='<div class="mt-2"><p class="text-[10px] font-semibold '+priorityColors[p]+'">'+priorityIcons[p]+' '+(p==='kritik'?'KRITIK':p==='yuksek'?'YUKSEK':'ORTA')+' ('+grouped[p].length+')</p>';
            grouped[p].forEach(r=>{html+='<div class="flex items-start gap-2 mt-1 p-1.5 rounded bg-gray-800/30"><span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700">'+(r.type==='proje'?'Proje':r.type==='ihale'?'Ihale':r.type==='taksit'?'Taksit':r.type==='butce'?'Butce':'Odeme')+'</span><p class="text-[10px] flex-1">'+r.text+'</p></div>';});
            html+='</div>';
        }
    });
    html+='<div class="mt-3"><button onclick="aiSendRemindersToChannels()" class="px-3 py-1.5 bg-amber-600/20 text-amber-400 text-[10px] rounded-lg hover:bg-amber-600/30 border border-amber-500/20">&#128227; Hatirlaticlari Kanallara Gonder</button></div>';
    addAiMsg(html,false);
    // Store for sending
    window._aiPendingReminders=reminders;
}

function aiSendRemindersToChannels(){
    const reminders=window._aiPendingReminders||[];
    if(reminders.length===0)return;
    const channelMsgs={};
    reminders.forEach(r=>{
        const ch=r.target||'genel';
        if(!channelMsgs[ch])channelMsgs[ch]=[];
        channelMsgs[ch].push(r);
    });
    let sentCount=0;
    Object.entries(channelMsgs).forEach(([ch,rList])=>{
        const chExists=S.channels.find(c=>c.id===ch);
        if(!chExists)ch='genel';
        if(!S.messages[ch])S.messages[ch]=[];
        const msgText='&#129302; <b>FaOn AI Hatirlatma</b><br>'+rList.map(r=>'&#8226; <span class="'+(r.priority==='kritik'?'text-red-400':r.priority==='yuksek'?'text-orange-400':'text-yellow-400')+'">['+r.priority.toUpperCase()+']</span> '+r.text).join('<br>');
        S.messages[ch].push({id:Date.now()+sentCount,user:'FaOn AI',text:msgText,time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),mine:false,isAI:true});
        sentCount++;
    });
    save();renderMessages();
    addAiMsg('<p class="text-green-400 text-[11px]">&#10003; '+reminders.length+' hatirlatma '+Object.keys(channelMsgs).length+' kanala gonderildi!</p><p class="text-[10px] text-gray-400 mt-1">Kanallar: '+Object.keys(channelMsgs).map(c=>'#'+c).join(', ')+'</p>',false);
    act('AI: '+reminders.length+' hatirlatma kanallara gonderildi');
}

function aiAutoNotifyChannels(warnings){
    if(!S.messages['genel'])S.messages['genel']=[];
    const msgText='&#129302; <b>FaOn AI Sistem Uyarisi</b><br>'+warnings.map(w=>'&#8226; '+w).join('<br>');
    S.messages['genel'].push({id:Date.now()+99,user:'FaOn AI',text:msgText,time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),mine:false,isAI:true});
    save();
}

// ---- AI: BUDGET ANALYSIS ----
function aiBudgetAnalysis(){
    if(S.projects.length===0){addAiMsg('<b class="text-amber-400">&#128176; Butce Analizi</b><p class="mt-2 text-gray-400 text-[11px]">Henuz proje eklenmemis. Proje ekleyince butce analizi yapabilirim.</p>',false);return;}
    let html='<b class="text-amber-400">&#128176; Butce Analizi</b><div class="space-y-2 mt-2">';
    S.projects.forEach(p=>{
        const spent=p.spent||0;const pct=p.budget>0?Math.round(spent/p.budget*100):0;
        const color=pct>=90?'text-red-400':pct>=70?'text-orange-400':pct>=50?'text-yellow-400':'text-green-400';
        const bar=pct>=90?'bg-red-500':pct>=70?'bg-orange-500':pct>=50?'bg-yellow-500':'bg-green-500';
        html+=`<div class="p-2 rounded bg-gray-800/30"><div class="flex justify-between items-center"><p class="text-[11px] font-medium">${p.name}</p><span class="${color} text-[10px] font-bold">%${pct}</span></div><div class="progress-bar mt-1"><div class="progress-fill ${bar}" style="width:${Math.min(pct,100)}%"></div></div><div class="flex justify-between mt-1"><span class="text-[9px] text-gray-500">Harcanan: \u20BA${fmt(spent)}</span><span class="text-[9px] text-gray-500">Butce: \u20BA${fmt(p.budget)}</span></div>${pct>=85?'<p class="text-[9px] text-red-400 mt-1">&#9888; Butce asimi riski!</p>':''}</div>`;
    });
    const totalBudget=S.projects.reduce((s,p)=>s+p.budget,0);
    const totalSpent=S.projects.reduce((s,p)=>s+(p.spent||0),0);
    html+=`</div><div class="mt-2 p-2 rounded bg-blue-500/10 border border-blue-500/20"><p class="text-[10px] text-gray-400">Toplam</p><p class="text-xs font-bold">Butce: \u20BA${fmt(totalBudget)} | Harcanan: \u20BA${fmt(totalSpent)} | Kalan: \u20BA${fmt(totalBudget-totalSpent)}</p></div>`;
    addAiMsg(html,false);
}

// ---- AI: INSTALLMENT CHECK ----
function aiInstallmentCheck(){
    const active=S.sales.filter(s=>s.installments&&s.installments.length>0&&s.installments.some(i=>!i.paid));
    if(active.length===0){addAiMsg('<b class="text-amber-400">&#128179; Taksit Durumu</b><p class="mt-2 text-gray-400 text-[11px]">Aktif taksit plani bulunamadi.</p>',false);return;}
    let html='<b class="text-amber-400">&#128179; Taksit Durumu ('+active.length+' aktif)</b><div class="space-y-2 mt-2">';
    active.forEach(s=>{
        const saleAmount=s.amount||s.price||0;
        const unpaid=s.installments.filter(i=>!i.paid);
        const paidInst=s.installments.filter(i=>i.paid);
        const pct=saleAmount>0?Math.round((s.paid||0)/saleAmount*100):0;
        const nextInst=unpaid[0];
        html+=`<div class="p-2 rounded bg-gray-800/30"><div class="flex justify-between"><p class="text-[11px] font-medium">${s.customer}</p><span class="text-[10px] ${unpaid.length<=2?'text-red-400':'text-yellow-400'} font-bold">${unpaid.length} taksit kaldi</span></div><p class="text-[9px] text-gray-500">${s.product||'-'} | ${paidInst.length}/${s.installments.length} odendi | Odenen: %${pct}</p><div class="progress-bar mt-1"><div class="progress-fill bg-green-500" style="width:${pct}%"></div></div><p class="text-[9px] text-gray-400 mt-1">Sonraki: \u20BA${fmt(nextInst.amount)} - ${nextInst.date}</p>${unpaid.length<=2?'<p class="text-[9px] text-red-400 mt-1">&#9888; Son taksitler yaklasti - musteri ile iletisime gecilmeli!</p>':''}</div>`;
    });
    const totalRemaining=active.reduce((s,sl)=>s+((sl.amount||sl.price||0)-(sl.paid||0)),0);
    html+=`</div><div class="mt-2 p-2 rounded bg-purple-500/10 border border-purple-500/20"><p class="text-[10px]">Toplam bekleyen tahsilat: <b class="text-purple-400">\u20BA${fmt(totalRemaining)}</b></p></div>`;
    addAiMsg(html,false);
}

// ---- AI: TENDER ANALYSIS ----
function aiTenderAnalysis(){
    if(S.tenders.length===0){addAiMsg('<b class="text-amber-400">&#128230; Ihale Durumu</b><p class="mt-2 text-gray-400 text-[11px]">Henuz ihale eklenmemis.</p>',false);return;}
    const pending=S.tenders.filter(t=>t.status==='Beklemede');
    const approved=S.tenders.filter(t=>t.status==='Onaylandi');
    const reviewing=S.tenders.filter(t=>t.status==='Degerlendiriliyor');
    const rejected=S.tenders.filter(t=>t.status==='Reddedildi');
    const totalVal=S.tenders.reduce((s,t)=>s+(t.budget||t.amount||0),0);
    let html=`<b class="text-amber-400">&#128230; Ihale Analizi (${S.tenders.length} toplam)</b>
<div class="grid grid-cols-2 gap-2 mt-2">
<div class="p-2 rounded bg-orange-500/10 text-center"><p class="text-lg font-bold text-orange-400">${pending.length}</p><p class="text-[9px] text-gray-400">Onay Bekleyen</p></div>
<div class="p-2 rounded bg-blue-500/10 text-center"><p class="text-lg font-bold text-blue-400">${reviewing.length}</p><p class="text-[9px] text-gray-400">Degerlendirmede</p></div>
<div class="p-2 rounded bg-green-500/10 text-center"><p class="text-lg font-bold text-green-400">${approved.length}</p><p class="text-[9px] text-gray-400">Onayli</p></div>
<div class="p-2 rounded bg-red-500/10 text-center"><p class="text-lg font-bold text-red-400">${rejected.length}</p><p class="text-[9px] text-gray-400">Reddedilen</p></div>
</div>`;
    if(pending.length>0){
        html+='<div class="mt-2"><p class="text-[10px] text-orange-400 font-semibold">Onay Bekleyenler:</p>';
        pending.forEach(t=>{html+='<div class="p-1.5 rounded bg-gray-800/30 mt-1 flex justify-between"><span class="text-[10px]">'+t.name+' ('+t.project+')</span><span class="text-[10px] font-bold">\u20BA'+fmt(t.budget||t.amount||0)+'</span></div>';});
        html+='</div>';
    }
    if(reviewing.length>0){
        html+='<div class="mt-2"><p class="text-[10px] text-blue-400 font-semibold">Degerlendirmede:</p>';
        reviewing.forEach(t=>{const bidCount=t.bids?t.bids.length:0;html+='<div class="p-1.5 rounded bg-gray-800/30 mt-1 flex justify-between"><span class="text-[10px]">'+t.name+' ('+bidCount+' teklif)</span><span class="text-[10px] font-bold">\u20BA'+fmt(t.budget||t.amount||0)+'</span></div>';});
        html+='</div>';
    }
    html+=`<div class="mt-2 p-2 rounded bg-gray-700/30"><p class="text-[10px]">Toplam ihale degeri: <b>\u20BA${fmt(totalVal)}</b></p></div>`;
    addAiMsg(html,false);
}

// ---- AI: PROJECT SUMMARY ----
function aiProjectSummary(){
    if(S.projects.length===0){addAiMsg('<b class="text-amber-400">&#127959; Proje Ozeti</b><p class="mt-2 text-gray-400 text-[11px]">Henuz proje eklenmemis. FaOn-Build modulunden proje ekleyebilirsiniz.</p>',false);return;}
    let html='<b class="text-amber-400">&#127959; Proje Ozeti ('+S.projects.length+')</b><div class="space-y-2 mt-2">';
    S.projects.forEach(p=>{
        const color=p.completion>=80?'text-green-400':p.completion>=50?'text-blue-400':p.completion>=25?'text-yellow-400':'text-red-400';
        html+=`<div class="p-2 rounded bg-gray-800/30"><div class="flex justify-between"><p class="text-[11px] font-medium">${p.name}</p><span class="${color} text-[10px] font-bold">%${p.completion}</span></div><p class="text-[9px] text-gray-500">Musteri: ${p.customer||'-'} | Durum: ${p.status} | Butce: \u20BA${fmt(p.budget)}</p></div>`;
    });
    html+='</div>';
    addAiMsg(html,false);
}

// ---- AI: SALES SUMMARY ----
function aiSalesSummary(){
    if(S.sales.length===0){addAiMsg('<b class="text-amber-400">&#128176; Satis Ozeti</b><p class="mt-2 text-gray-400 text-[11px]">Henuz satis kaydis yok.</p>',false);return;}
    const total=S.sales.reduce((s,x)=>s+(x.amount||x.price||0),0);
    const paid=S.sales.reduce((s,x)=>s+(x.paid||0),0);
    const stages={Teklif:0,Muzakere:0,Sozlesme:0,Tamamlandi:0};
    S.sales.forEach(s=>{const key=s.pipeline||s.status||'Diger';if(key==='Kapandi')stages['Tamamlandi']++;else if(stages[key]!==undefined)stages[key]++;});
    const collRate=total>0?Math.round(paid/total*100):0;
    addAiMsg(`<b class="text-amber-400">&#128176; Satis Ozeti (${S.sales.length})</b>
<div class="grid grid-cols-2 gap-2 mt-2">
<div class="p-2 rounded bg-green-500/10"><p class="text-[9px] text-gray-400">Toplam Satis</p><p class="text-sm font-bold text-green-400">\u20BA${fmt(total)}</p></div>
<div class="p-2 rounded bg-blue-500/10"><p class="text-[9px] text-gray-400">Tahsil Edilen</p><p class="text-sm font-bold text-blue-400">\u20BA${fmt(paid)} (%${collRate})</p></div>
</div>
<div class="mt-2 p-2 rounded bg-gray-800/30">
<p class="text-[10px] text-gray-400 mb-1">Pipeline Dagilimi:</p>
<div class="flex gap-2 flex-wrap">
<span class="text-[9px] px-2 py-0.5 rounded bg-gray-600">Teklif: ${stages.Teklif}</span>
<span class="text-[9px] px-2 py-0.5 rounded bg-yellow-600/30">Muzakere: ${stages.Muzakere}</span>
<span class="text-[9px] px-2 py-0.5 rounded bg-blue-600/30">Sozlesme: ${stages.Sozlesme}</span>
<span class="text-[9px] px-2 py-0.5 rounded bg-green-600/30">Tamamlandi: ${stages.Tamamlandi}</span>
</div></div>`,false);
}

// ---- AI: FILES SUMMARY ----
function aiFilesSummary(){
    const fileCount=Object.values(S.connFiles).reduce((s,arr)=>s+arr.length,0);
    const kbCount=S.knowledgeBase.length;
    addAiMsg(`<b class="text-amber-400">&#128194; Dosya & Bilgi Bankasi</b>
<p class="mt-2 text-[11px]">&#128196; Kanal dosyalari: <b>${fileCount}</b></p>
<p class="text-[11px]">&#128218; Bilgi bankasi: <b>${kbCount} dokuman</b></p>
${kbCount>0?'<p class="text-[10px] text-gray-400 mt-1">Kategoriler: '+[...new Set(S.knowledgeBase.map(k=>k.category))].join(', ')+'</p>':''}`,false);
}

// ---- AI: TEAM SUMMARY ----
function aiTeamSummary(){
    let html='<b class="text-amber-400">&#128101; Ekip Bilgisi ('+S.users.length+' kullanici)</b><div class="space-y-1 mt-2">';
    S.users.forEach(u=>{
        html+=`<div class="flex items-center gap-2 p-1.5 rounded bg-gray-800/30"><div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-[9px] font-bold">${u.name.split(' ').map(n=>n[0]).join('')}</div><div><p class="text-[10px] font-medium">${u.name}</p><p class="text-[9px] text-gray-500">${u.role} | ${u.phone||'-'}</p></div></div>`;
    });
    html+='</div>';
    addAiMsg(html,false);
}

// ---- AI: SEND NOTIFICATION ----
function aiSendNotification(text){
    const parts=text.replace(/@bildir|@gonder/gi,'').trim().split(' ');
    let targetChannel=parts[0]||'genel';
    targetChannel=targetChannel.replace('#','');
    const ch=S.channels.find(c=>c.id===targetChannel||c.name===targetChannel);
    if(!ch){addAiMsg('&#10060; <b>'+targetChannel+'</b> kanali bulunamadi. Mevcut kanallar: '+S.channels.map(c=>'#'+c.name).join(', '),false);return;}
    const msgContent=parts.slice(1).join(' ')||'FaOn AI sistem bildirimi';
    if(!S.messages[ch.id])S.messages[ch.id]=[];
    S.messages[ch.id].push({id:Date.now(),user:'FaOn AI',text:'&#129302; <b>AI Bildirimi:</b> '+msgContent,time:new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),mine:false,isAI:true});
    save();renderMessages();
    addAiMsg('&#10003; Mesaj <b>#'+ch.name+'</b> kanalina gonderildi: <i>"'+msgContent+'"</i>',false);
    act('AI: #'+ch.name+' kanalina bildirim gonderildi');
}

// ---- AI: SMART RESPONSE ----
function aiSmartResponse(text){
    const responses=[
        'Bu konuda size yardimci olabilmem icin daha detayli bilgi verebilir misiniz? Sistemdeki verileri analiz etmem icin <code class="text-[10px] bg-gray-700 px-1 rounded">@analiz</code> komutunu deneyebilirsiniz.',
        'Anladim! Sistem verilerine bakmami isterseniz alt kisimdaki hizli erisim butonlarini kullanabilirsiniz. Proje, butce, taksit ve ihale analizleri yapabilirim.',
        'Bu konuyu arastirmak icin daha fazla veriye ihtiyacim var. Su an sisteminizde <b>'+S.projects.length+'</b> proje, <b>'+S.tenders.length+'</b> ihale ve <b>'+S.sales.length+'</b> satis kaydi bulunuyor.',
    ];
    addAiMsg(responses[Math.floor(Math.random()*responses.length)],false);
}

// ---- AI: FULL SYSTEM SCAN ----
function aiRunFullScan(){
    addAiMsg('@tara',true);
    setTimeout(()=>{
        addAiMsg('&#128269; <b>Tam sistem taramasi baslatiliyor...</b>',false);
        setTimeout(()=>aiSystemAnalysis(),600);
        setTimeout(()=>aiReminders(),1200);
    },300);
}

// ---- AI: DEPO & ENVANTER ANALYSIS ----
function aiDepoAnalysis(){
    const depolar=S.depolar||[];
    const envanter=S.envanter||[];
    const hareketler=S.depoHareketler||[];
    const zimmetler=S.zimmetler||[];
    if(depolar.length===0&&envanter.length===0){
        addAiMsg('<b class="text-amber-400">&#128230; Depo & Envanter Analizi</b><p class="mt-2 text-gray-400 text-[11px]">Henuz depo veya envanter kaydi bulunamadi. FaOn-Depo modulunden ekleyebilirsiniz.</p>',false);return;
    }
    const kategoriler=S.depoKategoriler||[];
    const katDist={};
    envanter.forEach(i=>{const k=i.kategori||'diger';katDist[k]=(katDist[k]||0)+1;});
    const totalDeger=envanter.reduce((s,i)=>s+(parseFloat(i.birimFiyat||0)*parseFloat(i.miktar||1)),0);
    const dusukStok=envanter.filter(i=>parseFloat(i.miktar||0)<=parseFloat(i.minStok||0)&&parseFloat(i.minStok||0)>0);
    const sonHareketler=hareketler.slice(-5).reverse();
    let html='<b class="text-amber-400">&#128230; Depo & Envanter Raporu</b>';
    html+='<div class="grid grid-cols-3 gap-2 mt-2">';
    html+='<div class="p-2 rounded bg-blue-500/10 text-center"><p class="text-lg font-bold text-blue-400">'+depolar.length+'</p><p class="text-[9px] text-gray-400">Depo</p></div>';
    html+='<div class="p-2 rounded bg-purple-500/10 text-center"><p class="text-lg font-bold text-purple-400">'+envanter.length+'</p><p class="text-[9px] text-gray-400">Envanter</p></div>';
    html+='<div class="p-2 rounded bg-green-500/10 text-center"><p class="text-lg font-bold text-green-400">\u20BA'+fmt(totalDeger)+'</p><p class="text-[9px] text-gray-400">Toplam Deger</p></div>';
    html+='</div>';
    if(Object.keys(katDist).length>0){
        html+='<div class="mt-2 p-2 rounded bg-gray-800/30"><p class="text-[10px] text-gray-400 mb-1">Kategori Dagilimi:</p><div class="flex gap-1 flex-wrap">';
        Object.entries(katDist).forEach(([k,v])=>{
            const kat=kategoriler.find(c=>c.key===k);
            html+='<span class="text-[9px] px-2 py-0.5 rounded bg-gray-700">'+(kat?kat.ad:k)+': '+v+'</span>';
        });
        html+='</div></div>';
    }
    if(dusukStok.length>0){
        html+='<div class="mt-2 p-2 rounded bg-red-500/10 border border-red-500/20"><p class="text-[10px] text-red-400 font-semibold">&#9888; Dusuk Stok Uyarilari ('+dusukStok.length+')</p>';
        dusukStok.slice(0,5).forEach(i=>{
            html+='<p class="text-[10px] text-red-300 mt-1">&#8226; '+i.ad+' - Stok: '+(i.miktar||0)+' '+( i.birim||'adet')+' (Min: '+(i.minStok||0)+')</p>';
        });
        html+='</div>';
    }else{
        html+='<p class="text-[10px] text-green-400 mt-2">&#10003; Tum stok seviyeleri yeterli.</p>';
    }
    if(zimmetler.length>0){
        html+='<div class="mt-2 p-2 rounded bg-orange-500/10"><p class="text-[10px] text-orange-400 font-semibold">Zimmetler: '+zimmetler.length+' kayit</p></div>';
    }
    if(sonHareketler.length>0){
        html+='<div class="mt-2"><p class="text-[10px] text-gray-400 font-semibold">Son Hareketler:</p>';
        sonHareketler.forEach(h=>{
            const item=envanter.find(i=>i.id===h.envanterItemId);
            html+='<p class="text-[10px] text-gray-300 mt-0.5">&#8226; '+(item?item.ad:'?')+' - '+h.tip+' ('+h.miktar+') - '+new Date(h.tarih).toLocaleDateString('tr-TR')+'</p>';
        });
        html+='</div>';
    }
    addAiMsg(html,false);
}

// ---- AI: ARAC/FILO ANALYSIS ----
function aiAracAnalysis(){
    const araclar=S.araclar||[];
    if(araclar.length===0){
        addAiMsg('<b class="text-amber-400">&#128663; Arac & Filo Durumu</b><p class="mt-2 text-gray-400 text-[11px]">Henuz arac kaydi bulunamadi. FaOn-Depo modulunden arac ekleyebilirsiniz.</p>',false);return;
    }
    const aktif=araclar.filter(a=>a.durum==='aktif'||!a.durum);
    const bakimda=araclar.filter(a=>a.durum==='bakimda');
    const pasif=araclar.filter(a=>a.durum==='pasif');
    const warnings=[];
    araclar.forEach(a=>{
        if(a.sigortaBitis){const gun=Math.ceil((new Date(a.sigortaBitis)-new Date())/(1000*60*60*24));if(gun<=30)warnings.push({arac:a.plaka||a.ad||'Arac',tip:'Sigorta',gun:gun});}
        if(a.muayeneBitis){const gun=Math.ceil((new Date(a.muayeneBitis)-new Date())/(1000*60*60*24));if(gun<=30)warnings.push({arac:a.plaka||a.ad||'Arac',tip:'Muayene',gun:gun});}
        if(a.egzozBitis){const gun=Math.ceil((new Date(a.egzozBitis)-new Date())/(1000*60*60*24));if(gun<=30)warnings.push({arac:a.plaka||a.ad||'Arac',tip:'Egzoz Emisyon',gun:gun});}
        if(a.bakimKm&&a.km){const kalan=a.bakimKm-a.km;if(kalan<=1000&&kalan>0)warnings.push({arac:a.plaka||a.ad||'Arac',tip:'Bakim ('+kalan+' km kaldi)',gun:null});}
    });
    let html='<b class="text-amber-400">&#128663; Arac & Filo Raporu ('+araclar.length+' arac)</b>';
    html+='<div class="grid grid-cols-3 gap-2 mt-2">';
    html+='<div class="p-2 rounded bg-green-500/10 text-center"><p class="text-lg font-bold text-green-400">'+aktif.length+'</p><p class="text-[9px] text-gray-400">Aktif</p></div>';
    html+='<div class="p-2 rounded bg-orange-500/10 text-center"><p class="text-lg font-bold text-orange-400">'+bakimda.length+'</p><p class="text-[9px] text-gray-400">Bakimda</p></div>';
    html+='<div class="p-2 rounded bg-gray-500/10 text-center"><p class="text-lg font-bold text-gray-400">'+pasif.length+'</p><p class="text-[9px] text-gray-400">Pasif</p></div>';
    html+='</div>';
    if(warnings.length>0){
        html+='<div class="mt-2 p-2 rounded bg-red-500/10 border border-red-500/20"><p class="text-[10px] text-red-400 font-semibold">&#9888; Belge/Bakim Uyarilari ('+warnings.length+')</p>';
        warnings.forEach(w=>{
            const renk=w.gun!==null&&w.gun<=7?'text-red-400':w.gun!==null&&w.gun<=15?'text-orange-400':'text-yellow-400';
            html+='<p class="text-[10px] '+renk+' mt-1">&#8226; '+w.arac+' - '+w.tip+(w.gun!==null?' ('+w.gun+' gun kaldi)':'')+'</p>';
        });
        html+='</div>';
    }else{
        html+='<p class="text-[10px] text-green-400 mt-2">&#10003; Tum arac belgeleri guncel.</p>';
    }
    araclar.slice(0,5).forEach(a=>{
        html+='<div class="mt-1 p-1.5 rounded bg-gray-800/30 flex items-center gap-2"><span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700 font-mono">'+(a.plaka||'???')+'</span><span class="text-[10px] flex-1">'+(a.ad||a.marka||'-')+'</span><span class="text-[9px] text-gray-500">'+(a.km?a.km+' km':'')+'</span></div>';
    });
    addAiMsg(html,false);
}

// ---- AI: TOPLANTI OZETI ----
function aiMeetingSummary(){
    const meetings=S.meetings||[];
    if(meetings.length===0){
        addAiMsg('<b class="text-amber-400">&#128197; Toplanti Durumu</b><p class="mt-2 text-gray-400 text-[11px]">Henuz toplanti planlanmamis. Connect modulunden toplanti olusturabilirsiniz.</p>',false);return;
    }
    const now=new Date();
    const upcoming=meetings.filter(m=>new Date(m.startTime)>now).sort((a,b)=>new Date(a.startTime)-new Date(b.startTime));
    const past=meetings.filter(m=>new Date(m.startTime)<=now).sort((a,b)=>new Date(b.startTime)-new Date(a.startTime));
    let html='<b class="text-amber-400">&#128197; Toplanti Raporu ('+meetings.length+' toplam)</b>';
    html+='<div class="grid grid-cols-2 gap-2 mt-2">';
    html+='<div class="p-2 rounded bg-blue-500/10 text-center"><p class="text-lg font-bold text-blue-400">'+upcoming.length+'</p><p class="text-[9px] text-gray-400">Yaklasan</p></div>';
    html+='<div class="p-2 rounded bg-gray-500/10 text-center"><p class="text-lg font-bold text-gray-400">'+past.length+'</p><p class="text-[9px] text-gray-400">Gecmis</p></div>';
    html+='</div>';
    if(upcoming.length>0){
        html+='<div class="mt-2"><p class="text-[10px] text-blue-400 font-semibold">Yaklasan Toplantilar:</p>';
        upcoming.slice(0,5).forEach(m=>{
            const d=new Date(m.startTime);
            const gun=Math.ceil((d-now)/(1000*60*60*24));
            const renk=gun<=1?'text-red-400':gun<=3?'text-orange-400':'text-blue-400';
            html+='<div class="p-1.5 rounded bg-gray-800/30 mt-1"><div class="flex justify-between"><span class="text-[10px] font-medium">'+m.title+'</span><span class="text-[9px] '+renk+'">'+(gun<=0?'Bugun':gun+' gun sonra')+'</span></div><p class="text-[9px] text-gray-500">'+d.toLocaleDateString('tr-TR')+' '+d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})+(m.participants?' ¬∑ '+m.participants.length+' katilimci':'')+'</p></div>';
        });
        html+='</div>';
    }
    addAiMsg(html,false);
}

// ---- AI: SILME TALEPLERI DURUMU ----
function aiDeletionStatus(){
    const pending=(S.pendingDeletions||[]).filter(r=>r.status==='pending');
    const approved=(S.pendingDeletions||[]).filter(r=>r.status==='approved');
    const rejected=(S.pendingDeletions||[]).filter(r=>r.status==='rejected');
    const total=S.pendingDeletions?S.pendingDeletions.length:0;
    if(total===0){
        addAiMsg('<b class="text-amber-400">&#128465; Silme Talepleri</b><p class="mt-2 text-gray-400 text-[11px]">Henuz silme talebi olusturulmamis.</p>',false);return;
    }
    let html='<b class="text-amber-400">&#128465; Silme Talepleri Durumu</b>';
    html+='<div class="grid grid-cols-3 gap-2 mt-2">';
    html+='<div class="p-2 rounded bg-orange-500/10 text-center"><p class="text-lg font-bold text-orange-400">'+pending.length+'</p><p class="text-[9px] text-gray-400">Bekleyen</p></div>';
    html+='<div class="p-2 rounded bg-red-500/10 text-center"><p class="text-lg font-bold text-red-400">'+approved.length+'</p><p class="text-[9px] text-gray-400">Onaylanan</p></div>';
    html+='<div class="p-2 rounded bg-gray-500/10 text-center"><p class="text-lg font-bold text-gray-400">'+rejected.length+'</p><p class="text-[9px] text-gray-400">Reddedilen</p></div>';
    html+='</div>';
    if(pending.length>0){
        html+='<div class="mt-2 p-2 rounded bg-orange-500/10 border border-orange-500/20"><p class="text-[10px] text-orange-400 font-semibold">&#9203; Onay Bekleyenler:</p>';
        pending.forEach(r=>{
            html+='<p class="text-[10px] text-gray-300 mt-1">&#8226; '+r.itemName+' <span class="text-gray-500">('+r.requestedBy+')</span></p>';
        });
        html+='</div>';
        const isAdmin=currentUser&&(currentUser.role==='admin'||currentUser.role==='Yonetici');
        if(isAdmin)html+='<div class="mt-2"><button onclick="openDeletionRequests();closeModal(\'modal-none\')" class="px-3 py-1.5 bg-orange-600/20 text-orange-400 text-[10px] rounded-lg hover:bg-orange-600/30 border border-orange-500/20">&#128194; Talepleri Yonet</button></div>';
    }
    addAiMsg(html,false);
}

// ---- AI: SMART SEARCH ----
function aiSearch(query){
    const q=query.toLowerCase().replace(/ara |bul |goster |g√∂ster |nerede |listele /g,'').trim();
    if(!q||q.length<2){addAiMsg('<b class="text-amber-400">&#128269; Arama</b><p class="mt-2 text-gray-400 text-[11px]">Lutfen en az 2 karakter girin. Ornek: <code class="bg-gray-700 px-1 rounded">@ara hakedis</code></p>',false);return;}
    let results=[];
    // Search projects
    (S.projects||[]).forEach(p=>{if((p.name||'').toLowerCase().includes(q)||(p.customer||'').toLowerCase().includes(q))results.push({type:'Proje',name:p.name||'?',detail:'Durum: '+(p.status||'-')+' | %'+(p.completion||0)+' | \u20BA'+fmt(p.budget||0)});});
    // Search sales/customers
    (S.sales||[]).forEach(s=>{if((s.customer||'').toLowerCase().includes(q)||(s.product||'').toLowerCase().includes(q))results.push({type:'Satis',name:(s.customer||'?')+' - '+(s.product||''),detail:'Tutar: \u20BA'+fmt(s.amount||s.price||0)+' | Durum: '+(s.pipeline||s.status||'-')});});
    // Search tenders
    (S.tenders||[]).forEach(t=>{if((t.name||'').toLowerCase().includes(q)||(t.project||'').toLowerCase().includes(q))results.push({type:'Ihale',name:t.name||'?',detail:'Proje: '+(t.project||'-')+' | Durum: '+(t.status||'-')+' | \u20BA'+fmt(t.budget||t.amount||0)});});
    // Search files
    Object.entries(S.connFiles||{}).forEach(([ch,files])=>{(files||[]).forEach(f=>{if(!f.deleted&&(f.name||'').toLowerCase().includes(q))results.push({type:'Dosya',name:f.name,detail:(f.type||'-')+' | '+(f.size||'-')+' | #'+ch+' | '+(f.uploadedBy||'-')});});});
    // Search knowledge base
    (S.knowledgeBase||[]).forEach(k=>{if(!k.deleted&&((k.title||'').toLowerCase().includes(q)||(k.desc||'').toLowerCase().includes(q)))results.push({type:'Bilgi',name:k.title||'?',detail:(k.category||'-')+' | '+(k.fileType||'-')+' | '+(k.addedBy||'-')});});
    // Search users
    (S.users||[]).forEach(u=>{if((u.name||'').toLowerCase().includes(q)||(u.role||'').toLowerCase().includes(q))results.push({type:'Kullanici',name:u.name||'?',detail:(u.role||'-')+' | '+(u.email||'-')});});
    // Search inventory
    (S.envanter||[]).forEach(i=>{if((i.ad||'').toLowerCase().includes(q))results.push({type:'Envanter',name:i.ad||'?',detail:(i.kategori||'-')+' | Stok: '+(i.miktar||0)+' '+(i.birim||'adet')});});
    // Search vehicles
    (S.araclar||[]).forEach(a=>{if((a.plaka||'').toLowerCase().includes(q)||(a.ad||'').toLowerCase().includes(q)||(a.marka||'').toLowerCase().includes(q))results.push({type:'Arac',name:(a.plaka||'?')+' - '+(a.ad||a.marka||''),detail:'Durum: '+(a.durum||'aktif')+(a.km?' | '+a.km+' km':'')});});

    if(results.length===0){
        addAiMsg('<b class="text-amber-400">&#128269; Arama: "'+q+'"</b><p class="mt-2 text-gray-400 text-[11px]">Sonuc bulunamadi. Farkli anahtar kelimeler deneyin.</p>',false);return;
    }
    const typeIcons={Proje:'&#127959;',Satis:'&#128176;',Ihale:'&#128230;',Dosya:'&#128196;',Bilgi:'&#128218;',Kullanici:'&#128100;',Envanter:'&#128230;',Arac:'&#128663;'};
    let html='<b class="text-amber-400">&#128269; Arama: "'+q+'" ('+results.length+' sonuc)</b><div class="space-y-1.5 mt-2">';
    results.slice(0,10).forEach(r=>{
        html+='<div class="p-2 rounded bg-gray-800/30 flex items-start gap-2"><span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-700 flex-shrink-0">'+(typeIcons[r.type]||'')+' '+r.type+'</span><div class="min-w-0"><p class="text-[10px] font-medium truncate">'+r.name+'</p><p class="text-[9px] text-gray-500">'+r.detail+'</p></div></div>';
    });
    if(results.length>10)html+='<p class="text-[10px] text-gray-500 mt-1">...ve '+(results.length-10)+' sonuc daha</p>';
    html+='</div>';
    addAiMsg(html,false);
}

// ---- AI: ENHANCED SMART RESPONSE ----
function aiSmartResponseV2(text){
    const lower=text.toLowerCase();
    // Context-aware suggestions
    const suggestions=[];
    if(S.projects.length>0){
        const overBudget=S.projects.filter(p=>(p.spent||0)>p.budget*0.85);
        if(overBudget.length>0)suggestions.push('&#9888; '+overBudget.length+' projede butce riski var - <code class="text-[10px] bg-gray-700 px-1 rounded">@butce</code> ile detay gorun');
    }
    const pendingDel=(S.pendingDeletions||[]).filter(r=>r.status==='pending');
    if(pendingDel.length>0)suggestions.push('&#128465; '+pendingDel.length+' silme talebi onay bekliyor');
    const meetings=(S.meetings||[]).filter(m=>new Date(m.startTime)>new Date());
    if(meetings.length>0)suggestions.push('&#128197; '+meetings.length+' yaklasan toplanti var');
    const dusukStok=(S.envanter||[]).filter(i=>parseFloat(i.miktar||0)<=parseFloat(i.minStok||0)&&parseFloat(i.minStok||0)>0);
    if(dusukStok.length>0)suggestions.push('&#128230; '+dusukStok.length+' urun stok seviyesi dusuk');

    let html='<p class="text-[11px]">Bu konuda size daha iyi yardimci olabilmem icin asagidaki komutlari kullanabilirsiniz:</p>';
    html+='<div class="mt-2 space-y-1">';
    html+='<p class="text-[10px] text-gray-300">&#128202; <code class="bg-gray-700 px-1 rounded">@analiz</code> - Sistem genel durumu</p>';
    html+='<p class="text-[10px] text-gray-300">&#128269; <code class="bg-gray-700 px-1 rounded">@ara [kelime]</code> - Tum sistemde arama</p>';
    html+='<p class="text-[10px] text-gray-300">&#128230; <code class="bg-gray-700 px-1 rounded">@depo</code> - Envanter ve stok durumu</p>';
    html+='<p class="text-[10px] text-gray-300">&#128663; <code class="bg-gray-700 px-1 rounded">@arac</code> - Filo ve arac durumu</p>';
    html+='<p class="text-[10px] text-gray-300">&#128197; <code class="bg-gray-700 px-1 rounded">@toplanti</code> - Toplanti takvimi</p>';
    html+='<p class="text-[10px] text-gray-300">&#128465; <code class="bg-gray-700 px-1 rounded">@silme</code> - Silme talepleri durumu</p>';
    html+='</div>';
    if(suggestions.length>0){
        html+='<div class="mt-2 p-2 rounded bg-amber-500/10 border border-amber-500/20"><p class="text-[10px] text-amber-400 font-semibold">&#128161; Dikkatinize:</p>';
        suggestions.forEach(s=>{html+='<p class="text-[10px] text-amber-300 mt-0.5">'+s+'</p>';});
        html+='</div>';
    }
    addAiMsg(html,false);
}

// ---- AI: AUTO PERIODIC CHECK (every 60s) ----
setInterval(()=>{
    // Silent background check for critical issues
    const criticals=[];
    S.projects.forEach(p=>{if((p.spent||0)>p.budget)criticals.push(p.name+' butce asimi!');});
    S.sales.forEach(s=>{if(s.paid===0&&s.price>500000)criticals.push(s.customer+' yuksek tutarli odeme bekliyor');});
    if(criticals.length>0&&S.channels.find(c=>c.id==='genel')){
        // Add subtle notification badge
        const badge=document.getElementById('connect-badge');
        if(badge){const current=parseInt(badge.textContent)||0;badge.textContent=current+criticals.length;}
    }
},60000);

// ===================== TASERON CRUD =====================
function openTaseronForm(projectId){
    document.getElementById('taseron-project-id').value=projectId;
    const sel=document.getElementById('taseron-is-paketi');
    sel.innerHTML=WORK_PACKAGES.map(w=>`<option value="${w}">${w}</option>`).join('');
    openModal('modal-taseron');
}
function addTaseron(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('taseron-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.taseronlar)p.taseronlar=[];
    p.taseronlar.push({id:Date.now(),firma:f.get('firma'),isPaketi:f.get('isPaketi'),yetkili:f.get('yetkili')||'',telefon:f.get('telefon')||'',tutar:+f.get('tutar'),baslangic:f.get('baslangic')||'',kapsam:f.get('kapsam')||'',durum:'aktif',odemeler:[],createdAt:new Date().toISOString()});
    act(p.name+' - Taseron eklendi: '+f.get('firma'));save();renderAll();closeModal('modal-taseron');e.target.reset();showNotif('Taseron eklendi!');
}
function removeTaseron(projectId,taseronId){
    if(!confirm('Bu taseronu silmek istediginize emin misiniz?'))return;
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.taseronlar)return;
    p.taseronlar=p.taseronlar.filter(t=>t.id!==taseronId);
    act('Taseron silindi');save();renderAll();showNotif('Taseron silindi.');
}
function renderTaseronlarTab(){
    const c=document.getElementById('taseronlar-view');
    const allT=[];
    S.projects.forEach(p=>{(p.taseronlar||[]).forEach(t=>{allT.push({...t,projectName:p.name,projectId:p.id});});});
    if(allT.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz taseron eklenmedi.</p><p class="text-gray-600 text-xs mt-1">Proje kartlarindan "+ Taseron" butonunu kullanin.</p></div>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Tum Taseronlar ('+allT.length+')</h4><button onclick="openExcelImport(null,\'taseron\')" class="px-3 py-1.5 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/40 rounded text-xs">üì• Excel\'den Aktar</button></div>';
    html+='<div class="space-y-3">'+allT.map(t=>`<div class="glass rounded-xl p-4">
        <div class="flex items-start justify-between mb-2">
            <div><h5 class="font-bold text-sm">${t.firma}</h5><p class="text-[10px] text-gray-500">${t.projectName} | ${t.isPaketi}</p></div>
            <div class="flex items-center gap-2"><span class="px-2 py-0.5 rounded text-[9px] font-semibold ${t.durum==='aktif'?'bg-green-500/20 text-green-400':'bg-gray-500/20 text-gray-400'}">${t.durum==='aktif'?'Aktif':'Pasif'}</span><button onclick="removeTaseron(${t.projectId},${t.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button></div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-xs">
            <div><p class="text-[10px] text-gray-500">Sozlesme</p><p class="font-bold text-amber-400">\u20BA${fmt(t.tutar)}</p></div>
            <div><p class="text-[10px] text-gray-500">Yetkili</p><p>${t.yetkili||'-'}</p></div>
            <div><p class="text-[10px] text-gray-500">Telefon</p><p>${t.telefon||'-'}</p></div>
        </div>
        ${t.kapsam?'<p class="text-[10px] text-gray-500 mt-2">'+t.kapsam+'</p>':''}
    </div>`).join('')+'</div>';
    c.innerHTML=html;
}

// ===================== TEDARIKCI CRUD =====================
function openTedarikciForm(projectId){
    document.getElementById('tedarikci-project-id').value=projectId;
    openModal('modal-tedarikci');
}
function addTedarikci(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('tedarikci-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.tedarikciler)p.tedarikciler=[];
    p.tedarikciler.push({id:Date.now(),firma:f.get('firma'),malzeme:f.get('malzeme'),yetkili:f.get('yetkili')||'',telefon:f.get('telefon')||'',tutar:+f.get('tutar')||0,puan:+f.get('puan')||3,createdAt:new Date().toISOString()});
    act(p.name+' - Tedarikci eklendi: '+f.get('firma'));save();renderAll();closeModal('modal-tedarikci');e.target.reset();showNotif('Tedarikci eklendi!');
}
function removeTedarikci(projectId,tedarikciId){
    if(!confirm('Bu tedarikciyi silmek istediginize emin misiniz?'))return;
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.tedarikciler)return;
    p.tedarikciler=p.tedarikciler.filter(t=>t.id!==tedarikciId);
    act('Tedarikci silindi');save();renderAll();showNotif('Tedarikci silindi.');
}

// ===================== IS KALEMI (BOQ) CRUD =====================
function openIsKalemiForm(projectId){
    document.getElementById('iskalemi-project-id').value=projectId;
    const kSel=document.getElementById('iskalemi-kategori');
    kSel.innerHTML=WORK_CATEGORIES.map(c=>`<option value="${c.v}">${c.l}</option>`).join('');
    const bSel=document.getElementById('iskalemi-birim');
    bSel.innerHTML=UNITS.map(u=>`<option value="${u}">${u}</option>`).join('');
    const p=S.projects.find(x=>x.id===projectId);
    const tSel=document.getElementById('iskalemi-taseron');
    tSel.innerHTML='<option value="">Seciniz...</option>';
    if(p&&p.taseronlar)(p.taseronlar||[]).forEach(t=>tSel.innerHTML+=`<option value="${t.id}">${t.firma} (${t.isPaketi})</option>`);
    openModal('modal-iskalemi');
}
function addIsKalemi(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('iskalemi-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.isKalemleri)p.isKalemleri=[];
    const miktar=+f.get('miktar'),birimFiyat=+f.get('birimFiyat');
    p.isKalemleri.push({id:Date.now(),pozNo:f.get('pozNo')||'',kalemAdi:f.get('kalemAdi'),kategori:f.get('kategori'),miktar:miktar,birim:f.get('birim'),birimFiyat:birimFiyat,toplamTutar:miktar*birimFiyat,agirlik:+f.get('agirlik')||0,taseronId:f.get('taseronId')||'',gerceklesen:0,createdAt:new Date().toISOString()});
    act(p.name+' - Is kalemi eklendi: '+f.get('kalemAdi'));save();renderAll();closeModal('modal-iskalemi');e.target.reset();showNotif('Is kalemi eklendi!');
}
function removeIsKalemi(projectId,kalemId){
    if(!confirm('Bu is kalemini silmek istediginize emin misiniz?'))return;
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.isKalemleri)return;
    p.isKalemleri=p.isKalemleri.filter(k=>k.id!==kalemId);
    recalcProjectCompletion(projectId);
    act('Is kalemi silindi');save();renderAll();showNotif('Is kalemi silindi.');
}
function updateIsKalemiProgress(projectId,kalemId,value){
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.isKalemleri)return;
    const k=p.isKalemleri.find(x=>x.id===kalemId);if(!k)return;
    k.gerceklesen=Math.min(+value,k.miktar);
    recalcProjectCompletion(projectId);
    save();renderAll();
}
function recalcProjectCompletion(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.isKalemleri||p.isKalemleri.length===0)return;
    const totalWeight=p.isKalemleri.reduce((s,k)=>s+(k.agirlik||0),0);
    if(totalWeight>0){
        let weightedSum=0;
        p.isKalemleri.forEach(k=>{const pct=k.miktar>0?(k.gerceklesen/k.miktar)*100:0;weightedSum+=pct*(k.agirlik/totalWeight);});
        p.completion=Math.round(weightedSum);
    } else {
        const avg=p.isKalemleri.reduce((s,k)=>s+(k.miktar>0?(k.gerceklesen/k.miktar)*100:0),0)/p.isKalemleri.length;
        p.completion=Math.round(avg);
    }
}
function renderIsKalemleriTab(){
    const c=document.getElementById('is-kalemleri-view');
    const allK=[];
    S.projects.forEach(p=>{(p.isKalemleri||[]).forEach(k=>{allK.push({...k,projectName:p.name,projectId:p.id});});});
    if(allK.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz is kalemi eklenmedi.</p><p class="text-gray-600 text-xs mt-1">Proje kartlarindan "+ Is Kalemi" butonunu kullanin.</p></div>';return;}
    const totalTutar=allK.reduce((s,k)=>s+k.toplamTutar,0);
    let html=`<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Tum Is Kalemleri (${allK.length})</h4><div class="flex items-center gap-3"><span class="text-xs text-gray-400">Toplam: <b class="text-blue-400">\u20BA${fmt(totalTutar)}</b></span><button onclick="openExcelImport(0,'iskalemi')" class="px-3 py-1.5 bg-purple-600/20 text-purple-400 hover:bg-purple-600/40 rounded text-xs">üì• Excel'den Aktar</button></div></div>`;
    html+='<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-800/50"><tr class="text-left text-[10px] text-gray-400"><th class="p-2">Proje</th><th class="p-2">Poz No</th><th class="p-2">Is Kalemi</th><th class="p-2">Kategori</th><th class="p-2">Miktar</th><th class="p-2">B.Fiyat</th><th class="p-2">Toplam</th><th class="p-2">Gerceklesen</th><th class="p-2">%</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-gray-800">';
    allK.forEach(k=>{
        const pct=k.miktar>0?Math.round((k.gerceklesen/k.miktar)*100):0;
        const pctColor=pct>=80?'text-green-400':pct>=50?'text-blue-400':pct>=25?'text-yellow-400':'text-red-400';
        html+=`<tr><td class="p-2 text-gray-400">${k.projectName}</td><td class="p-2 text-purple-400 font-mono text-[10px]">${k.pozNo||'-'}</td><td class="p-2 font-medium">${k.kalemAdi}</td><td class="p-2">${(WORK_CATEGORIES.find(c=>c.v===k.kategori)||{l:'-'}).l}</td><td class="p-2">${k.miktar} ${k.birim}</td><td class="p-2">\u20BA${k.birimFiyat.toLocaleString('tr-TR')}</td><td class="p-2 font-bold text-blue-400">\u20BA${fmt(k.toplamTutar)}</td><td class="p-2"><input type="number" value="${k.gerceklesen}" min="0" max="${k.miktar}" step="0.01" class="w-16 bg-gray-800 border border-gray-700 rounded px-1 py-0.5 text-[10px] text-center" onchange="updateIsKalemiProgress(${k.projectId},${k.id},this.value)"> ${k.birim}</td><td class="p-2 ${pctColor} font-bold">%${pct}</td><td class="p-2"><button onclick="removeIsKalemi(${k.projectId},${k.id})" class="text-gray-600 hover:text-red-400">&times;</button></td></tr>`;
    });
    html+='</tbody></table></div>';
    c.innerHTML=html;
}

// ===================== EXCEL IMPORT =====================
let excelImportData=[];
function openExcelImport(projectId,type){
    document.getElementById('excel-import-type').value=type;
    document.getElementById('excel-import-project-id').value=projectId||'';
    const titles={iskalemi:'Is Kalemleri Icerik Aktar',taseron:'Taseron Icerik Aktar',tedarikci:'Tedarikci Icerik Aktar'};
    document.getElementById('excel-import-title').textContent=titles[type]||'Excel Icerik Aktar';
    const pSel=document.getElementById('excel-import-project-select');
    pSel.innerHTML=S.projects.map(p=>`<option value="${p.id}"${p.id===projectId?' selected':''}>${p.name}</option>`).join('');
    if(projectId)pSel.value=projectId;
    document.getElementById('excel-preview').classList.add('hidden');
    document.getElementById('excel-file-input').value='';
    document.getElementById('excel-file-info').textContent='';
    excelImportData=[];
    openModal('modal-excel-import');
}
function handleExcelFile(e){
    const file=e.target.files[0];if(!file)return;
    document.getElementById('excel-file-info').textContent=file.name+' ('+Math.round(file.size/1024)+' KB)';
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const wb=XLSX.read(ev.target.result,{type:'array'});
            const ws=wb.Sheets[wb.SheetNames[0]];
            const data=XLSX.utils.sheet_to_json(ws,{defval:''});
            if(data.length===0){showNotif('Dosya bos veya okunamiyor!');return;}
            excelImportData=data;
            document.getElementById('excel-row-count').textContent=data.length;
            const keys=Object.keys(data[0]);
            let thtml='<table class="w-full text-[10px]"><thead class="bg-gray-800/50"><tr>'+keys.map(k=>'<th class="p-1.5 text-left text-gray-400">'+k+'</th>').join('')+'</tr></thead><tbody class="divide-y divide-gray-800">';
            data.slice(0,8).forEach(row=>{thtml+='<tr>'+keys.map(k=>'<td class="p-1.5">'+String(row[k]||'')+'</td>').join('')+'</tr>';});
            if(data.length>8)thtml+='<tr><td colspan="'+keys.length+'" class="p-1.5 text-center text-gray-500">... ve '+(data.length-8)+' satir daha</td></tr>';
            thtml+='</tbody></table>';
            document.getElementById('excel-preview-table').innerHTML=thtml;
            document.getElementById('excel-preview').classList.remove('hidden');
        }catch(err){showNotif('Dosya okunamadi: '+err.message);}
    };
    reader.readAsArrayBuffer(file);
}
function executeExcelImport(){
    const pid=+document.getElementById('excel-import-project-id').value||+document.getElementById('excel-import-project-select').value;
    const type=document.getElementById('excel-import-type').value;
    const p=S.projects.find(x=>x.id===pid);
    if(!p&&type!=='depo-envanter'){showNotif('Proje seciniz!');return;}
    if(excelImportData.length===0){showNotif('Veri yok!');return;}
    let count=0;
    if(type==='iskalemi'){
        if(!p.isKalemleri)p.isKalemleri=[];
        excelImportData.forEach(r=>{
            const name=r['Is Kalemi']||r['Kalem Adi']||r['kalemAdi']||r['Tanim']||r['Aciklama']||'';
            if(!name)return;
            const miktar=+(r['Miktar']||r['miktar']||r['Quantity']||0);
            const bf=+(r['Birim Fiyat']||r['birimFiyat']||r['B.Fiyat']||r['Unit Price']||0);
            p.isKalemleri.push({id:Date.now()+count,pozNo:r['Poz No']||r['pozNo']||r['Poz']||'',kalemAdi:name,kategori:r['Kategori']||r['kategori']||'insaat',miktar:miktar,birim:r['Birim']||r['birim']||'m2',birimFiyat:bf,toplamTutar:miktar*bf,agirlik:+(r['Agirlik']||r['agirlik']||0),taseronId:'',gerceklesen:0,createdAt:new Date().toISOString()});
            count++;
        });
    } else if(type==='taseron'){
        if(!p.taseronlar)p.taseronlar=[];
        excelImportData.forEach(r=>{
            const firma=r['Firma']||r['firma']||r['Firma Adi']||'';
            if(!firma)return;
            p.taseronlar.push({id:Date.now()+count,firma:firma,isPaketi:r['Is Paketi']||r['isPaketi']||'Kaba Insaat',yetkili:r['Yetkili']||r['yetkili']||'',telefon:r['Telefon']||r['telefon']||'',tutar:+(r['Tutar']||r['tutar']||r['Sozlesme']||0),baslangic:r['Baslangic']||r['baslangic']||'',kapsam:r['Kapsam']||r['kapsam']||'',durum:'aktif',odemeler:[],createdAt:new Date().toISOString()});
            count++;
        });
    } else if(type==='tedarikci'){
        if(!p.tedarikciler)p.tedarikciler=[];
        excelImportData.forEach(r=>{
            const firma=r['Firma']||r['firma']||r['Firma Adi']||'';
            if(!firma)return;
            p.tedarikciler.push({id:Date.now()+count,firma:firma,malzeme:r['Malzeme']||r['malzeme']||'',yetkili:r['Yetkili']||r['yetkili']||'',telefon:r['Telefon']||r['telefon']||'',tutar:+(r['Tutar']||r['tutar']||0),puan:+(r['Puan']||r['puan']||3),createdAt:new Date().toISOString()});
            count++;
        });
    } else if(type==='depo-envanter'){
        excelImportData.forEach(r=>{
            const ad=r['Ad']||r['Malzeme']||r['ad']||r['Urun']||r['Tanim']||'';
            if(!ad)return;
            const depoAd=r['Depo']||r['depo']||'';
            const depo=S.depolar.find(d=>d.ad.toLowerCase().includes(depoAd.toLowerCase()));
            const miktar=+(r['Miktar']||r['miktar']||r['Stok']||0);
            const bf=+(r['Birim Fiyat']||r['birimFiyat']||r['B.Fiyat']||r['Fiyat']||0);
            S.envanter.push({id:Date.now()+count,ad:ad,kategori:r['Kategori']||r['kategori']||'insaat',depoId:depo?depo.id:S.depolar[0]?.id||0,barkod:r['Barkod']||r['barkod']||r['Kod']||'',birim:r['Birim']||r['birim']||'adet',miktar:miktar,minStok:+(r['Min Stok']||r['minStok']||0),birimFiyat:bf,tedarikci:r['Tedarikci']||r['tedarikci']||r['Firma']||'',notlar:r['Not']||r['notlar']||'',resim:null,ekleyen:S.users[0]?.name||'Sistem',eklenmeTarihi:new Date().toISOString(),sonGuncelleyen:null,guncellemeTarihi:null});
            count++;
        });
        act('Depo - '+count+' envanter kalemi iceri aktarildi');save();renderAll();closeModal('modal-excel-import');showNotif(count+' envanter kalemi basariyla iceri aktarildi!');return;
    }
    act(p.name+' - '+count+' kayit iceri aktarildi ('+type+')');save();renderAll();closeModal('modal-excel-import');showNotif(count+' kayit basariyla iceri aktarildi!');
}
function downloadImportTemplate(){
    const type=document.getElementById('excel-import-type').value;
    let headers,filename;
    if(type==='iskalemi'){headers=['Poz No','Is Kalemi','Kategori','Miktar','Birim','Birim Fiyat','Agirlik'];filename='is_kalemleri_sablon.csv';}
    else if(type==='taseron'){headers=['Firma','Is Paketi','Yetkili','Telefon','Tutar','Baslangic','Kapsam'];filename='taseron_sablon.csv';}
    else if(type==='depo-envanter'){headers=['Ad','Kategori','Depo','Barkod','Birim','Miktar','Min Stok','Birim Fiyat','Tedarikci','Not'];filename='envanter_sablon.csv';}
    else{headers=['Firma','Malzeme','Yetkili','Telefon','Tutar','Puan'];filename='tedarikci_sablon.csv';}
    const csv=headers.join(',')+'\n';
    const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);showNotif('Sablon indirildi: '+filename);
}

// ===================== PROFESSIONAL HAKEDIS CRUD =====================
let hakedisKalemData=[];
function openHakedisForm(projectId){
    const pid=projectId;
    document.getElementById('hakedis-project-id').value=pid;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    const hkNo=(p.hakedisler||[]).length+1;
    document.getElementById('hakedis-no').value='HK-'+String(hkNo).padStart(3,'0');
    // Populate tip select
    const tipSel=document.getElementById('hakedis-tip');
    tipSel.innerHTML=HAKEDIS_TYPES.map(t=>`<option value="${t.v}">${t.l}</option>`).join('');
    // Populate taseron select
    const tSel=document.getElementById('hakedis-taseron-select');
    tSel.innerHTML='<option value="">Seciniz...</option>';
    (p.taseronlar||[]).forEach(t=>tSel.innerHTML+=`<option value="${t.id}">${t.firma}</option>`);
    document.getElementById('hakedis-taseron-row').classList.add('hidden');
    // Populate onay selects
    const cUser=S.users.find(u=>u.id===S.currentUser)||{name:'Sistem'};
    document.getElementById('hk-hazirlayan').value=cUser.name;
    const kSel=document.getElementById('hk-kontrol');
    const oSel=document.getElementById('hk-onaylayan');
    kSel.innerHTML='<option value="">Seciniz...</option>'+S.users.map(u=>`<option>${u.name}</option>`).join('');
    oSel.innerHTML='<option value="">Seciniz...</option>'+S.users.map(u=>`<option>${u.name}</option>`).join('');
    // Populate kesintiler
    let kesHtml='';
    KESINTI_DEFAULTS.forEach(kd=>{
        kesHtml+=`<div class="flex items-center justify-between p-1.5 rounded bg-gray-800/30 mb-1"><div class="flex items-center gap-2"><input type="checkbox" id="hk-kes-${kd.k}" ${kd.aktif?'checked':''} onchange="calcHakedis()" class="rounded"><label for="hk-kes-${kd.k}" class="text-[10px] text-gray-400">${kd.l}</label></div><div class="flex items-center gap-1"><input type="number" id="hk-kes-oran-${kd.k}" value="${kd.oran}" step="0.1" class="w-12 bg-gray-800 border border-gray-700 rounded px-1 py-0.5 text-[10px] text-center" onchange="calcHakedis()"><span class="text-[10px] text-gray-500">%</span><span class="text-[10px] font-bold text-red-400 w-16 text-right" id="hk-kes-tutar-${kd.k}">\u20BA0</span></div></div>`;
    });
    document.getElementById('hk-kesintiler').innerHTML=kesHtml;
    // Render is kalemleri icmal tablosu
    renderHakedisKalemler(p,null);
    calcHakedis();
    openModal('modal-hakedis');
}
function onHakedisTipChange(){
    const tip=document.getElementById('hakedis-tip').value;
    document.getElementById('hakedis-taseron-row').classList.toggle('hidden',tip!=='taseron');
    if(tip!=='taseron'){
        const pid=+document.getElementById('hakedis-project-id').value;
        const p=S.projects.find(x=>x.id===pid);if(p)renderHakedisKalemler(p,null);
    }
}
function onHakedisTaseronChange(){
    const pid=+document.getElementById('hakedis-project-id').value;
    const tid=+document.getElementById('hakedis-taseron-select').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    renderHakedisKalemler(p,tid||null);
    calcHakedis();
}
function renderHakedisKalemler(p,taseronId){
    const kc=document.getElementById('hakedis-kalemler');
    let items=(p.isKalemleri||[]);
    if(taseronId)items=items.filter(k=>+k.taseronId===taseronId);
    if(items.length===0){kc.innerHTML='<p class="text-xs text-red-400">'+(!taseronId?'Bu projede is kalemi yok. Once is kalemi ekleyin.':'Bu taserona atanmis is kalemi yok.')+'</p>';return;}
    let html='<table class="w-full text-[10px]"><thead class="bg-gray-800/50 sticky top-0"><tr class="text-left text-gray-400"><th class="p-1.5">Poz No</th><th class="p-1.5">Is Kalemi</th><th class="p-1.5">Birim</th><th class="p-1.5">Sozlesme Miktar</th><th class="p-1.5">B.Fiyat</th><th class="p-1.5">Sozlesme Tutar</th><th class="p-1.5 text-orange-400">Onceki Toplam</th><th class="p-1.5 text-green-400">Bu Donem</th><th class="p-1.5 text-blue-400">Kumulatif</th><th class="p-1.5">Bu Donem Tutar</th><th class="p-1.5">Kalan</th><th class="p-1.5">%</th></tr></thead><tbody class="divide-y divide-gray-800">';
    items.forEach(k=>{
        const onceki=(p.hakedisler||[]).filter(h=>h.durum!=='reddedildi').reduce((s,h)=>{const kl=(h.kalemler||[]).find(x=>x.kalemId===k.id);return s+(kl?kl.buDonemMiktar:0);},0);
        const kalan=Math.max(0,k.miktar-onceki);
        html+=`<tr>
            <td class="p-1.5 font-mono text-purple-400">${k.pozNo||'-'}</td>
            <td class="p-1.5 font-medium">${k.kalemAdi}</td>
            <td class="p-1.5">${k.birim}</td>
            <td class="p-1.5">${k.miktar.toLocaleString('tr-TR')}</td>
            <td class="p-1.5">\u20BA${k.birimFiyat.toLocaleString('tr-TR')}</td>
            <td class="p-1.5 font-bold">\u20BA${fmt(k.toplamTutar)}</td>
            <td class="p-1.5 text-orange-400">${onceki.toFixed(1)}</td>
            <td class="p-1.5"><input type="number" id="hk-kalem-${k.id}" data-kalem-id="${k.id}" data-birim-fiyat="${k.birimFiyat}" data-poz="${k.pozNo||''}" data-adi="${k.kalemAdi}" data-birim="${k.birim}" data-sozlesme="${k.miktar}" data-onceki="${onceki}" min="0" max="${kalan}" step="0.01" value="0" class="w-20 bg-gray-800 border border-gray-700 rounded px-1.5 py-0.5 text-center" onchange="calcHakedis()"></td>
            <td class="p-1.5 text-blue-400 font-bold hk-kumulatif" data-kalem="${k.id}">${onceki.toFixed(1)}</td>
            <td class="p-1.5 font-bold hk-donem-tutar" data-kalem="${k.id}">\u20BA0</td>
            <td class="p-1.5 text-gray-500">${kalan.toFixed(1)}</td>
            <td class="p-1.5 hk-yuzde" data-kalem="${k.id}">%${k.miktar>0?Math.round(onceki/k.miktar*100):0}</td>
        </tr>`;
    });
    html+='</tbody></table>';
    kc.innerHTML=html;
}
function calcHakedis(){
    let isKalemleriToplam=0;
    document.querySelectorAll('[id^="hk-kalem-"]').forEach(inp=>{
        const miktar=+inp.value||0;
        const bf=+inp.dataset.birimFiyat||0;
        const onceki=+inp.dataset.onceki||0;
        const sozlesme=+inp.dataset.sozlesme||0;
        const tutar=miktar*bf;
        isKalemleriToplam+=tutar;
        const kid=inp.dataset.kalemId;
        const kumEl=document.querySelector('.hk-kumulatif[data-kalem="'+kid+'"]');
        if(kumEl)kumEl.textContent=(onceki+miktar).toFixed(1);
        const dtEl=document.querySelector('.hk-donem-tutar[data-kalem="'+kid+'"]');
        if(dtEl)dtEl.textContent='\u20BA'+fmt(tutar);
        const yzEl=document.querySelector('.hk-yuzde[data-kalem="'+kid+'"]');
        if(yzEl&&sozlesme>0)yzEl.textContent='%'+Math.round((onceki+miktar)/sozlesme*100);
    });
    const ffOran=+(document.getElementById('hk-fiyat-farki-oran')||{value:0}).value||0;
    const fiyatFarki=isKalemleriToplam*(ffOran/100);
    const araToplam=isKalemleriToplam+fiyatFarki;
    const kdv=araToplam*0.20;
    const genelToplam=araToplam+kdv;
    // Kesintiler
    let toplamKesinti=0;
    KESINTI_DEFAULTS.forEach(kd=>{
        const chk=document.getElementById('hk-kes-'+kd.k);
        const oranEl=document.getElementById('hk-kes-oran-'+kd.k);
        const tutarEl=document.getElementById('hk-kes-tutar-'+kd.k);
        if(chk&&chk.checked&&oranEl){
            const oran=+oranEl.value||0;
            const tutar=genelToplam*(oran/100);
            toplamKesinti+=tutar;
            if(tutarEl)tutarEl.textContent='\u20BA'+fmt(tutar);
        } else if(tutarEl){tutarEl.textContent='\u20BA0';}
    });
    const netOdeme=genelToplam-toplamKesinti;
    document.getElementById('hk-toplam').textContent='\u20BA'+fmt(isKalemleriToplam);
    document.getElementById('hk-fiyat-farki').textContent=(ffOran>=0?'+':'')+'\u20BA'+fmt(fiyatFarki);
    document.getElementById('hk-ara-toplam').textContent='\u20BA'+fmt(araToplam);
    document.getElementById('hk-kdv').textContent='\u20BA'+fmt(kdv);
    document.getElementById('hk-genel-toplam').textContent='\u20BA'+fmt(genelToplam);
    document.getElementById('hk-toplam-kesinti').textContent='\u20BA'+fmt(toplamKesinti);
    document.getElementById('hk-net').textContent='\u20BA'+fmt(netOdeme);
}
function addHakedis(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('hakedis-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.hakedisler)p.hakedisler=[];
    const kalemler=[];let isKalemleriToplam=0;
    document.querySelectorAll('[id^="hk-kalem-"]').forEach(inp=>{
        const miktar=+inp.value||0;if(miktar<=0)return;
        const kalemId=+inp.dataset.kalemId;const bf=+inp.dataset.birimFiyat||0;
        const onceki=+inp.dataset.onceki||0;const sozlesme=+inp.dataset.sozlesme||0;
        const tutar=miktar*bf;
        kalemler.push({kalemId,pozNo:inp.dataset.poz||'',kalemAdi:inp.dataset.adi||'',birim:inp.dataset.birim||'',sozlesmeMiktar:sozlesme,birimFiyat:bf,sozlesmeTutar:sozlesme*bf,oncekiToplam:onceki,buDonemMiktar:miktar,toplamImalat:onceki+miktar,buDonemTutar:tutar,toplamHakedisTutar:(onceki+miktar)*bf,kalanMiktar:sozlesme-(onceki+miktar),imalatYuzdesi:sozlesme>0?Math.round((onceki+miktar)/sozlesme*100):0});
        isKalemleriToplam+=tutar;
        const ik=p.isKalemleri.find(k=>k.id===kalemId);
        if(ik)ik.gerceklesen=Math.min(ik.miktar,(ik.gerceklesen||0)+miktar);
    });
    if(kalemler.length===0){showNotif('En az bir kalem icin miktar giriniz!');return;}
    const ffOran=+(document.getElementById('hk-fiyat-farki-oran')||{value:0}).value||0;
    const fiyatFarki=isKalemleriToplam*(ffOran/100);
    const araToplam=isKalemleriToplam+fiyatFarki;
    const kdv=araToplam*0.20;const genelToplam=araToplam+kdv;
    const kesintiler={};let toplamKesinti=0;
    KESINTI_DEFAULTS.forEach(kd=>{
        const chk=document.getElementById('hk-kes-'+kd.k);
        const oranEl=document.getElementById('hk-kes-oran-'+kd.k);
        if(chk&&chk.checked){const oran=+oranEl.value||0;const tutar=genelToplam*(oran/100);kesintiler[kd.k]={oran,tutar};toplamKesinti+=tutar;}
    });
    const net=genelToplam-toplamKesinti;
    const tip=document.getElementById('hakedis-tip').value||'ara';
    const taseronId=tip==='taseron'?+document.getElementById('hakedis-taseron-select').value:null;
    p.hakedisler.push({id:Date.now(),no:f.get('hakedisNo'),tip,taseronId,donem:f.get('donem'),tarih:f.get('tarih')||new Date().toISOString().slice(0,10),kalemler,isKalemleriToplam,fiyatFarkiOran:ffOran,fiyatFarkiTutar:fiyatFarki,araToplam,kdvOran:20,kdv,genelToplam,kesintiler,toplamKesinti,net,durum:'taslak',hazirlayan:document.getElementById('hk-hazirlayan').value,kontrolEden:f.get('kontrolEden')||'',onaylayan:f.get('onaylayan')||'',aciklama:f.get('aciklama')||'',createdAt:new Date().toISOString()});
    recalcProjectCompletion(pid);
    act(p.name+' - Hakedis olusturuldu: '+f.get('hakedisNo'));save();renderAll();closeModal('modal-hakedis');e.target.reset();showNotif('Hakedis olusturuldu!');
}
const DURUM_LABELS={taslak:'Taslak',kontrol:'Kontrole Gonderildi',onaylandi:'Onaylandi',odendi:'Odendi',reddedildi:'Reddedildi',revize:'Revizeye Gonderildi',beklemede:'Beklemede'};
const DURUM_COLORS={kontrol:'bg-blue-600',onaylandi:'bg-green-600',odendi:'bg-cyan-600',reddedildi:'bg-red-600',revize:'bg-orange-600'};
function changeHakedisDurum(projectId,hakedisId,yeniDurum,refreshDetail){
    document.getElementById('hd-project-id').value=projectId;
    document.getElementById('hd-hakedis-id').value=hakedisId;
    document.getElementById('hd-yeni-durum').value=yeniDurum;
    document.getElementById('hd-refresh-detail').value=refreshDetail?projectId:'';
    document.getElementById('hd-sebep').value='';
    document.getElementById('hd-revize-notu').value='';
    const p=S.projects.find(x=>x.id===projectId);
    const h=p?(p.hakedisler||[]).find(x=>x.id===hakedisId):null;
    const durumLabel=DURUM_LABELS[yeniDurum]||yeniDurum;
    const infoDiv=document.getElementById('hd-durum-info');
    infoDiv.innerHTML=`<div class="flex items-center justify-between"><span class="text-gray-400">${h?h.no:''}</span><span class="px-2 py-0.5 rounded text-[10px] font-bold ${DURUM_COLORS[yeniDurum]||'bg-gray-600'} text-white">${durumLabel}</span></div><p class="text-xs text-gray-500 mt-1">${h?(h.durum||'taslak').toUpperCase():''} ‚Üí ${yeniDurum.toUpperCase()}</p>`;
    document.getElementById('hakedis-durum-title').textContent=durumLabel;
    const btn=document.getElementById('hd-confirm-btn');
    btn.textContent=durumLabel;
    btn.className='flex-1 py-2.5 rounded-lg font-medium text-sm transition-colors text-white '+(DURUM_COLORS[yeniDurum]||'bg-gray-600')+' hover:opacity-90';
    document.getElementById('hd-revize-notu-row').style.display=yeniDurum==='revize'?'block':'none';
    document.getElementById('hd-sebep').placeholder=yeniDurum==='onaylandi'?'Onay aciklamasi...':yeniDurum==='reddedildi'?'Red sebebi...':yeniDurum==='revize'?'Revize sebebi...':yeniDurum==='odendi'?'Odeme aciklamasi...':'Aciklama...';
    openModal('modal-hakedis-durum');
}
function confirmDurumDegisikligi(){
    const projectId=Number(document.getElementById('hd-project-id').value);
    const hakedisId=Number(document.getElementById('hd-hakedis-id').value);
    const yeniDurum=document.getElementById('hd-yeni-durum').value;
    const sebep=document.getElementById('hd-sebep').value.trim();
    const revizeNotu=document.getElementById('hd-revize-notu').value.trim();
    const refreshDetail=document.getElementById('hd-refresh-detail').value;
    if(!sebep){showNotif('Lutfen aciklama/sebep yaziniz!');return;}
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.hakedisler)return;
    const h=p.hakedisler.find(x=>x.id===hakedisId);if(!h)return;
    const eskiDurum=h.durum;
    h.durum=yeniDurum;
    if(!h.durumGecmisi)h.durumGecmisi=[];
    h.durumGecmisi.push({eskiDurum,yeniDurum,sebep,revizeNotu:revizeNotu||'',tarih:new Date().toISOString(),kullanici:'Sistem'});
    if(yeniDurum==='onaylandi'&&eskiDurum!=='onaylandi'){p.spent=(p.spent||0)+(h.net||0);h.onaylayan=h.onaylayan||'Sistem';}
    if(yeniDurum==='odendi'&&eskiDurum!=='odendi')h.odenmeTarihi=new Date().toISOString().slice(0,10);
    if(yeniDurum==='reddedildi'&&eskiDurum==='onaylandi')p.spent=Math.max(0,(p.spent||0)-(h.net||0));
    if(yeniDurum==='revize'){h.revizeNotu=revizeNotu;h.revizeSayisi=(h.revizeSayisi||0)+1;}
    act(p.name+' - '+h.no+' '+(DURUM_LABELS[yeniDurum]||yeniDurum)+': '+sebep);
    save();renderAll();closeModal('modal-hakedis-durum');
    showNotif(h.no+' - '+(DURUM_LABELS[yeniDurum]||yeniDurum));
    if(refreshDetail)openProjectDetail(Number(refreshDetail));
}
function approveHakedis(pid,hid){changeHakedisDurum(pid,hid,'onaylandi');}
function rejectHakedis(pid,hid){changeHakedisDurum(pid,hid,'reddedildi');}

function renderHakedisTab(){
    const c=document.getElementById('hakedis-table');
    const allH=[];
    S.projects.forEach(p=>{(p.hakedisler||[]).forEach(h=>{allH.push({...h,projectName:p.name,projectId:p.id});});});
    if(allH.length===0){
        if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm p-6">Proje ekleyin.</p>';return;}
        c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz hakedis olusturulmadi.</p><div class="flex gap-2 justify-center mt-3">'+S.projects.map(p=>`<button onclick="openHakedisForm(${p.id})" class="px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
        return;
    }
    const totalNet=allH.reduce((s,h)=>s+(h.net||0),0);
    const durumCounts={taslak:0,kontrol:0,onaylandi:0,odendi:0,reddedildi:0,beklemede:0,revize:0};
    allH.forEach(h=>durumCounts[h.durum]=(durumCounts[h.durum]||0)+1);
    let html=`<div class="grid grid-cols-6 gap-3 mb-4">
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Toplam</p><p class="text-lg font-bold text-blue-400">${allH.length}</p></div>
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Taslak/Kontrol</p><p class="text-lg font-bold text-orange-400">${durumCounts.taslak+durumCounts.kontrol+durumCounts.beklemede}</p></div>
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Revize</p><p class="text-lg font-bold text-amber-400">${durumCounts.revize}</p></div>
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Onaylanan</p><p class="text-lg font-bold text-green-400">${durumCounts.onaylandi}</p></div>
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Odenen</p><p class="text-lg font-bold text-cyan-400">${durumCounts.odendi}</p></div>
        <div class="glass rounded-lg p-3 text-center"><p class="text-[10px] text-gray-500">Toplam Net</p><p class="text-lg font-bold text-purple-400">\u20BA${fmt(totalNet)}</p></div>
    </div>`;
    html+='<div class="space-y-3">'+allH.map(h=>{
        const durumMap={taslak:{c:'bg-gray-500/20 text-gray-400',l:'Taslak'},beklemede:{c:'bg-orange-500/20 text-orange-400',l:'Beklemede'},kontrol:{c:'bg-blue-500/20 text-blue-400',l:'Kontrol'},revize:{c:'bg-amber-500/20 text-amber-400',l:'Revize'},onaylandi:{c:'bg-green-500/20 text-green-400',l:'Onaylandi'},odendi:{c:'bg-cyan-500/20 text-cyan-400',l:'Odendi'},reddedildi:{c:'bg-red-500/20 text-red-400',l:'Reddedildi'}};
        const dm=durumMap[h.durum]||durumMap.taslak;
        const tipLabel=(HAKEDIS_TYPES.find(t=>t.v===h.tip)||{l:'Ara'}).l;
        const taseronName=h.taseronId?((S.projects.find(x=>x.id===h.projectId)||{}).taseronlar||[]).find(t=>t.id===h.taseronId):'';
        const kesStr=h.kesintiler?Object.keys(h.kesintiler).map(k=>{const kd=KESINTI_DEFAULTS.find(x=>x.k===k);if(!kd)return '';const o=h.kesintiler[k].oran;return o!=null&&o>0?(kd.l+': %'+o):(h.kesintiler[k].tutar>0?(kd.l+': ‚Ç∫'+fmt(h.kesintiler[k].tutar)):'');}).filter(Boolean).join(', '):'';
        return `<div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-2">
                <div><div class="flex items-center gap-2"><h5 class="font-bold text-sm">${h.no} - ${h.projectName}</h5><span class="px-2 py-0.5 rounded text-[9px] font-semibold bg-purple-500/20 text-purple-400">${tipLabel}</span></div><p class="text-[10px] text-gray-500">Donem: ${h.donem||'-'} | Tarih: ${h.tarih||'-'} | ${(h.kalemler||[]).length} kalem${taseronName?' | Taseron: '+taseronName.firma:''}</p></div>
                <span class="px-2 py-0.5 rounded text-[9px] font-semibold ${dm.c}">${dm.l}</span>
            </div>
            <div class="grid grid-cols-6 gap-2 text-xs mb-2">
                <div><p class="text-[10px] text-gray-500">Is Kalemleri</p><p class="font-bold text-blue-400">\u20BA${fmt(h.isKalemleriToplam||h.toplam||0)}</p></div>
                <div><p class="text-[10px] text-gray-500">Fiyat Farki</p><p class="font-bold text-yellow-400">${h.fiyatFarkiOran?'%'+h.fiyatFarkiOran:'-'}</p></div>
                <div><p class="text-[10px] text-gray-500">KDV</p><p class="font-bold text-purple-400">\u20BA${fmt(h.kdv||0)}</p></div>
                <div><p class="text-[10px] text-gray-500">Genel Toplam</p><p class="font-bold text-indigo-400">\u20BA${fmt(h.genelToplam||h.toplam||0)}</p></div>
                <div><p class="text-[10px] text-gray-500">Kesintiler</p><p class="font-bold text-red-400">\u20BA${fmt(h.toplamKesinti||h.stopaj||0)}</p></div>
                <div><p class="text-[10px] text-gray-500">Net Odeme</p><p class="font-bold text-green-400">\u20BA${fmt(h.net||0)}</p></div>
            </div>
            ${kesStr?'<p class="text-[9px] text-gray-500 mb-1">Kesintiler: '+kesStr+'</p>':''}
            ${h.hazirlayan?'<p class="text-[9px] text-gray-500">Hazirlayan: '+h.hazirlayan+(h.kontrolEden?' | Kontrol: '+h.kontrolEden:'')+(h.onaylayan?' | Onay: '+h.onaylayan:'')+'</p>':''}
            ${h.aciklama?'<p class="text-[10px] text-gray-500 mt-1">'+h.aciklama+'</p>':''}
            ${h.revizeNotu?'<p class="text-[10px] text-amber-400 mt-1">üìù Revize Notu: '+h.revizeNotu+'</p>':''}
            ${(h.durumGecmisi||[]).length>0?'<details class="mt-1"><summary class="text-[9px] text-gray-600 cursor-pointer hover:text-gray-400">Durum Gecmisi ('+h.durumGecmisi.length+')</summary><div class="mt-1 space-y-1">'+h.durumGecmisi.map(dg=>`<div class="text-[9px] text-gray-600 flex gap-2"><span class="text-gray-700">${dg.tarih?dg.tarih.slice(0,16).replace('T',' '):''}</span><span>${(DURUM_LABELS[dg.eskiDurum]||dg.eskiDurum)} ‚Üí <b>${(DURUM_LABELS[dg.yeniDurum]||dg.yeniDurum)}</b></span><span class="text-gray-500 italic">${dg.sebep}</span></div>`).join('')+'</div></details>':''}
            <div class="flex gap-2 mt-2 flex-wrap">
                ${h.durum==='taslak'||h.durum==='revize'?`<button onclick="changeHakedisDurum(${h.projectId},${h.id},'kontrol')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">Kontrole Gonder</button><button onclick="changeHakedisDurum(${h.projectId},${h.id},'reddedildi')" class="px-3 py-1 bg-red-600/50 hover:bg-red-600 rounded text-xs">Iptal</button>`:''}
                ${h.durum==='kontrol'||h.durum==='beklemede'?`<button onclick="changeHakedisDurum(${h.projectId},${h.id},'onaylandi')" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">Onayla</button><button onclick="changeHakedisDurum(${h.projectId},${h.id},'revize')" class="px-3 py-1 bg-amber-600 hover:bg-amber-700 rounded text-xs">Revizeye Gonder</button><button onclick="changeHakedisDurum(${h.projectId},${h.id},'reddedildi')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">Reddet</button>`:''}
                ${h.durum==='onaylandi'?`<button onclick="changeHakedisDurum(${h.projectId},${h.id},'odendi')" class="px-3 py-1 bg-cyan-600 hover:bg-cyan-700 rounded text-xs">Odendi Isaretle</button>`:''}
                <button onclick="printHakedisReport(${h.projectId},${h.id})" class="px-3 py-1 bg-gray-600/50 hover:bg-gray-600 rounded text-xs">üìÑ Rapor</button>
            </div>
        </div>`;
    }).join('')+'</div>';
    html+='<div class="flex gap-2 mt-4 flex-wrap">'+S.projects.map(p=>`<button onclick="openHakedisForm(${p.id})" class="px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">+ Hakedis: ${p.name}</button>`).join('')+'</div>';
    c.innerHTML=html;
}

function printHakedisReport(projectId,hakedisId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    const h=(p.hakedisler||[]).find(x=>x.id===hakedisId);if(!h)return;
    const tipLabel=(HAKEDIS_TYPES.find(t=>t.v===h.tip)||{l:'Ara Hakedis'}).l;
    const durumLabels={taslak:'Taslak',kontrol:'Kontrol Bekliyor',revize:'Revize Bekleniyor',onaylandi:'Onaylandi',odendi:'Odendi',reddedildi:'Reddedildi',beklemede:'Beklemede'};
    let kRows=(h.kalemler||[]).map((k,i)=>`<tr><td>${i+1}</td><td>${k.pozNo||'-'}</td><td>${k.kalemAdi||'-'}</td><td>${k.birim||'-'}</td><td>${(k.sozlesmeMiktar||0).toLocaleString('tr-TR')}</td><td>${(k.birimFiyat||0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</td><td>${((k.sozlesmeMiktar||0)*(k.birimFiyat||0)).toLocaleString('tr-TR',{minimumFractionDigits:2})}</td><td>${(k.oncekiToplam||0).toFixed(1)}</td><td style="font-weight:bold;color:#16a34a">${(k.buDonemMiktar||0).toFixed(1)}</td><td>${(k.toplamImalat||0).toFixed(1)}</td><td>${(k.buDonemTutar||0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</td><td>${((k.toplamImalat||0)*(k.birimFiyat||0)).toLocaleString('tr-TR',{minimumFractionDigits:2})}</td><td>${k.imalatYuzdesi||0}%</td></tr>`).join('');
    let kesRows='';
    if(h.kesintiler){Object.keys(h.kesintiler).forEach(k=>{const kd=KESINTI_DEFAULTS.find(x=>x.k===k);if(kd&&(h.kesintiler[k].tutar||0)>0){const oranStr=h.kesintiler[k].oran?(' (%'+h.kesintiler[k].oran+')'):'';kesRows+=`<tr><td>${kd.l}${oranStr}</td><td style="text-align:right;color:red">-${h.kesintiler[k].tutar.toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr>`;}});}
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Hakedis Raporu - ${h.no}</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:20px;color:#333}h1{font-size:16px;text-align:center;margin-bottom:5px}h2{font-size:13px;margin-top:15px;border-bottom:1px solid #ccc;padding-bottom:3px}table{width:100%;border-collapse:collapse;margin:8px 0}th,td{border:1px solid #ddd;padding:4px 6px;text-align:left;font-size:10px}th{background:#f5f5f5;font-weight:bold}.right{text-align:right}.bold{font-weight:bold}.green{color:#16a34a}.sum-row{background:#f0f9ff;font-weight:bold}.net-row{background:#ecfdf5;font-weight:bold;font-size:13px}.header-info{display:flex;justify-content:space-between;margin-bottom:15px}.header-info div{flex:1}.sign-area{display:flex;justify-content:space-between;margin-top:40px}.sign-box{width:30%;text-align:center;border-top:1px solid #333;padding-top:5px}@media print{body{padding:10px}}</style></head><body>
    <h1>HAKEDIS RAPORU</h1><p style="text-align:center;color:#666">${tipLabel} | ${durumLabels[h.durum]||h.durum}</p>
    <div class="header-info"><div><b>Proje:</b> ${p.name}<br><b>Muteahhit:</b> ${p.contractor}<br><b>Sozlesme Bedeli:</b> ${(p.contractAmount||p.budget).toLocaleString('tr-TR')} TL</div><div style="text-align:right"><b>Hakedis No:</b> ${h.no}<br><b>Donem:</b> ${h.donem||'-'}<br><b>Tarih:</b> ${h.tarih||'-'}</div></div>
    <h2>IS KALEMLERI ICMALI</h2>
    <table><thead><tr><th>S.No</th><th>Poz No</th><th>Is Kalemi</th><th>Birim</th><th>Sozlesme Miktar</th><th>B.Fiyat (TL)</th><th>Sozlesme Tutar (TL)</th><th>Onceki Toplam</th><th>Bu Donem</th><th>Kumulatif</th><th>Bu Donem Tutar (TL)</th><th>Toplam HK Tutar (TL)</th><th>%</th></tr></thead><tbody>${kRows}</tbody></table>
    <h2>HESAP OZETI</h2>
    <table style="width:50%"><tr><td>Is Kalemleri Toplami</td><td class="right">${(h.isKalemleriToplam||h.toplam||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr>${h.fiyatFarkiOran?`<tr><td>Fiyat Farki (%${h.fiyatFarkiOran})</td><td class="right">${(h.fiyatFarkiTutar||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr>`:''}<tr class="sum-row"><td>Ara Toplam</td><td class="right">${(h.araToplam||h.toplam||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr><tr><td>KDV (%${h.kdvOran||20})</td><td class="right">${(h.kdv||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr><tr class="sum-row"><td>Genel Toplam</td><td class="right">${(h.genelToplam||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr>${kesRows}<tr style="background:#fef2f2"><td class="bold">Toplam Kesinti</td><td class="right bold" style="color:red">-${(h.toplamKesinti||h.stopaj||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr><tr class="net-row"><td>NET ODEME</td><td class="right green">${(h.net||0).toLocaleString('tr-TR',{minimumFractionDigits:2})} TL</td></tr></table>
    <div class="sign-area"><div class="sign-box"><b>Hazirlayan</b><br>${h.hazirlayan||'-'}</div><div class="sign-box"><b>Kontrol Eden</b><br>${h.kontrolEden||'-'}</div><div class="sign-box"><b>Onaylayan</b><br>${h.onaylayan||'-'}</div></div>
    <script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
    w.document.close();
}

// ===================== SANTIYE GUNLUGU CRUD =====================
function openGunlukForm(projectId){
    document.getElementById('gunluk-project-id').value=projectId;
    const hSel=document.getElementById('gunluk-hava');
    hSel.innerHTML=WEATHER_OPTS.map(w=>`<option value="${w.v}">${w.l}</option>`).join('');
    openModal('modal-gunluk');
}
function addGunluk(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('gunluk-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.santiyeGunlugu)p.santiyeGunlugu=[];
    p.santiyeGunlugu.push({id:Date.now(),tarih:f.get('tarih'),hava:f.get('hava'),isciSayisi:+f.get('isciSayisi')||0,teknisyen:+f.get('teknisyen')||0,muhendis:+f.get('muhendis')||0,yapilanIsler:f.get('yapilanIsler'),sorunlar:f.get('sorunlar')||'',createdAt:new Date().toISOString()});
    act(p.name+' - Santiye gunlugu eklendi: '+f.get('tarih'));save();renderAll();closeModal('modal-gunluk');e.target.reset();showNotif('Gunluk kaydi eklendi!');
}
function removeGunluk(projectId,gunlukId){
    if(!confirm('Bu kaydi silmek istediginize emin misiniz?'))return;
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.santiyeGunlugu)return;
    p.santiyeGunlugu=p.santiyeGunlugu.filter(g=>g.id!==gunlukId);
    act('Santiye gunlugu silindi');save();renderAll();showNotif('Kayit silindi.');
}
function renderGunlukTab(){
    const c=document.getElementById('gunluk-view');
    const allG=[];
    S.projects.forEach(p=>{(p.santiyeGunlugu||[]).forEach(g=>{allG.push({...g,projectName:p.name,projectId:p.id});});});
    if(allG.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz santiye gunlugu kaydi yok.</p><div class="flex gap-2 justify-center mt-3">'+S.projects.map(p=>`<button onclick="openGunlukForm(${p.id})" class="px-3 py-1.5 bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';return;}
    allG.sort((a,b)=>b.tarih.localeCompare(a.tarih));
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Santiye Gunlugu ('+allG.length+' kayit)</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openGunlukForm(${p.id})" class="px-3 py-1.5 bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    html+='<div class="space-y-3">'+allG.map(g=>{
        const hava=(WEATHER_OPTS.find(w=>w.v===g.hava)||{l:'?'}).l;
        const toplamIsci=g.isciSayisi+g.teknisyen+g.muhendis;
        return `<div class="glass rounded-xl p-4">
            <div class="flex items-start justify-between mb-2">
                <div><h5 class="font-bold text-sm">${g.tarih} ${hava}</h5><p class="text-[10px] text-gray-500">${g.projectName}</p></div>
                <div class="flex items-center gap-2"><span class="text-[10px] text-gray-400">üë∑ ${toplamIsci} kisi</span><button onclick="removeGunluk(${g.projectId},${g.id})" class="text-gray-600 hover:text-red-400 text-sm">&times;</button></div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-[10px] mb-2">
                <div><span class="text-gray-500">Isci:</span> <b>${g.isciSayisi}</b></div>
                <div><span class="text-gray-500">Teknisyen:</span> <b>${g.teknisyen}</b></div>
                <div><span class="text-gray-500">Muhendis:</span> <b>${g.muhendis}</b></div>
            </div>
            <div class="p-2 rounded bg-gray-800/30 mb-2"><p class="text-[10px] text-gray-400">Yapilan Isler</p><p class="text-xs mt-1">${g.yapilanIsler}</p></div>
            ${g.sorunlar?'<div class="p-2 rounded bg-red-500/10 border border-red-500/20"><p class="text-[10px] text-red-400">Sorunlar / Gecikmeler</p><p class="text-xs mt-1">'+g.sorunlar+'</p></div>':''}
        </div>`;
    }).join('')+'</div>';
    c.innerHTML=html;
}

// ===================== ENHANCED PROJECT DETAIL (Tabbed) =====================
function openProjectDetail(id){
    const p=S.projects.find(x=>x.id===id);if(!p)return;
    document.getElementById('detail-title').textContent=p.name;
    const ptl=(PROJECT_TYPES.find(t=>t.v===p.projectType)||{l:'-'}).l;
    const ctl=(CONTRACT_TYPES.find(t=>t.v===p.contractType)||{l:'-'}).l;
    const pctColor=p.completion>=80?'green':p.completion>=50?'blue':p.completion>=25?'yellow':'red';
    const taseronlar=p.taseronlar||[];
    const tedarikciler=p.tedarikciler||[];
    const isKalemleri=p.isKalemleri||[];
    const hakedisler=p.hakedisler||[];
    const gunluk=p.santiyeGunlugu||[];
    const totalHkNet=hakedisler.reduce((s,h)=>s+(h.net||0),0);
    const totalIkTutar=isKalemleri.reduce((s,k)=>s+k.toplamTutar,0);
    let html=`
    <div class="flex gap-1 flex-wrap mb-4" id="detail-tabs">
        <button class="tab-btn active text-[10px]" onclick="switchDetailTab('genel')">Genel</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dtaseronlar')">Taseronlar (${taseronlar.length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dtedarikciler')">Tedarikciler (${tedarikciler.length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('disKalemleri')">Is Kalemleri (${isKalemleri.length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dhakedis')">Hakedis (${hakedisler.length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dgunluk')">Gunluk (${gunluk.length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dbutce')">Butce</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dsozlesme')">Sozlesme (${(p.sozlesmeler||[]).length})</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('disg')">ISG</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dkalite')">Kalite</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dnakit')">Nakit</button>
        <button class="tab-btn text-[10px]" onclick="switchDetailTab('dmalzeme')">Stok (${(p.malzemeStok||[]).length})</button>
    </div>
    <!-- GENEL TAB -->
    <div id="detail-tab-genel">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500 mb-1">Sozlesme Bedeli</p><p class="text-xl font-bold text-blue-400">\u20BA${fmtFull(p.contractAmount||p.budget)}</p></div>
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500 mb-1">Butce</p><p class="text-xl font-bold text-purple-400">\u20BA${fmtFull(p.budget)}</p></div>
        </div>
        <div class="glass rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center mb-2"><span class="text-sm">Ilerleme</span><span class="text-sm font-bold text-${pctColor}-400">%${p.completion}</span></div>
            <div class="progress-bar"><div class="progress-fill bg-${pctColor}-500" style="width:${p.completion}%"></div></div>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-4 text-xs">
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Tip</p><p class="font-semibold mt-1">${ptl}</p></div>
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Sozlesme</p><p class="font-semibold mt-1">${ctl}</p></div>
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Konum</p><p class="font-semibold mt-1">${p.location||'-'}</p></div>
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Muteahhit</p><p class="font-semibold mt-1">${p.contractor}</p></div>
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Proje Muduru</p><p class="font-semibold mt-1">${p.manager}</p></div>
            <div class="glass rounded-lg p-3"><p class="text-gray-500">Durum</p><p class="mt-1"><span class="status-${p.status}">${stName(p.status)}</span></p></div>
        </div>
        ${p.startDate||p.endDate?`<div class="glass rounded-lg p-3 mb-4 text-xs"><p class="text-gray-500">Tarih Araligi</p><p class="font-semibold mt-1">${p.startDate||'?'} ‚Üí ${p.endDate||'?'}</p></div>`:''}
        ${p.notes?`<div class="glass rounded-xl p-4 mb-4"><p class="text-xs text-gray-500 mb-1">Notlar</p><p class="text-sm">${p.notes}</p></div>`:''}
        <div class="grid grid-cols-4 gap-3 text-center text-xs">
            <div class="glass rounded-lg p-3"><p class="text-lg font-bold text-amber-400">${taseronlar.length}</p><p class="text-gray-500">Taseron</p></div>
            <div class="glass rounded-lg p-3"><p class="text-lg font-bold text-teal-400">${tedarikciler.length}</p><p class="text-gray-500">Tedarikci</p></div>
            <div class="glass rounded-lg p-3"><p class="text-lg font-bold text-indigo-400">${isKalemleri.length}</p><p class="text-gray-500">Is Kalemi</p></div>
            <div class="glass rounded-lg p-3"><p class="text-lg font-bold text-green-400">${hakedisler.length}</p><p class="text-gray-500">Hakedis</p></div>
        </div>
    </div>
    <!-- TASERONLAR TAB -->
    <div id="detail-tab-dtaseronlar" class="hidden">
        <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-semibold">Taseronlar</h4><button onclick="openTaseronForm(${p.id})" class="px-3 py-1.5 bg-amber-600/20 text-amber-400 hover:bg-amber-600/40 rounded text-xs">+ Taseron</button></div>
        ${taseronlar.length===0?'<p class="text-gray-500 text-xs">Taseron eklenmemis.</p>':taseronlar.map(t=>`<div class="glass rounded-lg p-3 mb-2"><div class="flex justify-between"><h5 class="text-sm font-bold">${t.firma}</h5><button onclick="removeTaseron(${p.id},${t.id})" class="text-gray-600 hover:text-red-400">&times;</button></div><p class="text-[10px] text-gray-500">${t.isPaketi} | Yetkili: ${t.yetkili||'-'} | Tel: ${t.telefon||'-'}</p><p class="text-xs font-bold text-amber-400 mt-1">\u20BA${fmt(t.tutar)}</p>${t.kapsam?'<p class="text-[10px] text-gray-500 mt-1">'+t.kapsam+'</p>':''}</div>`).join('')}
    </div>
    <!-- TEDARIKCILER TAB -->
    <div id="detail-tab-dtedarikciler" class="hidden">
        <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-semibold">Tedarikciler</h4><button onclick="openTedarikciForm(${p.id})" class="px-3 py-1.5 bg-teal-600/20 text-teal-400 hover:bg-teal-600/40 rounded text-xs">+ Tedarikci</button></div>
        ${tedarikciler.length===0?'<p class="text-gray-500 text-xs">Tedarikci eklenmemis.</p>':tedarikciler.map(t=>`<div class="glass rounded-lg p-3 mb-2"><div class="flex justify-between"><h5 class="text-sm font-bold">${t.firma}</h5><button onclick="removeTedarikci(${p.id},${t.id})" class="text-gray-600 hover:text-red-400">&times;</button></div><p class="text-[10px] text-gray-500">Malzeme: ${t.malzeme} | Yetkili: ${t.yetkili||'-'} | Puan: ${'‚≠ê'.repeat(t.puan||3)}</p>${t.tutar?'<p class="text-xs font-bold text-teal-400 mt-1">\u20BA'+fmt(t.tutar)+'</p>':''}</div>`).join('')}
    </div>
    <!-- IS KALEMLERI TAB -->
    <div id="detail-tab-disKalemleri" class="hidden">
        <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-semibold">Is Kalemleri</h4><div class="flex gap-2"><button onclick="openExcelImport(${p.id},'iskalemi')" class="px-3 py-1.5 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/40 rounded text-xs">üì• Excel</button><button onclick="openIsKalemiForm(${p.id})" class="px-3 py-1.5 bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/40 rounded text-xs">+ Is Kalemi</button></div></div>
        ${isKalemleri.length===0?'<p class="text-gray-500 text-xs">Is kalemi eklenmemis.</p>':`<p class="text-xs text-gray-400 mb-2">Toplam: <b class="text-blue-400">\u20BA${fmt(totalIkTutar)}</b></p>`+isKalemleri.map(k=>{const pct=k.miktar>0?Math.round((k.gerceklesen/k.miktar)*100):0;const bar=pct>=80?'bg-green-500':pct>=50?'bg-blue-500':'bg-orange-500';return `<div class="glass rounded-lg p-3 mb-2"><div class="flex justify-between"><h5 class="text-xs font-bold">${k.pozNo?'<span class="text-indigo-400 mr-1">'+k.pozNo+'</span>':''}${k.kalemAdi}</h5><span class="text-[10px] font-bold ${pct>=80?'text-green-400':'text-orange-400'}">%${pct}</span></div><p class="text-[10px] text-gray-500">${k.miktar} ${k.birim} x \u20BA${k.birimFiyat.toLocaleString('tr-TR')} = <b>\u20BA${fmt(k.toplamTutar)}</b></p><div class="progress-bar mt-1"><div class="progress-fill ${bar}" style="width:${pct}%"></div></div></div>`;}).join('')}
    </div>
    <!-- HAKEDIS TAB -->
    <div id="detail-tab-dhakedis" class="hidden">
        <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-semibold">Hakedisler</h4><button onclick="openHakedisForm(${p.id})" class="px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">+ Hakedis</button></div>
        ${hakedisler.length===0?'<p class="text-gray-500 text-xs">Hakedis eklenmemis. Once is kalemleri ekleyin.</p>':hakedisler.map(h=>{
            const durumMap={taslak:{c:'text-gray-400',l:'Taslak'},kontrol:{c:'text-yellow-400',l:'Kontrol Bekliyor'},revize:{c:'text-amber-400',l:'Revize Bekleniyor'},onaylandi:{c:'text-green-400',l:'Onaylandi'},odendi:{c:'text-blue-400',l:'Odendi'},reddedildi:{c:'text-red-400',l:'Reddedildi'},beklemede:{c:'text-orange-400',l:'Beklemede'}};
            const ds=durumMap[h.durum]||durumMap.taslak;
            const tipMap={ara:'Ara HK',kesin:'Kesin HK',taseron:'Taseron HK'};
            const tipLabel=tipMap[h.tip]||'Hakedis';
            const genelTop=h.genelToplam||((h.toplam||0)+(h.kdv||0));
            const topKes=h.toplamKesinti||h.stopaj||0;
            return `<div class="glass rounded-lg p-3 mb-2">
                <div class="flex justify-between items-start">
                    <div><h5 class="text-sm font-bold">${h.no}</h5><span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">${tipLabel}</span></div>
                    <span class="text-[10px] font-bold ${ds.c}">${ds.l}</span>
                </div>
                <p class="text-[10px] text-gray-500 mt-1">Donem: ${h.donem} | Tarih: ${h.tarih||'-'} | ${h.kalemler.length} kalem</p>
                <div class="grid grid-cols-3 gap-2 text-[10px] mt-2">
                    <div>Is Kalemleri: <b>‚Ç∫${fmt(h.isKalemleriToplam||h.toplam||0)}</b></div>
                    <div>KDV: <b>‚Ç∫${fmt(h.kdv||0)}</b></div>
                    <div>Genel Toplam: <b>‚Ç∫${fmt(genelTop)}</b></div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-[10px] mt-1">
                    <div>Kesintiler: <b class="text-red-400">‚Ç∫${fmt(topKes)}</b></div>
                    <div>Net Odeme: <b class="text-green-400">‚Ç∫${fmt(h.net||0)}</b></div>
                    <div>${h.fiyatFarkiOran?'Fiyat Farki: <b>%'+h.fiyatFarkiOran+'</b>':''}</div>
                </div>
                ${h.revizeNotu?'<p class="text-[9px] text-amber-400 mt-1">üìù Revize: '+h.revizeNotu+'</p>':''}
                <div class="flex gap-2 mt-2 flex-wrap">
                    ${h.durum==='taslak'||h.durum==='revize'?`<button onclick="changeHakedisDurum(${p.id},${h.id},'kontrol',true)" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-[10px]">Kontrole Gonder</button>`:''}
                    ${h.durum==='kontrol'||h.durum==='beklemede'?`<button onclick="changeHakedisDurum(${p.id},${h.id},'onaylandi',true)" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-[10px]">Onayla</button><button onclick="changeHakedisDurum(${p.id},${h.id},'revize',true)" class="px-2 py-1 bg-amber-600 hover:bg-amber-700 rounded text-[10px]">Revize</button><button onclick="changeHakedisDurum(${p.id},${h.id},'reddedildi',true)" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-[10px]">Reddet</button>`:''}
                    ${h.durum==='onaylandi'?`<button onclick="changeHakedisDurum(${p.id},${h.id},'odendi',true)" class="px-2 py-1 bg-cyan-600 hover:bg-cyan-700 rounded text-[10px]">Odendi Isaretle</button>`:''}
                    <button onclick="printHakedisReport(${p.id},${h.id})" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-[10px]">üñ®Ô∏è Rapor</button>
                </div>
            </div>`;}).join('')}
        <p class="text-xs text-gray-400 mt-2">Toplam Net Hakedis: <b class="text-green-400">‚Ç∫${fmt(totalHkNet)}</b></p>
    </div>
    <!-- GUNLUK TAB -->
    <div id="detail-tab-dgunluk" class="hidden">
        <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-semibold">Santiye Gunlugu</h4><button onclick="openGunlukForm(${p.id})" class="px-3 py-1.5 bg-cyan-600/20 text-cyan-400 hover:bg-cyan-600/40 rounded text-xs">+ Yeni Kayit</button></div>
        ${gunluk.length===0?'<p class="text-gray-500 text-xs">Kayit yok.</p>':gunluk.sort((a,b)=>b.tarih.localeCompare(a.tarih)).map(g=>{const hava=(WEATHER_OPTS.find(w=>w.v===g.hava)||{l:'?'}).l;return `<div class="glass rounded-lg p-3 mb-2"><div class="flex justify-between"><h5 class="text-xs font-bold">${g.tarih} ${hava}</h5><span class="text-[10px] text-gray-400">üë∑ ${g.isciSayisi+g.teknisyen+g.muhendis} kisi</span></div><p class="text-[10px] mt-1">${g.yapilanIsler}</p>${g.sorunlar?'<p class="text-[10px] text-red-400 mt-1">‚ö†Ô∏è '+g.sorunlar+'</p>':''}</div>`;}).join('')}
    </div>
    <!-- BUTCE TAB -->
    <div id="detail-tab-dbutce" class="hidden">
        <h4 class="text-sm font-semibold mb-3">Butce Analizi</h4>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500">Sozlesme</p><p class="text-xl font-bold text-blue-400">\u20BA${fmtFull(p.contractAmount||p.budget)}</p></div>
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500">Butce</p><p class="text-xl font-bold text-purple-400">\u20BA${fmtFull(p.budget)}</p></div>
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500">Harcanan (Onayli Hakedis)</p><p class="text-xl font-bold text-orange-400">\u20BA${fmtFull(p.spent||0)}</p></div>
            <div class="glass rounded-xl p-4"><p class="text-[10px] text-gray-500">Kalan Butce</p><p class="text-xl font-bold ${p.budget-(p.spent||0)>0?'text-green-400':'text-red-400'}">\u20BA${fmtFull(p.budget-(p.spent||0))}</p></div>
        </div>
        <div class="glass rounded-xl p-4 mb-4">
            <p class="text-xs text-gray-500 mb-2">Butce Kullanim Orani</p>
            <div class="progress-bar"><div class="progress-fill ${(p.spent||0)/p.budget>0.9?'bg-red-500':(p.spent||0)/p.budget>0.7?'bg-orange-500':'bg-green-500'}" style="width:${Math.min(100,Math.round(((p.spent||0)/p.budget)*100))}%"></div></div>
            <p class="text-xs mt-1 font-bold">%${Math.round(((p.spent||0)/p.budget)*100)}</p>
        </div>
        ${taseronlar.length>0?`<div class="glass rounded-xl p-4 mb-4"><p class="text-xs text-gray-500 mb-2">Taseron Maliyetleri</p>${taseronlar.map(t=>`<div class="flex justify-between text-xs p-1"><span>${t.firma} (${t.isPaketi})</span><b class="text-amber-400">\u20BA${fmt(t.tutar)}</b></div>`).join('')}<div class="border-t border-gray-700 mt-2 pt-2 flex justify-between text-xs font-bold"><span>Toplam</span><span class="text-amber-400">\u20BA${fmt(taseronlar.reduce((s,t)=>s+t.tutar,0))}</span></div></div>`:''}
    </div>
    <!-- SOZLESME TAB -->
    <div id="detail-tab-dsozlesme" class="hidden">
        <h4 class="text-sm font-semibold mb-3">Sozlesmeler</h4>
        ${(()=>{const sz=p.sozlesmeler||[];if(sz.length===0)return '<p class="text-gray-500 text-xs">Sozlesme kaydi yok.</p>';
        const tipMap={ana:'Ana Sozlesme',ek:'Ek Sozlesme',teminat:'Teminat Mektubu'};const tipCol={ana:'blue',ek:'amber',teminat:'purple'};
        return '<div class="space-y-2">'+sz.map(s=>{const col=tipCol[s.tip]||'gray';
        return '<div class="glass rounded-lg p-3 flex justify-between items-center"><div><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-'+col+'-600/20 text-'+col+'-400 mr-2">'+(tipMap[s.tip]||s.tip)+'</span><span class="text-sm font-medium">'+s.no+'</span>'+(s.tip==='teminat'?'<span class="text-xs text-purple-400 ml-2">Banka: '+(s.banka||'-')+' | Vade: '+(s.vade||'-')+'</span>':'')+'</div><div class="text-right"><p class="font-bold text-'+col+'-400">\\u20BA'+fmt(s.bedel)+'</p><p class="text-[10px] text-gray-500">'+(s.tarih||'-')+'</p></div></div>';}).join('')+'</div>';})()}
        <button onclick="openSozlesmeForm(${p.id})" class="mt-3 px-3 py-1.5 bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/40 rounded text-xs">+ Sozlesme Ekle</button>
    </div>
    <!-- ISG TAB -->
    <div id="detail-tab-disg" class="hidden">
        <h4 class="text-sm font-semibold mb-3">ISG Ozeti</h4>
        ${(()=>{const isg=p.isg||{riskler:[],kazalar:[],egitimler:[],denetimler:[]};
        const tr=(isg.riskler||[]).length,tk=(isg.kazalar||[]).length,te=(isg.egitimler||[]).length,td=(isg.denetimler||[]).length;
        if(tr+tk+te+td===0)return '<p class="text-gray-500 text-xs">ISG kaydi yok.</p>';
        const yr=(isg.riskler||[]).filter(r=>r.seviye==='yuksek'||r.seviye==='kritik').length;
        return '<div class="grid grid-cols-4 gap-2 mb-3"><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Risk</p><p class="font-bold text-amber-400">'+tr+'</p>'+(yr>0?'<p class="text-[9px] text-red-400">'+yr+' yuksek</p>':'')+'</div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Kaza</p><p class="font-bold text-red-400">'+tk+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Egitim</p><p class="font-bold text-blue-400">'+te+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Denetim</p><p class="font-bold text-green-400">'+td+'</p></div></div>'+
        ((isg.riskler||[]).length>0?'<p class="text-[10px] text-gray-500 mb-1">Riskler</p><div class="space-y-1 mb-2">'+(isg.riskler||[]).map(r=>{const sc={dusuk:'green',orta:'amber',yuksek:'orange',kritik:'red'};const c2=sc[r.seviye]||'gray';return '<div class="glass rounded p-1.5 text-[11px] flex items-center gap-2"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-'+c2+'-600/20 text-'+c2+'-400">'+(r.seviye||'').toUpperCase()+'</span><span class="flex-1">'+r.aciklama+'</span></div>';}).join('')+'</div>':'');})()}
        <button onclick="openIsgForm(${p.id})" class="mt-2 px-3 py-1.5 bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded text-xs">+ ISG Kaydi</button>
    </div>
    <!-- KALITE TAB -->
    <div id="detail-tab-dkalite" class="hidden">
        <h4 class="text-sm font-semibold mb-3">Kalite Kontrol</h4>
        ${(()=>{const kk=p.kaliteKontrol||{testler:[],ncrler:[],punchList:[]};
        const tt=(kk.testler||[]).length,tn=(kk.ncrler||[]).length,tp=(kk.punchList||[]).length;
        if(tt+tn+tp===0)return '<p class="text-gray-500 text-xs">Kalite kaydi yok.</p>';
        const pr=tt>0?Math.round((kk.testler||[]).filter(t=>t.sonuc==='gecti').length/tt*100):0;
        const on=(kk.ncrler||[]).filter(n=>n.durum==='acik').length;
        return '<div class="grid grid-cols-3 gap-2 mb-3"><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Pass Rate</p><p class="font-bold '+(pr>=80?'text-green-400':'text-amber-400')+'">'+pr+'%</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Acik NCR</p><p class="font-bold '+(on>0?'text-red-400':'text-green-400')+'">'+on+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Punch</p><p class="font-bold text-amber-400">'+(kk.punchList||[]).filter(x=>x.done).length+'/'+tp+'</p></div></div>'+
        (tt>0?'<p class="text-[10px] text-gray-500 mb-1">Son Testler</p><div class="space-y-1 mb-2">'+(kk.testler||[]).slice(-3).map(t=>{const sc2={gecti:'green',kaldi:'red',sartli:'amber'};const c3=sc2[t.sonuc]||'gray';return '<div class="glass rounded p-1.5 text-[11px] flex justify-between"><span>'+t.aciklama+'</span><span class="px-1.5 py-0.5 rounded text-[9px] bg-'+c3+'-600/20 text-'+c3+'-400">'+t.sonuc+'</span></div>';}).join('')+'</div>':'');})()}
        <button onclick="openKaliteForm(${p.id})" class="mt-2 px-3 py-1.5 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/40 rounded text-xs">+ Kalite Kaydi</button>
    </div>
    <!-- NAKIT TAB -->
    <div id="detail-tab-dnakit" class="hidden">
        <h4 class="text-sm font-semibold mb-3">Nakit Akisi</h4>
        ${(()=>{const na=p.nakitAkisi||[];if(na.length===0)return '<p class="text-gray-500 text-xs">Nakit akisi kaydi yok.</p>';
        na.sort((a,b)=>a.ay.localeCompare(b.ay));
        const tg=na.reduce((s,n)=>s+n.gelir,0),tgd=na.reduce((s,n)=>s+n.gider,0),tt2=na.reduce((s,n)=>s+n.taseronOdeme,0);
        return '<div class="grid grid-cols-4 gap-2 mb-3"><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Gelir</p><p class="font-bold text-green-400">\\u20BA'+fmt(tg)+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Gider</p><p class="font-bold text-red-400">\\u20BA'+fmt(tgd)+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Taseron</p><p class="font-bold text-amber-400">\\u20BA'+fmt(tt2)+'</p></div><div class="glass rounded-lg p-2 text-center"><p class="text-[10px] text-gray-400">Net</p><p class="font-bold '+(tg-tgd-tt2>=0?'text-green-400':'text-red-400')+'">\\u20BA'+fmt(tg-tgd-tt2)+'</p></div></div>'+
        '<div class="overflow-x-auto"><table class="w-full text-[11px]"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-1 text-left">Ay</th><th class="p-1 text-right">Gelir</th><th class="p-1 text-right">Gider</th><th class="p-1 text-right">Taseron</th><th class="p-1 text-right">Net</th></tr></thead><tbody>'+na.map(n=>'<tr class="border-b border-gray-800"><td class="p-1">'+n.ay+'</td><td class="p-1 text-right text-green-400">\\u20BA'+fmt(n.gelir)+'</td><td class="p-1 text-right text-red-400">\\u20BA'+fmt(n.gider)+'</td><td class="p-1 text-right text-amber-400">\\u20BA'+fmt(n.taseronOdeme)+'</td><td class="p-1 text-right font-bold '+(n.gelir-n.gider-n.taseronOdeme>=0?'text-green-400':'text-red-400')+'">\\u20BA'+fmt(n.gelir-n.gider-n.taseronOdeme)+'</td></tr>').join('')+'</tbody></table></div>';})()}
        <button onclick="openNakitAkisiForm(${p.id})" class="mt-2 px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">+ Nakit Kaydi</button>
    </div>
    <!-- MALZEME TAB -->
    <div id="detail-tab-dmalzeme" class="hidden">
        <h4 class="text-sm font-semibold mb-3">Malzeme / Stok</h4>
        ${(()=>{const ms=p.malzemeStok||[];if(ms.length===0)return '<p class="text-gray-500 text-xs">Malzeme kaydi yok.</p>';
        const low=ms.filter(m=>m.minStok>0&&m.miktar<=m.minStok);
        return (low.length>0?'<div class="bg-red-900/30 border border-red-800 rounded-lg p-2 mb-2 text-[11px] text-red-300">&#9888; Dusuk: '+low.map(m=>m.malzeme).join(', ')+'</div>':'')+
        '<div class="overflow-x-auto"><table class="w-full text-[11px]"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-1 text-left">Malzeme</th><th class="p-1 text-right">Stok</th><th class="p-1 text-right">Min</th><th class="p-1 text-center">Durum</th><th class="p-1"></th></tr></thead><tbody>'+ms.map(m=>{const lo=m.minStok>0&&m.miktar<=m.minStok;return '<tr class="border-b border-gray-800 '+(lo?'bg-red-900/10':'')+'"><td class="p-1">'+m.malzeme+'</td><td class="p-1 text-right '+(lo?'text-red-400':'text-green-400')+'">'+m.miktar+' '+m.birim+'</td><td class="p-1 text-right text-gray-400">'+(m.minStok||'-')+'</td><td class="p-1 text-center">'+(lo?'<span class="text-red-400 text-[9px] font-bold">DUSUK</span>':'<span class="text-green-400 text-[9px]">OK</span>')+'</td><td class="p-1"><button onclick="openStokHareketForm('+p.id+','+m.id+')" class="px-1.5 py-0.5 bg-orange-600/20 text-orange-400 rounded text-[9px]">+</button></td></tr>';}).join('')+'</tbody></table></div>';})()}
        <button onclick="openMalzemeForm(${p.id})" class="mt-2 px-3 py-1.5 bg-orange-600/20 text-orange-400 hover:bg-orange-600/40 rounded text-xs">+ Malzeme Ekle</button>
    </div>`;
    document.getElementById('detail-content').innerHTML=html;
    document.getElementById('project-detail').classList.add('active');
}
function switchDetailTab(tab){
    const tabs=['genel','dtaseronlar','dtedarikciler','disKalemleri','dhakedis','dgunluk','dbutce','dsozlesme','disg','dkalite','dnakit','dmalzeme'];
    tabs.forEach(t=>{const el=document.getElementById('detail-tab-'+t);if(el)el.classList.toggle('hidden',t!==tab);});
    document.querySelectorAll('#detail-tabs .tab-btn').forEach((b,i)=>b.classList.toggle('active',tabs[i]===tab));
}

// ===================== METRAJ / KESIF =====================
function renderMetrajTab(){
    const c=document.getElementById('metraj-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<h4 class="text-sm font-semibold mb-4">Metraj / Kesif Karsilastirmasi</h4>';
    S.projects.forEach(p=>{
        const ik=p.isKalemleri||[];if(ik.length===0)return;
        let topSozlesme=0,topGerceklesen=0;
        const rows=ik.map(k=>{
            const sozTutar=k.miktar*k.birimFiyat;
            const gMiktar=k.gerceklesen||0;
            const gTutar=gMiktar*k.birimFiyat;
            const sapma=gTutar-sozTutar;const sapmaPct=sozTutar>0?((sapma/sozTutar)*100):0;
            topSozlesme+=sozTutar;topGerceklesen+=gTutar;
            const badge=sapma>0?'<span class="text-red-400 text-xs font-bold">&#9650; Is Artisi</span>':sapma<0?'<span class="text-green-400 text-xs font-bold">&#9660; Is Azalisi</span>':'<span class="text-gray-500 text-xs">Esit</span>';
            return `<tr class="border-b border-gray-800"><td class="p-2 text-xs">${k.pozNo||'-'}</td><td class="p-2 text-xs">${k.kalemAdi}</td><td class="p-2 text-xs text-right">${fmt(k.miktar)} ${k.birim}</td><td class="p-2 text-xs text-right">${fmt(gMiktar)} ${k.birim}</td><td class="p-2 text-xs text-right">\u20BA${fmt(sozTutar)}</td><td class="p-2 text-xs text-right">\u20BA${fmt(gTutar)}</td><td class="p-2 text-xs text-right ${sapma>0?'text-red-400':sapma<0?'text-green-400':'text-gray-400'}">\u20BA${fmt(sapma)} (${sapmaPct.toFixed(1)}%)</td><td class="p-2 text-xs text-center">${badge}</td></tr>`;
        }).join('');
        const topSapma=topGerceklesen-topSozlesme;const topPct=topSozlesme>0?((topSapma/topSozlesme)*100):0;
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-purple-400">${p.name}</h5>
        <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Sozlesme Bedeli</p><p class="text-lg font-bold text-blue-400">\u20BA${fmt(topSozlesme)}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Gerceklesen</p><p class="text-lg font-bold text-amber-400">\u20BA${fmt(topGerceklesen)}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Sapma</p><p class="text-lg font-bold ${topSapma>0?'text-red-400':'text-green-400'}">\u20BA${fmt(topSapma)} (${topPct.toFixed(1)}%)</p></div>
        </div>
        <div class="overflow-x-auto"><table class="w-full"><thead><tr class="text-xs text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Poz No</th><th class="p-2 text-left">Kalem</th><th class="p-2 text-right">Sozlesme</th><th class="p-2 text-right">Gerceklesen</th><th class="p-2 text-right">Soz.Tutar</th><th class="p-2 text-right">Gerc.Tutar</th><th class="p-2 text-right">Sapma</th><th class="p-2 text-center">Durum</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
    });
    c.innerHTML=html;
}

// ===================== NAKIT AKISI =====================
function openNakitAkisiForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    const naF=id=>document.getElementById(id);
    const pid=naF('na-project-id');if(pid)pid.value=projectId;
    const ay=naF('na-ay');if(ay)ay.value=new Date().toISOString().slice(0,7);
    ['na-gelir','na-gider','na-taseron-odeme','na-notlar'].forEach(id=>{const el=naF(id);if(el)el.value='';});
    openModal('modal-nakit-akisi');
}
function addNakitAkisi(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('na-project-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.nakitAkisi)p.nakitAkisi=[];
    p.nakitAkisi.push({id:Date.now(),ay:f.get('ay'),gelir:+f.get('gelir')||0,gider:+f.get('gider')||0,taseronOdeme:+f.get('taseronOdeme')||0,notlar:f.get('notlar')||''});
    act(p.name+' - Nakit akisi kaydi eklendi');save();renderAll();closeModal('modal-nakit-akisi');e.target.reset();showNotif('Nakit akisi kaydi eklendi!');
}
function renderNakitAkisiTab(){
    const c=document.getElementById('nakit-akisi-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Nakit Akisi</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openNakitAkisiForm(${p.id})" class="px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const na=p.nakitAkisi||[];if(na.length===0)return;
        na.sort((a,b)=>a.ay.localeCompare(b.ay));
        const topG=na.reduce((s,n)=>s+n.gelir,0),topGd=na.reduce((s,n)=>s+n.gider,0),topT=na.reduce((s,n)=>s+n.taseronOdeme,0);
        const maxVal=Math.max(...na.map(n=>Math.max(n.gelir,n.gider+n.taseronOdeme)),1);
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-green-400">${p.name}</h5>
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Toplam Gelir</p><p class="font-bold text-green-400">\u20BA${fmt(topG)}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Toplam Gider</p><p class="font-bold text-red-400">\u20BA${fmt(topGd)}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Taseron Odeme</p><p class="font-bold text-amber-400">\u20BA${fmt(topT)}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Net</p><p class="font-bold ${topG-topGd-topT>=0?'text-green-400':'text-red-400'}">\u20BA${fmt(topG-topGd-topT)}</p></div>
        </div>
        <div class="flex items-end gap-1 h-32 mb-4">${na.map(n=>{
            const gh=Math.round((n.gelir/maxVal)*100);const gdh=Math.round(((n.gider+n.taseronOdeme)/maxVal)*100);
            return `<div class="flex-1 flex flex-col items-center gap-0.5"><div class="w-full flex gap-0.5 items-end justify-center" style="height:110px"><div class="chart-bar bg-green-500" style="width:40%;height:${gh}%"></div><div class="chart-bar bg-red-500" style="width:40%;height:${gdh}%"></div></div><span class="text-[9px] text-gray-500">${n.ay.slice(5)}</span></div>`;
        }).join('')}</div>
        <div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Ay</th><th class="p-2 text-right">Gelir</th><th class="p-2 text-right">Gider</th><th class="p-2 text-right">Taseron</th><th class="p-2 text-right">Net</th><th class="p-2 text-left">Not</th></tr></thead><tbody>${na.map(n=>`<tr class="border-b border-gray-800"><td class="p-2">${n.ay}</td><td class="p-2 text-right text-green-400">\u20BA${fmt(n.gelir)}</td><td class="p-2 text-right text-red-400">\u20BA${fmt(n.gider)}</td><td class="p-2 text-right text-amber-400">\u20BA${fmt(n.taseronOdeme)}</td><td class="p-2 text-right font-bold ${n.gelir-n.gider-n.taseronOdeme>=0?'text-green-400':'text-red-400'}">\u20BA${fmt(n.gelir-n.gider-n.taseronOdeme)}</td><td class="p-2 text-gray-400">${n.notlar||'-'}</td></tr>`).join('')}</tbody></table></div></div>`;
    });
    if(!html.includes('text-green-400'))html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz nakit akisi kaydi yok.</p></div>';
    c.innerHTML=html;
}

// ===================== SOZLESME YONETIMI =====================
function openSozlesmeForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('sz-project-id').value=projectId;
    document.getElementById('sz-tip').value='ana';toggleSozlesmeTip();
    document.getElementById('sz-no').value='';document.getElementById('sz-tarih').value='';document.getElementById('sz-bedel').value='';
    document.getElementById('sz-banka').value='';document.getElementById('sz-teminat-tutar').value='';document.getElementById('sz-vade').value='';document.getElementById('sz-aciklama').value='';
    openModal('modal-sozlesme');
}
function toggleSozlesmeTip(){
    const tip=document.getElementById('sz-tip').value;
    document.getElementById('sz-ek-fields').style.display=tip==='ek'?'block':'none';
    document.getElementById('sz-teminat-fields').style.display=tip==='teminat'?'block':'none';
}
function addSozlesme(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('sz-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.sozlesmeler)p.sozlesmeler=[];
    const tip=f.get('tip');
    const rec={id:Date.now(),tip,no:f.get('no'),tarih:f.get('tarih'),bedel:+f.get('bedel')||0,aciklama:f.get('aciklama')||''};
    if(tip==='teminat'){rec.banka=f.get('banka');rec.teminatTutar=+f.get('teminatTutar')||0;rec.vade=f.get('vade');}
    p.sozlesmeler.push(rec);
    act(p.name+' - Sozlesme eklendi: '+rec.no);save();renderAll();closeModal('modal-sozlesme');e.target.reset();showNotif('Sozlesme kaydi eklendi!');
}
function renderSozlesmeTab(){
    const c=document.getElementById('sozlesme-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Sozlesme Yonetimi</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openSozlesmeForm(${p.id})" class="px-3 py-1.5 bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const sz=p.sozlesmeler||[];if(sz.length===0)return;
        const tipMap={ana:'Ana Sozlesme',ek:'Ek Sozlesme / Tadilat',teminat:'Teminat Mektubu'};
        const tipColor={ana:'blue',ek:'amber',teminat:'purple'};
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-indigo-400">${p.name}</h5><div class="space-y-2">${sz.map(s=>{
            const col=tipColor[s.tip]||'gray';
            let extra='';
            if(s.tip==='teminat')extra=`<span class="text-xs text-purple-400 ml-2">Banka: ${s.banka||'-'} | Tutar: \u20BA${fmt(s.teminatTutar||0)} | Vade: ${s.vade||'-'}</span>`;
            return `<div class="glass rounded-lg p-3 flex items-center justify-between"><div><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-${col}-600/20 text-${col}-400 mr-2">${tipMap[s.tip]||s.tip}</span><span class="text-sm font-medium">${s.no}</span>${extra}</div><div class="text-right"><p class="font-bold text-${col}-400">\u20BA${fmt(s.bedel)}</p><p class="text-[10px] text-gray-500">${s.tarih||'-'}</p></div></div>`;
        }).join('')}</div></div>`;
    });
    if(!html.includes('text-indigo-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz sozlesme kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== YAZISMA / DOKUMAN =====================
let yazismaDosyalar=[];
function openYazismaForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('yz-project-id').value=projectId;
    const yz=p.yazismalar||[];const nextNo=yz.length+1;const autoNo='YZ-'+new Date().getFullYear()+'/'+String(nextNo).padStart(3,'0');
    document.getElementById('yz-tip').value='giden';document.getElementById('yz-no').value=autoNo;document.getElementById('yz-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('yz-konu').value='';document.getElementById('yz-gonderenAlici').value='';document.getElementById('yz-kategori').value='resmi';document.getElementById('yz-durum').value='acik';
    document.getElementById('yz-aciklama').value='';
    yazismaDosyalar=[];document.getElementById('yz-dosya-onizleme').innerHTML='';
    const fileInput=document.getElementById('yz-dosyalar');fileInput.value='';
    fileInput.onchange=function(){handleYazismaDosya(this.files);};
    openModal('modal-yazisma');
}
function handleYazismaDosya(files){
    const preview=document.getElementById('yz-dosya-onizleme');
    Array.from(files).forEach(file=>{
        if(file.size>5*1024*1024){showNotif('Dosya cok buyuk: '+file.name+' (maks 5MB)');return;}
        const reader=new FileReader();
        reader.onload=function(e2){
            const ext=file.name.split('.').pop().toLowerCase();
            const iconMap={pdf:'&#128196;',doc:'&#128195;',docx:'&#128195;',xls:'&#128202;',xlsx:'&#128202;',jpg:'&#128247;',jpeg:'&#128247;',png:'&#128247;',dwg:'&#128208;',zip:'&#128230;'};
            const icon=iconMap[ext]||'&#128196;';
            const sizeStr=file.size<1024?(file.size+'B'):file.size<1048576?(Math.round(file.size/1024)+'KB'):(Math.round(file.size/1048576*10)/10+'MB');
            yazismaDosyalar.push({ad:file.name,boyut:file.size,boyutStr:sizeStr,tip:file.type,ext,data:e2.target.result});
            preview.innerHTML=yazismaDosyalar.map((d,i)=>`<div class="glass rounded-lg px-2 py-1.5 flex items-center gap-1.5 text-[11px]"><span>${iconMap[d.ext]||'&#128196;'}</span><span class="max-w-[120px] truncate">${d.ad}</span><span class="text-gray-500">(${d.boyutStr})</span><button type="button" onclick="yazismaDosyalar.splice(${i},1);handleYazismaDosya([])" class="text-red-400 hover:text-red-300 ml-1">&times;</button></div>`).join('');
        };
        reader.readAsDataURL(file);
    });
}
function downloadYazismaDosya(projectId,yazismaId,dosyaIdx){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    const y=(p.yazismalar||[]).find(x=>x.id===yazismaId);if(!y||!y.dosyalar||!y.dosyalar[dosyaIdx])return;
    const d=y.dosyalar[dosyaIdx];
    const a=document.createElement('a');a.href=d.data;a.download=d.ad;document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function addYazisma(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('yz-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.yazismalar)p.yazismalar=[];
    const rec={id:Date.now(),tip:f.get('tip'),no:f.get('no'),tarih:f.get('tarih'),konu:f.get('konu'),gonderenAlici:f.get('gonderenAlici'),kategori:f.get('kategori'),durum:f.get('durum'),aciklama:f.get('aciklama')||''};
    if(yazismaDosyalar.length>0)rec.dosyalar=yazismaDosyalar.map(d=>({ad:d.ad,boyut:d.boyut,boyutStr:d.boyutStr,tip:d.tip,ext:d.ext,data:d.data}));
    p.yazismalar.push(rec);
    act(p.name+' - Yazisma eklendi: '+f.get('no'));save();renderAll();closeModal('modal-yazisma');e.target.reset();showNotif('Yazisma kaydi eklendi!');
}
function renderYazismaTab(){
    const c=document.getElementById('yazisma-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Yazisma / Dokuman</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openYazismaForm(${p.id})" class="px-3 py-1.5 bg-sky-600/20 text-sky-400 hover:bg-sky-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const yz=p.yazismalar||[];if(yz.length===0)return;
        yz.sort((a,b)=>(b.tarih||'').localeCompare(a.tarih||''));
        const katMap={resmi:'Resmi Yazi',teknik:'Teknik',idari:'Idari',toplanti:'Toplanti',diger:'Diger'};
        const durMap={acik:'Acik',cevaplandi:'Cevaplandi',kapandi:'Kapandi'};
        const durCol={acik:'amber',cevaplandi:'blue',kapandi:'green'};
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-sky-400">${p.name}</h5>
        <div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Tip</th><th class="p-2 text-left">No</th><th class="p-2 text-left">Tarih</th><th class="p-2 text-left">Konu</th><th class="p-2 text-left">Gonderen/Alici</th><th class="p-2 text-left">Kategori</th><th class="p-2 text-left">Durum</th><th class="p-2 text-left">Ekler</th></tr></thead><tbody>${yz.map(y=>{
            const tipIcon=y.tip==='gelen'?'&#9660;':'&#9650;';const tipCol=y.tip==='gelen'?'green':'blue';
            const dCol=durCol[y.durum]||'gray';
            const iconMap={pdf:'&#128196;',doc:'&#128196;',docx:'&#128196;',xls:'&#128202;',xlsx:'&#128202;',jpg:'&#128247;',jpeg:'&#128247;',png:'&#128247;',dwg:'&#128208;',zip:'&#128230;'};
            let dosyaHtml='-';
            if(y.dosyalar&&y.dosyalar.length>0){dosyaHtml=y.dosyalar.map((d,di)=>`<button onclick="downloadYazismaDosya(${p.id},${y.id},${di})" class="inline-flex items-center gap-1 px-1.5 py-0.5 glass rounded text-[10px] hover:bg-sky-600/20 text-sky-300 mr-1 mb-0.5" title="${d.ad} (${d.boyutStr})">${iconMap[d.ext]||'&#128196;'} ${d.ad.length>15?d.ad.substring(0,12)+'...':d.ad}</button>`).join('');}
            const aciklamaRow=y.aciklama?`<tr class="border-b border-gray-800 bg-gray-900/30"><td colspan="8" class="p-2 pl-8 text-gray-400 italic text-[11px]">&#128172; ${y.aciklama}</td></tr>`:'';
            return `<tr class="border-b border-gray-800"><td class="p-2"><span class="text-${tipCol}-400">${tipIcon}</span> ${y.tip==='gelen'?'Gelen':'Giden'}</td><td class="p-2 font-medium">${y.no}</td><td class="p-2">${y.tarih||'-'}</td><td class="p-2">${y.konu}</td><td class="p-2">${y.gonderenAlici||'-'}</td><td class="p-2">${katMap[y.kategori]||y.kategori}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-[10px] bg-${dCol}-600/20 text-${dCol}-400">${durMap[y.durum]||y.durum}</span></td><td class="p-2">${dosyaHtml}</td></tr>${aciklamaRow}`;
        }).join('')}</tbody></table></div></div>`;
    });
    if(!html.includes('text-sky-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz yazisma kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== MALZEME / STOK =====================
function openMalzemeForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('ms-project-id').value=projectId;
    document.getElementById('ms-malzeme').value='';document.getElementById('ms-miktar').value='';document.getElementById('ms-birim').value='adet';document.getElementById('ms-min-stok').value='';
    openModal('modal-malzeme');
}
function addMalzeme(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('ms-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.malzemeStok)p.malzemeStok=[];
    p.malzemeStok.push({id:Date.now(),malzeme:f.get('malzeme'),miktar:+f.get('miktar')||0,birim:f.get('birim')||'adet',minStok:+f.get('minStok')||0,hareketler:[]});
    act(p.name+' - Malzeme eklendi: '+f.get('malzeme'));save();renderAll();closeModal('modal-malzeme');e.target.reset();showNotif('Malzeme eklendi!');
}
function openStokHareketForm(projectId,malzemeId){
    document.getElementById('sh-project-id').value=projectId;document.getElementById('sh-malzeme-id').value=malzemeId;
    document.getElementById('sh-tarih').value=new Date().toISOString().slice(0,10);document.getElementById('sh-tip').value='giris';document.getElementById('sh-miktar').value='';document.getElementById('sh-irsaliye').value='';
    openModal('modal-stok-hareket');
}
function addStokHareket(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('sh-project-id').value;const mid=+document.getElementById('sh-malzeme-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;
    const m=(p.malzemeStok||[]).find(x=>x.id===mid);if(!m)return;
    if(!m.hareketler)m.hareketler=[];
    const tip=f.get('tip');const mkt=+f.get('miktar')||0;
    m.hareketler.push({id:Date.now(),tarih:f.get('tarih'),tip,miktar:mkt,irsaliyeNo:f.get('irsaliyeNo')||''});
    m.miktar+=(tip==='giris'?mkt:-mkt);
    act(p.name+' - Stok hareketi: '+m.malzeme+' '+tip);save();renderAll();closeModal('modal-stok-hareket');e.target.reset();showNotif('Stok hareketi kaydedildi!');
}
function renderMalzemeStokTab(){
    const c=document.getElementById('malzeme-stok-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Malzeme / Stok</h4><div class="flex flex-wrap gap-2">'+S.projects.map(p=>`<button onclick="openMalzemeForm(${p.id})" class="px-3 py-1.5 bg-orange-600/20 text-orange-400 hover:bg-orange-600/40 rounded text-xs">+ ${p.name}</button><button onclick="openDepoTalepForm(${p.id})" class="px-3 py-1.5 bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 rounded text-xs border border-blue-500/20">&#128230; Depodan Talep - ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const ms=p.malzemeStok||[];if(ms.length===0)return;
        const lowStock=ms.filter(m=>m.minStok>0&&m.miktar<=m.minStok);
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-orange-400">${p.name}</h5>`;
        if(lowStock.length>0)html+=`<div class="bg-red-900/30 border border-red-800 rounded-lg p-3 mb-3 text-xs text-red-300">&#9888; Dusuk stok uyarisi: ${lowStock.map(m=>m.malzeme+' ('+m.miktar+' '+m.birim+')').join(', ')}</div>`;
        html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Malzeme</th><th class="p-2 text-right">Stok</th><th class="p-2 text-right">Min Stok</th><th class="p-2 text-center">Durum</th><th class="p-2 text-center">Islem</th></tr></thead><tbody>${ms.map(m=>{
            const low=m.minStok>0&&m.miktar<=m.minStok;
            return `<tr class="border-b border-gray-800 ${low?'bg-red-900/10':''}"><td class="p-2 font-medium">${m.malzeme}</td><td class="p-2 text-right ${low?'text-red-400':'text-green-400'}">${m.miktar} ${m.birim}</td><td class="p-2 text-right text-gray-400">${m.minStok||'-'} ${m.minStok?m.birim:''}</td><td class="p-2 text-center">${low?'<span class="text-red-400 text-[10px] font-bold">DUSUK</span>':'<span class="text-green-400 text-[10px]">OK</span>'}</td><td class="p-2 text-center"><button onclick="openStokHareketForm(${p.id},${m.id})" class="px-2 py-1 bg-orange-600/20 text-orange-400 hover:bg-orange-600/40 rounded text-[10px]">+Hareket</button></td></tr>`;
        }).join('')}</tbody></table></div>`;
        // Son hareketler
        const allH=[];ms.forEach(m=>(m.hareketler||[]).forEach(h=>allH.push({...h,malzeme:m.malzeme})));
        if(allH.length>0){allH.sort((a,b)=>(b.tarih||'').localeCompare(a.tarih||''));
            html+=`<p class="text-xs text-gray-400 mt-3 mb-1">Son Hareketler</p><div class="space-y-1">${allH.slice(0,5).map(h=>`<div class="flex justify-between text-[11px] glass rounded p-1.5"><span>${h.tarih} - ${h.malzeme}</span><span class="${h.tip==='giris'?'text-green-400':'text-red-400'}">${h.tip==='giris'?'+':'-'}${h.miktar} ${h.irsaliyeNo?'('+h.irsaliyeNo+')':''}</span></div>`).join('')}</div>`;
        }
        html+=`</div>`;
    });
    if(!html.includes('text-orange-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz malzeme kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== DEPODAN MALZEME TALEP =====================
function openDepoTalepForm(projectId){
    document.getElementById('dt-project-id').value=projectId;
    const malSel=document.getElementById('dt-malzeme');
    malSel.innerHTML=(S.envanter||[]).filter(i=>i.miktar>0).map(i=>`<option value="${i.id}">${i.ad} (Stok: ${i.miktar} ${i.birim})</option>`).join('');
    if(malSel.options.length===0){showNotif('Depoda stok yok.');return;}
    const depoSel=document.getElementById('dt-depo');
    depoSel.innerHTML=(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    document.getElementById('dt-miktar').value='1';document.getElementById('dt-aciliyet').value='normal';document.getElementById('dt-aciklama').value='';
    updateDepoTalepStok();openModal('modal-depo-talep');
}
function updateDepoTalepStok(){
    const itemId=parseInt(document.getElementById('dt-malzeme').value);
    const item=(S.envanter||[]).find(i=>i.id===itemId);
    document.getElementById('dt-mevcut-stok').value=item?(item.miktar+' '+item.birim):'-';
}
function submitDepoTalep(){
    const projectId=parseInt(document.getElementById('dt-project-id').value);
    const itemId=parseInt(document.getElementById('dt-malzeme').value);
    const miktar=parseFloat(document.getElementById('dt-miktar').value)||0;
    if(!projectId||!itemId||miktar<=0){showNotif('Malzeme secin ve miktar girin.');return;}
    const item=(S.envanter||[]).find(i=>i.id===itemId);
    if(item&&miktar>item.miktar){showNotif('Stok yetersiz! Mevcut: '+item.miktar+' '+item.birim);return;}
    const project=S.projects.find(p=>p.id===projectId);
    if(!S.depoHareketler)S.depoHareketler=[];
    S.depoHareketler.push({id:Date.now(),tarih:new Date().toISOString().slice(0,10),envanterItemId:itemId,tip:'projeye',miktar,
        kaynakDepoId:parseInt(document.getElementById('dt-depo').value)||null,hedefDepoId:null,projectId:projectId,irsaliyeNo:'',
        aciklama:document.getElementById('dt-aciklama').value.trim()||('Proje talep: '+(project?project.name:'')),
        durum:'talep',talepEden:currentUser?currentUser.name:'',aciliyet:document.getElementById('dt-aciliyet').value,onaylayan:''});
    save();closeModal('modal-depo-talep');showNotif('Malzeme talebi olusturuldu. Onay bekleniyor.');
    act('Depo talep: '+(item?item.ad:'?')+' x'+miktar+' -> '+(project?project.name:'?'));
}

// ===================== YESIL DEFTER =====================
function openYesilDefterForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('yd-project-id').value=projectId;
    document.getElementById('yd-tip').value='atasman';toggleYesilDefterTip();
    document.getElementById('yd-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('yd-miktar').value='';document.getElementById('yd-konum').value='';
    document.getElementById('yd-isci').value='';document.getElementById('yd-meslek').value='';document.getElementById('yd-giris').value='08:00';document.getElementById('yd-cikis').value='17:00';document.getElementById('yd-fazla-mesai').value='0';
    // Populate kalem select
    const sel=document.getElementById('yd-kalem-id');sel.innerHTML='<option value="">Seciniz...</option>';
    (p.isKalemleri||[]).forEach(k=>sel.innerHTML+=`<option value="${k.id}">${k.pozNo||''} ${k.kalemAdi}</option>`);
    openModal('modal-yesil-defter');
}
function toggleYesilDefterTip(){
    const tip=document.getElementById('yd-tip').value;
    document.getElementById('yd-atasman-fields').style.display=tip==='atasman'?'block':'none';
    document.getElementById('yd-puantaj-fields').style.display=tip==='puantaj'?'block':'none';
}
function addYesilDefter(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('yd-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.yesilDefter)p.yesilDefter=[];
    const tip=f.get('tip');
    const rec={id:Date.now(),tip,tarih:f.get('tarih')};
    if(tip==='atasman'){rec.kalemId=+f.get('kalemId')||0;rec.miktar=+f.get('miktar')||0;rec.konum=f.get('konum')||'';}
    else{rec.isci=f.get('isci');rec.meslek=f.get('meslek');rec.giris=f.get('giris');rec.cikis=f.get('cikis');rec.fazlaMesai=+f.get('fazlaMesai')||0;}
    p.yesilDefter.push(rec);
    act(p.name+' - Yesil defter: '+tip);save();renderAll();closeModal('modal-yesil-defter');e.target.reset();showNotif('Yesil defter kaydi eklendi!');
}
function renderYesilDefterTab(){
    const c=document.getElementById('yesil-defter-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Yesil Defter (Atasman / Puantaj)</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openYesilDefterForm(${p.id})" class="px-3 py-1.5 bg-lime-600/20 text-lime-400 hover:bg-lime-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const yd=p.yesilDefter||[];if(yd.length===0)return;
        const atas=yd.filter(y=>y.tip==='atasman');const puan=yd.filter(y=>y.tip==='puantaj');
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-lime-400">${p.name}</h5>`;
        if(atas.length>0){
            html+=`<p class="text-xs text-gray-400 mb-2">Atasman Kayitlari (${atas.length})</p><div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Tarih</th><th class="p-2 text-left">Is Kalemi</th><th class="p-2 text-right">Miktar</th><th class="p-2 text-left">Konum</th></tr></thead><tbody>${atas.map(a=>{
                const k=(p.isKalemleri||[]).find(x=>x.id===a.kalemId);
                return `<tr class="border-b border-gray-800"><td class="p-2">${a.tarih}</td><td class="p-2">${k?(k.pozNo+' '+k.kalemAdi):'-'}</td><td class="p-2 text-right font-bold text-lime-400">${a.miktar}</td><td class="p-2">${a.konum||'-'}</td></tr>`;
            }).join('')}</tbody></table></div>`;
        }
        if(puan.length>0){
            html+=`<p class="text-xs text-gray-400 mb-2 ${atas.length>0?'mt-4':''}">Puantaj Cetveli (${puan.length})</p><div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Tarih</th><th class="p-2 text-left">Isci</th><th class="p-2 text-left">Meslek</th><th class="p-2 text-center">Giris</th><th class="p-2 text-center">Cikis</th><th class="p-2 text-center">Fazla Mesai</th></tr></thead><tbody>${puan.map(p2=>`<tr class="border-b border-gray-800"><td class="p-2">${p2.tarih}</td><td class="p-2">${p2.isci}</td><td class="p-2">${p2.meslek||'-'}</td><td class="p-2 text-center">${p2.giris}</td><td class="p-2 text-center">${p2.cikis}</td><td class="p-2 text-center ${p2.fazlaMesai>0?'text-amber-400':''}">${p2.fazlaMesai||0}s</td></tr>`).join('')}</tbody></table></div>`;
        }
        html+=`</div>`;
    });
    if(!html.includes('text-lime-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz yesil defter kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== EKIPMAN / MAKINE =====================
function openEkipmanForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('ek-project-id').value=projectId;
    document.getElementById('ek-ad').value='';document.getElementById('ek-tip').value='ekskavat√∂r';document.getElementById('ek-plaka').value='';
    document.getElementById('ek-sahiplik').value='kiralik';document.getElementById('ek-gunluk-maliyet').value='';
    openModal('modal-ekipman');
}
function addEkipman(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('ek-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.ekipmanlar)p.ekipmanlar=[];
    p.ekipmanlar.push({id:Date.now(),ad:f.get('ad'),tip:f.get('tip'),plaka:f.get('plaka')||'',sahiplik:f.get('sahiplik'),gunlukMaliyet:+f.get('gunlukMaliyet')||0,calismaKayitlari:[],bakimlar:[],yakitKayitlari:[]});
    act(p.name+' - Ekipman eklendi: '+f.get('ad'));save();renderAll();closeModal('modal-ekipman');e.target.reset();showNotif('Ekipman eklendi!');
}
function openEkipmanKayitForm(projectId,ekipmanId){
    document.getElementById('ekk-project-id').value=projectId;document.getElementById('ekk-ekipman-id').value=ekipmanId;
    document.getElementById('ekk-kayit-tip').value='calisma';document.getElementById('ekk-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('ekk-saat').value='';document.getElementById('ekk-yakit').value='';document.getElementById('ekk-bakim-aciklama').value='';
    openModal('modal-ekipman-kayit');
}
function addEkipmanKayit(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('ekk-project-id').value;const eid=+document.getElementById('ekk-ekipman-id').value;
    const p=S.projects.find(x=>x.id===pid);if(!p)return;const ek=(p.ekipmanlar||[]).find(x=>x.id===eid);if(!ek)return;
    const tip=f.get('kayitTip');const tarih=f.get('tarih');
    if(tip==='calisma'){if(!ek.calismaKayitlari)ek.calismaKayitlari=[];ek.calismaKayitlari.push({tarih,saat:+f.get('saat')||0});}
    else if(tip==='yakit'){if(!ek.yakitKayitlari)ek.yakitKayitlari=[];ek.yakitKayitlari.push({tarih,litre:+f.get('yakit')||0});}
    else{if(!ek.bakimlar)ek.bakimlar=[];ek.bakimlar.push({tarih,aciklama:f.get('bakimAciklama')||''});}
    act(p.name+' - Ekipman kayit: '+ek.ad+' '+tip);save();renderAll();closeModal('modal-ekipman-kayit');e.target.reset();showNotif('Kayit eklendi!');
}
function renderEkipmanTab(){
    const c=document.getElementById('ekipman-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Ekipman / Makine Yonetimi</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openEkipmanForm(${p.id})" class="px-3 py-1.5 bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const eks=p.ekipmanlar||[];if(eks.length===0)return;
        const topMaliyet=eks.reduce((s,e)=>{const gun=(e.calismaKayitlari||[]).length;return s+gun*e.gunlukMaliyet;},0);
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-1 text-yellow-400">${p.name}</h5><p class="text-xs text-gray-400 mb-3">Toplam Maliyet: <span class="text-yellow-400 font-bold">\u20BA${fmt(topMaliyet)}</span></p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${eks.map(e=>{
            const topSaat=(e.calismaKayitlari||[]).reduce((s,c)=>s+c.saat,0);
            const topYakit=(e.yakitKayitlari||[]).reduce((s,y)=>s+y.litre,0);
            const bakimSay=(e.bakimlar||[]).length;
            const sahipCol=e.sahiplik==='ozmal'?'green':'amber';
            return `<div class="glass rounded-lg p-3"><div class="flex justify-between items-start mb-2"><div><p class="font-bold text-sm">${e.ad}</p><p class="text-[10px] text-gray-500">${e.tip} ${e.plaka?'| '+e.plaka:''}</p></div><span class="px-2 py-0.5 rounded text-[10px] bg-${sahipCol}-600/20 text-${sahipCol}-400">${e.sahiplik==='ozmal'?'Oz Mal':'Kiralik'}</span></div>
            <div class="grid grid-cols-3 gap-2 text-center mb-2"><div><p class="text-lg font-bold text-blue-400">${topSaat}</p><p class="text-[9px] text-gray-500">Saat</p></div><div><p class="text-lg font-bold text-red-400">${topYakit}L</p><p class="text-[9px] text-gray-500">Yakit</p></div><div><p class="text-lg font-bold text-purple-400">${bakimSay}</p><p class="text-[9px] text-gray-500">Bakim</p></div></div>
            <div class="flex gap-1"><button onclick="openEkipmanKayitForm(${p.id},${e.id})" class="flex-1 px-2 py-1 bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600/40 rounded text-[10px]">+ Kayit</button></div></div>`;
        }).join('')}</div></div>`;
    });
    if(!html.includes('text-yellow-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz ekipman kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== IS PROGRAMI =====================
function openIsProgramiForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('ip-project-id').value=projectId;
    document.getElementById('ip-ad').value='';document.getElementById('ip-baslangic').value='';document.getElementById('ip-sure').value='';
    document.getElementById('ip-sorumlu').value='';document.getElementById('ip-ilerleme').value='0';
    const bagSel=document.getElementById('ip-bagimlilik');bagSel.innerHTML='<option value="">Yok</option>';
    (p.isProgrami||[]).forEach(a=>bagSel.innerHTML+=`<option value="${a.id}">${a.ad}</option>`);
    document.getElementById('ip-bagimlilik-tip').value='FS';
    openModal('modal-is-programi');
}
function addIsProgramiAktivite(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('ip-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.isProgrami)p.isProgrami=[];
    p.isProgrami.push({id:Date.now(),ad:f.get('ad'),baslangic:f.get('baslangic'),sure:+f.get('sure')||1,bagimlilik:+f.get('bagimlilik')||0,bagimlilikTip:f.get('bagimlilikTip')||'FS',sorumlu:f.get('sorumlu')||'',ilerleme:+f.get('ilerleme')||0});
    act(p.name+' - Is programi: '+f.get('ad'));save();renderAll();closeModal('modal-is-programi');e.target.reset();showNotif('Aktivite eklendi!');
}
function renderIsProgramiTab(){
    const c=document.getElementById('is-programi-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Is Programi (Detayli)</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openIsProgramiForm(${p.id})" class="px-3 py-1.5 bg-teal-600/20 text-teal-400 hover:bg-teal-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    S.projects.forEach(p=>{
        const ip=p.isProgrami||[];if(ip.length===0)return;
        // Calculate dates for Gantt-like display
        const allDates=ip.filter(a=>a.baslangic).map(a=>{const s=new Date(a.baslangic);const e2=new Date(s);e2.setDate(e2.getDate()+a.sure);return{s,e:e2};});
        const minD=allDates.length>0?new Date(Math.min(...allDates.map(d=>d.s.getTime()))):new Date();
        const maxD=allDates.length>0?new Date(Math.max(...allDates.map(d=>d.e.getTime()))):new Date();
        const totalDays=Math.max(Math.ceil((maxD-minD)/(1000*60*60*24)),1);
        const geciken=ip.filter(a=>{if(!a.baslangic)return false;const bitisDate=new Date(a.baslangic);bitisDate.setDate(bitisDate.getDate()+a.sure);return a.ilerleme<100&&bitisDate<new Date();});
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-1 text-teal-400">${p.name}</h5>`;
        if(geciken.length>0)html+=`<div class="bg-red-900/30 border border-red-800 rounded-lg p-2 mb-3 text-xs text-red-300">&#9888; ${geciken.length} geciken aktivite: ${geciken.map(g=>g.ad).join(', ')}</div>`;
        html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left w-40">Aktivite</th><th class="p-2 text-left w-20">Baslangic</th><th class="p-2 text-center w-12">Sure</th><th class="p-2 text-center w-16">Ilerleme</th><th class="p-2 text-left">Gantt</th></tr></thead><tbody>${ip.map(a=>{
            const start=a.baslangic?new Date(a.baslangic):minD;
            const offsetPct=totalDays>0?((start-minD)/(1000*60*60*24)/totalDays*100):0;
            const widthPct=totalDays>0?(a.sure/totalDays*100):10;
            const isGeciken=geciken.some(g=>g.id===a.id);
            const barColor=isGeciken?'bg-red-500':a.ilerleme>=100?'bg-green-500':'bg-teal-500';
            const bagDep=a.bagimlilik?ip.find(x=>x.id===a.bagimlilik):null;
            return `<tr class="border-b border-gray-800"><td class="p-2"><p class="font-medium ${isGeciken?'text-red-400':''}">${a.ad}</p><p class="text-[9px] text-gray-600">${a.sorumlu||'-'}${bagDep?' | Bag: '+bagDep.ad:''}</p></td><td class="p-2">${a.baslangic||'-'}</td><td class="p-2 text-center">${a.sure}g</td><td class="p-2 text-center"><span class="${a.ilerleme>=100?'text-green-400':isGeciken?'text-red-400':'text-teal-400'} font-bold">${a.ilerleme}%</span></td><td class="p-2"><div class="relative h-4 bg-gray-800 rounded overflow-hidden"><div class="${barColor} h-full rounded" style="margin-left:${offsetPct}%;width:${widthPct}%;opacity:0.3"></div><div class="${barColor} h-full rounded absolute top-0" style="margin-left:${offsetPct}%;width:${widthPct*a.ilerleme/100}%"></div></div></td></tr>`;
        }).join('')}</tbody></table></div></div>`;
    });
    if(!html.includes('text-teal-400">')){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz is programi kaydi yok.</p></div>';}
    c.innerHTML=html;
}

// ===================== ISG (Is Sagligi Guvenligi) =====================
function openIsgForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('isg-project-id').value=projectId;
    document.getElementById('isg-kayit-tip').value='risk';toggleIsgTip();
    document.getElementById('isg-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('isg-aciklama').value='';document.getElementById('isg-konum').value='';
    document.getElementById('isg-risk-seviye').value='orta';document.getElementById('isg-kaza-tipi').value='';
    document.getElementById('isg-yarali').value='0';document.getElementById('isg-egitim-konu').value='';
    document.getElementById('isg-katilimci').value='';document.getElementById('isg-denetim-sonuc').value='uygun';
    openModal('modal-isg');
}
function toggleIsgTip(){
    const tip=document.getElementById('isg-kayit-tip').value;
    ['risk','kaza','egitim','denetim'].forEach(t=>document.getElementById('isg-'+t+'-fields').style.display=t===tip?'block':'none');
}
function addIsgKayit(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('isg-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.isg)p.isg={riskler:[],kazalar:[],egitimler:[],denetimler:[]};
    const tip=f.get('kayitTip');const tarih=f.get('tarih');const aciklama=f.get('aciklama')||'';const konum=f.get('konum')||'';
    if(tip==='risk')p.isg.riskler.push({id:Date.now(),tarih,aciklama,konum,seviye:f.get('riskSeviye')});
    else if(tip==='kaza')p.isg.kazalar.push({id:Date.now(),tarih,aciklama,konum,kazaTipi:f.get('kazaTipi'),yarali:+f.get('yarali')||0});
    else if(tip==='egitim')p.isg.egitimler.push({id:Date.now(),tarih,konu:f.get('egitimKonu'),katilimci:+f.get('katilimci')||0});
    else p.isg.denetimler.push({id:Date.now(),tarih,aciklama,sonuc:f.get('denetimSonuc')});
    act(p.name+' - ISG kaydi: '+tip);save();renderAll();closeModal('modal-isg');e.target.reset();showNotif('ISG kaydi eklendi!');
}
function renderIsgTab(){
    const c=document.getElementById('isg-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Is Sagligi ve Guvenligi (ISG)</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openIsgForm(${p.id})" class="px-3 py-1.5 bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    let hasData=false;
    S.projects.forEach(p=>{
        const isg=p.isg||{riskler:[],kazalar:[],egitimler:[],denetimler:[]};
        const totalR=(isg.riskler||[]).length,totalK=(isg.kazalar||[]).length,totalE=(isg.egitimler||[]).length,totalD=(isg.denetimler||[]).length;
        if(totalR+totalK+totalE+totalD===0)return;
        hasData=true;
        const yuksekRisk=(isg.riskler||[]).filter(r=>r.seviye==='yuksek'||r.seviye==='kritik').length;
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-red-400">${p.name}</h5>
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Riskler</p><p class="text-xl font-bold text-amber-400">${totalR}</p>${yuksekRisk>0?`<p class="text-[9px] text-red-400">${yuksekRisk} yuksek/kritik</p>`:''}</div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Kazalar</p><p class="text-xl font-bold text-red-400">${totalK}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Egitimler</p><p class="text-xl font-bold text-blue-400">${totalE}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Denetimler</p><p class="text-xl font-bold text-green-400">${totalD}</p></div>
        </div>`;
        // Riskler
        if(totalR>0){
            const seviyeCol={dusuk:'green',orta:'amber',yuksek:'orange',kritik:'red'};
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Risk Degerlendirme</p><div class="space-y-1 mb-3">${(isg.riskler||[]).map(r=>{
                const col=seviyeCol[r.seviye]||'gray';
                return `<div class="flex items-center gap-2 glass rounded p-2 text-xs"><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-${col}-600/20 text-${col}-400">${(r.seviye||'').toUpperCase()}</span><span class="flex-1">${r.aciklama}</span><span class="text-gray-500">${r.konum||''}</span><span class="text-gray-600">${r.tarih}</span></div>`;
            }).join('')}</div>`;
        }
        // Kazalar
        if(totalK>0){
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Kaza Kayitlari</p><div class="space-y-1 mb-3">${(isg.kazalar||[]).map(k=>`<div class="flex items-center gap-2 glass rounded p-2 text-xs border-l-2 border-red-500"><span class="text-red-400 font-bold">${k.tarih}</span><span class="flex-1">${k.aciklama} ${k.kazaTipi?'('+k.kazaTipi+')':''}</span><span class="text-red-400">${k.yarali||0} yarali</span></div>`).join('')}</div>`;
        }
        // Egitimler
        if(totalE>0){
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Egitim Kayitlari</p><div class="space-y-1 mb-3">${(isg.egitimler||[]).map(e2=>`<div class="flex items-center gap-2 glass rounded p-2 text-xs"><span class="text-blue-400">${e2.tarih}</span><span class="flex-1 font-medium">${e2.konu}</span><span class="text-blue-400">${e2.katilimci} kisi</span></div>`).join('')}</div>`;
        }
        // Denetimler
        if(totalD>0){
            const sonucCol={uygun:'green',sartli:'amber',uygunsuz:'red'};
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Denetim Kayitlari</p><div class="space-y-1 mb-3">${(isg.denetimler||[]).map(d=>{
                const col=sonucCol[d.sonuc]||'gray';
                return `<div class="flex items-center gap-2 glass rounded p-2 text-xs"><span class="text-gray-400">${d.tarih}</span><span class="flex-1">${d.aciklama}</span><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-${col}-600/20 text-${col}-400">${d.sonuc}</span></div>`;
            }).join('')}</div>`;
        }
        html+=`</div>`;
    });
    if(!hasData)html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz ISG kaydi yok.</p></div>';
    c.innerHTML=html;
}

// ===================== KALITE KONTROL =====================
function openKaliteForm(projectId){
    const p=S.projects.find(x=>x.id===projectId);if(!p)return;
    document.getElementById('kk-project-id').value=projectId;
    document.getElementById('kk-kayit-tip').value='test';toggleKaliteTip();
    document.getElementById('kk-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('kk-aciklama').value='';document.getElementById('kk-konum').value='';
    document.getElementById('kk-test-sonuc').value='gecti';document.getElementById('kk-ncr-no').value='';
    document.getElementById('kk-ncr-durum').value='acik';document.getElementById('kk-punch-oncelik').value='normal';
    openModal('modal-kalite');
}
function toggleKaliteTip(){
    const tip=document.getElementById('kk-kayit-tip').value;
    ['test','ncr','punch'].forEach(t=>document.getElementById('kk-'+t+'-fields').style.display=t===tip?'block':'none');
}
function addKaliteKayit(e){
    e.preventDefault();const f=new FormData(e.target);
    const pid=+document.getElementById('kk-project-id').value;const p=S.projects.find(x=>x.id===pid);if(!p)return;
    if(!p.kaliteKontrol)p.kaliteKontrol={testler:[],ncrler:[],punchList:[]};
    const tip=f.get('kayitTip');const tarih=f.get('tarih');const aciklama=f.get('aciklama')||'';const konum=f.get('konum')||'';
    if(tip==='test')p.kaliteKontrol.testler.push({id:Date.now(),tarih,aciklama,konum,sonuc:f.get('testSonuc')});
    else if(tip==='ncr')p.kaliteKontrol.ncrler.push({id:Date.now(),tarih,aciklama,no:f.get('ncrNo'),durum:f.get('ncrDurum')});
    else p.kaliteKontrol.punchList.push({id:Date.now(),tarih,aciklama,konum,oncelik:f.get('punchOncelik'),done:false});
    act(p.name+' - Kalite kaydi: '+tip);save();renderAll();closeModal('modal-kalite');e.target.reset();showNotif('Kalite kaydi eklendi!');
}
function togglePunchDone(projectId,punchId){
    const p=S.projects.find(x=>x.id===projectId);if(!p||!p.kaliteKontrol)return;
    const punch=p.kaliteKontrol.punchList.find(x=>x.id===punchId);if(punch)punch.done=!punch.done;
    save();renderKaliteKontrolTab();
}
function renderKaliteKontrolTab(){
    const c=document.getElementById('kalite-kontrol-view');
    if(S.projects.length===0){c.innerHTML='<p class="text-gray-500 text-sm">Proje ekleyin.</p>';return;}
    let html='<div class="flex items-center justify-between mb-4"><h4 class="text-sm font-semibold">Kalite Kontrol</h4><div class="flex gap-2">'+S.projects.map(p=>`<button onclick="openKaliteForm(${p.id})" class="px-3 py-1.5 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/40 rounded text-xs">+ ${p.name}</button>`).join('')+'</div></div>';
    let hasData=false;
    S.projects.forEach(p=>{
        const kk=p.kaliteKontrol||{testler:[],ncrler:[],punchList:[]};
        const totalT=(kk.testler||[]).length,totalN=(kk.ncrler||[]).length,totalP=(kk.punchList||[]).length;
        if(totalT+totalN+totalP===0)return;
        hasData=true;
        const passRate=totalT>0?Math.round((kk.testler||[]).filter(t=>t.sonuc==='gecti').length/totalT*100):0;
        const openNcr=(kk.ncrler||[]).filter(n=>n.durum==='acik').length;
        const donePunch=(kk.punchList||[]).filter(p2=>p2.done).length;
        html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-sm font-bold mb-3 text-emerald-400">${p.name}</h5>
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Pass Rate</p><p class="text-xl font-bold ${passRate>=80?'text-green-400':passRate>=50?'text-amber-400':'text-red-400'}">${passRate}%</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Testler</p><p class="text-xl font-bold text-blue-400">${totalT}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Acik NCR</p><p class="text-xl font-bold ${openNcr>0?'text-red-400':'text-green-400'}">${openNcr}</p></div>
            <div class="glass rounded-lg p-3 text-center"><p class="text-xs text-gray-400">Punch List</p><p class="text-xl font-bold text-amber-400">${donePunch}/${totalP}</p></div>
        </div>`;
        // Testler
        if(totalT>0){
            const sonucCol={gecti:'green',kaldi:'red',sartli:'amber'};
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Test Sonuclari</p><div class="overflow-x-auto mb-3"><table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700"><th class="p-2 text-left">Tarih</th><th class="p-2 text-left">Aciklama</th><th class="p-2 text-left">Konum</th><th class="p-2 text-center">Sonuc</th></tr></thead><tbody>${(kk.testler||[]).map(t=>{
                const col=sonucCol[t.sonuc]||'gray';
                return `<tr class="border-b border-gray-800"><td class="p-2">${t.tarih}</td><td class="p-2">${t.aciklama}</td><td class="p-2">${t.konum||'-'}</td><td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-${col}-600/20 text-${col}-400">${t.sonuc}</span></td></tr>`;
            }).join('')}</tbody></table></div>`;
        }
        // NCR
        if(totalN>0){
            const ncrCol={acik:'red',inceleniyor:'amber',kapandi:'green'};
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">NCR (Uygunsuzluk Raporlari)</p><div class="space-y-1 mb-3">${(kk.ncrler||[]).map(n=>{
                const col=ncrCol[n.durum]||'gray';
                return `<div class="flex items-center gap-2 glass rounded p-2 text-xs"><span class="font-bold text-red-300">${n.no||'NCR'}</span><span class="text-gray-400">${n.tarih}</span><span class="flex-1">${n.aciklama}</span><span class="px-2 py-0.5 rounded text-[10px] bg-${col}-600/20 text-${col}-400">${n.durum}</span></div>`;
            }).join('')}</div>`;
        }
        // Punch List
        if(totalP>0){
            const oncCol={dusuk:'green',normal:'amber',yuksek:'red'};
            html+=`<p class="text-xs text-gray-400 mb-2 font-semibold">Punch List</p><div class="space-y-1 mb-3">${(kk.punchList||[]).map(pl=>{
                const col=oncCol[pl.oncelik]||'gray';
                return `<div class="flex items-center gap-2 glass rounded p-2 text-xs cursor-pointer" onclick="togglePunchDone(${p.id},${pl.id})"><input type="checkbox" ${pl.done?'checked':''} class="pointer-events-none"><span class="${pl.done?'line-through text-gray-600':''}  flex-1">${pl.aciklama}</span><span class="text-gray-500">${pl.konum||''}</span><span class="px-2 py-0.5 rounded text-[10px] bg-${col}-600/20 text-${col}-400">${pl.oncelik}</span></div>`;
            }).join('')}</div>`;
        }
        html+=`</div>`;
    });
    if(!hasData)html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz kalite kontrol kaydi yok.</p></div>';
    c.innerHTML=html;
}

// ===================== FAON-DEPO MODULE =====================
function getDepoKategoriler(){const o={};(S.depoKategoriler||[]).forEach(k=>o[k.key]=k.ad);return o;}
function getDepoKatColors(){const o={};(S.depoKategoriler||[]).forEach(k=>o[k.key]=`bg-${k.renk}-500/20 text-${k.renk}-400`);return o;}
const RENK_PALETI=['orange','blue','purple','cyan','amber','green','red','pink','teal','indigo','gray'];

// Kategori Yonetimi (Ayarlar)
function renderKategoriAyarlari(){
    const c=document.getElementById('kategoriler-view');if(!c)return;
    const kats=S.depoKategoriler||[];
    let html=`<h4 class="font-semibold text-sm mb-4">Envanter Kategorileri</h4>`;
    html+=`<div class="mb-4 glass rounded-lg p-3"><p class="text-[10px] text-gray-400 mb-2">Yeni Kategori Ekle</p><div class="flex gap-2 items-end">
        <div class="flex-1"><label class="text-[10px] text-gray-500 block mb-1">Anahtar (kucuk harf, bosluksuz)</label><input id="kat-new-key" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="orn: elektrik"></div>
        <div class="flex-1"><label class="text-[10px] text-gray-500 block mb-1">Goruntu Adi</label><input id="kat-new-ad" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" placeholder="orn: Elektrik"></div>
        <div><label class="text-[10px] text-gray-500 block mb-1">Renk</label><select id="kat-new-renk" class="bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs">${RENK_PALETI.map(r=>`<option value="${r}">${r}</option>`).join('')}</select></div>
        <button onclick="addDepoKategori()" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs text-white">Ekle</button>
    </div></div>`;
    html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Anahtar</th><th class="p-2">Ad</th><th class="p-2">Renk</th><th class="p-2">Onizleme</th><th class="p-2">Envanter</th><th class="p-2">Islem</th></tr></thead><tbody>`;
    kats.forEach(k=>{
        const cnt=(S.envanter||[]).filter(i=>i.kategori===k.key).length;
        html+=`<tr class="border-b border-gray-800"><td class="p-2 font-mono">${k.key}</td><td class="p-2">${k.ad}</td><td class="p-2">${k.renk}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-[9px] bg-${k.renk}-500/20 text-${k.renk}-400">${k.ad}</span></td><td class="p-2">${cnt} kalem</td><td class="p-2"><button onclick="removeDepoKategori('${k.key}')" class="text-red-400 hover:text-red-300 text-[10px]">${cnt>0?'(kullanimda)':'Sil'}</button></td></tr>`;
    });
    html+=`</tbody></table></div>`;
    c.innerHTML=html;
}
function addDepoKategori(){
    const key=document.getElementById('kat-new-key').value.trim().toLowerCase().replace(/[^a-z0-9]/g,'');
    const ad=document.getElementById('kat-new-ad').value.trim();
    const renk=document.getElementById('kat-new-renk').value;
    if(!key||!ad){showNotif('Anahtar ve ad girin.');return;}
    if((S.depoKategoriler||[]).some(k=>k.key===key)){showNotif('Bu anahtar zaten mevcut.');return;}
    S.depoKategoriler.push({key,ad,renk});
    save();renderKategoriAyarlari();showNotif('Kategori eklendi: '+ad);
}
function removeDepoKategori(key){
    const cnt=(S.envanter||[]).filter(i=>i.kategori===key).length;
    if(cnt>0){showNotif('Bu kategoride '+cnt+' envanter var. Once envanteri baska kategoriye tasyin.');return;}
    S.depoKategoriler=S.depoKategoriler.filter(k=>k.key!==key);
    save();renderKategoriAyarlari();showNotif('Kategori silindi.');
}

function renderBildirimAyarlari(){
    const c=document.getElementById('bildirim-ayarlar-view');if(!c)return;
    const ay=S.bildirimAyarlar||{};
    const esikler=ay.belgeEsikler||{};
    const km=ay.kmBakimHatirlatma||{};
    const filo=ay.filoSorumlusu||{};
    const dr=ay.departmanRouting||{};
    const kat=ay.kategoriler||{};
    const seviyeOpts=['bilgi','uyari','kritik','acil'];
    const seviyeLabels={bilgi:'Bilgi',uyari:'Uyari',kritik:'Kritik',acil:'Acil'};
    const rolOpts=['Yonetici','Proje Muduru','Muhasebe','Satin Alma','Satis','Izleyici'];
    function sevSel(id,val){return `<select id="${id}" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-[11px]">${seviyeOpts.map(s=>`<option value="${s}" ${val===s?'selected':''}>${seviyeLabels[s]}</option>`).join('')}</select>`;}
    let html=`<h4 class="text-sm font-bold mb-4">Bildirim Ayarlari</h4>`;
    // Bolum 1: Belge Esikleri
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-amber-400 mb-3">Belge Suresi Uyari Esikleri</h5><div class="space-y-2">`;
    const esikItems=[{key:'gun60',label:'60 gun oncesi'},{key:'gun30',label:'30 gun oncesi'},{key:'gun7',label:'7 gun oncesi'},{key:'gun0',label:'Sure dolunca (gecmis)'}];
    esikItems.forEach(e=>{
        const cfg=esikler[e.key]||{aktif:true,seviye:'bilgi'};
        html+=`<div class="flex items-center gap-3"><label class="flex items-center gap-2 w-48"><input type="checkbox" id="be-${e.key}-aktif" ${cfg.aktif?'checked':''} class="rounded"> <span class="text-xs">${e.label}</span></label>${sevSel('be-'+e.key+'-seviye',cfg.seviye)}</div>`;
    });
    html+=`</div></div>`;
    // Bolum 2: KM Bakim
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-blue-400 mb-3">KM Bazli Bakim Hatirlatmasi</h5>
        <div class="flex items-center gap-3 mb-2"><label class="flex items-center gap-2"><input type="checkbox" id="km-aktif" ${km.aktif?'checked':''} class="rounded"> <span class="text-xs">Aktif</span></label></div>
        <div class="flex items-center gap-3"><label class="text-xs w-32">Bakim Araligi (km):</label><input type="number" id="km-aralik" value="${km.aralik||10000}" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs w-28" step="1000" min="1000">
        <label class="text-xs ml-3">Seviye:</label>${sevSel('km-seviye',km.seviye||'uyari')}</div></div>`;
    // Bolum 3: Filo Sorumlusu
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-green-400 mb-3">Filo Sorumlusu</h5>
        <div class="flex items-center gap-3 mb-2"><label class="text-xs w-32">Sorumlu Kisi:</label><select id="filo-sorumlu" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs"><option value="">-- Atanmamis --</option>${S.users.map(u=>`<option value="${u.id}" ${filo.userId===u.id?'selected':''}>${u.name} (${u.role})</option>`).join('')}</select></div>
        <label class="flex items-center gap-2"><input type="checkbox" id="filo-tum" ${filo.tumBildirimleriAl!==false?'checked':''} class="rounded"> <span class="text-xs">Tum arac bildirimlerini alsin</span></label></div>`;
    // Bolum 4: Departman Yonlendirme
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-purple-400 mb-3">Departman Yonlendirme</h5><div class="space-y-2">`;
    const deptLabels={santiye:'Santiye',ofis:'Ofis',yonetim:'Yonetim',muhasebe:'Muhasebe',diger:'Diger'};
    Object.keys(deptLabels).forEach(d=>{
        const cfg=dr[d]||{aktif:false,hedefRol:null};
        html+=`<div class="flex items-center gap-3"><label class="flex items-center gap-2 w-32"><input type="checkbox" id="dr-${d}-aktif" ${cfg.aktif?'checked':''} class="rounded"> <span class="text-xs">${deptLabels[d]}</span></label><select id="dr-${d}-rol" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-[11px]"><option value="">-- Rol Sec --</option>${rolOpts.map(r=>`<option value="${r}" ${cfg.hedefRol===r?'selected':''}>${r}</option>`).join('')}</select></div>`;
    });
    html+=`</div></div>`;
    // Bolum 5: Kategori Ayarlari
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-cyan-400 mb-3">Bildirim Kategorileri</h5><div class="space-y-2">`;
    const katLabels={'arac-filo':'Arac / Filo Bildirimleri','envanter':'Envanter Bildirimleri','genel':'Genel Bildirimler'};
    Object.keys(katLabels).forEach(k=>{
        html+=`<label class="flex items-center gap-2"><input type="checkbox" id="kat-${k}" ${kat[k]!==false?'checked':''} class="rounded"> <span class="text-xs">${katLabels[k]}</span></label>`;
    });
    html+=`</div></div>`;
    // Bolum 6: Tercihler
    html+=`<div class="glass rounded-xl p-4 mb-4"><h5 class="text-xs font-semibold text-gray-300 mb-3">Tercihler</h5><div class="space-y-2">
        <label class="flex items-center gap-2"><input type="checkbox" id="ba-girisModal" ${ay.girisModalGoster!==false?'checked':''} class="rounded"> <span class="text-xs">Giris sirasinda kritik uyari modali goster</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" id="ba-ses" ${ay.sesAktif?'checked':''} class="rounded"> <span class="text-xs">Bildirim sesi</span></label>
    </div></div>`;
    // Kaydet + Kontrolleri Calistir
    html+=`<div class="flex gap-3"><button onclick="saveBildirimAyarlari()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">Ayarlari Kaydet</button><button onclick="tumKontrolleriCalistir();renderBildirimAyarlari();showNotif('Bildirim kontrolleri calistirildi.')" class="px-4 py-2 glass rounded-lg text-xs hover:bg-gray-700/50 transition-colors">Kontrolleri Tekrar Calistir</button></div>`;
    // Mevcut bildirim ozeti
    const gorunenler=bildirimlerKullanicininGoregi();
    html+=`<div class="mt-4 glass rounded-xl p-3"><p class="text-[10px] text-gray-400">Toplam ${gorunenler.length} bildirim (${gorunenler.filter(b=>!b.okunduDurumu||!b.okunduDurumu[(currentUser?currentUser.id:1)]).length} okunmamis)</p></div>`;
    c.innerHTML=html;
}
function saveBildirimAyarlari(){
    const ay=S.bildirimAyarlar;
    // Belge esikleri
    ['gun60','gun30','gun7','gun0'].forEach(k=>{
        const aktifEl=document.getElementById('be-'+k+'-aktif');
        const sevEl=document.getElementById('be-'+k+'-seviye');
        if(aktifEl&&sevEl){
            if(!ay.belgeEsikler)ay.belgeEsikler={};
            ay.belgeEsikler[k]={aktif:aktifEl.checked,seviye:sevEl.value};
        }
    });
    // KM
    const kmA=document.getElementById('km-aktif');
    const kmAr=document.getElementById('km-aralik');
    const kmS=document.getElementById('km-seviye');
    if(kmA)ay.kmBakimHatirlatma={aktif:kmA.checked,aralik:parseInt(kmAr?.value)||10000,seviye:kmS?.value||'uyari'};
    // Filo sorumlusu
    const filoS=document.getElementById('filo-sorumlu');
    const filoT=document.getElementById('filo-tum');
    if(filoS)ay.filoSorumlusu={userId:filoS.value?parseInt(filoS.value):null,tumBildirimleriAl:filoT?filoT.checked:true};
    // Departman routing
    ['santiye','ofis','yonetim','muhasebe','diger'].forEach(d=>{
        const aktifEl=document.getElementById('dr-'+d+'-aktif');
        const rolEl=document.getElementById('dr-'+d+'-rol');
        if(aktifEl&&rolEl){
            if(!ay.departmanRouting)ay.departmanRouting={};
            ay.departmanRouting[d]={aktif:aktifEl.checked,hedefRol:rolEl.value||null};
        }
    });
    // Kategoriler
    ['arac-filo','envanter','genel'].forEach(k=>{
        const el=document.getElementById('kat-'+k);
        if(el){if(!ay.kategoriler)ay.kategoriler={};ay.kategoriler[k]=el.checked;}
    });
    // Tercihler
    const gmEl=document.getElementById('ba-girisModal');
    const sesEl=document.getElementById('ba-ses');
    if(gmEl)ay.girisModalGoster=gmEl.checked;
    if(sesEl)ay.sesAktif=sesEl.checked;
    save();showNotif('Bildirim ayarlari kaydedildi.');
}

// ===================== BELGE SABLONLARI YONETIMI =====================
function renderBelgeSablonlari(){
    const c=document.getElementById('belge-sablonlari-view');if(!c)return;
    if(!S.belgeSablonlari)S.belgeSablonlari={};
    const sablonlar=HR_BELGE_SABLONLARI;
    let html=`<h4 class="text-sm font-bold mb-2">HR Belge Sablonlari</h4>
    <p class="text-[10px] text-gray-400 mb-4">Personel belge paketinde kullanilan belge iceriklerini duzenleyebilirsiniz. Her belge madde madde satirlardan olusur. Bos birakilan sablonlarda varsayilan metin kullanilir.</p>`;
    sablonlar.forEach(s=>{
        const mevcut=S.belgeSablonlari[s.id]||null;
        const expanded=mevcut?'true':'false';
        html+=`<div class="glass rounded-xl p-4 mb-3">
<div class="flex items-center justify-between cursor-pointer" onclick="toggleBelgeSablon('${s.id}')">
<div class="flex items-center gap-2"><span class="text-base">${s.icon}</span><h5 class="text-xs font-semibold">${s.baslik}</h5>${mevcut?'<span class="text-[9px] px-1.5 py-0.5 rounded bg-teal-500/20 text-teal-400">Ozel</span>':'<span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-500/20 text-gray-400">Varsayilan</span>'}</div>
<span class="text-gray-400 text-xs" id="bs-arrow-${s.id}">&#9660;</span>
</div>
<div id="bs-content-${s.id}" class="hidden mt-3">
<p class="text-[10px] text-gray-500 mb-2">Her satir bir madde olarak belgeye eklenir. <b>BASLIK:</b> ile baslayan satirlar bolum basligi olur. <b>**metin**</b> kalin yazar. Bos satirlar ayirici olur.</p>
<textarea id="bs-text-${s.id}" rows="12" class="w-full bg-gray-900/80 border border-gray-700 rounded-lg px-3 py-2 text-[11px] font-mono leading-relaxed" placeholder="Varsayilan sablon kullaniliyor...">${mevcut||''}</textarea>
<div class="flex gap-2 mt-2">
<button onclick="saveBelgeSablonu('${s.id}')" class="px-4 py-1.5 bg-teal-600 hover:bg-teal-700 rounded-lg text-[11px] transition-colors">Kaydet</button>
<button onclick="resetBelgeSablonu('${s.id}')" class="px-4 py-1.5 glass hover:bg-gray-700/50 rounded-lg text-[11px] transition-colors text-gray-400">Varsayilana Don</button>
<button onclick="previewBelgeSablonu('${s.id}')" class="px-4 py-1.5 glass hover:bg-blue-600/20 rounded-lg text-[11px] transition-colors text-blue-400">Onizleme</button>
</div>
</div></div>`;
    });
    html+=`<div class="mt-4 glass rounded-xl p-3"><p class="text-[10px] text-gray-400">&#128161; <b>Ipucu:</b> Belge sablonlarinda {AD_SOYAD}, {TC_KIMLIK}, {DEPARTMAN}, {GOREV}, {ISE_GIRIS}, {TARIH}, {MAAS} degiskenleri kullanabilirsiniz. Yazdirma sirasinda bu degerler otomatik olarak personel bilgileriyle degistirilir.</p></div>`;
    c.innerHTML=html;
}
function toggleBelgeSablon(id){
    const el=document.getElementById('bs-content-'+id);
    if(el)el.classList.toggle('hidden');
}
function saveBelgeSablonu(id){
    const txt=document.getElementById('bs-text-'+id);
    if(!txt)return;
    if(!S.belgeSablonlari)S.belgeSablonlari={};
    const val=txt.value.trim();
    if(val){
        S.belgeSablonlari[id]=val;
    }else{
        delete S.belgeSablonlari[id];
    }
    save();showNotif('Belge sablonu kaydedildi: '+HR_BELGE_SABLONLARI.find(s=>s.id===id)?.baslik);
    renderBelgeSablonlari();
}
function resetBelgeSablonu(id){
    if(!confirm('Bu belge sablonunu varsayilana dondurmek istediginize emin misiniz?'))return;
    if(S.belgeSablonlari)delete S.belgeSablonlari[id];
    save();showNotif('Sablon varsayilana donduruldu.');
    renderBelgeSablonlari();
}
function previewBelgeSablonu(sablonId){
    // Ornek personel ile onizleme
    const ornekPersonel={ad:'Ornek',soyad:'Personel',tcKimlikNo:'12345678901',departmanId:(S.departmanlar||[])[0]?.id||'',gorevi:'Yazilim Gelistirici',iseGirisTarihi:new Date().toISOString().slice(0,10),calismaTipi:'tam_zamanli',maas:50000};
    const belgeHTML=generateHrBelgeHTML(sablonId,ornekPersonel);
    const fullHTML=`<!DOCTYPE html><html><head><title>Onizleme</title><style>${BELGE_STIL}</style></head><body>${belgeHTML}</body></html>`;
    const frame=document.getElementById('print-frame');
    const doc=frame.contentDocument||frame.contentWindow.document;
    doc.open();doc.write(fullHTML);doc.close();
    setTimeout(()=>{frame.contentWindow.focus();frame.contentWindow.print();},400);
}

const DEPO_TIP_LABELS={merkez:'Merkez Depo',santiye:'Santiye Deposu',ofis:'Ofis Deposu'};
const HAREKET_TIP_LABELS={giris:'Giris',cikis:'Cikis',transfer:'Transfer',fire:'Fire/Kayip',iade:'Iade',projeye:'Projeye Cikis'};
const HAREKET_DURUM_LABELS={tamamlandi:'Tamamlandi',talep:'Talep',onaylandi:'Onaylandi',reddedildi:'Reddedildi'};
const HAREKET_DURUM_COLORS={tamamlandi:'bg-green-500/20 text-green-400',talep:'bg-blue-500/20 text-blue-400',onaylandi:'bg-amber-500/20 text-amber-400',reddedildi:'bg-red-500/20 text-red-400'};
let depoItemResim=null;
const HAREKET_TIP_COLORS={giris:'bg-green-500/20 text-green-400',cikis:'bg-red-500/20 text-red-400',transfer:'bg-blue-500/20 text-blue-400',fire:'bg-orange-500/20 text-orange-400',iade:'bg-purple-500/20 text-purple-400',projeye:'bg-cyan-500/20 text-cyan-400'};

function switchDepoTab(tab){
    ['envanter','depolar','hareketler','sayim','zimmet','arac'].forEach(t=>{
        const el=document.getElementById('depo-tab-'+t);if(el)el.classList.toggle('hidden',t!==tab);
    });
    document.querySelectorAll('#module-depo .tab-btn').forEach((b,i)=>b.classList.toggle('active',['envanter','depolar','hareketler','sayim','zimmet','arac'][i]===tab));
    const btn=document.getElementById('depo-add-btn');
    if(tab==='envanter'){btn.textContent='+ Envanter Ekle';btn.onclick=()=>openDepoItemForm();}
    else if(tab==='depolar'){btn.textContent='+ Depo Ekle';btn.onclick=()=>openDepoTesisForm();}
    else if(tab==='hareketler'){btn.textContent='+ Hareket Kaydet';btn.onclick=()=>openDepoHareketForm();}
    else if(tab==='sayim'){btn.textContent='+ Sayim Baslat';btn.onclick=()=>openDepoSayimForm();}
    else if(tab==='zimmet'){btn.textContent='+ Zimmet Ver';btn.onclick=()=>openZimmetForm();}
    else if(tab==='arac'){btn.textContent='+ Arac Ekle';btn.onclick=()=>openAracForm();}
    if(tab==='envanter')renderDepoEnvanter();
    if(tab==='depolar')renderDepolar();
    if(tab==='hareketler')renderDepoHareketler();
    if(tab==='sayim')renderDepoSayim();
    if(tab==='zimmet')renderDepoZimmet();
    if(tab==='arac')renderDepoArac();
}
function renderDepoModule(){
    const badge=document.getElementById('depo-badge');
    if(badge)badge.textContent=(S.envanter||[]).length+(S.araclar||[]).length;
    renderDepoEnvanter();
}
function renderDepoEnvanter(){
    const c=document.getElementById('depo-tab-envanter');if(!c)return;
    const items=S.envanter||[];
    const lowStock=items.filter(i=>i.minStok>0&&i.miktar<=i.minStok);
    let html='';
    // Excel butonlari
    html+=`<div class="flex flex-wrap gap-2 mb-3"><button onclick="openDepoExcelImport()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-green-600/20 text-green-400 border border-green-500/20">&#128229; Excel'den Aktar</button><button onclick="exportDepoExcel()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-blue-600/20 text-blue-400 border border-blue-500/20">&#128228; Excel'e Aktar</button></div>`;
    // Dusuk stok uyarisi
    if(lowStock.length>0){
        html+=`<div class="glass rounded-xl p-3 mb-4 border border-red-500/30 bg-red-500/5"><div class="flex items-center gap-2 mb-2"><span class="text-red-400 text-sm font-bold">&#9888; Dusuk Stok Uyarisi (${lowStock.length})</span></div><div class="flex flex-wrap gap-2">${lowStock.map(i=>`<span class="px-2 py-1 rounded text-[10px] bg-red-500/15 text-red-300">${i.ad}: ${i.miktar} ${i.birim} (min: ${i.minStok})</span>`).join('')}</div></div>`;
    }
    // Ozet kartlari
    const totalVal=items.reduce((s,i)=>s+i.miktar*(i.birimFiyat||0),0);
    const DK=getDepoKategoriler();const DKC=getDepoKatColors();const cats=Object.keys(DK);
    html+=`<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400 mb-1">Toplam Kalem</p><p class="text-xl font-bold text-amber-400">${items.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400 mb-1">Depo Sayisi</p><p class="text-xl font-bold text-blue-400">${(S.depolar||[]).length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400 mb-1">Toplam Deger</p><p class="text-xl font-bold text-green-400">${totalVal>=1000000?(totalVal/1000000).toFixed(1)+'M':totalVal>=1000?(totalVal/1000).toFixed(0)+'K':totalVal.toLocaleString('tr-TR')} TL</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400 mb-1">Dusuk Stok</p><p class="text-xl font-bold ${lowStock.length>0?'text-red-400':'text-green-400'}">${lowStock.length}</p></div>
    </div>`;
    // Kategori filtre
    html+=`<div class="flex flex-wrap gap-1 mb-3"><button class="tab-btn active text-[10px]" onclick="filterDepoKat('')" data-dkat="all">Tumu (${items.length})</button>`;
    cats.forEach(k=>{const cnt=items.filter(i=>i.kategori===k).length;if(cnt>0)html+=`<button class="tab-btn text-[10px]" onclick="filterDepoKat('${k}')" data-dkat="${k}">${DK[k]} (${cnt})</button>`;});
    html+=`</div>`;
    // Tablo
    if(items.length===0){
        html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz envanter eklenmedi.</p><button onclick="openDepoItemForm()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs">+ Ilk Kalemi Ekle</button></div>';
    }else{
        html+=`<div class="overflow-x-auto"><table class="w-full text-xs" id="depo-envanter-table"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2" style="width:36px"></th><th class="p-2">Malzeme</th><th class="p-2">Kategori</th><th class="p-2">Depo</th><th class="p-2 text-right">Miktar</th><th class="p-2 text-right">Toplam</th><th class="p-2">Durum</th><th class="p-2">Ekleyen</th><th class="p-2">Islem</th></tr></thead><tbody>`;
        items.forEach(i=>{
            const depo=(S.depolar||[]).find(d=>d.id===i.depoId);
            const toplam=i.miktar*(i.birimFiyat||0);
            const status=i.minStok>0&&i.miktar<=i.minStok?'<span class="px-1.5 py-0.5 rounded text-[9px] bg-red-500/20 text-red-400 font-bold">Dusuk</span>':i.minStok>0&&i.miktar<=i.minStok*1.5?'<span class="px-1.5 py-0.5 rounded text-[9px] bg-amber-500/20 text-amber-400">Azaliyor</span>':'<span class="px-1.5 py-0.5 rounded text-[9px] bg-green-500/20 text-green-400">Yeterli</span>';
            const thumb=i.resim?`<img src="${i.resim}" class="w-8 h-8 rounded object-cover cursor-pointer" onclick="showDepoItemImage(${i.id})">`:`<div class="w-8 h-8 rounded bg-gray-700/50 flex items-center justify-center text-[10px] text-gray-500">&#128247;</div>`;
            const ekleyenInfo=i.ekleyen?`<span class="text-gray-400">${i.ekleyen}</span>${i.eklenmeTarihi?'<br><span class="text-[9px] text-gray-600">'+i.eklenmeTarihi.slice(0,10)+'</span>':''}`:'-';
            html+=`<tr class="border-b border-gray-800 hover:bg-gray-800/30" data-kat="${i.kategori}"><td class="p-2">${thumb}</td><td class="p-2 font-medium">${i.ad}${i.barkod?'<br><span class="text-[9px] text-gray-500">'+i.barkod+'</span>':''}</td><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${DKC[i.kategori]||''}">${DK[i.kategori]||i.kategori}</span></td><td class="p-2 text-gray-400">${depo?depo.ad:'-'}${depo&&depo.sorumlu?'<br><span class="text-[9px] text-gray-600">Sor: '+depo.sorumlu+'</span>':''}</td><td class="p-2 text-right">${i.miktar} ${i.birim}<br><span class="text-[9px] text-gray-500">${(i.birimFiyat||0).toLocaleString('tr-TR')} TL/br</span></td><td class="p-2 text-right font-medium">${toplam.toLocaleString('tr-TR')} TL</td><td class="p-2">${status}</td><td class="p-2 text-[10px]">${ekleyenInfo}</td><td class="p-2"><button onclick="openDepoItemForm(${i.id})" class="text-blue-400 hover:text-blue-300 text-[10px] mr-2">Duzenle</button><button onclick="deleteDepoItem(${i.id})" class="text-red-400 hover:text-red-300 text-[10px]">Sil</button></td></tr>`;
        });
        html+=`</tbody></table></div>`;
    }
    c.innerHTML=html;
}
function showDepoItemImage(itemId){
    const item=(S.envanter||[]).find(i=>i.id===itemId);if(!item||!item.resim)return;
    const overlay=document.createElement('div');overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;cursor:pointer;';
    overlay.innerHTML=`<div style="max-width:90vw;max-height:90vh;text-align:center;"><img src="${item.resim}" style="max-width:100%;max-height:80vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);"><p style="color:#fff;margin-top:12px;font-size:14px;">${item.ad}</p></div>`;
    overlay.onclick=()=>document.body.removeChild(overlay);
    document.body.appendChild(overlay);
}
function filterDepoKat(kat){
    document.querySelectorAll('#module-depo [data-dkat]').forEach(b=>b.classList.toggle('active',kat===''?b.dataset.dkat==='all':b.dataset.dkat===kat));
    document.querySelectorAll('#depo-envanter-table tbody tr').forEach(tr=>{
        tr.style.display=(!kat||tr.dataset.kat===kat)?'':'none';
    });
}
function renderDepolar(){
    const c=document.getElementById('depo-tab-depolar');if(!c)return;
    const depolar=S.depolar||[];
    if(depolar.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz depo tanimlanmadi.</p><button onclick="openDepoTesisForm()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs">+ Ilk Depoyu Ekle</button></div>';return;}
    let html='<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">';
    depolar.forEach(d=>{
        const dItems=(S.envanter||[]).filter(i=>i.depoId===d.id);
        const totalItems=dItems.length;
        const totalVal=dItems.reduce((s,i)=>s+i.miktar*(i.birimFiyat||0),0);
        const lowStock=dItems.filter(i=>i.minStok>0&&i.miktar<=i.minStok).length;
        const tipCol=d.tip==='merkez'?'from-amber-500 to-orange-600':d.tip==='santiye'?'from-blue-500 to-cyan-600':'from-purple-500 to-pink-600';
        html+=`<div class="glass rounded-xl p-4 hover:border-amber-500/30 transition-colors">
            <div class="flex items-start justify-between mb-3">
                <div><h4 class="font-bold text-sm">${d.ad}</h4><p class="text-[10px] text-gray-400">${d.konum||''}</p></div>
                <span class="px-2 py-0.5 rounded text-[9px] bg-gradient-to-r ${tipCol} text-white font-medium">${DEPO_TIP_LABELS[d.tip]||d.tip}</span>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <div class="text-center"><p class="text-[10px] text-gray-400">Kalem</p><p class="text-lg font-bold text-amber-400">${totalItems}</p></div>
                <div class="text-center"><p class="text-[10px] text-gray-400">Deger</p><p class="text-lg font-bold text-green-400">${totalVal>=1000000?(totalVal/1000000).toFixed(1)+'M':totalVal>=1000?(totalVal/1000).toFixed(0)+'K':totalVal.toLocaleString('tr-TR')}</p></div>
                <div class="text-center"><p class="text-[10px] text-gray-400">Dusuk Stok</p><p class="text-lg font-bold ${lowStock>0?'text-red-400':'text-green-400'}">${lowStock}</p></div>
            </div>
            <div class="flex items-center justify-between text-[10px] text-gray-400 border-t border-gray-700/50 pt-2">
                <span>Sorumlu: ${d.sorumlu||'-'}</span>
                <div class="flex gap-2"><button onclick="openDepoTesisForm(${d.id})" class="text-blue-400 hover:text-blue-300">Duzenle</button><button onclick="deleteDepoTesis(${d.id})" class="text-red-400 hover:text-red-300">Sil</button></div>
            </div>
        </div>`;
    });
    html+='</div>';
    c.innerHTML=html;
}
function renderDepoHareketler(){
    const c=document.getElementById('depo-tab-hareketler');if(!c)return;
    const hareketler=(S.depoHareketler||[]).slice().sort((a,b)=>b.tarih.localeCompare(a.tarih));
    if(hareketler.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz stok hareketi yok.</p><button onclick="openDepoHareketForm()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs">+ Ilk Hareketi Kaydet</button></div>';return;}
    const giris=hareketler.filter(h=>h.tip==='giris'||h.tip==='iade').length;
    const cikis=hareketler.filter(h=>h.tip==='cikis'||h.tip==='projeye'||h.tip==='fire').length;
    const transfer=hareketler.filter(h=>h.tip==='transfer').length;
    const bekleyen=hareketler.filter(h=>h.durum==='talep').length;
    let html=`<div class="flex flex-wrap gap-2 mb-3"><button onclick="exportDepoHareketlerExcel()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-blue-600/20 text-blue-400 border border-blue-500/20">&#128228; Excel'e Aktar</button></div>`;
    html+=`<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Giris</p><p class="text-xl font-bold text-green-400">${giris}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Cikis</p><p class="text-xl font-bold text-red-400">${cikis}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Transfer</p><p class="text-xl font-bold text-blue-400">${transfer}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Onay Bekleyen</p><p class="text-xl font-bold ${bekleyen>0?'text-amber-400':'text-gray-500'}">${bekleyen}</p></div>
    </div>`;
    html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Tarih</th><th class="p-2">Tip</th><th class="p-2">Malzeme</th><th class="p-2 text-right">Miktar</th><th class="p-2">Kaynak</th><th class="p-2">Hedef</th><th class="p-2">Durum</th><th class="p-2">Islem</th></tr></thead><tbody>`;
    hareketler.forEach(h=>{
        const item=(S.envanter||[]).find(i=>i.id===h.envanterItemId);
        const kaynak=(S.depolar||[]).find(d=>d.id===h.kaynakDepoId);
        const hedef=(S.depolar||[]).find(d=>d.id===h.hedefDepoId);
        const proje=h.projectId?(S.projects||[]).find(p=>p.id===h.projectId):null;
        const durum=h.durum||'tamamlandi';
        const durumBadge=`<span class="px-1.5 py-0.5 rounded text-[9px] ${HAREKET_DURUM_COLORS[durum]||''}">${HAREKET_DURUM_LABELS[durum]||durum}</span>`;
        let actions='';
        if(durum==='talep')actions=`<button onclick="approveTransfer(${h.id})" class="text-green-400 hover:text-green-300 text-[10px] mr-1">Onayla</button><button onclick="rejectTransfer(${h.id})" class="text-red-400 hover:text-red-300 text-[10px]">Reddet</button>`;
        else if(durum==='onaylandi')actions=`<button onclick="completeTransfer(${h.id})" class="text-blue-400 hover:text-blue-300 text-[10px] mr-1">Tamamla</button>`;
        if(h.tip==='transfer'||h.tip==='projeye')actions+=`<button onclick="printTransferBelgesi(${h.id})" class="text-gray-400 hover:text-gray-300 text-[10px] ml-1" title="Belge Yazdir">&#128424;</button>`;
        const aciklamaStr=h.aciklama?(h.aciklama.length>25?h.aciklama.substring(0,22)+'...':h.aciklama):'-';
        html+=`<tr class="border-b border-gray-800"><td class="p-2">${h.tarih}</td><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${HAREKET_TIP_COLORS[h.tip]||''}">${HAREKET_TIP_LABELS[h.tip]||h.tip}</span>${h.aciliyet==='acil'?'<br><span class="text-[8px] text-red-400 font-bold">ACIL</span>':''}</td><td class="p-2 font-medium">${item?item.ad:'?'}</td><td class="p-2 text-right">${h.miktar} ${item?item.birim:''}</td><td class="p-2 text-gray-400">${kaynak?kaynak.ad:'-'}</td><td class="p-2 text-gray-400">${hedef?hedef.ad:(proje?proje.name:'-')}</td><td class="p-2">${durumBadge}${h.talepEden?'<br><span class="text-[9px] text-gray-500">'+h.talepEden+'</span>':''}</td><td class="p-2">${actions||`<span class="text-gray-600 text-[10px]">${aciklamaStr}</span>`}</td></tr>`;
    });
    html+=`</tbody></table></div>`;
    c.innerHTML=html;
}
function renderDepoSayim(){
    const c=document.getElementById('depo-tab-sayim');if(!c)return;
    const sayimlar=(S.sayimlar||[]).slice().sort((a,b)=>b.tarih.localeCompare(a.tarih));
    if(sayimlar.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz sayim yapilmadi.</p><button onclick="openDepoSayimForm()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs">+ Ilk Sayimi Baslat</button></div>';return;}
    const durumCol={planlanan:'bg-blue-500/20 text-blue-400',devam:'bg-amber-500/20 text-amber-400',tamamlanan:'bg-green-500/20 text-green-400'};
    const durumL={planlanan:'Planlanan',devam:'Devam Ediyor',tamamlanan:'Tamamlandi'};
    let html='<div class="space-y-4">';
    sayimlar.forEach(s=>{
        const depo=(S.depolar||[]).find(d=>d.id===s.depoId);
        const kalemler=s.kalemler||[];
        const farkli=kalemler.filter(k=>k.fark!==0).length;
        const toplamFark=kalemler.reduce((t,k)=>t+Math.abs(k.fark),0);
        html+=`<div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-3">
            <div><h4 class="font-bold text-sm">${depo?depo.ad:'?'} - Sayim</h4><p class="text-[10px] text-gray-400">${s.tarih} &middot; ${s.sorumlu||''}</p></div>
            <span class="px-2 py-0.5 rounded text-[10px] ${durumCol[s.durum]||''}">${durumL[s.durum]||s.durum}</span>
        </div>`;
        if(kalemler.length>0){
            html+=`<div class="grid grid-cols-3 gap-2 mb-3 text-center">
                <div><p class="text-[10px] text-gray-400">Sayilan Kalem</p><p class="text-lg font-bold text-amber-400">${kalemler.length}</p></div>
                <div><p class="text-[10px] text-gray-400">Farkli</p><p class="text-lg font-bold ${farkli>0?'text-red-400':'text-green-400'}">${farkli}</p></div>
                <div><p class="text-[10px] text-gray-400">Toplam Fark</p><p class="text-lg font-bold text-orange-400">${toplamFark}</p></div>
            </div>`;
            html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-gray-400"><th class="p-2 text-left">Malzeme</th><th class="p-2 text-right">Beklenen</th><th class="p-2 text-right">Sayilan</th><th class="p-2 text-right">Fark</th></tr></thead><tbody>`;
            kalemler.forEach(k=>{
                const item=(S.envanter||[]).find(i=>i.id===k.envanterItemId);
                const farkClass=k.fark>0?'text-green-400':k.fark<0?'text-red-400':'text-gray-400';
                html+=`<tr class="border-b border-gray-800"><td class="p-2">${item?item.ad:'?'}</td><td class="p-2 text-right">${k.beklenen}</td><td class="p-2 text-right">${k.sayilan}</td><td class="p-2 text-right font-bold ${farkClass}">${k.fark>0?'+':''}${k.fark}</td></tr>`;
            });
            html+=`</tbody></table></div>`;
        }
        if(s.notlar)html+=`<p class="text-[10px] text-gray-400 mt-2 italic">${s.notlar}</p>`;
        html+=`</div>`;
    });
    html+='</div>';
    c.innerHTML=html;
}
// --- DEPO CRUD ---
function handleDepoItemResim(files){
    if(!files||!files[0])return;
    const file=files[0];
    if(file.size>500*1024){showNotif('Resim cok buyuk (maks 500KB).');return;}
    const reader=new FileReader();
    reader.onload=function(e){
        depoItemResim=e.target.result;
        document.getElementById('di-resim-preview').innerHTML=`<img src="${depoItemResim}" class="w-full h-full object-cover">`;
        document.getElementById('di-resim-remove').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}
function clearDepoItemResim(){
    depoItemResim=null;
    document.getElementById('di-resim-preview').innerHTML='<span class="text-gray-500 text-[10px] text-center px-1">Resim Yukle<br>(maks 500KB)</span>';
    document.getElementById('di-resim-remove').classList.add('hidden');
    document.getElementById('di-resim-input').value='';
}
function openDepoItemForm(editId){
    const depoSel=document.getElementById('di-depo');
    depoSel.innerHTML=(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    if((S.depolar||[]).length===0)depoSel.innerHTML='<option value="">-- Once depo ekleyin --</option>';
    const katSel=document.getElementById('di-kategori');
    katSel.innerHTML=(S.depoKategoriler||[]).map(k=>`<option value="${k.key}">${k.ad}</option>`).join('');
    document.getElementById('di-edit-id').value='';
    document.getElementById('di-ad').value='';document.getElementById('di-kategori').value=(S.depoKategoriler[0]||{}).key||'diger';
    document.getElementById('di-barkod').value='';document.getElementById('di-birim').value='adet';
    document.getElementById('di-miktar').value='0';document.getElementById('di-minStok').value='0';
    document.getElementById('di-fiyat').value='0';document.getElementById('di-tedarikci').value='';document.getElementById('di-notlar').value='';
    depoItemResim=null;clearDepoItemResim();
    document.getElementById('di-meta-info').classList.add('hidden');
    if(editId){
        const item=(S.envanter||[]).find(i=>i.id===editId);
        if(item){
            document.getElementById('di-edit-id').value=item.id;
            document.getElementById('di-ad').value=item.ad;document.getElementById('di-kategori').value=item.kategori||'diger';
            depoSel.value=item.depoId||'';document.getElementById('di-barkod').value=item.barkod||'';
            document.getElementById('di-birim').value=item.birim||'adet';document.getElementById('di-miktar').value=item.miktar||0;
            document.getElementById('di-minStok').value=item.minStok||0;document.getElementById('di-fiyat').value=item.birimFiyat||0;
            document.getElementById('di-tedarikci').value=item.tedarikci||'';document.getElementById('di-notlar').value=item.notlar||'';
            if(item.resim){depoItemResim=item.resim;document.getElementById('di-resim-preview').innerHTML=`<img src="${item.resim}" class="w-full h-full object-cover">`;document.getElementById('di-resim-remove').classList.remove('hidden');}
            // Meta bilgiler
            const meta=document.getElementById('di-meta-info');
            let metaHtml='';
            if(item.ekleyen)metaHtml+=`Ekleyen: <b>${item.ekleyen}</b> (${(item.eklenmeTarihi||'').slice(0,10)})`;
            if(item.sonGuncelleyen)metaHtml+=` &middot; Son Guncelleyen: <b>${item.sonGuncelleyen}</b> (${(item.guncellemeTarihi||'').slice(0,10)})`;
            const depo=(S.depolar||[]).find(d=>d.id===item.depoId);
            if(depo&&depo.sorumlu)metaHtml+=` &middot; Depo Sorumlusu: <b>${depo.sorumlu}</b>`;
            if(metaHtml){meta.innerHTML=metaHtml;meta.classList.remove('hidden');}
        }
    }
    openModal('modal-depo-item');
}
function addDepoItem(){
    const ad=document.getElementById('di-ad').value.trim();if(!ad){showNotif('Malzeme adi girin.');return;}
    const depoId=parseInt(document.getElementById('di-depo').value);if(!depoId){showNotif('Once depo tanimlayƒ±n.');return;}
    const editId=document.getElementById('di-edit-id').value;
    const now=new Date().toISOString();
    const obj={
        ad,kategori:document.getElementById('di-kategori').value,
        depoId,barkod:document.getElementById('di-barkod').value.trim(),
        birim:document.getElementById('di-birim').value,
        miktar:parseFloat(document.getElementById('di-miktar').value)||0,
        minStok:parseFloat(document.getElementById('di-minStok').value)||0,
        birimFiyat:parseFloat(document.getElementById('di-fiyat').value)||0,
        tedarikci:document.getElementById('di-tedarikci').value.trim(),
        notlar:document.getElementById('di-notlar').value.trim()
    };
    if(depoItemResim)obj.resim=depoItemResim;
    else if(!editId)obj.resim=null;
    if(editId){
        const idx=(S.envanter||[]).findIndex(i=>i.id===parseInt(editId));
        if(idx>=0){
            if(depoItemResim)S.envanter[idx].resim=depoItemResim;
            Object.assign(S.envanter[idx],obj);
            S.envanter[idx].sonGuncelleyen=S.users[0].name;
            S.envanter[idx].guncellemeTarihi=now;
        }
    }else{
        obj.id=Date.now();
        obj.ekleyen=S.users[0].name;
        obj.eklenmeTarihi=now;
        if(!S.envanter)S.envanter=[];
        S.envanter.push(obj);
    }
    save();closeModal('modal-depo-item');renderDepoEnvanter();
    showNotif(editId?'Envanter guncellendi.':'Envanter eklendi.');
    act(editId?'Envanter guncellendi: '+ad:'Envanter eklendi: '+ad);
}
function deleteDepoItem(id){
    S.envanter=(S.envanter||[]).filter(i=>i.id!==id);save();renderDepoEnvanter();showNotif('Envanter silindi.');
}
function openDepoTesisForm(editId){
    document.getElementById('dt-edit-id').value='';
    document.getElementById('dt-ad').value='';document.getElementById('dt-konum').value='';
    document.getElementById('dt-tip').value='merkez';document.getElementById('dt-sorumlu').value='';
    if(editId){
        const d=(S.depolar||[]).find(x=>x.id===editId);
        if(d){
            document.getElementById('dt-edit-id').value=d.id;
            document.getElementById('dt-ad').value=d.ad;document.getElementById('dt-konum').value=d.konum||'';
            document.getElementById('dt-tip').value=d.tip||'merkez';document.getElementById('dt-sorumlu').value=d.sorumlu||'';
        }
    }
    openModal('modal-depo-tesis');
}
function addDepoTesis(){
    const ad=document.getElementById('dt-ad').value.trim();if(!ad){showNotif('Depo adi girin.');return;}
    const editId=document.getElementById('dt-edit-id').value;
    const obj={ad,konum:document.getElementById('dt-konum').value.trim(),tip:document.getElementById('dt-tip').value,sorumlu:document.getElementById('dt-sorumlu').value.trim(),aktif:true};
    if(editId){
        const idx=(S.depolar||[]).findIndex(d=>d.id===parseInt(editId));
        if(idx>=0)Object.assign(S.depolar[idx],obj);
    }else{
        obj.id=Date.now();
        if(!S.depolar)S.depolar=[];
        S.depolar.push(obj);
    }
    save();closeModal('modal-depo-tesis');renderDepolar();renderDepoModule();
    showNotif(editId?'Depo guncellendi.':'Depo eklendi.');
    act(editId?'Depo guncellendi: '+ad:'Depo tanimlandi: '+ad);
}
function deleteDepoTesis(id){
    S.depolar=(S.depolar||[]).filter(d=>d.id!==id);save();renderDepolar();showNotif('Depo silindi.');
}
function openDepoHareketForm(){
    document.getElementById('dh-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('dh-tip').value='giris';document.getElementById('dh-miktar').value='1';
    document.getElementById('dh-irsaliye').value='';document.getElementById('dh-aciklama').value='';
    const malSel=document.getElementById('dh-malzeme');
    malSel.innerHTML=(S.envanter||[]).map(i=>`<option value="${i.id}">${i.ad} (${i.miktar} ${i.birim})</option>`).join('');
    const depoOpts=(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    document.getElementById('dh-kaynak').innerHTML='<option value="">-</option>'+depoOpts;
    document.getElementById('dh-hedef').innerHTML='<option value="">-</option>'+depoOpts;
    const projOpts=(S.projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    document.getElementById('dh-proje').innerHTML='<option value="">-</option>'+projOpts;
    // Transfer fields - talep eden
    const userOpts=S.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    document.getElementById('dh-talep-eden').innerHTML=userOpts;
    document.getElementById('dh-aciliyet').value='normal';
    toggleDepoHareketFields();
    openModal('modal-depo-hareket');
}
function toggleDepoHareketFields(){
    const tip=document.getElementById('dh-tip').value;
    document.getElementById('dh-kaynak-wrap').style.display=(tip==='cikis'||tip==='transfer'||tip==='fire'||tip==='projeye')?'':'none';
    document.getElementById('dh-hedef-wrap').style.display=(tip==='giris'||tip==='transfer'||tip==='iade')?'':'none';
    document.getElementById('dh-proje-wrap').style.display=(tip==='projeye')?'':'none';
    document.getElementById('dh-transfer-fields').classList.toggle('hidden',tip!=='transfer'&&tip!=='projeye');
}
function addDepoHareket(){
    if(!enforceAccess('add_depo_hareket','depo'))return;
    const tip=document.getElementById('dh-tip').value;
    const itemId=parseInt(document.getElementById('dh-malzeme').value);
    const miktar=parseFloat(document.getElementById('dh-miktar').value)||0;
    if(!itemId||miktar<=0){showNotif('Malzeme secin ve miktar girin.');return;}
    const h={
        id:Date.now(),tarih:document.getElementById('dh-tarih').value,
        envanterItemId:itemId,tip,miktar,
        kaynakDepoId:parseInt(document.getElementById('dh-kaynak').value)||null,
        hedefDepoId:parseInt(document.getElementById('dh-hedef').value)||null,
        projectId:parseInt(document.getElementById('dh-proje').value)||null,
        irsaliyeNo:document.getElementById('dh-irsaliye').value.trim(),
        aciklama:document.getElementById('dh-aciklama').value.trim(),
        durum:(tip==='transfer'||tip==='projeye')?'talep':'tamamlandi',
        talepEden:(tip==='transfer'||tip==='projeye')?document.getElementById('dh-talep-eden').value:'',
        aciliyet:(tip==='transfer'||tip==='projeye')?document.getElementById('dh-aciliyet').value:'normal',
        onaylayan:''
    };
    if(!S.depoHareketler)S.depoHareketler=[];
    S.depoHareketler.push(h);
    // Stok guncelle (transfer/projeye icin onay bekle)
    const item=(S.envanter||[]).find(i=>i.id===itemId);
    if(item){
        if(tip==='giris'||tip==='iade')item.miktar+=miktar;
        else if(tip==='cikis'||tip==='fire')item.miktar=Math.max(0,item.miktar-miktar);
        // Transfer ve projeye: onay sonrasi stok duser
    }
    save();closeModal('modal-depo-hareket');renderDepoHareketler();renderDepoEnvanter();
    const itemName=item?item.ad:'?';
    const msg=(tip==='transfer'||tip==='projeye')?'Transfer talebi olusturuldu. Onay bekleniyor.':'Stok hareketi kaydedildi.';
    showNotif(msg);act(`Stok hareketi: ${HAREKET_TIP_LABELS[tip]} - ${itemName} x${miktar}`);
}
function approveTransfer(hId){
    if(!enforceAccess('approve_transfer','depo'))return;
    const h=(S.depoHareketler||[]).find(x=>x.id===hId);if(!h)return;
    h.durum='onaylandi';h.onaylayan=currentUser?currentUser.name:S.users[0].name;
    const item=(S.envanter||[]).find(i=>i.id===h.envanterItemId);
    if(item)item.miktar=Math.max(0,item.miktar-h.miktar);
    // Projeye transfer ise proje malzemeStok'a ekle
    if(h.tip==='projeye'&&h.projectId&&item){
        const project=S.projects.find(p=>p.id===h.projectId);
        if(project){
            if(!project.malzemeStok)project.malzemeStok=[];
            const existing=project.malzemeStok.find(m=>m.malzeme===item.ad);
            if(existing){existing.miktar+=h.miktar;if(!existing.hareketler)existing.hareketler=[];existing.hareketler.push({id:Date.now(),tarih:new Date().toISOString().slice(0,10),tip:'giris',miktar:h.miktar,irsaliyeNo:h.irsaliyeNo||''});}
            else{project.malzemeStok.push({id:Date.now(),malzeme:item.ad,miktar:h.miktar,birim:item.birim||'adet',minStok:0,hareketler:[{id:Date.now(),tarih:new Date().toISOString().slice(0,10),tip:'giris',miktar:h.miktar,irsaliyeNo:''}]});}
        }
    }
    save();renderDepoHareketler();renderDepoEnvanter();showNotif('Transfer onaylandi.'+(h.tip==='projeye'?' Proje stoku guncellendi.':''));
}
function completeTransfer(hId){
    const h=(S.depoHareketler||[]).find(x=>x.id===hId);if(!h)return;
    h.durum='tamamlandi';save();renderDepoHareketler();showNotif('Transfer tamamlandi.');
}
function rejectTransfer(hId){
    const h=(S.depoHareketler||[]).find(x=>x.id===hId);if(!h)return;
    h.durum='reddedildi';save();renderDepoHareketler();showNotif('Transfer reddedildi.');
}
function printTransferBelgesi(hId){
    const h=(S.depoHareketler||[]).find(x=>x.id===hId);if(!h)return;
    const item=(S.envanter||[]).find(i=>i.id===h.envanterItemId);
    const kaynak=(S.depolar||[]).find(d=>d.id===h.kaynakDepoId);
    const hedef=(S.depolar||[]).find(d=>d.id===h.hedefDepoId);
    const proje=h.projectId?(S.projects||[]).find(p=>p.id===h.projectId):null;
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Transfer Belgesi</title><style>body{font-family:Arial,sans-serif;font-size:12px;padding:30px;color:#1e293b;}h1{font-size:18px;text-align:center;margin-bottom:4px;}h2{font-size:11px;text-align:center;color:#64748b;margin-bottom:20px;}table{width:100%;border-collapse:collapse;margin:12px 0;}th,td{border:1px solid #cbd5e1;padding:6px 10px;text-align:left;font-size:11px;}th{background:#f1f5f9;}.sign-area{display:flex;justify-content:space-between;margin-top:50px;}.sign-box{width:30%;text-align:center;border-top:1px solid #94a3b8;padding-top:8px;font-size:10px;color:#64748b;}.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:bold;}.acil{background:#fef2f2;color:#dc2626;}.normal{background:#f0fdf4;color:#16a34a;}.planli{background:#eff6ff;color:#2563eb;}@media print{body{padding:15px;}}</style></head><body>`);
    w.document.write(`<h1>MALZEME TRANSFER BELGESI</h1><h2>FaOnSisT - ${new Date().toLocaleDateString('tr-TR')}</h2>`);
    w.document.write(`<table><tr><th style="width:30%">Belge No</th><td>TRF-${h.id}</td><th style="width:20%">Tarih</th><td>${h.tarih}</td></tr><tr><th>Hareket Tipi</th><td>${HAREKET_TIP_LABELS[h.tip]||h.tip}</td><th>Aciliyet</th><td><span class="badge ${h.aciliyet}">${h.aciliyet||'normal'}</span></td></tr><tr><th>Kaynak</th><td>${kaynak?kaynak.ad:'-'}</td><th>Hedef</th><td>${hedef?hedef.ad:(proje?proje.name:'-')}</td></tr><tr><th>Talep Eden</th><td>${h.talepEden||'-'}</td><th>Onaylayan</th><td>${h.onaylayan||'-'}</td></tr></table>`);
    w.document.write(`<h3 style="font-size:13px;margin-top:20px;">Malzeme Detayi</h3><table><tr><th>Malzeme</th><th>Barkod</th><th>Miktar</th><th>Birim</th><th>Birim Fiyat</th><th>Toplam</th></tr><tr><td>${item?item.ad:'?'}</td><td>${item?item.barkod||'-':'-'}</td><td style="text-align:right">${h.miktar}</td><td>${item?item.birim:'-'}</td><td style="text-align:right">${item?(item.birimFiyat||0).toLocaleString('tr-TR')+' TL':'-'}</td><td style="text-align:right">${item?(h.miktar*(item.birimFiyat||0)).toLocaleString('tr-TR')+' TL':'-'}</td></tr></table>`);
    if(h.irsaliyeNo)w.document.write(`<p style="font-size:10px;color:#64748b;">Irsaliye No: ${h.irsaliyeNo}</p>`);
    if(h.aciklama)w.document.write(`<p style="font-size:10px;color:#64748b;">Aciklama: ${h.aciklama}</p>`);
    w.document.write(`<div class="sign-area"><div class="sign-box"><b>Teslim Eden</b><br><br><br>${kaynak&&kaynak.sorumlu?kaynak.sorumlu:'________________'}</div><div class="sign-box"><b>Onaylayan</b><br><br><br>${h.onaylayan||'________________'}</div><div class="sign-box"><b>Teslim Alan</b><br><br><br>${hedef&&hedef.sorumlu?hedef.sorumlu:'________________'}</div></div>`);
    w.document.write(`<div style="margin-top:40px;text-align:center;font-size:9px;color:#94a3b8;">FaOnSisT v5.0 - Transfer Belgesi &middot; ${new Date().toLocaleString('tr-TR')}</div><script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
    w.document.close();
}
function openDepoSayimForm(){
    document.getElementById('ds-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('ds-sorumlu').value='';document.getElementById('ds-notlar').value='';
    const depoSel=document.getElementById('ds-depo');
    depoSel.innerHTML=(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    depoSel.onchange=()=>renderSayimKalemler();
    renderSayimKalemler();
    openModal('modal-depo-sayim');
}
function renderSayimKalemler(){
    const depoId=parseInt(document.getElementById('ds-depo').value);
    const items=(S.envanter||[]).filter(i=>i.depoId===depoId);
    const area=document.getElementById('ds-kalemler-area');
    if(items.length===0){area.innerHTML='<p class="text-gray-500 text-[11px] mt-2">Bu depoda envanter yok.</p>';return;}
    area.innerHTML=`<p class="text-xs text-gray-400 font-semibold mb-2 mt-2">Sayim Kalemleri</p><div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-gray-400"><th class="p-2 text-left">Malzeme</th><th class="p-2 text-right">Beklenen</th><th class="p-2 text-right">Sayilan</th></tr></thead><tbody>${items.map(i=>`<tr class="border-b border-gray-800"><td class="p-2">${i.ad}</td><td class="p-2 text-right text-gray-400">${i.miktar}</td><td class="p-2 text-right"><input type="number" class="w-16 bg-gray-800/80 border border-gray-700 rounded px-2 py-1 text-xs text-right ds-sayim-input" data-id="${i.id}" data-beklenen="${i.miktar}" value="${i.miktar}"></td></tr>`).join('')}</tbody></table></div>`;
}
function addDepoSayim(){
    const depoId=parseInt(document.getElementById('ds-depo').value);if(!depoId){showNotif('Depo secin.');return;}
    const inputs=document.querySelectorAll('.ds-sayim-input');
    const kalemler=[];
    inputs.forEach(inp=>{
        const eid=parseInt(inp.dataset.id);const beklenen=parseFloat(inp.dataset.beklenen)||0;
        const sayilan=parseFloat(inp.value)||0;
        kalemler.push({envanterItemId:eid,beklenen,sayilan,fark:sayilan-beklenen});
    });
    if(kalemler.length===0){showNotif('Sayilacak kalem yok.');return;}
    const s={
        id:Date.now(),tarih:document.getElementById('ds-tarih').value,
        depoId,durum:'tamamlanan',
        kalemler,sorumlu:document.getElementById('ds-sorumlu').value.trim(),
        notlar:document.getElementById('ds-notlar').value.trim()
    };
    if(!S.sayimlar)S.sayimlar=[];
    S.sayimlar.push(s);
    // Stok miktarlarini sayim sonucuna gore guncelle
    kalemler.forEach(k=>{
        const item=(S.envanter||[]).find(i=>i.id===k.envanterItemId);
        if(item)item.miktar=k.sayilan;
    });
    save();closeModal('modal-depo-sayim');renderDepoSayim();renderDepoEnvanter();
    const depo=(S.depolar||[]).find(d=>d.id===depoId);
    showNotif('Sayim kaydedildi.');act(`Envanter sayimi: ${depo?depo.ad:'?'}`);
}
// --- EXCEL IMPORT / EXPORT ---
function openDepoExcelImport(){
    document.getElementById('excel-import-type').value='depo-envanter';
    document.getElementById('excel-import-title').textContent='Envanter Toplu Aktar (Excel/CSV)';
    const projSel=document.getElementById('excel-import-project-select');
    projSel.innerHTML='<option value="">-- Proje Bagimsiz (Depo) --</option>';
    document.getElementById('excel-import-project-id').value='';
    document.getElementById('excel-file-input').value='';
    document.getElementById('excel-preview').classList.add('hidden');
    excelImportData=[];
    openModal('modal-excel-import');
}
function exportDepoExcel(){
    if(typeof XLSX==='undefined'){showNotif('XLSX kutuphanesi yuklenemedi.');return;}
    const items=S.envanter||[];if(items.length===0){showNotif('Aktarilacak envanter yok.');return;}
    const data=items.map(i=>{
        const depo=(S.depolar||[]).find(d=>d.id===i.depoId);
        const toplam=i.miktar*(i.birimFiyat||0);
        const durum=i.minStok>0&&i.miktar<=i.minStok?'Dusuk':i.minStok>0&&i.miktar<=i.minStok*1.5?'Azaliyor':'Yeterli';
        const DK=getDepoKategoriler();return {'Malzeme Adi':i.ad,'Kategori':DK[i.kategori]||i.kategori,'Depo':depo?depo.ad:'','Barkod':i.barkod||'','Birim':i.birim,'Miktar':i.miktar,'Min Stok':i.minStok,'Birim Fiyat':i.birimFiyat||0,'Toplam Deger':toplam,'Tedarikci':i.tedarikci||'','Durum':durum,'Ekleyen':i.ekleyen||''};
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Envanter');
    XLSX.writeFile(wb,'FaOnSisT_Envanter_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showNotif('Excel dosyasi indirildi.');
}
function exportDepoHareketlerExcel(){
    if(typeof XLSX==='undefined'){showNotif('XLSX kutuphanesi yuklenemedi.');return;}
    const hareketler=S.depoHareketler||[];if(hareketler.length===0){showNotif('Aktarilacak hareket yok.');return;}
    const data=hareketler.map(h=>{
        const item=(S.envanter||[]).find(i=>i.id===h.envanterItemId);
        const kaynak=(S.depolar||[]).find(d=>d.id===h.kaynakDepoId);
        const hedef=(S.depolar||[]).find(d=>d.id===h.hedefDepoId);
        return {'Tarih':h.tarih,'Tip':HAREKET_TIP_LABELS[h.tip]||h.tip,'Malzeme':item?item.ad:'?','Miktar':h.miktar,'Birim':item?item.birim:'','Kaynak Depo':kaynak?kaynak.ad:'','Hedef Depo':hedef?hedef.ad:'','Irsaliye No':h.irsaliyeNo||'','Durum':HAREKET_DURUM_LABELS[h.durum||'tamamlandi'],'Talep Eden':h.talepEden||'','Aciklama':h.aciklama||''};
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Hareketler');
    XLSX.writeFile(wb,'FaOnSisT_Stok_Hareketleri_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showNotif('Excel dosyasi indirildi.');
}
function exportZimmetExcel(){
    if(typeof XLSX==='undefined'){showNotif('XLSX kutuphanesi yuklenemedi.');return;}
    const zimmetler=S.zimmetler||[];if(zimmetler.length===0){showNotif('Aktarilacak zimmet yok.');return;}
    const data=zimmetler.map(z=>{
        const item=(S.envanter||[]).find(i=>i.id===z.envanterItemId);
        const depo=(S.depolar||[]).find(d=>d.id===z.depoId);
        return {'Tarih':z.tarih,'Malzeme':item?item.ad:'?','Miktar':z.miktar,'Zimmetli Kisi':z.zimmetliKisi,'Departman':z.departman||'','Depo':depo?depo.ad:'','Durum':z.durum==='aktif'?'Aktif':z.durum==='iade'?'Iade Edildi':'Kayip','Iade Tarihi':z.iadeTarihi||'','Onaylayan':z.onaylayan||'','Notlar':z.notlar||''};
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Zimmetler');
    XLSX.writeFile(wb,'FaOnSisT_Zimmet_Listesi_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showNotif('Excel dosyasi indirildi.');
}
// --- ZIMMET SISTEMI ---
function renderDepoZimmet(){
    const c=document.getElementById('depo-tab-zimmet');if(!c)return;
    const zimmetler=S.zimmetler||[];
    const aktif=zimmetler.filter(z=>z.durum==='aktif');
    const iade=zimmetler.filter(z=>z.durum==='iade');
    const kayip=zimmetler.filter(z=>z.durum==='kayip');
    if(zimmetler.length===0){c.innerHTML='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz zimmet kaydi yok.</p><button onclick="openZimmetForm()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-xs">+ Ilk Zimmeti Olustur</button></div>';return;}
    let html=`<div class="flex flex-wrap gap-2 mb-3"><button onclick="exportZimmetExcel()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-blue-600/20 text-blue-400 border border-blue-500/20">&#128228; Excel'e Aktar</button></div>`;
    html+=`<div class="grid grid-cols-3 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Aktif Zimmet</p><p class="text-xl font-bold text-amber-400">${aktif.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Iade Edildi</p><p class="text-xl font-bold text-green-400">${iade.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Kayip</p><p class="text-xl font-bold ${kayip.length>0?'text-red-400':'text-gray-500'}">${kayip.length}</p></div>
    </div>`;
    html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Tarih</th><th class="p-2">Malzeme</th><th class="p-2 text-right">Miktar</th><th class="p-2">Zimmetli Kisi</th><th class="p-2">Departman</th><th class="p-2">Durum</th><th class="p-2">Islem</th></tr></thead><tbody>`;
    zimmetler.slice().sort((a,b)=>b.tarih.localeCompare(a.tarih)).forEach(z=>{
        const item=(S.envanter||[]).find(i=>i.id===z.envanterItemId);
        const durumCol=z.durum==='aktif'?'bg-amber-500/20 text-amber-400':z.durum==='iade'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400';
        const durumL=z.durum==='aktif'?'Aktif':z.durum==='iade'?'Iade':'Kayip';
        let actions='';
        if(z.durum==='aktif')actions=`<button onclick="iadeZimmet(${z.id})" class="text-green-400 hover:text-green-300 text-[10px] mr-1">Iade</button><button onclick="kayipZimmet(${z.id})" class="text-red-400 hover:text-red-300 text-[10px] mr-1">Kayip</button>`;
        actions+=`<button onclick="printZimmetFormu(${z.id})" class="text-gray-400 hover:text-gray-300 text-[10px]" title="Zimmet Formu Yazdir">&#128424;</button>`;
        if(z.belgeNo)actions+=`<button onclick="printProfessionalZimmetBelgesi('${z.belgeNo}')" class="text-teal-400 hover:text-teal-300 text-[10px] ml-1" title="Toplu Zimmet Belgesi Yazdir">&#128203;</button>`;
        const malzemeAd=item?item.ad:(z.malzemeAdi||'?');
        const malzemeBarkod=item&&item.barkod?'<br><span class="text-[9px] text-gray-500">'+item.barkod+'</span>':(z.seriNo?'<br><span class="text-[9px] text-gray-500">'+z.seriNo+'</span>':'');
        const kisiAd=getZimmetKisiAdi(z);
        const kisiHtml=z.personelId?`<a onclick="event.stopPropagation();showModule('hr');setTimeout(()=>openPersonelDetay('${z.personelId}'),100)" class="text-teal-400 hover:text-teal-300 cursor-pointer">${kisiAd}</a>`:kisiAd;
        html+=`<tr class="border-b border-gray-800"><td class="p-2">${z.tarih}${z.iadeTarihi?'<br><span class="text-[9px] text-green-500">Iade: '+z.iadeTarihi+'</span>':''}</td><td class="p-2 font-medium">${malzemeAd}${malzemeBarkod}</td><td class="p-2 text-right">${z.miktar}</td><td class="p-2">${kisiHtml}${z.onaylayan?'<br><span class="text-[9px] text-gray-500">Onayl: '+z.onaylayan+'</span>':''}</td><td class="p-2 text-gray-400">${z.departman||'-'}</td><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${durumCol}">${durumL}</span></td><td class="p-2">${actions}</td></tr>`;
    });
    html+=`</tbody></table></div>`;
    c.innerHTML=html;
}
function openZimmetForm(){
    document.getElementById('dz-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('dz-miktar').value='1';document.getElementById('dz-kisi').value='';
    document.getElementById('dz-departman').value='santiye';document.getElementById('dz-notlar').value='';
    const malSel=document.getElementById('dz-malzeme');
    malSel.innerHTML=(S.envanter||[]).map(i=>`<option value="${i.id}">${i.ad} (${i.miktar} ${i.birim})</option>`).join('');
    const depoSel=document.getElementById('dz-depo');
    depoSel.innerHTML=(S.depolar||[]).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    const onaySel=document.getElementById('dz-onaylayan');
    onaySel.innerHTML=S.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    const kisiSel=document.getElementById('dz-kisi');
    kisiSel.innerHTML='<option value="">Seciniz...</option>'+(S.personeller||[]).filter(p=>p.durum==='aktif'||p.durum==='izinli').map(p=>{const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));return`<option value="${p.id}">${p.ad} ${p.soyad} (${dept?dept.ad:'-'})</option>`;}).join('');
    openModal('modal-depo-zimmet');
}
function addZimmet(){
    if(!enforceAccess('add_zimmet','depo'))return;
    const itemId=parseInt(document.getElementById('dz-malzeme').value);
    const miktar=parseFloat(document.getElementById('dz-miktar').value)||0;
    const personelId=document.getElementById('dz-kisi').value;
    if(!itemId||miktar<=0||!personelId){showNotif('Malzeme, miktar ve kisi secin.');return;}
    const personel=(S.personeller||[]).find(p=>String(p.id)===String(personelId));
    const kisiAd=personel?(personel.ad+' '+personel.soyad):'';
    const z={
        id:Date.now(),tarih:document.getElementById('dz-tarih').value,
        envanterItemId:itemId,miktar,
        personelId:personelId,zimmetliKisi:kisiAd,
        departman:document.getElementById('dz-departman').value,
        depoId:parseInt(document.getElementById('dz-depo').value)||null,
        durum:'aktif',iadeTarihi:null,
        notlar:document.getElementById('dz-notlar').value.trim(),
        ekleyen:S.users[0].name,onaylayan:document.getElementById('dz-onaylayan').value
    };
    if(!S.zimmetler)S.zimmetler=[];
    S.zimmetler.push(z);
    const item=(S.envanter||[]).find(i=>i.id===itemId);
    if(item)item.miktar=Math.max(0,item.miktar-miktar);
    save();closeModal('modal-depo-zimmet');renderDepoZimmet();renderDepoEnvanter();
    showNotif('Zimmet olusturuldu.');act(`Zimmet: ${item?item.ad:'?'} -> ${kisiAd}`);
}
function getZimmetKisiAdi(z){
    if(z.personelId){const p=(S.personeller||[]).find(x=>String(x.id)===String(z.personelId));return p?(p.ad+' '+p.soyad):(z.zimmetliKisi||'?');}
    return z.zimmetliKisi||'?';
}
function iadeZimmet(zId){
    const z=(S.zimmetler||[]).find(x=>x.id===zId);if(!z)return;
    z.durum='iade';z.iadeTarihi=new Date().toISOString().slice(0,10);
    const item=(S.envanter||[]).find(i=>i.id===z.envanterItemId);
    if(item)item.miktar+=z.miktar;
    save();renderDepoZimmet();renderDepoEnvanter();showNotif('Zimmet iade edildi.');
}
function kayipZimmet(zId){
    const z=(S.zimmetler||[]).find(x=>x.id===zId);if(!z)return;
    z.durum='kayip';save();renderDepoZimmet();showNotif('Zimmet kayip olarak isaretlendi.');
}
function printZimmetFormu(zId){
    const z=(S.zimmetler||[]).find(x=>x.id===zId);if(!z)return;
    const item=(S.envanter||[]).find(i=>i.id===z.envanterItemId);
    const depo=(S.depolar||[]).find(d=>d.id===z.depoId);
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Zimmet Formu</title><style>body{font-family:Arial,sans-serif;font-size:12px;padding:30px;color:#1e293b;}h1{font-size:18px;text-align:center;margin-bottom:4px;}h2{font-size:11px;text-align:center;color:#64748b;margin-bottom:24px;}table{width:100%;border-collapse:collapse;margin:12px 0;}th,td{border:1px solid #cbd5e1;padding:8px 10px;text-align:left;font-size:11px;}th{background:#f1f5f9;font-weight:600;}.sign-area{display:flex;justify-content:space-between;margin-top:60px;}.sign-box{width:40%;text-align:center;border-top:1px solid #94a3b8;padding-top:10px;font-size:10px;color:#64748b;}.status{display:inline-block;padding:3px 10px;border-radius:4px;font-size:10px;font-weight:bold;}.aktif{background:#fef3c7;color:#d97706;}.iade{background:#dcfce7;color:#16a34a;}.kayip{background:#fef2f2;color:#dc2626;}@media print{body{padding:15px;}}</style></head><body>`);
    w.document.write(`<h1>ZIMMET / MALZEME TESLIM FORMU</h1><h2>FaOnSisT - Envanter Yonetimi</h2>`);
    w.document.write(`<table><tr><th style="width:30%">Zimmet No</th><td>ZMT-${z.id}</td><th style="width:20%">Tarih</th><td>${z.tarih}</td></tr><tr><th>Teslim Alan</th><td><b>${z.zimmetliKisi}</b></td><th>Departman</th><td>${z.departman||'-'}</td></tr><tr><th>Durum</th><td><span class="status ${z.durum}">${z.durum==='aktif'?'AKTIF':z.durum==='iade'?'IADE EDILDI':'KAYIP'}</span>${z.iadeTarihi?' ('+z.iadeTarihi+')':''}</td><th>Onaylayan</th><td>${z.onaylayan||'-'}</td></tr></table>`);
    w.document.write(`<h3 style="font-size:13px;margin-top:20px;">Teslim Edilen Malzeme</h3><table><tr><th>Malzeme Adi</th><th>Barkod / Seri No</th><th>Miktar</th><th>Birim</th><th>Birim Deger</th><th>Toplam Deger</th></tr><tr><td><b>${item?item.ad:'?'}</b></td><td>${item?item.barkod||'-':'-'}</td><td style="text-align:right">${z.miktar}</td><td>${item?item.birim:'-'}</td><td style="text-align:right">${item?(item.birimFiyat||0).toLocaleString('tr-TR')+' TL':'-'}</td><td style="text-align:right"><b>${item?(z.miktar*(item.birimFiyat||0)).toLocaleString('tr-TR')+' TL':'-'}</b></td></tr></table>`);
    if(z.notlar)w.document.write(`<p style="font-size:10px;color:#64748b;margin-top:8px;">Not: ${z.notlar}</p>`);
    w.document.write(`<div style="margin-top:20px;padding:10px;background:#f8fafc;border-radius:6px;font-size:9px;color:#64748b;">Bu form ile teslim alinan malzeme, teslim alan kisinin sorumlulugundadir. Malzemenin hasar gormesi, kaybolmasi veya amaci disinda kullanilmasi halinde teslim alan kisi sorumludur.</div>`);
    w.document.write(`<div class="sign-area"><div class="sign-box"><b>Teslim Eden</b><br>(Depo Sorumlusu)<br><br><br>${depo&&depo.sorumlu?depo.sorumlu:'________________'}<br>Tarih: ___/___/______</div><div class="sign-box"><b>Teslim Alan</b><br><br><br><br>${z.zimmetliKisi}<br>Tarih: ${z.tarih}</div></div>`);
    w.document.write(`<div style="margin-top:40px;text-align:center;font-size:9px;color:#94a3b8;">FaOnSisT v5.0 - Zimmet Formu &middot; ${new Date().toLocaleString('tr-TR')}</div><script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
    w.document.close();
}

// ===================== BILDIRIM SISTEMI =====================
const BILDIRIM_SEVIYE_RENK={bilgi:'border-l-blue-500 bg-blue-500/5',uyari:'border-l-amber-500 bg-amber-500/5',kritik:'border-l-orange-500 bg-orange-500/5',acil:'border-l-red-500 bg-red-500/5'};
const BILDIRIM_SEVIYE_BADGE={bilgi:'bg-blue-500/20 text-blue-400',uyari:'bg-amber-500/20 text-amber-400',kritik:'bg-orange-500/20 text-orange-400',acil:'bg-red-500/20 text-red-400'};
const BILDIRIM_SEVIYE_ICON={bilgi:'\u2139\uFE0F',uyari:'\u26A0\uFE0F',kritik:'\uD83D\uDD36',acil:'\uD83D\uDD34'};
const BILDIRIM_SEVIYE_LABEL={bilgi:'Bilgi',uyari:'Uyari',kritik:'Kritik',acil:'Acil'};
let bildirimKategoriFiltre='tumu';

function bildirimHashOlustur(tip,aracId,belgeTip,esik,extra){
    const donem=new Date().toISOString().slice(0,7);
    const raw=`${tip}|${aracId||''}|${belgeTip||''}|${esik||''}|${extra||donem}`;
    let h=0;for(let i=0;i<raw.length;i++){h=((h<<5)-h)+raw.charCodeAt(i);h|=0;}
    return 'h_'+Math.abs(h).toString(36);
}
function bildirimOlustur(opts){
    if(!opts.hash)return null;
    if((S.bildirimler||[]).some(b=>b.hash===opts.hash))return null;
    const ay=S.bildirimAyarlar||{};
    const katAyar=ay.kategoriler||{};
    if(opts.kategori&&katAyar[opts.kategori]===false)return null;
    const b={
        id:Date.now()+Math.floor(Math.random()*1000),
        tip:opts.tip||'genel',seviye:opts.seviye||'bilgi',kategori:opts.kategori||'genel',
        baslik:opts.baslik||'',mesaj:opts.mesaj||'',
        aracId:opts.aracId||null,envanterItemId:opts.envanterItemId||null,
        hedefKullaniciId:opts.hedefKullaniciId||null,hedefRol:opts.hedefRol||null,
        okunduDurumu:{},tarih:new Date().toISOString(),
        aksiyonTip:opts.aksiyonTip||null,aksiyonId:opts.aksiyonId||null,
        hash:opts.hash
    };
    if(!S.bildirimler)S.bildirimler=[];
    S.bildirimler.unshift(b);
    save();
    return b;
}
function bildirimOkunduIsaretle(bildirimId,userId){
    const b=S.bildirimler.find(x=>x.id===bildirimId);
    if(b){if(!b.okunduDurumu)b.okunduDurumu={};b.okunduDurumu[userId]=true;save();}
}
function bildirimTumunuOkundu(userId){
    const gorunenler=bildirimlerKullanicininGoregi();
    gorunenler.forEach(b=>{if(!b.okunduDurumu)b.okunduDurumu={};b.okunduDurumu[userId]=true;});
    save();
}
function bildirimSil(bildirimId){
    S.bildirimler=(S.bildirimler||[]).filter(b=>b.id!==bildirimId);save();
}
function bildirimTemizle(){
    S.bildirimler=[];save();bildirimSayisiGuncelle();
}
function bildirimSayisiGuncelle(){
    const uid=currentUser?currentUser.id:1;
    const gorunenler=bildirimlerKullanicininGoregi();
    const okunmamis=gorunenler.filter(b=>!b.okunduDurumu||!b.okunduDurumu[uid]).length;
    const el=document.getElementById('notif-count');
    if(el)el.textContent=okunmamis;
}
function bildirimlerKullanicininGoregi(){
    const uid=currentUser?currentUser.id:1;
    const role=currentUser?currentUser.role:'Yonetici';
    return (S.bildirimler||[]).filter(b=>{
        if(!b.hedefKullaniciId&&!b.hedefRol)return true;
        if(b.hedefKullaniciId===uid)return true;
        if(b.hedefRol===role)return true;
        if(role==='Yonetici')return true;
        return false;
    });
}
function getBildirimHedef(arac){
    const ay=S.bildirimAyarlar||{};
    const hedefler=[];
    // Filo sorumlusu
    if(ay.filoSorumlusu&&ay.filoSorumlusu.userId&&ay.filoSorumlusu.tumBildirimleriAl){
        hedefler.push({hedefKullaniciId:ay.filoSorumlusu.userId});
    }
    // Zimmetli kisi
    if(arac&&arac.zimmetliKisi){
        const u=S.users.find(x=>x.name===arac.zimmetliKisi);
        if(u&&(!hedefler.length||hedefler[0].hedefKullaniciId!==u.id))hedefler.push({hedefKullaniciId:u.id});
    }
    // Departman routing
    if(arac&&arac.zimmetDepartman&&ay.departmanRouting){
        const dr=ay.departmanRouting[arac.zimmetDepartman];
        if(dr&&dr.aktif&&dr.hedefRol)hedefler.push({hedefRol:dr.hedefRol});
    }
    // Eger hicbir hedef yoksa broadcast (null)
    if(hedefler.length===0)return [{hedefKullaniciId:null,hedefRol:null}];
    return hedefler;
}

// ---- UYARI OLUSTURMA MOTORU ----
function kontrolBelgeSureleri(){
    const ay=S.bildirimAyarlar||{};
    const esikler=ay.belgeEsikler||{};
    const bugun=new Date();
    const esikMap={gun0:0,gun7:7,gun30:30,gun60:60};
    (S.araclar||[]).forEach(a=>{
        ['muayene','sigorta','kasko','egzoz'].forEach(bt=>{
            const b=a.belgeler&&a.belgeler[bt];
            if(!b||!b.bitisTarih)return;
            const bitis=new Date(b.bitisTarih);
            const kalanGun=Math.ceil((bitis-bugun)/(1000*60*60*24));
            Object.keys(esikMap).forEach(ek=>{
                const cfg=esikler[ek];
                if(!cfg||!cfg.aktif)return;
                const esikGun=esikMap[ek];
                let tetikle=false;
                if(ek==='gun0'&&kalanGun<0)tetikle=true;
                else if(ek==='gun7'&&kalanGun>=0&&kalanGun<=7)tetikle=true;
                else if(ek==='gun30'&&kalanGun>7&&kalanGun<=30)tetikle=true;
                else if(ek==='gun60'&&kalanGun>30&&kalanGun<=60)tetikle=true;
                if(!tetikle)return;
                const belgeAd={muayene:'Muayene',sigorta:'Sigorta',kasko:'Kasko',egzoz:'Egzoz Emisyon'}[bt];
                const hash=bildirimHashOlustur('belge_suresi',a.id,bt,ek);
                let baslik,mesaj;
                if(ek==='gun0'){
                    baslik=belgeAd+' Suresi Gecmis!';
                    mesaj=a.plaka+' - '+belgeAd+' '+Math.abs(kalanGun)+' gundur suresi gecmis ('+b.bitisTarih+')';
                }else{
                    baslik=belgeAd+' Suresi Yaklasƒ±yor';
                    mesaj=a.plaka+' - '+belgeAd+' '+kalanGun+' gun icinde sona erecek ('+b.bitisTarih+')';
                }
                const hedefler=getBildirimHedef(a);
                hedefler.forEach(h=>{
                    bildirimOlustur({tip:'belge_suresi',seviye:cfg.seviye,kategori:'arac-filo',baslik,mesaj,aracId:a.id,hedefKullaniciId:h.hedefKullaniciId,hedefRol:h.hedefRol,aksiyonTip:'arac-detay',aksiyonId:a.id,hash:hash+(h.hedefKullaniciId||h.hedefRol||'')});
                });
            });
        });
    });
}
function kontrolKmBakimTekArac(arac){
    const ay=S.bildirimAyarlar||{};
    const km=ay.kmBakimHatirlatma;
    if(!km||!km.aktif||!km.aralik)return;
    const aralik=km.aralik;
    const sonBakim=(arac.bakimlar||[]).filter(b=>b.islem).sort((a,b)=>(b.km||0)-(a.km||0))[0];
    const sonBakimKm=sonBakim?sonBakim.km:0;
    const fark=arac.km-sonBakimKm;
    if(fark>=aralik){
        const milestone=Math.floor(arac.km/aralik)*aralik;
        const hash=bildirimHashOlustur('km_bakim',arac.id,null,milestone,'km');
        const hedefler=getBildirimHedef(arac);
        hedefler.forEach(h=>{
            bildirimOlustur({tip:'km_bakim',seviye:km.seviye||'uyari',kategori:'arac-filo',baslik:'KM Bazli Bakim Hatirlatmasi',mesaj:arac.plaka+' - '+(arac.km||0).toLocaleString('tr-TR')+' km. Son bakimdan bu yana '+(fark).toLocaleString('tr-TR')+' km gecti.',aracId:arac.id,hedefKullaniciId:h.hedefKullaniciId,hedefRol:h.hedefRol,aksiyonTip:'arac-detay',aksiyonId:arac.id,hash:hash+(h.hedefKullaniciId||h.hedefRol||'')});
        });
    }
}
function kontrolKmBakim(){(S.araclar||[]).forEach(a=>kontrolKmBakimTekArac(a));}
function kontrolStokUyarilari(){
    const items=S.envanter||[];
    items.filter(i=>i.minStok>0&&i.miktar<=i.minStok).forEach(i=>{
        const hash=bildirimHashOlustur('stok_dusuk',null,i.id,i.miktar);
        bildirimOlustur({tip:'stok_dusuk',seviye:'uyari',kategori:'envanter',baslik:'Dusuk Stok Uyarisi',mesaj:i.ad+': '+i.miktar+' '+i.birim+' (min: '+i.minStok+')',envanterItemId:i.id,aksiyonTip:'envanter-detay',aksiyonId:i.id,hash});
    });
}
function tumKontrolleriCalistir(){
    // 90 gunden eski bildirimleri temizle
    const cutoff=new Date();cutoff.setDate(cutoff.getDate()-90);
    S.bildirimler=(S.bildirimler||[]).filter(b=>new Date(b.tarih)>=cutoff);
    kontrolBelgeSureleri();
    kontrolKmBakim();
    kontrolStokUyarilari();
    save();
    bildirimSayisiGuncelle();
}
function girisKritikModal(){
    const ay=S.bildirimAyarlar||{};
    if(!ay.girisModalGoster)return;
    const uid=currentUser?currentUser.id:1;
    const kritikler=bildirimlerKullanicininGoregi().filter(b=>(b.seviye==='kritik'||b.seviye==='acil')&&(!b.okunduDurumu||!b.okunduDurumu[uid]));
    if(kritikler.length===0)return;
    const c=document.getElementById('kritik-uyari-list');
    if(!c)return;
    c.innerHTML=kritikler.slice(0,15).map(b=>`<div class="flex items-start gap-2 p-2 rounded-lg border-l-3 ${BILDIRIM_SEVIYE_RENK[b.seviye]||''}" style="border-left:3px solid"><div class="flex-1"><div class="flex items-center gap-1"><span class="text-xs">${BILDIRIM_SEVIYE_ICON[b.seviye]||''}</span><span class="text-xs font-bold">${b.baslik}</span></div><p class="text-[10px] text-gray-400 mt-0.5">${b.mesaj}</p></div></div>`).join('');
    if(kritikler.length>15)c.innerHTML+=`<p class="text-[10px] text-gray-500 text-center mt-2">+${kritikler.length-15} daha...</p>`;
    openModal('modal-kritik-uyarilar');
}

// ===================== ARAC/FILO MODULE =====================
const ARAC_TIP_LABELS={sedan:'Sedan',suv:'SUV',kamyon:'Kamyon',van:'Van',pickup:'Pickup',minibus:'Minibus'};
const ARAC_DURUM_LABELS={aktif:'Aktif',serviste:'Serviste',beklemede:'Beklemede',pasif:'Pasif'};
const ARAC_DURUM_COLORS={aktif:'bg-green-500/20 text-green-400',serviste:'bg-orange-500/20 text-orange-400',beklemede:'bg-blue-500/20 text-blue-400',pasif:'bg-gray-500/20 text-gray-400'};
const BELGE_LABELS={muayene:'Muayene',sigorta:'Sigorta',kasko:'Kasko',egzoz:'Egzoz Emisyon'};
let aracResim=null;
let aracDetayId=null;

function getAracUyarilar(){
    const bugun=new Date();const uyariGun=30;
    let gecen=[],yaklasan=[],guncel=[];
    (S.araclar||[]).forEach(a=>{
        ['muayene','sigorta','kasko','egzoz'].forEach(bt=>{
            const b=a.belgeler&&a.belgeler[bt];
            if(!b||!b.bitisTarih)return;
            const bitis=new Date(b.bitisTarih);
            const kalanGun=Math.ceil((bitis-bugun)/(1000*60*60*24));
            const item={aracId:a.id,plaka:a.plaka,belgeTip:bt,belgeAd:BELGE_LABELS[bt],bitisTarih:b.bitisTarih,kalanGun};
            if(kalanGun<0)gecen.push(item);
            else if(kalanGun<=uyariGun)yaklasan.push(item);
            else guncel.push(item);
        });
    });
    return {gecen,yaklasan,guncel};
}

function renderDepoArac(){
    const c=document.getElementById('depo-tab-arac');if(!c)return;
    if(aracDetayId){renderAracDetay(aracDetayId);return;}
    const araclar=S.araclar||[];
    const uyarilar=getAracUyarilar();
    let html=`<div class="flex flex-wrap gap-2 mb-3"><button onclick="exportAracExcel()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-blue-600/20 text-blue-400 border border-blue-500/20">&#128203; Excel'e Aktar</button></div>`;
    // Uyari paneli
    html+=`<div class="grid grid-cols-3 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center ${uyarilar.gecen.length>0?'border border-red-500/30':''}"><p class="text-[10px] text-gray-400">Suresi Gecen</p><p class="text-xl font-bold ${uyarilar.gecen.length>0?'text-red-400':'text-gray-500'}">${uyarilar.gecen.length}</p></div>
        <div class="glass rounded-xl p-3 text-center ${uyarilar.yaklasan.length>0?'border border-amber-500/30':''}"><p class="text-[10px] text-gray-400">30 Gun Icinde</p><p class="text-xl font-bold ${uyarilar.yaklasan.length>0?'text-amber-400':'text-gray-500'}">${uyarilar.yaklasan.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Guncel</p><p class="text-xl font-bold text-green-400">${uyarilar.guncel.length}</p></div>
    </div>`;
    // Kritik uyarilar
    if(uyarilar.gecen.length>0){
        html+=`<div class="glass rounded-xl p-3 mb-4 border border-red-500/20"><p class="text-[10px] text-red-400 font-bold mb-2">&#9888; SURESI GECEN BELGELER</p>`;
        uyarilar.gecen.forEach(u=>html+=`<div class="flex items-center gap-2 text-[10px] mb-1"><span class="text-red-400 font-bold">${u.plaka}</span><span class="text-gray-400">${u.belgeAd}</span><span class="text-red-300">${u.bitisTarih} (${Math.abs(u.kalanGun)} gun gecti)</span></div>`);
        html+=`</div>`;
    }
    if(uyarilar.yaklasan.length>0){
        html+=`<div class="glass rounded-xl p-3 mb-4 border border-amber-500/20"><p class="text-[10px] text-amber-400 font-bold mb-2">&#9888; YAKLASAN BELGELER</p>`;
        uyarilar.yaklasan.forEach(u=>html+=`<div class="flex items-center gap-2 text-[10px] mb-1"><span class="text-amber-400 font-bold">${u.plaka}</span><span class="text-gray-400">${u.belgeAd}</span><span class="text-amber-300">${u.bitisTarih} (${u.kalanGun} gun kaldi)</span></div>`);
        html+=`</div>`;
    }
    // Arac kartlari
    if(araclar.length===0){
        html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz arac kaydi yok.</p><button onclick="openAracForm()" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs">+ Ilk Araci Ekle</button></div>';
    }else{
        html+=`<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
        araclar.forEach(a=>{
            const aracUyari=getAracBelgeDurum(a);
            const durumCol=ARAC_DURUM_COLORS[a.durum]||'';
            const thumb=a.resim?`<img src="${a.resim}" class="w-full h-24 rounded-t-lg object-cover">`:`<div class="w-full h-24 rounded-t-lg bg-gray-700/30 flex items-center justify-center text-2xl text-gray-600">&#128663;</div>`;
            html+=`<div class="glass rounded-xl overflow-hidden hover:border-blue-500/30 border border-transparent transition-all">
                ${thumb}
                <div class="p-3">
                    <div class="flex items-center justify-between mb-1"><span class="text-sm font-bold">${a.plaka}</span><span class="w-2.5 h-2.5 rounded-full ${aracUyari==='red'?'bg-red-500':aracUyari==='yellow'?'bg-amber-500':'bg-green-500'}"></span></div>
                    <p class="text-[10px] text-gray-400">${a.marka} ${a.model} ${a.yil||''}</p>
                    <div class="flex items-center gap-2 mt-1"><span class="px-1.5 py-0.5 rounded text-[9px] ${durumCol}">${ARAC_DURUM_LABELS[a.durum]||a.durum}</span><span class="text-[9px] text-gray-500">${(a.km||0).toLocaleString('tr-TR')} km</span></div>
                    ${a.zimmetliKisi?`<p class="text-[10px] text-gray-400 mt-1">&#128100; ${a.zimmetliKisi}</p>`:''}
                    <div class="flex gap-1 mt-2">
                        <button onclick="aracDetayId=${a.id};renderDepoArac();" class="flex-1 px-2 py-1 bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 rounded text-[10px]">Detay</button>
                        <button onclick="openAracForm(${a.id})" class="px-2 py-1 bg-gray-600/20 text-gray-400 hover:bg-gray-600/40 rounded text-[10px]">Duzenle</button>
                        <button onclick="openAracKayitForm(${a.id})" class="px-2 py-1 bg-green-600/20 text-green-400 hover:bg-green-600/40 rounded text-[10px]">+ Kayit</button>
                    </div>
                </div>
            </div>`;
        });
        html+=`</div>`;
    }
    c.innerHTML=html;
}

function getAracBelgeDurum(a){
    const bugun=new Date();
    let worst='green';
    ['muayene','sigorta','kasko','egzoz'].forEach(bt=>{
        const b=a.belgeler&&a.belgeler[bt];
        if(!b||!b.bitisTarih)return;
        const kalan=Math.ceil((new Date(b.bitisTarih)-bugun)/(1000*60*60*24));
        if(kalan<0)worst='red';
        else if(kalan<=30&&worst!=='red')worst='yellow';
    });
    return worst;
}

function renderAracDetay(aracId){
    const c=document.getElementById('depo-tab-arac');if(!c)return;
    const a=(S.araclar||[]).find(x=>x.id===aracId);
    if(!a){aracDetayId=null;renderDepoArac();return;}
    const bugun=new Date();
    let html=`<button onclick="aracDetayId=null;renderDepoArac();" class="mb-3 px-3 py-1.5 glass rounded-lg text-[11px] text-blue-400 hover:bg-blue-600/20">&larr; Tum Araclar</button>`;
    // Baslik
    const thumb=a.resim?`<img src="${a.resim}" class="w-20 h-20 rounded-lg object-cover">`:`<div class="w-20 h-20 rounded-lg bg-gray-700/30 flex items-center justify-center text-3xl text-gray-600">&#128663;</div>`;
    html+=`<div class="glass rounded-xl p-4 mb-4"><div class="flex gap-4 items-start">
        ${thumb}
        <div class="flex-1"><h3 class="text-lg font-bold">${a.plaka}</h3><p class="text-sm text-gray-400">${a.marka} ${a.model} ${a.yil||''} - ${a.renk||''}</p>
        <div class="flex gap-2 mt-1"><span class="px-2 py-0.5 rounded text-[10px] ${ARAC_DURUM_COLORS[a.durum]||''}">${ARAC_DURUM_LABELS[a.durum]||a.durum}</span><span class="text-[10px] text-gray-500">${(a.km||0).toLocaleString('tr-TR')} km</span><span class="text-[10px] text-gray-500">${a.yakitTipi||''}</span><span class="text-[10px] text-gray-500">${a.sahiplik||''}</span></div>
        ${a.zimmetliKisi?`<p class="text-xs text-amber-400 mt-1">&#128100; ${a.zimmetliKisi} (${a.zimmetDepartman||''})</p>`:''}
        </div>
        <div class="flex gap-1"><button onclick="openAracForm(${a.id})" class="px-2 py-1 glass rounded text-[10px] text-blue-400 hover:bg-blue-600/20">Duzenle</button><button onclick="printAracZimmetBelgesi(${a.id})" class="px-2 py-1 glass rounded text-[10px] text-gray-400 hover:bg-gray-600/20">&#128424; Zimmet Belgesi</button><button onclick="if(confirm('Bu araci silmek istediginize emin misiniz?')){deleteArac(${a.id});}" class="px-2 py-1 glass rounded text-[10px] text-red-400 hover:bg-red-600/20">Sil</button></div>
    </div></div>`;
    // Belgeler
    html+=`<h4 class="text-sm font-bold mb-2 text-amber-400">Belge Durumlari</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">`;
    ['muayene','sigorta','kasko','egzoz'].forEach(bt=>{
        const b=a.belgeler&&a.belgeler[bt];
        const bitis=b&&b.bitisTarih?b.bitisTarih:null;
        let kalanGun=null,durumRenk='gray',durumText='Bilgi yok';
        if(bitis){kalanGun=Math.ceil((new Date(bitis)-bugun)/(1000*60*60*24));if(kalanGun<0){durumRenk='red';durumText=Math.abs(kalanGun)+' gun gecti';}else if(kalanGun<=30){durumRenk='amber';durumText=kalanGun+' gun kaldi';}else{durumRenk='green';durumText=kalanGun+' gun kaldi';}}
        const extra=(bt==='sigorta'||bt==='kasko')&&b?`<p class="text-[9px] text-gray-600 mt-0.5">${b.policeNo||''} ${b.sirket||''}</p>`:'';
        html+=`<div class="glass rounded-lg p-3 border border-${durumRenk}-500/20"><p class="text-[9px] font-bold text-gray-400 mb-1">${BELGE_LABELS[bt]}</p><p class="text-xs font-bold text-${durumRenk}-400">${durumText}</p>${bitis?`<p class="text-[9px] text-gray-500">Bitis: ${bitis}</p>`:''}${extra}</div>`;
    });
    html+=`</div>`;
    // Bakim gecmisi
    const bakimlar=a.bakimlar||[];
    const topMaliyet=bakimlar.reduce((s,b)=>s+(b.maliyet||0),0);
    html+=`<div class="flex items-center justify-between mb-2"><h4 class="text-sm font-bold text-blue-400">Bakim Gecmisi (${bakimlar.length})</h4><div class="flex gap-2 items-center"><span class="text-[10px] text-gray-400">Toplam: <b class="text-blue-400">${topMaliyet.toLocaleString('tr-TR')} TL</b></span><button onclick="openAracKayitForm(${a.id},'bakim')" class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-[10px]">+ Bakim</button></div></div>`;
    if(bakimlar.length>0){
        html+=`<div class="overflow-x-auto mb-4"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-1.5">Tarih</th><th class="p-1.5">KM</th><th class="p-1.5">Islem</th><th class="p-1.5 text-right">Maliyet</th><th class="p-1.5">Servis</th><th class="p-1.5">Aciklama</th></tr></thead><tbody>`;
        bakimlar.slice().sort((a,b)=>b.tarih.localeCompare(a.tarih)).forEach(b=>{
            html+=`<tr class="border-b border-gray-800"><td class="p-1.5">${b.tarih}</td><td class="p-1.5">${(b.km||0).toLocaleString('tr-TR')}</td><td class="p-1.5 font-medium">${b.islem||''}</td><td class="p-1.5 text-right text-blue-400">${(b.maliyet||0).toLocaleString('tr-TR')} TL</td><td class="p-1.5 text-gray-400">${b.servis||''}</td><td class="p-1.5 text-gray-500">${b.aciklama||''}</td></tr>`;
        });
        html+=`</tbody></table></div>`;
    }else html+=`<p class="text-gray-500 text-[10px] mb-4">Henuz bakim kaydi yok.</p>`;
    // Lastik
    const lastikler=a.lastikler||[];
    html+=`<div class="flex items-center justify-between mb-2"><h4 class="text-sm font-bold text-purple-400">Lastik Kayitlari (${lastikler.length})</h4><button onclick="openAracKayitForm(${a.id},'lastik')" class="px-2 py-1 bg-purple-600/20 text-purple-400 rounded text-[10px]">+ Lastik</button></div>`;
    if(lastikler.length>0){
        html+=`<div class="overflow-x-auto mb-4"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-1.5">Tarih</th><th class="p-1.5">KM</th><th class="p-1.5">Tip</th><th class="p-1.5">Marka</th><th class="p-1.5">Not</th></tr></thead><tbody>`;
        lastikler.slice().sort((a,b)=>b.tarih.localeCompare(a.tarih)).forEach(l=>{
            html+=`<tr class="border-b border-gray-800"><td class="p-1.5">${l.tarih}</td><td class="p-1.5">${(l.km||0).toLocaleString('tr-TR')}</td><td class="p-1.5"><span class="px-1.5 py-0.5 rounded text-[9px] ${l.tip==='kis'?'bg-blue-500/20 text-blue-400':l.tip==='yaz'?'bg-orange-500/20 text-orange-400':'bg-green-500/20 text-green-400'}">${l.tip}</span></td><td class="p-1.5">${l.marka||''}</td><td class="p-1.5 text-gray-500">${l.notlar||''}</td></tr>`;
        });
        html+=`</tbody></table></div>`;
    }else html+=`<p class="text-gray-500 text-[10px] mb-4">Henuz lastik kaydi yok.</p>`;
    // Yakit
    const yakitlar=a.yakitKayitlari||[];
    const topYakit=yakitlar.reduce((s,y)=>s+(y.litre||0),0);
    const topTutar=yakitlar.reduce((s,y)=>s+(y.tutar||0),0);
    let ortTuketim='-';
    if(yakitlar.length>=2){const sorted=[...yakitlar].sort((a,b)=>a.km-b.km);const kmFark=sorted[sorted.length-1].km-sorted[0].km;const litreTop=sorted.slice(1).reduce((s,y)=>s+y.litre,0);if(kmFark>0)ortTuketim=(litreTop/kmFark*100).toFixed(1)+' lt/100km';}
    html+=`<div class="flex items-center justify-between mb-2"><h4 class="text-sm font-bold text-green-400">Yakit Kayitlari (${yakitlar.length})</h4><div class="flex gap-2 items-center"><span class="text-[10px] text-gray-400">Toplam: <b class="text-green-400">${topYakit.toFixed(0)} lt</b> / <b class="text-green-400">${topTutar.toLocaleString('tr-TR')} TL</b> | Ort: <b class="text-green-400">${ortTuketim}</b></span><button onclick="openAracKayitForm(${a.id},'yakit')" class="px-2 py-1 bg-green-600/20 text-green-400 rounded text-[10px]">+ Yakit</button></div></div>`;
    if(yakitlar.length>0){
        html+=`<div class="overflow-x-auto mb-4"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-1.5">Tarih</th><th class="p-1.5">KM</th><th class="p-1.5 text-right">Litre</th><th class="p-1.5 text-right">Tutar</th></tr></thead><tbody>`;
        yakitlar.slice().sort((a,b)=>b.tarih.localeCompare(a.tarih)).forEach(y=>{
            html+=`<tr class="border-b border-gray-800"><td class="p-1.5">${y.tarih}</td><td class="p-1.5">${(y.km||0).toLocaleString('tr-TR')}</td><td class="p-1.5 text-right">${y.litre} lt</td><td class="p-1.5 text-right text-green-400">${(y.tutar||0).toLocaleString('tr-TR')} TL</td></tr>`;
        });
        html+=`</tbody></table></div>`;
    }else html+=`<p class="text-gray-500 text-[10px] mb-4">Henuz yakit kaydi yok.</p>`;
    c.innerHTML=html;
}

// Arac CRUD
function handleAracResim(files){
    if(!files||!files[0])return;
    const file=files[0];if(file.size>512000){showNotif('Resim 500KB\'dan buyuk olamaz.');return;}
    const reader=new FileReader();
    reader.onload=e=>{aracResim=e.target.result;document.getElementById('ar-resim-preview').innerHTML=`<img src="${aracResim}" class="w-full h-full object-cover">`;document.getElementById('ar-resim-remove').classList.remove('hidden');};
    reader.readAsDataURL(file);
}
function clearAracResim(){aracResim=null;document.getElementById('ar-resim-preview').innerHTML='Arac Resmi<br>(maks 500KB)';document.getElementById('ar-resim-remove').classList.add('hidden');document.getElementById('ar-resim-input').value='';}

function openAracForm(editId){
    document.getElementById('arac-modal-title').textContent=editId?'Araci Duzenle':'Arac Ekle';
    document.getElementById('ar-edit-id').value='';
    document.getElementById('ar-plaka').value='';document.getElementById('ar-marka').value='';document.getElementById('ar-model').value='';
    document.getElementById('ar-yil').value='';document.getElementById('ar-renk').value='';document.getElementById('ar-tip').value='sedan';
    document.getElementById('ar-yakit').value='dizel';document.getElementById('ar-km').value='';document.getElementById('ar-sahiplik').value='sirket';
    document.getElementById('ar-sasi').value='';document.getElementById('ar-motor').value='';
    document.getElementById('ar-zimmetli').value='';document.getElementById('ar-departman').value='santiye';document.getElementById('ar-notlar').value='';
    document.getElementById('ar-muayene-son').value='';document.getElementById('ar-muayene-bitis').value='';
    document.getElementById('ar-sigorta-son').value='';document.getElementById('ar-sigorta-bitis').value='';document.getElementById('ar-sigorta-police').value='';document.getElementById('ar-sigorta-sirket').value='';
    document.getElementById('ar-kasko-son').value='';document.getElementById('ar-kasko-bitis').value='';document.getElementById('ar-kasko-police').value='';document.getElementById('ar-kasko-sirket').value='';
    document.getElementById('ar-egzoz-son').value='';document.getElementById('ar-egzoz-bitis').value='';
    aracResim=null;clearAracResim();
    if(editId){
        const a=(S.araclar||[]).find(x=>x.id===editId);
        if(a){
            document.getElementById('ar-edit-id').value=a.id;
            document.getElementById('ar-plaka').value=a.plaka||'';document.getElementById('ar-marka').value=a.marka||'';document.getElementById('ar-model').value=a.model||'';
            document.getElementById('ar-yil').value=a.yil||'';document.getElementById('ar-renk').value=a.renk||'';document.getElementById('ar-tip').value=a.tip||'sedan';
            document.getElementById('ar-yakit').value=a.yakitTipi||'dizel';document.getElementById('ar-km').value=a.km||'';document.getElementById('ar-sahiplik').value=a.sahiplik||'sirket';
            document.getElementById('ar-sasi').value=a.sasino||'';document.getElementById('ar-motor').value=a.motorNo||'';
            document.getElementById('ar-zimmetli').value=a.zimmetliKisi||'';document.getElementById('ar-departman').value=a.zimmetDepartman||'santiye';document.getElementById('ar-notlar').value=a.notlar||'';
            if(a.resim){aracResim=a.resim;document.getElementById('ar-resim-preview').innerHTML=`<img src="${a.resim}" class="w-full h-full object-cover">`;document.getElementById('ar-resim-remove').classList.remove('hidden');}
            const b=a.belgeler||{};
            if(b.muayene){document.getElementById('ar-muayene-son').value=b.muayene.sonTarih||'';document.getElementById('ar-muayene-bitis').value=b.muayene.bitisTarih||'';}
            if(b.sigorta){document.getElementById('ar-sigorta-son').value=b.sigorta.sonTarih||'';document.getElementById('ar-sigorta-bitis').value=b.sigorta.bitisTarih||'';document.getElementById('ar-sigorta-police').value=b.sigorta.policeNo||'';document.getElementById('ar-sigorta-sirket').value=b.sigorta.sirket||'';}
            if(b.kasko){document.getElementById('ar-kasko-son').value=b.kasko.sonTarih||'';document.getElementById('ar-kasko-bitis').value=b.kasko.bitisTarih||'';document.getElementById('ar-kasko-police').value=b.kasko.policeNo||'';document.getElementById('ar-kasko-sirket').value=b.kasko.sirket||'';}
            if(b.egzoz){document.getElementById('ar-egzoz-son').value=b.egzoz.sonTarih||'';document.getElementById('ar-egzoz-bitis').value=b.egzoz.bitisTarih||'';}
        }
    }
    openModal('modal-arac');
}

function addArac(){
    const plaka=document.getElementById('ar-plaka').value.trim();
    const marka=document.getElementById('ar-marka').value.trim();
    const model=document.getElementById('ar-model').value.trim();
    if(!plaka||!marka||!model){showNotif('Plaka, marka ve model zorunlu.');return;}
    const editId=+document.getElementById('ar-edit-id').value;
    const belgeler={
        muayene:{sonTarih:document.getElementById('ar-muayene-son').value||null,bitisTarih:document.getElementById('ar-muayene-bitis').value||null},
        sigorta:{sonTarih:document.getElementById('ar-sigorta-son').value||null,bitisTarih:document.getElementById('ar-sigorta-bitis').value||null,policeNo:document.getElementById('ar-sigorta-police').value.trim(),sirket:document.getElementById('ar-sigorta-sirket').value.trim()},
        kasko:{sonTarih:document.getElementById('ar-kasko-son').value||null,bitisTarih:document.getElementById('ar-kasko-bitis').value||null,policeNo:document.getElementById('ar-kasko-police').value.trim(),sirket:document.getElementById('ar-kasko-sirket').value.trim()},
        egzoz:{sonTarih:document.getElementById('ar-egzoz-son').value||null,bitisTarih:document.getElementById('ar-egzoz-bitis').value||null}
    };
    if(editId){
        const a=(S.araclar||[]).find(x=>x.id===editId);
        if(a){
            a.plaka=plaka;a.marka=marka;a.model=model;a.yil=+document.getElementById('ar-yil').value||null;a.renk=document.getElementById('ar-renk').value.trim();
            a.tip=document.getElementById('ar-tip').value;a.yakitTipi=document.getElementById('ar-yakit').value;a.km=+document.getElementById('ar-km').value||0;
            a.sahiplik=document.getElementById('ar-sahiplik').value;a.sasino=document.getElementById('ar-sasi').value.trim();a.motorNo=document.getElementById('ar-motor').value.trim();
            a.zimmetliKisi=document.getElementById('ar-zimmetli').value.trim();a.zimmetDepartman=document.getElementById('ar-departman').value;
            a.belgeler=belgeler;a.notlar=document.getElementById('ar-notlar').value.trim();
            if(aracResim)a.resim=aracResim;
            act('Arac guncellendi: '+plaka);
        }
    }else{
        if(!S.araclar)S.araclar=[];
        S.araclar.push({id:Date.now(),plaka,marka,model,yil:+document.getElementById('ar-yil').value||null,renk:document.getElementById('ar-renk').value.trim(),
            tip:document.getElementById('ar-tip').value,yakitTipi:document.getElementById('ar-yakit').value,sasino:document.getElementById('ar-sasi').value.trim(),motorNo:document.getElementById('ar-motor').value.trim(),
            km:+document.getElementById('ar-km').value||0,resim:aracResim,sahiplik:document.getElementById('ar-sahiplik').value,
            zimmetliKisi:document.getElementById('ar-zimmetli').value.trim(),zimmetDepartman:document.getElementById('ar-departman').value,
            durum:'aktif',belgeler,bakimlar:[],lastikler:[],yakitKayitlari:[],
            notlar:document.getElementById('ar-notlar').value.trim(),ekleyen:S.users[0]?.name||'',eklenmeTarihi:new Date().toISOString()});
        act('Yeni arac eklendi: '+plaka);
    }
    save();closeModal('modal-arac');renderDepoArac();showNotif(editId?'Arac guncellendi.':'Arac eklendi!');
    kontrolBelgeSureleri();bildirimSayisiGuncelle();
}

function deleteArac(id){
    S.araclar=(S.araclar||[]).filter(a=>a.id!==id);
    aracDetayId=null;save();renderDepoArac();showNotif('Arac silindi.');
}

// Arac Kayit (Bakim/Lastik/Yakit)
function toggleAracKayitFields(){
    const tip=document.getElementById('ark-tip').value;
    document.getElementById('ark-bakim-fields').classList.toggle('hidden',tip!=='bakim');
    document.getElementById('ark-lastik-fields').classList.toggle('hidden',tip!=='lastik');
    document.getElementById('ark-yakit-fields').classList.toggle('hidden',tip!=='yakit');
}
function openAracKayitForm(aracId,tip){
    document.getElementById('ark-arac-id').value=aracId;
    document.getElementById('ark-tip').value=tip||'bakim';
    document.getElementById('ark-tarih').value=new Date().toISOString().slice(0,10);
    const a=(S.araclar||[]).find(x=>x.id===aracId);
    document.getElementById('ark-km').value=a?a.km:'';
    document.getElementById('ark-islem').value='';document.getElementById('ark-maliyet').value='';document.getElementById('ark-servis').value='';document.getElementById('ark-aciklama').value='';
    document.getElementById('ark-lastik-tip').value='yaz';document.getElementById('ark-lastik-marka').value='';document.getElementById('ark-lastik-not').value='';
    document.getElementById('ark-litre').value='';document.getElementById('ark-tutar').value='';
    toggleAracKayitFields();
    openModal('modal-arac-kayit');
}
function addAracKayit(){
    const aracId=+document.getElementById('ark-arac-id').value;
    const a=(S.araclar||[]).find(x=>x.id===aracId);if(!a)return;
    const tip=document.getElementById('ark-tip').value;
    const tarih=document.getElementById('ark-tarih').value;
    const km=+document.getElementById('ark-km').value||0;
    if(km>a.km){a.km=km;kontrolKmBakimTekArac(a);}
    if(tip==='bakim'){
        const islem=document.getElementById('ark-islem').value.trim();if(!islem){showNotif('Islem alani zorunlu.');return;}
        if(!a.bakimlar)a.bakimlar=[];
        a.bakimlar.push({id:Date.now(),tarih,km,islem,maliyet:+document.getElementById('ark-maliyet').value||0,servis:document.getElementById('ark-servis').value.trim(),aciklama:document.getElementById('ark-aciklama').value.trim()});
        act(a.plaka+' - Bakim: '+islem);
    }else if(tip==='lastik'){
        if(!a.lastikler)a.lastikler=[];
        a.lastikler.push({id:Date.now(),tarih,km,tip:document.getElementById('ark-lastik-tip').value,marka:document.getElementById('ark-lastik-marka').value.trim(),notlar:document.getElementById('ark-lastik-not').value.trim()});
        act(a.plaka+' - Lastik degisimi');
    }else{
        const litre=+document.getElementById('ark-litre').value||0;if(litre<=0){showNotif('Litre girin.');return;}
        if(!a.yakitKayitlari)a.yakitKayitlari=[];
        a.yakitKayitlari.push({id:Date.now(),tarih,km,litre,tutar:+document.getElementById('ark-tutar').value||0});
        act(a.plaka+' - Yakit: '+litre+'lt');
    }
    save();closeModal('modal-arac-kayit');
    if(aracDetayId===aracId)renderAracDetay(aracId);else renderDepoArac();
    showNotif('Kayit eklendi!');
}

// Print & Export
function printAracZimmetBelgesi(aracId){
    const a=(S.araclar||[]).find(x=>x.id===aracId);if(!a)return;
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Arac Zimmet Belgesi</title><style>body{font-family:Arial,sans-serif;font-size:12px;padding:30px;color:#1e293b;}h1{font-size:18px;text-align:center;margin-bottom:4px;}h2{font-size:11px;text-align:center;color:#64748b;margin-bottom:20px;}table{width:100%;border-collapse:collapse;margin:12px 0;}th,td{border:1px solid #cbd5e1;padding:6px 10px;text-align:left;font-size:11px;}th{background:#f1f5f9;}.sign-area{display:flex;justify-content:space-between;margin-top:50px;}.sign-box{width:40%;text-align:center;border-top:1px solid #94a3b8;padding-top:8px;font-size:10px;color:#64748b;}@media print{body{padding:15px;}}</style></head><body>`);
    w.document.write(`<h1>ARAC ZIMMET / TAHSIS BELGESI</h1><h2>FaOnSisT - Filo Yonetimi &middot; ${new Date().toLocaleDateString('tr-TR')}</h2>`);
    w.document.write(`<table><tr><th style="width:30%">Plaka</th><td><b>${a.plaka}</b></td><th style="width:20%">Tarih</th><td>${new Date().toLocaleDateString('tr-TR')}</td></tr><tr><th>Arac</th><td>${a.marka} ${a.model} ${a.yil||''}</td><th>Renk</th><td>${a.renk||'-'}</td></tr><tr><th>Yakit Tipi</th><td>${a.yakitTipi||'-'}</td><th>KM</th><td>${(a.km||0).toLocaleString('tr-TR')}</td></tr><tr><th>Sasi No</th><td>${a.sasino||'-'}</td><th>Motor No</th><td>${a.motorNo||'-'}</td></tr><tr><th>Sahiplik</th><td>${a.sahiplik||'-'}</td><th>Durum</th><td>${ARAC_DURUM_LABELS[a.durum]||a.durum}</td></tr></table>`);
    w.document.write(`<h3 style="font-size:13px;margin-top:20px;">Zimmet Bilgileri</h3><table><tr><th style="width:30%">Teslim Alan</th><td><b>${a.zimmetliKisi||'-'}</b></td></tr><tr><th>Departman</th><td>${a.zimmetDepartman||'-'}</td></tr></table>`);
    const b=a.belgeler||{};
    w.document.write(`<h3 style="font-size:13px;margin-top:20px;">Belge Durumlari</h3><table><tr><th>Belge</th><th>Son Tarih</th><th>Bitis Tarihi</th></tr><tr><td>Muayene</td><td>${b.muayene?b.muayene.sonTarih||'-':'-'}</td><td>${b.muayene?b.muayene.bitisTarih||'-':'-'}</td></tr><tr><td>Sigorta</td><td>${b.sigorta?b.sigorta.sonTarih||'-':'-'}</td><td>${b.sigorta?b.sigorta.bitisTarih||'-':'-'}</td></tr><tr><td>Kasko</td><td>${b.kasko?b.kasko.sonTarih||'-':'-'}</td><td>${b.kasko?b.kasko.bitisTarih||'-':'-'}</td></tr><tr><td>Egzoz Emisyon</td><td>${b.egzoz?b.egzoz.sonTarih||'-':'-'}</td><td>${b.egzoz?b.egzoz.bitisTarih||'-':'-'}</td></tr></table>`);
    if(a.notlar)w.document.write(`<p style="font-size:10px;color:#64748b;margin-top:8px;">Not: ${a.notlar}</p>`);
    w.document.write(`<div style="margin-top:15px;padding:10px;background:#f8fafc;border-radius:6px;font-size:9px;color:#64748b;">Bu belge ile teslim alinan arac, teslim alan kisinin sorumlulugundadir. Aracin hasar gormesi, trafik cezasi, yakit masraflari ve gunluk bakimi teslim alan kisiye aittir.</div>`);
    w.document.write(`<div class="sign-area"><div class="sign-box"><b>Teslim Eden</b><br>(Filo Sorumlusu)<br><br><br>________________<br>Tarih: ___/___/______</div><div class="sign-box"><b>Teslim Alan</b><br><br><br><br>${a.zimmetliKisi||'________________'}<br>Tarih: ${new Date().toLocaleDateString('tr-TR')}</div></div>`);
    w.document.write(`<div style="margin-top:40px;text-align:center;font-size:9px;color:#94a3b8;">FaOnSisT v5.0 - Arac Zimmet Belgesi &middot; ${new Date().toLocaleString('tr-TR')}</div><script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
    w.document.close();
}

function exportAracExcel(){
    if(typeof XLSX==='undefined'){showNotif('XLSX kutuphanesi yuklenemedi.');return;}
    const items=S.araclar||[];if(items.length===0){showNotif('Aktarilacak arac yok.');return;}
    const data=items.map(a=>{
        const b=a.belgeler||{};
        return {'Plaka':a.plaka,'Marka':a.marka,'Model':a.model,'Yil':a.yil||'','Tip':ARAC_TIP_LABELS[a.tip]||a.tip,'Yakit':a.yakitTipi||'','KM':a.km||0,'Sahiplik':a.sahiplik||'','Durum':ARAC_DURUM_LABELS[a.durum]||a.durum,'Zimmetli':a.zimmetliKisi||'','Departman':a.zimmetDepartman||'','Muayene Bitis':b.muayene?b.muayene.bitisTarih||'':'','Sigorta Bitis':b.sigorta?b.sigorta.bitisTarih||'':'','Kasko Bitis':b.kasko?b.kasko.bitisTarih||'':'','Bakim Sayisi':(a.bakimlar||[]).length,'Toplam Bakim Maliyeti':(a.bakimlar||[]).reduce((s,x)=>s+(x.maliyet||0),0)};
    });
    const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Araclar');
    XLSX.writeFile(wb,'FaOnSisT_Araclar_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showNotif('Arac listesi Excel olarak indirildi.');
}

// ===================== DEMO DATA =====================
function initDemoDataAndRender(){
if(S.projects.length===0){
    const now=new Date().toISOString();
    S.projects=[
        {id:1001,name:'Atasehir Rezidans A Blok',budget:45000000,spent:8750000,contractor:'FaOn Insaat A.S.',manager:'Mehmet Kaya',completion:35,notes:'32 katli konut projesi, 2.etap',status:'approved',createdAt:now,projectType:'konut',location:'Atasehir, Istanbul',startDate:'2025-03-01',endDate:'2027-06-30',contractType:'goturu',contractAmount:42000000,
        taseronlar:[
            {id:2001,firma:'ABC Kaba Insaat Ltd.',isPaketi:'Kaba Insaat',yetkili:'Ali Yilmaz',telefon:'0532 111 2233',tutar:12000000,baslangic:'2025-03-15',kapsam:'Betonarme karkas, kalip, demir isleri',durum:'aktif',odemeler:[],createdAt:now},
            {id:2002,firma:'Delta Elektrik A.S.',isPaketi:'Elektrik Tesisati',yetkili:'Veli Kara',telefon:'0533 222 3344',tutar:4500000,baslangic:'2025-06-01',kapsam:'Kuvvetli ve zayif akim tesisati',durum:'aktif',odemeler:[],createdAt:now},
            {id:2003,firma:'Su-Tek Tesisat',isPaketi:'Sihhi Tesisat',yetkili:'Hasan Demir',telefon:'0535 333 4455',tutar:3200000,baslangic:'2025-06-01',kapsam:'Temiz su, pis su, yagmur suyu',durum:'aktif',odemeler:[],createdAt:now}
        ],
        tedarikciler:[
            {id:3001,firma:'Demir Trade A.S.',malzeme:'Insaat Demiri',yetkili:'Kemal Oz',telefon:'0536 444 5566',tutar:5600000,puan:4,createdAt:now},
            {id:3002,firma:'Beton-San Ltd.',malzeme:'Hazir Beton',yetkili:'Murat Tas',telefon:'0537 555 6677',tutar:3800000,puan:5,createdAt:now}
        ],
        isKalemleri:[
            {id:4001,pozNo:'04.013/1',kalemAdi:'Betonarme Karkas',kategori:'insaat',miktar:8500,birim:'m3',birimFiyat:2800,toplamTutar:23800000,agirlik:35,taseronId:'2001',gerceklesen:2975,createdAt:now},
            {id:4002,pozNo:'18.071/2',kalemAdi:'Elektrik Tesisati',kategori:'elektrik',miktar:32000,birim:'mt',birimFiyat:120,toplamTutar:3840000,agirlik:15,taseronId:'2002',gerceklesen:6400,createdAt:now},
            {id:4003,pozNo:'19.042/1',kalemAdi:'Sihhi Tesisat',kategori:'mekanik',miktar:18000,birim:'mt',birimFiyat:85,toplamTutar:1530000,agirlik:12,taseronId:'2003',gerceklesen:3600,createdAt:now},
            {id:4004,pozNo:'27.003/5',kalemAdi:'Dis Cephe Kaplama',kategori:'insaat',miktar:12000,birim:'m2',birimFiyat:450,toplamTutar:5400000,agirlik:20,taseronId:'',gerceklesen:0,createdAt:now},
            {id:4005,pozNo:'26.011/1',kalemAdi:'Ic Boya-Siva',kategori:'insaat',miktar:45000,birim:'m2',birimFiyat:85,toplamTutar:3825000,agirlik:10,taseronId:'',gerceklesen:4500,createdAt:now},
            {id:4006,pozNo:'28.062/3',kalemAdi:'Peyzaj Duzenleme',kategori:'peyzaj',miktar:3500,birim:'m2',birimFiyat:200,toplamTutar:700000,agirlik:8,taseronId:'',gerceklesen:0,createdAt:now}
        ],
        hakedisler:[
            {id:5001,no:'HK-001',tip:'ara',taseronId:null,donem:'2025-04',tarih:'2025-04-30',kalemler:[
                {kalemId:4001,pozNo:'04.013/1',kalemAdi:'Betonarme Karkas',birim:'m3',sozlesmeMiktar:8500,birimFiyat:2800,sozlesmeTutar:23800000,oncekiToplam:0,buDonemMiktar:1500,toplamImalat:1500,buDonemTutar:4200000,toplamHakedisTutar:4200000,kalanMiktar:7000,imalatYuzdesi:17.6}
            ],isKalemleriToplam:4200000,fiyatFarkiOran:0,fiyatFarkiTutar:0,araToplam:4200000,kdvOran:20,kdv:840000,genelToplam:5040000,
            kesintiler:{teminat:{oran:10,tutar:504000},stopaj:{oran:5,tutar:252000},sgk:{oran:0,tutar:0},avans:{tutar:0},diger:{tutar:0}},
            toplamKesinti:756000,net:4284000,toplam:4200000,stopaj:252000,
            durum:'onaylandi',hazirlayan:'Sistem',kontrolEden:'Ahmet Yilmaz',onaylayan:'Mehmet Kaya',aciklama:'1. ay betonarme isleri',createdAt:now},
            {id:5002,no:'HK-002',tip:'ara',taseronId:null,donem:'2025-06',tarih:'2025-06-30',kalemler:[
                {kalemId:4001,pozNo:'04.013/1',kalemAdi:'Betonarme Karkas',birim:'m3',sozlesmeMiktar:8500,birimFiyat:2800,sozlesmeTutar:23800000,oncekiToplam:1500,buDonemMiktar:1475,toplamImalat:2975,buDonemTutar:4130000,toplamHakedisTutar:8330000,kalanMiktar:5525,imalatYuzdesi:35},
                {kalemId:4002,pozNo:'18.071/2',kalemAdi:'Elektrik Tesisati',birim:'mt',sozlesmeMiktar:32000,birimFiyat:120,sozlesmeTutar:3840000,oncekiToplam:0,buDonemMiktar:6400,toplamImalat:6400,buDonemTutar:768000,toplamHakedisTutar:768000,kalanMiktar:25600,imalatYuzdesi:20}
            ],isKalemleriToplam:4898000,fiyatFarkiOran:0,fiyatFarkiTutar:0,araToplam:4898000,kdvOran:20,kdv:979600,genelToplam:5877600,
            kesintiler:{teminat:{oran:10,tutar:587760},stopaj:{oran:5,tutar:293880},sgk:{oran:0,tutar:0},avans:{tutar:0},diger:{tutar:0}},
            toplamKesinti:881640,net:4995960,toplam:4898000,stopaj:293880,
            durum:'kontrol',hazirlayan:'Sistem',kontrolEden:'',onaylayan:'',aciklama:'2. ay betonarme + elektrik baslangic',createdAt:now}
        ],
        santiyeGunlugu:[
            {id:6001,tarih:'2025-06-10',hava:'gunesli',isciSayisi:45,teknisyen:8,muhendis:4,yapilanIsler:'3. kat kalip montaji tamamlandi, 4. kat demir baglama basladi. Beton dokumu icin planlama yapildi.',sorunlar:'',createdAt:now},
            {id:6002,tarih:'2025-06-11',hava:'bulutlu',isciSayisi:42,teknisyen:6,muhendis:3,yapilanIsler:'4. kat demir baglama devam, elektrik boru doseme 1-2. kat tamamlandi.',sorunlar:'Demir teslimatinda 1 gun gecikme var.',createdAt:now},
            {id:6003,tarih:'2025-06-12',hava:'yagmurlu',isciSayisi:20,teknisyen:4,muhendis:2,yapilanIsler:'Yagis nedeniyle dis cephe isleri durdu. Ic mekanda sihhi tesisat calismasi yapildi.',sorunlar:'Yagmur nedeniyle beton dokumu ertelendi.',createdAt:now}
        ],
        milestones:[],expenses:[],tasks:[{id:7001,text:'Is guvenligi egitimi',done:true},{id:7002,text:'3.kat beton kontrolu',done:true},{id:7003,text:'Asansor projesi onayi',done:false}],
        yesilDefter:[
            {id:8001,tip:'atasman',tarih:'2025-06-10',kalemId:4001,miktar:125,konum:'A1-B3 arasi 3.kat'},
            {id:8002,tip:'atasman',tarih:'2025-06-11',kalemId:4001,miktar:98,konum:'C1-D2 arasi 4.kat'},
            {id:8003,tip:'puantaj',tarih:'2025-06-10',isci:'Ahmet Kaya',meslek:'Kalipci',giris:'07:30',cikis:'17:30',fazlaMesai:2},
            {id:8004,tip:'puantaj',tarih:'2025-06-10',isci:'Mehmet Oz',meslek:'Demirci',giris:'08:00',cikis:'18:00',fazlaMesai:1}
        ],
        sozlesmeler:[
            {id:9001,tip:'ana',no:'SZ-2025/001',tarih:'2025-02-15',bedel:42000000,aciklama:'Ana sozlesme - goturu bedel'},
            {id:9002,tip:'ek',no:'EK-001',tarih:'2025-05-20',bedel:3000000,aciklama:'Asansor sistemi ek sozlesme'},
            {id:9003,tip:'teminat',no:'TM-001',tarih:'2025-03-01',bedel:4200000,banka:'Is Bankasi',teminatTutar:4200000,vade:'2027-12-31'}
        ],
        malzemeStok:[
            {id:10001,malzeme:'Insaat Demiri (12mm)',miktar:45,birim:'ton',minStok:20,hareketler:[{id:10101,tarih:'2025-06-05',tip:'giris',miktar:30,irsaliyeNo:'IRS-2025/045'},{id:10102,tarih:'2025-06-10',tip:'cikis',miktar:8,irsaliyeNo:''}]},
            {id:10002,malzeme:'Hazir Beton C30',miktar:120,birim:'m3',minStok:50,hareketler:[{id:10103,tarih:'2025-06-08',tip:'giris',miktar:200,irsaliyeNo:'IRS-2025/052'},{id:10104,tarih:'2025-06-11',tip:'cikis',miktar:80,irsaliyeNo:''}]},
            {id:10003,malzeme:'Kalip Paneli',miktar:15,birim:'adet',minStok:30,hareketler:[]}
        ],
        nakitAkisi:[
            {id:11001,ay:'2025-03',gelir:5000000,gider:1200000,taseronOdeme:2500000,notlar:'Baslangic hak edisi'},
            {id:11002,ay:'2025-04',gelir:4200000,gider:800000,taseronOdeme:1800000,notlar:'1. hakedis odemesi'},
            {id:11003,ay:'2025-05',gelir:3500000,gider:950000,taseronOdeme:2100000,notlar:'Demir ve beton alimlari'},
            {id:11004,ay:'2025-06',gelir:4900000,gider:1100000,taseronOdeme:2400000,notlar:'2. hakedis odemesi'}
        ],
        isg:{
            riskler:[
                {id:12001,tarih:'2025-03-10',aciklama:'Yuksekte calisma - guvenlik agi eksik',konum:'3. kat dis cephe',seviye:'yuksek'},
                {id:12002,tarih:'2025-04-15',aciklama:'Elektrik pano kapagi acik',konum:'Bodrum kat',seviye:'orta'},
                {id:12003,tarih:'2025-05-20',aciklama:'Malzeme istifleme alani duzensiz',konum:'Santiye girisi',seviye:'dusuk'}
            ],
            kazalar:[
                {id:12101,tarih:'2025-05-02',aciklama:'Isci ayagindan incinme',kazaTipi:'Dusme',yarali:1}
            ],
            egitimler:[
                {id:12201,tarih:'2025-03-05',konu:'Yuksekte Calisma Guvenligi',katilimci:45},
                {id:12202,tarih:'2025-04-10',konu:'Yangin Guvenligi ve Tahliye',katilimci:52},
                {id:12203,tarih:'2025-06-01',konu:'Kisisel Koruyucu Donanimlar',katilimci:38}
            ],
            denetimler:[
                {id:12301,tarih:'2025-04-20',aciklama:'ISG Genel Denetimi - Q2',sonuc:'sartli'},
                {id:12302,tarih:'2025-06-15',aciklama:'Yangin Guvenligi Denetimi',sonuc:'uygun'}
            ]
        },
        kaliteKontrol:{
            testler:[
                {id:13001,tarih:'2025-04-05',aciklama:'Beton basinc testi - 3.kat',konum:'A1 kolonu',sonuc:'gecti'},
                {id:13002,tarih:'2025-04-12',aciklama:'Beton basinc testi - 4.kat',konum:'B2 kirisi',sonuc:'gecti'},
                {id:13003,tarih:'2025-05-10',aciklama:'Demir cekme testi',konum:'Lab',sonuc:'gecti'},
                {id:13004,tarih:'2025-06-05',aciklama:'Kaynak dikis kontrolu',konum:'Celik baglanti',sonuc:'kaldi'}
            ],
            ncrler:[
                {id:13101,tarih:'2025-05-15',aciklama:'Beton vibrasyon yetersiz - bosluk tespit',no:'NCR-001',durum:'kapandi'},
                {id:13102,tarih:'2025-06-08',aciklama:'Pas payi eksik - 4. kat plak',no:'NCR-002',durum:'acik'}
            ],
            punchList:[
                {id:13201,tarih:'2025-06-10',aciklama:'1.kat kolon yuzey duzeltme',konum:'A1 kolonu',oncelik:'normal',done:true},
                {id:13202,tarih:'2025-06-10',aciklama:'Merdiven korkuluk montaji',konum:'B merdiveni',oncelik:'yuksek',done:false},
                {id:13203,tarih:'2025-06-12',aciklama:'Su yalitim kontrolu',konum:'Bodrum',oncelik:'yuksek',done:false}
            ]
        },
        yazismalar:[
            {id:14001,tip:'giden',no:'YZ-2025/001',tarih:'2025-03-15',konu:'Is baslangic bildirimi',gonderenAlici:'Atasehir Belediyesi',kategori:'resmi',durum:'cevaplandi'},
            {id:14002,tip:'gelen',no:'YZ-2025/002',tarih:'2025-04-20',konu:'Proje revizyon talebi',gonderenAlici:'Tasarim Ofisi',kategori:'teknik',durum:'kapandi'},
            {id:14003,tip:'giden',no:'YZ-2025/003',tarih:'2025-06-01',konu:'2. Hakedis gonderim yazisi',gonderenAlici:'Isveren',kategori:'idari',durum:'acik'}
        ],
        isProgrami:[
            {id:15001,ad:'Temel Kazisi',baslangic:'2025-03-01',sure:15,bagimlilik:0,bagimlilikTip:'FS',sorumlu:'Ali Yilmaz',ilerleme:100},
            {id:15002,ad:'Betonarme Karkas',baslangic:'2025-03-20',sure:90,bagimlilik:15001,bagimlilikTip:'FS',sorumlu:'Ali Yilmaz',ilerleme:65},
            {id:15003,ad:'Elektrik Tesisat Altyapi',baslangic:'2025-05-15',sure:60,bagimlilik:15002,bagimlilikTip:'SS',sorumlu:'Veli Kara',ilerleme:30},
            {id:15004,ad:'Sihhi Tesisat',baslangic:'2025-05-20',sure:55,bagimlilik:15002,bagimlilikTip:'SS',sorumlu:'Hasan Demir',ilerleme:25},
            {id:15005,ad:'Dis Cephe',baslangic:'2025-08-01',sure:45,bagimlilik:15002,bagimlilikTip:'FS',sorumlu:'',ilerleme:0}
        ],
        ekipmanlar:[
            {id:16001,ad:'CAT 320 Ekskavat√∂r',tip:'Ekskavat√∂r',plaka:'34 ABC 123',sahiplik:'kiralik',gunlukMaliyet:8500,
                calismaKayitlari:[{tarih:'2025-06-10',saat:8},{tarih:'2025-06-11',saat:7},{tarih:'2025-06-12',saat:4}],
                bakimlar:[{tarih:'2025-06-09',aciklama:'Motor yag degisimi'}],
                yakitKayitlari:[{tarih:'2025-06-10',litre:120},{tarih:'2025-06-11',litre:95}]},
            {id:16002,ad:'Liebherr Kule Vinc',tip:'Vinc',plaka:'',sahiplik:'kiralik',gunlukMaliyet:15000,
                calismaKayitlari:[{tarih:'2025-06-10',saat:10},{tarih:'2025-06-11',saat:9}],
                bakimlar:[],
                yakitKayitlari:[{tarih:'2025-06-10',litre:80}]}
        ]},
        {id:1002,name:'Kadikoy Ticaret Merkezi',budget:28000000,spent:3200000,contractor:'FaOn Insaat A.S.',manager:'Ayse Demir',completion:18,notes:'5 katli ticari proje, bodrum + 4 kat',status:'reviewing',createdAt:now,projectType:'ticari',location:'Kadikoy, Istanbul',startDate:'2025-05-01',endDate:'2026-12-31',contractType:'birimfiyat',contractAmount:26500000,
        taseronlar:[
            {id:2004,firma:'Celik-Pro Imalat',isPaketi:'Celik Imalat',yetkili:'Osman Celik',telefon:'0538 666 7788',tutar:8500000,baslangic:'2025-05-15',kapsam:'Celik konstruksiyon, montaj',durum:'aktif',odemeler:[],createdAt:now}
        ],
        tedarikciler:[
            {id:3003,firma:'Yildiz Cimento',malzeme:'Cimento',yetkili:'Fatma Han',telefon:'0539 777 8899',tutar:1200000,puan:3,createdAt:now}
        ],
        isKalemleri:[
            {id:4007,pozNo:'10.005/1',kalemAdi:'Celik Konstruksiyon',kategori:'insaat',miktar:450,birim:'ton',birimFiyat:28000,toplamTutar:12600000,agirlik:40,taseronId:'2004',gerceklesen:81,createdAt:now},
            {id:4008,pozNo:'04.013/2',kalemAdi:'Betonarme Temel',kategori:'insaat',miktar:2200,birim:'m3',birimFiyat:3200,toplamTutar:7040000,agirlik:30,taseronId:'',gerceklesen:660,createdAt:now},
            {id:4009,pozNo:'19.055/1',kalemAdi:'Mekanik Tesisat',kategori:'mekanik',miktar:8000,birim:'mt',birimFiyat:150,toplamTutar:1200000,agirlik:15,taseronId:'',gerceklesen:0,createdAt:now},
            {id:4010,pozNo:'19.090/1',kalemAdi:'Yangin Tesisati',kategori:'mekanik',miktar:4000,birim:'mt',birimFiyat:180,toplamTutar:720000,agirlik:15,taseronId:'',gerceklesen:0,createdAt:now}
        ],
        hakedisler:[
            {id:5003,no:'HK-001',tip:'ara',taseronId:null,donem:'2025-06',tarih:'2025-06-30',kalemler:[
                {kalemId:4008,pozNo:'04.013/2',kalemAdi:'Betonarme Temel',birim:'m3',sozlesmeMiktar:2200,birimFiyat:3200,sozlesmeTutar:7040000,oncekiToplam:0,buDonemMiktar:660,toplamImalat:660,buDonemTutar:2112000,toplamHakedisTutar:2112000,kalanMiktar:1540,imalatYuzdesi:30}
            ],isKalemleriToplam:2112000,fiyatFarkiOran:0,fiyatFarkiTutar:0,araToplam:2112000,kdvOran:20,kdv:422400,genelToplam:2534400,
            kesintiler:{teminat:{oran:10,tutar:253440},stopaj:{oran:5,tutar:126720},sgk:{oran:0,tutar:0},avans:{tutar:0},diger:{tutar:0}},
            toplamKesinti:380160,net:2154240,toplam:2112000,stopaj:126720,
            durum:'onaylandi',hazirlayan:'Sistem',kontrolEden:'Fatma Celik',onaylayan:'Ayse Demir',aciklama:'Temel betonu 1.etap',createdAt:now}
        ],
        santiyeGunlugu:[
            {id:6004,tarih:'2025-06-12',hava:'gunesli',isciSayisi:30,teknisyen:5,muhendis:2,yapilanIsler:'Celik kolonlarin montajina baslandi. Temel izolasyonu tamamlandi.',sorunlar:'',createdAt:now}
        ],
        milestones:[],expenses:[],tasks:[{id:7004,text:'Belediye ruhsat onayi',done:true},{id:7005,text:'Celik malzeme siparis takibi',done:false}],
        yesilDefter:[
            {id:8101,tip:'atasman',tarih:'2025-06-12',kalemId:4008,miktar:85,konum:'A aksƒ± temel'}
        ],
        sozlesmeler:[
            {id:9101,tip:'ana',no:'SZ-2025/002',tarih:'2025-04-10',bedel:26500000,aciklama:'Birim fiyat sozlesmesi'},
            {id:9102,tip:'teminat',no:'TM-002',tarih:'2025-04-15',bedel:2650000,banka:'Garanti BBVA',teminatTutar:2650000,vade:'2027-06-30'}
        ],
        malzemeStok:[
            {id:10101,malzeme:'Celik Profil HEA200',miktar:85,birim:'ton',minStok:30,hareketler:[{id:10201,tarih:'2025-06-01',tip:'giris',miktar:100,irsaliyeNo:'IRS-2025/088'},{id:10202,tarih:'2025-06-10',tip:'cikis',miktar:15,irsaliyeNo:''}]}
        ],
        nakitAkisi:[
            {id:11101,ay:'2025-05',gelir:3500000,gider:600000,taseronOdeme:1500000,notlar:'Baslangic'},
            {id:11102,ay:'2025-06',gelir:2100000,gider:450000,taseronOdeme:1200000,notlar:'Celik tedarik'}
        ],
        isg:{riskler:[{id:12401,tarih:'2025-05-20',aciklama:'Celik montaj alani korkuluk eksik',konum:'1. kat',seviye:'yuksek'}],kazalar:[],
            egitimler:[{id:12501,tarih:'2025-05-10',konu:'Celik Montaj Guvenligi',katilimci:28}],
            denetimler:[{id:12601,tarih:'2025-06-10',aciklama:'Santiye genel denetim',sonuc:'uygun'}]},
        kaliteKontrol:{testler:[{id:13301,tarih:'2025-06-05',aciklama:'Celik kaynak ultrasonic test',konum:'Kolon baglanti',sonuc:'gecti'}],
            ncrler:[],punchList:[{id:13401,tarih:'2025-06-12',aciklama:'Temel su yalitim eksik',konum:'B aksƒ±',oncelik:'yuksek',done:false}]},
        yazismalar:[{id:14101,tip:'giden',no:'YZ-K-001',tarih:'2025-05-05',konu:'Celik montaj plani gonderimi',gonderenAlici:'Celik-Pro Imalat',kategori:'teknik',durum:'cevaplandi'}],
        isProgrami:[
            {id:15101,ad:'Temel Insaat',baslangic:'2025-05-01',sure:30,bagimlilik:0,bagimlilikTip:'FS',sorumlu:'Osman Celik',ilerleme:100},
            {id:15102,ad:'Celik Konstruksiyon',baslangic:'2025-06-01',sure:75,bagimlilik:15101,bagimlilikTip:'FS',sorumlu:'Osman Celik',ilerleme:20},
            {id:15103,ad:'Mekanik Tesisat',baslangic:'2025-08-01',sure:45,bagimlilik:15102,bagimlilikTip:'SS',sorumlu:'',ilerleme:0}
        ],
        ekipmanlar:[
            {id:16101,ad:'Mobil Vinc 50T',tip:'Vinc',plaka:'34 DEF 456',sahiplik:'kiralik',gunlukMaliyet:12000,
                calismaKayitlari:[{tarih:'2025-06-10',saat:6},{tarih:'2025-06-11',saat:8}],bakimlar:[],yakitKayitlari:[{tarih:'2025-06-10',litre:90}]}
        ]}
    ];
    save();
}
// Depo demo data
if((S.depolar||[]).length===0){
    S.depolar=[
        {id:9001,ad:'Merkez Depo',konum:'Atasehir, Istanbul',tip:'merkez',sorumlu:'Ahmet Yildiz',aktif:true},
        {id:9002,ad:'Santiye-1 Sahasi',konum:'Atasehir Proje Alani',tip:'santiye',sorumlu:'Mehmet Kaya',aktif:true},
        {id:9003,ad:'Ofis Deposu',konum:'Levent Merkez Ofis',tip:'ofis',sorumlu:'Ayse Demir',aktif:true}
    ];
    S.envanter=[
        {id:9101,ad:'Cimento (CEM I 42.5)',kategori:'insaat',depoId:9001,barkod:'INS-001',birim:'ton',miktar:85,minStok:20,birimFiyat:3200,tedarikci:'Akcansa',notlar:'',resim:null,ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2025-05-15T09:00:00',sonGuncelleyen:'Mehmet Kaya',guncellemeTarihi:'2025-06-01T14:30:00'},
        {id:9102,ad:'Insaat Demiri (Q12)',kategori:'insaat',depoId:9001,barkod:'INS-002',birim:'ton',miktar:42,minStok:10,birimFiyat:18500,tedarikci:'Kardemir',notlar:'',resim:null,ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2025-05-15T09:10:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9103,ad:'Hazir Beton C30',kategori:'insaat',depoId:9002,barkod:'INS-003',birim:'m3',miktar:15,minStok:50,birimFiyat:2800,tedarikci:'Beton-San',notlar:'Dusuk stok - siparis verilecek',resim:null,ekleyen:'Mehmet Kaya',eklenmeTarihi:'2025-05-16T10:00:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9104,ad:'Dis Cephe Boyasi',kategori:'insaat',depoId:9001,barkod:'INS-004',birim:'lt',miktar:500,minStok:100,birimFiyat:450,tedarikci:'Marshall',notlar:'',resim:null,ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2025-05-17T08:30:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9105,ad:'Kalip Tahtasi',kategori:'insaat',depoId:9002,barkod:'INS-005',birim:'m2',miktar:320,minStok:50,birimFiyat:280,tedarikci:'Kereste-San',notlar:'',resim:null,ekleyen:'Mehmet Kaya',eklenmeTarihi:'2025-05-18T11:00:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9106,ad:'Dizustu Bilgisayar',kategori:'it',depoId:9003,barkod:'IT-001',birim:'adet',miktar:12,minStok:2,birimFiyat:45000,tedarikci:'Teknoloji Market',notlar:'Dell Latitude 5540',resim:null,ekleyen:'Ayse Demir',eklenmeTarihi:'2025-05-20T09:00:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9107,ad:'Yazici (Laser)',kategori:'it',depoId:9003,barkod:'IT-002',birim:'adet',miktar:3,minStok:1,birimFiyat:12000,tedarikci:'Teknoloji Market',notlar:'HP LaserJet Pro',resim:null,ekleyen:'Ayse Demir',eklenmeTarihi:'2025-05-20T09:15:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9108,ad:'Jenerator 100kVA',kategori:'arac',depoId:9002,barkod:'AG-001',birim:'adet',miktar:2,minStok:1,birimFiyat:350000,tedarikci:'Aksa Jenerator',notlar:'',resim:null,ekleyen:'Mehmet Kaya',eklenmeTarihi:'2025-05-22T14:00:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9109,ad:'Ofis Masasi',kategori:'mobilya',depoId:9003,barkod:'MOB-001',birim:'adet',miktar:8,minStok:0,birimFiyat:8500,tedarikci:'Ofis Mobilya',notlar:'160x80 L-tipi',resim:null,ekleyen:'Ayse Demir',eklenmeTarihi:'2025-05-25T10:00:00',sonGuncelleyen:null,guncellemeTarihi:null},
        {id:9110,ad:'Matkap (Hilti)',kategori:'arac',depoId:9001,barkod:'AG-002',birim:'adet',miktar:5,minStok:2,birimFiyat:15000,tedarikci:'Hilti Turkiye',notlar:'TE 30-A36',resim:null,ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2025-05-28T08:00:00',sonGuncelleyen:null,guncellemeTarihi:null}
    ];
    S.depoHareketler=[
        {id:9201,tarih:'2025-06-01',envanterItemId:9101,tip:'giris',miktar:50,kaynakDepoId:null,hedefDepoId:9001,projectId:null,irsaliyeNo:'IRS-2025/041',aciklama:'Aylik cimento siparisi',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9202,tarih:'2025-06-03',envanterItemId:9102,tip:'giris',miktar:20,kaynakDepoId:null,hedefDepoId:9001,projectId:null,irsaliyeNo:'IRS-2025/042',aciklama:'Demir teslimat',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9203,tarih:'2025-06-05',envanterItemId:9101,tip:'transfer',miktar:15,kaynakDepoId:9001,hedefDepoId:9002,projectId:null,irsaliyeNo:'',aciklama:'Santiyeye transfer',durum:'tamamlandi',talepEden:'Mehmet Kaya',onaylayan:'Ahmet Yildiz',aciliyet:'normal'},
        {id:9204,tarih:'2025-06-07',envanterItemId:9105,tip:'projeye',miktar:40,kaynakDepoId:9002,hedefDepoId:null,projectId:1001,irsaliyeNo:'',aciklama:'A Blok 5.kat kalip',durum:'tamamlandi',talepEden:'Osman Celik',onaylayan:'Mehmet Kaya',aciliyet:'acil'},
        {id:9205,tarih:'2025-06-08',envanterItemId:9103,tip:'cikis',miktar:30,kaynakDepoId:9002,hedefDepoId:null,projectId:null,irsaliyeNo:'',aciklama:'Beton dokum',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9206,tarih:'2025-06-10',envanterItemId:9106,tip:'giris',miktar:3,kaynakDepoId:null,hedefDepoId:9003,projectId:null,irsaliyeNo:'IRS-2025/048',aciklama:'Yeni laptop alimi',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9207,tarih:'2025-06-12',envanterItemId:9104,tip:'iade',miktar:50,kaynakDepoId:null,hedefDepoId:9001,projectId:null,irsaliyeNo:'',aciklama:'Fazla boya iadesi',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9208,tarih:'2025-06-15',envanterItemId:9108,tip:'fire',miktar:0,kaynakDepoId:9002,hedefDepoId:null,projectId:null,irsaliyeNo:'',aciklama:'Jenerator arizasi - onarima gonderildi',durum:'tamamlandi',talepEden:null,onaylayan:null,aciliyet:'normal'},
        {id:9209,tarih:'2025-06-18',envanterItemId:9102,tip:'transfer',miktar:10,kaynakDepoId:9001,hedefDepoId:9002,projectId:null,irsaliyeNo:'',aciklama:'Santiye demir ihtiyaci',durum:'onaylandi',talepEden:'Osman Celik',onaylayan:'Ahmet Yildiz',aciliyet:'acil'},
        {id:9210,tarih:'2025-06-20',envanterItemId:9104,tip:'transfer',miktar:100,kaynakDepoId:9001,hedefDepoId:9002,projectId:null,irsaliyeNo:'',aciklama:'Boya santiyeye gonderilecek',durum:'talep',talepEden:'Mehmet Kaya',onaylayan:null,aciliyet:'planli'}
    ];
    S.sayimlar=[
        {id:9301,tarih:'2025-06-15',depoId:9001,durum:'tamamlanan',
            kalemler:[
                {envanterItemId:9101,beklenen:85,sayilan:83,fark:-2},
                {envanterItemId:9102,beklenen:42,sayilan:42,fark:0},
                {envanterItemId:9104,beklenen:500,sayilan:495,fark:-5},
                {envanterItemId:9105,beklenen:320,sayilan:320,fark:0},
                {envanterItemId:9110,beklenen:5,sayilan:5,fark:0}
            ],sorumlu:'Ahmet Yildiz',notlar:'Cimentoda 2 ton fire tespit edildi, boya farkinin sebebi arastiriliyor.'}
    ];
    S.zimmetler=[
        {id:9401,tarih:'2025-06-01',envanterItemId:9106,miktar:1,zimmetliKisi:'Ali Vural',departman:'santiye',depoId:9003,durum:'aktif',iadeTarihi:null,notlar:'Saha muhendisi icin laptop',ekleyen:'Ayse Demir',onaylayan:'Can Ozturk'},
        {id:9402,tarih:'2025-06-05',envanterItemId:9110,miktar:1,zimmetliKisi:'Hasan Toprak',departman:'santiye',depoId:9001,durum:'aktif',iadeTarihi:null,notlar:'A Blok ince isler',ekleyen:'Ahmet Yildiz',onaylayan:'Osman Celik'},
        {id:9403,tarih:'2025-05-20',envanterItemId:9106,miktar:1,zimmetliKisi:'Zeynep Arslan',departman:'ofis',depoId:9003,durum:'iade',iadeTarihi:'2025-06-15',notlar:'Proje bitimi - laptop iade',ekleyen:'Ayse Demir',onaylayan:'Can Ozturk'},
        {id:9404,tarih:'2025-06-10',envanterItemId:9110,miktar:1,zimmetliKisi:'Kemal Dogan',departman:'santiye',depoId:9001,durum:'aktif',iadeTarihi:null,notlar:'Mekanik tesisat delme isleri',ekleyen:'Ahmet Yildiz',onaylayan:'Mehmet Kaya'}
    ];
    S.araclar=[
        {id:9501,plaka:'34 FN 001',marka:'Ford',model:'Transit Connect',yil:2022,renk:'Beyaz',tip:'van',yakitTipi:'dizel',sasino:'WF0XXXGCDX1234567',motorNo:'CYF6789012',km:48500,resim:null,sahiplik:'sirket',zimmetliKisi:'Mehmet Kaya',zimmetDepartman:'santiye',durum:'aktif',belgeler:{muayene:{sonTarih:'2024-12-15',bitisTarih:'2025-12-15'},sigorta:{sonTarih:'2025-01-10',bitisTarih:'2026-01-10',policeNo:'POL-2025/1234',sirket:'Axa Sigorta'},kasko:{sonTarih:'2025-01-10',bitisTarih:'2026-01-10',policeNo:'KAS-2025/567',sirket:'Axa Sigorta'},egzoz:{sonTarih:'2025-03-20',bitisTarih:'2026-03-20'}},bakimlar:[{id:1,tarih:'2025-05-10',km:45000,islem:'Periyodik bakim',maliyet:4500,servis:'Ford Yetkili',aciklama:'Yag+filtre degisimi'}],lastikler:[{id:1,tarih:'2025-04-01',km:43000,tip:'yaz',marka:'Michelin',notlar:'4 adet degisim'}],yakitKayitlari:[{id:1,tarih:'2025-06-01',km:47800,litre:45,tutar:1800},{id:2,tarih:'2025-06-10',km:48500,litre:42,tutar:1680}],notlar:'Santiye servis araci',ekleyen:'Ayse Demir',eklenmeTarihi:'2025-01-15'},
        {id:9502,plaka:'34 FN 002',marka:'Toyota',model:'Corolla',yil:2023,renk:'Gri',tip:'sedan',yakitTipi:'hibrit',sasino:'SB1KR9FE10E123456',motorNo:'2ZR7654321',km:22000,resim:null,sahiplik:'sirket',zimmetliKisi:'Can Ozturk',zimmetDepartman:'yonetim',durum:'aktif',belgeler:{muayene:{sonTarih:'2025-08-01',bitisTarih:'2026-08-01'},sigorta:{sonTarih:'2025-03-15',bitisTarih:'2026-03-15',policeNo:'POL-2025/2345',sirket:'Allianz'},kasko:{sonTarih:'2025-03-15',bitisTarih:'2026-03-15',policeNo:'KAS-2025/890',sirket:'Allianz'},egzoz:{sonTarih:'2025-06-01',bitisTarih:'2026-06-01'}},bakimlar:[],lastikler:[],yakitKayitlari:[{id:1,tarih:'2025-06-05',km:21500,litre:35,tutar:1400}],notlar:'Yonetim araci',ekleyen:'Can Ozturk',eklenmeTarihi:'2023-09-01'},
        {id:9503,plaka:'34 FN 003',marka:'Mercedes',model:'Sprinter',yil:2021,renk:'Beyaz',tip:'kamyon',yakitTipi:'dizel',sasino:'WDB9066331S123456',motorNo:'OM651DE22LA56789',km:95000,resim:null,sahiplik:'kiralik',zimmetliKisi:'Hasan Toprak',zimmetDepartman:'santiye',durum:'aktif',belgeler:{muayene:{sonTarih:'2024-11-01',bitisTarih:'2025-11-01'},sigorta:{sonTarih:'2025-02-01',bitisTarih:'2025-08-01',policeNo:'POL-2025/3456',sirket:'HDI Sigorta'},kasko:{sonTarih:null,bitisTarih:null,policeNo:'',sirket:''},egzoz:{sonTarih:'2025-01-15',bitisTarih:'2026-01-15'}},bakimlar:[{id:1,tarih:'2025-04-20',km:90000,islem:'Fren balatasi degisimi',maliyet:8500,servis:'Mercedes Yetkili Servis',aciklama:'On ve arka balata degisimi'},{id:2,tarih:'2025-06-01',km:93000,islem:'Periyodik bakim',maliyet:6200,servis:'Mercedes Yetkili Servis',aciklama:'60.000 km bakimi'}],lastikler:[{id:1,tarih:'2025-03-15',km:88000,tip:'4mevsim',marka:'Continental',notlar:'6 adet kamyon lastigi'}],yakitKayitlari:[{id:1,tarih:'2025-06-01',km:93500,litre:70,tutar:2800},{id:2,tarih:'2025-06-08',km:95000,litre:65,tutar:2600}],notlar:'Malzeme tasima araci - kiralik',ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2021-06-15'},
        {id:9504,plaka:'06 FN 004',marka:'Fiat',model:'Doblo',yil:2020,renk:'Lacivert',tip:'van',yakitTipi:'dizel',sasino:'ZFA26300006543210',motorNo:'198A4000M9876543',km:72000,resim:null,sahiplik:'sirket',zimmetliKisi:'Ali Vural',zimmetDepartman:'santiye',durum:'aktif',belgeler:{muayene:{sonTarih:'2024-06-01',bitisTarih:'2025-06-01'},sigorta:{sonTarih:'2024-12-01',bitisTarih:'2025-06-15',policeNo:'POL-2024/9876',sirket:'Mapfre Sigorta'},kasko:{sonTarih:null,bitisTarih:null,policeNo:'',sirket:''},egzoz:{sonTarih:'2024-09-01',bitisTarih:'2025-09-01'}},bakimlar:[],lastikler:[],yakitKayitlari:[],notlar:'Santiye araci',ekleyen:'Ahmet Yildiz',eklenmeTarihi:'2020-03-10'}
    ];
    S.bildirimAyarlar.filoSorumlusu={userId:1,tumBildirimleriAl:true};
    save();
}
// Supply demo data
if((S.tedarikcilerHavuzu||[]).length===0){
    const now=new Date().toISOString();
    S.tedarikcilerHavuzu=[
        {id:20001,firma:'Demir Trade A.S.',vergiNo:'1234567890',adres:'Dilovasi OSB, Kocaeli',yetkili:'Kemal Oz',telefon:'0536 444 5566',email:'kemal@demirtrade.com',kategoriler:['demir','celik'],puan:4.2,performans:{zamanindaTeslimat:92,kalitePuani:4.5,fiyatRekabet:3.8},karaListe:false,karaListeNedeni:'',toplamIsHacmi:5600000,ihaleSayisi:8,notlar:'Guvenilir demir tedarik√ßisi',createdAt:now},
        {id:20002,firma:'Beton-San Ltd.',vergiNo:'2345678901',adres:'Tuzla, Istanbul',yetkili:'Murat Tas',telefon:'0537 555 6677',email:'murat@betonsan.com',kategoriler:['beton','cimento'],puan:4.8,performans:{zamanindaTeslimat:98,kalitePuani:4.8,fiyatRekabet:4.2},karaListe:false,karaListeNedeni:'',toplamIsHacmi:3800000,ihaleSayisi:5,notlar:'Premium beton kalitesi',createdAt:now},
        {id:20003,firma:'Yildiz Cimento',vergiNo:'3456789012',adres:'Gebze, Kocaeli',yetkili:'Fatma Han',telefon:'0539 777 8899',email:'fatma@yildizcimento.com',kategoriler:['cimento','beton'],puan:3.5,performans:{zamanindaTeslimat:78,kalitePuani:3.5,fiyatRekabet:4.5},karaListe:false,karaListeNedeni:'',toplamIsHacmi:1200000,ihaleSayisi:3,notlar:'Uygun fiyat',createdAt:now},
        {id:20004,firma:'Aktas Elektrik',vergiNo:'4567890123',adres:'Dudullu OSB, Istanbul',yetkili:'Serkan Aktas',telefon:'0542 888 9900',email:'serkan@aktaselektrik.com',kategoriler:['elektrik','tesisat'],puan:4.0,performans:{zamanindaTeslimat:85,kalitePuani:4.0,fiyatRekabet:3.5},karaListe:false,karaListeNedeni:'',toplamIsHacmi:2400000,ihaleSayisi:4,notlar:'Elektrik malzeme uzmani',createdAt:now},
        {id:20005,firma:'Guven Insaat Mlz.',vergiNo:'5678901234',adres:'Ikitelli OSB, Istanbul',yetkili:'Hakan Guven',telefon:'0544 111 2233',email:'hakan@guveninsaat.com',kategoriler:['insaat','izolasyon','kaplama'],puan:3.8,performans:{zamanindaTeslimat:80,kalitePuani:3.8,fiyatRekabet:4.0},karaListe:false,karaListeNedeni:'',toplamIsHacmi:900000,ihaleSayisi:2,notlar:'Genel insaat malzemeleri',createdAt:now}
    ];
    S.satinalmaTalepleri=[
        {id:21001,talepNo:'ST-2025-001',projectId:1001,departman:'santiye',talepEden:'Mehmet Kaya',aciliyet:'yuksek',
            kalemler:[{id:21101,malzeme:'Insaat Demiri Q12',miktar:50,birim:'ton',tahmiFiyat:18500,aciklama:''},{id:21102,malzeme:'Insaat Demiri Q16',miktar:30,birim:'ton',tahmiFiyat:19000,aciklama:''}],
            toplamTahmini:1495000,durum:'onaylandi',onaylayan:'Can Ozturk',onayTarihi:now,ihaleId:null,notlar:'5-6. kat demir ihtiyaci',createdAt:now},
        {id:21002,talepNo:'ST-2025-002',projectId:1002,departman:'santiye',talepEden:'Ayse Demir',aciliyet:'normal',
            kalemler:[{id:21201,malzeme:'Celik Profil HEA200',miktar:25,birim:'ton',tahmiFiyat:28000,aciklama:''},{id:21202,malzeme:'Celik Profil HEA300',miktar:15,birim:'ton',tahmiFiyat:32000,aciklama:''}],
            toplamTahmini:1180000,durum:'onayBekliyor',onaylayan:'',onayTarihi:'',ihaleId:null,notlar:'2. etap celik ihtiyaci',createdAt:now},
        {id:21003,talepNo:'ST-2025-003',projectId:1001,departman:'ofis',talepEden:'Ali Vural',aciliyet:'dusuk',
            kalemler:[{id:21301,malzeme:'A4 Fotokopi Kagidi',miktar:50,birim:'pkt',tahmiFiyat:180,aciklama:''},{id:21302,malzeme:'Printer Toner',miktar:5,birim:'adet',tahmiFiyat:1200,aciklama:''}],
            toplamTahmini:15000,durum:'taslak',onaylayan:'',onayTarihi:'',ihaleId:null,notlar:'Ofis malzemeleri',createdAt:now}
    ];
    // Ihaleler (yeni yapida)
    const bpiDate=new Date();bpiDate.setDate(bpiDate.getDate()+21);
    S.tenders=[
        {id:22001,ihaleNo:'IH-2025-001',baslik:'Insaat Demiri Alimi',projectId:1001,ihaleTipi:'acik',
            kalemler:[{id:22101,malzeme:'Insaat Demiri Q12',miktar:50,birim:'ton'},{id:22102,malzeme:'Insaat Demiri Q16',miktar:30,birim:'ton'}],
            teklifler:[
                {id:22201,tedarikciId:20001,tedarikciAdi:'Demir Trade A.S.',birimFiyatlar:[17800,18500],toplamFiyat:17800*50+18500*30,teslimat:14,odemeKosulu:'30 gun vadeli',puan:0,notlar:'',tarih:now},
                {id:22202,tedarikciId:20005,tedarikciAdi:'Guven Insaat Mlz.',birimFiyatlar:[18200,19200],toplamFiyat:18200*50+19200*30,teslimat:21,odemeKosulu:'Pesin',puan:0,notlar:'',tarih:now}
            ],
            kazananTeklifId:22201,status:'approved',item:'Insaat Demiri Alimi',amount:17800*50+18500*30,supplier:'Demir Trade A.S.',delivery:14,rating:4,talepIds:[21001],komisyonNotu:'',createdAt:now},
        {id:22002,ihaleNo:'IH-2025-002',baslik:'Hazir Beton Temini',projectId:1001,ihaleTipi:'kapaliZarf',
            kalemler:[{id:22301,malzeme:'Hazir Beton C30',miktar:500,birim:'m3'},{id:22302,malzeme:'Hazir Beton C40',miktar:200,birim:'m3'}],
            teklifler:[
                {id:22401,tedarikciId:20002,tedarikciAdi:'Beton-San Ltd.',birimFiyatlar:[2650,3100],toplamFiyat:2650*500+3100*200,teslimat:7,odemeKosulu:'15 gun vadeli',puan:0,notlar:'',tarih:now},
                {id:22402,tedarikciId:20003,tedarikciAdi:'Yildiz Cimento',birimFiyatlar:[2500,2900],toplamFiyat:2500*500+2900*200,teslimat:10,odemeKosulu:'30 gun vadeli',puan:0,notlar:'Fiyat avantaji',tarih:now}
            ],
            kazananTeklifId:null,status:'reviewing',item:'Hazir Beton Temini',amount:2500*500+2900*200,supplier:'',delivery:7,rating:3,talepIds:[],komisyonNotu:'En dusuk teklif bazli tahmini tutar',createdAt:now},
        {id:22003,ihaleNo:'IH-2025-003',baslik:'Elektrik Kablo ve Malzeme',projectId:1001,ihaleTipi:'dogrudan',
            kalemler:[{id:22501,malzeme:'NYM 3x2.5 Kablo',miktar:5000,birim:'mt'},{id:22502,malzeme:'NYM 5x4 Kablo',miktar:2000,birim:'mt'},{id:22503,malzeme:'Sigorta Panosu',miktar:8,birim:'adet'}],
            teklifler:[],kazananTeklifId:null,status:'pending',item:'Elektrik Kablo ve Malzeme',amount:485000,supplier:'',delivery:14,rating:3,talepIds:[],komisyonNotu:'Tahmini butce',createdAt:now}
    ];
    // Talebi ihaleye baƒüla
    S.satinalmaTalepleri[0].ihaleId=22001;S.satinalmaTalepleri[0].durum='ihaleyeCevrildi';
    // Sipari≈ü (kazanan ihaleden)
    S.orders=[
        {id:23001,orderNo:'PO-2025-001',ihaleId:22001,projectId:1001,tedarikciId:20001,tedarikciAdi:'Demir Trade A.S.',
            kalemler:[{malzeme:'Insaat Demiri Q12',miktar:50,birim:'ton',birimFiyat:17800,toplam:890000},{malzeme:'Insaat Demiri Q16',miktar:30,birim:'ton',birimFiyat:18500,toplam:555000}],
            toplamTutar:1445000,odemeKosulu:'30 gun vadeli',durum:'kismiTeslimat',
            teslimatlar:[
                {id:23101,tarih:now,miktar:30,birim:'ton',malzeme:'Insaat Demiri Q12',irsaliyeNo:'IRS-2025/101',notlar:'Ilk parti teslimat'}
            ],
            bpiGun:14,bpiTarih:bpiDate.toISOString(),item:'Insaat Demiri Alimi',supplier:'Demir Trade A.S.',amount:1445000,status:'ordered',createdAt:now}
    ];
    // Satis demo data
    S.sales=[
        {id:30001,customer:'Yilmaz Holding A.S.',phone:'0212 555 1122',product:'Atasehir Rezidans A Blok - Daire (3+1)',price:8500000,installments:12,paid:3541666,stage:'negotiation',status:'active',createdAt:now},
        {id:30002,customer:'Mehmet Aktas',phone:'0532 666 7788',product:'Atasehir Rezidans A Blok - Daire (2+1)',price:5200000,installments:24,paid:1083333,stage:'proposal',status:'active',createdAt:now},
        {id:30003,customer:'Deniz Insaat Ltd.',phone:'0216 333 4455',product:'Kadikoy Ticaret Merkezi - B Blok 3.Kat Ofis',price:12000000,installments:6,paid:6000000,stage:'contract',status:'active',createdAt:now},
        {id:30004,customer:'Ayhan Celik',phone:'0533 999 8877',product:'Atasehir Rezidans A Blok - Daire (1+1)',price:3800000,installments:1,paid:0,stage:'meeting',status:'active',createdAt:now},
        {id:30005,customer:'Kara Gayrimenkul',phone:'0212 777 6655',product:'Kadikoy Ticaret Merkezi - Zemin Kat Magaza',price:18500000,installments:8,paid:0,stage:'lead',status:'active',createdAt:now},
        {id:30006,customer:'Ozturk Tekstil A.S.',phone:'0216 444 3322',product:'Kadikoy Ticaret Merkezi - A Blok 2.Kat Ofis',price:9200000,installments:10,paid:920000,stage:'proposal',status:'active',createdAt:now}
    ];
    save();
}

// Init render (demo data prep only ‚Äî UI render after login)
checkReminders();
renderAll();
tumKontrolleriCalistir();
// girisKritikModal artik sadece completeLogin icinde calisir
}

// ===================== PWA SERVICE WORKER & INSTALL =====================
let deferredInstallPrompt=null;
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js').then(reg=>{
      console.log('SW kayitli:',reg.scope);
    }).catch(err=>console.warn('SW kayit hatasi:',err));
  });
}
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredInstallPrompt=e;
  showPwaInstallBanner();
});
function showPwaInstallBanner(){
  let banner=document.getElementById('pwa-install-banner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='pwa-install-banner';
    banner.className='glass-strong rounded-2xl p-4 shadow-2xl';
    banner.innerHTML=`<div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0"><span class="text-lg font-bold">F</span></div>
      <div class="flex-1"><p class="text-sm font-semibold">FaOnSisT Uygulamasi</p><p class="text-[10px] text-gray-400">Cihaziniza yukleyerek hizli erisim saglayin</p></div>
      <button onclick="installPwa()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg text-xs font-medium">Yukle</button>
      <button onclick="dismissPwaBanner()" class="p-1 text-gray-400 hover:text-white">&times;</button>
    </div>`;
    document.body.appendChild(banner);
  }
  setTimeout(()=>banner.classList.add('show'),100);
}
function installPwa(){
  if(!deferredInstallPrompt)return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(r=>{
    if(r.outcome==='accepted')showNotif('Uygulama yuklendi!');
    deferredInstallPrompt=null;
    dismissPwaBanner();
  });
}
function dismissPwaBanner(){
  const b=document.getElementById('pwa-install-banner');
  if(b)b.classList.remove('show');
}

// ===================== PUSH NOTIFICATIONS =====================
async function subscribePushNotifications(){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token||!('serviceWorker' in navigator)||!('PushManager' in window))return;
  try{
    const permission=await Notification.requestPermission();
    if(permission!=='granted')return;
    const reg=await navigator.serviceWorker.ready;
    // VAPID public key al
    const keyRes=await fetch('/api/notifications/subscribe',{headers:{'Authorization':'Bearer '+token}});
    if(!keyRes.ok)return;
    const keyData=await keyRes.json();
    if(!keyData.success||!keyData.data?.vapidPublicKey)return;
    const vapidKey=keyData.data.vapidPublicKey;
    // URL-safe base64 to Uint8Array
    const padding='='.repeat((4-vapidKey.length%4)%4);
    const base64=((vapidKey+'').replace(/-/g,'+').replace(/_/g,'/'))+padding;
    const raw=atob(base64);
    const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)arr[i]=raw.charCodeAt(i);
    const sub=await reg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:arr});
    const subJson=sub.toJSON();
    await fetch('/api/notifications/subscribe',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({endpoint:subJson.endpoint,p256dh:subJson.keys.p256dh,auth:subJson.keys.auth})
    });
  }catch(e){console.warn('Push bildirim kaydi basarisiz:',e);}
}

// ===================== AI SOHBET GECMISI =====================
function toggleAiHistory(){
  const panel=document.getElementById('ai-history-panel');
  panel.classList.toggle('active');
  if(panel.classList.contains('active'))loadAiSessions();
}
async function loadAiSessions(){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/ai/sessions?limit=30',{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok)return;
    const data=await r.json();
    if(!data.success)return;
    aiSessions=data.data?.sessions||[];
    renderAiSessions();
  }catch(e){}
}
function renderAiSessions(){
  const list=document.getElementById('ai-session-list');
  if(!list)return;
  if(aiSessions.length===0){list.innerHTML='<p class="text-[10px] text-gray-500 text-center py-4">Henuz sohbet yok</p>';return;}
  list.innerHTML=aiSessions.map(s=>{
    const date=new Date(s.updatedAt).toLocaleDateString('tr-TR',{day:'2-digit',month:'short'});
    const preview=s.messages&&s.messages[0]?s.messages[0].icerik.substring(0,40)+'...':'';
    const active=currentAiSessionId===s.id?'active':'';
    return `<div class="ai-session-item ${active}" onclick="loadAiSession('${s.id}')">
      <p class="text-xs font-medium truncate">${s.baslik||'Sohbet'}</p>
      <p class="text-[9px] text-gray-500 truncate mt-0.5">${preview}</p>
      <div class="flex items-center justify-between mt-1">
        <span class="text-[8px] text-gray-600">${date} &middot; ${s.mesajSayisi||0} mesaj</span>
        <button onclick="event.stopPropagation();deleteAiSession('${s.id}')" class="text-[9px] text-gray-600 hover:text-red-400 px-1">&times;</button>
      </div>
    </div>`;
  }).join('');
}
async function loadAiSession(sessionId){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/ai/sessions/'+sessionId,{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok)return;
    const data=await r.json();
    if(!data.success||!data.data)return;
    currentAiSessionId=sessionId;
    const container=document.getElementById('ai-chat-messages');
    container.innerHTML='';
    const msgs=data.data.messages||[];
    msgs.forEach(m=>{
      const isUser=m.role==='user';
      const html=m.icerik.replace(/\n/g,'<br>');
      addAiMsg(html,isUser);
    });
    renderAiSessions();
  }catch(e){}
}
function startNewAiSession(){
  currentAiSessionId=null;
  const container=document.getElementById('ai-chat-messages');
  container.innerHTML='';
  addAiMsg('Yeni sohbet baslatildi. Size nasil yardimci olabilirim?',false);
  renderAiSessions();
}
async function deleteAiSession(sessionId){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    await fetch('/api/ai/sessions/'+sessionId,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
    if(currentAiSessionId===sessionId){currentAiSessionId=null;startNewAiSession();}
    loadAiSessions();
    showNotif('Sohbet silindi');
  }catch(e){}
}

// ===================== DASHBOARD CHART.JS GRAFIKLERI =====================
let dashChartInstance=null;
let currentDashChartType='progress';

function switchDashChart(type){
  currentDashChartType=type;
  document.querySelectorAll('#dash-chart-tabs .chart-tab').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  loadDashboardCharts();
}
async function loadDashboardCharts(){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/dashboard/charts?type='+currentDashChartType,{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok)return;
    const data=await r.json();
    if(!data.success||!data.data)return;
    renderDashChartJS(data.data);
  }catch(e){console.warn('Grafik yukleme hatasi:',e);}
}
function renderDashChartJS(chartData){
  const canvas=document.getElementById('dash-chart-canvas');
  if(!canvas||typeof Chart==='undefined')return;
  if(dashChartInstance){dashChartInstance.destroy();}
  // Chart.js tema
  Chart.defaults.color='#94a3b8';
  Chart.defaults.borderColor='rgba(148,163,184,0.1)';
  const ctx=canvas.getContext('2d');
  const type=currentDashChartType;
  let config={};
  if(type==='progress'){
    config={type:'doughnut',data:{labels:chartData.labels||[],datasets:[{data:chartData.values||[],backgroundColor:['#3b82f6','#22c55e','#f59e0b','#ef4444','#8b5cf6'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{padding:16,usePointStyle:true,pointStyle:'circle',font:{size:11}}}}}};
  }else if(type==='cashflow'){
    config={type:'bar',data:{labels:chartData.labels||[],datasets:[{label:'Gelir',data:chartData.gelir||[],backgroundColor:'rgba(34,197,94,0.7)',borderRadius:4},{label:'Gider',data:chartData.gider||[],backgroundColor:'rgba(239,68,68,0.7)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{usePointStyle:true,font:{size:11}}}},scales:{y:{ticks:{callback:v=>'‚Ç∫'+fmt(v)},grid:{color:'rgba(148,163,184,0.08)'}},x:{grid:{display:false}}}}};
  }else if(type==='cost'){
    config={type:'bar',data:{labels:chartData.labels||[],datasets:[{label:'Butce',data:chartData.butce||[],backgroundColor:'rgba(59,130,246,0.7)',borderRadius:4},{label:'Harcanan',data:chartData.harcanan||[],backgroundColor:'rgba(245,158,11,0.7)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{labels:{usePointStyle:true,font:{size:11}}}},scales:{x:{ticks:{callback:v=>'‚Ç∫'+fmt(v)},grid:{color:'rgba(148,163,184,0.08)'}},y:{grid:{display:false}}}}};
  }else if(type==='trend'){
    config={type:'line',data:{labels:chartData.labels||[],datasets:[{label:'Projeler',data:chartData.projeler||[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.4,pointRadius:4},{label:'Ihaleler',data:chartData.ihaleler||[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',fill:true,tension:0.4,pointRadius:4},{label:'Satislar',data:chartData.satislar||[],borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,0.1)',fill:true,tension:0.4,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{usePointStyle:true,font:{size:11}}}},scales:{y:{beginAtZero:true,grid:{color:'rgba(148,163,184,0.08)'}},x:{grid:{display:false}}}}};
  }
  dashChartInstance=new Chart(ctx,config);
}
// 60sn auto-refresh
setInterval(()=>{if(isLoggedIn&&document.querySelector('[data-module="dashboard"]')?.classList.contains('active'))loadDashboardCharts();},60000);

// ===================== AI RAPOR OLUSTURMA =====================
async function aiCreateReport(text){
  const lower=text.toLowerCase().replace('@rapor','').trim();
  let tur=null;
  if(lower.includes('maliyet'))tur='maliyet_analiz';
  else if(lower.includes('nakit'))tur='nakit_akis';
  else if(lower.includes('performans'))tur='performans';
  else if(lower.includes('risk'))tur='risk';
  else if(lower.includes('proje')||lower.includes('ozet'))tur='proje_ozet';

  // Tur belirtilmemisse secim menusu goster
  if(!tur){
    addAiMsg(`<b class="text-amber-400">&#128202; AI Rapor Olustur</b><br><br>
<span class="text-gray-400 text-[10px]">Olusturmak istediginiz rapor turunu secin:</span><br><br>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">
  <button onclick="aiStartReport('proje_ozet')" class="px-3 py-1.5 bg-blue-500/15 text-blue-400 rounded-lg text-[10px] hover:bg-blue-500/25 border border-blue-500/20 transition-colors">&#128203; Proje Ozet</button>
  <button onclick="aiStartReport('maliyet_analiz')" class="px-3 py-1.5 bg-green-500/15 text-green-400 rounded-lg text-[10px] hover:bg-green-500/25 border border-green-500/20 transition-colors">&#128176; Maliyet Analizi</button>
  <button onclick="aiStartReport('nakit_akis')" class="px-3 py-1.5 bg-purple-500/15 text-purple-400 rounded-lg text-[10px] hover:bg-purple-500/25 border border-purple-500/20 transition-colors">&#128184; Nakit Akisi</button>
  <button onclick="aiStartReport('performans')" class="px-3 py-1.5 bg-teal-500/15 text-teal-400 rounded-lg text-[10px] hover:bg-teal-500/25 border border-teal-500/20 transition-colors">&#128200; Performans</button>
  <button onclick="aiStartReport('risk')" class="px-3 py-1.5 bg-red-500/15 text-red-400 rounded-lg text-[10px] hover:bg-red-500/25 border border-red-500/20 transition-colors">&#9888;&#65039; Risk Analizi</button>
</div>
<br><span class="text-gray-500 text-[9px]">Veya yazarak: @rapor maliyet, @rapor nakit, @rapor performans, @rapor risk</span>`,false);
    return;
  }

  aiStartReport(tur);
}

async function aiStartReport(tur){
  const turNames={proje_ozet:'Proje Ozet',maliyet_analiz:'Maliyet Analizi',nakit_akis:'Nakit Akisi',performans:'Performans',risk:'Risk Degerlendirmesi'};
  addAiMsg(`<b class="text-amber-400">&#128202; AI Rapor Olusturuluyor</b><br><br>Rapor turu: <b>${turNames[tur]||tur}</b><br>Lutfen bekleyin, AI verilerinizi analiz ediyor...`,false);
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token){addAiMsg('Hata: Oturum acik degil.',false);return;}
  try{
    const r=await fetch('/api/ai/reports',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({tur})
    });
    const data=await r.json();
    if(data.success){
      addAiMsg(`<span class="text-green-400">&#10004;</span> Rapor olusturuluyor (ID: ${data.data.reportId}). Hazir oldugunda bildirim alacaksiniz.<br><br><button onclick="loadAiReportDetail('${data.data.reportId}')" class="px-3 py-1.5 bg-amber-600/20 text-amber-400 rounded-lg text-[10px] border border-amber-500/20 hover:bg-amber-600/30 transition-colors">&#128196; Raporu Goruntule</button>`,false);
    }else{
      addAiMsg('Rapor olusturulamadi: '+(data.error?.message||'Bilinmeyen hata'),false);
    }
  }catch(e){
    addAiMsg('Rapor olusturma hatasi: '+e.message,false);
  }
}
async function loadAiReportDetail(reportId){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/ai/reports/'+reportId,{headers:{'Authorization':'Bearer '+token}});
    const data=await r.json();
    if(!data.success||!data.data){addAiMsg('Rapor henuz hazir degil, lutfen bekleyin.',false);return;}
    const report=data.data;
    if(report.durum==='olusturuluyor'){addAiMsg('Rapor henuz hazirlaniyor... Lutfen birka saniye sonra tekrar deneyin.',false);return;}
    if(report.durum==='hata'){addAiMsg('<span class="text-red-400">Rapor olusturulurken hata olustu:</span><br>'+report.icerik,false);return;}
    const html=report.icerik.replace(/\n/g,'<br>');
    addAiMsg(`<b class="text-amber-400">&#128202; ${report.baslik}</b><br><span class="text-[9px] text-gray-500">${new Date(report.createdAt).toLocaleString('tr-TR')}</span><br><br>${html}`,false);
  }catch(e){addAiMsg('Rapor yukleme hatasi.',false);}
}

// ===================== RAPORLAMA MODULU UI =====================
async function downloadReport(type,format){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token){showNotif('Oturum acik degil');return;}
  showNotif('Rapor hazirlaniyor...');
  try{
    let url='';
    if(type==='project'){
      const pid=S.projects?.[0]?.id;
      if(!pid){showNotif('Proje bulunamadi');return;}
      url='/api/reports/project?projectId='+pid+'&format='+(format||'pdf');
    }else if(type==='cost'){
      url='/api/reports/cost-analysis?format='+(format||'pdf');
    }else if(type==='cashflow'){
      url='/api/reports/cashflow?format='+(format||'pdf');
    }else if(type==='export'){
      const r=await fetch('/api/reports/export',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
        body:JSON.stringify({type:'projects'})
      });
      if(!r.ok){showNotif('Rapor hatasi');return;}
      const blob=await r.blob();
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='faonsist-export.xlsx';
      a.click();
      showNotif('Dosya indirildi');
      return;
    }
    const r=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok){showNotif('Rapor hatasi');return;}
    const blob=await r.blob();
    const ext=format==='excel'?'xlsx':'pdf';
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='faonsist-'+type+'-rapor.'+ext;
    a.click();
    showNotif('Rapor indirildi');
  }catch(e){showNotif('Rapor indirme hatasi');}
}

// ===================== DOSYA ONIZLEME GELISTIRMESI =====================
async function openFilePreviewEnhanced(fileId,fileName,mimeType){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  // Resim ve PDF - mevcut sistem
  if(mimeType&&(mimeType.startsWith('image/')||mimeType==='application/pdf')){
    openFilePreview(fileId,fileName,mimeType);
    return;
  }
  // Excel, CSV, DOCX - sunucu tarafli onizleme
  try{
    const r=await fetch('/api/uploads/'+fileId+'/preview',{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok){openFilePreview(fileId,fileName,mimeType);return;}
    const data=await r.json();
    if(!data.success){openFilePreview(fileId,fileName,mimeType);return;}
    const preview=data.data;
    showPreviewModal(fileName,preview);
  }catch(e){openFilePreview(fileId,fileName,mimeType);}
}
function showPreviewModal(fileName,preview){
  let modal=document.getElementById('modal-file-preview-enhanced');
  if(!modal){
    modal=document.createElement('div');
    modal.id='modal-file-preview-enhanced';
    modal.className='modal';
    modal.innerHTML=`<div class="glass-strong rounded-2xl p-6 w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold" id="preview-file-name"></h3>
        <button onclick="closeModal('modal-file-preview-enhanced')" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <div class="flex-1 overflow-auto" id="preview-content"></div>
    </div>`;
    document.body.appendChild(modal);
  }
  const pfn=document.getElementById('preview-file-name');
  if(pfn)pfn.textContent=fileName;
  const content=document.getElementById('preview-content');
  if(!content)return;
  if(preview.type==='excel'||preview.type==='csv'){
    let html='';
    const sheets=preview.sheets||[{name:'Veri',headers:preview.headers,rows:preview.rows}];
    if(sheets.length>1){
      html+='<div class="flex gap-1 mb-3">';
      sheets.forEach((sh,i)=>{html+=`<button class="tab-btn ${i===0?'active':''}" onclick="switchPreviewSheet(${i})">${sh.name}</button>`;});
      html+='</div>';
    }
    sheets.forEach((sh,i)=>{
      html+=`<div class="preview-sheet ${i>0?'hidden':''}" data-sheet="${i}">`;
      html+='<div class="overflow-auto"><table class="w-full text-xs border-collapse">';
      if(sh.headers&&sh.headers.length>0){
        html+='<thead><tr class="bg-gray-800/50"><th class="px-2 py-1.5 text-left text-[10px] text-gray-400 border border-gray-700/50">#</th>';
        sh.headers.forEach(h=>{html+='<th class="px-2 py-1.5 text-left text-[10px] text-gray-400 border border-gray-700/50 font-semibold">'+h+'</th>';});
        html+='</tr></thead>';
      }
      html+='<tbody>';
      (sh.rows||[]).forEach((row,ri)=>{
        html+='<tr class="hover:bg-gray-800/30"><td class="px-2 py-1 text-[9px] text-gray-600 border border-gray-700/30">'+(ri+1)+'</td>';
        row.forEach(cell=>{html+='<td class="px-2 py-1 border border-gray-700/30">'+cell+'</td>';});
        html+='</tr>';
      });
      html+='</tbody></table></div>';
      html+=`<p class="text-[9px] text-gray-500 mt-2">${(sh.rows||[]).length} satir gosteriliyor</p></div>`;
    });
    content.innerHTML=html;
  }else if(preview.type==='text'){
    content.innerHTML=`<div class="bg-gray-900/50 rounded-lg p-4 text-xs leading-relaxed whitespace-pre-wrap font-mono">${preview.content||''}</div>
      <p class="text-[9px] text-gray-500 mt-2">Metin onizlemesi (tam format icin dosyayi indirin)</p>`;
  }else{
    content.innerHTML=`<div class="text-center py-12"><p class="text-gray-500">Bu dosya turu icin onizleme desteklenmiyor</p><p class="text-[10px] text-gray-600 mt-1">${fileName}</p></div>`;
  }
  modal.classList.add('active');
}
function switchPreviewSheet(idx){
  document.querySelectorAll('.preview-sheet').forEach((el,i)=>{
    el.classList.toggle('hidden',i!==idx);
  });
  const btns=document.querySelectorAll('#preview-content .tab-btn');
  btns.forEach((b,i)=>b.classList.toggle('active',i===idx));
}

// ===================== AI RAPOR LISTELEME (Raporlar Modulu) =====================
async function loadAiReports(){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/ai/reports?limit=10',{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok)return;
    const data=await r.json();
    if(!data.success)return;
    const list=document.getElementById('ai-reports-list');
    if(!list)return;
    const reports=data.data?.reports||[];
    if(reports.length===0){list.innerHTML='<p class="text-xs text-gray-500 text-center py-2">Henuz AI raporu yok</p>';return;}
    list.innerHTML=reports.map(r=>{
      const date=new Date(r.createdAt).toLocaleDateString('tr-TR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      const statusCls='report-status-'+r.durum;
      const statusName={olusturuluyor:'Hazirlaniyor',tamamlandi:'Hazir',hata:'Hata'}[r.durum]||r.durum;
      return `<div class="ai-report-item flex items-center gap-3" onclick="viewAiReport('${r.id}')">
        <div class="flex-1 min-w-0">
          <p class="text-xs font-medium truncate">${r.baslik}</p>
          <p class="text-[9px] text-gray-500">${date}</p>
        </div>
        <span class="px-2 py-0.5 rounded-full text-[9px] font-semibold ${statusCls}">${statusName}</span>
      </div>`;
    }).join('');
  }catch(e){}
}
async function createAiReport(tur){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token){showNotif('Oturum acik degil');return;}
  showNotif('AI raporu olusturuluyor...');
  try{
    const r=await fetch('/api/ai/reports',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({tur})
    });
    const data=await r.json();
    if(data.success){showNotif('Rapor hazirlaniyor. Hazir oldugunda bildirim alacaksiniz.');setTimeout(loadAiReports,2000);}
    else showNotif('Rapor olusturulamadi');
  }catch(e){showNotif('Hata olustu');}
}
async function viewAiReport(reportId){
  const token=authToken||localStorage.getItem('faonsist-token');
  if(!token)return;
  try{
    const r=await fetch('/api/ai/reports/'+reportId,{headers:{'Authorization':'Bearer '+token}});
    const data=await r.json();
    if(!data.success||!data.data)return;
    const report=data.data;
    let modal=document.getElementById('modal-ai-report-view');
    if(!modal){
      modal=document.createElement('div');
      modal.id='modal-ai-report-view';
      modal.className='modal';
      modal.innerHTML=`<div class="glass-strong rounded-2xl p-6 w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <div><h3 class="text-lg font-bold" id="ai-report-title"></h3><p class="text-[10px] text-gray-500" id="ai-report-date"></p></div>
          <button onclick="closeModal('modal-ai-report-view')" class="text-gray-400 hover:text-white text-xl">&times;</button>
        </div>
        <div class="flex-1 overflow-auto prose prose-invert prose-sm max-w-none" id="ai-report-content"></div>
      </div>`;
      document.body.appendChild(modal);
    }
    const art=document.getElementById('ai-report-title');
    if(art)art.textContent=report.baslik;
    const ard=document.getElementById('ai-report-date');
    if(ard)ard.textContent=new Date(report.createdAt).toLocaleString('tr-TR');
    const content=report.icerik||'';
    const arc=document.getElementById('ai-report-content');
    if(arc)arc.innerHTML=content.replace(/\n/g,'<br>');
    modal.classList.add('active');
  }catch(e){}
}

// ===================== SOCKET.IO BILDIRIM DINLEME =====================
function setupSocketNotifications(){
  if(!socket)return;
  socket.on('notification:new',(data)=>{
    showNotif(data.baslik||data.mesaj||'Yeni bildirim');
    bildirimSayisiGuncelle();
  });
  socket.on('ai-report:ready',(data)=>{
    showNotif('AI Raporu Hazir: '+(data.baslik||''));
    if(document.getElementById('connect-ai-view')&&!document.getElementById('connect-ai-view').classList.contains('hidden')){
      addAiMsg(`<span class="text-green-400">&#10004;</span> <b>"${data.baslik}"</b> raporu hazir!<br><button onclick="loadAiReportDetail('${data.id}')" class="px-3 py-1 bg-amber-600/20 text-amber-400 rounded-lg text-[10px] border border-amber-500/20 mt-1">Goruntule</button>`,false);
    }
  });
}
// Socket init sirasinda cagir
const _origInitSocket=typeof initSocket==='function'?initSocket:null;
if(_origInitSocket){
  const _origFn=initSocket;
  // initSocket zaten tanimlanmissa, sonrasina ekle
}
// Socket baglanti sonrasi bildirim dinlemeyi aktif et
setTimeout(()=>{if(socket&&socket.connected)setupSocketNotifications();},3000);
// Periyodik kontrol
setInterval(()=>{if(socket&&socket.connected&&!socket._notifSetup){setupSocketNotifications();socket._notifSetup=true;}},5000);

// ===================== FAZ 3: EXCEL IMPORT GENISLETME =====================
const IMPORT_FIELD_DEFS={
    'tedarikci-havuzu':{
        fields:['firma','yetkili','telefon','email','adres','vergiNo','kategori','puan','notlar'],
        guesses:{firma:['Firma','firma','Firma Adi','sirket','Sirket'],yetkili:['Yetkili','yetkili','Kisi','Ad Soyad'],telefon:['Telefon','telefon','Tel','Phone'],email:['Email','email','E-posta','Eposta'],adres:['Adres','adres','Address'],vergiNo:['Vergi No','vergiNo','VKN','Vergi'],kategori:['Kategori','kategori','Category'],puan:['Puan','puan','Score'],notlar:['Not','notlar','Aciklama']}
    },
    'satislar':{
        fields:['customer','phone','product','price','installments','paid','stage','status'],
        guesses:{customer:['Musteri','customer','Firma','Ad Soyad','Musteri Adi'],phone:['Telefon','phone','Tel'],product:['Urun','product','Hizmet','Aciklama'],price:['Fiyat','price','Tutar','Toplam'],installments:['Taksit','installments','Vade'],paid:['Odenen','paid','Odeme'],stage:['Asama','stage','Durum','A≈üama'],status:['Status','status','Aktiflik']}
    },
    'projeler':{
        fields:['ad','kod','konum','basTarihi','bitTarihi','butce','durum','isverenAdi','mudurAdi'],
        guesses:{ad:['Proje','ad','Proje Adi','Baslik'],kod:['Kod','kod','Proje Kodu'],konum:['Konum','konum','Adres','Lokasyon'],basTarihi:['Baslangic','basTarihi','Bas Tarihi'],bitTarihi:['Bitis','bitTarihi','Bit Tarihi'],butce:['Butce','butce','Toplam'],durum:['Durum','durum','Status'],isverenAdi:['Isveren','isverenAdi'],mudurAdi:['Mudur','mudurAdi','Proje Muduru']}
    },
    'zimmetler':{
        fields:['tarih','malzemeAdi','miktar','zimmetliKisi','departman','durum','seriNo','birimDeger'],
        guesses:{tarih:['Tarih','tarih','Date'],malzemeAdi:['Malzeme','malzemeAdi','Urun','Ekipman'],miktar:['Miktar','miktar','Adet'],zimmetliKisi:['Kisi','zimmetliKisi','Teslim Alan','Personel'],departman:['Departman','departman','Birim'],durum:['Durum','durum'],seriNo:['Seri No','seriNo','IMEI','Barkod'],birimDeger:['Deger','birimDeger','Fiyat','Birim Deger']}
    },
    'araclar':{
        fields:['plaka','marka','model','yil','tur','yakit','kmSayaci','durum','sofor','departman'],
        guesses:{plaka:['Plaka','plaka','Plate'],marka:['Marka','marka','Brand'],model:['Model','model'],yil:['Yil','yil','Year'],tur:['Tur','tur','Tip','Type'],yakit:['Yakit','yakit','Fuel'],kmSayaci:['KM','kmSayaci','Kilometre'],durum:['Durum','durum'],sofor:['Sofor','sofor','Driver'],departman:['Departman','departman']}
    },
    'personeller':{
        fields:['ad','soyad','tcKimlikNo','telefonKisisel','emailKisisel','departmanId','gorevi','iseGirisTarihi','calismaTipi','maas'],
        guesses:{ad:['Ad','ad','Isim','First Name'],soyad:['Soyad','soyad','Last Name'],tcKimlikNo:['TC','tcKimlikNo','TC Kimlik','Kimlik No'],telefonKisisel:['Telefon','telefonKisisel','Tel','Phone'],emailKisisel:['Email','emailKisisel','E-posta'],departmanId:['Departman','departmanId','Birim'],gorevi:['Gorev','gorevi','Unvan','Position'],iseGirisTarihi:['Ise Giris','iseGirisTarihi','Giris Tarihi','Start Date'],calismaTipi:['Calisma Tipi','calismaTipi','Tip'],maas:['Maas','maas','Salary','Ucret']}
    }
};
function openImportModal(type,title){
    document.getElementById('excel-import-type').value=type;
    document.getElementById('excel-import-title').textContent=title||'Excel / CSV Icerik Aktar';
    const projSel=document.getElementById('excel-import-project-select');
    const needsProject=['iskalemi','taseron','tedarikci'].includes(type);
    projSel.parentElement.parentElement.style.display=needsProject?'':'none';
    if(needsProject){projSel.innerHTML=(S.projects||[]).map(p=>`<option value="${p.id}">${p.ad||p.name}</option>`).join('');}
    document.getElementById('excel-preview').classList.add('hidden');
    document.getElementById('excel-file-input').value='';
    document.getElementById('excel-file-info').textContent='';
    // Column mapping container
    let mapDiv=document.getElementById('excel-column-mapping');
    if(!mapDiv){mapDiv=document.createElement('div');mapDiv.id='excel-column-mapping';mapDiv.className='hidden space-y-2 mt-3';document.getElementById('excel-preview').parentElement.insertBefore(mapDiv,document.getElementById('excel-preview'));}
    mapDiv.innerHTML='';mapDiv.classList.add('hidden');
    excelImportData=[];
    openModal('modal-excel-import');
}
function buildColumnMapping(excelColumns,type){
    const def=IMPORT_FIELD_DEFS[type];if(!def)return null;
    let mapDiv=document.getElementById('excel-column-mapping');
    if(!mapDiv)return null;
    let html='<p class="text-xs text-purple-400 font-semibold border-b border-gray-700 pb-1">SUTUN ESLEME</p><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">';
    excelColumns.forEach(col=>{
        let bestMatch='_skip';
        for(const [field,guesses] of Object.entries(def.guesses)){
            if(guesses.some(g=>g.toLowerCase()===col.toLowerCase())){bestMatch=field;break;}
        }
        if(bestMatch==='_skip'){
            for(const [field,guesses] of Object.entries(def.guesses)){
                if(guesses.some(g=>col.toLowerCase().includes(g.toLowerCase()))){bestMatch=field;break;}
            }
        }
        html+=`<div class="flex flex-col"><label class="text-[9px] text-gray-500 truncate">${col}</label><select data-excel-col="${col}" class="bg-gray-800/80 border border-gray-700 rounded px-2 py-1 text-[11px]"><option value="_skip">-- Atla --</option>`;
        def.fields.forEach(f=>{html+=`<option value="${f}" ${f===bestMatch?'selected':''}>${f}</option>`;});
        html+=`</select></div>`;
    });
    html+='</div>';
    mapDiv.innerHTML=html;mapDiv.classList.remove('hidden');
    return mapDiv;
}
// Override handleExcelFile to add column mapping
const _origHandleExcelFile=handleExcelFile;
handleExcelFile=function(e){
    _origHandleExcelFile(e);
    setTimeout(()=>{
        if(excelImportData.length>0){
            const type=document.getElementById('excel-import-type').value;
            if(IMPORT_FIELD_DEFS[type]){
                const cols=Object.keys(excelImportData[0]);
                buildColumnMapping(cols,type);
            }
        }
    },500);
};
// Extended executeExcelImport
const _origExecuteExcelImport=executeExcelImport;
executeExcelImport=function(){
    const type=document.getElementById('excel-import-type').value;
    if(!IMPORT_FIELD_DEFS[type]){_origExecuteExcelImport();return;}
    if(excelImportData.length===0){showNotif('Veri yok!');return;}
    // Build mapping from dropdowns
    const mapping={};
    document.querySelectorAll('#excel-column-mapping select[data-excel-col]').forEach(sel=>{
        if(sel.value!=='_skip')mapping[sel.getAttribute('data-excel-col')]=sel.value;
    });
    let count=0;
    if(type==='tedarikci-havuzu'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,aktif:true,puan:3};
            for(const [col,field] of Object.entries(mapping)){item[field]=field==='puan'?+(row[col]||3):String(row[col]||'');}
            if(!item.firma)return;
            if(!S.tedarikcilerHavuzu)S.tedarikcilerHavuzu=[];
            S.tedarikcilerHavuzu.push(item);count++;
        });
    }else if(type==='satislar'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,stage:'lead',status:'active'};
            for(const [col,field] of Object.entries(mapping)){
                if(['price','installments','paid'].includes(field))item[field]=+(row[col]||0);
                else item[field]=String(row[col]||'');
            }
            if(!item.customer)return;
            S.sales.push(item);count++;
        });
    }else if(type==='projeler'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,ilerleme:0,durum:'devam',taseronlar:[],isKalemleri:[],hakedisler:[],gunlukRaporlar:[],yesilDefter:[],sozlesmeler:[],malzemeler:[],nakitAkisi:[],isg:[],kaliteKontrol:[],yazisMalar:[],isProgrami:[],ekipmanlar:[],gorevler:[],fotograflar:[]};
            for(const [col,field] of Object.entries(mapping)){
                if(field==='butce')item[field]=+(row[col]||0);
                else item[field]=String(row[col]||'');
            }
            if(!item.ad)return;
            S.projects.push(item);count++;
        });
    }else if(type==='zimmetler'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,durum:'aktif',miktar:1};
            for(const [col,field] of Object.entries(mapping)){
                if(['miktar','birimDeger'].includes(field))item[field]=+(row[col]||0);
                else item[field]=String(row[col]||'');
            }
            if(!item.malzemeAdi&&!item.zimmetliKisi)return;
            if(!S.zimmetler)S.zimmetler=[];
            S.zimmetler.push(item);count++;
        });
    }else if(type==='araclar'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,durum:'aktif',kmSayaci:0,belgeler:[],bakimlar:[],yakitlar:[]};
            for(const [col,field] of Object.entries(mapping)){
                if(['yil','kmSayaci'].includes(field))item[field]=+(row[col]||0);
                else item[field]=String(row[col]||'');
            }
            if(!item.plaka)return;
            S.araclar.push(item);count++;
        });
    }else if(type==='personeller'){
        excelImportData.forEach(row=>{
            const item={id:Date.now()+count,durum:'aktif',calismaTipi:'tam_zamanli',maas:0};
            for(const [col,field] of Object.entries(mapping)){
                if(field==='maas')item[field]=+(row[col]||0);
                else if(field==='departmanId'){
                    const dept=(S.departmanlar||[]).find(d=>d.ad.toLowerCase().includes(String(row[col]).toLowerCase()));
                    item[field]=dept?dept.id:String(row[col]||'');
                }else item[field]=String(row[col]||'');
            }
            if(!item.ad&&!item.soyad)return;
            if(!S.personeller)S.personeller=[];
            S.personeller.push(item);count++;
        });
    }
    if(count>0){save();renderAll();closeModal('modal-excel-import');showNotif(count+' kayit basariyla iceri aktarildi!');}
    else showNotif('Aktarilacak kayit bulunamadi. Sutun eslemeyi kontrol edin.');
};
// Extended downloadImportTemplate
const _origDownloadTemplate=downloadImportTemplate;
downloadImportTemplate=function(){
    const type=document.getElementById('excel-import-type').value;
    const def=IMPORT_FIELD_DEFS[type];
    if(!def){_origDownloadTemplate();return;}
    const headers=def.fields;
    const filename=type+'_sablon.csv';
    const csv=headers.join(',')+'\n';
    const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);showNotif('Sablon indirildi: '+filename);
};

// ===================== FAZ 4: GELISMIS ZIMMET =====================
let topluZimmetSerbestItems=[];
function generateZimmetBelgeNo(){
    const yil=new Date().getFullYear();
    const mevcut=(S.zimmetler||[]).filter(z=>z.belgeNo&&z.belgeNo.startsWith('ZMT-'+yil));
    const nums=mevcut.map(z=>{const m=z.belgeNo.match(/ZMT-\d{4}-(\d+)/);return m?parseInt(m[1]):0;});
    const next=Math.max(0,...nums)+1;
    return 'ZMT-'+yil+'-'+String(next).padStart(4,'0');
}
function openTopluZimmetForm(){
    topluZimmetSerbestItems=[];
    const pSel=document.getElementById('tz-personel');
    pSel.innerHTML='<option value="">Manuel Giris</option>'+(S.personeller||[]).filter(p=>p.durum==='aktif').map(p=>`<option value="${p.id}">${p.ad} ${p.soyad}</option>`).join('');
    document.getElementById('tz-kisi').value='';document.getElementById('tz-tc').value='';
    document.getElementById('tz-gorev').value='';document.getElementById('tz-isegiris').value='';
    const dSel=document.getElementById('tz-dept');
    dSel.innerHTML=(S.departmanlar||[]).filter(d=>d.aktif).map(d=>`<option value="${d.ad}">${d.ad}</option>`).join('');
    // Envanter kategori filtreleri
    const allKats=[...new Set((S.envanter||[]).map(i=>i.kategori).filter(Boolean))];
    const defaultActiveKats=['it','ofis','mobilya'];
    const katLabels={insaat:'Insaat',it:'IT',ofis:'Ofis',mobilya:'Mobilya','arac-gerec':'Arac-Gerec',diger:'Diger'};
    const katFilters=document.getElementById('tz-kat-filters');
    let html='<button onclick="tzToggleAllKats()" class="px-2 py-1 rounded text-[10px] border border-gray-600 bg-gray-700/50 text-gray-300 hover:bg-gray-600/50 tz-kat-all">Tumu</button>';
    allKats.forEach(k=>{
        const isDefault=defaultActiveKats.includes(k);
        html+=`<button onclick="tzToggleKat(this,'${k}')" class="px-2 py-1 rounded text-[10px] border tz-kat-btn ${isDefault?'border-teal-500 bg-teal-600/30 text-teal-300':'border-gray-600 bg-gray-700/50 text-gray-400'}" data-kat="${k}" data-active="${isDefault}">${katLabels[k]||k}</button>`;
    });
    katFilters.innerHTML=html;
    document.getElementById('tz-envanter-search').value='';
    filterTopluZimmetEnvanter();
    document.getElementById('tz-serbest-list').innerHTML='';
    document.getElementById('tz-belge-no').value=generateZimmetBelgeNo();
    const oSel=document.getElementById('tz-onaylayan');
    oSel.innerHTML=S.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    openModal('modal-toplu-zimmet');
}
function tzToggleKat(btn,kat){
    const isActive=btn.getAttribute('data-active')==='true';
    btn.setAttribute('data-active',String(!isActive));
    if(!isActive){btn.classList.remove('border-gray-600','bg-gray-700/50','text-gray-400');btn.classList.add('border-teal-500','bg-teal-600/30','text-teal-300');}
    else{btn.classList.remove('border-teal-500','bg-teal-600/30','text-teal-300');btn.classList.add('border-gray-600','bg-gray-700/50','text-gray-400');}
    filterTopluZimmetEnvanter();
}
function tzToggleAllKats(){
    document.querySelectorAll('.tz-kat-btn').forEach(b=>{
        b.setAttribute('data-active','true');
        b.classList.remove('border-gray-600','bg-gray-700/50','text-gray-400');
        b.classList.add('border-teal-500','bg-teal-600/30','text-teal-300');
    });
    filterTopluZimmetEnvanter();
}
function filterTopluZimmetEnvanter(){
    const envList=document.getElementById('tz-envanter-list');
    const searchText=(document.getElementById('tz-envanter-search')?.value||'').toLowerCase();
    const activeKats=[];
    document.querySelectorAll('.tz-kat-btn[data-active="true"]').forEach(b=>activeKats.push(b.getAttribute('data-kat')));
    const items=(S.envanter||[]).filter(i=>{
        if(i.miktar<=0)return false;
        if(activeKats.length>0&&i.kategori&&!activeKats.includes(i.kategori))return false;
        if(searchText&&!i.ad.toLowerCase().includes(searchText)&&!(i.barkod||'').toLowerCase().includes(searchText))return false;
        return true;
    });
    if(items.length===0){envList.innerHTML='<p class="text-xs text-gray-500 py-2">Filtreye uygun stokta malzeme bulunamadi.</p>';return;}
    // Mevcut checkbox durumlarini koru
    const checkedIds=new Set();
    document.querySelectorAll('.tz-env-check:checked').forEach(cb=>checkedIds.add(cb.getAttribute('data-item-id')));
    envList.innerHTML=items.map(i=>{
        const fiyat=i.birimFiyat?`<span class="text-amber-400 text-[10px] font-medium">${Number(i.birimFiyat).toLocaleString('tr-TR')} TL</span>`:'';
        const katBadge=i.kategori?`<span class="text-[8px] px-1 py-0.5 rounded ${i.kategori==='it'?'bg-blue-500/20 text-blue-400':i.kategori==='ofis'?'bg-purple-500/20 text-purple-400':i.kategori==='mobilya'?'bg-green-500/20 text-green-400':i.kategori==='insaat'?'bg-orange-500/20 text-orange-400':'bg-gray-500/20 text-gray-400'}">${i.kategori.toUpperCase()}</span>`:'';
        const isChecked=checkedIds.has(String(i.id))?'checked':'';
        return `<label class="flex items-center gap-2 p-1.5 rounded hover:bg-gray-800/40 cursor-pointer"><input type="checkbox" class="tz-env-check rounded" data-item-id="${i.id}" ${isChecked}><span class="text-xs flex-1">${i.ad} <span class="text-gray-500">(${i.miktar} ${i.birim})</span> ${katBadge}</span><input type="number" class="tz-env-qty w-12 bg-gray-800 border border-gray-700 rounded px-1 py-0.5 text-[10px] text-center" value="1" min="1" max="${i.miktar}">${fiyat}</label>`;
    }).join('');
}
function topluZimmetPersonelSec(){
    const pId=document.getElementById('tz-personel').value;
    if(!pId)return;
    const p=(S.personeller||[]).find(x=>String(x.id)===String(pId));
    if(!p)return;
    document.getElementById('tz-kisi').value=p.ad+' '+p.soyad;
    document.getElementById('tz-tc').value=p.tcKimlikNo||'';
    document.getElementById('tz-gorev').value=p.gorevi||'';
    document.getElementById('tz-isegiris').value=p.iseGirisTarihi||'';
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
    if(dept)document.getElementById('tz-dept').value=dept.ad;
}
function addSerbestZimmetItem(){
    const ad=document.getElementById('tz-serbest-ad').value.trim();
    if(!ad){showNotif('Malzeme adi girin.');return;}
    const seri=document.getElementById('tz-serbest-seri').value.trim();
    const deger=parseFloat(document.getElementById('tz-serbest-deger').value)||0;
    topluZimmetSerbestItems.push({ad,seriNo:seri,birimDeger:deger});
    document.getElementById('tz-serbest-ad').value='';document.getElementById('tz-serbest-seri').value='';document.getElementById('tz-serbest-deger').value='';
    const list=document.getElementById('tz-serbest-list');
    list.innerHTML=topluZimmetSerbestItems.map((s,i)=>`<div class="flex items-center gap-2 text-xs p-1 bg-gray-800/30 rounded"><span class="flex-1">${s.ad}</span><span class="text-gray-500">${s.seriNo||'-'}</span><span class="text-amber-400">${s.birimDeger?s.birimDeger.toLocaleString('tr-TR')+' TL':'-'}</span><button onclick="topluZimmetSerbestItems.splice(${i},1);addSerbestZimmetItem.call(null)" class="text-red-400 text-[10px]">x</button></div>`).join('');
}
function addTopluZimmet(){
    const kisi=document.getElementById('tz-kisi').value.trim();
    if(!kisi){showNotif('Personel adi girin.');return;}
    const belgeNo=document.getElementById('tz-belge-no').value;
    const dept=document.getElementById('tz-dept').value;
    const tc=document.getElementById('tz-tc').value.trim();
    const gorev=document.getElementById('tz-gorev').value.trim();
    const iseGiris=document.getElementById('tz-isegiris').value;
    const onaylayan=document.getElementById('tz-onaylayan').value;
    const tarih=new Date().toISOString().slice(0,10);
    let count=0;
    // Envanter secili kalemler
    document.querySelectorAll('.tz-env-check:checked').forEach(cb=>{
        const itemId=parseInt(cb.getAttribute('data-item-id'));
        const qty=parseInt(cb.closest('label').querySelector('.tz-env-qty').value)||1;
        const item=(S.envanter||[]).find(i=>i.id===itemId);
        if(!item)return;
        S.zimmetler.push({
            id:Date.now()+count,tarih,malzemeAdi:item.ad,malzemeId:String(itemId),
            envanterItemId:itemId,miktar:qty,zimmetliKisi:kisi,departman:dept,
            depoId:item.depoId||null,durum:'aktif',iadeTarihi:null,
            notlar:'Toplu zimmet',ekleyen:S.users[0]?.name||'Sistem',onaylayan,
            belgeNo,seriNo:item.barkod||'',birimDeger:item.birimFiyat||0,
            tcKimlikNo:tc,gorevi:gorev,iseGirisTarihi:iseGiris
        });
        item.miktar=Math.max(0,item.miktar-qty);
        count++;
    });
    // Serbest malzemeler
    topluZimmetSerbestItems.forEach(s=>{
        S.zimmetler.push({
            id:Date.now()+count,tarih,malzemeAdi:s.ad,malzemeId:null,
            envanterItemId:null,miktar:1,zimmetliKisi:kisi,departman:dept,
            depoId:null,durum:'aktif',iadeTarihi:null,
            notlar:'Toplu zimmet - serbest kalem',ekleyen:S.users[0]?.name||'Sistem',onaylayan,
            belgeNo,seriNo:s.seriNo||'',birimDeger:s.birimDeger||0,
            tcKimlikNo:tc,gorevi:gorev,iseGirisTarihi:iseGiris
        });
        count++;
    });
    if(count===0){showNotif('En az bir malzeme secin.');return;}
    // Toplam deger hesapla
    const olusturulanZimmetler=(S.zimmetler||[]).filter(z=>z.belgeNo===belgeNo);
    const toplamDeger=olusturulanZimmetler.reduce((s,z)=>(z.birimDeger||0)*(z.miktar||1)+s,0);
    save();closeModal('modal-toplu-zimmet');
    if(document.getElementById('hr-tab-personeller'))renderHrPersoneller();
    renderDepoZimmet();renderDepoEnvanter();
    const degerStr=toplamDeger>0?' Toplam deger: '+toplamDeger.toLocaleString('tr-TR')+' TL':'';
    showNotif(count+' kalem zimmet olusturuldu (Belge: '+belgeNo+').'+degerStr);
    act('Toplu Zimmet: '+kisi+' - '+count+' kalem ('+belgeNo+')');
    // Otomatik profesyonel belge acar misiniz sorusu
    if(confirm('Zimmet belgesi yazdirilsin mi?'))printProfessionalZimmetBelgesi(belgeNo);
}
function printProfessionalZimmetBelgesi(belgeNo){
    const zimmetler=(S.zimmetler||[]).filter(z=>z.belgeNo===belgeNo);
    if(zimmetler.length===0){showNotif('Bu belge numarasina ait zimmet bulunamadi.');return;}
    const z0=zimmetler[0];
    const toplamDeger=zimmetler.reduce((s,z)=>(z.birimDeger||0)*(z.miktar||1)+s,0);
    const depo0=(S.depolar||[]).find(d=>d.id===z0.depoId);
    let rows='';
    zimmetler.forEach((z,i)=>{
        const td=(z.birimDeger||0)*(z.miktar||1);
        rows+=`<tr><td>${i+1}</td><td><b>${z.malzemeAdi}</b></td><td>${z.seriNo||'-'}</td><td style="text-align:center">${z.miktar||1}</td><td style="text-align:right">${(z.birimDeger||0).toLocaleString('tr-TR')} TL</td><td style="text-align:right">${td.toLocaleString('tr-TR')} TL</td></tr>`;
    });
    const htmlContent=`<!DOCTYPE html><html><head><title>Zimmet Belgesi - ${belgeNo}</title><style>
    *{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;padding:25px;color:#1e293b;line-height:1.5;}
    .header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #0f766e;}
    .header h1{font-size:22px;color:#0f766e;margin-bottom:3px;letter-spacing:1px;}
    .header h2{font-size:13px;color:#64748b;font-weight:normal;}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px;}
    .info-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:10px;}
    .info-box label{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;}
    .info-box span{display:block;font-weight:600;font-size:12px;margin-top:2px;}
    .section-title{font-size:12px;font-weight:bold;color:#0f766e;margin:15px 0 8px;padding-bottom:4px;border-bottom:1px solid #e2e8f0;}
    table{width:100%;border-collapse:collapse;margin:8px 0;}
    th{background:#0f766e;color:white;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;padding:8px 6px;text-align:left;}
    td{border-bottom:1px solid #e2e8f0;padding:7px 6px;font-size:10px;}
    tr:nth-child(even){background:#f8fafc;}
    .total-row{background:#f0fdfa !important;font-weight:bold;}
    .total-row td{border-top:2px solid #0f766e;font-size:11px;}
    .taahhut{margin-top:15px;padding:12px;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;font-size:9px;color:#92400e;line-height:1.6;}
    .signs{display:flex;justify-content:space-between;margin-top:50px;}
    .sign-box{width:28%;text-align:center;padding-top:8px;border-top:1px solid #94a3b8;}
    .sign-box strong{display:block;font-size:10px;margin-bottom:3px;}
    .sign-box span{font-size:9px;color:#64748b;}
    .footer{text-align:center;margin-top:30px;font-size:8px;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:8px;}
    @media print{body{padding:15px;}}
    </style></head><body>
    <div class="header"><div style="font-size:28px;color:#0f766e;font-weight:900;letter-spacing:2px;margin-bottom:3px;">F<span style="font-size:20px">a</span>O<span style="font-size:20px">n</span>S<span style="font-size:20px">is</span>T</div><h1>ZIMMET / MALZEME TESLIM TUTANAGI</h1><h2>Asset Assignment Document</h2></div>
    <div class="info-grid"><div class="info-box"><label>Belge No</label><span>${belgeNo}</span></div><div class="info-box"><label>Duzenleme Tarihi</label><span>${z0.tarih||new Date().toISOString().slice(0,10)}</span></div></div>
    <div class="section-title">PERSONEL BILGILERI</div>
    <div class="info-grid"><div class="info-box"><label>Ad Soyad</label><span>${z0.zimmetliKisi}</span></div><div class="info-box"><label>TC Kimlik No</label><span>${z0.tcKimlikNo||'-'}</span></div><div class="info-box"><label>Departman</label><span>${z0.departman||'-'}</span></div><div class="info-box"><label>Gorev / Unvan</label><span>${z0.gorevi||'-'}</span></div><div class="info-box"><label>Ise Giris Tarihi</label><span>${z0.iseGirisTarihi||'-'}</span></div></div>
    <div class="section-title">TESLIM EDILEN MALZEMELER</div>
    <table><thead><tr><th>#</th><th>Malzeme / Ekipman</th><th>Seri No / IMEI</th><th style="text-align:center">Miktar</th><th style="text-align:right">Birim Deger</th><th style="text-align:right">Toplam</th></tr></thead><tbody>
    ${rows}
    <tr class="total-row"><td colspan="4"></td><td style="text-align:right">TOPLAM DEGER:</td><td style="text-align:right">${toplamDeger.toLocaleString('tr-TR')} TL</td></tr></tbody></table>
    <div class="taahhut"><b>TAAHHUTNAME:</b> Bu tutanak ile yukarida belirtilen malzeme/ekipmanlar tarafima zimmet olarak teslim edilmistir. Teslim alinan malzemelerin korunmasi, amacina uygun kullanilmasi ve istendiginde eksiksiz iade edilmesi taahhut edilmektedir. Hasar, kayip veya amac disi kullanim durumunda sorumluluk teslim alan kisiye aittir.</div>
    <div class="signs"><div class="sign-box"><strong>Teslim Eden</strong><span>(Depo Sorumlusu)</span><br><br><br><span>${depo0&&depo0.sorumlu?depo0.sorumlu:'________________'}</span><br><span>Tarih: ___/___/______</span></div><div class="sign-box"><strong>Teslim Alan</strong><span>(Personel)</span><br><br><br><span>${z0.zimmetliKisi}</span><br><span>Tarih: ${z0.tarih||'___/___/______'}</span></div><div class="sign-box"><strong>Onaylayan</strong><span>(Yonetici)</span><br><br><br><span>${z0.onaylayan||'________________'}</span><br><span>Tarih: ___/___/______</span></div></div>
    <div class="footer">FaOnSisT v5.0 &middot; Zimmet / Malzeme Teslim Tutanagi &middot; Belge No: ${belgeNo} &middot; ${new Date().toLocaleString('tr-TR')}</div>
    </body></html>`;
    const frame=document.getElementById('print-frame');
    const doc=frame.contentDocument||frame.contentWindow.document;
    doc.open();doc.write(htmlContent);doc.close();
    setTimeout(()=>{frame.contentWindow.focus();frame.contentWindow.print();},300);
}

// ===================== FAZ 5: FAON-HR MODULU =====================
// Turkiye Is Kanunu Madde 53 - Kidem bazli yillik izin hakki
// 1-5 yil: 14 gun, 5-15 yil: 20 gun, 15+ yil: 26 gun
// 18 yas alti + 50 yas ustu: minimum 20 gun
// 1 yildan az kidem: 0 gun (hak yok)
const UCRETLI_IZIN_TURLERI=['yillik','evlilik','olum','dogum'];
const UCRETSIZ_IZIN_TURLERI=['ucretsiz'];

// ===================== ISTEN AYRILMA SURECI =====================
const AYRILMA_NEDENLERI={istifa:'Istifa',isverenFesih:'Isveren Feshi',karsilikliAnlasma:'Karsilikli Anlasma',emeklilik:'Emeklilik',askereGidis:'Askerlik',vefat:'Vefat',sozlesmeSonu:'Sozlesme Sonu',diger:'Diger'};
// Is Kanunu Madde 17 - Ihbar sureleri
const IHBAR_SURELERI=[{min:0,max:6,hafta:2},{min:6,max:18,hafta:4},{min:18,max:36,hafta:6},{min:36,max:Infinity,hafta:8}];

// ===================== PERSONEL BELGE PAKETI SISTEMI =====================
const HR_BELGE_SABLONLARI=[
    {id:'kvkk',baslik:'KVKK Aydinlatma Metni',tur:'kvkk',icon:'&#128274;'},
    {id:'gizlilik',baslik:'Gizlilik Sozlesmesi',tur:'gizlilik',icon:'&#129309;'},
    {id:'is_sozlesmesi',baslik:'Is Sozlesmesi',tur:'sozlesme',icon:'&#128203;'},
    {id:'zimmet_tutanagi',baslik:'Zimmet Teslim Tutanagi',tur:'zimmet_tutanagi',icon:'&#128230;'},
    {id:'isg',baslik:'ISG Egitim Belgesi',tur:'isg',icon:'&#9888;'},
    {id:'etik',baslik:'Etik Kurallar Taahhutnamesi',tur:'etik',icon:'&#9878;'},
    {id:'isten_ayrilma_bildirimi',baslik:'Isten Ayrilma Bildirimi',tur:'ayrilma',icon:'&#128683;',ayrilmaBelgesi:true},
    {id:'is_deneyim_belgesi',baslik:'Is Deneyim Belgesi',tur:'deneyim',icon:'&#127891;',ayrilmaBelgesi:true},
    {id:'zimmet_iade_tutanagi',baslik:'Zimmet Iade Tutanagi',tur:'zimmet_iade',icon:'&#128230;',ayrilmaBelgesi:true},
    {id:'ibra_belgesi',baslik:'Ibra Belgesi (Ibraname)',tur:'ibra',icon:'&#128220;',ayrilmaBelgesi:true}
];
const BELGE_STIL=`*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;padding:30px 40px;color:#1e293b;line-height:1.6;}
.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #0f766e;}
.header h1{font-size:18px;color:#0f766e;margin-bottom:3px;letter-spacing:1px;text-transform:uppercase;}
.header h2{font-size:11px;color:#64748b;font-weight:normal;}
.logo{font-size:28px;color:#0f766e;font-weight:900;letter-spacing:2px;margin-bottom:3px;}
.logo span{font-size:20px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px;}
.info-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:10px;}
.info-box label{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;}
.info-box span{display:block;font-weight:600;font-size:12px;margin-top:2px;}
.section-title{font-size:13px;font-weight:bold;color:#0f766e;margin:18px 0 8px;padding-bottom:4px;border-bottom:1px solid #e2e8f0;}
.madde{margin:6px 0;padding-left:8px;font-size:10.5px;line-height:1.7;}
.madde b{color:#0f766e;}
table{width:100%;border-collapse:collapse;margin:8px 0;}
th{background:#0f766e;color:white;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;padding:8px 6px;text-align:left;}
td{border-bottom:1px solid #e2e8f0;padding:7px 6px;font-size:10px;}
tr:nth-child(even){background:#f8fafc;}
.signs{display:flex;justify-content:space-between;margin-top:40px;}
.sign-box{width:30%;text-align:center;padding-top:8px;border-top:1px solid #94a3b8;}
.sign-box strong{display:block;font-size:10px;margin-bottom:3px;}
.sign-box span{font-size:9px;color:#64748b;}
.footer{text-align:center;margin-top:25px;font-size:8px;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:8px;}
.page-break{page-break-before:always;}
@media print{body{padding:20px 25px;}}`;

function _belgeHeader(baslik,altBaslik){
    return `<div class="header"><div class="logo">F<span>a</span>O<span>n</span>S<span>is</span>T</div><h1>${baslik}</h1>${altBaslik?'<h2>'+altBaslik+'</h2>':''}</div>`;
}
function _belgePersonelInfo(p,dept){
    const bugun=new Date().toISOString().slice(0,10);
    return `<div class="info-grid">
<div class="info-box"><label>Ad Soyad</label><span>${p.ad} ${p.soyad}</span></div>
<div class="info-box"><label>TC Kimlik No</label><span>${p.tcKimlikNo||'_______________'}</span></div>
<div class="info-box"><label>Departman</label><span>${dept?dept.ad:'-'}</span></div>
<div class="info-box"><label>Gorev / Unvan</label><span>${p.gorevi||'-'}</span></div>
<div class="info-box"><label>Ise Giris Tarihi</label><span>${p.iseGirisTarihi||bugun}</span></div>
<div class="info-box"><label>Belge Tarihi</label><span>${bugun}</span></div>
</div>`;
}
function _belgeImzaAlani(personelAdi){
    return `<div class="signs">
<div class="sign-box"><strong>Calisan</strong><span>(Personel)</span><br><br><br><span>${personelAdi}</span><br><span>Imza: ________________</span><br><span>Tarih: ___/___/______</span></div>
<div class="sign-box"><strong>IK Muduru</strong><span>(Insan Kaynaklari)</span><br><br><br><span>________________</span><br><span>Imza: ________________</span><br><span>Tarih: ___/___/______</span></div>
<div class="sign-box"><strong>Sirket Yetkilisi</strong><span>(Genel Mudur)</span><br><br><br><span>________________</span><br><span>Imza: ________________</span><br><span>Tarih: ___/___/______</span></div>
</div>`;
}
function _belgeFooter(belgeNo,baslik){
    return `<div class="footer">FaOnSisT v5.0 &middot; ${baslik} &middot; ${belgeNo} &middot; ${new Date().toLocaleString('tr-TR')}</div>`;
}
function _belgeAyrilmaInfo(personel){
    const ayrilmaTarihi=personel.ayrilmaTarihi||new Date().toISOString().slice(0,10);
    const neden=AYRILMA_NEDENLERI[personel.ayrilmaNedeni]||personel.ayrilmaNedeni||'-';
    const k=hesaplaKidemTazminati(personel,ayrilmaTarihi);
    return `<div class="info-grid"><div class="info-box"><label>Ayrilma Tarihi</label><span>${ayrilmaTarihi}</span></div><div class="info-box"><label>Ayrilma Nedeni</label><span>${neden}</span></div><div class="info-box"><label>Kidem Suresi</label><span>${k.yil} yil ${k.ay} ay ${k.gun} gun</span></div><div class="info-box"><label>Toplam Calisma</label><span>${k.toplamGun} gun</span></div></div>`;
}

function _parseBelgeSablonu(sablonText,personel,dept){
    const pAdi=personel.ad+' '+personel.soyad;
    const bugun=new Date().toISOString().slice(0,10);
    // Degisken degistirme
    let text=sablonText
        .replace(/\{AD_SOYAD\}/g,pAdi)
        .replace(/\{TC_KIMLIK\}/g,personel.tcKimlikNo||'_______________')
        .replace(/\{DEPARTMAN\}/g,dept?dept.ad:'-')
        .replace(/\{GOREV\}/g,personel.gorevi||'-')
        .replace(/\{ISE_GIRIS\}/g,personel.iseGirisTarihi||bugun)
        .replace(/\{TARIH\}/g,bugun)
        .replace(/\{MAAS\}/g,personel.maas?personel.maas.toLocaleString('tr-TR')+' TL':'________________ TL')
        .replace(/\{CALISMA_TIPI\}/g,personel.calismaTipi==='tam_zamanli'?'Tam Zamanli':personel.calismaTipi==='yari_zamanli'?'Yari Zamanli':personel.calismaTipi==='sozlesmeli'?'Sozlesmeli':'Stajyer')
        .replace(/\{AYRILMA_TARIHI\}/g,personel.ayrilmaTarihi||'________________')
        .replace(/\{AYRILMA_NEDENI\}/g,AYRILMA_NEDENLERI[personel.ayrilmaNedeni]||personel.ayrilmaNedeni||'________________')
        .replace(/\{KIDEM_SURESI\}/g,(function(){const k=hesaplaKidemTazminati(personel,personel.ayrilmaTarihi);return k.yil+' yil '+k.ay+' ay '+k.gun+' gun';})());
    // Satirlari parse et
    let html='';
    text.split('\n').forEach(line=>{
        const trimmed=line.trim();
        if(!trimmed){html+='<br>';return;}
        if(trimmed.startsWith('BASLIK:')){
            html+=`<div class="section-title">${trimmed.replace('BASLIK:','').trim()}</div>`;
        }else{
            // **bold** destegi
            let processed=trimmed.replace(/\*\*(.+?)\*\*/g,'<b>$1</b>');
            html+=`<p class="madde">${processed}</p>`;
        }
    });
    return html;
}
function generateHrBelgeHTML(sablonId,personel){
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(personel.departmanId));
    const pAdi=personel.ad+' '+personel.soyad;
    const bugun=new Date().toISOString().slice(0,10);
    const belgeNo='BLG-'+new Date().getFullYear()+'-'+String(Date.now()).slice(-5);
    // Ozel sablon var mi kontrol et
    const ozelSablon=(S.belgeSablonlari||{})[sablonId];
    if(ozelSablon){
        const sablon=HR_BELGE_SABLONLARI.find(s=>s.id===sablonId);
        const baslik=sablon?sablon.baslik:sablonId;
        return `${_belgeHeader(baslik.toUpperCase(),'')}
${_belgePersonelInfo(personel,dept)}
${_parseBelgeSablonu(ozelSablon,personel,dept)}
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,baslik)}`;
    }
    // Varsayilan sablonlar
    let icerik='';
    switch(sablonId){
        case 'kvkk':
            icerik=`
${_belgeHeader('KISISEL VERILERIN KORUNMASI HAKKINDA AYDINLATMA METNI','6698 Sayili KVKK Kapsaminda')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">1. VERI SORUMLUSU</div>
<p class="madde">6698 sayili Kisisel Verilerin Korunmasi Kanunu ("KVKK") uyarinca, kisisel verileriniz veri sorumlusu sifatiyla sirketimiz tarafindan asagida aciklanan amaclarla islenebilecektir.</p>
<div class="section-title">2. KISISEL VERILERIN ISLENME AMACI</div>
<p class="madde"><b>a)</b> Is sozlesmesinin kurulmasi ve ifasi ile ilgili sureclerin yurutulmesi</p>
<p class="madde"><b>b)</b> Insan kaynaklari sureclerinin planlanmasi ve yurutulmesi</p>
<p class="madde"><b>c)</b> Calisan adaylari / stajyerler / calisanlara yonelik sureclerin yurutulmesi</p>
<p class="madde"><b>d)</b> Is sagligi ve guvenligi faaliyetlerinin yurutulmesi</p>
<p class="madde"><b>e)</b> Egitim faaliyetlerinin yurutulmesi</p>
<p class="madde"><b>f)</b> Performans degerlendirme sureclerinin yurutulmesi</p>
<p class="madde"><b>g)</b> Yasal yukumluluklerin yerine getirilmesi (SGK, vergi vb.)</p>
<p class="madde"><b>h)</b> Fiziksel mekan guvenliginin saglanmasi</p>
<div class="section-title">3. ISLENEN KISISEL VERI KATEGORILERI</div>
<p class="madde"><b>Kimlik:</b> Ad, soyad, TC kimlik numarasi, dogum tarihi, cinsiyet</p>
<p class="madde"><b>Iletisim:</b> Telefon numarasi, e-posta adresi, adres bilgileri</p>
<p class="madde"><b>Mesleki:</b> Egitim durumu, is deneyimi, sertifika bilgileri</p>
<p class="madde"><b>Finansal:</b> Banka hesap bilgileri, maas bilgileri</p>
<p class="madde"><b>Saglik:</b> Saglik raporu, kan grubu, engel durumu</p>
<div class="section-title">4. KISISEL VERILERIN AKTARILMASI</div>
<p class="madde">Kisisel verileriniz; yasal zorunluluklar kapsaminda kamu kurum ve kuruluslarinda (SGK, Gelir Idaresi), hukuki uyusmazliklarda yetkili yargi organlarinda, is sagligi ve guvenligi amaciyla yetkili saglik kuruluslarinda paylasabilecektir.</p>
<div class="section-title">5. HAKLARINIZ (KVKK Madde 11)</div>
<p class="madde"><b>a)</b> Kisisel verilerin islenip islenmedigini ogrenme</p>
<p class="madde"><b>b)</b> Islenmisse buna iliskin bilgi talep etme</p>
<p class="madde"><b>c)</b> Islenme amacini ve amacina uygun kullanilip kullanilmadigini ogrenme</p>
<p class="madde"><b>d)</b> Eksik veya yanlis islenmisse duzeltilmesini isteme</p>
<p class="madde"><b>e)</b> KVKK Madde 7 kapsaminda silinmesini veya yok edilmesini isteme</p>
<p class="madde"><b>f)</b> Islenen verilerin ucuncu kisilere bildirilmesini isteme</p>
<p class="madde"><b>g)</b> Verilerin otomatik sistemler ile analiz edilmesi sonucu aleyhine bir sonucun ortaya cikmasina itiraz etme</p>
<p class="madde"><b>h)</b> Kanuna aykiri olarak islenmesi sebebiyle zarara ugramaniz halinde giderilmesini talep etme</p>
<p class="madde" style="margin-top:15px;font-style:italic;">Bu aydinlatma metnini okudugumu, anladigimi ve bir nushasini teslim aldigimi beyan ederim.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'KVKK Aydinlatma Metni')}`;
            break;

        case 'gizlilik':
            icerik=`
${_belgeHeader('GIZLILIK SOZLESMESI','Confidentiality Agreement')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">MADDE 1 - KONU</div>
<p class="madde">Bu sozlesme, calisanin is iliskisi suresince ve is iliskisinin sona ermesinden sonra sirketin ticari sirlarini, musterilerine, is ortaklarina, teknik bilgilerine ve diger gizli bilgilerine iliskin gizlilik yukumluluklerini duzenler.</p>
<div class="section-title">MADDE 2 - GIZLI BILGI TANIMI</div>
<p class="madde"><b>a)</b> Sirketin ticari, mali, teknik ve idari bilgileri</p>
<p class="madde"><b>b)</b> Musteri listeleri, fiyatlandirma politikalari, pazarlama stratejileri</p>
<p class="madde"><b>c)</b> Yazilim kodlari, teknik cizimleri, uretim surecleri, know-how bilgileri</p>
<p class="madde"><b>d)</b> Calisanlara, yoneticilere ve sirket ortaklarina ait kisisel veriler</p>
<p class="madde"><b>e)</b> Sirketin is planlari, projeler, fizibilite calismalari</p>
<div class="section-title">MADDE 3 - YUKUMLULUKLER</div>
<p class="madde"><b>3.1</b> Calisan, gizli bilgileri sadece gorev tanimi kapsaminda ve sirket cikarlari dogrultusunda kullanacaktir.</p>
<p class="madde"><b>3.2</b> Gizli bilgileri yazili izin almaksizin ucuncu sahis ve kuruluslara aciklamayacaktir.</p>
<p class="madde"><b>3.3</b> Gizli bilgileri iceren belge, dosya, elektronik veri ve benzeri materyalleri koruyacak ve yetkisiz erisime karsi onlem alacaktir.</p>
<p class="madde"><b>3.4</b> Is iliskisi sona erdiginde, elindeki tum gizli bilgi iceren materyalleri eksiksiz olarak iade edecektir.</p>
<div class="section-title">MADDE 4 - SURE</div>
<p class="madde">Bu sozlesmedeki gizlilik yukumlulukleri, is sozlesmesinin sona ermesinden itibaren <b>2 (iki) yil</b> sureyle devam edecektir.</p>
<div class="section-title">MADDE 5 - IHLAL VE YAPTIRIMLAR</div>
<p class="madde">Calisanin bu sozlesmedeki yukumluluklerini ihlal etmesi halinde; sirket, is sozlesmesini hakli sebeple feshedebilir ve ugranan zarar icin tazminat talebinde bulunabilir. Ayrica Turk Ceza Kanunu'nun ilgili maddeleri kapsaminda cezai islem yapilabilir.</p>
<p class="madde" style="margin-top:15px;font-style:italic;">Yukaridaki sartlari okudugumu, anladigimi ve kabul ettigimi beyan ederim.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Gizlilik Sozlesmesi')}`;
            break;

        case 'is_sozlesmesi':
            icerik=`
${_belgeHeader('IS SOZLESMESI','Belirsiz Sureli Is Sozlesmesi')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">MADDE 1 - TARAFLAR</div>
<p class="madde"><b>Isveren:</b> ________________________________ (Bundan sonra "Sirket" olarak anilacaktir)</p>
<p class="madde"><b>Calisan:</b> ${pAdi} ‚Äî TC: ${personel.tcKimlikNo||'_______________'}</p>
<div class="section-title">MADDE 2 - IS TANIMI</div>
<p class="madde">Calisan, <b>${dept?dept.ad:'-'}</b> departmaninda <b>${personel.gorevi||'-'}</b> gorevini yurutecektir. Sirket, is gerekliliklerine gore calisanin gorev ve calisma yerini degistirebilir.</p>
<div class="section-title">MADDE 3 - CALISMA SARTLARI</div>
<p class="madde"><b>3.1 Ise Baslama Tarihi:</b> ${personel.iseGirisTarihi||bugun}</p>
<p class="madde"><b>3.2 Calisma Sekli:</b> ${personel.calismaTipi==='tam_zamanli'?'Tam Zamanli':personel.calismaTipi==='yari_zamanli'?'Yari Zamanli':personel.calismaTipi==='sozlesmeli'?'Sozlesmeli':'Stajyer'}</p>
<p class="madde"><b>3.3 Calisma Saatleri:</b> Haftalik 45 saat, Pazartesi-Cuma 09:00-18:00 (1 saat oglen arasi)</p>
<p class="madde"><b>3.4 Deneme Suresi:</b> 2 (iki) ay (4857 sayili Is Kanunu Madde 15)</p>
<div class="section-title">MADDE 4 - UCRET</div>
<p class="madde"><b>4.1 Aylik Brut Ucret:</b> ${personel.maas?personel.maas.toLocaleString('tr-TR')+' TL':'________________ TL'}</p>
<p class="madde"><b>4.2 Odeme Gunu:</b> Her ayin son is gunu banka hesabina</p>
<p class="madde"><b>4.3 Fazla Mesai:</b> 4857 sayili Is Kanunu hukumlerine gore hesaplanir</p>
<div class="section-title">MADDE 5 - YILLIK IZIN</div>
<p class="madde">Calisan, 4857 sayili Is Kanunu Madde 53 uyarinca kidem suresine gore yillik ucretli izin hakkina sahiptir.</p>
<div class="section-title">MADDE 6 - FESIH</div>
<p class="madde"><b>6.1</b> Taraflardan her biri, 4857 sayili Is Kanunu'nda belirtilen bildirim surelerine uyarak sozlesmeyi feshedebilir.</p>
<p class="madde"><b>6.2</b> Hakli fesih halleri Is Kanunu Madde 24 ve 25'te duzenlenmistir.</p>
<p class="madde" style="margin-top:15px;font-style:italic;">Bu sozlesme 2 (iki) nushadan duzenlenmis olup, taraflarca okunarak imzalanmistir.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Is Sozlesmesi')}`;
            break;

        case 'zimmet_tutanagi':
            icerik=`
${_belgeHeader('ZIMMET / MALZEME TESLIM TUTANAGI','Asset Assignment Document')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">TESLIM EDILEN MALZEMELER</div>
<table><thead><tr><th>#</th><th>Malzeme / Ekipman</th><th>Seri No / IMEI</th><th style="text-align:center">Miktar</th><th>Durum</th><th>Notlar</th></tr></thead><tbody>
<tr><td>1</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>2</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>3</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>4</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>5</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>6</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>7</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
<tr><td>8</td><td></td><td></td><td style="text-align:center"></td><td></td><td></td></tr>
</tbody></table>
<div style="margin-top:15px;padding:12px;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;font-size:9px;color:#92400e;line-height:1.6;">
<b>TAAHHUTNAME:</b> Yukarida belirtilen malzeme/ekipmanlar tarafima zimmet olarak teslim edilmistir. Teslim alinan malzemelerin korunmasi, amacina uygun kullanilmasi ve istendiginde eksiksiz iade edilmesi taahhut edilmektedir. Hasar, kayip veya amac disi kullanim durumunda sorumluluk teslim alan kisiye aittir.
</div>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Zimmet Teslim Tutanagi')}`;
            break;

        case 'isg':
            icerik=`
${_belgeHeader('IS SAGLIGI VE GUVENLIGI EGITIM BELGESI','6331 Sayili ISG Kanunu Kapsaminda')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">EGITIM KONULARI</div>
<p class="madde"><b>1.</b> Genel is sagligi ve guvenligi kurallari</p>
<p class="madde"><b>2.</b> Calisma ortamindaki riskler ve korunma yontemleri</p>
<p class="madde"><b>3.</b> Kisisel koruyucu donanimlarin (KKD) kullanimi</p>
<p class="madde"><b>4.</b> Acil durum plani ve tahliye proseduru</p>
<p class="madde"><b>5.</b> Yangin guvenligi ve yangin sondurme cihazlarinin kullanimi</p>
<p class="madde"><b>6.</b> Ilk yardim bilgisi</p>
<p class="madde"><b>7.</b> Is kazasi ve meslek hastaliklari bildirimi</p>
<p class="madde"><b>8.</b> Ergonomi ve ofis calisma kosullari</p>
<p class="madde"><b>9.</b> Elektrik guvenligi</p>
<p class="madde"><b>10.</b> Kimyasal madde guvenligi</p>
<div class="section-title">CALISANIN BEYAN VE TAAHHUTLERI</div>
<p class="madde"><b>a)</b> Yukarida belirtilen konularda is sagligi ve guvenligi egitimi aldigimi,</p>
<p class="madde"><b>b)</b> Is sagligi ve guvenligi kurallarini okuyup anladigimi,</p>
<p class="madde"><b>c)</b> Bu kurallara uyacagimi ve uymamanin sonuclarini bildigimi,</p>
<p class="madde"><b>d)</b> Is kazasi ve tehlikeli durumlari derhal amire bildirmeyi,</p>
<p class="madde"><b>e)</b> Kisisel koruyucu donanimlarimi (KKD) calisma suresi boyunca kullanacagimi,</p>
<p class="madde"><b>f)</b> 6331 sayili ISG Kanunu kapsamindaki yukumluluklerimi yerine getirmeyi taahhut ederim.</p>
<div class="section-title">EGITIM BILGILERI</div>
<div class="info-grid">
<div class="info-box"><label>Egitim Tarihi</label><span>${bugun}</span></div>
<div class="info-box"><label>Egitim Suresi</label><span>_______ saat</span></div>
<div class="info-box"><label>Egitmen</label><span>________________</span></div>
<div class="info-box"><label>Egitim Yeri</label><span>________________</span></div>
</div>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'ISG Egitim Belgesi')}`;
            break;

        case 'etik':
            icerik=`
${_belgeHeader('ETIK KURALLAR TAAHHUTNAMESI','Code of Ethics Commitment')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">MADDE 1 - AMAC</div>
<p class="madde">Bu taahhutname, sirketimizin is etigi ilkeleri cercevesinde tum calisanlarin uyacagi davranis kurallari ve sorumluluklari belirler.</p>
<div class="section-title">MADDE 2 - TEMEL ILKELER</div>
<p class="madde"><b>2.1 Durustluk:</b> Tum is iliskilerinde durust ve seffaf davranacagimi,</p>
<p class="madde"><b>2.2 Gizlilik:</b> Sirket bilgilerini gizli tutacagimi ve yetkisiz kisilarla paylasmayacagimi,</p>
<p class="madde"><b>2.3 Cikar Catismasi:</b> Kisisel cikarlarim ile sirket cikarlari arasinda catisma yaratmayacagimi,</p>
<p class="madde"><b>2.4 Esitlik:</b> Irk, din, dil, cinsiyet, yas ayrimciligi yapmayacagimi,</p>
<p class="madde"><b>2.5 Taciz ve Zorbalik:</b> Is yerinde her turlu taciz ve zorbaliktan kacinacagimi,</p>
<p class="madde"><b>2.6 Sirket Varliklarinin Korunmasi:</b> Sirket varliklarini ozenle kullanacagimi ve koruyacagimi,</p>
<div class="section-title">MADDE 3 - HEDIYE VE MENFAAT</div>
<p class="madde"><b>3.1</b> Gorevimle ilgili hicbir kisiden hediye, para veya menfaat kabul etmeyecegimi,</p>
<p class="madde"><b>3.2</b> Tedarikci, musteri veya is ortaklarindan herhangi bir kisisel cikar saglamayacagimi,</p>
<div class="section-title">MADDE 4 - BILDIRIM YUKUMLULUGU</div>
<p class="madde"><b>4.1</b> Etik kurallara aykiri gozlemledigim davranislari derhal yonetimime bildirecegimi,</p>
<p class="madde"><b>4.2</b> Bildirimde bulunan calisanlara misilleme yapilmayacagini bildigimi,</p>
<div class="section-title">MADDE 5 - YAPTIRIMLAR</div>
<p class="madde">Bu taahhutnamedeki kurallara uyulmamasi halinde, is sozlesmesinin feshi dahil disiplin islemleri uygulanabilir.</p>
<p class="madde" style="margin-top:15px;font-style:italic;">Yukaridaki etik kurallari okudugumu, anladigimi ve uyacagimi taahhut ederim.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Etik Kurallar Taahhutnamesi')}`;
            break;

        case 'isten_ayrilma_bildirimi':
            icerik=`
${_belgeHeader('ISTEN AYRILMA BILDIRIMI','Employee Separation Notice')}
${_belgePersonelInfo(personel,dept)}
${_belgeAyrilmaInfo(personel)}
<div class="section-title">1. AYRILMA BILGILERI</div>
<p class="madde">Asagida bilgileri yer alan calisanimiz, belirtilen tarih itibariyle sirketimizden ayrilmistir.</p>
<p class="madde"><b>Ayrilma Tarihi:</b> ${personel.ayrilmaTarihi||'________________'}</p>
<p class="madde"><b>Ayrilma Nedeni:</b> ${AYRILMA_NEDENLERI[personel.ayrilmaNedeni]||personel.ayrilmaNedeni||'________________'}</p>
<p class="madde"><b>Kidem Suresi:</b> ${(function(){const k=hesaplaKidemTazminati(personel,personel.ayrilmaTarihi);return k.yil+' yil '+k.ay+' ay '+k.gun+' gun';})()}</p>
${personel.ayrilmaAciklama?'<p class="madde"><b>Aciklama:</b> '+personel.ayrilmaAciklama+'</p>':''}
<div class="section-title">2. TAZMINAT BILGILERI</div>
<p class="madde"><b>Kidem Tazminati:</b> ${personel.kidemTazminatiHakEder?((personel.kidemTazminatiTutar||0).toLocaleString('tr-TR')+' TL (Tahmini)'):'Hak etmez'}</p>
<p class="madde"><b>Ihbar Tazminati:</b> ${personel.ihbarTazminatiHakEder?((personel.ihbarTazminatiTutar||0).toLocaleString('tr-TR')+' TL (Tahmini)'):'Hak etmez'}</p>
<div class="section-title">3. YAPILACAK ISLEMLER</div>
<p class="madde">1. Zimmetli malzemelerin iadesi</p>
<p class="madde">2. Is deneyim belgesinin hazirlanmasi</p>
<p class="madde">3. SGK cikis bildiriminin yapilmasi</p>
<p class="madde">4. Son maas ve tazminat odemelerinin tamamlanmasi</p>
<p class="madde">5. Ibraname imzalanmasi</p>
<p class="madde">6. Sirket erisim yetkilerinin kapatilmasi</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Isten Ayrilma Bildirimi')}`;
            break;

        case 'is_deneyim_belgesi':
            icerik=`
${_belgeHeader('IS DENEYIM BELGESI','Work Experience Certificate')}
${_belgePersonelInfo(personel,dept)}
<div class="section-title">CALISAN BILGILERI</div>
<p class="madde">Asagida bilgileri belirtilen kisinin sirketimizde calistigini ve belirtilen tarihler arasinda gorevini basariyla yerine getirdigini tasdik ederiz.</p>
<table class="info-table"><tr><td style="font-weight:600;width:200px;padding:6px 10px;">Calisan Adi Soyadi</td><td style="padding:6px 10px;">${pAdi}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">TC Kimlik No</td><td style="padding:6px 10px;">${personel.tcKimlikNo||'_______________'}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Departman</td><td style="padding:6px 10px;">${dept?dept.ad:'-'}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Gorevi / Unvani</td><td style="padding:6px 10px;">${personel.gorevi||'-'}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Ise Baslama Tarihi</td><td style="padding:6px 10px;">${personel.iseGirisTarihi||'-'}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Isten Ayrilma Tarihi</td><td style="padding:6px 10px;">${personel.ayrilmaTarihi||'-'}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Toplam Calisma Suresi</td><td style="padding:6px 10px;">${(function(){const k=hesaplaKidemTazminati(personel,personel.ayrilmaTarihi);return k.yil+' yil '+k.ay+' ay '+k.gun+' gun';})()}</td></tr>
<tr><td style="font-weight:600;padding:6px 10px;">Ayrilma Nedeni</td><td style="padding:6px 10px;">${AYRILMA_NEDENLERI[personel.ayrilmaNedeni]||'-'}</td></tr></table>
<br>
<p class="madde">Yukarda bilgileri yer alan personelimiz, belirtilen tarihler arasinda sirketimizde ${personel.gorevi||'calisan'} olarak gorev yapmis olup, gorevini basari ile ifa etmistir.</p>
<p class="madde">Isbu belge ilgilinin talebi uzerine, is deneyimini belgelemek amaciyla duzenlenistir.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Is Deneyim Belgesi')}`;
            break;

        case 'zimmet_iade_tutanagi':
            const zimmetler=(S.envanterZimmetleri||[]).filter(z=>String(z.personelId)===String(personel.id)&&z.durum==='teslim_edildi');
            let zimmetRows='';
            if(zimmetler.length>0){
                zimmetler.forEach((z,i)=>{
                    const env=(S.envanterler||[]).find(e=>String(e.id)===String(z.malzemeId));
                    zimmetRows+=`<tr><td style="padding:6px 10px;text-align:center;">${i+1}</td><td style="padding:6px 10px;">${env?env.ad:z.malzemeId}</td><td style="padding:6px 10px;">${env?env.seriNo||'-':'-'}</td><td style="padding:6px 10px;text-align:center;">&#9744;</td><td style="padding:6px 10px;"></td></tr>`;
                });
            }else{
                for(let i=0;i<5;i++){zimmetRows+=`<tr><td style="padding:6px 10px;text-align:center;">${i+1}</td><td style="padding:6px 10px;"></td><td style="padding:6px 10px;"></td><td style="padding:6px 10px;text-align:center;">&#9744;</td><td style="padding:6px 10px;"></td></tr>`;}
            }
            icerik=`
${_belgeHeader('ZIMMET IADE TUTANAGI','Asset Return Receipt')}
${_belgePersonelInfo(personel,dept)}
${_belgeAyrilmaInfo(personel)}
<div class="section-title">IADE EDILEN MALZEMELER</div>
<p class="madde">Asagida listelenen malzemeler, calisanin isten ayrilmasi sebebiyle iade alinmistir.</p>
<table class="info-table"><thead><tr style="background:#f0f9ff;"><th style="padding:6px 10px;text-align:center;width:40px;">No</th><th style="padding:6px 10px;">Malzeme Adi</th><th style="padding:6px 10px;">Seri No</th><th style="padding:6px 10px;text-align:center;width:60px;">Iade</th><th style="padding:6px 10px;">Aciklama</th></tr></thead><tbody>${zimmetRows}</tbody></table>
<br>
<p class="madde">Yukarda listelenen malzemeler eksiksiz olarak teslim alinmis/teslim edilmistir. Iade islemi tamamlanmistir.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Zimmet Iade Tutanagi')}`;
            break;

        case 'ibra_belgesi':
            icerik=`
${_belgeHeader('IBRA BELGESI (IBRANAME)','Release Document')}
${_belgePersonelInfo(personel,dept)}
${_belgeAyrilmaInfo(personel)}
<div class="section-title">IBRA BEYANI</div>
<p class="madde">Asagida imzasi bulunan ben <b>${pAdi}</b>, TC Kimlik No: <b>${personel.tcKimlikNo||'_______________'}</b>, ${personel.iseGirisTarihi||'________________'} tarihinden ${personel.ayrilmaTarihi||'________________'} tarihine kadar calismis oldugum sirketinizden ayrilmam sebebiyle;</p>
<p class="madde">1. <b>Ucret ve Maas:</b> Calistigim surede hak ettigim tum ucret, fazla mesai, prim, ikramiye ve diger her turlu alacaklarimi eksiksiz olarak aldigimi,</p>
<p class="madde">2. <b>Yillik Izin:</b> Hak ettigim yillik ucretli izinlerimi kullandigimi veya karsiliginin odendigini,</p>
<p class="madde">3. <b>Kidem Tazminati:</b> ${personel.kidemTazminatiHakEder?'Kidem tazminatimin hesaplanarak tarafima odendigini/odenecegini,':'Kidem tazminati talep etme hakkimin bulunmadigini,'}</p>
<p class="madde">4. <b>Ihbar Tazminati:</b> ${personel.ihbarTazminatiHakEder?'Ihbar tazminatimin hesaplanarak tarafima odendigini/odenecegini,':'Ihbar tazminati talep etme hakkimin bulunmadigini,'}</p>
<p class="madde">5. <b>Diger Haklar:</b> Bunlarin disinda sirketinizden hi√ßbir alacagimin kalmadigini,</p>
<p class="madde">beyan ve kabul ederim. Isbu ibranameyi herhangi bir baski altinda kalmaksizin, serbest iradem ile imzaliyorum.</p>
<br>
<p class="madde" style="font-size:10px;color:#666;">Not: 6098 sayili Turk Borclar Kanunu'nun 420. maddesi geregince, isbu ibraname is sozlesmesinin sona ermesinden itibaren en az bir ay sonra imzalanmalidir.</p>
${_belgeImzaAlani(pAdi)}
${_belgeFooter(belgeNo,'Ibra Belgesi')}`;
            break;

        default:
            icerik=`${_belgeHeader(sablonId,'Belge')}${_belgePersonelInfo(personel,dept)}<p>Belge icerigi bulunamadi.</p>${_belgeImzaAlani(pAdi)}`;
    }
    return icerik;
}

function printHrBelgePaketi(personelId){
    const p=(S.personeller||[]).find(x=>String(x.id)===String(personelId));
    if(!p){showNotif('Personel bulunamadi.');return;}
    // Secilen belgeleri topla
    const checkboxes=document.querySelectorAll('#belge-paketi-list input[type="checkbox"]:checked');
    const secilen=[];
    checkboxes.forEach(cb=>secilen.push(cb.value));
    if(secilen.length===0){showNotif('Lutfen en az bir belge seciniz.');return;}
    // Tum belgeleri tek HTML'de birletir
    let pages='';
    secilen.forEach((sid,idx)=>{
        const pageClass=idx>0?' class="page-break"':'';
        pages+=`<div${pageClass}>${generateHrBelgeHTML(sid,p)}</div>`;
    });
    const fullHTML=`<!DOCTYPE html><html><head><title>Belge Paketi - ${p.ad} ${p.soyad}</title><style>${BELGE_STIL}</style></head><body>${pages}</body></html>`;
    // iframe ile yazdir
    const frame=document.getElementById('print-frame');
    const doc=frame.contentDocument||frame.contentWindow.document;
    doc.open();doc.write(fullHTML);doc.close();
    setTimeout(()=>{frame.contentWindow.focus();frame.contentWindow.print();},400);
    // S.personelBelgeler'e kayit ekle
    if(!S.personelBelgeler)S.personelBelgeler=[];
    const bugun=new Date().toISOString().slice(0,10);
    secilen.forEach(sid=>{
        const sablon=HR_BELGE_SABLONLARI.find(s=>s.id===sid);
        if(!sablon)return;
        // Ayni tur belge zaten var mi kontrol et (tekrar eklemeyi onle)
        const mevcutBelge=(S.personelBelgeler||[]).find(b=>String(b.employeeId)===String(personelId)&&b.tur===sablon.tur&&b.baslik===sablon.baslik);
        if(!mevcutBelge){
            S.personelBelgeler.push({id:Date.now()+Math.random(),employeeId:String(personelId),tur:sablon.tur,baslik:sablon.baslik,dosyaUrl:null,gecerlilikTarihi:null,notlar:'Belge paketi ile olusturuldu - '+bugun});
        }
    });
    save();
    showNotif(secilen.length+' belge yazdirildi ve personel dosyasina kaydedildi.');
    closeModal('modal-belge-paketi');
    // Eger belgeler tabinda isek yenile
    if(document.getElementById('hr-tab-belgeler'))renderHrBelgeler();
}

function openBelgePaketiModal(personelId){
    const p=(S.personeller||[]).find(x=>String(x.id)===String(personelId));
    if(!p)return;
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
    let html=`<div class="mb-4">
<div class="flex items-center gap-3 mb-3">
<div class="w-10 h-10 rounded-full bg-gradient-to-br from-teal-500 to-blue-500 flex items-center justify-center text-white font-bold text-sm">${(p.ad||'?')[0]}${(p.soyad||'?')[0]}</div>
<div><p class="font-bold text-sm">${p.ad} ${p.soyad}</p><p class="text-[10px] text-gray-400">${dept?dept.ad:'-'} &middot; ${p.gorevi||'-'} &middot; Ise Giris: ${p.iseGirisTarihi||'-'}</p></div>
</div></div>
<div class="mb-3"><p class="text-xs text-gray-300 mb-2 font-medium">Olusturulacak Belgeler:</p>
<div id="belge-paketi-list" class="space-y-2">`;
    HR_BELGE_SABLONLARI.filter(s=>!s.ayrilmaBelgesi).forEach(s=>{
        html+=`<label class="flex items-center gap-2 p-2 glass rounded-lg cursor-pointer hover:bg-gray-700/30">
<input type="checkbox" value="${s.id}" checked class="w-4 h-4 rounded accent-teal-500">
<span class="text-sm">${s.icon} ${s.baslik}</span></label>`;
    });
    html+=`</div></div>
<div class="flex gap-2 mb-3">
<button onclick="document.querySelectorAll('#belge-paketi-list input').forEach(c=>c.checked=true)" class="px-3 py-1 text-[10px] glass rounded-lg text-teal-400 hover:bg-teal-600/20 border border-teal-500/20">Tumunu Sec</button>
<button onclick="document.querySelectorAll('#belge-paketi-list input').forEach(c=>c.checked=false)" class="px-3 py-1 text-[10px] glass rounded-lg text-gray-400 hover:bg-gray-600/20 border border-gray-500/20">Temizle</button>
</div>`;
    document.getElementById('belge-paketi-icerik').innerHTML=html;
    document.getElementById('belge-paketi-personel-id').value=personelId;
    openModal('modal-belge-paketi');
}

function hesaplaYillikIzinHakki(personel){
    if(!personel||!personel.iseGirisTarihi)return 14; // varsayilan
    const now=new Date();
    const giris=new Date(personel.iseGirisTarihi);
    const kidemYil=(now-giris)/(365.25*24*60*60*1000);
    if(kidemYil<1)return 0; // 1 yildan az - hak yok
    let hak=14;
    if(kidemYil>=15)hak=26;
    else if(kidemYil>=5)hak=20;
    // Yas kontrolu: 18 alti veya 50 ustu minimum 20 gun
    if(personel.dogumTarihi){
        const dogum=new Date(personel.dogumTarihi);
        const yas=(now-dogum)/(365.25*24*60*60*1000);
        if(yas<18||yas>=50)hak=Math.max(hak,20);
    }
    return hak;
}
// ===================== KIDEM / IHBAR TAZMINATI HESAPLAMA =====================
function hesaplaKidemTazminati(personel,ayrilmaTarihi){
    if(!personel||!personel.iseGirisTarihi)return{yil:0,ay:0,gun:0,tutar:0,brutMaas:0,toplamGun:0};
    const giris=new Date(personel.iseGirisTarihi);
    const cikis=new Date(ayrilmaTarihi||new Date().toISOString().slice(0,10));
    const diffMs=cikis-giris;
    if(diffMs<=0)return{yil:0,ay:0,gun:0,tutar:0,brutMaas:0,toplamGun:0};
    const toplamGun=diffMs/(24*60*60*1000);
    const yil=Math.floor(toplamGun/365.25);
    const kalanGunYil=toplamGun-(yil*365.25);
    const ay=Math.floor(kalanGunYil/30.44);
    const gun=Math.floor(kalanGunYil-(ay*30.44));
    const brutMaas=personel.maas||0;
    const tutar=yil*brutMaas+(ay/12)*brutMaas;
    return{yil,ay,gun,tutar:Math.round(tutar),brutMaas,toplamGun:Math.floor(toplamGun)};
}
function hesaplaIhbarTazminati(personel,ayrilmaTarihi){
    if(!personel||!personel.iseGirisTarihi)return{hafta:0,tutar:0,haftalikUcret:0,kidemAy:0};
    const giris=new Date(personel.iseGirisTarihi);
    const cikis=new Date(ayrilmaTarihi||new Date().toISOString().slice(0,10));
    const kidemAy=(cikis-giris)/(30.44*24*60*60*1000);
    let hafta=2;
    if(kidemAy>=36)hafta=8;
    else if(kidemAy>=18)hafta=6;
    else if(kidemAy>=6)hafta=4;
    const brutMaas=personel.maas||0;
    const haftalikUcret=Math.round(brutMaas/4.33);
    const tutar=hafta*haftalikUcret;
    return{hafta,tutar:Math.round(tutar),haftalikUcret,kidemAy:Math.round(kidemAy)};
}
// ===================== ISTEN AYRILMA FONKSIYONLARI =====================
function openIstenAyrilmaModal(id){
    const p=(S.personeller||[]).find(x=>String(x.id)===String(id));
    if(!p)return;
    if(p.durum==='ayrilmis'){showNotif('Bu personel zaten ayrilmis.');return;}
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
    const initials=((p.ad||'?')[0]+(p.soyad||'?')[0]).toUpperCase();
    const now=new Date();
    let kidemStr='-';
    if(p.iseGirisTarihi){const yil=(now-new Date(p.iseGirisTarihi))/(365.25*24*60*60*1000);kidemStr=yil>=1?yil.toFixed(1)+' yil':Math.floor(yil*12)+' ay';}
    document.getElementById('ayrilma-personel-ozet').innerHTML=`<div class="flex items-center gap-3 p-3 glass rounded-xl border border-red-500/20">
        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center text-lg font-bold text-white flex-shrink-0">${initials}</div>
        <div class="flex-1 min-w-0"><p class="font-bold text-sm">${p.ad} ${p.soyad}</p><p class="text-[10px] text-gray-400">${dept?dept.ad:'-'} &middot; ${p.gorevi||'-'}</p><p class="text-[10px] text-gray-500">Ise Giris: ${p.iseGirisTarihi||'-'} &middot; Kidem: ${kidemStr} &middot; Maas: ${p.maas?p.maas.toLocaleString('tr-TR')+' TL':'-'}</p></div>
    </div>`;
    document.getElementById('ayrilma-personel-id').value=id;
    document.getElementById('ayrilma-tarihi').value=new Date().toISOString().slice(0,10);
    document.getElementById('ayrilma-nedeni').value='';
    document.getElementById('ayrilma-aciklama').value='';
    document.getElementById('ayrilma-kidem-hak').checked=false;
    document.getElementById('ayrilma-ihbar-hak').checked=false;
    document.getElementById('ayrilma-hesaplama').style.display='none';
    // Aktif zimmet uyarisi
    const activeZimmetler=(S.zimmetler||[]).filter(z=>(z.personelId&&String(z.personelId)===String(id)||(!z.personelId&&z.zimmetliKisi===(p.ad+' '+p.soyad)))&&z.durum==='aktif');
    if(activeZimmetler.length>0){
        const zimList=activeZimmetler.map(z=>{const item=(S.envanter||[]).find(i=>i.id===z.envanterItemId);return item?item.ad:'Bilinmeyen';}).join(', ');
        document.getElementById('ayrilma-personel-ozet').innerHTML+=`<div class="mt-2 p-2 glass rounded-lg border border-amber-500/30 bg-amber-500/5"><p class="text-xs text-amber-400 font-bold">&#9888; Dikkat: ${activeZimmetler.length} aktif zimmet var!</p><p class="text-[10px] text-gray-400">Isten ayrilma oncesi zimmetlerin iade edilmesi gerekir: ${zimList}</p></div>`;
    }
    openModal('modal-isten-ayrilma');
}
function updateAyrilmaHesaplama(){
    const id=document.getElementById('ayrilma-personel-id').value;
    const p=(S.personeller||[]).find(x=>String(x.id)===String(id));
    if(!p)return;
    const ayrilmaTarihi=document.getElementById('ayrilma-tarihi').value;
    const kidemHak=document.getElementById('ayrilma-kidem-hak').checked;
    const ihbarHak=document.getElementById('ayrilma-ihbar-hak').checked;
    const panel=document.getElementById('ayrilma-hesaplama');
    if(!kidemHak&&!ihbarHak){panel.style.display='none';return;}
    panel.style.display='block';
    let html='<h4 class="text-[11px] font-bold text-red-400 mb-3 uppercase tracking-wider">Tazminat Hesaplama (Tahmini)</h4>';
    if(kidemHak){
        const k=hesaplaKidemTazminati(p,ayrilmaTarihi);
        html+=`<div class="glass rounded-lg p-3 mb-2 border border-red-500/10"><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Kidem Suresi</span><span class="font-medium">${k.yil} yil ${k.ay} ay ${k.gun} gun</span></div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Son Brut Maas</span><span class="font-medium">${k.brutMaas.toLocaleString('tr-TR')} TL</span></div><div class="flex justify-between text-xs"><span class="text-gray-400 font-bold">Kidem Tazminati (Tahmini)</span><span class="font-bold text-red-400">${k.tutar.toLocaleString('tr-TR')} TL</span></div></div>`;
    }
    if(ihbarHak){
        const ih=hesaplaIhbarTazminati(p,ayrilmaTarihi);
        html+=`<div class="glass rounded-lg p-3 mb-2 border border-orange-500/10"><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Kidem (ay)</span><span class="font-medium">${ih.kidemAy} ay</span></div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Ihbar Suresi (Is Kanunu Md.17)</span><span class="font-medium">${ih.hafta} hafta</span></div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Haftalik Ucret</span><span class="font-medium">${ih.haftalikUcret.toLocaleString('tr-TR')} TL</span></div><div class="flex justify-between text-xs"><span class="text-gray-400 font-bold">Ihbar Tazminati (Tahmini)</span><span class="font-bold text-orange-400">${ih.tutar.toLocaleString('tr-TR')} TL</span></div></div>`;
    }
    html+='<p class="text-[9px] text-gray-500 mt-2 italic">* Bu hesaplamalar tahminidir, kesin bordro hesaplamasini temsil etmez.</p>';
    panel.innerHTML=html;
}
function tamamlaIstenAyrilma(){
    const id=document.getElementById('ayrilma-personel-id').value;
    const ayrilmaTarihi=document.getElementById('ayrilma-tarihi').value;
    const ayrilmaNedeni=document.getElementById('ayrilma-nedeni').value;
    const aciklama=document.getElementById('ayrilma-aciklama').value.trim();
    if(!ayrilmaTarihi){showNotif('Ayrilma tarihi zorunludur.');return;}
    if(!ayrilmaNedeni){showNotif('Ayrilma nedeni seciniz.');return;}
    if(!confirm('Bu personelin isten ayrilma islemini tamamlamak istediginize emin misiniz?'))return;
    const idx=(S.personeller||[]).findIndex(p=>String(p.id)===String(id));
    if(idx<0){showNotif('Personel bulunamadi.');return;}
    const p=S.personeller[idx];
    p.durum='ayrilmis';
    p.ayrilmaTarihi=ayrilmaTarihi;
    p.ayrilmaNedeni=ayrilmaNedeni;
    p.ayrilmaAciklama=aciklama||null;
    p.kidemTazminatiHakEder=document.getElementById('ayrilma-kidem-hak').checked;
    p.ihbarTazminatiHakEder=document.getElementById('ayrilma-ihbar-hak').checked;
    if(p.kidemTazminatiHakEder)p.kidemTazminatiTutar=hesaplaKidemTazminati(p,ayrilmaTarihi).tutar;
    if(p.ihbarTazminatiHakEder)p.ihbarTazminatiTutar=hesaplaIhbarTazminati(p,ayrilmaTarihi).tutar;
    save();
    closeModal('modal-isten-ayrilma');
    renderHrPersoneller();
    showNotif(p.ad+' '+p.soyad+' isten ayrildi. Ayrilma belgeleri hazirlaniyor...');
    act('Isten ayrilma: '+p.ad+' '+p.soyad+' ('+(AYRILMA_NEDENLERI[ayrilmaNedeni]||ayrilmaNedeni)+')');
    setTimeout(()=>openAyrilmaBelgePaketiModal(id),500);
}
function openAyrilmaBelgePaketiModal(personelId){
    const p=(S.personeller||[]).find(x=>String(x.id)===String(personelId));
    if(!p)return;
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
    let html=`<div class="mb-4"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center text-white font-bold text-sm">${(p.ad||'?')[0]}${(p.soyad||'?')[0]}</div><div><p class="font-bold text-sm">${p.ad} ${p.soyad}</p><p class="text-[10px] text-gray-400">${dept?dept.ad:'-'} &middot; ${p.gorevi||'-'} &middot; Ayrilma: ${p.ayrilmaTarihi||'-'} &middot; Neden: ${AYRILMA_NEDENLERI[p.ayrilmaNedeni]||'-'}</p></div></div></div>
<div class="mb-3"><p class="text-xs text-red-400 mb-2 font-medium">Ayrilma Belgeleri:</p><div id="belge-paketi-list" class="space-y-2">`;
    HR_BELGE_SABLONLARI.filter(s=>s.ayrilmaBelgesi).forEach(s=>{
        html+=`<label class="flex items-center gap-2 p-2 glass rounded-lg cursor-pointer hover:bg-gray-700/30"><input type="checkbox" value="${s.id}" checked class="w-4 h-4 rounded accent-red-500"><span class="text-sm">${s.icon} ${s.baslik}</span></label>`;
    });
    html+=`</div></div><div class="flex gap-2 mb-3"><button onclick="document.querySelectorAll('#belge-paketi-list input').forEach(c=>c.checked=true)" class="px-3 py-1 text-[10px] glass rounded-lg text-red-400 hover:bg-red-600/20 border border-red-500/20">Tumunu Sec</button><button onclick="document.querySelectorAll('#belge-paketi-list input').forEach(c=>c.checked=false)" class="px-3 py-1 text-[10px] glass rounded-lg text-gray-400 hover:bg-gray-600/20 border border-gray-500/20">Temizle</button></div>`;
    document.getElementById('belge-paketi-icerik').innerHTML=html;
    document.getElementById('belge-paketi-personel-id').value=personelId;
    openModal('modal-belge-paketi');
}
function switchHrTab(tab){
    ['personeller','departmanlar','izinler','belgeler','ozet','puantaj'].forEach(t=>{
        const el=document.getElementById('hr-tab-'+t);if(el)el.classList.add('hidden');
    });
    const active=document.getElementById('hr-tab-'+tab);if(active)active.classList.remove('hidden');
    const btns=document.querySelectorAll('#module-hr .tab-btn');
    btns.forEach((b,i)=>{b.classList.remove('active');if(b.textContent.toLowerCase().includes(tab.substring(0,4)))b.classList.add('active');});
    const addBtn=document.getElementById('hr-add-btn');
    if(tab==='personeller'){addBtn.textContent='+ Yeni Personel';addBtn.onclick=()=>openPersonelForm();}
    else if(tab==='departmanlar'){addBtn.textContent='+ Yeni Departman';addBtn.onclick=()=>openDepartmanForm();}
    else if(tab==='izinler'){addBtn.textContent='+ Izin Talebi';addBtn.onclick=()=>openIzinForm();}
    else if(tab==='belgeler'){addBtn.textContent='+ Belge Ekle';addBtn.onclick=()=>openPersonelBelgeForm();}
    else if(tab==='puantaj'){addBtn.textContent='+ Manuel Kayit';addBtn.onclick=()=>openPuantajForm();}
    else{addBtn.textContent='';addBtn.onclick=null;}
    if(tab==='personeller')renderHrPersoneller();
    else if(tab==='departmanlar')renderHrDepartmanlar();
    else if(tab==='izinler')renderHrIzinler();
    else if(tab==='belgeler')renderHrBelgeler();
    else if(tab==='ozet')renderHrOzet();
    else if(tab==='puantaj')renderHrPuantaj();
}
function renderHrModule(){
    renderHrPersoneller();
    const badge=document.getElementById('hr-badge');
    if(badge)badge.textContent=(S.personeller||[]).filter(p=>p.durum==='aktif').length;
}
function renderHrPersoneller(){
    const c=document.getElementById('hr-tab-personeller');if(!c)return;
    const personeller=S.personeller||[];
    const aktif=personeller.filter(p=>p.durum==='aktif');
    const izinli=personeller.filter(p=>p.durum==='izinli');
    const ayrilmis=personeller.filter(p=>p.durum==='ayrilmis');
    let html=`<div class="flex flex-wrap gap-2 mb-3">
        <button onclick="openImportModal('personeller','Personel Excel Import')" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-teal-600/20 text-teal-400 border border-teal-500/20">&#128228; Excel'den Aktar</button>
        <button onclick="openTopluZimmetForm()" class="px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-amber-600/20 text-amber-400 border border-amber-500/20">&#128188; Personel Giris Paketi</button>
    </div>`;
    const engelliSayi=personeller.filter(p=>p.engelDurumu==='var'&&p.durum==='aktif').length;
    const emekliSayi=personeller.filter(p=>p.emekliDurumu==='emekli'&&p.durum==='aktif').length;
    html+=`<div class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Toplam</p><p class="text-xl font-bold text-white">${personeller.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Aktif</p><p class="text-xl font-bold text-green-400">${aktif.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Izinli</p><p class="text-xl font-bold text-amber-400">${izinli.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Ayrilmis</p><p class="text-xl font-bold text-red-400">${ayrilmis.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Engelli</p><p class="text-xl font-bold text-purple-400">${engelliSayi}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Emekli</p><p class="text-xl font-bold text-amber-300">${emekliSayi}</p></div>
    </div>`;
    if(personeller.length===0){html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Henuz personel kaydi yok.</p><button onclick="openPersonelForm()" class="mt-2 px-4 py-2 bg-teal-600 hover:bg-teal-700 rounded-lg text-xs">+ Ilk Personeli Ekle</button></div>';c.innerHTML=html;return;}
    html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Ad Soyad</th><th class="p-2">Departman</th><th class="p-2">Gorev</th><th class="p-2">Telefon</th><th class="p-2">Ise Giris</th><th class="p-2">Durum</th><th class="p-2">Islem</th></tr></thead><tbody>`;
    personeller.forEach(p=>{
        const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
        const durumCol=p.durum==='aktif'?'bg-green-500/20 text-green-400':p.durum==='izinli'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400';
        const durumL=p.durum==='aktif'?'Aktif':p.durum==='izinli'?'Izinli':'Ayrilmis';
        html+=`<tr class="border-b border-gray-800 hover:bg-gray-800/30 cursor-pointer" onclick="openPersonelDetay('${p.id}')">
            <td class="p-2 font-medium">${p.ad} ${p.soyad}${p.engelDurumu==='var'?' <span class="text-[8px] px-1 py-0.5 rounded bg-purple-500/20 text-purple-400" title="Engelli Personel - %'+(p.engelBilgileri?p.engelBilgileri.oran:'')+'">‚ôø</span>':''}${p.emekliDurumu==='emekli'?' <span class="text-[8px] px-1 py-0.5 rounded bg-amber-500/20 text-amber-400" title="Emekli">üèñÔ∏è</span>':''}</td>
            <td class="p-2 text-gray-400">${dept?dept.ad:'-'}</td>
            <td class="p-2 text-gray-400">${p.gorevi||'-'}</td>
            <td class="p-2 text-gray-400">${p.telefonKisisel||p.telefonIs||'-'}</td>
            <td class="p-2 text-gray-400">${p.iseGirisTarihi||'-'}</td>
            <td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${durumCol}">${durumL}</span></td>
            <td class="p-2"><button onclick="event.stopPropagation();openPersonelForm('${p.id}')" class="text-blue-400 hover:text-blue-300 text-[10px] mr-1">Duzenle</button>${(p.durum==='aktif'||p.durum==='izinli')?`<button onclick="event.stopPropagation();openIstenAyrilmaModal('${p.id}')" class="text-orange-400 hover:text-orange-300 text-[10px] mr-1" title="Isten Ayrilma">&#128683;</button>`:''}<button onclick="event.stopPropagation();openBelgePaketiModal('${p.id}')" class="text-teal-400 hover:text-teal-300 text-[10px] mr-1" title="Belge Paketi">&#128196;</button><button onclick="event.stopPropagation();deletePersonel('${p.id}')" class="text-red-400 hover:text-red-300 text-[10px]">Sil</button></td>
        </tr>`;
    });
    html+=`</tbody></table></div>`;
    c.innerHTML=html;
}
function renderHrDepartmanlar(){
    const c=document.getElementById('hr-tab-departmanlar');if(!c)return;
    const deps=S.departmanlar||[];
    let html='<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">';
    deps.forEach(d=>{
        const count=(S.personeller||[]).filter(p=>String(p.departmanId)===String(d.id)&&p.durum==='aktif').length;
        const yonetici=(S.personeller||[]).find(p=>String(p.id)===String(d.yoneticiId));
        html+=`<div class="glass rounded-xl p-4">
            <div class="flex items-center justify-between mb-2"><h4 class="font-bold text-sm">${d.ad}</h4><span class="text-[10px] px-2 py-0.5 rounded ${d.aktif?'bg-green-500/20 text-green-400':'bg-gray-500/20 text-gray-400'}">${d.aktif?'Aktif':'Pasif'}</span></div>
            <p class="text-[10px] text-gray-500 mb-2">${d.kod||'-'} &middot; ${d.aciklama||''}</p>
            <div class="flex items-center justify-between"><span class="text-xs text-gray-400">${count} calisan${yonetici?' &middot; Ynt: '+yonetici.ad+' '+yonetici.soyad+(yonetici.gorevi?' <span class=\\"text-teal-400\\">('+yonetici.gorevi+')</span>':''):''}</span>
            <div class="flex gap-1"><button onclick="openDepartmanForm('${d.id}')" class="text-blue-400 hover:text-blue-300 text-[10px]">Duzenle</button><button onclick="deleteDepartman('${d.id}')" class="text-red-400 hover:text-red-300 text-[10px]">Sil</button></div></div></div>`;
    });
    html+='</div>';
    c.innerHTML=html;
}
function renderHrIzinler(){
    const c=document.getElementById('hr-tab-izinler');if(!c)return;
    const izinler=S.izinler||[];
    const bekleyen=izinler.filter(i=>i.durum==='beklemede');
    const buYil=new Date().getFullYear();
    const ucretliSayi=izinler.filter(i=>i.durum==='onaylandi'&&UCRETLI_IZIN_TURLERI.includes(i.izinTuru)).length;
    const ucretsizSayi=izinler.filter(i=>i.durum==='onaylandi'&&UCRETSIZ_IZIN_TURLERI.includes(i.izinTuru)).length;
    let html=`<div class="grid grid-cols-4 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Toplam Izin</p><p class="text-xl font-bold text-white">${izinler.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Onay Bekleyen</p><p class="text-xl font-bold text-amber-400">${bekleyen.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Ucretli Izin</p><p class="text-xl font-bold text-green-400">${ucretliSayi}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Ucretsiz Izin</p><p class="text-xl font-bold text-gray-400">${ucretsizSayi}</p></div>
    </div>`;
    if(izinler.length===0){html+='<p class="text-center text-gray-500 text-sm py-8">Henuz izin kaydi yok.</p>';}
    else{
        html+=`<div class="overflow-x-auto mb-4"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Personel</th><th class="p-2">Izin Turu</th><th class="p-2">Ucret</th><th class="p-2">Tarihler</th><th class="p-2 text-center">Gun</th><th class="p-2">Durum</th><th class="p-2">Islem</th></tr></thead><tbody>`;
        const IZIN_LABELS={yillik:'Yillik',hastalik:'Hastalik',mazeret:'Mazeret',dogum:'Dogum',ucretsiz:'Ucretsiz',evlilik:'Evlilik',olum:'Olum'};
        const izinBadgeColors={yillik:'bg-teal-500/20 text-teal-400',hastalik:'bg-red-500/20 text-red-400',mazeret:'bg-amber-500/20 text-amber-400',dogum:'bg-pink-500/20 text-pink-400',ucretsiz:'bg-gray-500/20 text-gray-400',evlilik:'bg-purple-500/20 text-purple-400',olum:'bg-gray-600/20 text-gray-300'};
        izinler.forEach(iz=>{
            const emp=(S.personeller||[]).find(p=>String(p.id)===String(iz.employeeId));
            const durumCol=iz.durum==='onaylandi'?'bg-green-500/20 text-green-400':iz.durum==='beklemede'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400';
            const durumL=iz.durum==='onaylandi'?'Onaylandi':iz.durum==='beklemede'?'Beklemede':'Reddedildi';
            const badge=izinBadgeColors[iz.izinTuru]||'bg-gray-500/20 text-gray-400';
            const isUcretli=UCRETLI_IZIN_TURLERI.includes(iz.izinTuru)||iz.izinTuru==='hastalik'||iz.izinTuru==='mazeret';
            const ucretBadge=isUcretli?'<span class="px-1 py-0.5 rounded text-[8px] bg-green-500/20 text-green-400">Ucretli</span>':'<span class="px-1 py-0.5 rounded text-[8px] bg-gray-500/20 text-gray-400">Ucretsiz</span>';
            let actions='';
            if(iz.durum==='beklemede')actions=`<button onclick="approveIzin('${iz.id}')" class="text-green-400 hover:text-green-300 text-[10px] mr-1">Onayla</button><button onclick="rejectIzin('${iz.id}')" class="text-red-400 hover:text-red-300 text-[10px]">Reddet</button>`;
            html+=`<tr class="border-b border-gray-800"><td class="p-2 font-medium">${emp?emp.ad+' '+emp.soyad:'?'}</td><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${badge}">${IZIN_LABELS[iz.izinTuru]||iz.izinTuru}</span></td><td class="p-2">${ucretBadge}</td><td class="p-2 text-gray-400">${iz.basTarihi} - ${iz.bitTarihi}</td><td class="p-2 text-center">${iz.gunSayisi}</td><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[9px] ${durumCol}">${durumL}</span></td><td class="p-2">${actions}</td></tr>`;
        });
        html+=`</tbody></table></div>`;
    }
    // Izin Bakiyeleri bolumu - kidem bazli dinamik hak
    const aktifPersoneller=(S.personeller||[]).filter(p=>p.durum==='aktif');
    if(aktifPersoneller.length>0){
        html+=`<div class="border-t border-gray-700 pt-4 mt-2"><h4 class="text-sm font-bold text-teal-400 mb-3">&#127796; Yillik Izin Bakiyeleri (${buYil}) <span class="text-[10px] text-gray-500 font-normal ml-2">Is Kanunu Md.53 - Kidem bazli</span></h4>`;
        html+=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Personel</th><th class="p-2">Departman</th><th class="p-2 text-center">Kidem</th><th class="p-2 text-center">Hak</th><th class="p-2 text-center">Kullanilan</th><th class="p-2 text-center">Kalan</th><th class="p-2 w-32">Durum</th></tr></thead><tbody>`;
        aktifPersoneller.forEach(p=>{
            const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
            const hakGun=hesaplaYillikIzinHakki(p);
            const kidemYil=p.iseGirisTarihi?((new Date()-new Date(p.iseGirisTarihi))/(365.25*24*60*60*1000)):0;
            const kidemStr=kidemYil>=1?kidemYil.toFixed(1)+' yil':kidemYil>0?(kidemYil*12).toFixed(0)+' ay':'-';
            const kullanilan=(izinler||[]).filter(i=>String(i.employeeId)===String(p.id)&&i.durum==='onaylandi'&&i.izinTuru==='yillik'&&i.basTarihi&&i.basTarihi.startsWith(String(buYil))).reduce((s,i)=>s+(i.gunSayisi||0),0);
            const kalan=hakGun-kullanilan;
            const pct=hakGun>0?Math.max(0,Math.round(kalan/hakGun*100)):0;
            const barColor=hakGun===0?'bg-gray-600':kalan<=3?'bg-red-500':kalan<=7?'bg-amber-500':'bg-teal-500';
            const kalanClass=hakGun===0?'text-gray-500':kalan<=3?'text-red-400 font-bold':kalan<=7?'text-amber-400':'text-green-400';
            const hakNote=hakGun===0?'<span class="text-[8px] text-gray-500 block">1 yil dolmadi</span>':'';
            html+=`<tr class="border-b border-gray-800"><td class="p-2 font-medium">${p.ad} ${p.soyad}</td><td class="p-2 text-gray-400">${dept?dept.ad:'-'}</td><td class="p-2 text-center text-gray-400">${kidemStr}</td><td class="p-2 text-center">${hakGun}${hakNote}</td><td class="p-2 text-center">${kullanilan}</td><td class="p-2 text-center ${kalanClass}">${kalan}</td><td class="p-2"><div class="flex items-center gap-2"><div class="flex-1 bg-gray-800 rounded-full h-2"><div class="${barColor} h-2 rounded-full transition-all" style="width:${pct}%"></div></div><span class="text-[9px] text-gray-500 w-8 text-right">${pct}%</span></div></td></tr>`;
        });
        html+=`</tbody></table></div></div>`;
    }
    c.innerHTML=html;
}
function renderHrBelgeler(){
    const c=document.getElementById('hr-tab-belgeler');if(!c)return;
    const belgeler=S.personelBelgeler||[];
    if(belgeler.length===0){c.innerHTML='<p class="text-center text-gray-500 text-sm py-8">Henuz belge yok.</p>';return;}
    const BELGE_LABELS={sozlesme:'Is Sozlesmesi',diploma:'Diploma',sertifika:'Sertifika',saglik_raporu:'Saglik Raporu',ikametgah:'Ikametgah',nufus_cuzdani:'Nufus Cuzdani',ehliyet:'Ehliyet',diger:'Diger',kvkk:'KVKK Aydinlatma',gizlilik:'Gizlilik Sozlesmesi',isg:'ISG Egitim',etik:'Etik Taahhutname',zimmet_tutanagi:'Zimmet Tutanagi',ayrilma:'Isten Ayrilma Bildirimi',deneyim:'Is Deneyim Belgesi',zimmet_iade:'Zimmet Iade',ibra:'Ibra Belgesi'};
    let html=`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-2">Personel</th><th class="p-2">Belge Turu</th><th class="p-2">Baslik</th><th class="p-2">Gecerlilik</th><th class="p-2">Notlar</th></tr></thead><tbody>`;
    belgeler.forEach(b=>{
        const emp=(S.personeller||[]).find(p=>String(p.id)===String(b.employeeId));
        html+=`<tr class="border-b border-gray-800"><td class="p-2 font-medium">${emp?emp.ad+' '+emp.soyad:'?'}</td><td class="p-2">${BELGE_LABELS[b.tur]||b.tur}</td><td class="p-2">${b.baslik}</td><td class="p-2 text-gray-400">${b.gecerlilikTarihi||'-'}</td><td class="p-2 text-gray-500">${b.notlar||'-'}</td></tr>`;
    });
    html+=`</tbody></table></div>`;
    c.innerHTML=html;
}
function renderHrOzet(){
    const c=document.getElementById('hr-tab-ozet');if(!c)return;
    const personeller=S.personeller||[];
    const deps=S.departmanlar||[];
    const izinler=S.izinler||[];
    const aktif=personeller.filter(p=>p.durum==='aktif');
    const izinli=personeller.filter(p=>p.durum==='izinli');
    const ayrilmis=personeller.filter(p=>p.durum==='ayrilmis');
    // Ort. kidem hesapla
    const now=new Date();
    let toplamKidem=0;let kidemSayac=0;
    aktif.forEach(p=>{if(p.iseGirisTarihi){const diff=(now-new Date(p.iseGirisTarihi))/(365.25*24*60*60*1000);toplamKidem+=diff;kidemSayac++;}});
    const ortKidem=kidemSayac>0?(toplamKidem/kidemSayac).toFixed(1):'?';
    // Bu yil ayrilan
    const buYilOzet=new Date().getFullYear();
    const buYilAyrilan=ayrilmis.filter(p=>p.ayrilmaTarihi&&p.ayrilmaTarihi.startsWith(String(buYilOzet))).length;
    // Ust satir - 6 ozet kart
    let html=`<div class="grid grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Toplam Personel</p><p class="text-xl font-bold text-white">${personeller.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Aktif</p><p class="text-xl font-bold text-green-400">${aktif.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Izinli</p><p class="text-xl font-bold text-amber-400">${izinli.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Ayrilmis</p><p class="text-xl font-bold text-red-400">${ayrilmis.length}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Bu Yil Ayrilan</p><p class="text-xl font-bold text-orange-400">${buYilAyrilan}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Ort. Kidem</p><p class="text-xl font-bold text-teal-400">${ortKidem} <span class="text-[10px] font-normal">yil</span></p></div>
    </div>`;
    // Alt grid - 6 detay karti
    // 1. Departman Dagilimi
    const deptColors=['bg-teal-500','bg-blue-500','bg-purple-500','bg-pink-500','bg-amber-500','bg-emerald-500','bg-cyan-500','bg-rose-500'];
    let deptHtml='';
    deps.forEach((d,di)=>{
        const count=personeller.filter(p=>String(p.departmanId)===String(d.id)&&p.durum==='aktif').length;
        const pct=aktif.length>0?Math.round(count/aktif.length*100):0;
        const color=deptColors[di%deptColors.length];
        deptHtml+=`<div class="flex items-center gap-2 mb-1.5"><span class="text-[11px] w-28 truncate">${d.ad}</span><div class="flex-1 bg-gray-800 rounded-full h-4"><div class="${color} h-4 rounded-full flex items-center justify-end pr-1 transition-all" style="width:${Math.max(pct,8)}%"><span class="text-[8px] text-white font-medium">${count}</span></div></div><span class="text-[10px] text-gray-500 w-8 text-right">${pct}%</span></div>`;
    });
    // 2. Calisma Tipleri
    const tipSayilari={tam_zamanli:0,yari_zamanli:0,sozlesmeli:0,stajyer:0};
    aktif.forEach(p=>{if(tipSayilari[p.calismaTipi]!==undefined)tipSayilari[p.calismaTipi]++;});
    const tipLabels={tam_zamanli:'Tam Zamanli',yari_zamanli:'Yari Zamanli',sozlesmeli:'Sozlesmeli',stajyer:'Stajyer'};
    const tipColors={tam_zamanli:'text-teal-400',yari_zamanli:'text-blue-400',sozlesmeli:'text-purple-400',stajyer:'text-amber-400'};
    // 3. Cinsiyet Dagilimi
    let erkek=0,kadin=0,belirtilmemis=0;
    personeller.forEach(p=>{if(p.cinsiyet==='erkek')erkek++;else if(p.cinsiyet==='kadin')kadin++;else belirtilmemis++;});
    const cinsiyetTotal=erkek+kadin+belirtilmemis||1;
    // 4. Son Katilimlar
    const sonKatilanlar=[...personeller].filter(p=>p.iseGirisTarihi).sort((a,b)=>(b.iseGirisTarihi||'').localeCompare(a.iseGirisTarihi||'')).slice(0,5);
    // 5. Izin Bakiye Ozeti - kidem bazli dinamik hak
    const buYil=new Date().getFullYear();
    let toplamKalan=0;let enAzIzinKalanlar=[];
    aktif.forEach(p=>{
        const hakGun=hesaplaYillikIzinHakki(p);
        const kullanilan=(izinler||[]).filter(i=>String(i.employeeId)===String(p.id)&&i.durum==='onaylandi'&&i.izinTuru==='yillik'&&i.basTarihi&&i.basTarihi.startsWith(String(buYil))).reduce((s,i)=>s+(i.gunSayisi||0),0);
        const kalan=hakGun-kullanilan;
        toplamKalan+=kalan;
        enAzIzinKalanlar.push({ad:p.ad+' '+p.soyad,kalan,kullanilan,hakGun});
    });
    enAzIzinKalanlar.sort((a,b)=>a.kalan-b.kalan);
    const ortKalanIzin=aktif.length>0?(toplamKalan/aktif.length).toFixed(1):'?';
    // 6. Son Izin Talepleri
    const IZIN_LABELS={yillik:'Yillik',hastalik:'Hastalik',mazeret:'Mazeret',dogum:'Dogum',ucretsiz:'Ucretsiz',evlilik:'Evlilik',olum:'Olum'};
    const izinBadgeColors={yillik:'bg-teal-500/20 text-teal-400',hastalik:'bg-red-500/20 text-red-400',mazeret:'bg-amber-500/20 text-amber-400',dogum:'bg-pink-500/20 text-pink-400',ucretsiz:'bg-gray-500/20 text-gray-400',evlilik:'bg-purple-500/20 text-purple-400',olum:'bg-gray-600/20 text-gray-300'};
    const sonIzinler=izinler.slice(-5).reverse();
    html+=`<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">`;
    // Kart 1: Departman Dagilimi
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#127970; Departman Dagilimi</h4>${deptHtml||'<p class="text-xs text-gray-500">Veri yok</p>'}</div>`;
    // Kart 2: Calisma Tipleri
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#128188; Calisma Tipleri</h4><div class="space-y-2">`;
    Object.keys(tipSayilari).forEach(k=>{
        const pct=aktif.length>0?Math.round(tipSayilari[k]/aktif.length*100):0;
        html+=`<div class="flex justify-between items-center text-xs"><span>${tipLabels[k]}</span><div class="flex items-center gap-2"><div class="w-16 bg-gray-800 rounded-full h-2"><div class="bg-teal-500 h-2 rounded-full" style="width:${pct}%"></div></div><span class="font-bold ${tipColors[k]} w-6 text-right">${tipSayilari[k]}</span></div></div>`;
    });
    html+=`</div></div>`;
    // Kart 3: Cinsiyet Dagilimi
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#128101; Cinsiyet Dagilimi</h4>
        <div class="flex gap-1 mb-3 h-6 rounded-full overflow-hidden">
            <div class="bg-blue-500 flex items-center justify-center" style="width:${Math.round(erkek/cinsiyetTotal*100)}%"><span class="text-[8px] text-white font-medium">${erkek>0?erkek:''}</span></div>
            <div class="bg-pink-500 flex items-center justify-center" style="width:${Math.round(kadin/cinsiyetTotal*100)}%"><span class="text-[8px] text-white font-medium">${kadin>0?kadin:''}</span></div>
            <div class="bg-gray-500 flex items-center justify-center" style="width:${Math.round(belirtilmemis/cinsiyetTotal*100)}%"><span class="text-[8px] text-white font-medium">${belirtilmemis>0?belirtilmemis:''}</span></div>
        </div>
        <div class="space-y-1.5">
            <div class="flex justify-between text-xs"><span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-blue-500 inline-block"></span>Erkek</span><span class="font-bold">${erkek}</span></div>
            <div class="flex justify-between text-xs"><span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-pink-500 inline-block"></span>Kadin</span><span class="font-bold">${kadin}</span></div>
            <div class="flex justify-between text-xs"><span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-gray-500 inline-block"></span>Belirtilmemis</span><span class="font-bold">${belirtilmemis}</span></div>
        </div></div>`;
    // Kart 4: Son Katilimlar
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#128587; Son Katilimlar</h4>`;
    if(sonKatilanlar.length===0)html+='<p class="text-xs text-gray-500">Henuz personel yok</p>';
    else sonKatilanlar.forEach(p=>{
        const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
        const kidem=p.iseGirisTarihi?((now-new Date(p.iseGirisTarihi))/(30*24*60*60*1000)).toFixed(0)+'ay':'';
        html+=`<div class="flex items-center justify-between text-[11px] mb-1.5 p-1.5 rounded hover:bg-gray-800/30"><div><span class="font-medium">${p.ad} ${p.soyad}</span><span class="text-gray-500 ml-1.5">${dept?dept.ad:''}</span></div><span class="text-gray-400">${p.iseGirisTarihi||'?'}</span></div>`;
    });
    html+=`</div>`;
    // Kart 5: Izin Bakiye Ozeti
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#127796; Izin Bakiye Ozeti</h4>
        <div class="flex justify-between text-xs mb-3"><span class="text-gray-400">Ort. Kalan Izin:</span><span class="font-bold text-teal-400">${ortKalanIzin} gun</span></div>
        <p class="text-[9px] text-gray-500 mb-1.5">En az izni kalanlar:</p>`;
    enAzIzinKalanlar.slice(0,3).forEach(p=>{
        const pct=p.hakGun>0?Math.max(0,Math.round(p.kalan/p.hakGun*100)):0;
        const renk=p.hakGun===0?'bg-gray-600':p.kalan<=3?'bg-red-500':'bg-teal-500';
        html+=`<div class="mb-1.5"><div class="flex justify-between text-[10px] mb-0.5"><span class="truncate">${p.ad}</span><span class="${p.kalan<=3?'text-red-400 font-bold':'text-gray-400'}">${p.kalan}/${p.hakGun}g</span></div><div class="w-full bg-gray-800 rounded-full h-1.5"><div class="${renk} h-1.5 rounded-full" style="width:${pct}%"></div></div></div>`;
    });
    html+=`</div>`;
    // Kart 6: Son Izin Talepleri
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-teal-400">&#128197; Son Izin Talepleri</h4>`;
    if(sonIzinler.length===0)html+='<p class="text-xs text-gray-500">Henuz izin talebi yok</p>';
    else sonIzinler.forEach(iz=>{
        const emp=(S.personeller||[]).find(p=>String(p.id)===String(iz.employeeId));
        const badge=izinBadgeColors[iz.izinTuru]||'bg-gray-500/20 text-gray-400';
        html+=`<div class="flex items-center justify-between text-[11px] mb-1.5"><span class="font-medium">${emp?emp.ad+' '+emp.soyad:'?'}</span><span class="px-1.5 py-0.5 rounded text-[8px] ${badge}">${IZIN_LABELS[iz.izinTuru]||iz.izinTuru}</span><span class="text-gray-500">${iz.basTarihi} (${iz.gunSayisi}g)</span></div>`;
    });
    html+=`</div>`;
    // Kart 7: Ayrilma Nedeni Dagilimi
    html+=`<div class="glass rounded-xl p-4"><h4 class="text-sm font-bold mb-3 text-red-400">&#128683; Ayrilma Nedeni Dagilimi</h4>`;
    if(ayrilmis.length===0){html+='<p class="text-xs text-gray-500">Henuz ayrilan personel yok</p>';}
    else{
        const nedenSayilari={};ayrilmis.forEach(p=>{const n=p.ayrilmaNedeni||'diger';nedenSayilari[n]=(nedenSayilari[n]||0)+1;});
        const nedenColors={istifa:'text-red-400',isverenFesih:'text-orange-400',karsilikliAnlasma:'text-yellow-400',emeklilik:'text-green-400',askereGidis:'text-blue-400',vefat:'text-gray-400',sozlesmeSonu:'text-purple-400',diger:'text-gray-500'};
        const barColors={istifa:'bg-red-500',isverenFesih:'bg-orange-500',karsilikliAnlasma:'bg-yellow-500',emeklilik:'bg-green-500',askereGidis:'bg-blue-500',vefat:'bg-gray-500',sozlesmeSonu:'bg-purple-500',diger:'bg-gray-600'};
        html+='<div class="space-y-2">';
        Object.keys(nedenSayilari).forEach(k=>{
            const pct=Math.round(nedenSayilari[k]/ayrilmis.length*100);
            html+=`<div class="flex justify-between items-center text-xs"><span class="${nedenColors[k]||'text-gray-400'}">${AYRILMA_NEDENLERI[k]||k}</span><div class="flex items-center gap-2"><div class="w-20 bg-gray-800 rounded-full h-2"><div class="${barColors[k]||'bg-gray-500'} h-2 rounded-full" style="width:${pct}%"></div></div><span class="font-bold w-6 text-right">${nedenSayilari[k]}</span></div></div>`;
        });
        html+='</div>';
    }
    html+=`</div>`;
    // Kart 8: Sistem Kullanim Skoru
    const skLogs=(S.sistemKullanimLog||[]);
    const buAyKullanim=skLogs.filter(l=>l.timestamp&&l.timestamp.startsWith(new Date().toISOString().slice(0,7)));
    html+=`<div class="glass rounded-xl p-4 col-span-full border border-purple-500/20"><h4 class="text-sm font-bold mb-3 text-purple-400">&#128200; Sistem Kullanim Skoru (Bu Ay)</h4>`;
    if(buAyKullanim.length===0){html+='<p class="text-xs text-gray-500">Bu ay henuz kullanim verisi yok</p>';}
    else{
        const userActs={};buAyKullanim.forEach(l=>{userActs[l.userName]=(userActs[l.userName]||0)+1;});
        const skSorted=Object.entries(userActs).sort((a,b)=>b[1]-a[1]).slice(0,5);
        const skMax=skSorted[0]?skSorted[0][1]:1;
        html+='<div class="space-y-2">';
        skSorted.forEach(([name,count],idx)=>{
            const pct=Math.round(count/skMax*100);
            const medal=idx===0?'&#129351;':idx===1?'&#129352;':idx===2?'&#129353;':'';
            html+=`<div class="flex items-center gap-2"><span class="w-5 text-center text-[10px]">${medal||(idx+1)+'.'}</span><span class="w-24 text-xs font-medium truncate">${name}</span><div class="flex-1 bg-gray-800 rounded-full h-2.5"><div class="bg-gradient-to-r from-purple-600 to-purple-400 h-2.5 rounded-full" style="width:${pct}%"></div></div><span class="w-16 text-[10px] text-gray-400 text-right font-medium">${count} islem</span></div>`;
        });
        html+='</div>';
        html+=`<p class="text-[9px] text-gray-600 mt-2">Toplam: ${buAyKullanim.length} islem | ${Object.keys(userActs).length} kullanici</p>`;
    }
    html+=`</div></div>`;
    c.innerHTML=html;
}
// --- HR CRUD ---
function openPersonelForm(id){
    document.getElementById('personel-edit-id').value=id||'';
    document.getElementById('personel-modal-title').textContent=id?'Personel Duzenle':'Yeni Personel';
    // Departman dropdown doldur
    const dSel=document.getElementById('p-departman');
    dSel.innerHTML='<option value="">Seciniz</option>'+(S.departmanlar||[]).filter(d=>d.aktif).map(d=>`<option value="${d.id}">${d.ad}</option>`).join('');
    // User dropdown
    const uSel=document.getElementById('p-userId');
    uSel.innerHTML='<option value="">Baglantilik hesap yok</option>'+S.users.map(u=>`<option value="${u.id}">${u.name} (${u.email})</option>`).join('');
    if(id){
        const p=(S.personeller||[]).find(x=>String(x.id)===String(id));
        if(p){
            document.getElementById('p-ad').value=p.ad||'';document.getElementById('p-soyad').value=p.soyad||'';
            document.getElementById('p-tc').value=p.tcKimlikNo||'';document.getElementById('p-dogum').value=p.dogumTarihi||'';
            document.getElementById('p-cinsiyet').value=p.cinsiyet||'';document.getElementById('p-medeni').value=p.medeniDurum||'';
            document.getElementById('p-kan').value=p.kanGrubu||'';document.getElementById('p-sgk').value=p.sgkNo||'';
            document.getElementById('p-tel-kisisel').value=p.telefonKisisel||'';document.getElementById('p-tel-is').value=p.telefonIs||'';
            document.getElementById('p-email-kisisel').value=p.emailKisisel||'';document.getElementById('p-email-is').value=p.emailIs||'';
            document.getElementById('p-adres').value=p.adres||'';document.getElementById('p-sehir').value=p.sehir||'';
            document.getElementById('p-departman').value=p.departmanId||'';document.getElementById('p-gorev').value=p.gorevi||'';
            document.getElementById('p-isegiris').value=p.iseGirisTarihi||'';document.getElementById('p-calisma').value=p.calismaTipi||'tam_zamanli';
            document.getElementById('p-maas').value=p.maas||0;document.getElementById('p-durum').value=p.durum||'aktif';
            fillEgitimForm(p.egitimler||[{seviye:p.egitimDurumu||'',okul:p.okulAdi||'',bolum:p.bolum||'',mezuniyet:''}]);
            fillEngelForm(p);
            document.getElementById('p-acil-kisi').value=p.acilDurumKisi||'';document.getElementById('p-acil-tel').value=p.acilDurumTel||'';
            document.getElementById('p-userId').value=p.userId||'';document.getElementById('p-notlar').value=p.notlar||'';
        }
    }else{
        ['p-ad','p-soyad','p-tc','p-dogum','p-cinsiyet','p-medeni','p-kan','p-sgk','p-tel-kisisel','p-tel-is','p-email-kisisel','p-email-is','p-adres','p-sehir','p-gorev','p-isegiris','p-acil-kisi','p-acil-tel','p-notlar'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
        document.getElementById('p-calisma').value='tam_zamanli';document.getElementById('p-durum').value='aktif';
        document.getElementById('p-maas').value='0';document.getElementById('p-departman').value='';
        document.getElementById('p-userId').value='';
        fillEgitimForm([]);fillEngelForm(null);
    }
    openModal('modal-personel');
}
// --- Egitim helpers ---
function addEgitimSatiri(data){
    const list=document.getElementById('p-egitim-list');
    if(!list)return;
    const d=data||{seviye:'',okul:'',bolum:'',mezuniyet:''};
    const row=document.createElement('div');
    row.className='p-3 rounded-lg bg-gray-800/20 border border-gray-700/20 egitim-row';
    row.innerHTML=`<div class="grid grid-cols-4 gap-2">
        <div><label class="block text-[10px] mb-1 text-gray-500">Seviye</label><select name="egitim-seviye" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs"><option value="">Seciniz</option><option value="ilkokul" ${d.seviye==='ilkokul'?'selected':''}>Ilkokul</option><option value="ortaokul" ${d.seviye==='ortaokul'?'selected':''}>Ortaokul</option><option value="lise" ${d.seviye==='lise'?'selected':''}>Lise</option><option value="onlisans" ${d.seviye==='onlisans'?'selected':''}>On Lisans</option><option value="lisans" ${d.seviye==='lisans'?'selected':''}>Lisans</option><option value="yukseklisans" ${d.seviye==='yukseklisans'?'selected':''}>Yuksek Lisans</option><option value="doktora" ${d.seviye==='doktora'?'selected':''}>Doktora</option></select></div>
        <div><label class="block text-[10px] mb-1 text-gray-500">Okul Adi</label><input name="egitim-okul" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" value="${d.okul||''}" placeholder="Okul adi"></div>
        <div><label class="block text-[10px] mb-1 text-gray-500">Bolum</label><input name="egitim-bolum" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" value="${d.bolum||''}" placeholder="Bolum"></div>
        <div class="flex gap-1"><div class="flex-1"><label class="block text-[10px] mb-1 text-gray-500">Mezuniyet</label><input type="month" name="egitim-mezuniyet" class="w-full bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 text-xs" value="${d.mezuniyet||''}"></div><button type="button" onclick="this.closest('.egitim-row').remove()" class="text-red-400 hover:text-red-300 mt-4 px-1 text-sm">&times;</button></div>
    </div>`;
    list.appendChild(row);
}
function fillEgitimForm(egitimler){
    const list=document.getElementById('p-egitim-list');
    if(!list)return;
    list.innerHTML='';
    if(!egitimler||egitimler.length===0){addEgitimSatiri();return;}
    egitimler.forEach(e=>addEgitimSatiri(e));
}
function collectEgitimData(){
    const rows=document.querySelectorAll('#p-egitim-list .egitim-row');
    const result=[];
    rows.forEach(row=>{
        const seviye=row.querySelector('[name="egitim-seviye"]').value;
        const okul=row.querySelector('[name="egitim-okul"]').value.trim();
        const bolum=row.querySelector('[name="egitim-bolum"]').value.trim();
        const mezuniyet=row.querySelector('[name="egitim-mezuniyet"]').value;
        if(seviye||okul) result.push({seviye,okul,bolum,mezuniyet});
    });
    return result;
}
// --- Engel helpers ---
function toggleEngelFields(val){
    const show=val==='var';
    document.getElementById('p-engel-detay').style.display=show?'grid':'none';
    document.getElementById('p-engel-oran').disabled=!show;
    document.getElementById('p-engel-tur').disabled=!show;
}
function fillEngelForm(p){
    if(!p||!p.engelDurumu||p.engelDurumu==='yok'){
        document.getElementById('p-engel-durum').value='yok';
        toggleEngelFields('yok');
        ['p-engel-oran','p-engel-tur','p-engel-rapor-tarih','p-engel-not'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
        document.getElementById('p-engel-rapor-sure').value='surekli';
    } else {
        document.getElementById('p-engel-durum').value='var';
        toggleEngelFields('var');
        const b=p.engelBilgileri||{};
        document.getElementById('p-engel-oran').value=b.oran||'';
        document.getElementById('p-engel-tur').value=b.tur||'';
        document.getElementById('p-engel-rapor-tarih').value=b.raporTarihi||'';
        document.getElementById('p-engel-rapor-sure').value=b.raporSure||'surekli';
        document.getElementById('p-engel-not').value=b.not||'';
    }
    // Emeklilik
    fillEmekliForm(p);
}
// --- Emeklilik helpers ---
function toggleEmekliFields(val){
    const show=val==='emekli';
    document.getElementById('p-emekli-detay').style.display=show?'grid':'none';
    document.getElementById('p-emekli-tarih').disabled=!show;
    document.getElementById('p-emekli-sandik').disabled=!show;
}
function fillEmekliForm(p){
    if(!p||!p.emekliDurumu||p.emekliDurumu==='calisan'){
        document.getElementById('p-emekli-durum').value='calisan';
        toggleEmekliFields('calisan');
        ['p-emekli-tarih','p-emekli-sicil','p-emekli-not'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
        document.getElementById('p-emekli-sandik').value='';
        return;
    }
    document.getElementById('p-emekli-durum').value='emekli';
    toggleEmekliFields('emekli');
    const em=p.emekliBilgileri||{};
    document.getElementById('p-emekli-tarih').value=em.tarih||'';
    document.getElementById('p-emekli-sandik').value=em.sandik||'';
    document.getElementById('p-emekli-sicil').value=em.sicilNo||'';
    document.getElementById('p-emekli-not').value=em.not||'';
}
function savePersonel(){
    if(!enforceAccess('add_personel','hr'))return;
    const ad=document.getElementById('p-ad').value.trim();
    const soyad=document.getElementById('p-soyad').value.trim();
    const tc=document.getElementById('p-tc').value.trim();
    const dept=document.getElementById('p-departman').value;
    const gorev=document.getElementById('p-gorev').value.trim();
    const iseGiris=document.getElementById('p-isegiris').value;
    const telK=document.getElementById('p-tel-kisisel').value.trim();
    const telI=document.getElementById('p-tel-is').value.trim();
    // Zorunlu alan kontrolleri
    const eksik=[];
    if(!ad)eksik.push('Ad');
    if(!soyad)eksik.push('Soyad');
    if(!tc||tc.length!==11)eksik.push('TC Kimlik No (11 hane)');
    if(!dept)eksik.push('Departman');
    if(!gorev)eksik.push('Gorev/Unvan');
    if(!iseGiris)eksik.push('Ise Giris Tarihi');
    if(!telK&&!telI)eksik.push('Telefon (en az biri)');
    if(eksik.length>0){showNotif('Eksik alanlar: '+eksik.join(', '));return;}
    const editId=document.getElementById('personel-edit-id').value;
    const data={
        ad,soyad,tcKimlikNo:document.getElementById('p-tc').value.trim()||null,
        dogumTarihi:document.getElementById('p-dogum').value||null,
        cinsiyet:document.getElementById('p-cinsiyet').value||null,
        medeniDurum:document.getElementById('p-medeni').value||null,
        kanGrubu:document.getElementById('p-kan').value||null,
        sgkNo:document.getElementById('p-sgk').value.trim()||null,
        telefonKisisel:document.getElementById('p-tel-kisisel').value.trim()||null,
        telefonIs:document.getElementById('p-tel-is').value.trim()||null,
        emailKisisel:document.getElementById('p-email-kisisel').value.trim()||null,
        emailIs:document.getElementById('p-email-is').value.trim()||null,
        adres:document.getElementById('p-adres').value.trim()||null,
        sehir:document.getElementById('p-sehir').value.trim()||null,
        departmanId:document.getElementById('p-departman').value||null,
        gorevi:document.getElementById('p-gorev').value.trim()||null,
        iseGirisTarihi:document.getElementById('p-isegiris').value||null,
        calismaTipi:document.getElementById('p-calisma').value||'tam_zamanli',
        maas:parseFloat(document.getElementById('p-maas').value)||0,
        durum:document.getElementById('p-durum').value||'aktif',
        egitimler:collectEgitimData(),
        engelDurumu:document.getElementById('p-engel-durum').value||'yok',
        engelBilgileri:document.getElementById('p-engel-durum').value==='var'?{oran:parseInt(document.getElementById('p-engel-oran').value)||0,tur:document.getElementById('p-engel-tur').value.trim()||null,raporTarihi:document.getElementById('p-engel-rapor-tarih').value||null,raporSure:document.getElementById('p-engel-rapor-sure').value||'surekli',not:document.getElementById('p-engel-not').value.trim()||null}:null,
        emekliDurumu:document.getElementById('p-emekli-durum').value||'calisan',
        emekliBilgileri:document.getElementById('p-emekli-durum').value==='emekli'?{tarih:document.getElementById('p-emekli-tarih').value||null,sandik:document.getElementById('p-emekli-sandik').value||null,sicilNo:document.getElementById('p-emekli-sicil').value.trim()||null,not:document.getElementById('p-emekli-not').value.trim()||null}:null,
        acilDurumKisi:document.getElementById('p-acil-kisi').value.trim()||null,
        acilDurumTel:document.getElementById('p-acil-tel').value.trim()||null,
        userId:document.getElementById('p-userId').value||null,
        notlar:document.getElementById('p-notlar').value.trim()||null,
        profilResmi:null
    };
    if(!S.personeller)S.personeller=[];
    if(editId){
        const idx=S.personeller.findIndex(p=>String(p.id)===String(editId));
        if(idx>=0)Object.assign(S.personeller[idx],data);
    }else{
        data.id=Date.now();
        S.personeller.push(data);
    }
    save();closeModal('modal-personel');renderHrPersoneller();
    if(!editId){
        showNotif('Personel eklendi. Belge paketi hazirlaniyor...');
        setTimeout(()=>openBelgePaketiModal(data.id),500);
    }else{
        showNotif('Personel guncellendi.');
    }
    act(editId?'Personel guncellendi: '+ad+' '+soyad:'Yeni personel: '+ad+' '+soyad);
}
function deletePersonel(id){
    if(!enforceAccess('delete_personel','hr'))return;
    const p=(S.personeller||[]).find(x=>String(x.id)===String(id));
    if(p&&(p.durum==='aktif'||p.durum==='izinli')){
        if(!confirm('Bu personel hala aktif/izinli. Isten ayrilma islemi yapmak yerine tamamen silmek istediginize emin misiniz? Bu islem geri alinamaz.'))return;
    }else{
        if(!confirm('Bu personeli silmek istediginize emin misiniz? Tum kayitlari silinecektir.'))return;
    }
    S.personeller=(S.personeller||[]).filter(p=>String(p.id)!==String(id));
    S.izinler=(S.izinler||[]).filter(i=>String(i.employeeId)!==String(id));
    S.personelBelgeler=(S.personelBelgeler||[]).filter(b=>String(b.employeeId)!==String(id));
    save();renderHrPersoneller();showNotif('Personel silindi.');
}
// ===================== HR - PUANTAJ =====================
function renderHrPuantaj(){
    const c=document.getElementById('hr-tab-puantaj');if(!c)return;
    if(!S.puantajlar)S.puantajlar=[];
    const buAy=new Date().toISOString().slice(0,7);
    const selectedMonth=document.getElementById('puantaj-ay-sec')?document.getElementById('puantaj-ay-sec').value:buAy;
    const monthPuantaj=(S.puantajlar||[]).filter(p=>p.tarih&&p.tarih.startsWith(selectedMonth));
    const personeller=(S.personeller||[]).filter(p=>p.durum==='aktif'||p.durum==='izinli');
    const toplamGun=monthPuantaj.length;
    const toplamSaat=monthPuantaj.reduce((s,p)=>s+(p.toplamSaat||0),0);
    const toplamFazla=monthPuantaj.reduce((s,p)=>s+(p.fazlaMesai||0),0);
    const devamsiz=monthPuantaj.filter(p=>p.durum==='yok').length;
    let html=`<div class="flex items-center gap-3 mb-4">
        <input type="month" id="puantaj-ay-sec" value="${selectedMonth}" onchange="renderHrPuantaj()" class="bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm">
        <button onclick="openPuantajForm()" class="px-3 py-1.5 bg-teal-600/20 text-teal-400 hover:bg-teal-600/40 rounded text-xs border border-teal-500/20">+ Manuel Kayit</button>
    </div>`;
    html+=`<div class="grid grid-cols-4 gap-3 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Toplam Kayit</p><p class="text-xl font-bold text-white">${toplamGun}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Toplam Saat</p><p class="text-xl font-bold text-teal-400">${toplamSaat.toFixed(1)}</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Fazla Mesai</p><p class="text-xl font-bold text-amber-400">${toplamFazla.toFixed(1)} saat</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-[10px] text-gray-400">Devamsizlik</p><p class="text-xl font-bold text-red-400">${devamsiz}</p></div>
    </div>`;
    // Personel bazli puantaj tablosu
    const allIds=[...new Set(monthPuantaj.map(pt=>String(pt.personelId)))];
    allIds.forEach(pid=>{
        const pPuantaj=monthPuantaj.filter(pt=>String(pt.personelId)===String(pid));
        if(pPuantaj.length===0)return;
        const personel=(S.personeller||[]).find(p=>String(p.id)===String(pid));
        const pName=personel?(personel.ad+' '+personel.soyad):(S.users.find(u=>('user_'+u.id)===pid)?S.users.find(u=>('user_'+u.id)===pid).name:'Kullanici #'+pid);
        const pSaat=pPuantaj.reduce((s,p)=>s+(p.toplamSaat||0),0);
        html+=`<div class="glass rounded-xl p-4 mb-3"><div class="flex items-center justify-between mb-2"><h5 class="text-xs font-bold text-teal-400">${pName}</h5><span class="text-[10px] text-gray-400">${pPuantaj.length} gun | ${pSaat.toFixed(1)} saat</span></div>
            <div class="overflow-x-auto"><table class="w-full text-[10px]"><thead><tr class="text-gray-400 border-b border-gray-700"><th class="p-1 text-left">Tarih</th><th class="p-1">Giris</th><th class="p-1">Cikis</th><th class="p-1 text-right">Saat</th><th class="p-1 text-right">F.Mesai</th><th class="p-1">Durum</th></tr></thead><tbody>`;
        pPuantaj.sort((a,b)=>a.tarih.localeCompare(b.tarih)).forEach(pt=>{
            const durCol=pt.durum==='tam'?'text-green-400':pt.durum==='yarim'?'text-amber-400':pt.durum==='izinli'?'text-blue-400':'text-red-400';
            const durL=pt.durum==='tam'?'Tam':pt.durum==='yarim'?'Yarim':pt.durum==='izinli'?'Izinli':'Yok';
            html+=`<tr class="border-b border-gray-800"><td class="p-1">${pt.tarih}</td><td class="p-1 text-center">${pt.girisSaat||'-'}</td><td class="p-1 text-center">${pt.cikisSaat||'-'}</td><td class="p-1 text-right">${(pt.toplamSaat||0).toFixed(1)}</td><td class="p-1 text-right">${(pt.fazlaMesai||0).toFixed(1)}</td><td class="p-1 ${durCol}">${durL}</td></tr>`;
        });
        html+=`</tbody></table></div></div>`;
    });
    if(allIds.length===0)html+='<div class="text-center py-8"><p class="text-gray-500 text-sm">Bu ay puantaj kaydi yok.</p></div>';
    // Sistem Kullanim Skoru
    const logs=S.sistemKullanimLog||[];
    const monthLogs=logs.filter(l=>l.timestamp&&l.timestamp.startsWith(selectedMonth));
    if(monthLogs.length>0){
        html+=`<div class="glass rounded-xl p-4 mb-3 border border-purple-500/20"><h4 class="text-xs font-bold text-purple-400 mb-3 uppercase tracking-wider">&#128200; Sistem Kullanim Skoru</h4><div class="space-y-2">`;
        const userCounts={};monthLogs.forEach(l=>{userCounts[l.userName]=(userCounts[l.userName]||0)+1;});
        const sorted=Object.entries(userCounts).sort((a,b)=>b[1]-a[1]);
        const maxC=sorted[0]?sorted[0][1]:1;
        sorted.forEach(([name,count],idx)=>{
            const pct=Math.round(count/maxC*100);
            html+=`<div class="flex items-center gap-3"><span class="w-4 text-[10px] text-gray-500 text-right">${idx+1}.</span><span class="w-28 text-xs font-medium truncate">${name}</span><div class="flex-1 bg-gray-800 rounded-full h-2"><div class="bg-purple-500 h-2 rounded-full" style="width:${pct}%"></div></div><span class="w-16 text-[10px] text-gray-400 text-right">${count} islem</span></div>`;
        });
        html+=`</div></div>`;
        // Modul kullanim dagilimi
        const modCounts={};monthLogs.filter(l=>l.module&&l.action==='modul_erisim').forEach(l=>{modCounts[l.module]=(modCounts[l.module]||0)+1;});
        const modSorted=Object.entries(modCounts).sort((a,b)=>b[1]-a[1]);
        if(modSorted.length>0){
            const maxM=modSorted[0][1];
            html+=`<div class="glass rounded-xl p-4 mb-3 border border-blue-500/20"><h4 class="text-xs font-bold text-blue-400 mb-3 uppercase tracking-wider">&#128202; Modul Kullanim Dagilimi</h4><div class="space-y-2">`;
            modSorted.forEach(([mod,count])=>{
                const pct=Math.round(count/maxM*100);
                const modNames={dashboard:'Dashboard',connect:'FaOn-Connect',build:'FaOn-Build',supply:'FaOn-Supply',sales:'FaOn-Sales',depo:'FaOn-Depo',hr:'FaOn-HR',reports:'Raporlar',settings:'Ayarlar'};
                html+=`<div class="flex items-center gap-3"><span class="w-28 text-xs font-medium truncate">${modNames[mod]||mod}</span><div class="flex-1 bg-gray-800 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width:${pct}%"></div></div><span class="w-12 text-[10px] text-gray-400 text-right">${count}</span></div>`;
            });
            html+=`</div></div>`;
        }
    }
    c.innerHTML=html;
}
function openPuantajForm(){
    const pSel=document.getElementById('pnt-personel');
    if(!pSel){
        // Modal yoksa olustur
        let modal=document.getElementById('modal-puantaj');
        if(!modal){
            modal=document.createElement('div');modal.id='modal-puantaj';modal.className='modal';
            modal.innerHTML=`<div class="glass-strong rounded-2xl p-6 w-full max-w-lg"><div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold">Manuel Puantaj Kaydi</h3><button onclick="closeModal('modal-puantaj')" class="text-gray-400 hover:text-white text-lg">&times;</button></div>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="col-span-2"><label class="text-xs text-gray-400 mb-1 block">Personel *</label><select id="pnt-personel" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></select></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Tarih *</label><input id="pnt-tarih" type="date" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Durum</label><select id="pnt-durum" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm"><option value="tam">Tam Gun</option><option value="yarim">Yarim Gun</option><option value="yok">Gelmedi</option><option value="izinli">Izinli</option></select></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Giris Saati</label><input id="pnt-giris" type="time" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="08:00"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Cikis Saati</label><input id="pnt-cikis" type="time" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm" value="17:00"></div>
            </div>
            <div class="flex gap-3 mt-4"><button onclick="savePuantaj()" class="flex-1 bg-teal-600 hover:bg-teal-700 py-2.5 rounded-lg font-medium text-sm transition-colors">Kaydet</button><button onclick="closeModal('modal-puantaj')" class="px-6 bg-gray-700 hover:bg-gray-600 py-2.5 rounded-lg text-sm transition-colors">Iptal</button></div></div>`;
            document.body.appendChild(modal);
        }
    }
    document.getElementById('pnt-tarih').value=new Date().toISOString().slice(0,10);
    document.getElementById('pnt-durum').value='tam';
    document.getElementById('pnt-giris').value='08:00';document.getElementById('pnt-cikis').value='17:00';
    const sel=document.getElementById('pnt-personel');
    sel.innerHTML=(S.personeller||[]).filter(p=>p.durum==='aktif'||p.durum==='izinli').map(p=>`<option value="${p.id}">${p.ad} ${p.soyad}</option>`).join('');
    openModal('modal-puantaj');
}
function savePuantaj(){
    const personelId=document.getElementById('pnt-personel').value;
    const tarih=document.getElementById('pnt-tarih').value;
    if(!personelId||!tarih){showNotif('Personel ve tarih secin.');return;}
    const giris=document.getElementById('pnt-giris').value||'08:00';
    const cikis=document.getElementById('pnt-cikis').value||'17:00';
    const durum=document.getElementById('pnt-durum').value;
    let toplamSaat=0,fazlaMesai=0;
    if(durum==='tam'||durum==='yarim'){
        const [gh,gm]=giris.split(':').map(Number);const [ch,cm]=cikis.split(':').map(Number);
        toplamSaat=Math.max(0,((ch*60+cm)-(gh*60+gm))/60);fazlaMesai=Math.max(0,toplamSaat-8);
    }
    if(!S.puantajlar)S.puantajlar=[];
    S.puantajlar=S.puantajlar.filter(p=>!(String(p.personelId)===String(personelId)&&p.tarih===tarih));
    S.puantajlar.push({id:Date.now(),personelId,tarih,girisSaat:giris,cikisSaat:cikis,toplamSaat,fazlaMesai,durum,otomatik:false});
    save();closeModal('modal-puantaj');renderHrPuantaj();showNotif('Puantaj kaydi eklendi.');act('Puantaj kaydi eklendi.');
}

function openPersonelDetay(id){
    const p=(S.personeller||[]).find(x=>String(x.id)===String(id));if(!p)return;
    const dept=(S.departmanlar||[]).find(d=>String(d.id)===String(p.departmanId));
    const pIzinler=(S.izinler||[]).filter(i=>String(i.employeeId)===String(id));
    const pBelgeler=(S.personelBelgeler||[]).filter(b=>String(b.employeeId)===String(id));
    const pZimmetler=(S.zimmetler||[]).filter(z=>(z.personelId&&String(z.personelId)===String(id))||(!z.personelId&&z.zimmetliKisi===(p.ad+' '+p.soyad)));
    const IZIN_LABELS={yillik:'Yillik',hastalik:'Hastalik',mazeret:'Mazeret',dogum:'Dogum',ucretsiz:'Ucretsiz',evlilik:'Evlilik',olum:'Olum'};
    const izinBadgeColors={yillik:'bg-teal-500/20 text-teal-400',hastalik:'bg-red-500/20 text-red-400',mazeret:'bg-amber-500/20 text-amber-400',dogum:'bg-pink-500/20 text-pink-400',ucretsiz:'bg-gray-500/20 text-gray-400',evlilik:'bg-purple-500/20 text-purple-400',olum:'bg-gray-600/20 text-gray-300'};
    // Kidem hesapla
    const now=new Date();
    let kidemStr='-';
    if(p.iseGirisTarihi){const yil=((now-new Date(p.iseGirisTarihi))/(365.25*24*60*60*1000));kidemStr=yil>=1?yil.toFixed(1)+' yil':(yil*12).toFixed(0)+' ay';}
    // Avatar initials
    const initials=(p.ad||'').charAt(0).toUpperCase()+(p.soyad||'').charAt(0).toUpperCase();
    // Durum badge
    const durumCol=p.durum==='aktif'?'bg-green-500/20 text-green-400 border-green-500/30':p.durum==='izinli'?'bg-amber-500/20 text-amber-400 border-amber-500/30':'bg-red-500/20 text-red-400 border-red-500/30';
    const durumL=p.durum==='aktif'?'Aktif':p.durum==='izinli'?'Izinli':'Ayrilmis';
    // Izin bakiye - kidem bazli dinamik hak
    const izinHakGun=hesaplaYillikIzinHakki(p);
    const buYil=new Date().getFullYear();
    const kullanilanIzin=(pIzinler||[]).filter(i=>i.durum==='onaylandi'&&i.izinTuru==='yillik'&&i.basTarihi&&i.basTarihi.startsWith(String(buYil))).reduce((s,i)=>s+(i.gunSayisi||0),0);
    const ucretsizIzinGun=(pIzinler||[]).filter(i=>i.durum==='onaylandi'&&UCRETSIZ_IZIN_TURLERI.includes(i.izinTuru)&&i.basTarihi&&i.basTarihi.startsWith(String(buYil))).reduce((s,i)=>s+(i.gunSayisi||0),0);
    const kalanIzin=izinHakGun-kullanilanIzin;
    const izinPct=izinHakGun>0?Math.max(0,Math.round(kalanIzin/izinHakGun*100)):0;
    const izinBarColor=izinHakGun===0?'bg-gray-600':kalanIzin<=3?'bg-red-500':kalanIzin<=7?'bg-amber-500':'bg-teal-500';
    let html=`<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" id="personel-detay-overlay" onclick="if(event.target===this)this.remove()">
    <div class="glass-strong rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto">
        <!-- Header -->
        <div class="p-5 border-b border-gray-700/50">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-teal-500 to-teal-700 flex items-center justify-center text-xl font-bold text-white flex-shrink-0">${initials}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap"><h3 class="text-lg font-bold">${p.ad} ${p.soyad}</h3><span class="px-2 py-0.5 rounded-full text-[10px] border ${durumCol}">${durumL}</span></div>
                    <p class="text-sm text-gray-400">${dept?dept.ad:'-'} &middot; ${p.gorevi||'-'}</p>
                    <p class="text-[11px] text-gray-500">Ise Giris: ${p.iseGirisTarihi||'-'} &middot; Kidem: ${kidemStr}</p>
                </div>
                <div class="flex gap-1.5 flex-shrink-0">
                    <button onclick="document.getElementById('personel-detay-overlay').remove();openPersonelForm('${p.id}')" class="px-3 py-1.5 bg-teal-600 hover:bg-teal-700 rounded-lg text-[11px] transition-colors">Duzenle</button>
                    ${p.durum==='ayrilmis'?`<button onclick="document.getElementById('personel-detay-overlay').remove();openAyrilmaBelgePaketiModal('${p.id}')" class="px-3 py-1.5 bg-orange-600 hover:bg-orange-700 rounded-lg text-[11px] transition-colors">&#128196; Ayrilma Belgeleri</button>`:(p.durum==='aktif'||p.durum==='izinli')?`<button onclick="document.getElementById('personel-detay-overlay').remove();openIstenAyrilmaModal('${p.id}')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded-lg text-[11px] transition-colors">&#128683; Isten Ayrilma</button>`:''}
                    <button onclick="document.getElementById('personel-detay-overlay').remove()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-[11px] transition-colors">&times;</button>
                </div>
            </div>
        </div>
        <div class="p-5 space-y-4">
        <!-- Kisisel + Iletisim Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="glass rounded-xl p-4">
                <h4 class="text-[11px] font-bold text-teal-400 mb-2.5 uppercase tracking-wider">Kisisel Bilgiler</h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500">TC Kimlik</span><span class="font-medium">${p.tcKimlikNo||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Dogum Tarihi</span><span class="font-medium">${p.dogumTarihi||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Cinsiyet</span><span class="font-medium">${p.cinsiyet==='erkek'?'Erkek':p.cinsiyet==='kadin'?'Kadin':'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Medeni Durum</span><span class="font-medium">${p.medeniDurum||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Kan Grubu</span><span class="font-medium">${p.kanGrubu||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">SGK No</span><span class="font-medium">${p.sgkNo||'-'}</span></div>
                </div>
            </div>
            <div class="glass rounded-xl p-4">
                <h4 class="text-[11px] font-bold text-teal-400 mb-2.5 uppercase tracking-wider">Iletisim</h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500">Kisisel Tel</span><span class="font-medium">${p.telefonKisisel||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Is Tel</span><span class="font-medium">${p.telefonIs||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Kisisel E-posta</span><span class="font-medium">${p.emailKisisel||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Is E-posta</span><span class="font-medium">${p.emailIs||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Sehir</span><span class="font-medium">${p.sehir||'-'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Adres</span><span class="font-medium text-right max-w-[180px] truncate" title="${p.adres||''}">${p.adres||'-'}</span></div>
                </div>
            </div>
        </div>`;
    // Egitim Bilgileri (coklu)
    const egitimLabels={ilkokul:'Ilkokul',ortaokul:'Ortaokul',lise:'Lise',onlisans:'On Lisans',lisans:'Lisans',yukseklisans:'Yuksek Lisans',doktora:'Doktora'};
    const egitimler=p.egitimler||[];
    // Backward compat: eski tek egitim alanlari
    if(egitimler.length===0&&(p.egitimDurumu||p.okulAdi)){egitimler.push({seviye:p.egitimDurumu||'',okul:p.okulAdi||'',bolum:p.bolum||'',mezuniyet:''});}
    if(egitimler.length>0){
        html+=`<div class="glass rounded-xl p-4"><h4 class="text-[11px] font-bold text-teal-400 mb-2.5 uppercase tracking-wider">Egitim Bilgileri (${egitimler.length})</h4>
            <div class="space-y-2">${egitimler.map((e,i)=>`<div class="flex items-center gap-3 p-2.5 rounded-lg bg-gray-800/30 border border-gray-700/20">
                <div class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-400 text-xs font-bold">${i+1}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium">${egitimLabels[e.seviye]||e.seviye||'-'} ${e.okul?'&middot; '+e.okul:''}</p>
                    <p class="text-[10px] text-gray-500">${e.bolum||'-'}${e.mezuniyet?' &middot; Mezuniyet: '+e.mezuniyet:''}</p>
                </div>
            </div>`).join('')}</div></div>`;
    }
    // Engel Durumu + Emeklilik + Acil Durum
    html+=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">`;
    // Engel Durumu
    if(p.engelDurumu==='var'&&p.engelBilgileri){
        const eb=p.engelBilgileri;
        const sureLbl={surekli:'Surekli','1yil':'1 Yil','2yil':'2 Yil','5yil':'5 Yil'};
        html+=`<div class="glass rounded-xl p-4 border border-purple-500/20"><h4 class="text-[11px] font-bold text-purple-400 mb-2.5 uppercase tracking-wider">‚ôø Engel Durumu</h4><div class="space-y-2 text-xs">
            <div class="flex justify-between"><span class="text-gray-500">Engel Orani</span><span class="font-medium text-purple-300">%${eb.oran||0}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Engel Turu</span><span class="font-medium">${eb.tur||'-'}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Rapor Tarihi</span><span class="font-medium">${eb.raporTarihi||'-'}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Gecerlilik</span><span class="font-medium">${sureLbl[eb.raporSure]||eb.raporSure||'-'}</span></div>
            ${eb.not?`<div class="mt-2 p-2 rounded bg-purple-500/5 border border-purple-500/10"><p class="text-[10px] text-gray-400">${eb.not}</p></div>`:''}
        </div></div>`;
    }
    // Emeklilik Durumu
    if(p.emekliDurumu==='emekli'&&p.emekliBilgileri){
        const em=p.emekliBilgileri;
        html+=`<div class="glass rounded-xl p-4 border border-amber-500/20"><h4 class="text-[11px] font-bold text-amber-400 mb-2.5 uppercase tracking-wider">üèñÔ∏è Emeklilik Bilgileri</h4><div class="space-y-2 text-xs">
            <div class="flex justify-between"><span class="text-gray-500">Emeklilik Tarihi</span><span class="font-medium">${em.tarih||'-'}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Emekli Sandigi</span><span class="font-medium">${em.sandik||'-'}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Emekli Sicil No</span><span class="font-medium">${em.sicilNo||'-'}</span></div>
            ${em.not?`<div class="mt-2 p-2 rounded bg-amber-500/5 border border-amber-500/10"><p class="text-[10px] text-gray-400">${em.not}</p></div>`:''}
        </div></div>`;
    }
    // Acil Durum
    if(p.acilDurumKisi){
        html+=`<div class="glass rounded-xl p-4"><h4 class="text-[11px] font-bold text-red-400 mb-2.5 uppercase tracking-wider">Acil Durum</h4><div class="space-y-2 text-xs">
            <div class="flex justify-between"><span class="text-gray-500">Irtibat Kisi</span><span class="font-medium">${p.acilDurumKisi}</span></div>
            <div class="flex justify-between"><span class="text-gray-500">Telefon</span><span class="font-medium">${p.acilDurumTel||'-'}</span></div>
        </div></div>`;
    }
    html+=`</div>`;
    // Ayrilma Bilgileri (sadece ayrilmis personel icin)
    if(p.durum==='ayrilmis'&&p.ayrilmaTarihi){
        const kidemCalc=hesaplaKidemTazminati(p,p.ayrilmaTarihi);
        html+=`<div class="glass rounded-xl p-4 border border-red-500/20">
            <h4 class="text-[11px] font-bold text-red-400 mb-2.5 uppercase tracking-wider">&#128683; Ayrilma Bilgileri</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="flex justify-between"><span class="text-gray-500">Ayrilma Tarihi</span><span class="font-medium">${p.ayrilmaTarihi}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Ayrilma Nedeni</span><span class="font-medium text-red-400">${AYRILMA_NEDENLERI[p.ayrilmaNedeni]||p.ayrilmaNedeni||'-'}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Kidem Suresi</span><span class="font-medium">${kidemCalc.yil} yil ${kidemCalc.ay} ay ${kidemCalc.gun} gun</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Kidem Tazminati</span><span class="font-medium ${p.kidemTazminatiHakEder?'text-red-400':'text-gray-500'}">${p.kidemTazminatiHakEder?(p.kidemTazminatiTutar||kidemCalc.tutar).toLocaleString('tr-TR')+' TL':'Hak etmez'}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Ihbar Tazminati</span><span class="font-medium ${p.ihbarTazminatiHakEder?'text-orange-400':'text-gray-500'}">${p.ihbarTazminatiHakEder?(p.ihbarTazminatiTutar||0).toLocaleString('tr-TR')+' TL':'Hak etmez'}</span></div>
                ${p.ayrilmaAciklama?'<div class="col-span-2 flex justify-between"><span class="text-gray-500">Aciklama</span><span class="font-medium text-right max-w-[250px]">'+p.ayrilmaAciklama+'</span></div>':''}
            </div>
        </div>`;
    }
    // Izin Bakiyesi progress bar
    const izinHakNotu=izinHakGun===0?'<span class="text-[9px] text-gray-500 ml-1">(1 yil dolmadi)</span>':izinHakGun>=20?'<span class="text-[9px] text-gray-500 ml-1">(5+ yil kidem)</span>':'';
    html+=`<div class="glass rounded-xl p-4">
        <div class="flex items-center justify-between mb-2"><h4 class="text-[11px] font-bold text-teal-400 uppercase tracking-wider">Yillik Izin Bakiyesi (${buYil})</h4><span class="text-xs font-bold ${izinHakGun===0?'text-gray-500':kalanIzin<=3?'text-red-400':'text-teal-400'}">${kalanIzin}/${izinHakGun} gun kaldi${izinHakNotu}</span></div>
        <div class="w-full bg-gray-800 rounded-full h-3"><div class="${izinBarColor} h-3 rounded-full transition-all flex items-center ${izinPct>15?'justify-end pr-2':''}" style="width:${Math.max(izinPct,3)}%">${izinPct>15?`<span class="text-[8px] text-white font-medium">${izinPct}%</span>`:''}</div></div>
        <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>Kullanilan: ${kullanilanIzin} gun${ucretsizIzinGun>0?' ¬∑ Ucretsiz: '+ucretsizIzinGun+' gun':''}</span><span>Kalan: ${kalanIzin} gun</span></div>
    </div>`;
    // Zimmetler tablosu
    if(pZimmetler.length>0){
        html+=`<div class="glass rounded-xl p-4"><h4 class="text-[11px] font-bold text-amber-400 mb-2.5 uppercase tracking-wider">Zimmetler (${pZimmetler.length})</h4>
        <div class="overflow-x-auto"><table class="w-full text-[10px]"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-1.5">#</th><th class="p-1.5">Malzeme</th><th class="p-1.5">Seri No</th><th class="p-1.5">Tarih</th><th class="p-1.5">Durum</th><th class="p-1.5">Belge No</th></tr></thead><tbody>`;
        pZimmetler.forEach((z,zi)=>{
            const zDurumCol=z.durum==='aktif'?'bg-amber-500/20 text-amber-400':z.durum==='iade'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400';
            html+=`<tr class="border-b border-gray-800"><td class="p-1.5 text-gray-500">${zi+1}</td><td class="p-1.5 font-medium">${z.malzemeAdi}</td><td class="p-1.5 text-gray-400">${z.seriNo||'-'}</td><td class="p-1.5 text-gray-400">${z.tarih||'-'}</td><td class="p-1.5"><span class="px-1 py-0.5 rounded text-[8px] ${zDurumCol}">${z.durum}</span></td><td class="p-1.5 text-gray-500">${z.belgeNo||'-'}</td></tr>`;
        });
        html+=`</tbody></table></div></div>`;
    }
    // Izinler
    if(pIzinler.length>0){
        html+=`<div class="glass rounded-xl p-4"><h4 class="text-[11px] font-bold text-teal-400 mb-2.5 uppercase tracking-wider">Izinler (${pIzinler.length})</h4>
        <div class="overflow-x-auto"><table class="w-full text-[10px]"><thead class="border-b border-gray-700"><tr class="text-left text-gray-400"><th class="p-1.5">Tur</th><th class="p-1.5">Tarihler</th><th class="p-1.5 text-center">Gun</th><th class="p-1.5">Durum</th></tr></thead><tbody>`;
        pIzinler.forEach(iz=>{
            const badge=izinBadgeColors[iz.izinTuru]||'bg-gray-500/20 text-gray-400';
            const durumCol2=iz.durum==='onaylandi'?'bg-green-500/20 text-green-400':iz.durum==='beklemede'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400';
            html+=`<tr class="border-b border-gray-800"><td class="p-1.5"><span class="px-1.5 py-0.5 rounded text-[8px] ${badge}">${IZIN_LABELS[iz.izinTuru]||iz.izinTuru}</span></td><td class="p-1.5 text-gray-400">${iz.basTarihi} ~ ${iz.bitTarihi}</td><td class="p-1.5 text-center">${iz.gunSayisi}g</td><td class="p-1.5"><span class="px-1 py-0.5 rounded text-[8px] ${durumCol2}">${iz.durum}</span></td></tr>`;
        });
        html+=`</tbody></table></div></div>`;
    }
    // Belgeler
    {
        const BELGE_LABELS={sozlesme:'Is Sozlesmesi',diploma:'Diploma',sertifika:'Sertifika',saglik_raporu:'Saglik Raporu',ikametgah:'Ikametgah',nufus_cuzdani:'Nufus Cuzdani',ehliyet:'Ehliyet',diger:'Diger',kvkk:'KVKK Aydinlatma',gizlilik:'Gizlilik Sozlesmesi',isg:'ISG Egitim',etik:'Etik Taahhutname',zimmet_tutanagi:'Zimmet Tutanagi',ayrilma:'Isten Ayrilma Bildirimi',deneyim:'Is Deneyim Belgesi',zimmet_iade:'Zimmet Iade',ibra:'Ibra Belgesi'};
        html+=`<div class="glass rounded-xl p-4"><div class="flex items-center justify-between mb-2.5"><h4 class="text-[11px] font-bold text-purple-400 uppercase tracking-wider">Belgeler (${pBelgeler.length})</h4><button onclick="document.getElementById('personel-detay-overlay')?.remove();openBelgePaketiModal('${id}')" class="text-[10px] px-2 py-1 glass rounded-lg text-teal-400 hover:bg-teal-600/20 border border-teal-500/20">&#128196; Belge Paketi</button></div>`;
        if(pBelgeler.length>0){
            html+=`<div class="space-y-1">`;
            pBelgeler.forEach(b=>{
                html+=`<div class="flex items-center justify-between text-[11px] p-1.5 rounded hover:bg-gray-800/30"><span class="font-medium">${BELGE_LABELS[b.tur]||b.tur}: ${b.baslik}</span><span class="text-gray-500">${b.gecerlilikTarihi||'-'}</span></div>`;
            });
            html+=`</div>`;
        }else{
            html+=`<p class="text-[10px] text-gray-500">Henuz belge yok. Belge Paketi ile olusturabilirsiniz.</p>`;
        }
        html+=`</div>`;
    }
    // Puantaj Ozeti
    {
        const buAyStr=new Date().toISOString().slice(0,7);
        const pPuantaj=(S.puantajlar||[]).filter(pt=>String(pt.personelId)===String(id)&&pt.tarih&&pt.tarih.startsWith(buAyStr));
        const pCalismaGun=pPuantaj.filter(pt=>pt.durum==='tam'||pt.durum==='yarim').length;
        const pToplamSaat=pPuantaj.reduce((s,pt)=>s+(pt.toplamSaat||0),0);
        const pFazlaMesai=pPuantaj.reduce((s,pt)=>s+(pt.fazlaMesai||0),0);
        const pDevamsiz=pPuantaj.filter(pt=>pt.durum==='yok').length;
        // Sistem kullanim skoru
        const pLogs=(S.sistemKullanimLog||[]).filter(l=>l.userId&&String(l.userId)===String(p.userId||'')&&l.timestamp&&l.timestamp.startsWith(buAyStr));
        const kullanimSkoru=pLogs.length;
        html+=`<div class="glass rounded-xl p-4 border border-purple-500/20">
            <h4 class="text-[11px] font-bold text-purple-400 mb-2.5 uppercase tracking-wider">&#128197; Puantaj Ozeti (${buAyStr})</h4>
            <div class="grid grid-cols-5 gap-2 text-center mb-3">
                <div><p class="text-[10px] text-gray-500">Calisma Gunu</p><p class="text-sm font-bold text-white">${pCalismaGun}</p></div>
                <div><p class="text-[10px] text-gray-500">Toplam Saat</p><p class="text-sm font-bold text-teal-400">${pToplamSaat.toFixed(1)}</p></div>
                <div><p class="text-[10px] text-gray-500">Fazla Mesai</p><p class="text-sm font-bold text-amber-400">${pFazlaMesai.toFixed(1)}s</p></div>
                <div><p class="text-[10px] text-gray-500">Devamsizlik</p><p class="text-sm font-bold ${pDevamsiz>0?'text-red-400':'text-green-400'}">${pDevamsiz}</p></div>
                <div><p class="text-[10px] text-gray-500">Sistem Kullanim</p><p class="text-sm font-bold text-purple-400">${kullanimSkoru} islem</p></div>
            </div>`;
        if(pPuantaj.length>0){
            const son5=pPuantaj.sort((a,b)=>b.tarih.localeCompare(a.tarih)).slice(0,5);
            html+=`<div class="overflow-x-auto"><table class="w-full text-[10px]"><thead><tr class="text-gray-400 border-b border-gray-700"><th class="p-1 text-left">Tarih</th><th class="p-1">Giris</th><th class="p-1">Cikis</th><th class="p-1 text-right">Saat</th><th class="p-1">Durum</th></tr></thead><tbody>`;
            son5.forEach(pt=>{
                const dCol=pt.durum==='tam'?'text-green-400':pt.durum==='yarim'?'text-amber-400':pt.durum==='izinli'?'text-blue-400':'text-red-400';
                const dL=pt.durum==='tam'?'Tam':pt.durum==='yarim'?'Yarim':pt.durum==='izinli'?'Izinli':'Yok';
                html+=`<tr class="border-b border-gray-800"><td class="p-1">${pt.tarih}</td><td class="p-1 text-center">${pt.girisSaat||'-'}</td><td class="p-1 text-center">${pt.cikisSaat||'-'}</td><td class="p-1 text-right">${(pt.toplamSaat||0).toFixed(1)}</td><td class="p-1 ${dCol}">${dL}</td></tr>`;
            });
            html+=`</tbody></table></div>`;
        }else{
            html+=`<p class="text-[10px] text-gray-500 text-center">Bu ay puantaj kaydi yok.</p>`;
        }
        html+=`</div>`;
    }
    // Notlar
    if(p.notlar){
        html+=`<div class="glass rounded-xl p-4"><h4 class="text-[11px] font-bold text-gray-400 mb-2 uppercase tracking-wider">Notlar</h4><p class="text-xs text-gray-300">${p.notlar}</p></div>`;
    }
    html+=`</div></div></div>`;
    document.body.insertAdjacentHTML('beforeend',html);
}
function openDepartmanForm(id){
    document.getElementById('dept-edit-id').value=id||'';
    document.getElementById('departman-modal-title').textContent=id?'Departman Duzenle':'Yeni Departman';
    const ySel=document.getElementById('dept-yonetici');
    ySel.innerHTML='<option value="">Seciniz</option>'+(S.personeller||[]).filter(p=>p.durum==='aktif').map(p=>`<option value="${p.id}">${p.ad} ${p.soyad}</option>`).join('');
    if(id){
        const d=(S.departmanlar||[]).find(x=>String(x.id)===String(id));
        if(d){document.getElementById('dept-ad').value=d.ad||'';document.getElementById('dept-kod').value=d.kod||'';document.getElementById('dept-yonetici').value=d.yoneticiId||'';document.getElementById('dept-aciklama').value=d.aciklama||'';}
    }else{document.getElementById('dept-ad').value='';document.getElementById('dept-kod').value='';document.getElementById('dept-yonetici').value='';document.getElementById('dept-aciklama').value='';}
    openModal('modal-departman');
}
function saveDepartman(){
    const ad=document.getElementById('dept-ad').value.trim();
    if(!ad){showNotif('Departman adi zorunludur.');return;}
    const editId=document.getElementById('dept-edit-id').value;
    const data={ad,kod:document.getElementById('dept-kod').value.trim().toUpperCase()||null,yoneticiId:document.getElementById('dept-yonetici').value||null,aciklama:document.getElementById('dept-aciklama').value.trim()||null,aktif:true};
    if(!S.departmanlar)S.departmanlar=[];
    if(editId){const idx=S.departmanlar.findIndex(d=>String(d.id)===String(editId));if(idx>=0)Object.assign(S.departmanlar[idx],data);}
    else{data.id=Date.now();S.departmanlar.push(data);}
    save();closeModal('modal-departman');renderHrDepartmanlar();showNotif(editId?'Departman guncellendi.':'Departman eklendi.');
}
function deleteDepartman(id){
    if(!confirm('Bu departmani silmek istediginize emin misiniz?'))return;
    S.departmanlar=(S.departmanlar||[]).filter(d=>String(d.id)!==String(id));
    save();renderHrDepartmanlar();showNotif('Departman silindi.');
}
function openIzinForm(){
    const pSel=document.getElementById('izin-personel');
    pSel.innerHTML='<option value="">Seciniz</option>'+(S.personeller||[]).filter(p=>p.durum==='aktif').map(p=>`<option value="${p.id}">${p.ad} ${p.soyad}</option>`).join('');
    document.getElementById('izin-tur').value='yillik';
    document.getElementById('izin-bas').value='';document.getElementById('izin-bit').value='';
    document.getElementById('izin-gun-sayisi').textContent='0';
    document.getElementById('izin-aciklama').value='';
    const oSel=document.getElementById('izin-onaylayan');
    oSel.innerHTML='<option value="">Seciniz</option>'+S.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    openModal('modal-izin');
}
function calcIzinGun(){
    const bas=document.getElementById('izin-bas').value;
    const bit=document.getElementById('izin-bit').value;
    if(bas&&bit){
        const d1=new Date(bas);const d2=new Date(bit);
        const diff=Math.ceil((d2-d1)/(1000*60*60*24))+1;
        document.getElementById('izin-gun-sayisi').textContent=Math.max(0,diff);
    }
}
function saveIzin(){
    const empId=document.getElementById('izin-personel').value;
    const bas=document.getElementById('izin-bas').value;
    const bit=document.getElementById('izin-bit').value;
    if(!empId||!bas||!bit){showNotif('Personel, baslangic ve bitis zorunlu.');return;}
    const gun=parseInt(document.getElementById('izin-gun-sayisi').textContent)||0;
    const iz={id:Date.now(),employeeId:empId,izinTuru:document.getElementById('izin-tur').value,basTarihi:bas,bitTarihi:bit,gunSayisi:gun,durum:'beklemede',onaylayanId:document.getElementById('izin-onaylayan').value||null,aciklama:document.getElementById('izin-aciklama').value.trim()||null};
    if(!S.izinler)S.izinler=[];
    S.izinler.push(iz);
    save();closeModal('modal-izin');renderHrIzinler();showNotif('Izin talebi olusturuldu.');
    const emp=(S.personeller||[]).find(p=>String(p.id)===String(empId));
    act('Izin talebi: '+(emp?emp.ad+' '+emp.soyad:'?')+' - '+gun+' gun');
}
function approveIzin(id){
    const iz=(S.izinler||[]).find(x=>String(x.id)===String(id));if(!iz)return;
    iz.durum='onaylandi';save();renderHrIzinler();showNotif('Izin onaylandi.');
}
function rejectIzin(id){
    const iz=(S.izinler||[]).find(x=>String(x.id)===String(id));if(!iz)return;
    iz.durum='reddedildi';save();renderHrIzinler();showNotif('Izin reddedildi.');
}
function openPersonelBelgeForm(){
    const pSel=document.getElementById('pb-personel');
    pSel.innerHTML='<option value="">Seciniz</option>'+(S.personeller||[]).filter(p=>p.durum!=='ayrilmis').map(p=>`<option value="${p.id}">${p.ad} ${p.soyad}</option>`).join('');
    document.getElementById('pb-tur').value='sozlesme';
    document.getElementById('pb-baslik').value='';document.getElementById('pb-gecerlilik').value='';document.getElementById('pb-notlar').value='';
    openModal('modal-personel-belge');
}
function savePersonelBelge(){
    const empId=document.getElementById('pb-personel').value;
    const baslik=document.getElementById('pb-baslik').value.trim();
    if(!empId||!baslik){showNotif('Personel ve baslik zorunlu.');return;}
    const b={id:Date.now(),employeeId:empId,tur:document.getElementById('pb-tur').value,baslik,dosyaUrl:null,gecerlilikTarihi:document.getElementById('pb-gecerlilik').value||null,notlar:document.getElementById('pb-notlar').value.trim()||null};
    if(!S.personelBelgeler)S.personelBelgeler=[];
    S.personelBelgeler.push(b);
    save();closeModal('modal-personel-belge');renderHrBelgeler();showNotif('Belge eklendi.');
}

// ===================== ZIMMET RENDER GUNCELLEME =====================
// renderDepoZimmet'e toplu zimmet butonu ekleme (mevcut render'in uzerine)
const _origRenderDepoZimmet=renderDepoZimmet;
renderDepoZimmet=function(){
    _origRenderDepoZimmet();
    const c=document.getElementById('depo-tab-zimmet');if(!c)return;
    // Toolbar'a butonlar ekle
    const toolbar=c.querySelector('.flex.flex-wrap.gap-2.mb-3');
    if(toolbar&&!toolbar.querySelector('.tz-btn')){
        toolbar.insertAdjacentHTML('beforeend',`<button class="tz-btn px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-amber-600/20 text-amber-400 border border-amber-500/20" onclick="openTopluZimmetForm()">&#128188; Personel Giris Paketi</button>`);
        toolbar.insertAdjacentHTML('beforeend',`<button class="tz-btn px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-green-600/20 text-green-400 border border-green-500/20" onclick="openImportModal('zimmetler','Zimmet Excel Import')">&#128228; Excel'den Aktar</button>`);
    }
};

// ===================== IMPORT BUTONLARI EKLEME (DIGER MODULLER) =====================
// Tedarikci havuzu
const _origRenderTedarikciler=typeof renderTedarikciler==='function'?renderTedarikciler:null;
if(_origRenderTedarikciler){
    renderTedarikciler=function(){
        _origRenderTedarikciler();
        const tabs=document.querySelectorAll('#module-supply .tab-btn');
        // Tedarikci toolbar'a import butonu ekle
        const panel=document.getElementById('supply-tab-tedarikciler');
        if(panel){
            const toolbar=panel.querySelector('.flex.flex-wrap.gap-2');
            if(toolbar&&!toolbar.querySelector('.imp-btn')){
                toolbar.insertAdjacentHTML('beforeend',`<button class="imp-btn px-3 py-1.5 glass rounded-lg text-[11px] hover:bg-green-600/20 text-green-400 border border-green-500/20" onclick="openImportModal('tedarikci-havuzu','Tedarikci Excel Import')">&#128228; Excel'den Aktar</button>`);
            }
        }
    };
}

</script>
<div id="mention-dropdown" class="hidden fixed bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 max-h-40 overflow-y-auto" style="min-width:180px;"></div>
</body>
</html>
